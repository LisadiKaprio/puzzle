import{d as K,r as U,o as v,c as A,a as n,b as x,w as Q,e as ee,f as M,g as ne,n as Oe,t as Y,F as ie,h as me,i as Fe,j as G,v as ve,k as we,l as tn,m as se,p as ao,q as uo,s as on,u as nn,x as sn,T as ln,y as rn,z as an,A as un,B as cn}from"./vendor.a55c7513.js";const dn=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))s(l);new MutationObserver(l=>{for(const r of l)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(l){const r={};return l.integrity&&(r.integrity=l.integrity),l.referrerpolicy&&(r.referrerPolicy=l.referrerpolicy),l.crossorigin==="use-credentials"?r.credentials="include":l.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(l){if(l.ep)return;l.ep=!0;const r=o(l);fetch(l.href,r)}};dn();var j=(e,t)=>{const o=e.__vccOpts||e;for(const[s,l]of t)o[s]=l;return o};const pn=K({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),gn={id:"app"},hn={key:0,class:"nav"},fn=M("Games overview"),mn=M("New game");function yn(e,t,o,s,l,r){const i=U("router-link"),a=U("router-view");return v(),A("div",gn,[e.showNav?(v(),A("ul",hn,[n("li",null,[x(i,{class:"btn",to:{name:"index"}},{default:Q(()=>[fn]),_:1})]),n("li",null,[x(i,{class:"btn",to:{name:"new-game"}},{default:Q(()=>[mn]),_:1})])])):ee("",!0),x(a)])}var _n=j(pn,[["render",yn]]);let co="",po="";const gt=async(e,t,o)=>new Promise((s,l)=>{const r=new window.XMLHttpRequest;r.open(e,t,!0),r.withCredentials=!0;for(const i in o.headers||{})r.setRequestHeader(i,o.headers[i]);r.setRequestHeader("Client-Id",co),r.setRequestHeader("Client-Secret",po),r.addEventListener("load",function(i){s({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),r.addEventListener("error",function(i){l(new Error("xhr error"))}),r.upload&&o.onUploadProgress&&r.upload.addEventListener("progress",function(i){o.onUploadProgress&&o.onUploadProgress(i)}),r.send(o.body||null)});var ae={request:gt,get:(e,t)=>gt("get",e,t),post:(e,t)=>gt("post",e,t),setClientId:e=>{co=e},setClientSecret:e=>{po=e}};const go=1,ht=go*1e3,He=ht*60,qe=He*60,ft=qe*24,En=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},ho=e=>{const t=Math.floor(e/ft);e=e%ft;const o=Math.floor(e/qe);e=e%qe;const s=Math.floor(e/He);e=e%He;const l=Math.floor(e/ht);return`${t}d ${o}h ${s}m ${l}s`},vn=(e,t)=>ho(t-e);var pe={MS:go,SEC:ht,MIN:He,HOUR:qe,DAY:ft,timestamp:En,timeDiffStr:vn,durationStr:ho};const wn=K({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const o=t?"\u{1F3C1}":"\u23F3",s=e,l=t||pe.timestamp(),r=pe.timeDiffStr(s,l);return`${o} ${r}`}}}),Pn={class:"game-info-text"},Tn=n("br",null,null,-1),Cn=n("br",null,null,-1),Sn=n("br",null,null,-1),$n=M(" \u21AA\uFE0F Watch replay ");function An(e,t,o,s,l,r){const i=U("router-link");return v(),A("div",{class:"game-teaser",style:Oe(e.style)},[x(i,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:Q(()=>[n("span",Pn,[M(" \u{1F9E9} "+Y(e.game.tilesFinished)+"/"+Y(e.game.tilesTotal),1),Tn,M(" \u{1F465} "+Y(e.game.players),1),Cn,M(" "+Y(e.time(e.game.started,e.game.finished)),1),Sn])]),_:1},8,["to"]),e.game.hasReplay?(v(),ne(i,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:Q(()=>[$n]),_:1},8,["to"])):ee("",!0)],4)}var fo=j(wn,[["render",An]]);const bn=K({components:{GameTeaser:fo},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ae.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),On=n("h1",null,"Running games",-1),Nn=n("h1",null,"Finished games",-1);function kn(e,t,o,s,l,r){const i=U("game-teaser");return v(),A("div",null,[On,(v(!0),A(ie,null,me(e.gamesRunning,(a,y)=>(v(),A("div",{class:"game-teaser-wrap",key:y},[x(i,{game:a},null,8,["game"])]))),128)),Nn,(v(!0),A(ie,null,me(e.gamesFinished,(a,y)=>(v(),A("div",{class:"game-teaser-wrap",key:y},[x(i,{game:a},null,8,["game"])]))),128))])}var Un=j(bn,[["render",kn]]);const Vn=K({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function Rn(e,t,o,s,l,r){const i=U("image-teaser");return v(),A("div",null,[(v(!0),A(ie,null,me(e.images,(a,y)=>(v(),ne(i,{image:a,onClick:h=>e.imageClicked(a),onEditClick:h=>e.imageEditClicked(a),key:y},null,8,["image","onClick","onEditClick"]))),128))])}var mo=j(Vn,[["render",Rn]]);class Qe{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,o){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const s=(this.rand_high>>>0)/4294967295;return t+s*(o-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const o=t.slice();for(let s=0;s<=o.length-2;s++){const l=this.random(s,o.length-1),r=o[s];o[s]=o[l],o[l]=r}return o}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const o=new Qe(0);return o.rand_high=t.rand_high,o.rand_low=t.rand_low,o}}const zn=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},mt=(e,t)=>{const o=`${e}`;return o.length>=t.length?o:t.substr(0,t.length-o.length)+o},Xe=(...e)=>{const t=o=>(...s)=>{const l=new Date,r=mt(l.getHours(),"00"),i=mt(l.getMinutes(),"00"),a=mt(l.getSeconds(),"00");console[o](`${r}:${i}:${a}`,...e,...s)};return{log:t("log"),error:t("error"),info:t("info")}},Ln=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function Mn(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Dn(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function Fn(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function In(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function Gn(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function Bn(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function xn(e){return[e.id,e.rng.type||"",Qe.serialize(e.rng.obj),e.puzzle,e.players,e.evtInfos,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId]}function Yn(e){return{id:e[0],rng:{type:e[1],obj:Qe.unserialize(e[2])},puzzle:e[3],players:e[4],evtInfos:e[5],scoreMode:e[6],shapeMode:e[7],snapMode:e[8],creatorUserId:e[9]}}function Wn(e,t){const o=e.width/e.tileSize;return{x:t%o,y:Math.floor(t/o)}}const jn=e=>{let t=0;for(let o=0;o<e.length;o++){const s=e.charCodeAt(o);t=(t<<5)-t+s,t|=0}return t};function Zn(e){const t=[];for(const o in e){const s=[o,e[o]].map(encodeURIComponent);t.push(s.join("="))}return t.length===0?"":`?${t.join("&")}`}var F={hash:jn,slug:zn,uniqId:Ln,encodeShape:Mn,decodeShape:Dn,encodePiece:Fn,decodePiece:In,encodePlayer:Gn,decodePlayer:Bn,encodeGame:xn,decodeGame:Yn,coordByPieceIdx:Wn,asQueryArgs:Zn};const Kn=Xe("NewImageDialog.vue"),Hn=K({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{imageFromDragEvt(e){var s;const t=(s=e.dataTransfer)==null?void 0:s.items;if(!t||t.length===0)return null;const o=t[0];return o.type.startsWith("image/")?o:null},onFileSelect(e){const t=e.target;if(!t.files)return;const o=t.files[0];!o||this.preview(o)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=o=>{this.previewUrl=o.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags})},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags})},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const o=t.getAsFile();return o&&(this.file=o,this.preview(o),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){Kn.info("onDragleave"),this.droppable=!1}}}),qn=n("div",{class:"drop-target"},null,-1),Qn={key:0,class:"has-image"},Xn={key:1},Jn={class:"upload"},es=n("span",{class:"btn"},"Upload File",-1),ts={class:"area-settings"},os=n("td",null,[n("label",null,"Title")],-1),ns=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),ss=n("td",null,[n("label",null,"Tags")],-1),ls={class:"area-buttons"},is=["disabled"],rs=M("\u{1F5BC}\uFE0F Post to gallery"),as=["disabled"],us=M("\u{1F9E9} Post to gallery "),cs=n("br",null,null,-1),ds=M(" + set up game");function ps(e,t,o,s,l,r){const i=U("responsive-image"),a=U("tags-input"),y=U("overlay");return v(),ne(y,{class:"new-image-dialog"},{default:Q(()=>[n("div",{class:Fe(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...h)=>e.onDrop&&e.onDrop(...h)),onDragover:t[3]||(t[3]=(...h)=>e.onDragover&&e.onDragover(...h)),onDragleave:t[4]||(t[4]=(...h)=>e.onDragleave&&e.onDragleave(...h))},[qn,e.previewUrl?(v(),A("div",Qn,[n("span",{class:"remove btn",onClick:t[0]||(t[0]=h=>e.previewUrl="")},"X"),x(i,{src:e.previewUrl},null,8,["src"])])):(v(),A("div",Xn,[n("label",Jn,[n("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...h)=>e.onFileSelect&&e.onFileSelect(...h)),accept:"image/*"},null,32),es])]))],34),n("div",ts,[n("table",null,[n("tr",null,[os,n("td",null,[G(n("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=h=>e.title=h),placeholder:"Flower by @artist"},null,512),[[ve,e.title]])])]),ns,n("tr",null,[ss,n("td",null,[x(a,{modelValue:e.tags,"onUpdate:modelValue":t[6]||(t[6]=h=>e.tags=h),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),n("div",ls,[n("button",{class:"btn",disabled:!e.canPostToGallery,onClick:t[7]||(t[7]=(...h)=>e.postToGallery&&e.postToGallery(...h))},[e.uploading==="postToGallery"?(v(),A(ie,{key:0},[M("Uploading ("+Y(e.uploadProgressPercent)+"%)",1)],64)):(v(),A(ie,{key:1},[rs],64))],8,is),n("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[8]||(t[8]=(...h)=>e.setupGameClick&&e.setupGameClick(...h))},[e.uploading==="setupGame"?(v(),A(ie,{key:0},[M("Uploading ("+Y(e.uploadProgressPercent)+"%)",1)],64)):(v(),A(ie,{key:1},[us,cs,ds],64))],8,as)])]),_:1})}var yo=j(Hn,[["render",ps]]);const gs=K({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},created(){this.title=this.image.title,this.tags=this.image.tags.map(e=>e.title)},methods:{saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),hs={class:"area-image"},fs={class:"has-image"},ms={class:"area-settings"},ys=n("td",null,[n("label",null,"Title")],-1),_s=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Es=n("td",null,[n("label",null,"Tags")],-1),vs={class:"area-buttons"};function ws(e,t,o,s,l,r){const i=U("responsive-image"),a=U("tags-input"),y=U("overlay");return v(),ne(y,{class:"edit-image-dialog"},{default:Q(()=>[n("div",hs,[n("div",fs,[x(i,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),n("div",ms,[n("table",null,[n("tr",null,[ys,n("td",null,[G(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=h=>e.title=h),placeholder:"Flower by @artist"},null,512),[[ve,e.title]])])]),_s,n("tr",null,[Es,n("td",null,[x(a,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=h=>e.tags=h),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),n("div",vs,[n("button",{class:"btn",onClick:t[2]||(t[2]=(...h)=>e.saveImage&&e.saveImage(...h))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var _o=j(gs,[["render",ws]]),Eo;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(Eo||(Eo={}));var ye;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(ye||(ye={}));var Ne;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(Ne||(Ne={}));var Pe;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(Pe||(Pe={}));const Ps=K({props:{image:{type:Object,required:!0}},emits:{newGame:null},data(){return{tiles:1e3,scoreMode:ye.ANY,shapeMode:Ne.NORMAL,snapMode:Pe.NORMAL}},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Ts={class:"area-image"},Cs={class:"has-image"},Ss={key:0,class:"image-title"},$s={key:0,class:"image-title-title"},As={key:1,class:"image-title-dim"},bs={class:"area-settings"},Os=n("td",null,[n("label",null,"Pieces")],-1),Ns=n("td",null,[n("label",null,"Scoring: ")],-1),ks=M(" Any (Score when pieces are connected to each other or on final location)"),Us=n("br",null,null,-1),Vs=M(" Final (Score when pieces are put to their final location)"),Rs=n("td",null,[n("label",null,"Shapes: ")],-1),zs=M(" Normal"),Ls=n("br",null,null,-1),Ms=M(" Any (Flat pieces can occur anywhere)"),Ds=n("br",null,null,-1),Fs=M(" Flat (All pieces flat on all sides)"),Is=n("td",null,[n("label",null,"Snapping: ")],-1),Gs=M(" Normal (Pieces snap to final destination and to each other)"),Bs=n("br",null,null,-1),xs=M(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),Ys={class:"area-buttons"},Ws=["disabled"];function js(e,t,o,s,l,r){const i=U("responsive-image"),a=U("overlay");return v(),ne(a,{class:"new-game-dialog"},{default:Q(()=>[n("div",Ts,[n("div",Cs,[x(i,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(v(),A("div",Ss,[e.image.title?(v(),A("span",$s,'"'+Y(e.image.title)+'"',1)):ee("",!0),e.image.width||e.image.height?(v(),A("span",As,"("+Y(e.image.width)+" \u2715 "+Y(e.image.height)+")",1)):ee("",!0)])):ee("",!0)]),n("div",bs,[n("table",null,[n("tr",null,[Os,n("td",null,[G(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=y=>e.tiles=y)},null,512),[[ve,e.tiles]])])]),n("tr",null,[Ns,n("td",null,[n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=y=>e.scoreMode=y),value:"1"},null,512),[[we,e.scoreMode]]),ks]),Us,n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=y=>e.scoreMode=y),value:"0"},null,512),[[we,e.scoreMode]]),Vs])])]),n("tr",null,[Rs,n("td",null,[n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=y=>e.shapeMode=y),value:"0"},null,512),[[we,e.shapeMode]]),zs]),Ls,n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=y=>e.shapeMode=y),value:"1"},null,512),[[we,e.shapeMode]]),Ms]),Ds,n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=y=>e.shapeMode=y),value:"2"},null,512),[[we,e.shapeMode]]),Fs])])]),n("tr",null,[Is,n("td",null,[n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=y=>e.snapMode=y),value:"0"},null,512),[[we,e.snapMode]]),Gs]),Bs,n("label",null,[G(n("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=y=>e.snapMode=y),value:"1"},null,512),[[we,e.snapMode]]),xs])])])])]),n("div",Ys,[n("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[8]||(t[8]=(...y)=>e.onNewGameClick&&e.onNewGameClick(...y))}," \u{1F9E9} Generate Puzzle ",8,Ws)])]),_:1})}var vo=j(Ps,[["render",js]]);const Zs=K({components:{ImageLibrary:mo,NewImageDialog:yo,EditImageDialog:_o,NewGameDialog:vo},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(o=>!t.includes(o.title)&&o.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(o=>o.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ae.get(`/api/newgame-data${F.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags);const o=await ae.post("/api/upload",{body:t,onUploadProgress:s=>{this.uploadProgress=s.loaded/s.total}});return this.uploadProgress=1,await o.json()},async saveImage(e){return await(await ae.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.dialog="new-game"},async onNewGame(e){const t=await ae.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const o=await t.json();this.$router.push({name:"game",params:{id:o.id}})}}}}),Ks={class:"upload-image-teaser"},Hs=n("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),qs={key:0},Qs=M(" Tags: "),Xs=["onClick"],Js=M(" Sort by: "),el=n("option",{value:"date_desc"},"Newest first",-1),tl=n("option",{value:"date_asc"},"Oldest first",-1),ol=n("option",{value:"alpha_asc"},"A-Z",-1),nl=n("option",{value:"alpha_desc"},"Z-A",-1),sl=[el,tl,ol,nl];function ll(e,t,o,s,l,r){const i=U("image-library"),a=U("new-image-dialog"),y=U("edit-image-dialog"),h=U("new-game-dialog");return v(),A("div",null,[n("div",Ks,[n("div",{class:"btn btn-big",onClick:t[0]||(t[0]=S=>e.dialog="new-image")},"Upload your image"),Hs]),n("div",null,[e.tags.length>0?(v(),A("label",qs,[Qs,(v(!0),A(ie,null,me(e.relevantTags,(S,$)=>(v(),A("span",{class:Fe(["bit",{on:e.filters.tags.includes(S.slug)}]),key:$,onClick:w=>e.toggleTag(S)},Y(S.title)+" ("+Y(S.total)+")",11,Xs))),128))])):ee("",!0),n("label",null,[Js,G(n("select",{"onUpdate:modelValue":t[1]||(t[1]=S=>e.filters.sort=S),onChange:t[2]||(t[2]=(...S)=>e.filtersChanged&&e.filtersChanged(...S))},sl,544),[[tn,e.filters.sort]])])]),x(i,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),G(x(a,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=S=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[se,e.dialog==="new-image"]]),G(x(y,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=S=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[se,e.dialog==="edit-image"]]),G(x(h,{onBgclick:t[5]||(t[5]=S=>e.dialog=""),onNewGame:e.onNewGame,image:e.image},null,8,["onNewGame","image"]),[[se,e.image&&e.dialog==="new-game"]])])}var il=j(Zs,[["render",ll]]);const rl=K({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),al={class:"scores"},ul=n("div",null,"Scores",-1),cl=n("td",null,"\u26A1",-1),dl=n("td",null,"\u{1F4A4}",-1);function pl(e,t,o,s,l,r){return v(),A("div",al,[ul,n("table",null,[(v(!0),A(ie,null,me(e.actives,(i,a)=>(v(),A("tr",{key:a,style:Oe({color:i.color})},[cl,n("td",null,Y(i.name),1),n("td",null,Y(i.points),1)],4))),128)),(v(!0),A(ie,null,me(e.idles,(i,a)=>(v(),A("tr",{key:a,style:Oe({color:i.color})},[dl,n("td",null,Y(i.name),1),n("td",null,Y(i.points),1)],4))),128))])])}var yt=j(rl,[["render",pl]]);const gl=K({props:{finished:{type:Boolean,required:!0},duration:{type:Number,required:!0},piecesDone:{type:Number,required:!0},piecesTotal:{type:Number,required:!0}},computed:{icon(){return this.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return pe.durationStr(this.duration)}}}),hl={class:"timer"};function fl(e,t,o,s,l,r){return v(),A("div",hl,[n("div",null," \u{1F9E9} "+Y(e.piecesDone)+"/"+Y(e.piecesTotal),1),n("div",null,Y(e.icon)+" "+Y(e.durationStr),1),ao(e.$slots,"default")])}var _t=j(gl,[["render",fl]]);const ml=K({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},methods:{updateVolume(e){this.modelValue.soundsVolume=e.target.value},decreaseVolume(){const e=parseInt(this.modelValue.soundsVolume,10)-5;this.modelValue.soundsVolume=Math.max(0,e)},increaseVolume(){const e=parseInt(this.modelValue.soundsVolume,10)+5;this.modelValue.soundsVolume=Math.min(100,e)}},created(){this.$watch("modelValue",e=>{this.$emit("update:modelValue",e)},{deep:!0})}}),ke=e=>(on("data-v-80b37c44"),e=e(),nn(),e),yl={class:"settings"},_l=ke(()=>n("td",null,[n("label",null,"Background: ")],-1)),El=ke(()=>n("td",null,[n("label",null,"Color: ")],-1)),vl=ke(()=>n("td",null,[n("label",null,"Name: ")],-1)),wl=ke(()=>n("td",null,[n("label",null,"Sounds: ")],-1)),Pl=ke(()=>n("td",null,[n("label",null,"Sounds Volume: ")],-1)),Tl={class:"sound-volume"},Cl=["value"],Sl=ke(()=>n("td",null,[n("label",null,"Show player names: ")],-1));function $l(e,t,o,s,l,r){const i=U("overlay");return v(),ne(i,{class:"transparent"},{default:Q(()=>[n("table",yl,[n("tr",null,[_l,n("td",null,[G(n("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=a=>e.modelValue.background=a)},null,512),[[ve,e.modelValue.background]])])]),n("tr",null,[El,n("td",null,[G(n("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=a=>e.modelValue.color=a)},null,512),[[ve,e.modelValue.color]])])]),n("tr",null,[vl,n("td",null,[G(n("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=a=>e.modelValue.name=a)},null,512),[[ve,e.modelValue.name]])])]),n("tr",null,[wl,n("td",null,[G(n("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=a=>e.modelValue.soundsEnabled=a)},null,512),[[uo,e.modelValue.soundsEnabled]])])]),n("tr",null,[Pl,n("td",Tl,[n("span",{onClick:t[4]||(t[4]=(...a)=>e.decreaseVolume&&e.decreaseVolume(...a))},"\u{1F509}"),n("input",{type:"range",min:"0",max:"100",value:e.modelValue.soundsVolume,onChange:t[5]||(t[5]=(...a)=>e.updateVolume&&e.updateVolume(...a))},null,40,Cl),n("span",{onClick:t[6]||(t[6]=(...a)=>e.increaseVolume&&e.increaseVolume(...a))},"\u{1F50A}")])]),n("tr",null,[Sl,n("td",null,[G(n("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=a=>e.modelValue.showPlayerNames=a)},null,512),[[uo,e.modelValue.showPlayerNames]])])])])]),_:1})}var Et=j(ml,[["render",$l],["__scopeId","data-v-80b37c44"]]);const Al=K({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),bl={class:"preview"};function Ol(e,t,o,s,l,r){const i=U("overlay");return v(),ne(i,{class:"preview-overlay",animate:!1},{default:Q(()=>[n("div",bl,[n("div",{class:"img",style:Oe(e.previewStyle)},null,4)])]),_:1})}var vt=j(Al,[["render",Ol]]);const Nl=K({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case ye.ANY:return["Any","Score when pieces are connected to each other or on final location"];case ye.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ne.FLAT:return["Flat","All pieces flat on all sides"];case Ne.ANY:return["Any","Flat pieces can occur anywhere"];case Ne.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case Pe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case Pe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),kl={class:"help"},Ul=n("tr",null,[n("td",{colspan:"2"},"Info about this puzzle")],-1),Vl=n("td",null,"Image Title: ",-1),Rl=n("td",null,"Scoring: ",-1),zl=["title"],Ll=n("td",null,"Shapes: ",-1),Ml=["title"],Dl=n("td",null,"Snapping: ",-1),Fl=["title"];function Il(e,t,o,s,l,r){const i=U("overlay");return v(),ne(i,{class:"transparent"},{default:Q(()=>[n("table",kl,[Ul,n("tr",null,[Vl,n("td",null,Y(e.game.puzzle.info.image.title),1)]),n("tr",null,[Rl,n("td",null,[n("span",{title:e.snapMode[1]},Y(e.scoreMode[0]),9,zl)])]),n("tr",null,[Ll,n("td",null,[n("span",{title:e.snapMode[1]},Y(e.shapeMode[0]),9,Ml)])]),n("tr",null,[Dl,n("td",null,[n("span",{title:e.snapMode[1]},Y(e.snapMode[0]),9,Fl)])])])]),_:1})}var wt=j(Nl,[["render",Il]]);const Gl=1,Bl=4,xl=2,Yl=3,Wl=1,jl=2,Zl=4,Kl=3,Hl=1,ql=2,Ql=3,Xl=4,Jl=5,ei=6,ti=7,oi=8,ni=9,si=10,li=11,ii=12,ri=13,ai=14,ui=15,ci=16,di=17,pi=18,gi=19,hi=20,fi=1,mi=2,yi=3;var p={EV_SERVER_EVENT:Gl,EV_SERVER_INIT:Bl,EV_CLIENT_EVENT:xl,EV_CLIENT_INIT:Yl,LOG_HEADER:Wl,LOG_ADD_PLAYER:jl,LOG_UPDATE_PLAYER:Zl,LOG_HANDLE_INPUT:Kl,INPUT_EV_MOVE:ni,INPUT_EV_MOUSE_DOWN:Hl,INPUT_EV_MOUSE_UP:ql,INPUT_EV_MOUSE_MOVE:Ql,INPUT_EV_ZOOM_IN:Xl,INPUT_EV_ZOOM_OUT:Jl,INPUT_EV_BG_COLOR:ei,INPUT_EV_PLAYER_COLOR:ti,INPUT_EV_PLAYER_NAME:oi,INPUT_EV_TOGGLE_PREVIEW:si,INPUT_EV_TOGGLE_SOUNDS:li,INPUT_EV_REPLAY_TOGGLE_PAUSE:ii,INPUT_EV_REPLAY_SPEED_UP:ri,INPUT_EV_REPLAY_SPEED_DOWN:ai,INPUT_EV_TOGGLE_PLAYER_NAMES:ui,INPUT_EV_CENTER_FIT_PUZZLE:ci,INPUT_EV_TOGGLE_FIXED_PIECES:di,INPUT_EV_TOGGLE_LOOSE_PIECES:pi,INPUT_EV_STORE_POS:gi,INPUT_EV_RESTORE_POS:hi,CHANGE_DATA:fi,CHANGE_TILE:mi,CHANGE_PLAYER:yi};const _i=Xe("Communication.js"),Ei=1001,Pt=4e3,wo=0,Tt=1,Ct=2,Po=3,To=4;let _e,St=[],$t=e=>{St.push(e)},At=[],bt=e=>{At.push(e)};function vi(e){$t=e;for(const t of St)$t(t);St=[]}function wi(e){bt=e;for(const t of At)bt(t);At=[]}let Ot=wo;const Ie=e=>{Ot!==e&&(Ot=e,bt(e))};function Co(e){if(Ot===Ct)try{_e.send(JSON.stringify(e))}catch{_i.info("unable to send message.. maybe because ws is invalid?")}}let Ue,Ve;function Pi(e,t,o){return Ue=0,Ve={},Ie(Po),new Promise(s=>{_e=new WebSocket(e,o+"|"+t),_e.onopen=()=>{Ie(Ct),Co([p.EV_CLIENT_INIT])},_e.onmessage=l=>{const r=JSON.parse(l.data),i=r[0];if(i===p.EV_SERVER_INIT){const a=r[1];s(a)}else if(i===p.EV_SERVER_EVENT){const a=r[1],y=r[2];if(a===o&&Ve[y]){delete Ve[y];return}$t(r)}else throw`[ 2021-05-09 invalid connect msgType ${i} ]`},_e.onerror=()=>{throw Ie(Tt),"[ 2021-05-15 onerror ]"},_e.onclose=l=>{l.code===Pt||l.code===Ei?Ie(To):Ie(Tt)}})}async function Ti(e,t){const o={gameId:e,offset:t};return await(await ae.get(`/api/replay-data${F.asQueryArgs(o)}`,{})).json()}function Ci(){_e&&_e.close(Pt),Ue=0,Ve={}}function Si(e){Ue++,Ve[Ue]=e,Co([p.EV_CLIENT_EVENT,Ue,Ve[Ue]])}var Ee={connect:Pi,requestReplayData:Ti,disconnect:Ci,sendClientEvent:Si,onServerChange:vi,onConnectionStateChange:wi,CODE_CUSTOM_DISCONNECT:Pt,CONN_STATE_NOT_CONNECTED:wo,CONN_STATE_DISCONNECTED:Tt,CONN_STATE_CLOSED:To,CONN_STATE_CONNECTED:Ct,CONN_STATE_CONNECTING:Po};const $i=K({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Ee.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Ee.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),Ai={key:0},bi={key:2};function Oi(e,t,o,s,l,r){const i=U("overlay");return G((v(),ne(i,{class:"connection-lost"},{default:Q(()=>[e.lostConnection?(v(),A("div",Ai,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):ee("",!0),e.lostConnection?(v(),A("span",{key:1,class:"btn",onClick:t[0]||(t[0]=a=>e.$emit("reconnect"))},"Reconnect")):ee("",!0),e.connecting?(v(),A("div",bi,"Connecting...")):ee("",!0)]),_:1},512)),[[se,e.show]])}var So=j($i,[["render",Oi]]);const Ni=K({}),ki=n("table",{class:"help"},[n("tr",null,[n("td",null,"\u2B06\uFE0F Move up:"),n("td",null,[n("div",null,[n("kbd",null,"W"),M("/"),n("kbd",null,"\u2191"),M("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u2B07\uFE0F Move down:"),n("td",null,[n("div",null,[n("kbd",null,"S"),M("/"),n("kbd",null,"\u2193"),M("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u2B05\uFE0F Move left:"),n("td",null,[n("div",null,[n("kbd",null,"A"),M("/"),n("kbd",null,"\u2190"),M("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u27A1\uFE0F Move right:"),n("td",null,[n("div",null,[n("kbd",null,"D"),M("/"),n("kbd",null,"\u2192"),M("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td"),n("td",null,[n("div",null,[M("Move faster by holding "),n("kbd",null,"Shift")])])]),n("tr",null,[n("td",null,"\u{1F50D}+ Zoom in:"),n("td",null,[n("div",null,[n("kbd",null,"E"),M("/\u{1F5B1}\uFE0F-Wheel")])])]),n("tr",null,[n("td",null,"\u{1F50D}- Zoom out:"),n("td",null,[n("div",null,[n("kbd",null,"Q"),M("/\u{1F5B1}\uFE0F-Wheel")])])]),n("tr",null,[n("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),n("td",null,[n("div",null,[n("kbd",null,"Space")])])]),n("tr",null,[n("td",null,"\u{1F3AF} Center puzzle in screen:"),n("td",null,[n("div",null,[n("kbd",null,"C")])])]),n("tr",null,[n("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),n("td",null,[n("div",null,[n("kbd",null,"F")])])]),n("tr",null,[n("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),n("td",null,[n("div",null,[n("kbd",null,"G")])])]),n("tr",null,[n("td",null,"\u{1F464} Toggle player names:"),n("td",null,[n("div",null,[n("kbd",null,"N")])])]),n("tr",null,[n("td",null,"\u{1F509} Toggle sounds:"),n("td",null,[n("div",null,[n("kbd",null,"M")])])]),n("tr",null,[n("td",null,"\u23EB Speed up (replay):"),n("td",null,[n("div",null,[n("kbd",null,"I")])])]),n("tr",null,[n("td",null,"\u23EC Speed down (replay):"),n("td",null,[n("div",null,[n("kbd",null,"O")])])]),n("tr",null,[n("td",null,"\u23F8\uFE0F Pause (replay):"),n("td",null,[n("div",null,[n("kbd",null,"P")])])])],-1);function Ui(e,t,o,s,l,r){const i=U("overlay");return v(),ne(i,{class:"transparent"},{default:Q(()=>[ki]),_:1})}var Nt=j(Ni,[["render",Ui]]),Vi="/assets/click.bb97cb07.mp3",Ri=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Vi}),zi="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",Li=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:zi}),Mi="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",Di=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Mi}),Fi="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Ii=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Fi}),Gi="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",Bi=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Gi});const xi=e=>{let t=!1;const o=()=>{t=!0},s=e.fps||60,l=e.slow||1,r=e.update,i=e.render,a=window.requestAnimationFrame,y=1/s,h=l*y;let S,$=0,w=window.performance.now();const O=()=>{for(S=window.performance.now(),$=$+Math.min(1,(S-w)/1e3);$>h;)$=$-h,r(y);i($/l),w=S,t||a(O)};return a(O),{stop:o}},Yi=.1,Wi=6,ji=.05;function Zi(){let e=0,t=0,o=1;const s=()=>({x:e,y:t,curZoom:o}),l=g=>{e=g.x,t=g.y,o=g.curZoom},r=()=>{e=0,t=0,o=1},i=(g,d)=>{e+=g/o,t+=d/o},a=g=>{const d=g==="in"?1:-1,R=o+ji*o*d;return Math.min(Math.max(R,Yi),Wi)},y=g=>o!=a(g),h=(g,d)=>{if(o==g)return!1;const R=1-o/g;return i(-d.x*R,-d.y*R),o=g,!0},S=(g,d)=>h(a(g),d),$=g=>{const{x:d,y:R}=w(g);return{x:Math.round(d),y:Math.round(R)}},w=g=>({x:g.x/o-e,y:g.y/o-t}),O=g=>{const{x:d,y:R}=E(g);return{x:Math.round(d),y:Math.round(R)}},E=g=>({x:(g.x+e)*o,y:(g.y+t)*o}),m=g=>{const{w:d,h:R}=V(g);return{w:Math.round(d),h:Math.round(R)}},V=g=>({w:g.w*o,h:g.h*o}),P=g=>{const{w:d,h:R}=_(g);return{w:Math.round(d),h:Math.round(R)}},_=g=>({w:g.w/o,h:g.h/o});return{getCurrentZoom:()=>o,reset:r,move:i,canZoom:y,zoom:S,setZoom:h,worldToViewport:O,worldToViewportRaw:E,worldDimToViewport:m,worldDimToViewportRaw:V,viewportToWorld:$,viewportToWorldRaw:w,viewportDimToWorld:P,viewportDimToWorldRaw:_,snapshot:s,fromSnapshot:l}}function kt(e=0,t=0){const o=document.createElement("canvas");return o.width=e,o.height=t,o}async function Ki(e){return new Promise(t=>{const o=new Image;o.onload=()=>{createImageBitmap(o).then(t)},o.src=e})}async function Hi(e,t,o){const s=kt(t,o);return s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,o),await createImageBitmap(s)}function qi(e,t,o){const s=kt(e.width,e.height),l=s.getContext("2d");return l.save(),l.drawImage(t,0,0),l.fillStyle=o,l.globalCompositeOperation="source-in",l.fillRect(0,0,t.width,t.height),l.restore(),l.save(),l.globalCompositeOperation="destination-over",l.drawImage(e,0,0),l.restore(),s}var re={createCanvas:kt,loadImageToBitmap:Ki,resizeBitmap:Hi,colorizedCanvas:qi};const Qi=Xe("Debug.js");let Ut=0,$o=0;const Xi=e=>{Ut=performance.now(),$o=e},Ji=e=>{const t=performance.now(),o=t-Ut;o>$o&&Qi.log(e+": "+o),Ut=t};var Te={checkpoint_start:Xi,checkpoint:Ji};function er(e,t){return{x:e.x-t.x,y:e.y-t.y}}function tr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Ao(e,t){const o=e.x-t.x,s=e.y-t.y;return Math.sqrt(o*o+s*s)}function or(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Vt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function nr(e,t,o){return{x:e.x+t,y:e.y+o,w:e.w,h:e.h}}function sr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function lr(e,t){return Ao(Vt(e),Vt(t))}var W={pointSub:er,pointAdd:tr,pointDistance:Ao,pointInBounds:or,rectCenter:Vt,rectMoved:nr,rectCenterDistance:lr,rectsOverlap:sr};const bo=Xe("PuzzleGraphics.js");async function ir(e,t,o){bo.log("start createPuzzleTileBitmaps");const s=o.tileSize,l=o.tileMarginWidth,r=o.tileDrawSize,i=s/100,a=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],y=new Array(t.length),h={};function S(m){const V=`${m.top}${m.right}${m.left}${m.bottom}`;if(h[V])return h[V];const P=new Path2D,_={x:l,y:l},g=W.pointAdd(_,{x:s,y:0}),d=W.pointAdd(g,{x:0,y:s}),R=W.pointSub(d,{x:s,y:0});if(P.moveTo(_.x,_.y),m.top!==0)for(let u=0;u<a.length/6;u++){const T=W.pointAdd(_,{x:a[u*6+0]*i,y:m.top*a[u*6+1]*i}),z=W.pointAdd(_,{x:a[u*6+2]*i,y:m.top*a[u*6+3]*i}),N=W.pointAdd(_,{x:a[u*6+4]*i,y:m.top*a[u*6+5]*i});P.bezierCurveTo(T.x,T.y,z.x,z.y,N.x,N.y)}else P.lineTo(g.x,g.y);if(m.right!==0)for(let u=0;u<a.length/6;u++){const T=W.pointAdd(g,{x:-m.right*a[u*6+1]*i,y:a[u*6+0]*i}),z=W.pointAdd(g,{x:-m.right*a[u*6+3]*i,y:a[u*6+2]*i}),N=W.pointAdd(g,{x:-m.right*a[u*6+5]*i,y:a[u*6+4]*i});P.bezierCurveTo(T.x,T.y,z.x,z.y,N.x,N.y)}else P.lineTo(d.x,d.y);if(m.bottom!==0)for(let u=0;u<a.length/6;u++){const T=W.pointSub(d,{x:a[u*6+0]*i,y:m.bottom*a[u*6+1]*i}),z=W.pointSub(d,{x:a[u*6+2]*i,y:m.bottom*a[u*6+3]*i}),N=W.pointSub(d,{x:a[u*6+4]*i,y:m.bottom*a[u*6+5]*i});P.bezierCurveTo(T.x,T.y,z.x,z.y,N.x,N.y)}else P.lineTo(R.x,R.y);if(m.left!==0)for(let u=0;u<a.length/6;u++){const T=W.pointSub(R,{x:-m.left*a[u*6+1]*i,y:a[u*6+0]*i}),z=W.pointSub(R,{x:-m.left*a[u*6+3]*i,y:a[u*6+2]*i}),N=W.pointSub(R,{x:-m.left*a[u*6+5]*i,y:a[u*6+4]*i});P.bezierCurveTo(T.x,T.y,z.x,z.y,N.x,N.y)}else P.lineTo(_.x,_.y);return h[V]=P,P}const $=re.createCanvas(r,r),w=$.getContext("2d"),O=re.createCanvas(r,r),E=O.getContext("2d");for(const m of t){const V=F.decodePiece(m),P=rr(o,V.idx),_=S(F.decodeShape(o.shapes[V.idx]));w.clearRect(0,0,r,r),w.save(),w.lineWidth=2,w.stroke(_),w.globalCompositeOperation="source-in",w.drawImage(e,P.x-l,P.y-l,r,r,0,0,r,r),w.restore(),w.save(),w.globalCompositeOperation="source-in",w.globalAlpha=.2,w.fillStyle="black",w.fillRect(0,0,$.width,$.height),w.restore(),w.save(),w.clip(_),w.drawImage(e,P.x-l,P.y-l,r,r,0,0,r,r),w.restore(),w.save(),w.clip(_),w.strokeStyle="rgba(0,0,0,.4)",w.lineWidth=0,w.shadowColor="black",w.shadowBlur=2,w.shadowOffsetX=-1,w.shadowOffsetY=-1,w.stroke(_),w.restore(),w.save(),w.clip(_),w.strokeStyle="rgba(255,255,255,.4)",w.lineWidth=0,w.shadowColor="white",w.shadowBlur=2,w.shadowOffsetX=1,w.shadowOffsetY=1,w.stroke(_),w.restore(),E.clearRect(0,0,r,r),E.save(),E.lineWidth=1,E.stroke(_),E.globalCompositeOperation="source-in",E.drawImage(e,P.x-l,P.y-l,r,r,0,0,r,r),E.restore(),w.drawImage(O,0,0),y[V.idx]=await createImageBitmap($)}return bo.log("end createPuzzleTileBitmaps"),y}function rr(e,t){const o=F.coordByPieceIdx(e,t);return{x:o.x*e.tileSize,y:o.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function ar(e){const t=await re.loadImageToBitmap(e.info.imageUrl),o=await re.resizeBitmap(t,e.info.width,e.info.height);return await ir(o,e.tiles,e.info)}var ur={loadPuzzleBitmaps:ar};const Oo=30,C={};function cr(e){return!!C[e]||!1}function dr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function pr(e,t){C[e]=t}function Je(e,t){let o=0;for(const s of C[e].players){if(F.decodePlayer(s).id===t)return o;o++}return-1}function gr(e,t){return C[e].players.length>t?F.decodePlayer(C[e].players[t]).id:null}function Ce(e,t){const o=Je(e,t);return o===-1?null:F.decodePlayer(C[e].players[o])}function Rt(e,t,o){const s=Je(e,t);s===-1?C[e].players.push(F.encodePlayer(o)):C[e].players[s]=F.encodePlayer(o)}function hr(e,t,o){C[e].puzzle.tiles[t]=F.encodePiece(o)}function fr(e,t){C[e].puzzle.data=t}function No(e,t){return Je(e,t)!==-1}function mr(e,t){const o=t-Oo*pe.SEC;return ko(e).filter(s=>s.ts>=o)}function yr(e,t){const o=t-Oo*pe.SEC;return ko(e).filter(s=>s.ts<o&&s.points>0)}function _r(e,t,o){No(e,t)?X(e,t,{ts:o}):Rt(e,t,dr(t,o))}function Er(e,t){return t in C[e].evtInfos?C[e].evtInfos[t]:{_last_mouse:null,_last_mouse_down:null}}function vr(e,t,o){C[e].evtInfos[t]=o}function wr(){return Object.values(C).sort((e,t)=>{const o=Vo(e.id);return o===Vo(t.id)?o?t.puzzle.data.finished-e.puzzle.data.finished:t.puzzle.data.started-e.puzzle.data.started:o?1:-1})}function ko(e){return C[e]?C[e].players.map(F.decodePlayer):[]}function Pr(e){return C[e]||null}function et(e){return C[e].puzzle.tiles.length}function Tr(e){var o;const t=((o=C[e].puzzle.info.image)==null?void 0:o.url)||C[e].puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function zt(e){return C[e].scoreMode}function Uo(e){return C[e].snapMode}function Vo(e){return tt(e)===et(e)}function tt(e){let t=0;for(const o of C[e].puzzle.tiles)F.decodePiece(o).owner===-1&&t++;return t}function Cr(e){return C[e].puzzle.tiles.map(F.decodePiece).sort((o,s)=>o.z-s.z)}function X(e,t,o){const s=Ce(e,t);if(s!==null){for(const l of Object.keys(o))s[l]=o[l];Rt(e,t,s)}}function ot(e,t){for(const o of Object.keys(t))C[e].puzzle.data[o]=t[o]}function Se(e,t,o){for(const s of Object.keys(o)){const l=F.decodePiece(C[e].puzzle.tiles[t]);l[s]=o[s],C[e].puzzle.tiles[t]=F.encodePiece(l)}}const $e=(e,t)=>F.decodePiece(C[e].puzzle.tiles[t]),nt=(e,t)=>$e(e,t).group,Sr=(e,t)=>{const o=C[e].puzzle.info;return t===0||t===o.tilesX-1||t===o.tiles-o.tilesX||t===o.tiles-1},Ro=(e,t)=>{const o=C[e].puzzle.info,s={x:(o.table.width-o.width)/2,y:(o.table.height-o.height)/2},l=Rr(e,t);return W.pointAdd(s,l)},st=(e,t)=>$e(e,t).pos,Lt=e=>{const t=Bo(e),o=xo(e),s=Math.round(t/4),l=Math.round(o/4);return{x:0-s,y:0-l,w:t+2*s,h:o+2*l}},$r=(e,t)=>{const o=Nr(e),s=$e(e,t);return{x:s.pos.x,y:s.pos.y,w:o,h:o}},Ar=(e,t)=>$e(e,t).z,Mt=(e,t)=>{for(const o of C[e].puzzle.tiles){const s=F.decodePiece(o);if(s.owner===t)return s.idx}return-1},br=(e,t)=>{const o=Mt(e,t);return o<0?null:C[e].puzzle.tiles[o]},Or=e=>C[e].puzzle.info.tileDrawOffset,zo=e=>C[e].puzzle.info.tileDrawSize,Nr=e=>C[e].puzzle.info.tileSize,kr=e=>C[e].puzzle.data.started,Ur=e=>C[e].puzzle.data.finished,Lo=e=>C[e].puzzle.data.maxGroup,Mo=e=>C[e].puzzle.data.maxZ,Vr=(e,t)=>{let o=0;for(const s of t){const l=Ar(e,s);l>o&&(o=l)}return o};function Rr(e,t){const o=C[e].puzzle.info,s=F.coordByPieceIdx(o,t),l=s.x*o.tileSize,r=s.y*o.tileSize;return{x:l,y:r}}function zr(e,t){const o=C[e].puzzle.info,s=F.coordByPieceIdx(o,t);return[s.y>0?t-o.tilesX:-1,s.x<o.tilesX-1?t+1:-1,s.y<o.tilesY-1?t+o.tilesX:-1,s.x>0?t-1:-1]}const Do=(e,t,o)=>{for(const s of t)Se(e,s,{z:o})},Lr=(e,t,o)=>{const s=st(e,t),l=W.pointAdd(s,o);Se(e,t,{pos:l})},Dt=(e,t,o)=>{const s=zo(e),l=Lt(e),r=o;for(const i of t){const a=$e(e,i);a.pos.x+o.x<l.x?r.x=Math.max(l.x-a.pos.x,r.x):a.pos.x+s+o.x>l.x+l.w&&(r.x=Math.min(l.x+l.w-a.pos.x+s,r.x)),a.pos.y+o.y<l.y?r.y=Math.max(l.y-a.pos.y,r.y):a.pos.y+s+o.y>l.y+l.h&&(r.y=Math.min(l.y+l.h-a.pos.y+s,r.y))}for(const i of t)Lr(e,i,r)},Mr=(e,t)=>Dr(e,t)===-1,Dr=(e,t)=>$e(e,t).owner,Fo=(e,t)=>{for(const o of t)Se(e,o,{owner:-1,z:1})},Io=(e,t,o)=>{for(const s of t)Se(e,s,{owner:o})};function Re(e,t){const o=C[e].puzzle.tiles,s=F.decodePiece(o[t]),l=[];if(s.group)for(const r of o){const i=F.decodePiece(r);i.group===s.group&&l.push(i.idx)}else l.push(s.idx);return l}const Fr=(e,t)=>{const o=C[e].puzzle.info,s=C[e].puzzle.tiles;let l=-1,r=-1;for(let i=0;i<s.length;i++){const a=F.decodePiece(s[i]);if(a.owner!==0)continue;const y={x:a.pos.x,y:a.pos.y,w:o.tileSize,h:o.tileSize};W.pointInBounds(t,y)&&(l===-1||a.z>l)&&(l=a.z,r=i)}return r},Ir=(e,t)=>{const o=Ce(e,t);return o?o.bgcolor:null},Gr=(e,t)=>{const o=Ce(e,t);return o?o.color:null},Br=(e,t)=>{const o=Ce(e,t);return o?o.name:null},Go=(e,t)=>{const o=Ce(e,t);return o?o.points:0},xr=(e,t,o)=>{const s=nt(e,t),l=nt(e,o);return!!(s&&s===l)},Bo=e=>C[e].puzzle.info.table.width,xo=e=>C[e].puzzle.info.table.height,Yr=e=>C[e].puzzle,Wr=e=>C[e].rng.obj,jr=e=>C[e].puzzle.info.width,Zr=e=>C[e].puzzle.info.height;function Kr(e,t,o,s,l){const r=C[e].puzzle,i=Er(e,t),a=[],y=()=>{a.push([p.CHANGE_DATA,r.data])},h=E=>{a.push([p.CHANGE_TILE,F.encodePiece($e(e,E))])},S=E=>{for(const m of E)h(m)},$=()=>{const E=Ce(e,t);!E||a.push([p.CHANGE_PLAYER,F.encodePlayer(E)])},w=(E,m,V)=>{const P=C[E].puzzle.tiles,_=nt(E,m),g=nt(E,V);let d;const R=[];if(_&&R.push(_),g&&R.push(g),_)d=_;else if(g)d=g;else{const u=Lo(E)+1;ot(E,{maxGroup:u}),y(),d=Lo(E)}if(Se(E,m,{group:d}),h(m),Se(E,V,{group:d}),h(V),R.length>0)for(const u of P){const T=F.decodePiece(u);R.includes(T.group)&&(Se(E,T.idx,{group:d}),h(T.idx))}},O=o[0];if(O===p.INPUT_EV_BG_COLOR){const E=o[1];X(e,t,{bgcolor:E,ts:s}),$()}else if(O===p.INPUT_EV_PLAYER_COLOR){const E=o[1];X(e,t,{color:E,ts:s}),$()}else if(O===p.INPUT_EV_PLAYER_NAME){const E=`${o[1]}`.substr(0,16);X(e,t,{name:E,ts:s}),$()}else if(O===p.INPUT_EV_MOVE){const E=o[1],m=o[2],V=Ce(e,t);if(V){const P=V.x-E,_=V.y-m;X(e,t,{ts:s,x:P,y:_}),$()}}else if(O===p.INPUT_EV_MOUSE_DOWN){const E=o[1],m=o[2],V={x:E,y:m};X(e,t,{d:1,ts:s}),$(),i._last_mouse_down=V;const P=Fr(e,V);if(P>=0){const _=Mo(e)+1;ot(e,{maxZ:_}),y();const g=Re(e,P);Do(e,g,Mo(e)),Io(e,g,t),S(g)}i._last_mouse=V}else if(O===p.INPUT_EV_MOUSE_MOVE){const E=o[1],m=o[2],V={x:E,y:m};if(i._last_mouse_down===null)X(e,t,{x:E,y:m,ts:s}),$();else{const P=Mt(e,t);if(P>=0){X(e,t,{x:E,y:m,ts:s}),$();const _=Re(e,P);let g=W.pointInBounds(V,Lt(e))&&W.pointInBounds(i._last_mouse_down,Lt(e));for(const d of _){const R=$r(e,d);if(W.pointInBounds(V,R)){g=!0;break}}if(g){const d=E-i._last_mouse_down.x,R=m-i._last_mouse_down.y;Dt(e,_,{x:d,y:R}),S(_)}}else X(e,t,{ts:s}),$();i._last_mouse_down=V}i._last_mouse=V}else if(O===p.INPUT_EV_MOUSE_UP){const E=o[1],m=o[2],V={x:E,y:m},P=0;i._last_mouse_down=null;const _=Mt(e,t);if(_>=0){const g=Re(e,_);Io(e,g,0),S(g);const d=st(e,_),R=Ro(e,_);let u=!1;if(Uo(e)===Pe.REAL){for(const T of g)if(Sr(e,T)){u=!0;break}}else u=!0;if(u&&W.pointDistance(R,d)<r.info.snapDistance){const T=W.pointSub(R,d);Dt(e,g,T),Fo(e,g),S(g);let z=Go(e,t);zt(e)===ye.FINAL?z+=g.length:zt(e)===ye.ANY&&(z+=1),X(e,t,{d:P,ts:s,points:z}),$(),tt(e)===et(e)&&(ot(e,{finished:s}),y()),l&&l(t)}else{const T=(N,te,he,ze)=>{const Ae=C[N].puzzle.info;if(he<0||xr(N,te,he))return!1;const Ye=st(N,te),Le=W.pointAdd(st(N,he),{x:ze[0]*Ae.tileSize,y:ze[1]*Ae.tileSize});if(W.pointDistance(Ye,Le)<Ae.snapDistance){const it=W.pointSub(Le,Ye);let fe=Re(N,te);if(Dt(N,fe,it),w(N,te,he),fe=Re(N,te),Mr(N,he))Fo(N,fe);else{const Me=Vr(N,fe);Do(N,fe,Me)}return S(fe),!0}return!1};let z=!1;for(const N of Re(e,_)){const te=zr(e,N);if(T(e,N,te[0],[0,1])||T(e,N,te[1],[-1,0])||T(e,N,te[2],[0,-1])||T(e,N,te[3],[1,0])){z=!0;break}}if(z&&zt(e)===ye.ANY){const N=Go(e,t)+1;X(e,t,{d:P,ts:s,points:N}),$()}else X(e,t,{d:P,ts:s}),$();z&&Uo(e)===Pe.REAL&&tt(e)===et(e)&&(ot(e,{finished:s}),y()),z&&l&&l(t)}}else X(e,t,{d:P,ts:s}),$();i._last_mouse=V}else if(O===p.INPUT_EV_ZOOM_IN){const E=o[1],m=o[2];X(e,t,{x:E,y:m,ts:s}),$(),i._last_mouse={x:E,y:m}}else if(O===p.INPUT_EV_ZOOM_OUT){const E=o[1],m=o[2];X(e,t,{x:E,y:m,ts:s}),$(),i._last_mouse={x:E,y:m}}else X(e,t,{ts:s}),$();return vr(e,t,i),a}var k={setGame:pr,exists:cr,playerExists:No,getActivePlayers:mr,getIdlePlayers:yr,addPlayer:_r,getFinishedPiecesCount:tt,getPieceCount:et,getImageUrl:Tr,get:Pr,getAllGames:wr,getPlayerBgColor:Ir,getPlayerColor:Gr,getPlayerName:Br,getPlayerIndexById:Je,getPlayerIdByIndex:gr,changePlayer:X,setPlayer:Rt,setPiece:hr,setPuzzleData:fr,getTableWidth:Bo,getTableHeight:xo,getPuzzle:Yr,getRng:Wr,getPuzzleWidth:jr,getPuzzleHeight:Zr,getPiecesSortedByZIndex:Cr,getFirstOwnedPiece:br,getPieceDrawOffset:Or,getPieceDrawSize:zo,getFinalPiecePos:Ro,getStartTs:kr,getFinishTs:Ur,handleInput:Kr};let Yo=-10,Wo=20,Ft=2,jo=15;const Hr=5,qr=5,It=1,Qr=200,Zo=10,Xr=100,Jr=10,ea=1,ta=5;function oa(e){const t=e.random(0,255),o=e.random(0,255),s=e.random(0,255);return"rgba("+t+","+o+","+s+", 0.8)"}class Ko{constructor(t){this.radius=Zo,this.previousRadius=Zo,this.explodingDuration=Xr,this.hasExploded=!1,this.alive=!0,this.color=oa(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Yo+Math.random()*Wo,this.vy=(Ft+Math.random()*jo)*-1,this.duration=0}update(t){if(this.hasExploded){const o=Qr-this.radius;this.previousRadius=this.radius,this.radius+=o/Jr,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=It,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const o=3+Math.floor(Math.random()*3);for(let s=0;s<o;s++){const l=10+Math.floor(Math.random()*21),r=Hr+Math.random()*qr,i=2*Math.PI/l,a=Math.random()*i;for(let y=0;y<l;y++)t.push(new na(this,y*i+a,r))}}}class na{constructor(t,o,s){this.px=t.px,this.py=t.py,this.vx=Math.cos(o)*s,this.vy=Math.sin(o)*s,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=It/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class sa{constructor(t,o){this.canvas=t,this.rng=o,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,o=0;for(;t<this.canvas.height&&o>=0;)o+=It,t+=o;Ft=o/2,jo=o-Ft;const s=1/4*this.canvas.width/(o/2);Yo=-s,Wo=2*s}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<ea;t++)this.readyBombs.push(new Ko(this.rng))}update(){Math.random()*100<ta&&this.readyBombs.push(new Ko(this.rng));const t=[];for(;this.explodedBombs.length>0;){const l=this.explodedBombs.shift();if(!l)break;l.update(),l.alive&&t.push(l)}this.explodedBombs=t;const o=[];for(;this.readyBombs.length>0;){const l=this.readyBombs.shift();if(!l)break;l.update(this.particles),l.hasExploded?this.explodedBombs.push(l):o.push(l)}this.readyBombs=o;const s=[];for(;this.particles.length>0;){const l=this.particles.shift();if(!l)break;l.update(),l.alive&&s.push(l)}this.particles=s}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}const J={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},ge={SOUND_VOLUME:100,SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},Gt=(e,t)=>{localStorage.setItem(e,t)},Bt=e=>localStorage.getItem(e),la=(e,t)=>{Gt(e,`${t}`)},ia=(e,t)=>{const o=Bt(e);if(o===null)return t;const s=parseInt(o,10);return isNaN(s)?t:s},ra=(e,t)=>{Gt(e,t?"1":"0")},aa=(e,t)=>{const o=Bt(e);return o===null?t:o==="1"},ua=(e,t)=>{Gt(e,t)},ca=(e,t)=>{const o=Bt(e);return o===null?t:o};var q={setInt:la,getInt:ia,setBool:ra,getBool:aa,setStr:ua,getStr:ca};function da(e,t,o,s){let l=[],r=!0,i=!1,a=!1,y=!1,h=!1,S=!1,$=!1,w=!1;const O=(u,T)=>{const z=o.viewportToWorld({x:u,y:T});return[z.x,z.y]},E=u=>O(u.offsetX,u.offsetY),m=()=>O(e.width/2,e.height/2),V=(u,T)=>{!r||(T.code==="ShiftLeft"||T.code==="ShiftRight"?w=u:T.code==="ArrowUp"||T.code==="KeyW"?y=u:T.code==="ArrowDown"||T.code==="KeyS"?h=u:T.code==="ArrowLeft"||T.code==="KeyA"?i=u:T.code==="ArrowRight"||T.code==="KeyD"?a=u:T.code==="KeyQ"?$=u:T.code==="KeyE"&&(S=u))};let P=null;e.addEventListener("mousedown",u=>{P=E(u),u.button===0&&_([p.INPUT_EV_MOUSE_DOWN,...P])}),e.addEventListener("mouseup",u=>{P=E(u),u.button===0&&_([p.INPUT_EV_MOUSE_UP,...P])}),e.addEventListener("mousemove",u=>{P=E(u),_([p.INPUT_EV_MOUSE_MOVE,...P])}),e.addEventListener("wheel",u=>{if(P=E(u),o.canZoom(u.deltaY<0?"in":"out")){const T=u.deltaY<0?p.INPUT_EV_ZOOM_IN:p.INPUT_EV_ZOOM_OUT;_([T,...P])}}),t.addEventListener("keydown",u=>V(!0,u)),t.addEventListener("keyup",u=>V(!1,u)),t.addEventListener("keypress",u=>{if(!!r){if(s===ue&&(u.code==="KeyI"?_([p.INPUT_EV_REPLAY_SPEED_UP]):u.code==="KeyO"?_([p.INPUT_EV_REPLAY_SPEED_DOWN]):u.code==="KeyP"&&_([p.INPUT_EV_REPLAY_TOGGLE_PAUSE])),u.code==="Space")_([p.INPUT_EV_TOGGLE_PREVIEW]);else if(u.code==="KeyF")_([p.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(u.code==="KeyG")_([p.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(u.code==="KeyM")_([p.INPUT_EV_TOGGLE_SOUNDS]);else if(u.code==="KeyN")_([p.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(u.code==="KeyC")_([p.INPUT_EV_CENTER_FIT_PUZZLE]);else if(u.code==="Digit1"){const T=u.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;_([T,1])}else if(u.code==="Digit2"){const T=u.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;_([T,2])}else if(u.code==="Digit3"){const T=u.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;_([T,3])}}});const _=u=>{l.push(u)};return{addEvent:_,consumeAll:()=>{if(l.length===0)return[];const u=l.slice();return l=[],u},createKeyEvents:()=>{const u=(i?1:0)-(a?1:0),T=(y?1:0)-(h?1:0);if(u!==0||T!==0){const z=(w?24:12)*Math.sqrt(o.getCurrentZoom()),N=o.viewportDimToWorld({w:u*z,h:T*z});_([p.INPUT_EV_MOVE,N.w,N.h]),P&&(P[0]-=N.w,P[1]-=N.h)}if(!(S&&$)){if(S){if(o.canZoom("in")){const z=P||m();_([p.INPUT_EV_ZOOM_IN,...z])}}else if($&&o.canZoom("out")){const z=P||m();_([p.INPUT_EV_ZOOM_OUT,...z])}}},setHotkeys:u=>{r=u}}}const lt={"./grab.png":Li,"./grab_mask.png":Di,"./hand.png":Ii,"./hand_mask.png":Bi},pa={"./click.mp3":Ri},Ge="play",ue="replay";let Be=!0,xe=!0;const ga=e=>e.owner===-1?Be:xe;let Z=!0;function ha(e,t){return t.width=window.innerWidth,t.height=window.innerHeight,e.appendChild(t),window.addEventListener("resize",()=>{t.width=window.innerWidth,t.height=window.innerHeight,Z=!0}),t}async function Ho(e,t,o,s,l,r){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const i=c=>s===ue||c.id!==t,a=pa["./click.mp3"].default,y=new Audio(a),h=await re.loadImageToBitmap(lt["./grab.png"].default),S=await re.loadImageToBitmap(lt["./hand.png"].default),$=await re.loadImageToBitmap(lt["./grab_mask.png"].default),w=await re.loadImageToBitmap(lt["./hand_mask.png"].default),O=h.width,E=Math.round(O/2),m=h.height,V=Math.round(m/2),P={},_=async c=>{const f=c.color+" "+c.d;if(!P[f]){const b=c.d?h:S;if(c.color){const B=c.d?$:w;P[f]=await createImageBitmap(re.colorizedCanvas(b,B,c.color))}else P[f]=b}return P[f]},g=ha(l,re.createCanvas()),d={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Ee.onConnectionStateChange(c=>{r.setConnectionState(c)});const R=async c=>{const f=d.dataOffset;d.dataOffset+=1e4;const b=await Ee.requestReplayData(c,f);return d.log=d.log.slice(d.logPointer),d.logPointer=0,d.log.push(...b.log),b.log.length===0&&(d.final=!0),b};let u=()=>0;const T=async()=>{if(s===Ge){const c=await Ee.connect(o,e,t),f=F.decodeGame(c);k.setGame(f.id,f),u=()=>pe.timestamp()}else if(s===ue){const c=await R(e);if(!c.game)throw"[ 2021-05-29 no game received ]";const f=F.decodeGame(c.game);k.setGame(f.id,f),d.lastRealTs=pe.timestamp(),d.gameStartTs=parseInt(c.log[0][4],10),d.lastGameTs=d.gameStartTs,u=()=>d.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";Z=!0};await T();const z=k.getPieceDrawOffset(e),N=k.getPieceDrawSize(e),te=k.getPuzzleWidth(e),he=k.getPuzzleHeight(e),ze=k.getTableWidth(e),Ae=k.getTableHeight(e),Ye={x:(ze-te)/2,y:(Ae-he)/2},Le={w:te,h:he},it={w:N,h:N},fe=await ur.loadPuzzleBitmaps(k.getPuzzle(e)),Me=new sa(g,k.getRng(e));Me.init();const ce=g.getContext("2d");g.classList.add("loaded"),r.setPuzzleCut();let xt="";const oe={},L=Zi(),qo=()=>{L.reset(),L.move(-(ze-g.width)/2,-(Ae-g.height)/2);const c=L.worldDimToViewport(Le),f=20,b=g.width-f*2,B=g.height-f*2;if(c.w>b||c.h>B||c.w<b&&c.h<B){const D=Math.min(b/c.w,B/c.h);L.setZoom(D,{x:g.width/2,y:g.height/2})}},We=c=>{oe.last&&xt===c?(L.fromSnapshot(oe.last),delete oe.last):oe[c]&&(oe.last=L.snapshot(),xt=c,L.fromSnapshot(oe[c]))};qo(),oe.center=L.snapshot();const be=da(g,window,L,s),Qo=k.getImageUrl(e),rt=()=>{const c=k.getStartTs(e),f=k.getFinishTs(e),b=u();r.setFinished(!!f),r.setDuration((f||b)-c)};rt(),r.setPiecesDone(k.getFinishedPiecesCount(e)),r.setPiecesTotal(k.getPieceCount(e));const Yt=u();r.setPlayers(k.getActivePlayers(e,Yt),k.getIdlePlayers(e,Yt));const Wt=!!k.getFinishTs(e);let at=Wt;const jt=()=>at&&!Wt,Zt=()=>q.getInt(J.SOUND_VOLUME,ge.SOUND_VOLUME),Kt=()=>q.getBool(J.SOUND_ENABLED,ge.SOUND_ENABLED),Ht=()=>q.getBool(J.SHOW_PLAYER_NAMES,ge.SHOW_PLAYER_NAMES),qt=()=>{const c=Zt();y.volume=c/100,y.play()},Qt=()=>s===ue?q.getStr(J.COLOR_BACKGROUND,ge.COLOR_BACKGROUND):k.getPlayerBgColor(e,t)||q.getStr(J.COLOR_BACKGROUND,ge.COLOR_BACKGROUND),Xt=()=>s===ue?q.getStr(J.PLAYER_COLOR,ge.PLAYER_COLOR):k.getPlayerColor(e,t)||q.getStr(J.PLAYER_COLOR,ge.PLAYER_COLOR),Xo=()=>s===ue?q.getStr(J.PLAYER_NAME,ge.PLAYER_NAME):k.getPlayerName(e,t)||q.getStr(J.PLAYER_NAME,ge.PLAYER_NAME);let Jt="",eo="",to=!1;const De=c=>{to=c;const[f,b]=c?[Jt,"grab"]:[eo,"default"];g.style.cursor=`url('${f}') ${E} ${V}, ${b}`},ut=c=>{Jt=re.colorizedCanvas(h,$,c).toDataURL(),eo=re.colorizedCanvas(S,w,c).toDataURL(),De(to)};ut(Xt());const je=()=>{r.setReplaySpeed&&r.setReplaySpeed(d.speeds[d.speedIdx]),r.setReplayPaused&&r.setReplayPaused(d.paused)},oo=()=>{d.speedIdx+1<d.speeds.length&&(d.speedIdx++,je())},no=()=>{d.speedIdx>=1&&(d.speedIdx--,je())},so=()=>{d.paused=!d.paused,je()},lo=[];let Ze;const Jo=()=>{lo.forEach(c=>{clearInterval(c)}),Ze&&clearTimeout(Ze)};let ct;const en=()=>{Jo(),ct&&ct.stop()};if(s===Ge?lo.push(setInterval(()=>{rt()},1e3)):s===ue&&je(),s===Ge)Ee.onServerChange(c=>{c[0],c[1],c[2];const f=c[3];for(const[b,B]of f)switch(b){case p.CHANGE_PLAYER:{const D=F.decodePlayer(B);D.id!==t&&(k.setPlayer(e,D.id,D),Z=!0)}break;case p.CHANGE_TILE:{const D=F.decodePiece(B);k.setPiece(e,D.idx,D),Z=!0}break;case p.CHANGE_DATA:k.setPuzzleData(e,B),Z=!0;break}at=!!k.getFinishTs(e)});else if(s===ue){const c=(B,D)=>{const H=B;if(H[0]===p.LOG_ADD_PLAYER){const I=H[1];return k.addPlayer(e,I,D),!0}if(H[0]===p.LOG_UPDATE_PLAYER){const I=k.getPlayerIdByIndex(e,H[1]);if(!I)throw"[ 2021-05-17 player not found (update player) ]";return k.addPlayer(e,I,D),!0}if(H[0]===p.LOG_HANDLE_INPUT){const I=k.getPlayerIdByIndex(e,H[1]);if(!I)throw"[ 2021-05-17 player not found (handle input) ]";const de=H[2];return k.handleInput(e,I,de,D),!0}return!1};let f=d.lastGameTs;const b=async()=>{d.logPointer+1>=d.log.length&&await R(e);const B=pe.timestamp();if(d.paused){d.lastRealTs=B,Ze=setTimeout(b,50);return}const H=(B-d.lastRealTs)*d.speeds[d.speedIdx];let I=d.lastGameTs+H;do{if(d.paused)break;const de=d.logPointer+1;if(de>=d.log.length)break;const Ke=d.log[d.logPointer],io=f+Ke[Ke.length-1],dt=d.log[de],ro=dt[dt.length-1],pt=io+ro;if(pt>I){I+500*pe.MS<pt&&(I+=ro);break}f=io,c(dt,pt)&&(Z=!0),d.logPointer=de}while(!0);d.lastRealTs=B,d.lastGameTs=I,rt(),d.final||(Ze=setTimeout(b,50))};b()}let le=null;return ct=xi({update:()=>{be.createKeyEvents();for(const c of be.consumeAll())if(s===Ge){const f=c[0];if(f===p.INPUT_EV_MOVE){const D=c[1],H=c[2],I=L.worldDimToViewport({w:D,h:H});Z=!0,L.move(I.w,I.h),delete oe.last}else if(f===p.INPUT_EV_MOUSE_MOVE){if(le&&!k.getFirstOwnedPiece(e,t)){const D={x:c[1],y:c[2]},H=L.worldToViewport(D),I=Math.round(H.x-le.x),de=Math.round(H.y-le.y);Z=!0,L.move(I,de),le=H,delete oe.last}}else if(f===p.INPUT_EV_PLAYER_COLOR)ut(c[1]);else if(f===p.INPUT_EV_MOUSE_DOWN){const D={x:c[1],y:c[2]};le=L.worldToViewport(D),De(!0)}else if(f===p.INPUT_EV_MOUSE_UP)le=null,De(!1);else if(f===p.INPUT_EV_ZOOM_IN){const D={x:c[1],y:c[2]};Z=!0,L.zoom("in",L.worldToViewport(D)),delete oe.last}else if(f===p.INPUT_EV_ZOOM_OUT){const D={x:c[1],y:c[2]};Z=!0,L.zoom("out",L.worldToViewport(D)),delete oe.last}else if(f===p.INPUT_EV_TOGGLE_PREVIEW)r.togglePreview();else if(f===p.INPUT_EV_TOGGLE_SOUNDS)r.toggleSoundsEnabled();else if(f===p.INPUT_EV_TOGGLE_PLAYER_NAMES)r.togglePlayerNames();else if(f===p.INPUT_EV_CENTER_FIT_PUZZLE)We("center");else if(f===p.INPUT_EV_TOGGLE_FIXED_PIECES)Be=!Be,Z=!0;else if(f===p.INPUT_EV_TOGGLE_LOOSE_PIECES)xe=!xe,Z=!0;else if(f===p.INPUT_EV_STORE_POS){const D=`${c[1]}`;oe[D]=L.snapshot()}else if(f===p.INPUT_EV_RESTORE_POS){const D=`${c[1]}`;We(D)}const b=u();k.handleInput(e,t,c,b,D=>{Kt()&&qt()}).length>0&&(Z=!0),Ee.sendClientEvent(c)}else if(s===ue){const f=c[0];if(f===p.INPUT_EV_REPLAY_TOGGLE_PAUSE)so();else if(f===p.INPUT_EV_REPLAY_SPEED_DOWN)no();else if(f===p.INPUT_EV_REPLAY_SPEED_UP)oo();else if(f===p.INPUT_EV_MOVE){const b=c[1],B=c[2];Z=!0,L.move(b,B)}else if(f===p.INPUT_EV_MOUSE_MOVE){if(le){const b={x:c[1],y:c[2]},B=L.worldToViewport(b),D=Math.round(B.x-le.x),H=Math.round(B.y-le.y);Z=!0,L.move(D,H),le=B}}else if(f===p.INPUT_EV_PLAYER_COLOR)ut(c[1]);else if(f===p.INPUT_EV_MOUSE_DOWN){const b={x:c[1],y:c[2]};le=L.worldToViewport(b),De(!0)}else if(f===p.INPUT_EV_MOUSE_UP)le=null,De(!1);else if(f===p.INPUT_EV_ZOOM_IN){const b={x:c[1],y:c[2]};Z=!0,L.zoom("in",L.worldToViewport(b))}else if(f===p.INPUT_EV_ZOOM_OUT){const b={x:c[1],y:c[2]};Z=!0,L.zoom("out",L.worldToViewport(b))}else if(f===p.INPUT_EV_TOGGLE_PREVIEW)r.togglePreview();else if(f===p.INPUT_EV_TOGGLE_SOUNDS)r.toggleSoundsEnabled();else if(f===p.INPUT_EV_TOGGLE_PLAYER_NAMES)r.togglePlayerNames();else if(f===p.INPUT_EV_CENTER_FIT_PUZZLE)We("center");else if(f===p.INPUT_EV_TOGGLE_FIXED_PIECES)Be=!Be,Z=!0;else if(f===p.INPUT_EV_TOGGLE_LOOSE_PIECES)xe=!xe,Z=!0;else if(f===p.INPUT_EV_STORE_POS){const b=`${c[1]}`;oe[b]=L.snapshot()}else if(f===p.INPUT_EV_RESTORE_POS){const b=`${c[1]}`;We(b)}}at=!!k.getFinishTs(e),jt()&&(Me.update(),Z=!0)},render:async()=>{if(!Z)return;const c=u();let f,b,B;window.DEBUG&&Te.checkpoint_start(0),ce.fillStyle=Qt(),ce.fillRect(0,0,g.width,g.height),window.DEBUG&&Te.checkpoint("clear done"),f=L.worldToViewportRaw(Ye),b=L.worldDimToViewportRaw(Le),ce.fillStyle="rgba(255, 255, 255, .3)",ce.fillRect(f.x,f.y,b.w,b.h),window.DEBUG&&Te.checkpoint("board done");const D=k.getPiecesSortedByZIndex(e);window.DEBUG&&Te.checkpoint("get tiles done"),b=L.worldDimToViewportRaw(it);for(const I of D)!ga(I)||(B=fe[I.idx],f=L.worldToViewportRaw({x:z+I.pos.x,y:z+I.pos.y}),ce.drawImage(B,0,0,B.width,B.height,f.x,f.y,b.w,b.h));window.DEBUG&&Te.checkpoint("tiles done");const H=[];for(const I of k.getActivePlayers(e,c))i(I)&&(B=await _(I),f=L.worldToViewport(I),ce.drawImage(B,f.x-E,f.y-V),Ht()&&H.push([`${I.name} (${I.points})`,f.x,f.y+m]));ce.fillStyle="white",ce.textAlign="center";for(const[I,de,Ke]of H)ce.fillText(I,de,Ke);window.DEBUG&&Te.checkpoint("players done"),r.setPlayers(k.getActivePlayers(e,c),k.getIdlePlayers(e,c)),r.setPiecesDone(k.getFinishedPiecesCount(e)),window.DEBUG&&Te.checkpoint("HUD done"),jt()&&Me.render(),Z=!1}}),{setHotkeys:c=>{be.setHotkeys(c)},onBgChange:c=>{q.setStr(J.COLOR_BACKGROUND,c),be.addEvent([p.INPUT_EV_BG_COLOR,c])},onColorChange:c=>{q.setStr(J.PLAYER_COLOR,c),be.addEvent([p.INPUT_EV_PLAYER_COLOR,c])},onNameChange:c=>{q.setStr(J.PLAYER_NAME,c),be.addEvent([p.INPUT_EV_PLAYER_NAME,c])},onSoundsEnabledChange:c=>{q.setBool(J.SOUND_ENABLED,c)},onSoundsVolumeChange:c=>{q.setInt(J.SOUND_VOLUME,c),qt()},onShowPlayerNamesChange:c=>{q.setBool(J.SHOW_PLAYER_NAMES,c)},replayOnSpeedUp:oo,replayOnSpeedDown:no,replayOnPauseToggle:so,previewImageUrl:Qo,player:{background:Qt(),color:Xt(),name:Xo(),soundsEnabled:Kt(),soundsVolume:Zt(),showPlayerNames:Ht()},game:k.get(e),disconnect:Ee.disconnect,connect:T,unload:en}}const fa=K({name:"game",components:{PuzzleStatus:_t,Scores:yt,SettingsOverlay:Et,PreviewOverlay:vt,InfoOverlay:wt,ConnectionOverlay:So,HelpOverlay:Nt},data(){return{players:{active:[],idle:[]},finished:!1,duration:0,piecesDone:0,piecesTotal:0,overlay:"",connectionState:0,cuttingPuzzle:!0,g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",setHotkeys:e=>{},onBgChange:e=>{},onColorChange:e=>{},onNameChange:e=>{},onSoundsEnabledChange:e=>{},onSoundsVolumeChange:e=>{},onShowPlayerNamesChange:e=>{},connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){!this.$route.params.id||(this.$watch(()=>this.g.player.background,e=>{this.g.onBgChange(e)}),this.$watch(()=>this.g.player.color,e=>{this.g.onColorChange(e)}),this.$watch(()=>this.g.player.name,e=>{this.g.onNameChange(e)}),this.$watch(()=>this.g.player.soundsEnabled,e=>{this.g.onSoundsEnabledChange(e)}),this.$watch(()=>this.g.player.soundsVolume,e=>{this.g.onSoundsVolumeChange(e)}),this.$watch(()=>this.g.player.showPlayerNames,e=>{this.g.onShowPlayerNamesChange(e)}),this.g=await Ho(`${this.$route.params.id}`,this.$clientId,this.$config.WS_ADDRESS,Ge,this.$el,{setPuzzleCut:()=>{this.cuttingPuzzle=!1},setPlayers:(e,t)=>{this.players={active:e,idle:t}},setFinished:e=>{this.finished=e},setDuration:e=>{this.duration=e},setPiecesDone:e=>{this.piecesDone=e},setPiecesTotal:e=>{this.piecesTotal=e},togglePreview:()=>{this.toggle("preview",!1)},setConnectionState:e=>{this.connectionState=e},toggleSoundsEnabled:()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled},togglePlayerNames:()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}}))},unmounted(){this.g.unload(),this.g.disconnect()},methods:{reconnect(){this.g.connect()},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.g.setHotkeys(!1)):(this.overlay="",t&&this.g.setHotkeys(!0))}}}),ma={id:"game"},ya=n("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),_a={class:"menu"},Ea={class:"tabs"},va=M("\u{1F9E9} Puzzles");function wa(e,t,o,s,l,r){const i=U("settings-overlay"),a=U("preview-overlay"),y=U("info-overlay"),h=U("help-overlay"),S=U("overlay"),$=U("connection-overlay"),w=U("puzzle-status"),O=U("router-link"),E=U("scores");return v(),A("div",ma,[G(x(i,{onClose:t[0]||(t[0]=m=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=m=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=m=>e.g.player=m)},null,8,["modelValue"]),[[se,e.overlay==="settings"]]),G(x(a,{onClose:t[3]||(t[3]=m=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=m=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[se,e.overlay==="preview"]]),e.g.game?G((v(),ne(y,{key:0,onClose:t[5]||(t[5]=m=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=m=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[se,e.overlay==="info"]]):ee("",!0),G(x(h,{onClose:t[7]||(t[7]=m=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=m=>e.toggle("help",!0))},null,512),[[se,e.overlay==="help"]]),G(x(S,null,{default:Q(()=>[ya]),_:1},512),[[se,e.cuttingPuzzle]]),x($,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),x(w,{finished:e.finished,duration:e.duration,piecesDone:e.piecesDone,piecesTotal:e.piecesTotal},null,8,["finished","duration","piecesDone","piecesTotal"]),n("div",_a,[n("div",Ea,[x(O,{class:"opener",to:{name:"index"},target:"_blank"},{default:Q(()=>[va]),_:1}),n("div",{class:"opener",onClick:t[9]||(t[9]=m=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),n("div",{class:"opener",onClick:t[10]||(t[10]=m=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),n("div",{class:"opener",onClick:t[11]||(t[11]=m=>e.toggle("info",!0))},"\u2139\uFE0F Info"),n("div",{class:"opener",onClick:t[12]||(t[12]=m=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),x(E,{players:e.players},null,8,["players"])])}var Pa=j(fa,[["render",wa]]);const Ta=K({name:"replay",components:{PuzzleStatus:_t,Scores:yt,SettingsOverlay:Et,PreviewOverlay:vt,InfoOverlay:wt,HelpOverlay:Nt},data(){return{players:{active:[],idle:[]},finished:!1,duration:0,piecesDone:0,piecesTotal:0,overlay:"",connectionState:0,cuttingPuzzle:!0,g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",setHotkeys:e=>{},onBgChange:e=>{},onColorChange:e=>{},onNameChange:e=>{},onSoundsEnabledChange:e=>{},onSoundsVolumeChange:e=>{},onShowPlayerNamesChange:e=>{},replayOnSpeedUp:()=>{},replayOnSpeedDown:()=>{},replayOnPauseToggle:()=>{},connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){!this.$route.params.id||(this.$watch(()=>this.g.player.background,e=>{this.g.onBgChange(e)}),this.$watch(()=>this.g.player.color,e=>{this.g.onColorChange(e)}),this.$watch(()=>this.g.player.name,e=>{this.g.onNameChange(e)}),this.$watch(()=>this.g.player.soundsEnabled,e=>{this.g.onSoundsEnabledChange(e)}),this.$watch(()=>this.g.player.soundsVolume,e=>{this.g.onSoundsVolumeChange(e)}),this.$watch(()=>this.g.player.showPlayerNames,e=>{this.g.onShowPlayerNamesChange(e)}),this.g=await Ho(`${this.$route.params.id}`,this.$clientId,this.$config.WS_ADDRESS,ue,this.$el,{setPuzzleCut:()=>{this.cuttingPuzzle=!1},setPlayers:(e,t)=>{this.players={active:e,idle:t}},setFinished:e=>{this.finished=e},setDuration:e=>{this.duration=e},setPiecesDone:e=>{this.piecesDone=e},setPiecesTotal:e=>{this.piecesTotal=e},togglePreview:()=>{this.toggle("preview",!1)},setConnectionState:e=>{this.connectionState=e},setReplaySpeed:e=>{this.replay.speed=e},setReplayPaused:e=>{this.replay.paused=e},toggleSoundsEnabled:()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled},togglePlayerNames:()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}}))},unmounted(){this.g.unload(),this.g.disconnect()},methods:{toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.g.setHotkeys(!1)):(this.overlay="",t&&this.g.setHotkeys(!0))}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Ca={id:"replay"},Sa={key:1,class:"overlay"},$a=n("div",{class:"overlay-content"},[n("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),Aa=[$a],ba={class:"menu"},Oa={class:"tabs"},Na=M("\u{1F9E9} Puzzles");function ka(e,t,o,s,l,r){const i=U("settings-overlay"),a=U("preview-overlay"),y=U("info-overlay"),h=U("help-overlay"),S=U("puzzle-status"),$=U("router-link"),w=U("scores");return v(),A("div",Ca,[G(x(i,{onClose:t[0]||(t[0]=O=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=O=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=O=>e.g.player=O)},null,8,["modelValue"]),[[se,e.overlay==="settings"]]),G(x(a,{onClose:t[3]||(t[3]=O=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=O=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[se,e.overlay==="preview"]]),e.g.game?G((v(),ne(y,{key:0,onClose:t[5]||(t[5]=O=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=O=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[se,e.overlay==="info"]]):ee("",!0),G(x(h,{onClose:t[7]||(t[7]=O=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=O=>e.toggle("help",!0))},null,512),[[se,e.overlay==="help"]]),e.cuttingPuzzle?(v(),A("div",Sa,Aa)):ee("",!0),x(S,{finished:e.finished,duration:e.duration,piecesDone:e.piecesDone,piecesTotal:e.piecesTotal},{default:Q(()=>[n("div",null,[n("div",null,Y(e.replayText),1),n("button",{class:"btn",onClick:t[9]||(t[9]=O=>e.g.replayOnSpeedUp())},"\u23EB"),n("button",{class:"btn",onClick:t[10]||(t[10]=O=>e.g.replayOnSpeedDown())},"\u23EC"),n("button",{class:"btn",onClick:t[11]||(t[11]=O=>e.g.replayOnPauseToggle())},"\u23F8\uFE0F")])]),_:1},8,["finished","duration","piecesDone","piecesTotal"]),n("div",ba,[n("div",Oa,[x($,{class:"opener",to:{name:"index"},target:"_blank"},{default:Q(()=>[Na]),_:1}),n("div",{class:"opener",onClick:t[12]||(t[12]=O=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),n("div",{class:"opener",onClick:t[13]||(t[13]=O=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),n("div",{class:"opener",onClick:t[14]||(t[14]=O=>e.toggle("info",!0))},"\u2139\uFE0F Info"),n("div",{class:"opener",onClick:t[15]||(t[15]=O=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),x(w,{players:e.players},null,8,["players"])])}var Ua=j(Ta,[["render",ka]]);const Va=K({props:{image:{type:Object,required:!0}},computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.$me.id?this.$me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function Ra(e,t,o,s,l,r){return v(),A("div",{class:"imageteaser",style:Oe(e.style),onClick:t[1]||(t[1]=(...i)=>e.onClick&&e.onClick(...i))},[e.canEdit?(v(),A("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=sn((...i)=>e.onEditClick&&e.onEditClick(...i),["stop"]))},"\u270F\uFE0F")):ee("",!0)],4)}var za=j(Va,[["render",Ra]]);const La=K({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Ma={class:"overlay"};function Da(e,t,o,s,l,r){return v(),ne(ln,{name:"overlay",duration:e.animate?{enter:300,leave:250}:0,onBeforeEnter:t[1]||(t[1]=i=>e.classes=["enter-from"]),onEnter:t[2]||(t[2]=i=>e.classes=["enter-active"]),onAfterEnter:t[3]||(t[3]=i=>e.classes=[]),onBeforeLeave:t[4]||(t[4]=i=>e.classes=["leave-to","leave-active"])},{default:Q(()=>[n("div",Ma,[n("div",{class:Fe(["overlay-background",e.classes.map(i=>"overlay-background-"+i)]),onClick:t[0]||(t[0]=i=>e.$emit("bgclick"))},null,2),n("div",{class:Fe(["overlay-content",e.classes.map(i=>"overlay-content-"+i)])},[ao(e.$slots,"default")],2)])]),_:3},8,["duration"])}var Fa=j(La,[["render",Da]]);const Ia={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Ga=["title"];function Ba(e,t,o,s,l,r){return v(),A("div",{style:Oe(r.style),title:o.title},null,12,Ga)}var xa=j(Ia,[["render",Ba]]);const Ya=K({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),Wa={key:0,class:"autocomplete"},ja=["onClick"],Za=["onClick"];function Ka(e,t,o,s,l,r){return v(),A("div",null,[G(n("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=i=>e.input=i),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...i)=>e.onChange&&e.onChange(...i)),onKeydown:t[2]||(t[2]=rn((...i)=>e.add&&e.add(...i),["enter"])),onKeyup:t[3]||(t[3]=(...i)=>e.onKeyUp&&e.onKeyUp(...i))},null,544),[[ve,e.input]]),e.autocomplete.values?(v(),A("div",Wa,[n("ul",null,[(v(!0),A(ie,null,me(e.autocomplete.values,(i,a)=>(v(),A("li",{key:a,class:Fe({active:a===e.autocomplete.idx}),onClick:y=>e.addVal(i)},Y(i),11,ja))),128))])])):ee("",!0),(v(!0),A(ie,null,me(e.values,(i,a)=>(v(),A("span",{key:a,class:"bit",onClick:y=>e.rm(i)},Y(i)+" \u2716",9,Za))),128))])}var Ha=j(Ya,[["render",Ka],["__scopeId","data-v-65df6414"]]);const qa=K({props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const o=t.files[0];if(!o)return;const s=new FormData;s.append("file",o,o.name);const r=await(await ae.post("/upload",{body:s})).json();this.$emit("uploaded",r)}}}),Qa=["accept"],Xa={class:"btn"};function Ja(e,t,o,s,l,r){return v(),A("label",null,[n("input",{type:"file",style:{display:"none"},onChange:t[0]||(t[0]=(...i)=>e.upload&&e.upload(...i)),accept:e.accept},null,40,Qa),n("span",Xa,Y(e.label||"Upload File"),1)])}var eu=j(qa,[["render",Ja]]);(async()=>{function e(){let S=q.getStr("SECRET","");return S||(S=F.uniqId(),q.setStr("SECRET",S)),S}function t(){let S=q.getStr("ID","");return S||(S=F.uniqId(),q.setStr("ID",S)),S}const o=t(),s=e();ae.setClientId(o),ae.setClientSecret(s);const r=await(await ae.get("/api/me",{})).json(),a=await(await ae.get("/api/conf",{})).json(),y=an({history:un(),routes:[{name:"index",path:"/",component:Un},{name:"new-game",path:"/new-game",component:il},{name:"game",path:"/g/:id",component:Pa},{name:"replay",path:"/replay/:id",component:Ua}]});y.beforeEach((S,$)=>{$.name&&document.documentElement.classList.remove(`view-${String($.name)}`),document.documentElement.classList.add(`view-${String(S.name)}`)});const h=cn(_n);h.config.globalProperties.$me=r,h.config.globalProperties.$config=a,h.config.globalProperties.$clientId=o,h.use(y),h.component("connection-overlay",So),h.component("edit-image-dialog",_o),h.component("game-teaser",fo),h.component("help-overlay",Nt),h.component("image-library",mo),h.component("image-teaser",za),h.component("info-overlay",wt),h.component("new-game-dialog",vo),h.component("new-image-dialog",yo),h.component("overlay",Fa),h.component("preview-overlay",vt),h.component("puzzle-status",_t),h.component("responsive-image",xa),h.component("scores",yt),h.component("settings-overlay",Et),h.component("tags-input",Ha),h.component("upload",eu),h.mount("#app")})();
