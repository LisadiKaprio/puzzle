import{d as se,r as O,o as h,c as v,a as o,b as Z,w as le,e as W,f as N,g as ne,n as Ve,t as F,F as ae,h as de,i as Be,j as H,v as Ce,k as Ye,l as Te,m as Eo,p as Xe,q as vo,s as wo,u as vs,x as Po,y as So,z as Co,A as To,B as bo,C as $o}from"./vendor.d3963963.js";const Ao=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=s(i);fetch(i.href,l)}};Ao();var X=(e,t)=>{const s=e.__vccOpts||e;for(const[n,i]of t)s[n]=i;return s};const No=se({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),Oo={id:"app"},ko={key:0,class:"nav"},Uo=N("Games overview"),Ro=N("New game");function Vo(e,t,s,n,i,l){const a=O("router-link"),u=O("router-view");return h(),v("div",Oo,[e.showNav?(h(),v("ul",ko,[o("li",null,[Z(a,{class:"btn",to:{name:"index"}},{default:le(()=>[Uo]),_:1})]),o("li",null,[Z(a,{class:"btn",to:{name:"new-game"}},{default:le(()=>[Ro]),_:1})])])):W("",!0),Z(u)])}var Lo=X(No,[["render",Vo]]);class Je{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,s){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const n=(this.rand_high>>>0)/4294967295;return t+n*(s-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const s=t.slice();for(let n=0;n<=s.length-2;n++){const i=this.random(n,s.length-1),l=s[n];s[n]=s[i],s[i]=l}return s}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const s=new Je(0);return s.rand_high=t.rand_high,s.rand_low=t.rand_low,s}}const Mo=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},ft=(e,t)=>{const s=`${e}`;return s.length>=t.length?s:t.substr(0,t.length-s.length)+s},yt=(...e)=>{const t=s=>(...n)=>{const i=new Date,l=ft(i.getHours(),"00"),a=ft(i.getMinutes(),"00"),u=ft(i.getSeconds(),"00");console[s](`${l}:${a}:${u}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},zo=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function Do(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Go(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function Fo(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function Io(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function Bo(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function Yo(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function Wo(e){return[e.id,e.rng.type||"",Je.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion,e.private]}function xo(e){return{id:e[0],rng:{type:e[1],obj:Je.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10],private:e[11]}}function Zo(e,t){const s=e.width/e.tileSize;return{x:t%s,y:Math.floor(t/s)}}const Ho=e=>{let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t|=0}return t};function jo(e){const t=[];for(const s in e){const n=[s,e[s]].map(encodeURIComponent);t.push(n.join("="))}return t.length===0?"":`?${t.join("&")}`}var z={hash:Ho,slug:Mo,uniqId:zo,encodeShape:Do,decodeShape:Go,encodePiece:Fo,decodePiece:Io,encodePlayer:Bo,decodePlayer:Yo,encodeGame:Wo,decodeGame:xo,coordByPieceIdx:Zo,asQueryArgs:jo};const ie={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",OTHER_PLAYER_CLICK_SOUND_ENABLED:"other_player_click_sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},me={SOUND_VOLUME:100,SOUND_ENABLED:!0,OTHER_PLAYER_CLICK_SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},ws=()=>({background:"",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0}),_t=(e,t)=>{localStorage.setItem(e,t)},Et=e=>localStorage.getItem(e),Ko=(e,t)=>{_t(e,`${t}`)},qo=(e,t)=>{const s=Et(e);if(s===null)return t;const n=parseInt(s,10);return isNaN(n)?t:n},Qo=(e,t)=>{_t(e,t?"1":"0")},Xo=(e,t)=>{const s=Et(e);return s===null?t:s==="1"},Jo=(e,t)=>{_t(e,t)},en=(e,t)=>{const s=Et(e);return s===null?t:s};var J={setInt:Ko,getInt:qo,setBool:Qo,getBool:Xo,setStr:Jo,getStr:en};let vt="",Ps="";const wt=async(e,t,s)=>new Promise((n,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const a in s.headers||{})l.setRequestHeader(a,s.headers[a]);l.setRequestHeader("Client-Id",vt),l.setRequestHeader("Client-Secret",Ps),l.addEventListener("load",function(a){n({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(a){i(new Error("xhr error"))}),l.upload&&s.onUploadProgress&&l.upload.addEventListener("progress",function(a){s.onUploadProgress&&s.onUploadProgress(a)}),l.send(s.body||null)}),Ss=e=>{let t=J.getStr(e,"");return t||(t=z.uniqId(),J.setStr(e,t)),t};var pe={init:()=>{vt=Ss("ID"),Ps=Ss("SECRET")},request:wt,get:(e,t)=>wt("get",e,t),post:(e,t)=>wt("post",e,t),clientId:()=>vt};const Cs=1,Pt=Cs*1e3,et=Pt*60,tt=et*60,St=tt*24,tn=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},Ts=e=>{const t=Math.floor(e/St);e=e%St;const s=Math.floor(e/tt);e=e%tt;const n=Math.floor(e/et);e=e%et;const i=Math.floor(e/Pt);return`${t}d ${s}h ${n}m ${i}s`},sn=(e,t)=>Ts(t-e);var ye={MS:Cs,SEC:Pt,MIN:et,HOUR:tt,DAY:St,timestamp:tn,timeDiffStr:sn,durationStr:Ts};const on=se({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const s=t?"\u{1F3C1}":"\u23F3",n=e,i=t||ye.timestamp(),l=ye.timeDiffStr(n,i);return`${s} ${l}`}}}),nn={class:"game-info-text"},ln=o("br",null,null,-1),rn=o("br",null,null,-1),an=o("br",null,null,-1),un=N(" \u21AA\uFE0F Watch replay ");function cn(e,t,s,n,i,l){const a=O("router-link");return h(),v("div",{class:"game-teaser",style:Ve(e.style)},[Z(a,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:le(()=>[o("span",nn,[N(" \u{1F9E9} "+F(e.game.tilesFinished)+"/"+F(e.game.tilesTotal),1),ln,N(" \u{1F465} "+F(e.game.players),1),rn,N(" "+F(e.time(e.game.started,e.game.finished)),1),an])]),_:1},8,["to"]),e.game.hasReplay?(h(),ne(a,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:le(()=>[un]),_:1},8,["to"])):W("",!0)],4)}var bs=X(on,[["render",cn]]);const dn=se({components:{GameTeaser:bs},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await pe.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),pn=o("h1",null,"Running games",-1),hn=o("h1",null,"Finished games",-1);function gn(e,t,s,n,i,l){const a=O("game-teaser");return h(),v("div",null,[pn,(h(!0),v(ae,null,de(e.gamesRunning,(u,f)=>(h(),v("div",{class:"game-teaser-wrap",key:f},[Z(a,{game:u},null,8,["game"])]))),128)),hn,(h(!0),v(ae,null,de(e.gamesFinished,(u,f)=>(h(),v("div",{class:"game-teaser-wrap",key:f},[Z(a,{game:u},null,8,["game"])]))),128))])}var mn=X(dn,[["render",gn]]);const fn=se({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function yn(e,t,s,n,i,l){const a=O("image-teaser");return h(),v("div",null,[(h(!0),v(ae,null,de(e.images,(u,f)=>(h(),ne(a,{image:u,onClick:y=>e.imageClicked(u),onEditClick:y=>e.imageEditClicked(u),key:f},null,8,["image","onClick","onEditClick"]))),128))])}var $s=X(fn,[["render",yn]]);const _n=se({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],isPrivate:!1,droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.isPrivate=!1,this.droppable=!1},imageFromDragEvt(e){var n;const t=(n=e.dataTransfer)==null?void 0:n.items;if(!t||t.length===0)return null;const s=t[0];return s.type.startsWith("image/")?s:null},onFileSelect(e){const t=e.target;if(!t.files)return;const s=t.files[0];!s||this.preview(s)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=s=>{this.previewUrl=s.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const s=t.getAsFile();return s&&(this.file=s,this.preview(s),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),En=o("div",{class:"drop-target"},null,-1),vn={key:0,class:"has-image"},wn={key:1},Pn={class:"upload"},Sn=o("span",{class:"btn"},"Upload File",-1),Cn={class:"area-settings"},Tn=o("td",null,[o("label",null,"Title")],-1),bn=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),$n=o("td",null,[o("label",null,"Private Image")],-1),An=o("td",null,[o("label",null,"Tags")],-1),Nn={class:"area-buttons"},On=["disabled"],kn=N("\u{1F5BC}\uFE0F Post to gallery"),Un=["disabled"],Rn=N("\u{1F9E9} Set up game"),Vn=N("\u{1F9E9} Post to gallery "),Ln=o("br",null,null,-1),Mn=N(" + set up game");function zn(e,t,s,n,i,l){const a=O("responsive-image"),u=O("tags-input"),f=O("overlay");return h(),ne(f,{class:"new-image-dialog"},{default:le(()=>[o("div",{class:Be(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...y)=>e.onDrop&&e.onDrop(...y)),onDragover:t[3]||(t[3]=(...y)=>e.onDragover&&e.onDragover(...y)),onDragleave:t[4]||(t[4]=(...y)=>e.onDragleave&&e.onDragleave(...y))},[En,e.previewUrl?(h(),v("div",vn,[o("span",{class:"remove btn",onClick:t[0]||(t[0]=y=>e.previewUrl="")},"X"),Z(a,{src:e.previewUrl},null,8,["src"])])):(h(),v("div",wn,[o("label",Pn,[o("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...y)=>e.onFileSelect&&e.onFileSelect(...y)),accept:"image/*"},null,32),Sn])]))],34),o("div",Cn,[o("table",null,[o("tr",null,[Tn,o("td",null,[H(o("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=y=>e.title=y),placeholder:"Flower by @artist"},null,512),[[Ce,e.title]])])]),bn,o("tr",null,[$n,o("td",null,[H(o("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=y=>e.isPrivate=y)},null,512),[[Ye,e.isPrivate]])])]),o("tr",null,[An,o("td",null,[Z(u,{modelValue:e.tags,"onUpdate:modelValue":t[7]||(t[7]=y=>e.tags=y),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",Nn,[e.isPrivate?W("",!0):(h(),v("button",{key:0,class:"btn",disabled:!e.canPostToGallery,onClick:t[8]||(t[8]=(...y)=>e.postToGallery&&e.postToGallery(...y))},[e.uploading==="postToGallery"?(h(),v(ae,{key:0},[N("Uploading ("+F(e.uploadProgressPercent)+"%)",1)],64)):(h(),v(ae,{key:1},[kn],64))],8,On)),o("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[9]||(t[9]=(...y)=>e.setupGameClick&&e.setupGameClick(...y))},[e.uploading==="setupGame"?(h(),v(ae,{key:0},[N("Uploading ("+F(e.uploadProgressPercent)+"%)",1)],64)):e.isPrivate?(h(),v(ae,{key:1},[Rn],64)):(h(),v(ae,{key:2},[Vn,Ln,Mn],64))],8,Un)])]),_:1})}var As=X(_n,[["render",zn]]);const Dn=se({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),Gn={class:"area-image"},Fn={class:"has-image"},In={class:"area-settings"},Bn=o("td",null,[o("label",null,"Title")],-1),Yn=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Wn=o("td",null,[o("label",null,"Tags")],-1),xn={class:"area-buttons"};function Zn(e,t,s,n,i,l){const a=O("responsive-image"),u=O("tags-input"),f=O("overlay");return h(),ne(f,{class:"edit-image-dialog"},{default:le(()=>[o("div",Gn,[o("div",Fn,[Z(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),o("div",In,[o("table",null,[o("tr",null,[Bn,o("td",null,[H(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=y=>e.title=y),placeholder:"Flower by @artist"},null,512),[[Ce,e.title]])])]),Yn,o("tr",null,[Wn,o("td",null,[Z(u,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=y=>e.tags=y),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",xn,[o("button",{class:"btn",onClick:t[2]||(t[2]=(...y)=>e.saveImage&&e.saveImage(...y))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var Ns=X(Dn,[["render",Zn]]),Os;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(Os||(Os={}));var we;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(we||(we={}));var Le;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(Le||(Le={}));var be;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(be||(be={}));const Hn=se({props:{image:{type:Object,required:!0},forcePrivate:{type:Boolean,default:!1}},emits:{newGame:null},data(){return{tiles:1e3,isPrivate:!1,scoreMode:we.ANY,shapeMode:Le.NORMAL,snapMode:be.NORMAL}},mounted(){this.isPrivate=this.forcePrivate},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,private:this.isPrivate,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),jn={class:"area-image"},Kn={class:"has-image"},qn={key:0,class:"image-title"},Qn={key:0,class:"image-title-title"},Xn={key:1,class:"image-title-dim"},Jn={class:"area-settings"},ei=o("td",null,[o("label",null,"Pieces")],-1),ti=o("td",null,[o("label",null,"Scoring: ")],-1),si=N(" Any (Score when pieces are connected to each other or on final location)"),oi=o("br",null,null,-1),ni=N(" Final (Score when pieces are put to their final location)"),ii=o("td",null,[o("label",null,"Shapes: ")],-1),li=N(" Normal"),ri=o("br",null,null,-1),ai=N(" Any (Flat pieces can occur anywhere)"),ui=o("br",null,null,-1),ci=N(" Flat (All pieces flat on all sides)"),di=o("td",null,[o("label",null,"Snapping: ")],-1),pi=N(" Normal (Pieces snap to final destination and to each other)"),hi=o("br",null,null,-1),gi=N(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),mi=o("td",null,[o("label",null,"Private Game")],-1),fi=["disabled"],yi={key:0},_i=o("td",null,[o("label",null,"Tags: ")],-1),Ei={class:"area-buttons"},vi=["disabled"];function wi(e,t,s,n,i,l){const a=O("responsive-image"),u=O("overlay");return h(),ne(u,{class:"new-game-dialog"},{default:le(()=>[o("div",jn,[o("div",Kn,[Z(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(h(),v("div",qn,[e.image.title?(h(),v("span",Qn,'"'+F(e.image.title)+'"',1)):W("",!0),e.image.width||e.image.height?(h(),v("span",Xn,"("+F(e.image.width)+" \u2715 "+F(e.image.height)+")",1)):W("",!0)])):W("",!0)]),o("div",Jn,[o("table",null,[o("tr",null,[ei,o("td",null,[H(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=f=>e.tiles=f)},null,512),[[Ce,e.tiles]])])]),o("tr",null,[ti,o("td",null,[o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=f=>e.scoreMode=f),value:"1"},null,512),[[Te,e.scoreMode]]),si]),oi,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=f=>e.scoreMode=f),value:"0"},null,512),[[Te,e.scoreMode]]),ni])])]),o("tr",null,[ii,o("td",null,[o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=f=>e.shapeMode=f),value:"0"},null,512),[[Te,e.shapeMode]]),li]),ri,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=f=>e.shapeMode=f),value:"1"},null,512),[[Te,e.shapeMode]]),ai]),ui,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=f=>e.shapeMode=f),value:"2"},null,512),[[Te,e.shapeMode]]),ci])])]),o("tr",null,[di,o("td",null,[o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=f=>e.snapMode=f),value:"0"},null,512),[[Te,e.snapMode]]),pi]),hi,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=f=>e.snapMode=f),value:"1"},null,512),[[Te,e.snapMode]]),gi])])]),o("tr",null,[mi,o("td",null,[H(o("input",{disabled:e.forcePrivate,type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=f=>e.isPrivate=f)},null,8,fi),[[Ye,e.isPrivate]])])]),e.image.tags.length?(h(),v("tr",yi,[_i,o("td",null,[(h(!0),v(ae,null,de(e.image.tags,(f,y)=>(h(),v("span",{key:y,class:"bit"},F(f.title),1))),128))])])):W("",!0)])]),o("div",Ei,[o("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[9]||(t[9]=(...f)=>e.onNewGameClick&&e.onNewGameClick(...f))}," \u{1F9E9} Generate Puzzle ",8,vi)])]),_:1})}var ks=X(Hn,[["render",wi]]);const Pi=se({components:{ImageLibrary:$s,NewImageDialog:As,EditImageDialog:Ns,NewGameDialog:ks},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",newGameForcePrivate:!1,uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(s=>!t.includes(s.title)&&s.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(s=>s.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await pe.get(`/api/newgame-data${z.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.newGameForcePrivate=!1,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags),t.append("private",e.isPrivate);const s=await pe.post("/api/upload",{body:t,onUploadProgress:n=>{this.uploadProgress=n.loaded/n.total}});return this.uploadProgress=1,await s.json()},async saveImage(e){return await(await pe.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.newGameForcePrivate=e.isPrivate,this.dialog="new-game"},async onNewGame(e){const t=await pe.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const s=await t.json();this.$router.push({name:"game",params:{id:s.id}})}}}}),Si={class:"upload-image-teaser"},Ci=o("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),Ti={key:0},bi=N(" Tags: "),$i=["onClick"],Ai=N(" Sort by: "),Ni=o("option",{value:"date_desc"},"Newest first",-1),Oi=o("option",{value:"date_asc"},"Oldest first",-1),ki=o("option",{value:"alpha_asc"},"A-Z",-1),Ui=o("option",{value:"alpha_desc"},"Z-A",-1),Ri=[Ni,Oi,ki,Ui];function Vi(e,t,s,n,i,l){const a=O("image-library"),u=O("new-image-dialog"),f=O("edit-image-dialog"),y=O("new-game-dialog");return h(),v("div",null,[o("div",Si,[o("div",{class:"btn btn-big",onClick:t[0]||(t[0]=U=>e.dialog="new-image")},"Upload your image"),Ci]),o("div",null,[e.tags.length>0?(h(),v("label",Ti,[bi,(h(!0),v(ae,null,de(e.relevantTags,(U,Y)=>(h(),v("span",{class:Be(["bit is-clickable",{on:e.filters.tags.includes(U.slug)}]),key:Y,onClick:E=>e.toggleTag(U)},F(U.title)+" ("+F(U.total)+")",11,$i))),128))])):W("",!0),o("label",null,[Ai,H(o("select",{"onUpdate:modelValue":t[1]||(t[1]=U=>e.filters.sort=U),onChange:t[2]||(t[2]=(...U)=>e.filtersChanged&&e.filtersChanged(...U))},Ri,544),[[Eo,e.filters.sort]])])]),Z(a,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),H(Z(u,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=U=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[Xe,e.dialog==="new-image"]]),H(Z(f,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=U=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[Xe,e.dialog==="edit-image"]]),e.image&&e.dialog==="new-game"?(h(),ne(y,{key:0,onBgclick:t[5]||(t[5]=U=>e.dialog=""),onNewGame:e.onNewGame,image:e.image,forcePrivate:e.newGameForcePrivate},null,8,["onNewGame","image","forcePrivate"])):W("",!0)])}var Li=X(Pi,[["render",Vi]]);const Mi=se({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),zi={class:"scores"},Di=o("div",null,"Scores",-1),Gi=o("td",null,"\u26A1",-1),Fi=o("td",null,"\u{1F4A4}",-1);function Ii(e,t,s,n,i,l){return h(),v("div",zi,[Di,o("table",null,[(h(!0),v(ae,null,de(e.actives,(a,u)=>(h(),v("tr",{key:u,style:Ve({color:a.color})},[Gi,o("td",null,F(a.name),1),o("td",null,F(a.points),1)],4))),128)),(h(!0),v(ae,null,de(e.idles,(a,u)=>(h(),v("tr",{key:u,style:Ve({color:a.color})},[Fi,o("td",null,F(a.name),1),o("td",null,F(a.points),1)],4))),128))])])}var Ct=X(Mi,[["render",Ii]]);const Bi=se({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return ye.durationStr(this.status.duration)}}}),Yi={class:"puzzle-status"};function Wi(e,t,s,n,i,l){return h(),v("div",Yi,[o("div",null," \u{1F9E9} "+F(e.status.piecesDone)+"/"+F(e.status.piecesTotal),1),o("div",null,F(e.icon)+" "+F(e.durationStr),1)])}var Tt=X(Bi,[["render",Wi]]);const xi=se({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.otherPlayerClickSoundEnabled=!!e.otherPlayerClickSoundEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,otherPlayerClickSoundEnabled:this.otherPlayerClickSoundEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch(()=>this.background,this.emitChanges)),this.watches.push(this.$watch(()=>this.color,this.emitChanges)),this.watches.push(this.$watch(()=>this.name,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.otherPlayerClickSoundEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsVolume,this.emitChanges)),this.watches.push(this.$watch(()=>this.showPlayerNames,this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue)}}),$e=e=>(vo("data-v-39b343a4"),e=e(),wo(),e),Zi={class:"settings"},Hi=$e(()=>o("td",null,[o("label",null,"Background: ")],-1)),ji=$e(()=>o("td",null,[o("label",null,"Color: ")],-1)),Ki=$e(()=>o("td",null,[o("label",null,"Name: ")],-1)),qi=$e(()=>o("td",null,[o("label",null,"Sounds: ")],-1)),Qi=$e(()=>o("td",null,[o("label",null,"Piece connect sounds of others: ")],-1)),Xi=["disabled"],Ji=$e(()=>o("td",null,[o("label",null,"Sounds Volume: ")],-1)),el={class:"sound-volume"},tl=["disabled","value"],sl=$e(()=>o("td",null,[o("label",null,"Show player names: ")],-1));function ol(e,t,s,n,i,l){const a=O("overlay");return h(),ne(a,{class:"transparent"},{default:le(()=>[o("table",Zi,[o("tr",null,[Hi,o("td",null,[H(o("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=u=>e.background=u)},null,512),[[Ce,e.background]])])]),o("tr",null,[ji,o("td",null,[H(o("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=u=>e.color=u)},null,512),[[Ce,e.color]])])]),o("tr",null,[Ki,o("td",null,[H(o("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=u=>e.name=u)},null,512),[[Ce,e.name]])])]),o("tr",null,[qi,o("td",null,[H(o("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=u=>e.soundsEnabled=u)},null,512),[[Ye,e.soundsEnabled]])])]),o("tr",null,[Qi,o("td",null,[H(o("input",{type:"checkbox",disabled:!e.soundsEnabled,"onUpdate:modelValue":t[4]||(t[4]=u=>e.otherPlayerClickSoundEnabled=u)},null,8,Xi),[[Ye,e.otherPlayerClickSoundEnabled]])])]),o("tr",null,[Ji,o("td",el,[o("span",{onClick:t[5]||(t[5]=(...u)=>e.decreaseVolume&&e.decreaseVolume(...u))},"\u{1F509}"),o("input",{disabled:!e.soundsEnabled,type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[6]||(t[6]=(...u)=>e.updateVolume&&e.updateVolume(...u))},null,40,tl),o("span",{onClick:t[7]||(t[7]=(...u)=>e.increaseVolume&&e.increaseVolume(...u))},"\u{1F50A}")])]),o("tr",null,[sl,o("td",null,[H(o("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=u=>e.showPlayerNames=u)},null,512),[[Ye,e.showPlayerNames]])])])])]),_:1})}var bt=X(xi,[["render",ol],["__scopeId","data-v-39b343a4"]]);const nl=se({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),il={class:"preview"};function ll(e,t,s,n,i,l){const a=O("overlay");return h(),ne(a,{class:"preview-overlay",animate:!1},{default:le(()=>[o("div",il,[o("div",{class:"img",style:Ve(e.previewStyle)},null,4)])]),_:1})}var $t=X(nl,[["render",ll]]);const rl=se({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case we.ANY:return["Any","Score when pieces are connected to each other or on final location"];case we.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Le.FLAT:return["Flat","All pieces flat on all sides"];case Le.ANY:return["Any","Flat pieces can occur anywhere"];case Le.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case be.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case be.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),al={class:"help"},ul=o("tr",null,[o("td",{colspan:"2"},"Info about this puzzle")],-1),cl=o("td",null,"Image Title: ",-1),dl=o("td",null,"Scoring: ",-1),pl=["title"],hl=o("td",null,"Shapes: ",-1),gl=["title"],ml=o("td",null,"Snapping: ",-1),fl=["title"];function yl(e,t,s,n,i,l){const a=O("overlay");return h(),ne(a,{class:"transparent"},{default:le(()=>[o("table",al,[ul,o("tr",null,[cl,o("td",null,F(e.game.puzzle.info.image.title),1)]),o("tr",null,[dl,o("td",null,[o("span",{title:e.snapMode[1]},F(e.scoreMode[0]),9,pl)])]),o("tr",null,[hl,o("td",null,[o("span",{title:e.snapMode[1]},F(e.shapeMode[0]),9,gl)])]),o("tr",null,[ml,o("td",null,[o("span",{title:e.snapMode[1]},F(e.snapMode[0]),9,fl)])])])]),_:1})}var At=X(rl,[["render",yl]]);const _l=2,El=1,vl=4,wl=2,Pl=3,Sl=1,Cl=2,Tl=4,bl=3,$l=1,Al=2,Nl=3,Ol=4,kl=5,Ul=6,Rl=7,Vl=8,Ll=9,Ml=10,zl=11,Dl=12,Gl=13,Fl=14,Il=15,Bl=16,Yl=17,Wl=18,xl=19,Zl=20,Hl=21,jl=1,Kl=2,ql=3,Ql=4;var d={EV_SERVER_EVENT:El,EV_SERVER_INIT:vl,EV_CLIENT_EVENT:wl,EV_CLIENT_INIT:Pl,GAME_VERSION:_l,LOG_HEADER:Sl,LOG_ADD_PLAYER:Cl,LOG_UPDATE_PLAYER:Tl,LOG_HANDLE_INPUT:bl,INPUT_EV_MOVE:Ll,INPUT_EV_MOUSE_DOWN:$l,INPUT_EV_MOUSE_UP:Al,INPUT_EV_MOUSE_MOVE:Nl,INPUT_EV_ZOOM_IN:Ol,INPUT_EV_ZOOM_OUT:kl,INPUT_EV_BG_COLOR:Ul,INPUT_EV_PLAYER_COLOR:Rl,INPUT_EV_PLAYER_NAME:Vl,INPUT_EV_TOGGLE_PREVIEW:Ml,INPUT_EV_TOGGLE_SOUNDS:zl,INPUT_EV_REPLAY_TOGGLE_PAUSE:Dl,INPUT_EV_REPLAY_SPEED_UP:Gl,INPUT_EV_REPLAY_SPEED_DOWN:Fl,INPUT_EV_TOGGLE_PLAYER_NAMES:Il,INPUT_EV_CENTER_FIT_PUZZLE:Bl,INPUT_EV_TOGGLE_FIXED_PIECES:Yl,INPUT_EV_TOGGLE_LOOSE_PIECES:Wl,INPUT_EV_STORE_POS:xl,INPUT_EV_RESTORE_POS:Zl,INPUT_EV_CONNECTION_CLOSE:Hl,CHANGE_DATA:jl,CHANGE_TILE:Kl,CHANGE_PLAYER:ql,PLAYER_SNAP:Ql};const Xl=yt("Communication.js"),Jl=1001,Nt=4e3,Us=0,Ot=1,kt=2,Rs=3,Vs=4;let he,Ut=[],Rt=e=>{Ut.push(e)},Vt=[],Lt=e=>{Vt.push(e)};function er(e){Rt=e;for(const t of Ut)Rt(t);Ut=[]}function tr(e){Lt=e;for(const t of Vt)Lt(t);Vt=[]}let Mt=Us;const We=e=>{Mt!==e&&(Mt=e,Lt(e))};function Ls(e){if(Mt===kt)try{he.send(JSON.stringify(e))}catch{Xl.info("unable to send message.. maybe because ws is invalid?")}}let Me,ze,zt=0;function Ms(e=2e4){he.readyState==he.OPEN&&he.send(""),zt=setTimeout(Ms,e)}function zs(){zt&&clearTimeout(zt)}function sr(e,t,s){return Me=0,ze={},We(Rs),new Promise(n=>{he=new WebSocket(e,s+"|"+t),he.onopen=()=>{We(kt),Ls([d.EV_CLIENT_INIT]),Ms()},he.onmessage=i=>{const l=JSON.parse(i.data),a=l[0];if(a===d.EV_SERVER_INIT){const u=l[1];n(u)}else if(a===d.EV_SERVER_EVENT){const u=l[1],f=l[2];if(u===s&&ze[f]){delete ze[f];return}Rt(l)}else throw`[ 2021-05-09 invalid connect msgType ${a} ]`},he.onerror=()=>{throw zs(),We(Ot),"[ 2021-05-15 onerror ]"},he.onclose=i=>{zs(),i.code===Nt||i.code===Jl?We(Vs):We(Ot)}})}async function or(e,t){const s={gameId:e,offset:t};return await(await pe.get(`/api/replay-data${z.asQueryArgs(s)}`,{})).json()}function nr(){he&&he.close(Nt),Me=0,ze={}}function ir(e){Me++,ze[Me]=e,Ls([d.EV_CLIENT_EVENT,Me,ze[Me]])}var Pe={connect:sr,requestReplayData:or,disconnect:nr,sendClientEvent:ir,onServerChange:er,onConnectionStateChange:tr,CODE_CUSTOM_DISCONNECT:Nt,CONN_STATE_NOT_CONNECTED:Us,CONN_STATE_DISCONNECTED:Ot,CONN_STATE_CLOSED:Vs,CONN_STATE_CONNECTED:kt,CONN_STATE_CONNECTING:Rs};const lr=se({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Pe.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Pe.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),rr={key:0},ar={key:2};function ur(e,t,s,n,i,l){const a=O("overlay");return H((h(),ne(a,{class:"connection-lost"},{default:le(()=>[e.lostConnection?(h(),v("div",rr,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):W("",!0),e.lostConnection?(h(),v("span",{key:1,class:"btn",onClick:t[0]||(t[0]=u=>e.$emit("reconnect"))},"Reconnect")):W("",!0),e.connecting?(h(),v("div",ar,"Connecting...")):W("",!0)]),_:1},512)),[[Xe,e.show]])}var Ds=X(lr,[["render",ur]]);const cr=se({}),dr=o("table",{class:"help"},[o("tr",null,[o("td",null,"\u2B06\uFE0F Move up:"),o("td",null,[o("div",null,[o("kbd",null,"W"),N("/"),o("kbd",null,"\u2191"),N("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B07\uFE0F Move down:"),o("td",null,[o("div",null,[o("kbd",null,"S"),N("/"),o("kbd",null,"\u2193"),N("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B05\uFE0F Move left:"),o("td",null,[o("div",null,[o("kbd",null,"A"),N("/"),o("kbd",null,"\u2190"),N("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u27A1\uFE0F Move right:"),o("td",null,[o("div",null,[o("kbd",null,"D"),N("/"),o("kbd",null,"\u2192"),N("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td"),o("td",null,[o("div",null,[N("Move faster by holding "),o("kbd",null,"Shift")])])]),o("tr",null,[o("td",null,"\u{1F50D}+ Zoom in:"),o("td",null,[o("div",null,[o("kbd",null,"E"),N("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F50D}- Zoom out:"),o("td",null,[o("div",null,[o("kbd",null,"Q"),N("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),o("td",null,[o("div",null,[o("kbd",null,"Space")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Center puzzle in screen:"),o("td",null,[o("div",null,[o("kbd",null,"C")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),o("td",null,[o("div",null,[o("kbd",null,"F")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),o("td",null,[o("div",null,[o("kbd",null,"G")])])]),o("tr",null,[o("td",null,"\u{1F464} Toggle player names:"),o("td",null,[o("div",null,[o("kbd",null,"N")])])]),o("tr",null,[o("td",null,"\u{1F509} Toggle sounds:"),o("td",null,[o("div",null,[o("kbd",null,"M")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Store position [0-9]:"),o("td",null,[o("div",null,[o("kbd",null,"Shift"),N(" + "),o("kbd",null,"0"),N("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Restore position [0-9]:"),o("td",null,[o("div",null,[o("kbd",null,"0"),N("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,"\u23EB Speed up (replay):"),o("td",null,[o("div",null,[o("kbd",null,"I")])])]),o("tr",null,[o("td",null,"\u23EC Speed down (replay):"),o("td",null,[o("div",null,[o("kbd",null,"O")])])]),o("tr",null,[o("td",null,"\u23F8\uFE0F Pause (replay):"),o("td",null,[o("div",null,[o("kbd",null,"P")])])])],-1);function pr(e,t,s,n,i,l){const a=O("overlay");return h(),ne(a,{class:"transparent"},{default:le(()=>[dr]),_:1})}var Dt=X(cr,[["render",pr]]),hr="/assets/click.bb97cb07.mp3",gr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:hr}),mr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",fr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:mr}),yr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",_r=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:yr}),Er="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",vr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Er}),wr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",Pr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:wr});const Sr=e=>{let t=!1;const s=()=>{t=!0},n=e.fps||60,i=e.slow||1,l=e.update,a=e.render,u=window.requestAnimationFrame,f=1/n,y=i*f;let U,Y=0,E=window.performance.now();const g=()=>{for(U=window.performance.now(),Y=Y+Math.min(1,(U-E)/1e3);Y>y;)Y=Y-y,l(f);a(Y/i),E=U,t||u(g)};return u(g),{stop:s}},Cr=.1,Tr=6,br=.05;class Gt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,s){this.x+=t/this.curZoom,this.y+=s/this.curZoom}calculateNewZoom(t){const s=t==="in"?1:-1,n=this.curZoom+br*this.curZoom*s;return Math.min(Math.max(n,Cr),Tr)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,s){if(this.curZoom==t)return!1;const n=1-this.curZoom/t;return this.move(-s.x*n,-s.y*n),this.curZoom=t,!0}zoom(t,s){return this.setZoom(this.calculateNewZoom(t),s)}viewportToWorld(t){const{x:s,y:n}=this.viewportToWorldRaw(t);return{x:Math.round(s),y:Math.round(n)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:s,y:n}=this.worldToViewportRaw(t);return{x:Math.round(s),y:Math.round(n)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:s,h:n}=this.worldDimToViewportRaw(t);return{w:Math.round(s),h:Math.round(n)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:s,h:n}=this.viewportDimToWorldRaw(t);return{w:Math.round(s),h:Math.round(n)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function Ft(e=0,t=0){const s=document.createElement("canvas");return s.width=e,s.height=t,s}async function $r(e){return new Promise(t=>{const s=new Image;s.onload=()=>{createImageBitmap(s).then(t)},s.src=e})}async function Ar(e,t,s){const n=Ft(t,s);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,s),await createImageBitmap(n)}function Nr(e,t,s){const n=Ft(e.width,e.height),i=n.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=s,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),n}var ge={createCanvas:Ft,loadImageToBitmap:$r,resizeBitmap:Ar,colorizedCanvas:Nr};const Or=yt("Debug.js");let It=0,Gs=0;const kr=e=>{It=performance.now(),Gs=e},Ur=e=>{const t=performance.now(),s=t-It;s>Gs&&Or.log(e+": "+s),It=t};var Ae={checkpoint_start:kr,checkpoint:Ur};function Rr(e,t){return{x:e.x-t.x,y:e.y-t.y}}function Vr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Fs(e,t){const s=e.x-t.x,n=e.y-t.y;return Math.sqrt(s*s+n*n)}function Lr(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Bt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function Mr(e,t,s){return{x:e.x+t,y:e.y+s,w:e.w,h:e.h}}function zr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function Dr(e,t){return Fs(Bt(e),Bt(t))}var j={pointSub:Rr,pointAdd:Vr,pointDistance:Fs,pointInBounds:Lr,rectCenter:Bt,rectMoved:Mr,rectCenterDistance:Dr,rectsOverlap:zr};const Is=yt("PuzzleGraphics.js");async function Gr(e,t,s){Is.log("start createPuzzleTileBitmaps");const n=s.tileSize,i=s.tileMarginWidth,l=s.tileDrawSize,a=n/100,u=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],f=new Array(t.length),y={};function U(_){const I=`${_.top}${_.right}${_.left}${_.bottom}`;if(y[I])return y[I];const A=new Path2D,T={x:i,y:i},S=j.pointAdd(T,{x:n,y:0}),c=j.pointAdd(S,{x:0,y:n}),D=j.pointSub(c,{x:n,y:0});if(A.moveTo(T.x,T.y),_.top!==0)for(let w=0;w<u.length/6;w++){const ee=j.pointAdd(T,{x:u[w*6+0]*a,y:_.top*u[w*6+1]*a}),Q=j.pointAdd(T,{x:u[w*6+2]*a,y:_.top*u[w*6+3]*a}),te=j.pointAdd(T,{x:u[w*6+4]*a,y:_.top*u[w*6+5]*a});A.bezierCurveTo(ee.x,ee.y,Q.x,Q.y,te.x,te.y)}else A.lineTo(S.x,S.y);if(_.right!==0)for(let w=0;w<u.length/6;w++){const ee=j.pointAdd(S,{x:-_.right*u[w*6+1]*a,y:u[w*6+0]*a}),Q=j.pointAdd(S,{x:-_.right*u[w*6+3]*a,y:u[w*6+2]*a}),te=j.pointAdd(S,{x:-_.right*u[w*6+5]*a,y:u[w*6+4]*a});A.bezierCurveTo(ee.x,ee.y,Q.x,Q.y,te.x,te.y)}else A.lineTo(c.x,c.y);if(_.bottom!==0)for(let w=0;w<u.length/6;w++){const ee=j.pointSub(c,{x:u[w*6+0]*a,y:_.bottom*u[w*6+1]*a}),Q=j.pointSub(c,{x:u[w*6+2]*a,y:_.bottom*u[w*6+3]*a}),te=j.pointSub(c,{x:u[w*6+4]*a,y:_.bottom*u[w*6+5]*a});A.bezierCurveTo(ee.x,ee.y,Q.x,Q.y,te.x,te.y)}else A.lineTo(D.x,D.y);if(_.left!==0)for(let w=0;w<u.length/6;w++){const ee=j.pointSub(D,{x:-_.left*u[w*6+1]*a,y:u[w*6+0]*a}),Q=j.pointSub(D,{x:-_.left*u[w*6+3]*a,y:u[w*6+2]*a}),te=j.pointSub(D,{x:-_.left*u[w*6+5]*a,y:u[w*6+4]*a});A.bezierCurveTo(ee.x,ee.y,Q.x,Q.y,te.x,te.y)}else A.lineTo(T.x,T.y);return y[I]=A,A}const Y=ge.createCanvas(l,l),E=Y.getContext("2d"),g=ge.createCanvas(l,l),b=g.getContext("2d");for(const _ of t){const I=z.decodePiece(_),A=Fr(s,I.idx),T=U(z.decodeShape(s.shapes[I.idx]));E.clearRect(0,0,l,l),E.save(),E.lineWidth=2,E.stroke(T),E.globalCompositeOperation="source-in",E.drawImage(e,A.x-i,A.y-i,l,l,0,0,l,l),E.restore(),E.save(),E.globalCompositeOperation="source-in",E.globalAlpha=.2,E.fillStyle="black",E.fillRect(0,0,Y.width,Y.height),E.restore(),E.save(),E.clip(T),E.drawImage(e,A.x-i,A.y-i,l,l,0,0,l,l),E.restore(),E.save(),E.clip(T),E.strokeStyle="rgba(0,0,0,.4)",E.lineWidth=0,E.shadowColor="black",E.shadowBlur=2,E.shadowOffsetX=-1,E.shadowOffsetY=-1,E.stroke(T),E.restore(),E.save(),E.clip(T),E.strokeStyle="rgba(255,255,255,.4)",E.lineWidth=0,E.shadowColor="white",E.shadowBlur=2,E.shadowOffsetX=1,E.shadowOffsetY=1,E.stroke(T),E.restore(),b.clearRect(0,0,l,l),b.save(),b.lineWidth=1,b.stroke(T),b.globalCompositeOperation="source-in",b.drawImage(e,A.x-i,A.y-i,l,l,0,0,l,l),b.restore(),E.drawImage(g,0,0),f[I.idx]=await createImageBitmap(Y)}return Is.log("end createPuzzleTileBitmaps"),f}function Fr(e,t){const s=z.coordByPieceIdx(e,t);return{x:s.x*e.tileSize,y:s.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function Ir(e){const t=await ge.loadImageToBitmap(e.info.imageUrl),s=await ge.resizeBitmap(t,e.info.width,e.info.height);return await Gr(s,e.tiles,e.info)}var Br={loadPuzzleBitmaps:Ir};const Bs=30,C={};function Yr(e){return!!C[e]||!1}function Wr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function xr(e,t){C[e]=t}function Zr(e){delete C[e]}function st(e,t){let s=0;for(const n of C[e].players){if(z.decodePlayer(n).id===t)return s;s++}return-1}function Hr(e,t){return C[e].players.length>t?z.decodePlayer(C[e].players[t]).id:null}function Ne(e,t){const s=st(e,t);return s===-1?null:z.decodePlayer(C[e].players[s])}function Yt(e,t,s){const n=st(e,t);n===-1?C[e].players.push(z.encodePlayer(s)):C[e].players[n]=z.encodePlayer(s)}function jr(e,t,s){C[e].puzzle.tiles[t]=z.encodePiece(s)}function Kr(e,t){C[e].puzzle.data=t}function Ys(e,t){return st(e,t)!==-1}function qr(e,t){return oo(C[e],t)}function Qr(e,t){return $a(C[e],t)}function Xr(e,t,s){Ys(e,t)?re(e,t,{ts:s}):Yt(e,t,Wr(t,s))}function Jr(e){return C[e]||null}function Wt(e){return Kt(C[e])}function ea(e){return no(C[e])}function xt(e){return C[e].scoreMode}function Ws(e){return C[e].snapMode}function Zt(e){return jt(C[e])}function ta(e){return C[e].puzzle.tiles.map(z.decodePiece).sort((s,n)=>s.z-n.z)}function re(e,t,s){const n=Ne(e,t);if(n!==null){for(const i of Object.keys(s))n[i]=s[i];Yt(e,t,n)}}function ot(e,t){for(const s of Object.keys(t))C[e].puzzle.data[s]=t[s]}function Oe(e,t,s){for(const n of Object.keys(s)){const i=z.decodePiece(C[e].puzzle.tiles[t]);i[n]=s[n],C[e].puzzle.tiles[t]=z.encodePiece(i)}}const De=(e,t)=>z.decodePiece(C[e].puzzle.tiles[t]),nt=(e,t)=>De(e,t).group,sa=(e,t)=>{const s=C[e].puzzle.info;return t===0||t===s.tilesX-1||t===s.tiles-s.tilesX||t===s.tiles-1},xs=(e,t)=>{const s=C[e].puzzle.info,n={x:(s.table.width-s.width)/2,y:(s.table.height-s.height)/2},i=ca(e,t);return j.pointAdd(n,i)},it=(e,t)=>De(e,t).pos,oa=e=>{const t=Xs(e),s=Js(e),n=Math.round(t/4),i=Math.round(s/4);return{x:0-n,y:0-i,w:t+2*n,h:s+2*i}},na=(e,t)=>De(e,t).z,xe=(e,t)=>{for(const s of C[e].puzzle.tiles){const n=z.decodePiece(s);if(n.owner===t)return n.idx}return-1},ia=(e,t)=>{const s=xe(e,t);return s<0?null:C[e].puzzle.tiles[s]},la=e=>C[e].puzzle.info.tileDrawOffset,Zs=e=>C[e].puzzle.info.tileDrawSize,ra=e=>eo(C[e]),aa=e=>to(C[e]),Hs=e=>C[e].puzzle.data.maxGroup,js=e=>C[e].puzzle.data.maxZ,ua=(e,t)=>{let s=0;for(const n of t){const i=na(e,n);i>s&&(s=i)}return s};function ca(e,t){const s=C[e].puzzle.info,n=z.coordByPieceIdx(s,t),i=n.x*s.tileSize,l=n.y*s.tileSize;return{x:i,y:l}}function da(e,t){const s=C[e].puzzle.info,n=z.coordByPieceIdx(s,t);return[n.y>0?t-s.tilesX:-1,n.x<s.tilesX-1?t+1:-1,n.y<s.tilesY-1?t+s.tilesX:-1,n.x>0?t-1:-1]}const Ks=(e,t,s)=>{for(const n of t)Oe(e,n,{z:s})},pa=(e,t,s)=>{const n=it(e,t),i=j.pointAdd(n,s);Oe(e,t,{pos:i})},lt=(e,t,s)=>{const n=Zs(e),i=oa(e),l=s;for(const a of t){const u=De(e,a);u.pos.x+s.x<i.x?l.x=Math.max(i.x-u.pos.x,l.x):u.pos.x+n+s.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-u.pos.x+n,l.x)),u.pos.y+s.y<i.y?l.y=Math.max(i.y-u.pos.y,l.y):u.pos.y+n+s.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-u.pos.y+n,l.y))}if(!l.x&&!l.y)return!1;for(const a of t)pa(e,a,l);return!0},ha=(e,t)=>ga(e,t)===-1,ga=(e,t)=>De(e,t).owner,qs=(e,t)=>{for(const s of t)Oe(e,s,{owner:-1,z:1})},Ht=(e,t,s)=>{for(const n of t)Oe(e,n,{owner:s})};function ma(e,t){return _e(e,t).length}function _e(e,t){const s=C[e].puzzle.tiles,n=z.decodePiece(s[t]),i=[];if(n.group)for(const l of s){const a=z.decodePiece(l);a.group===n.group&&i.push(a.idx)}else i.push(n.idx);return i}const fa=(e,t)=>{const s=C[e].puzzle.info,n=C[e].puzzle.tiles;let i=-1,l=-1;for(let a=0;a<n.length;a++){const u=z.decodePiece(n[a]);if(u.owner!==0)continue;const f={x:u.pos.x,y:u.pos.y,w:s.tileSize,h:s.tileSize};j.pointInBounds(t,f)&&(i===-1||u.z>i)&&(i=u.z,l=a)}return l},ya=(e,t)=>{const s=Ne(e,t);return s?s.bgcolor:null},_a=(e,t)=>{const s=Ne(e,t);return s?s.color:null},Ea=(e,t)=>{const s=Ne(e,t);return s?s.name:null},Qs=(e,t)=>{const s=Ne(e,t);return s?s.points:0},va=(e,t,s)=>{const n=nt(e,t),i=nt(e,s);return!!(n&&n===i)},Xs=e=>C[e].puzzle.info.table.width,Js=e=>C[e].puzzle.info.table.height,wa=e=>C[e].puzzle,Pa=e=>C[e].rng.obj,Sa=e=>C[e].puzzle.info.width,Ca=e=>C[e].puzzle.info.height,Ta=(e,t)=>{if(Ws(e)===be.REAL){for(const s of t)if(sa(e,s))return!0;return!1}return!0};function ba(e,t,s,n){const i=C[e].puzzle,l=[],a=()=>{l.push([d.CHANGE_DATA,i.data])},u=g=>{l.push([d.CHANGE_TILE,z.encodePiece(De(e,g))])},f=g=>{for(const b of g)u(b)},y=()=>{const g=Ne(e,t);!g||l.push([d.CHANGE_PLAYER,z.encodePlayer(g)])};let U=!1;const Y=(g,b,_)=>{const I=C[g].puzzle.tiles,A=nt(g,b),T=nt(g,_);let S;const c=[];if(A&&c.push(A),T&&c.push(T),A)S=A;else if(T)S=T;else{const D=Hs(g)+1;ot(g,{maxGroup:D}),a(),S=Hs(g)}if(Oe(g,b,{group:S}),u(b),Oe(g,_,{group:S}),u(_),c.length>0)for(const D of I){const w=z.decodePiece(D);c.includes(w.group)&&(Oe(g,w.idx,{group:S}),u(w.idx))}},E=s[0];if(E===d.INPUT_EV_CONNECTION_CLOSE){const g=xe(e,t);if(g>=0){const b=_e(e,g);Ht(e,b,0),f(b)}}else if(E===d.INPUT_EV_BG_COLOR){const g=s[1];re(e,t,{bgcolor:g,ts:n}),y()}else if(E===d.INPUT_EV_PLAYER_COLOR){const g=s[1];re(e,t,{color:g,ts:n}),y()}else if(E===d.INPUT_EV_PLAYER_NAME){const g=`${s[1]}`.substr(0,16);re(e,t,{name:g,ts:n}),y()}else if(E===d.INPUT_EV_MOVE){const g=s[1],b=s[2],_=Ne(e,t);if(_){const I=_.x-g,A=_.y-b;re(e,t,{ts:n,x:I,y:A}),y();const T=xe(e,t);if(T>=0){const S=_e(e,T),c={x:-g,y:-b};lt(e,S,c)&&f(S)}}}else if(E===d.INPUT_EV_MOUSE_DOWN){const g=s[1],b=s[2],_={x:g,y:b};re(e,t,{d:1,ts:n}),y();const I=fa(e,_);if(I>=0){const A=js(e)+1;ot(e,{maxZ:A}),a();const T=_e(e,I);Ks(e,T,js(e)),Ht(e,T,t),f(T)}}else if(E===d.INPUT_EV_MOUSE_MOVE){const g=s[1],b=s[2];if(!s[5])re(e,t,{x:g,y:b,ts:n}),y();else{const I=xe(e,t);if(I<0)re(e,t,{ts:n}),y();else{const A=s[1],T=s[2],S=s[3],c=s[4];re(e,t,{x:A,y:T,ts:n}),y();const D=_e(e,I);lt(e,D,{x:S,y:c})&&f(D)}}}else if(E===d.INPUT_EV_MOUSE_UP){const g=0,b=xe(e,t);if(b>=0){const _=_e(e,b);Ht(e,_,0),f(_);const I=it(e,b),A=xs(e,b);if(Ta(e,_)&&j.pointDistance(A,I)<i.info.snapDistance){const T=j.pointSub(A,I);lt(e,_,T),qs(e,_),f(_);let S=Qs(e,t);xt(e)===we.FINAL?S+=_.length:xt(e)===we.ANY&&(S+=1),re(e,t,{d:g,ts:n,points:S}),y(),Zt(e)===Wt(e)&&(ot(e,{finished:n}),a()),U=!0}else{const T=(c,D,w,ee)=>{const Q=C[c].puzzle.info;if(w<0||va(c,D,w))return!1;const te=it(c,D),Ee=j.pointAdd(it(c,w),{x:ee[0]*Q.tileSize,y:ee[1]*Q.tileSize});if(j.pointDistance(te,Ee)<Q.snapDistance){const Se=j.pointSub(Ee,te);let ce=_e(c,D);if(lt(c,ce,Se),Y(c,D,w),ce=_e(c,D),ha(c,w))qs(c,ce);else{const Re=ua(c,ce);Ks(c,ce,Re)}return f(ce),!0}return!1};let S=!1;for(const c of _e(e,b)){const D=da(e,c);if(T(e,c,D[0],[0,1])||T(e,c,D[1],[-1,0])||T(e,c,D[2],[0,-1])||T(e,c,D[3],[1,0])){S=!0;break}}if(S&&xt(e)===we.ANY){const c=Qs(e,t)+1;re(e,t,{d:g,ts:n,points:c}),y()}else re(e,t,{d:g,ts:n}),y();S&&Ws(e)===be.REAL&&Zt(e)===Wt(e)&&(ot(e,{finished:n}),a()),S&&(U=!0)}}else re(e,t,{d:g,ts:n}),y()}else if(E===d.INPUT_EV_ZOOM_IN){const g=s[1],b=s[2];re(e,t,{x:g,y:b,ts:n}),y()}else if(E===d.INPUT_EV_ZOOM_OUT){const g=s[1],b=s[2];re(e,t,{x:g,y:b,ts:n}),y()}else re(e,t,{ts:n}),y();return U&&l.push([d.PLAYER_SNAP,t]),l}function eo(e){return e.puzzle.data.started}function to(e){return e.puzzle.data.finished}function jt(e){let t=0;for(const s of e.puzzle.tiles)z.decodePiece(s).owner===-1&&t++;return t}function Kt(e){return e.puzzle.tiles.length}function so(e){return e.players.map(z.decodePlayer)}function oo(e,t){const s=t-Bs*ye.SEC;return so(e).filter(n=>n.ts>=s)}function $a(e,t){const s=t-Bs*ye.SEC;return so(e).filter(n=>n.ts<s&&n.points>0)}function no(e){var s;const t=((s=e.puzzle.info.image)==null?void 0:s.url)||e.puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Aa(e){return jt(e)===Kt(e)}var k={setGame:xr,unsetGame:Zr,loaded:Yr,playerExists:Ys,getActivePlayers:qr,getIdlePlayers:Qr,addPlayer:Xr,getFinishedPiecesCount:Zt,getPieceCount:Wt,getImageUrl:ea,get:Jr,getGroupedPieceCount:ma,getPlayerBgColor:ya,getPlayerColor:_a,getPlayerName:Ea,getPlayerIndexById:st,getPlayerIdByIndex:Hr,changePlayer:re,setPlayer:Yt,setPiece:jr,setPuzzleData:Kr,getTableWidth:Xs,getTableHeight:Js,getPuzzle:wa,getRng:Pa,getPuzzleWidth:Sa,getPuzzleHeight:Ca,getPiecesSortedByZIndex:ta,getFirstOwnedPiece:ia,getPieceDrawOffset:la,getPieceDrawSize:Zs,getFinalPiecePos:xs,getStartTs:ra,getFinishTs:aa,handleInput:ba,Game_getStartTs:eo,Game_getFinishTs:to,Game_getFinishedPiecesCount:jt,Game_getPieceCount:Kt,Game_getActivePlayers:oo,Game_getImageUrl:no,Game_isFinished:Aa};let io=-10,lo=20,qt=2,ro=15;const Na=5,Oa=5,Qt=1,ka=200,ao=10,Ua=100,Ra=10,Va=1,La=5;function Ma(e){const t=e.random(0,255),s=e.random(0,255),n=e.random(0,255);return"rgba("+t+","+s+","+n+", 0.8)"}class uo{constructor(t){this.radius=ao,this.previousRadius=ao,this.explodingDuration=Ua,this.hasExploded=!1,this.alive=!0,this.color=Ma(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=io+Math.random()*lo,this.vy=(qt+Math.random()*ro)*-1,this.duration=0}update(t){if(this.hasExploded){const s=ka-this.radius;this.previousRadius=this.radius,this.radius+=s/Ra,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=Qt,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const s=3+Math.floor(Math.random()*3);for(let n=0;n<s;n++){const i=10+Math.floor(Math.random()*21),l=Na+Math.random()*Oa,a=2*Math.PI/i,u=Math.random()*a;for(let f=0;f<i;f++)t.push(new za(this,f*a+u,l))}}}class za{constructor(t,s,n){this.px=t.px,this.py=t.py,this.vx=Math.cos(s)*n,this.vy=Math.sin(s)*n,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=Qt/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class Da{constructor(t,s){this.canvas=t,this.rng=s,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,s=0;for(;t<this.canvas.height&&s>=0;)s+=Qt,t+=s;qt=s/2,ro=s-qt;const n=1/4*this.canvas.width/(s/2);io=-n,lo=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<Va;t++)this.readyBombs.push(new uo(this.rng))}update(){Math.random()*100<La&&this.readyBombs.push(new uo(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const s=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):s.push(i)}this.readyBombs=s;const n=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&n.push(i)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function Ga(e,t,s,n){let i=[],l=!0,a=!1,u=!1,f=!1,y=!1,U=!1,Y=!1,E=!1;const g=(m,R)=>{const M=s.viewportToWorld({x:m,y:R});return[M.x,M.y]},b=(m,R)=>{const M=s.viewportDimToWorld({w:m,h:R});return[M.w,M.h]},_=m=>g(m.offsetX,m.offsetY),I=()=>g(e.width/2,e.height/2),A=(m,R)=>{!l||(R.code==="ShiftLeft"||R.code==="ShiftRight"?E=m:R.code==="ArrowUp"||R.code==="KeyW"?f=m:R.code==="ArrowDown"||R.code==="KeyS"?y=m:R.code==="ArrowLeft"||R.code==="KeyA"?a=m:R.code==="ArrowRight"||R.code==="KeyD"?u=m:R.code==="KeyQ"?Y=m:R.code==="KeyE"&&(U=m))};let T=!1,S=null,c=null;const D=m=>{c=_(m),S=[m.offsetX,m.offsetY],m.button===0&&(T=!0,K([d.INPUT_EV_MOUSE_DOWN,...c]))},w=m=>{c=_(m),S=[m.offsetX,m.offsetY],m.button===0&&(T=!1,K([d.INPUT_EV_MOUSE_UP,...c]))},ee=m=>{if(!S)return;c=_(m);const R=b(-(S[0]-m.offsetX),-(S[1]-m.offsetY));K([d.INPUT_EV_MOUSE_MOVE,...c,...R,T?1:0]),S=[m.offsetX,m.offsetY]},Q=m=>{if(c=_(m),s.canZoom(m.deltaY<0?"in":"out")){const R=m.deltaY<0?d.INPUT_EV_ZOOM_IN:d.INPUT_EV_ZOOM_OUT;K([R,...c])}},te=m=>A(!0,m),Ee=m=>A(!1,m),Se=m=>{if(!!l){if(n===fe&&(m.code==="KeyI"?K([d.INPUT_EV_REPLAY_SPEED_UP]):m.code==="KeyO"?K([d.INPUT_EV_REPLAY_SPEED_DOWN]):m.code==="KeyP"&&K([d.INPUT_EV_REPLAY_TOGGLE_PAUSE])),m.code==="Space")K([d.INPUT_EV_TOGGLE_PREVIEW]);else if(m.code==="KeyF")K([d.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(m.code==="KeyG")K([d.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(m.code==="KeyM")K([d.INPUT_EV_TOGGLE_SOUNDS]);else if(m.code==="KeyN")K([d.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(m.code==="KeyC")K([d.INPUT_EV_CENTER_FIT_PUZZLE]);else for(let R=0;R<=9;R++)if(m.code===`Digit${R}`){const M=m.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;K([M,R]);break}}},ce=()=>{e.addEventListener("mousedown",D),e.addEventListener("mouseup",w),e.addEventListener("mousemove",ee),e.addEventListener("wheel",Q),t.addEventListener("keydown",te),t.addEventListener("keyup",Ee),t.addEventListener("keypress",Se)},Re=()=>{e.removeEventListener("mousedown",D),e.removeEventListener("mouseup",w),e.removeEventListener("mousemove",ee),e.removeEventListener("wheel",Q),t.removeEventListener("keydown",te),t.removeEventListener("keyup",Ee),t.removeEventListener("keypress",Se)},at=(m,R)=>{if(!S||!c)return;const M=new Gt(m).viewportToWorld({x:S[0],y:S[1]}),$=new Gt(R).viewportToWorld({x:S[0],y:S[1]}),ut=[-(M.x-$.x),-(M.y-$.y)];K([d.INPUT_EV_MOUSE_MOVE,...c,...ut,T?1:0])},K=m=>{i.push(m)};return{registerEvents:ce,unregisterEvents:Re,addEvent:K,consumeAll:()=>{if(i.length===0)return[];const m=i.slice();return i=[],m},createKeyEvents:()=>{const m=(a?1:0)-(u?1:0),R=(f?1:0)-(y?1:0);if(m!==0||R!==0){const M=(E?24:12)*Math.sqrt(s.getCurrentZoom()),$=s.viewportDimToWorld({w:m*M,h:R*M});K([d.INPUT_EV_MOVE,$.w,$.h]),c&&(c[0]-=$.w,c[1]-=$.h)}if(!(U&&Y)){if(U){if(s.canZoom("in")){const M=c||I();K([d.INPUT_EV_ZOOM_IN,...M])}}else if(Y&&s.canZoom("out")){const M=c||I();K([d.INPUT_EV_ZOOM_OUT,...M])}}},createSnapshotEvents:at,setHotkeys:m=>{l=m}}}const rt={"./grab.png":fr,"./grab_mask.png":_r,"./hand.png":vr,"./hand_mask.png":Pr},Fa={"./click.mp3":gr},Ze="play",fe="replay";let ke=!0,Ue=!0;const Ia=e=>e.owner===-1?ke:Ue;let oe=!0;async function co(e,t,s,n,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const a=r=>n===fe||r.id!==t,u=Fa["./click.mp3"].default,f=new Audio(u),y=await ge.loadImageToBitmap(rt["./grab.png"].default),U=await ge.loadImageToBitmap(rt["./hand.png"].default),Y=await ge.loadImageToBitmap(rt["./grab_mask.png"].default),E=await ge.loadImageToBitmap(rt["./hand_mask.png"].default),g=y.width,b=Math.round(g/2),_=y.height,I=Math.round(_/2),A={},T=async r=>{const p=r.color+" "+r.d;if(!A[p]){const P=r.d?y:U;if(r.color){const V=r.d?Y:E;A[p]=await createImageBitmap(ge.colorizedCanvas(P,V,r.color))}else A[p]=P}return A[p]},S=i,c={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Pe.onConnectionStateChange(r=>{l.emit("connectionState",r)});const D=async r=>{const p=c.dataOffset;c.dataOffset+=1e4;const P=await Pe.requestReplayData(r,p);return c.log=c.log.slice(c.logPointer),c.logPointer=0,c.log.push(...P.log),P.log.length===0&&(c.final=!0),P};let w=()=>0;const ee=async()=>{if(n===Ze){const r=await Pe.connect(s,e,t),p=z.decodeGame(r);k.setGame(p.id,p),w=()=>ye.timestamp()}else if(n===fe){const r=await D(e);if(!r.game)throw"[ 2021-05-29 no game received ]";const p=z.decodeGame(r.game);k.setGame(p.id,p),c.lastRealTs=ye.timestamp(),c.gameStartTs=parseInt(r.log[0][4],10),c.lastGameTs=c.gameStartTs,w=()=>c.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";oe=!0};await ee();const Q=k.getPieceDrawOffset(e),te=k.getPieceDrawSize(e),Ee=k.getPuzzleWidth(e),Se=k.getPuzzleHeight(e),ce=k.getTableWidth(e),Re=k.getTableHeight(e),at={x:(ce-Ee)/2,y:(Re-Se)/2},K={w:Ee,h:Se},Xt={w:te,h:te},Jt=await Br.loadPuzzleBitmaps(k.getPuzzle(e)),He=new Da(S,k.getRng(e));He.init();const m=S.getContext("2d");S.classList.add("loaded"),l.emit("puzzleCut");let R="";const M={},$=new Gt,ut=()=>{$.reset(),$.move(-(ce-S.width)/2,-(Re-S.height)/2);const r=$.worldDimToViewportRaw(K),p=20,P=S.width-p*2,V=S.height-p*2;if(r.w>P||r.h>V||r.w<P&&r.h<V){const G=Math.min(P/r.w,V/r.h),B={x:S.width/2,y:S.height/2};$.setZoom(G,B)}},ue=Ga(S,window,$,n);ue.registerEvents();const je=r=>{if(M.last&&R===r){const p=$.snapshot(),P=M.last;return $.fromSnapshot(P),ue.createSnapshotEvents(p,P),delete M.last,"last"}else if(M[r]){const p=M[r],P=$.snapshot();return M.last=P,R=r,$.fromSnapshot(p),ue.createSnapshotEvents(P,p),r}else return null};ut(),M.center=$.snapshot();const go=k.getImageUrl(e),Ke=r=>{const p=k.getStartTs(e),P=k.getFinishTs(e);l.emit("status",{finished:!!P,duration:(P||r)-p,piecesDone:k.getFinishedPiecesCount(e),piecesTotal:k.getPieceCount(e)}),l.emit("players",{active:k.getActivePlayers(e,r),idle:k.getIdlePlayers(e,r)})};Ke(w());const es=!!k.getFinishTs(e);let ct=es;const ts=()=>ct&&!es,ss=()=>J.getInt(ie.SOUND_VOLUME,me.SOUND_VOLUME),os=()=>J.getBool(ie.OTHER_PLAYER_CLICK_SOUND_ENABLED,me.OTHER_PLAYER_CLICK_SOUND_ENABLED),dt=()=>J.getBool(ie.SOUND_ENABLED,me.SOUND_ENABLED),ns=()=>J.getBool(ie.SHOW_PLAYER_NAMES,me.SHOW_PLAYER_NAMES),is=()=>n===fe?J.getStr(ie.COLOR_BACKGROUND,me.COLOR_BACKGROUND):k.getPlayerBgColor(e,t)||J.getStr(ie.COLOR_BACKGROUND,me.COLOR_BACKGROUND),ls=()=>n===fe?J.getStr(ie.PLAYER_COLOR,me.PLAYER_COLOR):k.getPlayerColor(e,t)||J.getStr(ie.PLAYER_COLOR,me.PLAYER_COLOR),mo=()=>n===fe?J.getStr(ie.PLAYER_NAME,me.PLAYER_NAME):k.getPlayerName(e,t)||J.getStr(ie.PLAYER_NAME,me.PLAYER_NAME),pt=()=>{const r=ss();f.volume=r/100,f.play()},x={background:is(),color:ls(),name:mo(),soundsEnabled:dt(),otherPlayerClickSoundEnabled:os(),soundsVolume:ss(),showPlayerNames:ns()};ue.addEvent([d.INPUT_EV_BG_COLOR,x.background]),ue.addEvent([d.INPUT_EV_PLAYER_COLOR,x.color]),ue.addEvent([d.INPUT_EV_PLAYER_NAME,x.name]);let rs="",as="",us=!1;const Ge=r=>{us=r;const[p,P]=r?[rs,"grab"]:[as,"default"];S.style.cursor=`url('${p}') ${b} ${I}, ${P}`},ht=r=>{rs=ge.colorizedCanvas(y,Y,r).toDataURL(),as=ge.colorizedCanvas(U,E,r).toDataURL(),Ge(us)};ht(ls());const qe=()=>{l.emit("replaySpeed",c.speeds[c.speedIdx]),l.emit("replayPaused",c.paused)},q=(r,p=void 0)=>{l.emit("statusMessage",{what:r,value:p})},cs=()=>{c.speedIdx+1<c.speeds.length&&(c.speedIdx++,qe(),q("Speed Up"))},ds=()=>{c.speedIdx>=1&&(c.speedIdx--,qe(),q("Speed Down"))},ps=()=>{c.paused=!c.paused,qe(),q(c.paused?"Paused":"Playing")};let Fe=!1;const hs=()=>{Fe=!Fe,l.emit("togglePreview",Fe)},gs=()=>{x.soundsEnabled=!x.soundsEnabled;const r=x.soundsEnabled;l.emit("toggleSoundsEnabled",r),J.setBool(ie.SOUND_ENABLED,r),q("Sounds",r)},ms=()=>{x.showPlayerNames=!x.showPlayerNames;const r=x.showPlayerNames;l.emit("togglePlayerNames",r),J.setBool(ie.SHOW_PLAYER_NAMES,r),q("Player names",r)};l.on("replayOnSpeedUp",()=>{cs()}),l.on("replayOnSpeedDown",()=>{ds()}),l.on("replayOnPauseToggle",()=>{ps()}),l.on("onPreviewChange",r=>{Fe!==r&&(Fe=r)}),l.on("onBgChange",r=>{x.background!==r&&(x.background=r,J.setStr(ie.COLOR_BACKGROUND,r),ue.addEvent([d.INPUT_EV_BG_COLOR,r]),q("Background",r))}),l.on("onColorChange",r=>{x.color!==r&&(x.color=r,J.setStr(ie.PLAYER_COLOR,r),ue.addEvent([d.INPUT_EV_PLAYER_COLOR,r]),q("Color",r))}),l.on("onNameChange",r=>{x.name!==r&&(x.name=r,J.setStr(ie.PLAYER_NAME,r),ue.addEvent([d.INPUT_EV_PLAYER_NAME,r]),q("Name",r))}),l.on("onOtherPlayerClickSoundEnabledChange",r=>{x.otherPlayerClickSoundEnabled!==r&&(x.otherPlayerClickSoundEnabled=r,J.setBool(ie.OTHER_PLAYER_CLICK_SOUND_ENABLED,r),q("Other player sounds",r))}),l.on("onSoundsEnabledChange",r=>{x.soundsEnabled!==r&&(x.soundsEnabled=r,J.setBool(ie.SOUND_ENABLED,r),q("Sounds",r))}),l.on("onSoundsVolumeChange",r=>{x.soundsVolume!==r&&(x.soundsVolume=r,J.setInt(ie.SOUND_VOLUME,r),pt(),q("Volume",r))}),l.on("onShowPlayerNamesChange",r=>{x.showPlayerNames!==r&&(x.showPlayerNames=r,J.setBool(ie.SHOW_PLAYER_NAMES,r),q("Player names",r))}),l.on("setHotkeys",r=>{ue.setHotkeys(r)}),l.on("requireRerender",()=>{oe=!0});const fs=[];let Qe;const fo=()=>{fs.forEach(r=>{clearInterval(r)}),Qe&&clearTimeout(Qe)};if(n===Ze?fs.push(setInterval(()=>{Ke(w())},1e3)):n===fe&&qe(),n===Ze)Pe.onServerChange(r=>{r[0],r[1],r[2];const p=r[3];let P=!1,V=!1;for(const[G,B]of p)switch(G){case d.CHANGE_PLAYER:{const L=z.decodePlayer(B);L.id!==t&&(k.setPlayer(e,L.id,L),P=!0)}break;case d.CHANGE_TILE:{const L=z.decodePiece(B);k.setPiece(e,L.idx,L),P=!0}break;case d.CHANGE_DATA:k.setPuzzleData(e,B),P=!0;break;case d.PLAYER_SNAP:B!==t&&(V=!0);break}V&&dt()&&os()&&pt(),P&&(oe=!0),ct=!!k.getFinishTs(e)});else if(n===fe){const r=(V,G)=>{const B=V;if(B[0]===d.LOG_ADD_PLAYER){const L=B[1];return k.addPlayer(e,L,G),!0}if(B[0]===d.LOG_UPDATE_PLAYER){const L=k.getPlayerIdByIndex(e,B[1]);if(!L)throw"[ 2021-05-17 player not found (update player) ]";return k.addPlayer(e,L,G),!0}if(B[0]===d.LOG_HANDLE_INPUT){const L=k.getPlayerIdByIndex(e,B[1]);if(!L)throw"[ 2021-05-17 player not found (handle input) ]";const ve=B[2];return k.handleInput(e,L,ve,G),!0}return!1};let p=c.lastGameTs;const P=async()=>{c.logPointer+1>=c.log.length&&await D(e);const V=ye.timestamp();if(c.paused){c.lastRealTs=V,Qe=setTimeout(P,50);return}const B=(V-c.lastRealTs)*c.speeds[c.speedIdx];let L=c.lastGameTs+B,ve=!0;do if(c.paused)ve=!1;else{const Ie=c.logPointer+1;if(Ie>=c.log.length)ve=!1;else{const ys=c.log[c.logPointer],_s=p+ys[ys.length-1],gt=c.log[Ie],Es=gt[gt.length-1],mt=_s+Es;mt>L?(L+500*ye.MS<mt&&(L+=Es),ve=!1):(p=_s,r(gt,mt)&&(oe=!0),c.logPointer=Ie)}}while(ve);c.lastRealTs=V,c.lastGameTs=L,Ke(w()),c.final||(Qe=setTimeout(P,50))};P()}const yo=Sr({update:()=>{ue.createKeyEvents();for(const r of ue.consumeAll())if(n===Ze){const p=r[0];if(p===d.INPUT_EV_MOVE){const G=$.worldDimToViewportRaw({w:r[1],h:r[2]});oe=!0,$.move(G.w,G.h),delete M.last}else if(p===d.INPUT_EV_MOUSE_MOVE){if(r[5]&&!k.getFirstOwnedPiece(e,t)){const B=$.worldDimToViewportRaw({w:r[3],h:r[4]});oe=!0,$.move(B.w,B.h),delete M.last}}else if(p===d.INPUT_EV_PLAYER_COLOR)ht(r[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Ge(!0);else if(p===d.INPUT_EV_MOUSE_UP)Ge(!1);else if(p===d.INPUT_EV_ZOOM_IN){const G={x:r[1],y:r[2]};oe=!0,$.zoom("in",$.worldToViewportRaw(G)),delete M.last}else if(p===d.INPUT_EV_ZOOM_OUT){const G={x:r[1],y:r[2]};oe=!0,$.zoom("out",$.worldToViewportRaw(G)),delete M.last}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)hs();else if(p===d.INPUT_EV_TOGGLE_SOUNDS)gs();else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)ms();else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE){const G="center",B=je(G);q(B?`Restored position "${B}"`:`Position "${G}" not set`)}else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)ke=!ke,q(`${ke?"Showing":"Hiding"} finished pieces`),oe=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)Ue=!Ue,q(`${Ue?"Showing":"Hiding"} unfinished pieces`),oe=!0;else if(p===d.INPUT_EV_STORE_POS){const G=`${r[1]}`;M[G]=$.snapshot(),q(`Stored position ${G}`)}else if(p===d.INPUT_EV_RESTORE_POS){const G=`${r[1]}`,B=je(G);q(B?`Restored position "${B}"`:`Position "${G}" not set`)}const P=w(),V=k.handleInput(e,t,r,P);dt()&&V.find(G=>G[0]===d.PLAYER_SNAP)&&pt(),V.length>0&&(oe=!0),Pe.sendClientEvent(r)}else if(n===fe){const p=r[0];if(p===d.INPUT_EV_REPLAY_TOGGLE_PAUSE)ps();else if(p===d.INPUT_EV_REPLAY_SPEED_DOWN)ds();else if(p===d.INPUT_EV_REPLAY_SPEED_UP)cs();else if(p===d.INPUT_EV_MOVE){const P=$.worldDimToViewportRaw({w:r[1],h:r[2]});oe=!0,$.move(P.w,P.h)}else if(p===d.INPUT_EV_MOUSE_MOVE){if(r[5]){const V=$.worldDimToViewportRaw({w:r[3],h:r[4]});oe=!0,$.move(V.w,V.h)}}else if(p===d.INPUT_EV_PLAYER_COLOR)ht(r[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Ge(!0);else if(p===d.INPUT_EV_MOUSE_UP)Ge(!1);else if(p===d.INPUT_EV_ZOOM_IN){const P={x:r[1],y:r[2]};oe=!0,$.zoom("in",$.worldToViewportRaw(P))}else if(p===d.INPUT_EV_ZOOM_OUT){const P={x:r[1],y:r[2]};oe=!0,$.zoom("out",$.worldToViewportRaw(P))}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)hs();else if(p===d.INPUT_EV_TOGGLE_SOUNDS)gs();else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)ms();else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE){const P="center",V=je(P);q(V?`Restored position "${V}"`:`Position "${P}" not set`)}else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)ke=!ke,q(`${ke?"Showing":"Hiding"} finished pieces`),oe=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)Ue=!Ue,q(`${Ue?"Showing":"Hiding"} unfinished pieces`),oe=!0;else if(p===d.INPUT_EV_STORE_POS){const P=`${r[1]}`;M[P]=$.snapshot(),q(`Stored position ${P}`)}else if(p===d.INPUT_EV_RESTORE_POS){const P=`${r[1]}`,V=je(P);q(V?`Restored position "${V}"`:`Position "${P}" not set`)}}ct=!!k.getFinishTs(e),ts()&&(He.update(),oe=!0)},render:async()=>{if(!oe)return;const r=w();let p,P,V;window.DEBUG&&Ae.checkpoint_start(0),m.fillStyle=is(),m.fillRect(0,0,S.width,S.height),window.DEBUG&&Ae.checkpoint("clear done"),p=$.worldToViewportRaw(at),P=$.worldDimToViewportRaw(K),m.fillStyle="rgba(255, 255, 255, .3)",m.fillRect(p.x,p.y,P.w,P.h),window.DEBUG&&Ae.checkpoint("board done");const G=k.getPiecesSortedByZIndex(e);window.DEBUG&&Ae.checkpoint("get tiles done"),P=$.worldDimToViewportRaw(Xt);for(const L of G)!Ia(L)||(V=Jt[L.idx],p=$.worldToViewportRaw({x:Q+L.pos.x,y:Q+L.pos.y}),m.drawImage(V,0,0,V.width,V.height,p.x,p.y,P.w,P.h));window.DEBUG&&Ae.checkpoint("tiles done");const B=[];for(const L of k.getActivePlayers(e,r))a(L)&&(V=await T(L),p=$.worldToViewport(L),m.drawImage(V,p.x-b,p.y-I),ns()&&B.push([`${L.name} (${L.points})`,p.x,p.y+_]));m.fillStyle="white",m.textAlign="center";for(const[L,ve,Ie]of B)m.fillText(L,ve,Ie);window.DEBUG&&Ae.checkpoint("players done"),Ke(r),window.DEBUG&&Ae.checkpoint("HUD done"),ts()&&He.render(),oe=!1}}),_o=()=>{fo(),yo.stop(),ue&&ue.unregisterEvents()};return{previewImageUrl:go,player:x,game:k.get(e),disconnect:Pe.disconnect,connect:ee,unload:_o}}const Ba=se({name:"game",components:{PuzzleStatusComponent:Tt,Scores:Ct,SettingsOverlay:bt,PreviewOverlay:$t,InfoOverlay:At,ConnectionOverlay:Ds,HelpOverlay:Dt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:vs(),g:{player:ws(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await co(`${this.$route.params.id}`,pe.clientId(),this.$config.WS_ADDRESS,Ze,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}}}),Ya={id:"game"},Wa=o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),xa={class:"menu-left"},Za={key:0,class:"switch-game-replay"},Ha=N("\u21AA\uFE0F Watch replay"),ja={class:"menu"},Ka={class:"tabs"},qa=N("\u{1F9E9} Puzzles"),Qa={class:"menu-right"},Xa={key:4,class:"status-messages"},Ja={ref:"canvas"};function eu(e,t,s,n,i,l){const a=O("settings-overlay"),u=O("preview-overlay"),f=O("info-overlay"),y=O("help-overlay"),U=O("overlay"),Y=O("connection-overlay"),E=O("puzzle-status"),g=O("router-link"),b=O("scores");return h(),v("div",Ya,[e.overlay==="settings"?(h(),ne(a,{key:0,onClose:t[0]||(t[0]=_=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=_=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=_=>e.g.player=_)},null,8,["modelValue"])):W("",!0),e.overlay==="preview"?(h(),ne(u,{key:1,onClose:t[3]||(t[3]=_=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=_=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):W("",!0),e.g.game&&e.overlay==="info"?(h(),ne(f,{key:2,onClose:t[5]||(t[5]=_=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=_=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):W("",!0),e.overlay==="help"?(h(),ne(y,{key:3,onClose:t[7]||(t[7]=_=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=_=>e.toggle("help",!0))})):W("",!0),H(Z(U,null,{default:le(()=>[Wa]),_:1},512),[[Xe,e.cuttingPuzzle]]),Z(Y,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),o("div",xa,[Z(E,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(h(),v("div",Za,[Z(g,{to:{name:"replay",params:{id:e.g.game.id}}},{default:le(()=>[Ha]),_:1},8,["to"])])):W("",!0)]),o("div",ja,[o("div",Ka,[Z(g,{class:"opener",to:{name:"index"},target:"_blank"},{default:le(()=>[qa]),_:1}),o("div",{class:"opener",onClick:t[9]||(t[9]=_=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[10]||(t[10]=_=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[11]||(t[11]=_=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[12]||(t[12]=_=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",Qa,[Z(b,{players:e.players},null,8,["players"])]),e.statusMessages.length?(h(),v("div",Xa,[(h(!0),v(ae,null,de(e.statusMessages,(_,I)=>(h(),v("div",{key:I},F(_),1))),128))])):W("",!0),o("canvas",Ja,null,512)])}var tu=X(Ba,[["render",eu]]);const su=se({name:"replay",components:{PuzzleStatusComponent:Tt,Scores:Ct,SettingsOverlay:bt,PreviewOverlay:$t,InfoOverlay:At,HelpOverlay:Dt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:vs(),g:{player:ws(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await co(`${this.$route.params.id}`,pe.clientId(),this.$config.WS_ADDRESS,fe,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),ou={id:"replay"},nu={key:4,class:"overlay"},iu=o("div",{class:"overlay-content"},[o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),lu=[iu],ru={class:"menu-left"},au={class:"playback-control"},uu={key:0,class:"switch-game-replay"},cu=N("\u{1F9E9} To the game"),du={class:"menu"},pu={class:"tabs"},hu=N("\u{1F9E9} Puzzles"),gu={class:"menu-right"},mu={key:5,class:"status-messages"},fu={ref:"canvas"};function yu(e,t,s,n,i,l){const a=O("settings-overlay"),u=O("preview-overlay"),f=O("info-overlay"),y=O("help-overlay"),U=O("puzzle-status"),Y=O("router-link"),E=O("scores");return h(),v("div",ou,[e.overlay==="settings"?(h(),ne(a,{key:0,onClose:t[0]||(t[0]=g=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=g=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=g=>e.g.player=g)},null,8,["modelValue"])):W("",!0),e.overlay==="preview"?(h(),ne(u,{key:1,onClose:t[3]||(t[3]=g=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=g=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):W("",!0),e.g.game&&e.overlay==="info"?(h(),ne(f,{key:2,onClose:t[5]||(t[5]=g=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=g=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):W("",!0),e.overlay==="help"?(h(),ne(y,{key:3,onClose:t[7]||(t[7]=g=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=g=>e.toggle("help",!0))})):W("",!0),e.cuttingPuzzle?(h(),v("div",nu,lu)):W("",!0),o("div",ru,[Z(U,{status:e.status},null,8,["status"]),o("div",au,[o("div",null,F(e.replayText),1),o("button",{class:"btn",onClick:t[9]||(t[9]=g=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),o("button",{class:"btn",onClick:t[10]||(t[10]=g=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),o("button",{class:"btn",onClick:t[11]||(t[11]=g=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")]),e.g.game?(h(),v("div",uu,[Z(Y,{to:{name:"game",params:{id:e.g.game.id}}},{default:le(()=>[cu]),_:1},8,["to"])])):W("",!0)]),o("div",du,[o("div",pu,[Z(Y,{class:"opener",to:{name:"index"},target:"_blank"},{default:le(()=>[hu]),_:1}),o("div",{class:"opener",onClick:t[12]||(t[12]=g=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[13]||(t[13]=g=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[14]||(t[14]=g=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[15]||(t[15]=g=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",gu,[Z(E,{players:e.players},null,8,["players"])]),e.statusMessages.length?(h(),v("div",mu,[(h(!0),v(ae,null,de(e.statusMessages,(g,b)=>(h(),v("div",{key:b},F(g),1))),128))])):W("",!0),o("canvas",fu,null,512)])}var _u=X(su,[["render",yu]]);let po=null;async function Eu(){po=await(await pe.get("/api/me",{})).json()}var ho={getMe:()=>po,init:Eu};const vu=se({props:{image:{type:Object,required:!0}},data:()=>({me:ho.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function wu(e,t,s,n,i,l){return h(),v("div",{class:"imageteaser",style:Ve(e.style),onClick:t[1]||(t[1]=(...a)=>e.onClick&&e.onClick(...a))},[e.canEdit?(h(),v("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=Po((...a)=>e.onEditClick&&e.onEditClick(...a),["stop"]))},"\u270F\uFE0F")):W("",!0)],4)}var Pu=X(vu,[["render",wu]]);const Su=se({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Cu={class:"overlay"};function Tu(e,t,s,n,i,l){return h(),v("div",Cu,[o("div",{class:Be(["overlay-background",e.classes.map(a=>"overlay-background-"+a)]),onClick:t[0]||(t[0]=a=>e.$emit("bgclick"))},null,2),o("div",{class:Be(["overlay-content",e.classes.map(a=>"overlay-content-"+a)])},[So(e.$slots,"default")],2)])}var bu=X(Su,[["render",Tu]]);const $u={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Au=["title"];function Nu(e,t,s,n,i,l){return h(),v("div",{style:Ve(l.style),title:s.title},null,12,Au)}var Ou=X($u,[["render",Nu]]);const ku=se({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),Uu={key:0,class:"autocomplete"},Ru=["onClick"],Vu=["onClick"];function Lu(e,t,s,n,i,l){return h(),v("div",null,[H(o("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=a=>e.input=a),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...a)=>e.onChange&&e.onChange(...a)),onKeydown:t[2]||(t[2]=Co((...a)=>e.add&&e.add(...a),["enter"])),onKeyup:t[3]||(t[3]=(...a)=>e.onKeyUp&&e.onKeyUp(...a))},null,544),[[Ce,e.input]]),e.autocomplete.values?(h(),v("div",Uu,[o("ul",null,[(h(!0),v(ae,null,de(e.autocomplete.values,(a,u)=>(h(),v("li",{key:u,class:Be({active:u===e.autocomplete.idx}),onClick:f=>e.addVal(a)},F(a),11,Ru))),128))])])):W("",!0),(h(!0),v(ae,null,de(e.values,(a,u)=>(h(),v("span",{key:u,class:"bit is-clickable",onClick:f=>e.rm(a)},F(a)+" \u2716",9,Vu))),128))])}var Mu=X(ku,[["render",Lu],["__scopeId","data-v-d5073870"]]);(async()=>{pe.init(),await ho.init();const t=await(await pe.get("/api/conf",{})).json(),s=To({history:bo(),routes:[{name:"index",path:"/",component:mn},{name:"new-game",path:"/new-game",component:Li},{name:"game",path:"/g/:id",component:tu},{name:"replay",path:"/replay/:id",component:_u}]});s.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const n=$o(Lo);n.config.globalProperties.$config=t,n.use(s),n.component("connection-overlay",Ds),n.component("edit-image-dialog",Ns),n.component("game-teaser",bs),n.component("help-overlay",Dt),n.component("image-library",$s),n.component("image-teaser",Pu),n.component("info-overlay",At),n.component("new-game-dialog",ks),n.component("new-image-dialog",As),n.component("overlay",bu),n.component("preview-overlay",$t),n.component("puzzle-status",Tt),n.component("responsive-image",Ou),n.component("scores",Ct),n.component("settings-overlay",bt),n.component("tags-input",Mu),n.mount("#app")})();
//# sourceMappingURL=index.662d8f18.js.map
