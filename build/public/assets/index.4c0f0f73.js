import{d as e,c as t,a as n,w as o,b as l,r as i,o as s,e as a,t as r,F as d,f as c,g as u,v as p,h,i as g,j as y,k as m,l as f,m as w,n as v}from"./vendor.00b608ff.js";var x=e({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}});const b={id:"app"},A={key:0,class:"nav"},z=a("Index"),T=a("New game");x.render=function(e,a,r,d,c,u){const p=i("router-link"),h=i("router-view");return s(),t("div",b,[e.showNav?(s(),t("ul",A,[n("li",null,[n(p,{class:"btn",to:{name:"index"}},{default:o((()=>[z])),_:1})]),n("li",null,[n(p,{class:"btn",to:{name:"new-game"}},{default:o((()=>[T])),_:1})])])):l("",!0),n(h)])};const S=864e5,C=e=>{const t=Math.floor(e/S);e%=S;const n=Math.floor(e/36e5);e%=36e5;const o=Math.floor(e/6e4);e%=6e4;return`${t}d ${n}h ${o}m ${Math.floor(e/1e3)}s`};var k=1e3,I=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},P=(e,t)=>C(t-e),_=C,D=e({name:"game-teaser",props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const n=t?"🏁":"⏳",o=e,l=t||I();return`${n} ${P(o,l)}`}}});const B={class:"game-info-text"},O=n("br",null,null,-1),E=n("br",null,null,-1),M=n("br",null,null,-1);D.render=function(e,d,c,u,p,h){const g=i("router-link");return s(),t("div",{class:"game-teaser",style:e.style},[n(g,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:o((()=>[n("span",B,[a(" 🧩 "+r(e.game.tilesFinished)+"/"+r(e.game.tilesTotal),1),O,a(" 👥 "+r(e.game.players),1),E,a(" "+r(e.time(e.game.started,e.game.finished)),1),M])])),_:1},8,["to"]),l("",!0)],4)};var N=e({components:{GameTeaser:D},data:()=>({gamesRunning:[],gamesFinished:[]}),async created(){const e=await fetch("/api/index-data"),t=await e.json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}});const U=n("h1",null,"Running games",-1),R=n("h1",null,"Finished games",-1);function $(e,t){const n=e.x-t.x,o=e.y-t.y;return Math.sqrt(n*n+o*o)}function G(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}N.render=function(e,o,l,a,r,u){const p=i("game-teaser");return s(),t("div",null,[U,(s(!0),t(d,null,c(e.gamesRunning,((e,o)=>(s(),t("div",{class:"game-teaser-wrap",key:o},[n(p,{game:e},null,8,["game"])])))),128)),R,(s(!0),t(d,null,c(e.gamesFinished,((e,o)=>(s(),t("div",{class:"game-teaser-wrap",key:o},[n(p,{game:e},null,8,["game"])])))),128))])};var V={pointSub:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},pointAdd:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},pointDistance:$,pointInBounds:function(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h},rectCenter:G,rectMoved:function(e,t,n){return{x:e.x+t,y:e.y+n,w:e.w,h:e.h}},rectCenterDistance:function(e,t){return $(G(e),G(t))},rectsOverlap:function(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}};var j=1,W=4,F=5,H=2,L=3,Q=6,Y=2,q=4,Z=3,K=9,J=1,X=2,ee=3,te=4,ne=5,oe=6,le=7,ie=8,se=10,ae=1,re=2,de=3;class ce{constructor(e){this.rand_high=e||3735929054,this.rand_low=1231121986^e}random(e,t){return this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295,e+(this.rand_high>>>0)/4294967295*(t-e+1)|0}static serialize(e){return{rand_high:e.rand_high,rand_low:e.rand_low}}static unserialize(e){const t=new ce(0);return t.rand_high=e.rand_high,t.rand_low=e.rand_low,t}}const ue=(e,t)=>{const n=`${e}`;return n.length>=t.length?n:t.substr(0,t.length-n.length)+n},pe=(...e)=>{const t=t=>(...n)=>{const o=new Date,l=ue(o.getHours(),"00"),i=ue(o.getMinutes(),"00"),s=ue(o.getSeconds(),"00");console[t](`${l}:${i}:${s}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},he=(e,t,n)=>e.random(t,n);var ge={hash:e=>{let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t},uniqId:()=>Date.now().toString(36)+Math.random().toString(36).substring(2),randomInt:he,choice:(e,t)=>t[he(e,0,t.length-1)],shuffle:(e,t)=>{const n=t.slice();for(let o=0;o<=n.length-2;o++){const t=he(e,o,n.length-1),l=n[o];n[o]=n[t],n[t]=l}return n},encodeShape:function(e){return"number"==typeof e?e:e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6},decodeShape:function(e){return"number"!=typeof e?e:{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}},encodeTile:function(e){return Array.isArray(e)?e:[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]},decodeTile:function(e){return Array.isArray(e)?{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}:e},encodePlayer:function(e){return Array.isArray(e)?e:[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]},decodePlayer:function(e){return Array.isArray(e)?{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}:e},encodeGame:function(e){return Array.isArray(e)?e:[e.id,e.rng.type,ce.serialize(e.rng.obj),e.puzzle,e.players,e.evtInfos,e.scoreMode]},decodeGame:function(e){return Array.isArray(e)?{id:e[0],rng:{type:e[1],obj:ce.unserialize(e[2])},puzzle:e[3],players:e[4],evtInfos:e[5],scoreMode:e[6]}:e},coordByTileIdx:function(e,t){const n=e.width/e.tileSize;return{x:t%n,y:Math.floor(t/n)}}};const ye={};function me(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function fe(e,t){let n=0;for(let o of ye[e].players){if(ge.decodePlayer(o).id===t)return n;n++}return-1}function we(e,t){let n=fe(e,t);return ge.decodePlayer(ye[e].players[n])}function ve(e,t,n){let o=fe(e,t);-1===o?ye[e].players.push(ge.encodePlayer(n)):ye[e].players[o]=ge.encodePlayer(n)}function xe(e,t){return-1!==fe(e,t)}function be(e){return ye[e]?ye[e].players.map(ge.decodePlayer):[]}function Ae(e){return ye[e].puzzle.tiles.length}function ze(e){return ye[e].scoreMode||0}function Te(e){return Se(e)===Ae(e)}function Se(e){let t=0;for(let n of ye[e].puzzle.tiles)-1===ge.decodeTile(n).owner&&t++;return t}function Ce(e,t,n){const o=we(e,t);for(let l of Object.keys(n))o[l]=n[l];ve(e,t,o)}function ke(e,t){for(let n of Object.keys(t))ye[e].puzzle.data[n]=t[n]}function Ie(e,t,n){for(let o of Object.keys(n)){const l=ge.decodeTile(ye[e].puzzle.tiles[t]);l[o]=n[o],ye[e].puzzle.tiles[t]=ge.encodeTile(l)}}const Pe=(e,t)=>ge.decodeTile(ye[e].puzzle.tiles[t]),_e=(e,t)=>Pe(e,t).group,De=(e,t)=>{const n=ye[e].puzzle.info,o={x:(n.table.width-n.width)/2,y:(n.table.height-n.height)/2},l=function(e,t){const n=ye[e].puzzle.info,o=ge.coordByTileIdx(n,t),l=o.x*n.tileSize,i=o.y*n.tileSize;return{x:l,y:i}}(e,t);return V.pointAdd(o,l)},Be=(e,t)=>Pe(e,t).pos,Oe=e=>{const t=Ye(e),n=qe(e),o=Math.round(t/4),l=Math.round(n/4);return{x:0-o,y:0-l,w:t+2*o,h:n+2*l}},Ee=(e,t)=>{const n=Re(e),o=Pe(e,t);return{x:o.pos.x,y:o.pos.y,w:n,h:n}},Me=(e,t)=>Pe(e,t).z,Ne=(e,t)=>{for(let n of ye[e].puzzle.tiles){const e=ge.decodeTile(n);if(e.owner===t)return e.idx}return-1},Ue=e=>ye[e].puzzle.info.tileDrawSize,Re=e=>ye[e].puzzle.info.tileSize,$e=e=>ye[e].puzzle.data.maxGroup,Ge=e=>ye[e].puzzle.data.maxZ;function Ve(e,t){const n=ye[e].puzzle.info,o=ge.coordByTileIdx(n,t);return[o.y>0?t-n.tilesX:-1,o.x<n.tilesX-1?t+1:-1,o.y<n.tilesY-1?t+n.tilesX:-1,o.x>0?t-1:-1]}const je=(e,t,n)=>{for(let o of t)Ie(e,o,{z:n})},We=(e,t,n)=>{const o=Be(e,t);Ie(e,t,{pos:V.pointAdd(o,n)})},Fe=(e,t,n)=>{const o=Ue(e),l=Oe(e),i=n;for(let s of t){const t=Pe(e,s);t.pos.x+n.x<l.x?i.x=Math.max(l.x-t.pos.x,i.x):t.pos.x+o+n.x>l.x+l.w&&(i.x=Math.min(l.x+l.w-t.pos.x+o,i.x)),t.pos.y+n.y<l.y?i.y=Math.max(l.y-t.pos.y,i.y):t.pos.y+o+n.y>l.y+l.h&&(i.y=Math.min(l.y+l.h-t.pos.y+o,i.y))}for(let s of t)We(e,s,i)},He=(e,t,n)=>{for(let o of t)Ie(e,o,{owner:n})};function Le(e,t){const n=ye[e].puzzle.tiles,o=ge.decodeTile(n[t]),l=[];if(o.group)for(let i of n){const e=ge.decodeTile(i);e.group===o.group&&l.push(e.idx)}else l.push(o.idx);return l}const Qe=(e,t)=>{const n=we(e,t);return n?n.points:null},Ye=e=>ye[e].puzzle.info.table.width,qe=e=>ye[e].puzzle.info.table.height;var Ze={__createPlayerObject:me,setGame:function(e,t){ye[e]=t},exists:function(e){return!!ye[e]||!1},playerExists:xe,getActivePlayers:function(e,t){const n=t-30*k;return be(e).filter((e=>e.ts>=n))},getIdlePlayers:function(e,t){const n=t-30*k;return be(e).filter((e=>e.ts<n&&e.points>0))},addPlayer:function(e,t,n){xe(e,t)?Ce(e,t,{ts:n}):ve(e,t,me(t,n))},getFinishedTileCount:Se,getTileCount:Ae,getImageUrl:function(e){return ye[e].puzzle.info.imageUrl},setImageUrl:function(e,t){ye[e].puzzle.info.imageUrl=t},get:function(e){return ye[e]},getAllGames:function(){return Object.values(ye).sort(((e,t)=>Te(e.id)===Te(t.id)?t.puzzle.data.started-e.puzzle.data.started:Te(e.id)?1:-1))},getPlayerBgColor:(e,t)=>{const n=we(e,t);return n?n.bgcolor:null},getPlayerColor:(e,t)=>{const n=we(e,t);return n?n.color:null},getPlayerName:(e,t)=>{const n=we(e,t);return n?n.name:null},getPlayerIndexById:fe,getPlayerIdByIndex:function(e,t){return ye[e].players.length>t?ge.decodePlayer(ye[e].players[t]).id:null},changePlayer:Ce,setPlayer:ve,setTile:function(e,t,n){ye[e].puzzle.tiles[t]=ge.encodeTile(n)},setPuzzleData:function(e,t){ye[e].puzzle.data=t},getTableWidth:Ye,getTableHeight:qe,getPuzzle:e=>ye[e].puzzle,getRng:e=>ye[e].rng.obj,getPuzzleWidth:e=>ye[e].puzzle.info.width,getPuzzleHeight:e=>ye[e].puzzle.info.height,getTilesSortedByZIndex:function(e){return ye[e].puzzle.tiles.map(ge.decodeTile).sort(((e,t)=>e.z-t.z))},getFirstOwnedTile:(e,t)=>{const n=Ne(e,t);return n<0?null:ye[e].puzzle.tiles[n]},getTileDrawOffset:e=>ye[e].puzzle.info.tileDrawOffset,getTileDrawSize:Ue,getFinalTilePos:De,getStartTs:e=>ye[e].puzzle.data.started,getFinishTs:e=>ye[e].puzzle.data.finished,handleInput:function(e,t,n,o){const l=ye[e].puzzle,i=function(e,t){return t in ye[e].evtInfos?ye[e].evtInfos[t]:{_last_mouse:null,_last_mouse_down:null}}(e,t),s=[],a=()=>{s.push([ae,l.data])},r=t=>{s.push([re,ge.encodeTile(Pe(e,t))])},d=e=>{for(const t of e)r(t)},c=()=>{s.push([de,ge.encodePlayer(we(e,t))])},u=n[0];if(u===oe){const l=n[1];Ce(e,t,{bgcolor:l,ts:o}),c()}else if(u===le){const l=n[1];Ce(e,t,{color:l,ts:o}),c()}else if(u===ie){const l=`${n[1]}`.substr(0,16);Ce(e,t,{name:l,ts:o}),c()}else if(u===J){const l={x:n[1],y:n[2]};Ce(e,t,{d:1,ts:o}),c(),i._last_mouse_down=l;const s=((e,t)=>{let n=ye[e].puzzle.info,o=ye[e].puzzle.tiles,l=-1,i=-1;for(let s=0;s<o.length;s++){const e=ge.decodeTile(o[s]);if(0!==e.owner)continue;const a={x:e.pos.x,y:e.pos.y,w:n.tileSize,h:n.tileSize};V.pointInBounds(t,a)&&(-1===l||e.z>l)&&(l=e.z,i=s)}return i})(e,l);if(s>=0){let n=Ge(e)+1;ke(e,{maxZ:n}),a();const o=Le(e,s);je(e,o,Ge(e)),He(e,o,t),d(o)}i._last_mouse=l}else if(u===ee){const l=n[1],s=n[2],a={x:l,y:s};if(null===i._last_mouse_down)Ce(e,t,{x:l,y:s,ts:o}),c();else{let n=Ne(e,t);if(n>=0){Ce(e,t,{x:l,y:s,ts:o}),c();const r=Le(e,n);let u=V.pointInBounds(a,Oe(e))&&V.pointInBounds(i._last_mouse_down,Oe(e));for(let t of r){const n=Ee(e,t);if(V.pointInBounds(a,n)){u=!0;break}}if(u){const t=l-i._last_mouse_down.x,n=s-i._last_mouse_down.y;Fe(e,r,{x:t,y:n}),d(r)}}else Ce(e,t,{ts:o}),c();i._last_mouse_down=a}i._last_mouse=a}else if(u===X){const s={x:n[1],y:n[2]},u=0;i._last_mouse_down=null;let p=Ne(e,t);if(p>=0){let n=Le(e,p);He(e,n,0),d(n);let i=Be(e,p),s=De(e,p);if(V.pointDistance(s,i)<l.info.snapDistance){let l=V.pointSub(s,i);Fe(e,n,l),((e,t)=>{for(let n of t)Ie(e,n,{owner:-1,z:1})})(e,n),d(n);let r=Qe(e,t);0===ze(e)?r+=n.length:1===ze(e)&&(r+=1),Ce(e,t,{d:u,ts:o,points:r}),c(),Se(e)===Ae(e)&&(ke(e,{finished:o}),a())}else{const n=(e,t,n,o)=>{let l=ye[e].puzzle.info;if(n<0)return!1;if(((e,t,n)=>{const o=_e(e,t),l=_e(e,n);return o&&o===l})(e,t,n))return!1;const i=Be(e,t),s=V.pointAdd(Be(e,n),{x:o[0]*l.tileSize,y:o[1]*l.tileSize});if(V.pointDistance(i,s)<l.snapDistance){let o=V.pointSub(s,i),l=Le(e,t);Fe(e,l,o),((e,t,n)=>{const o=ye[e].puzzle.tiles,l=_e(e,t),i=_e(e,n);let s;const d=[];l&&d.push(l),i&&d.push(i),l?s=l:i?s=i:(ke(e,{maxGroup:$e(e)+1}),a(),s=$e(e));if(Ie(e,t,{group:s}),r(t),Ie(e,n,{group:s}),r(n),d.length>0)for(const a of o){const t=ge.decodeTile(a);d.includes(t.group)&&(Ie(e,t.idx,{group:s}),r(t.idx))}})(e,t,n),l=Le(e,t);const c=((e,t)=>{let n=0;for(let o of t){let t=Me(e,o);t>n&&(n=t)}return n})(e,l);return je(e,l,c),d(l),!0}return!1};let l=!1;for(let t of Le(e,p)){let o=Ve(e,t);if(n(e,t,o[0],[0,1])||n(e,t,o[1],[-1,0])||n(e,t,o[2],[0,-1])||n(e,t,o[3],[1,0])){l=!0;break}}if(l&&1===ze(e)){const n=Qe(e,t)+1;Ce(e,t,{d:u,ts:o,points:n}),c()}else Ce(e,t,{d:u,ts:o}),c()}}else Ce(e,t,{d:u,ts:o}),c();i._last_mouse=s}else if(u===te){const l=n[1],s=n[2];Ce(e,t,{x:l,y:s,ts:o}),c(),i._last_mouse={x:l,y:s}}else if(u===ne){const l=n[1],s=n[2];Ce(e,t,{x:l,y:s,ts:o}),c(),i._last_mouse={x:l,y:s}}else Ce(e,t,{ts:o}),c();return function(e,t,n){ye[e].evtInfos[t]=n}(e,t,i),s},SCORE_MODE_FINAL:0,SCORE_MODE_ANY:1},Ke=e({name:"upload",props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const n=t.files[0];if(!n)return;const o=new FormData;o.append("file",n,n.name);const l=await fetch("/upload",{method:"post",body:o}),i=await l.json();this.$emit("uploaded",i)}}});const Je={class:"btn"};Ke.render=function(e,o,l,i,a,d){return s(),t("label",null,[n("input",{type:"file",style:{display:"none"},onChange:o[1]||(o[1]=(...t)=>e.upload&&e.upload(...t)),accept:e.accept},null,40,["accept"]),n("span",Je,r(e.label||"Upload File"),1)])};var Xe=e({name:"image-teaser",props:{image:{type:Object,required:!0}},computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}}},methods:{onClick(){this.$emit("click")}}});Xe.render=function(e,n,o,l,i,a){return s(),t("div",{class:"imageteaser",style:e.style,onClick:n[1]||(n[1]=(...t)=>e.onClick&&e.onClick(...t))},null,4)};var et=e({name:"new-game-dialog",components:{Upload:Ke,ImageTeaser:Xe},props:{images:Array},emits:{newGame:null},data:()=>({tiles:1e3,image:"",scoreMode:Ze.SCORE_MODE_ANY}),methods:{mediaImgUploaded(e){this.image=e.image},canStartNewGame(){return!!(this.tilesInt&&this.image&&[0,1].includes(this.scoreModeInt))},onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt})}},computed:{scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}});const tt=n("h1",null,"New game",-1),nt=n("td",null,[n("label",null,"Pieces: ")],-1),ot=n("td",null,[n("label",null,"Scoring: ")],-1),lt=a(" Any (Score when pieces are connected to each other or on final location)"),it=n("br",null,null,-1),st=a(" Final (Score when pieces are put to their final location)"),at=n("td",null,[n("label",null,"Image: ")],-1),rt={key:0},dt=a(" or "),ct={key:1},ut=a(" (or select from below) "),pt={colspan:"2"},ht=n("h1",null,"Image lib",-1);et.render=function(e,o,l,a,r,g){const y=i("upload"),m=i("image-teaser");return s(),t("div",null,[tt,n("table",null,[n("tr",null,[nt,n("td",null,[u(n("input",{type:"text","onUpdate:modelValue":o[1]||(o[1]=t=>e.tiles=t)},null,512),[[p,e.tiles]])])]),n("tr",null,[ot,n("td",null,[n("label",null,[u(n("input",{type:"radio","onUpdate:modelValue":o[2]||(o[2]=t=>e.scoreMode=t),value:"1"},null,512),[[h,e.scoreMode]]),lt]),it,n("label",null,[u(n("input",{type:"radio","onUpdate:modelValue":o[3]||(o[3]=t=>e.scoreMode=t),value:"0"},null,512),[[h,e.scoreMode]]),st])])]),n("tr",null,[at,n("td",null,[e.image?(s(),t("span",rt,[n("img",{src:e.image.url,style:{width:"150px"}},null,8,["src"]),dt,n(y,{onUploaded:o[4]||(o[4]=t=>e.mediaImgUploaded(t)),accept:"image/*",label:"Upload an image"})])):(s(),t("span",ct,[n(y,{onUploaded:o[5]||(o[5]=t=>e.mediaImgUploaded(t)),accept:"image/*",label:"Upload an image"}),ut]))])]),n("tr",null,[n("td",pt,[n("button",{class:"btn",disabled:!e.canStartNewGame,onClick:o[6]||(o[6]=(...t)=>e.onNewGameClick&&e.onNewGameClick(...t))},"Start new game",8,["disabled"])])])]),ht,n("div",null,[(s(!0),t(d,null,c(e.images,((n,o)=>(s(),t(m,{image:n,onClick:t=>e.image=n,key:o},null,8,["image","onClick"])))),128))])])};var gt=e({components:{NewGameDialog:et},data:()=>({images:[]}),async created(){const e=await fetch("/api/newgame-data"),t=await e.json();this.images=t.images},methods:{async onNewGame(e){const t=await fetch("/newgame",{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(200===t.status){const e=await t.json();this.$router.push({name:"game",params:{id:e.id}})}}}});gt.render=function(e,o,l,a,r,d){const c=i("new-game-dialog");return s(),t("div",null,[n(c,{images:e.images,onNewGame:e.onNewGame},null,8,["images","onNewGame"])])};var yt=e({name:"scores",props:{activePlayers:{type:Array,required:!0},idlePlayers:{type:Array,required:!0}},computed:{actives(){return this.activePlayers.sort(((e,t)=>t.points-e.points)),this.activePlayers},idles(){return this.idlePlayers.sort(((e,t)=>t.points-e.points)),this.idlePlayers}}});const mt={class:"scores"},ft=n("div",null,"Scores",-1),wt=n("td",null,"⚡",-1),vt=n("td",null,"💤",-1);yt.render=function(e,o,l,i,a,u){return s(),t("div",mt,[ft,n("table",null,[(s(!0),t(d,null,c(e.actives,((e,o)=>(s(),t("tr",{key:o,style:{color:e.color}},[wt,n("td",null,r(e.name),1),n("td",null,r(e.points),1)],4)))),128)),(s(!0),t(d,null,c(e.idles,((e,o)=>(s(),t("tr",{key:o,style:{color:e.color}},[vt,n("td",null,r(e.name),1),n("td",null,r(e.points),1)],4)))),128))])])};var xt=e({name:"puzzle-status",props:{finished:{type:Boolean,required:!0},duration:{type:Number,required:!0},piecesDone:{type:Number,required:!0},piecesTotal:{type:Number,required:!0}},computed:{icon(){return this.finished?"🏁":"⏳"},durationStr(){return _(this.duration)}}});const bt={class:"timer"};xt.render=function(e,o,l,i,a,d){return s(),t("div",bt,[n("div",null," 🧩 "+r(e.piecesDone)+"/"+r(e.piecesTotal),1),n("div",null,r(e.icon)+" "+r(e.durationStr),1),g(e.$slots,"default")])};var At=e({name:"settings-overlay",emits:{bgclick:null,"update:modelValue":null},props:{modelValue:Object},created(){this.$watch("modelValue",(e=>{this.$emit("update:modelValue",e)}),{deep:!0})}});const zt=n("td",null,[n("label",null,"Background: ")],-1),Tt=n("td",null,[n("label",null,"Color: ")],-1),St=n("td",null,[n("label",null,"Name: ")],-1);At.render=function(e,o,l,i,a,r){return s(),t("div",{class:"overlay transparent",onClick:o[5]||(o[5]=t=>e.$emit("bgclick"))},[n("table",{class:"overlay-content settings",onClick:o[4]||(o[4]=y((()=>{}),["stop"]))},[n("tr",null,[zt,n("td",null,[u(n("input",{type:"color","onUpdate:modelValue":o[1]||(o[1]=t=>e.modelValue.background=t)},null,512),[[p,e.modelValue.background]])])]),n("tr",null,[Tt,n("td",null,[u(n("input",{type:"color","onUpdate:modelValue":o[2]||(o[2]=t=>e.modelValue.color=t)},null,512),[[p,e.modelValue.color]])])]),n("tr",null,[St,n("td",null,[u(n("input",{type:"text",maxLength:"16","onUpdate:modelValue":o[3]||(o[3]=t=>e.modelValue.name=t)},null,512),[[p,e.modelValue.name]])])])])])};var Ct=e({name:"preview-overlay",props:{img:String},emits:{bgclick:null},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}});const kt={class:"preview"};Ct.render=function(e,o,l,i,a,r){return s(),t("div",{class:"overlay",onClick:o[1]||(o[1]=t=>e.$emit("bgclick"))},[n("div",kt,[n("div",{class:"img",style:e.previewStyle},null,4)])])};const It=pe("Communication.js");let Pt,_t=e=>{},Dt=e=>{};let Bt=0;const Ot=e=>{Bt!==e&&(Bt=e,Dt(e))};function Et(e){if(2===Bt)try{Pt.send(JSON.stringify(e))}catch(t){It.info("unable to send message.. maybe because ws is invalid?")}}let Mt,Nt;var Ut={connect:function(e,t,n){return Mt=0,Nt={},Ot(3),new Promise((o=>{Pt=new WebSocket(e,n+"|"+t),Pt.onopen=e=>{Ot(2),Et([L])},Pt.onmessage=e=>{const t=JSON.parse(e.data),l=t[0];if(l===W){const e=t[1];o(e)}else{if(l!==j)throw`[ 2021-05-09 invalid connect msgType ${l} ]`;{const e=t[1],o=t[2];if(e===n&&Nt[o])return void delete Nt[o];_t(t)}}},Pt.onerror=e=>{throw Ot(1),"[ 2021-05-15 onerror ]"},Pt.onclose=e=>{4e3===e.code||1001===e.code?Ot(4):Ot(1)}}))},connectReplay:function(e,t,n){return Mt=0,Nt={},Ot(3),new Promise((o=>{Pt=new WebSocket(e,n+"|"+t),Pt.onopen=e=>{Ot(2),Et([Q])},Pt.onmessage=e=>{const t=JSON.parse(e.data),n=t[0];if(n!==F)throw`[ 2021-05-09 invalid connectReplay msgType ${n} ]`;{const e=t[1],n=t[2];o({game:e,log:n})}},Pt.onerror=e=>{throw Ot(1),"[ 2021-05-15 onerror ]"},Pt.onclose=e=>{4e3===e.code||1001===e.code?Ot(4):Ot(1)}}))},disconnect:function(){Pt&&Pt.close(4e3),Mt=0,Nt={}},sendClientEvent:function(e){Mt++,Nt[Mt]=e,Et([H,Mt,Nt[Mt]])},onServerChange:function(e){_t=e},onConnectionStateChange:function(e){Dt=e},CODE_CUSTOM_DISCONNECT:4e3,CONN_STATE_NOT_CONNECTED:0,CONN_STATE_DISCONNECTED:1,CONN_STATE_CLOSED:4,CONN_STATE_CONNECTED:2,CONN_STATE_CONNECTING:3},Rt=e({name:"connection-overlay",emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Ut.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Ut.CONN_STATE_CONNECTING},show(){return!(!this.lostConnection&&!this.connecting)}}});const $t={key:0,class:"overlay connection-lost"},Gt={key:0,class:"overlay-content"},Vt=n("div",null,"⁉️ LOST CONNECTION ⁉️",-1),jt={key:1,class:"overlay-content"},Wt=n("div",null,"Connecting...",-1);Rt.render=function(e,o,i,a,r,d){return e.show?(s(),t("div",$t,[e.lostConnection?(s(),t("div",Gt,[Vt,n("span",{class:"btn",onClick:o[1]||(o[1]=t=>e.$emit("reconnect"))},"Reconnect")])):l("",!0),e.connecting?(s(),t("div",jt,[Wt])):l("",!0)])):l("",!0)};var Ft=e({name:"help-overlay",emits:{bgclick:null}});const Ht=n("tr",null,[n("td",null,"⬆️ Move up:"),n("td",null,[n("div",null,[n("kbd",null,"W"),a("/"),n("kbd",null,"↑"),a("/🖱️")])])],-1),Lt=n("tr",null,[n("td",null,"⬇️ Move down:"),n("td",null,[n("div",null,[n("kbd",null,"S"),a("/"),n("kbd",null,"↓"),a("/🖱️")])])],-1),Qt=n("tr",null,[n("td",null,"⬅️ Move left:"),n("td",null,[n("div",null,[n("kbd",null,"A"),a("/"),n("kbd",null,"←"),a("/🖱️")])])],-1),Yt=n("tr",null,[n("td",null,"➡️ Move right:"),n("td",null,[n("div",null,[n("kbd",null,"D"),a("/"),n("kbd",null,"→"),a("/🖱️")])])],-1),qt=n("tr",null,[n("td"),n("td",null,[n("div",null,[a("Move faster by holding "),n("kbd",null,"Shift")])])],-1),Zt=n("tr",null,[n("td",null,"🔍+ Zoom in:"),n("td",null,[n("div",null,[n("kbd",null,"E"),a("/🖱️-Wheel")])])],-1),Kt=n("tr",null,[n("td",null,"🔍- Zoom out:"),n("td",null,[n("div",null,[n("kbd",null,"Q"),a("/🖱️-Wheel")])])],-1),Jt=n("tr",null,[n("td",null,"🖼️ Toggle preview:"),n("td",null,[n("div",null,[n("kbd",null,"Space")])])],-1),Xt=n("tr",null,[n("td",null,"🧩✔️ Toggle fixed pieces:"),n("td",null,[n("div",null,[n("kbd",null,"F")])])],-1),en=n("tr",null,[n("td",null,"🧩❓ Toggle loose pieces:"),n("td",null,[n("div",null,[n("kbd",null,"G")])])],-1);Ft.render=function(e,o,l,i,a,r){return s(),t("div",{class:"overlay transparent",onClick:o[2]||(o[2]=t=>e.$emit("bgclick"))},[n("table",{class:"overlay-content help",onClick:o[1]||(o[1]=y((()=>{}),["stop"]))},[Ht,Lt,Qt,Yt,qt,Zt,Kt,Jt,Xt,en])])};var tn=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg=="}),nn=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII="}),on=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII="}),ln=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII="});function sn(){let e=0,t=0,n=1;const o=(o,l)=>{e+=o/n,t+=l/n},l=e=>{const t=n+.05*n*("in"===e?1:-1);return Math.min(Math.max(t,.1),6)},i=o=>({x:o.x/n-e,y:o.y/n-t}),s=o=>({x:(o.x+e)*n,y:(o.y+t)*n}),a=e=>({w:e.w*n,h:e.h*n});return{move:o,canZoom:e=>n!=l(e),zoom:(e,t)=>((e,t)=>{if(n==e)return!1;const l=1-n/e;return o(-t.x*l,-t.y*l),n=e,!0})(l(e),t),worldToViewport:e=>{const{x:t,y:n}=s(e);return{x:Math.round(t),y:Math.round(n)}},worldToViewportRaw:s,worldDimToViewport:e=>{const{w:t,h:n}=a(e);return{w:Math.round(t),h:Math.round(n)}},worldDimToViewportRaw:a,viewportToWorld:e=>{const{x:t,y:n}=i(e);return{x:Math.round(t),y:Math.round(n)}},viewportToWorldRaw:i}}function an(e=0,t=0){const n=document.createElement("canvas");return n.width=e,n.height=t,n}var rn={createCanvas:an,loadImageToBitmap:async function(e){return new Promise((t=>{const n=new Image;n.onload=()=>{createImageBitmap(n).then(t)},n.src=e}))},resizeBitmap:async function(e,t,n){const o=an(t,n);return o.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,n),await createImageBitmap(o)},colorize:async function(e,t,n){const o=an(e.width,e.height),l=o.getContext("2d");return l.save(),l.drawImage(t,0,0),l.fillStyle=n,l.globalCompositeOperation="source-in",l.fillRect(0,0,t.width,t.height),l.restore(),l.save(),l.globalCompositeOperation="destination-over",l.drawImage(e,0,0),l.restore(),await createImageBitmap(o)}};const dn=pe("Debug.js");let cn=0,un=0;var pn=e=>{cn=performance.now(),un=e},hn=e=>{const t=performance.now(),n=t-cn;n>un&&dn.log(e+": "+n),cn=t};const gn=pe("PuzzleGraphics.js");function yn(e,t){const n=ge.coordByTileIdx(e,t);return{x:n.x*e.tileSize,y:n.y*e.tileSize,w:e.tileSize,h:e.tileSize}}var mn={loadPuzzleBitmaps:async function(e){const t=await rn.loadImageToBitmap(e.info.imageUrl),n=await rn.resizeBitmap(t,e.info.width,e.info.height);return await async function(e,t,n){gn.log("start createPuzzleTileBitmaps");var o=n.tileSize,l=n.tileMarginWidth,i=n.tileDrawSize,s=o/100,a=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0];const r=new Array(t.length),d={};function c(e){const t=`${e.top}${e.right}${e.left}${e.bottom}`;if(d[t])return d[t];const n=new Path2D,i={x:l,y:l},r=V.pointAdd(i,{x:o,y:0}),c=V.pointAdd(r,{x:0,y:o}),u=V.pointSub(c,{x:o,y:0});if(n.moveTo(i.x,i.y),0!==e.top)for(let o=0;o<a.length/6;o++){const t=V.pointAdd(i,{x:a[6*o+0]*s,y:e.top*a[6*o+1]*s}),l=V.pointAdd(i,{x:a[6*o+2]*s,y:e.top*a[6*o+3]*s}),r=V.pointAdd(i,{x:a[6*o+4]*s,y:e.top*a[6*o+5]*s});n.bezierCurveTo(t.x,t.y,l.x,l.y,r.x,r.y)}else n.lineTo(r.x,r.y);if(0!==e.right)for(let o=0;o<a.length/6;o++){const t=V.pointAdd(r,{x:-e.right*a[6*o+1]*s,y:a[6*o+0]*s}),l=V.pointAdd(r,{x:-e.right*a[6*o+3]*s,y:a[6*o+2]*s}),i=V.pointAdd(r,{x:-e.right*a[6*o+5]*s,y:a[6*o+4]*s});n.bezierCurveTo(t.x,t.y,l.x,l.y,i.x,i.y)}else n.lineTo(c.x,c.y);if(0!==e.bottom)for(let o=0;o<a.length/6;o++){let t=V.pointSub(c,{x:a[6*o+0]*s,y:e.bottom*a[6*o+1]*s}),l=V.pointSub(c,{x:a[6*o+2]*s,y:e.bottom*a[6*o+3]*s}),i=V.pointSub(c,{x:a[6*o+4]*s,y:e.bottom*a[6*o+5]*s});n.bezierCurveTo(t.x,t.y,l.x,l.y,i.x,i.y)}else n.lineTo(u.x,u.y);if(0!==e.left)for(let o=0;o<a.length/6;o++){let t=V.pointSub(u,{x:-e.left*a[6*o+1]*s,y:a[6*o+0]*s}),l=V.pointSub(u,{x:-e.left*a[6*o+3]*s,y:a[6*o+2]*s}),i=V.pointSub(u,{x:-e.left*a[6*o+5]*s,y:a[6*o+4]*s});n.bezierCurveTo(t.x,t.y,l.x,l.y,i.x,i.y)}else n.lineTo(i.x,i.y);return d[t]=n,n}const u=rn.createCanvas(i,i),p=u.getContext("2d"),h=rn.createCanvas(i,i),g=h.getContext("2d");for(let y of t){const t=ge.decodeTile(y),o=yn(n,t.idx),s=c(ge.decodeShape(n.shapes[t.idx]));p.clearRect(0,0,i,i),p.save(),p.lineWidth=2,p.stroke(s),p.globalCompositeOperation="source-in",p.drawImage(e,o.x-l,o.y-l,i,i,0,0,i,i),p.restore(),p.save(),p.globalCompositeOperation="source-in",p.globalAlpha=.2,p.fillStyle="black",p.fillRect(0,0,u.width,u.height),p.restore(),p.save(),p.clip(s),p.drawImage(e,o.x-l,o.y-l,i,i,0,0,i,i),p.restore(),p.save(),p.clip(s),p.strokeStyle="rgba(0,0,0,.4)",p.lineWidth=0,p.shadowColor="black",p.shadowBlur=2,p.shadowOffsetX=-1,p.shadowOffsetY=-1,p.stroke(s),p.restore(),p.save(),p.clip(s),p.strokeStyle="rgba(255,255,255,.4)",p.lineWidth=0,p.shadowColor="white",p.shadowBlur=2,p.shadowOffsetX=1,p.shadowOffsetY=1,p.stroke(s),p.restore(),g.clearRect(0,0,i,i),g.save(),g.lineWidth=1,g.stroke(s),g.globalCompositeOperation="source-in",g.drawImage(e,o.x-l,o.y-l,i,i,0,0,i,i),g.restore(),p.drawImage(h,0,0),r[t.idx]=await createImageBitmap(u)}return gn.log("end createPuzzleTileBitmaps"),r}(n,e.tiles,e.info)}};let fn=-10,wn=20,vn=2,xn=15;class bn{constructor(e){this.radius=10,this.previousRadius=10,this.explodingDuration=100,this.hasExploded=!1,this.alive=!0,this.color=function(e){return"rgba("+ge.randomInt(e,0,255)+","+ge.randomInt(e,0,255)+","+ge.randomInt(e,0,255)+", 0.8)"}(e),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=fn+Math.random()*wn,this.vy=-1*(vn+Math.random()*xn),this.duration=0}update(e){if(this.hasExploded){const e=200-this.radius;this.previousRadius=this.radius,this.radius+=e/10,this.explodingDuration--,0==this.explodingDuration&&(this.alive=!1)}else this.vx+=0,this.vy+=1,this.vy>=0&&e&&this.explode(e),this.px+=this.vx,this.py+=this.vy}draw(e){e.beginPath(),e.arc(this.px,this.py,this.previousRadius,0,2*Math.PI,!1),this.hasExploded||(e.fillStyle=this.color,e.lineWidth=1,e.fill())}explode(e){this.hasExploded=!0;const t=3+Math.floor(3*Math.random());for(let n=0;n<t;n++){const t=10+Math.floor(21*Math.random()),n=5+5*Math.random(),o=2*Math.PI/t,l=Math.random()*o;for(let i=0;i<t;i++)e.push(new An(this,i*o+l,n))}}}class An{constructor(e,t,n){this.px=e.px,this.py=e.py,this.vx=Math.cos(t)*n,this.vy=Math.sin(t)*n,this.color=e.color,this.duration=40+Math.floor(20*Math.random()),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=.1,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(e){e.beginPath(),e.arc(this.px,this.py,this.radius,0,2*Math.PI,!1),e.fillStyle=this.color,e.lineWidth=1,e.fill()}}class zn{constructor(e,t){this.canvas=e,this.rng=t,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",(()=>{this.resize()}))}setSpeedParams(){let e=0,t=0;for(;e<this.canvas.height&&t>=0;)t+=1,e+=t;vn=t/2,xn=t-vn;const n=1/4*this.canvas.width/(t/2);fn=-n,wn=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let e=0;e<1;e++)this.readyBombs.push(new bn(this.rng))}update(){100*Math.random()<5&&this.readyBombs.push(new bn(this.rng));const e=[];for(;this.explodedBombs.length>0;){const t=this.explodedBombs.shift();if(!t)break;t.update(),t.alive&&e.push(t)}this.explodedBombs=e;const t=[];for(;this.readyBombs.length>0;){const e=this.readyBombs.shift();if(!e)break;e.update(this.particles),e.hasExploded?this.explodedBombs.push(e):t.push(e)}this.readyBombs=t;const n=[];for(;this.particles.length>0;){const e=this.particles.shift();if(!e)break;e.update(),e.alive&&n.push(e)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let e=0;e<this.readyBombs.length;e++)this.readyBombs[e].draw(this.ctx);for(let e=0;e<this.explodedBombs.length;e++)this.explodedBombs[e].draw(this.ctx);for(let e=0;e<this.particles.length;e++)this.particles[e].draw(this.ctx)}}const Tn={"./grab.png":tn,"./grab_mask.png":nn,"./hand.png":on,"./hand_mask.png":ln};let Sn=!0,Cn=!0;let kn=!0;async function In(e,t,n,o,l,i){void 0===window.DEBUG&&(window.DEBUG=!1);const s=await rn.loadImageToBitmap(Tn["./grab.png"].default),a=await rn.loadImageToBitmap(Tn["./hand.png"].default),r=await rn.loadImageToBitmap(Tn["./grab_mask.png"].default),d=await rn.loadImageToBitmap(Tn["./hand_mask.png"].default),c=s.width,u=Math.round(c/2),p=s.height,h=Math.round(p/2),g={},y=async e=>{const t=e.color+" "+e.d;if(!g[t]){const n=e.d?s:a;if(e.color){const o=e.d?r:d;g[t]=await rn.colorize(n,o,e.color)}else g[t]=n}return g[t]},m=function(e,t){return t.width=window.innerWidth,t.height=window.innerHeight,e.appendChild(t),window.addEventListener("resize",(()=>{t.width=window.innerWidth,t.height=window.innerHeight,kn=!0})),t}(l,rn.createCanvas()),f={log:[],logIdx:0,speeds:[.5,1,2,5,10,20,50],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0};Ut.onConnectionStateChange((e=>{i.setConnectionState(e)}));let w=()=>0;const v=async()=>{if("play"===o){const o=await Ut.connect(n,e,t),l=ge.decodeGame(o);Ze.setGame(l.id,l),w=()=>I()}else{if("replay"!==o)throw"[ 2020-12-22 MODE invalid, must be play|replay ]";{const o=await Ut.connectReplay(n,e,t),l=ge.decodeGame(o.game);Ze.setGame(l.id,l),f.log=o.log,f.lastRealTs=I(),f.gameStartTs=parseInt(f.log[0][f.log[0].length-2],10),f.lastGameTs=f.gameStartTs,w=()=>f.lastGameTs}}kn=!0};await v();const x=Ze.getTileDrawOffset(e),b=Ze.getTileDrawSize(e),A=Ze.getPuzzleWidth(e),z=Ze.getPuzzleHeight(e),T=Ze.getTableWidth(e),S=Ze.getTableHeight(e),C={x:(T-A)/2,y:(S-z)/2},k={w:A,h:z},P={w:b,h:b},_=await mn.loadPuzzleBitmaps(Ze.getPuzzle(e)),D=new zn(m,Ze.getRng(e));D.init();const B=m.getContext("2d");m.classList.add("loaded");const O=sn();O.move(-(T-m.width)/2,-(S-m.height)/2);const E=function(e,t,n){let o=[],l=!0,i=!1,s=!1,a=!1,r=!1,d=!1,c=!1,u=!1;const p=(e,t)=>{const o=n.viewportToWorld({x:e,y:t});return[o.x,o.y]},h=e=>p(e.offsetX,e.offsetY),g=()=>p(e.width/2,e.height/2),y=(e,t)=>{l&&("Shift"===t.key?u=e:"ArrowUp"===t.key||"w"===t.key||"W"===t.key?a=e:"ArrowDown"===t.key||"s"===t.key||"S"===t.key?r=e:"ArrowLeft"===t.key||"a"===t.key||"A"===t.key?i=e:"ArrowRight"===t.key||"d"===t.key||"D"===t.key?s=e:"q"===t.key?c=e:"e"===t.key&&(d=e))};e.addEventListener("mousedown",(e=>{0===e.button&&m([J,...h(e)])})),e.addEventListener("mouseup",(e=>{0===e.button&&m([X,...h(e)])})),e.addEventListener("mousemove",(e=>{m([ee,...h(e)])})),e.addEventListener("wheel",(e=>{if(n.canZoom(e.deltaY<0?"in":"out")){const t=e.deltaY<0?te:ne;m([t,...h(e)])}})),t.addEventListener("keydown",(e=>y(!0,e))),t.addEventListener("keyup",(e=>y(!1,e))),t.addEventListener("keypress",(e=>{l&&(" "===e.key&&m([se]),"F"!==e.key&&"f"!==e.key||(Sn=!Sn,kn=!0),"G"!==e.key&&"g"!==e.key||(Cn=!Cn,kn=!0))}));const m=e=>{o.push(e)};return{addEvent:m,consumeAll:()=>{if(0===o.length)return[];const e=o.slice();return o=[],e},createKeyEvents:()=>{const e=u?20:10,t=(i?e:0)-(s?e:0),o=(a?e:0)-(r?e:0);0===t&&0===o||m([K,t,o]),d&&c||(d?n.canZoom("in")&&m([te,...g()]):c&&n.canZoom("out")&&m([ne,...g()]))},setHotkeys:e=>{l=e}}}(m,window,O),M=Ze.getImageUrl(e),N=()=>{const t=Ze.getStartTs(e),n=Ze.getFinishTs(e),o=w();i.setFinished(!!n),i.setDuration((n||o)-t)};N(),i.setPiecesDone(Ze.getFinishedTileCount(e)),i.setPiecesTotal(Ze.getTileCount(e));const U=w();i.setActivePlayers(Ze.getActivePlayers(e,U)),i.setIdlePlayers(Ze.getIdlePlayers(e,U));const R=!!Ze.getFinishTs(e);let $=R;const G=()=>$&&!R,V=()=>Ze.getPlayerBgColor(e,t)||localStorage.getItem("bg_color")||"#222222",j=()=>{i.setReplaySpeed&&i.setReplaySpeed(f.speeds[f.speedIdx]),i.setReplayPaused&&i.setReplayPaused(f.paused)};if("play"===o?setInterval(N,1e3):"replay"===o&&j(),"play"===o)Ut.onServerChange((n=>{n[0],n[1],n[2];const o=n[3];for(const[l,i]of o)switch(l){case de:{const n=ge.decodePlayer(i);n.id!==t&&(Ze.setPlayer(e,n.id,n),kn=!0)}break;case re:{const t=ge.decodeTile(i);Ze.setTile(e,t.idx,t),kn=!0}break;case ae:Ze.setPuzzleData(e,i),kn=!0}$=!!Ze.getFinishTs(e)}));else if("replay"===o){let t=setInterval((()=>{const n=I();if(f.paused)return void(f.lastRealTs=n);const o=(n-f.lastRealTs)*f.speeds[f.speedIdx],l=f.lastGameTs+o;for(;;){if(f.paused)break;const n=f.logIdx+1;if(n>=f.log.length){clearInterval(t);break}const o=f.log[n],i=f.gameStartTs+o[o.length-1];if(i>l)break;const s=o.slice();if(s[0]===Y){const t=s[1];Ze.addPlayer(e,t,i),kn=!0}else if(s[0]===q){const t=Ze.getPlayerIdByIndex(e,s[1]);Ze.addPlayer(e,t,i),kn=!0}else if(s[0]===Z){const t=Ze.getPlayerIdByIndex(e,s[1]),n=s[2];Ze.handleInput(e,t,n,i),kn=!0}f.logIdx=n}f.lastRealTs=n,f.lastGameTs=l,N()}),50)}let W=null;return(e=>{const t=e.fps||60,n=e.slow||1,o=e.update,l=e.render,i=window.requestAnimationFrame,s=1/t,a=n*s;let r,d=0,c=window.performance.now();const u=()=>{for(r=window.performance.now(),d+=Math.min(1,(r-c)/1e3);d>a;)d-=a,o(s);l(d/n),c=r,i(u)};i(u)})({update:()=>{E.createKeyEvents();for(const n of E.consumeAll())if("play"===o){const o=n[0];if(o===K){const e=n[1],t=n[2];kn=!0,O.move(e,t)}else if(o===ee){if(W&&!Ze.getFirstOwnedTile(e,t)){const e={x:n[1],y:n[2]},t=O.worldToViewport(e),o=Math.round(t.x-W.x),l=Math.round(t.y-W.y);kn=!0,O.move(o,l),W=t}}else if(o===J){const e={x:n[1],y:n[2]};W=O.worldToViewport(e)}else if(o===X)W=null;else if(o===te){const e={x:n[1],y:n[2]};kn=!0,O.zoom("in",O.worldToViewport(e))}else if(o===ne){const e={x:n[1],y:n[2]};kn=!0,O.zoom("out",O.worldToViewport(e))}else o===se&&i.togglePreview();const l=w();Ze.handleInput(e,t,n,l).length>0&&(kn=!0),Ut.sendClientEvent(n)}else if("replay"===o){const e=n[0];if(e===K){const e=n[1],t=n[2];kn=!0,O.move(e,t)}else if(e===ee){if(W){const e={x:n[1],y:n[2]},t=O.worldToViewport(e),o=Math.round(t.x-W.x),l=Math.round(t.y-W.y);kn=!0,O.move(o,l),W=t}}else if(e===J){const e={x:n[1],y:n[2]};W=O.worldToViewport(e)}else if(e===X)W=null;else if(e===te){const e={x:n[1],y:n[2]};kn=!0,O.zoom("in",O.worldToViewport(e))}else if(e===ne){const e={x:n[1],y:n[2]};kn=!0,O.zoom("out",O.worldToViewport(e))}else e===se&&i.togglePreview()}$=!!Ze.getFinishTs(e),G()&&(D.update(),kn=!0)},render:async()=>{if(!kn)return;const n=w();let l,s,a;window.DEBUG&&pn(0),B.fillStyle=V(),B.fillRect(0,0,m.width,m.height),window.DEBUG&&hn("clear done"),l=O.worldToViewportRaw(C),s=O.worldDimToViewportRaw(k),B.fillStyle="rgba(255, 255, 255, .3)",B.fillRect(l.x,l.y,s.w,s.h),window.DEBUG&&hn("board done");const r=Ze.getTilesSortedByZIndex(e);window.DEBUG&&hn("get tiles done"),s=O.worldDimToViewportRaw(P);for(const e of r)(-1===e.owner?Sn:Cn)&&(a=_[e.idx],l=O.worldToViewportRaw({x:x+e.pos.x,y:x+e.pos.y}),B.drawImage(a,0,0,a.width,a.height,l.x,l.y,s.w,s.h));window.DEBUG&&hn("tiles done");const d=[];for(const i of Ze.getActivePlayers(e,n))a=await y(i),l=O.worldToViewport(i),B.drawImage(a,l.x-u,l.y-h),c=i,("replay"===o||c.id!==t)&&d.push([`${i.name} (${i.points})`,l.x,l.y+p]);var c;B.fillStyle="white",B.textAlign="center";for(const[e,t,o]of d)B.fillText(e,t,o);window.DEBUG&&hn("players done"),i.setActivePlayers(Ze.getActivePlayers(e,n)),i.setIdlePlayers(Ze.getIdlePlayers(e,n)),i.setPiecesDone(Ze.getFinishedTileCount(e)),window.DEBUG&&hn("HUD done"),G()&&D.render(),kn=!1}}),{setHotkeys:e=>{E.setHotkeys(e)},onBgChange:e=>{localStorage.setItem("bg_color",e),E.addEvent([oe,e])},onColorChange:e=>{localStorage.setItem("player_color",e),E.addEvent([le,e])},onNameChange:e=>{localStorage.setItem("player_name",e),E.addEvent([ie,e])},replayOnSpeedUp:()=>{f.speedIdx+1<f.speeds.length&&(f.speedIdx++,j())},replayOnSpeedDown:()=>{f.speedIdx>=1&&(f.speedIdx--,j())},replayOnPauseToggle:()=>{f.paused=!f.paused,j()},previewImageUrl:M,player:{background:V(),color:Ze.getPlayerColor(e,t)||localStorage.getItem("player_color")||"#ffffff",name:Ze.getPlayerName(e,t)||localStorage.getItem("player_name")||"anon"},disconnect:Ut.disconnect,connect:v}}var Pn=e({name:"game",components:{PuzzleStatus:xt,Scores:yt,SettingsOverlay:At,PreviewOverlay:Ct,ConnectionOverlay:Rt,HelpOverlay:Ft},data:()=>({activePlayers:[],idlePlayers:[],finished:!1,duration:0,piecesDone:0,piecesTotal:0,overlay:"",connectionState:0,g:{player:{background:"",color:"",name:""},previewImageUrl:"",setHotkeys:e=>{},onBgChange:e=>{},onColorChange:e=>{},onNameChange:e=>{},disconnect:()=>{},connect:()=>{}}}),async mounted(){this.$route.params.id&&(this.$watch((()=>this.g.player.background),(e=>{this.g.onBgChange(e)})),this.$watch((()=>this.g.player.color),(e=>{this.g.onColorChange(e)})),this.$watch((()=>this.g.player.name),(e=>{this.g.onNameChange(e)})),this.g=await In(`${this.$route.params.id}`,this.$clientId,this.$config.WS_ADDRESS,"play",this.$el,{setActivePlayers:e=>{this.activePlayers=e},setIdlePlayers:e=>{this.idlePlayers=e},setFinished:e=>{this.finished=e},setDuration:e=>{this.duration=e},setPiecesDone:e=>{this.piecesDone=e},setPiecesTotal:e=>{this.piecesTotal=e},setConnectionState:e=>{this.connectionState=e},togglePreview:()=>{this.toggle("preview",!1)}}))},unmounted(){this.g.disconnect()},methods:{reconnect(){this.g.connect()},toggle(e,t){""===this.overlay?(this.overlay=e,t&&this.g.setHotkeys(!1)):(this.overlay="",t&&this.g.setHotkeys(!0))}}});const _n={id:"game"},Dn={class:"menu"},Bn={class:"tabs"},On=a("🧩 Puzzles");Pn.render=function(e,l,a,r,d,c){const p=i("settings-overlay"),h=i("preview-overlay"),g=i("help-overlay"),y=i("connection-overlay"),f=i("puzzle-status"),w=i("router-link"),v=i("scores");return s(),t("div",_n,[u(n(p,{onBgclick:l[1]||(l[1]=t=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":l[2]||(l[2]=t=>e.g.player=t)},null,8,["modelValue"]),[[m,"settings"===e.overlay]]),u(n(h,{onBgclick:l[3]||(l[3]=t=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[m,"preview"===e.overlay]]),u(n(g,{onBgclick:l[4]||(l[4]=t=>e.toggle("help",!0))},null,512),[[m,"help"===e.overlay]]),n(y,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),n(f,{finished:e.finished,duration:e.duration,piecesDone:e.piecesDone,piecesTotal:e.piecesTotal},null,8,["finished","duration","piecesDone","piecesTotal"]),n("div",Dn,[n("div",Bn,[n(w,{class:"opener",to:{name:"index"},target:"_blank"},{default:o((()=>[On])),_:1}),n("div",{class:"opener",onClick:l[5]||(l[5]=t=>e.toggle("preview",!1))},"🖼️ Preview"),n("div",{class:"opener",onClick:l[6]||(l[6]=t=>e.toggle("settings",!0))},"🛠️ Settings"),n("div",{class:"opener",onClick:l[7]||(l[7]=t=>e.toggle("help",!0))},"ℹ️ Help")])]),n(v,{activePlayers:e.activePlayers,idlePlayers:e.idlePlayers},null,8,["activePlayers","idlePlayers"])])};var En=e({name:"replay",components:{PuzzleStatus:xt,Scores:yt,SettingsOverlay:At,PreviewOverlay:Ct,HelpOverlay:Ft},data:()=>({activePlayers:[],idlePlayers:[],finished:!1,duration:0,piecesDone:0,piecesTotal:0,overlay:"",connectionState:0,g:{player:{background:"",color:"",name:""},previewImageUrl:"",setHotkeys:e=>{},onBgChange:e=>{},onColorChange:e=>{},onNameChange:e=>{},replayOnSpeedUp:()=>{},replayOnSpeedDown:()=>{},replayOnPauseToggle:()=>{},disconnect:()=>{}},replay:{speed:1,paused:!1}}),async mounted(){this.$route.params.id&&(this.$watch((()=>this.g.player.background),(e=>{this.g.onBgChange(e)})),this.$watch((()=>this.g.player.color),(e=>{this.g.onColorChange(e)})),this.$watch((()=>this.g.player.name),(e=>{this.g.onNameChange(e)})),this.g=await In(`${this.$route.params.id}`,this.$clientId,this.$config.WS_ADDRESS,"replay",this.$el,{setActivePlayers:e=>{this.activePlayers=e},setIdlePlayers:e=>{this.idlePlayers=e},setFinished:e=>{this.finished=e},setDuration:e=>{this.duration=e},setPiecesDone:e=>{this.piecesDone=e},setPiecesTotal:e=>{this.piecesTotal=e},togglePreview:()=>{this.toggle("preview",!1)},setConnectionState:e=>{this.connectionState=e},setReplaySpeed:e=>{this.replay.speed=e},setReplayPaused:e=>{this.replay.paused=e}}))},unmounted(){this.g.disconnect()},methods:{toggle(e,t){""===this.overlay?(this.overlay=e,t&&this.g.setHotkeys(!1)):(this.overlay="",t&&this.g.setHotkeys(!0))}},computed:{replayText(){return"Replay-Speed: "+this.replay.speed+"x"+(this.replay.paused?" Paused":"")}}});const Mn={id:"replay"},Nn={class:"menu"},Un={class:"tabs"},Rn=a("🧩 Puzzles");En.render=function(e,l,a,d,c,p){const h=i("settings-overlay"),g=i("preview-overlay"),y=i("help-overlay"),f=i("puzzle-status"),w=i("router-link"),v=i("scores");return s(),t("div",Mn,[u(n(h,{onBgclick:l[1]||(l[1]=t=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":l[2]||(l[2]=t=>e.g.player=t)},null,8,["modelValue"]),[[m,"settings"===e.overlay]]),u(n(g,{onBgclick:l[3]||(l[3]=t=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[m,"preview"===e.overlay]]),u(n(y,{onBgclick:l[4]||(l[4]=t=>e.toggle("help",!0))},null,512),[[m,"help"===e.overlay]]),n(f,{finished:e.finished,duration:e.duration,piecesDone:e.piecesDone,piecesTotal:e.piecesTotal},{default:o((()=>[n("div",null,[n("div",null,r(e.replayText),1),n("button",{class:"btn",onClick:l[5]||(l[5]=t=>e.g.replayOnSpeedUp())},"⏫"),n("button",{class:"btn",onClick:l[6]||(l[6]=t=>e.g.replayOnSpeedDown())},"⏬"),n("button",{class:"btn",onClick:l[7]||(l[7]=t=>e.g.replayOnPauseToggle())},"⏸️")])])),_:1},8,["finished","duration","piecesDone","piecesTotal"]),n("div",Nn,[n("div",Un,[n(w,{class:"opener",to:{name:"index"},target:"_blank"},{default:o((()=>[Rn])),_:1}),n("div",{class:"opener",onClick:l[8]||(l[8]=t=>e.toggle("preview",!1))},"🖼️ Preview"),n("div",{class:"opener",onClick:l[9]||(l[9]=t=>e.toggle("settings",!0))},"🛠️ Settings"),n("div",{class:"opener",onClick:l[10]||(l[10]=t=>e.toggle("help",!0))},"ℹ️ Help")])]),n(v,{activePlayers:e.activePlayers,idlePlayers:e.idlePlayers},null,8,["activePlayers","idlePlayers"])])},(async()=>{const e=await fetch("/api/conf"),t=await e.json();const n=f({history:w(),routes:[{name:"index",path:"/",component:N},{name:"new-game",path:"/new-game",component:gt},{name:"game",path:"/g/:id",component:Pn},{name:"replay",path:"/replay/:id",component:En}]});n.beforeEach(((e,t)=>{t.name&&document.documentElement.classList.remove(`view-${String(t.name)}`),document.documentElement.classList.add(`view-${String(e.name)}`)}));const o=v(x);o.config.globalProperties.$config=t,o.config.globalProperties.$clientId=function(){let e=localStorage.getItem("ID");return e||(e=ge.uniqId(),localStorage.setItem("ID",e)),e}(),o.use(n),o.mount("#app")})();
