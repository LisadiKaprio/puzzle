import{d as Q,r as U,o as m,c as P,a as n,b as F,w as ne,e as ee,f as k,g as ae,n as Re,t as I,F as re,h as ye,i as Fe,j as L,v as be,k as Ge,l as Se,m as cn,p as ue,q as dn,s as pn,u as go,x as hn,y as gn,z as mn,A as fn,B as yn,C as _n}from"./vendor.7581c8fd.js";const En=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}};En();var j=(e,t)=>{const o=e.__vccOpts||e;for(const[s,i]of t)o[s]=i;return o};const vn=Q({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),wn={id:"app"},Pn={key:0,class:"nav"},Cn=k("Games overview"),bn=k("New game");function Sn(e,t,o,s,i,l){const r=U("router-link"),u=U("router-view");return m(),P("div",wn,[e.showNav?(m(),P("ul",Pn,[n("li",null,[F(r,{class:"btn",to:{name:"index"}},{default:ne(()=>[Cn]),_:1})]),n("li",null,[F(r,{class:"btn",to:{name:"new-game"}},{default:ne(()=>[bn]),_:1})])])):ee("",!0),F(u)])}var Tn=j(vn,[["render",Sn]]);class Qe{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,o){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const s=(this.rand_high>>>0)/4294967295;return t+s*(o-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const o=t.slice();for(let s=0;s<=o.length-2;s++){const i=this.random(s,o.length-1),l=o[s];o[s]=o[i],o[i]=l}return o}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const o=new Qe(0);return o.rand_high=t.rand_high,o.rand_low=t.rand_low,o}}const $n=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},yt=(e,t)=>{const o=`${e}`;return o.length>=t.length?o:t.substr(0,t.length-o.length)+o},_t=(...e)=>{const t=o=>(...s)=>{const i=new Date,l=yt(i.getHours(),"00"),r=yt(i.getMinutes(),"00"),u=yt(i.getSeconds(),"00");console[o](`${l}:${r}:${u}`,...e,...s)};return{log:t("log"),error:t("error"),info:t("info")}},An=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function On(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Nn(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function kn(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function Un(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function Rn(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function Vn(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function Ln(e){return[e.id,e.rng.type||"",Qe.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion,e.private]}function zn(e){return{id:e[0],rng:{type:e[1],obj:Qe.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10],private:e[11]}}function Mn(e,t){const o=e.width/e.tileSize;return{x:t%o,y:Math.floor(t/o)}}const Dn=e=>{let t=0;for(let o=0;o<e.length;o++){const s=e.charCodeAt(o);t=(t<<5)-t+s,t|=0}return t};function Fn(e){const t=[];for(const o in e){const s=[o,e[o]].map(encodeURIComponent);t.push(s.join("="))}return t.length===0?"":`?${t.join("&")}`}var D={hash:Dn,slug:$n,uniqId:An,encodeShape:On,decodeShape:Nn,encodePiece:kn,decodePiece:Un,encodePlayer:Rn,decodePlayer:Vn,encodeGame:Ln,decodeGame:zn,coordByPieceIdx:Mn,asQueryArgs:Fn};const se={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",OTHER_PLAYER_CLICK_SOUND_ENABLED:"other_player_click_sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},ge={SOUND_VOLUME:100,SOUND_ENABLED:!0,OTHER_PLAYER_CLICK_SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},mo=()=>({background:"",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0}),Et=(e,t)=>{localStorage.setItem(e,t)},vt=e=>localStorage.getItem(e),Gn=(e,t)=>{Et(e,`${t}`)},In=(e,t)=>{const o=vt(e);if(o===null)return t;const s=parseInt(o,10);return isNaN(s)?t:s},Bn=(e,t)=>{Et(e,t?"1":"0")},Yn=(e,t)=>{const o=vt(e);return o===null?t:o==="1"},xn=(e,t)=>{Et(e,t)},Wn=(e,t)=>{const o=vt(e);return o===null?t:o};var te={setInt:Gn,getInt:In,setBool:Bn,getBool:Yn,setStr:xn,getStr:Wn};let wt="",fo="";const Pt=async(e,t,o)=>new Promise((s,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const r in o.headers||{})l.setRequestHeader(r,o.headers[r]);l.setRequestHeader("Client-Id",wt),l.setRequestHeader("Client-Secret",fo),l.addEventListener("load",function(r){s({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(r){i(new Error("xhr error"))}),l.upload&&o.onUploadProgress&&l.upload.addEventListener("progress",function(r){o.onUploadProgress&&o.onUploadProgress(r)}),l.send(o.body||null)}),yo=e=>{let t=te.getStr(e,"");return t||(t=D.uniqId(),te.setStr(e,t)),t};var ce={init:()=>{wt=yo("ID"),fo=yo("SECRET")},request:Pt,get:(e,t)=>Pt("get",e,t),post:(e,t)=>Pt("post",e,t),clientId:()=>wt};const _o=1,Ct=_o*1e3,Xe=Ct*60,Je=Xe*60,bt=Je*24,Zn=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},Eo=e=>{const t=Math.floor(e/bt);e=e%bt;const o=Math.floor(e/Je);e=e%Je;const s=Math.floor(e/Xe);e=e%Xe;const i=Math.floor(e/Ct);return`${t}d ${o}h ${s}m ${i}s`},Hn=(e,t)=>Eo(t-e);var _e={MS:_o,SEC:Ct,MIN:Xe,HOUR:Je,DAY:bt,timestamp:Zn,timeDiffStr:Hn,durationStr:Eo};const jn=Q({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const o=t?"\u{1F3C1}":"\u23F3",s=e,i=t||_e.timestamp(),l=_e.timeDiffStr(s,i);return`${o} ${l}`}}}),Kn={class:"game-info-text"},qn=n("br",null,null,-1),Qn=n("br",null,null,-1),Xn=n("br",null,null,-1),Jn=k(" \u21AA\uFE0F Watch replay ");function es(e,t,o,s,i,l){const r=U("router-link");return m(),P("div",{class:"game-teaser",style:Re(e.style)},[F(r,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:ne(()=>[n("span",Kn,[k(" \u{1F9E9} "+I(e.game.tilesFinished)+"/"+I(e.game.tilesTotal),1),qn,k(" \u{1F465} "+I(e.game.players),1),Qn,k(" "+I(e.time(e.game.started,e.game.finished)),1),Xn])]),_:1},8,["to"]),e.game.hasReplay?(m(),ae(r,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:ne(()=>[Jn]),_:1},8,["to"])):ee("",!0)],4)}var vo=j(jn,[["render",es]]);const ts=Q({components:{GameTeaser:vo},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ce.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),os=n("h1",null,"Running games",-1),ns=n("h1",null,"Finished games",-1);function ss(e,t,o,s,i,l){const r=U("game-teaser");return m(),P("div",null,[os,(m(!0),P(re,null,ye(e.gamesRunning,(u,f)=>(m(),P("div",{class:"game-teaser-wrap",key:f},[F(r,{game:u},null,8,["game"])]))),128)),ns,(m(!0),P(re,null,ye(e.gamesFinished,(u,f)=>(m(),P("div",{class:"game-teaser-wrap",key:f},[F(r,{game:u},null,8,["game"])]))),128))])}var is=j(ts,[["render",ss]]);const ls=Q({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function rs(e,t,o,s,i,l){const r=U("image-teaser");return m(),P("div",null,[(m(!0),P(re,null,ye(e.images,(u,f)=>(m(),ae(r,{image:u,onClick:E=>e.imageClicked(u),onEditClick:E=>e.imageEditClicked(u),key:f},null,8,["image","onClick","onEditClick"]))),128))])}var wo=j(ls,[["render",rs]]);const as=Q({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],isPrivate:!1,droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.isPrivate=!1,this.droppable=!1},imageFromDragEvt(e){var s;const t=(s=e.dataTransfer)==null?void 0:s.items;if(!t||t.length===0)return null;const o=t[0];return o.type.startsWith("image/")?o:null},onFileSelect(e){const t=e.target;if(!t.files)return;const o=t.files[0];!o||this.preview(o)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=o=>{this.previewUrl=o.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const o=t.getAsFile();return o&&(this.file=o,this.preview(o),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),us=n("div",{class:"drop-target"},null,-1),cs={key:0,class:"has-image"},ds={key:1},ps={class:"upload"},hs=n("span",{class:"btn"},"Upload File",-1),gs={class:"area-settings"},ms=n("td",null,[n("label",null,"Title")],-1),fs=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),ys=n("td",null,[n("label",null,"Private Image")],-1),_s=n("td",null,[n("label",null,"Tags")],-1),Es={class:"area-buttons"},vs=["disabled"],ws=k("\u{1F5BC}\uFE0F Post to gallery"),Ps=["disabled"],Cs=k("\u{1F9E9} Set up game"),bs=k("\u{1F9E9} Post to gallery "),Ss=n("br",null,null,-1),Ts=k(" + set up game");function $s(e,t,o,s,i,l){const r=U("responsive-image"),u=U("tags-input"),f=U("overlay");return m(),ae(f,{class:"new-image-dialog"},{default:ne(()=>[n("div",{class:Fe(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...E)=>e.onDrop&&e.onDrop(...E)),onDragover:t[3]||(t[3]=(...E)=>e.onDragover&&e.onDragover(...E)),onDragleave:t[4]||(t[4]=(...E)=>e.onDragleave&&e.onDragleave(...E))},[us,e.previewUrl?(m(),P("div",cs,[n("span",{class:"remove btn",onClick:t[0]||(t[0]=E=>e.previewUrl="")},"X"),F(r,{src:e.previewUrl},null,8,["src"])])):(m(),P("div",ds,[n("label",ps,[n("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...E)=>e.onFileSelect&&e.onFileSelect(...E)),accept:"image/*"},null,32),hs])]))],34),n("div",gs,[n("table",null,[n("tr",null,[ms,n("td",null,[L(n("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=E=>e.title=E),placeholder:"Flower by @artist"},null,512),[[be,e.title]])])]),fs,n("tr",null,[ys,n("td",null,[L(n("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=E=>e.isPrivate=E)},null,512),[[Ge,e.isPrivate]])])]),n("tr",null,[_s,n("td",null,[F(u,{modelValue:e.tags,"onUpdate:modelValue":t[7]||(t[7]=E=>e.tags=E),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),n("div",Es,[e.isPrivate?ee("",!0):(m(),P("button",{key:0,class:"btn",disabled:!e.canPostToGallery,onClick:t[8]||(t[8]=(...E)=>e.postToGallery&&e.postToGallery(...E))},[e.uploading==="postToGallery"?(m(),P(re,{key:0},[k("Uploading ("+I(e.uploadProgressPercent)+"%)",1)],64)):(m(),P(re,{key:1},[ws],64))],8,vs)),n("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[9]||(t[9]=(...E)=>e.setupGameClick&&e.setupGameClick(...E))},[e.uploading==="setupGame"?(m(),P(re,{key:0},[k("Uploading ("+I(e.uploadProgressPercent)+"%)",1)],64)):e.isPrivate?(m(),P(re,{key:1},[Cs],64)):(m(),P(re,{key:2},[bs,Ss,Ts],64))],8,Ps)])]),_:1})}var Po=j(as,[["render",$s]]);const As=Q({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),Os={class:"area-image"},Ns={class:"has-image"},ks={class:"area-settings"},Us=n("td",null,[n("label",null,"Title")],-1),Rs=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Vs=n("td",null,[n("label",null,"Tags")],-1),Ls={class:"area-buttons"};function zs(e,t,o,s,i,l){const r=U("responsive-image"),u=U("tags-input"),f=U("overlay");return m(),ae(f,{class:"edit-image-dialog"},{default:ne(()=>[n("div",Os,[n("div",Ns,[F(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),n("div",ks,[n("table",null,[n("tr",null,[Us,n("td",null,[L(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=E=>e.title=E),placeholder:"Flower by @artist"},null,512),[[be,e.title]])])]),Rs,n("tr",null,[Vs,n("td",null,[F(u,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=E=>e.tags=E),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),n("div",Ls,[n("button",{class:"btn",onClick:t[2]||(t[2]=(...E)=>e.saveImage&&e.saveImage(...E))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var Co=j(As,[["render",zs]]),bo;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(bo||(bo={}));var we;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(we||(we={}));var Ve;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(Ve||(Ve={}));var Te;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(Te||(Te={}));const Ms=Q({props:{image:{type:Object,required:!0},forcePrivate:{type:Boolean,default:!1}},emits:{newGame:null},data(){return{tiles:1e3,isPrivate:!1,scoreMode:we.ANY,shapeMode:Ve.NORMAL,snapMode:Te.NORMAL}},mounted(){this.isPrivate=this.forcePrivate},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,private:this.isPrivate,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Ds={class:"area-image"},Fs={class:"has-image"},Gs={key:0,class:"image-title"},Is={key:0,class:"image-title-title"},Bs={key:1,class:"image-title-dim"},Ys={class:"area-settings"},xs=n("td",null,[n("label",null,"Pieces")],-1),Ws=n("td",null,[n("label",null,"Scoring: ")],-1),Zs=k(" Any (Score when pieces are connected to each other or on final location)"),Hs=n("br",null,null,-1),js=k(" Final (Score when pieces are put to their final location)"),Ks=n("td",null,[n("label",null,"Shapes: ")],-1),qs=k(" Normal"),Qs=n("br",null,null,-1),Xs=k(" Any (Flat pieces can occur anywhere)"),Js=n("br",null,null,-1),ei=k(" Flat (All pieces flat on all sides)"),ti=n("td",null,[n("label",null,"Snapping: ")],-1),oi=k(" Normal (Pieces snap to final destination and to each other)"),ni=n("br",null,null,-1),si=k(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),ii=n("td",null,[n("label",null,"Private Game")],-1),li=["disabled"],ri={key:0},ai=n("td",null,[n("label",null,"Tags: ")],-1),ui={class:"area-buttons"},ci=["disabled"];function di(e,t,o,s,i,l){const r=U("responsive-image"),u=U("overlay");return m(),ae(u,{class:"new-game-dialog"},{default:ne(()=>[n("div",Ds,[n("div",Fs,[F(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(m(),P("div",Gs,[e.image.title?(m(),P("span",Is,'"'+I(e.image.title)+'"',1)):ee("",!0),e.image.width||e.image.height?(m(),P("span",Bs,"("+I(e.image.width)+" \u2715 "+I(e.image.height)+")",1)):ee("",!0)])):ee("",!0)]),n("div",Ys,[n("table",null,[n("tr",null,[xs,n("td",null,[L(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=f=>e.tiles=f)},null,512),[[be,e.tiles]])])]),n("tr",null,[Ws,n("td",null,[n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=f=>e.scoreMode=f),value:"1"},null,512),[[Se,e.scoreMode]]),Zs]),Hs,n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=f=>e.scoreMode=f),value:"0"},null,512),[[Se,e.scoreMode]]),js])])]),n("tr",null,[Ks,n("td",null,[n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=f=>e.shapeMode=f),value:"0"},null,512),[[Se,e.shapeMode]]),qs]),Qs,n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=f=>e.shapeMode=f),value:"1"},null,512),[[Se,e.shapeMode]]),Xs]),Js,n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=f=>e.shapeMode=f),value:"2"},null,512),[[Se,e.shapeMode]]),ei])])]),n("tr",null,[ti,n("td",null,[n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=f=>e.snapMode=f),value:"0"},null,512),[[Se,e.snapMode]]),oi]),ni,n("label",null,[L(n("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=f=>e.snapMode=f),value:"1"},null,512),[[Se,e.snapMode]]),si])])]),n("tr",null,[ii,n("td",null,[L(n("input",{disabled:e.forcePrivate,type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=f=>e.isPrivate=f)},null,8,li),[[Ge,e.isPrivate]])])]),e.image.tags.length?(m(),P("tr",ri,[ai,n("td",null,[(m(!0),P(re,null,ye(e.image.tags,(f,E)=>(m(),P("span",{key:E,class:"bit"},I(f.title),1))),128))])])):ee("",!0)])]),n("div",ui,[n("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[9]||(t[9]=(...f)=>e.onNewGameClick&&e.onNewGameClick(...f))}," \u{1F9E9} Generate Puzzle ",8,ci)])]),_:1})}var So=j(Ms,[["render",di]]);const pi=Q({components:{ImageLibrary:wo,NewImageDialog:Po,EditImageDialog:Co,NewGameDialog:So},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",newGameForcePrivate:!1,uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(o=>!t.includes(o.title)&&o.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(o=>o.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ce.get(`/api/newgame-data${D.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.newGameForcePrivate=!1,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags),t.append("private",e.isPrivate);const o=await ce.post("/api/upload",{body:t,onUploadProgress:s=>{this.uploadProgress=s.loaded/s.total}});return this.uploadProgress=1,await o.json()},async saveImage(e){return await(await ce.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.newGameForcePrivate=e.isPrivate,this.dialog="new-game"},async onNewGame(e){const t=await ce.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const o=await t.json();this.$router.push({name:"game",params:{id:o.id}})}}}}),hi={class:"upload-image-teaser"},gi=n("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),mi={key:0},fi=k(" Tags: "),yi=["onClick"],_i=k(" Sort by: "),Ei=n("option",{value:"date_desc"},"Newest first",-1),vi=n("option",{value:"date_asc"},"Oldest first",-1),wi=n("option",{value:"alpha_asc"},"A-Z",-1),Pi=n("option",{value:"alpha_desc"},"Z-A",-1),Ci=[Ei,vi,wi,Pi];function bi(e,t,o,s,i,l){const r=U("image-library"),u=U("new-image-dialog"),f=U("edit-image-dialog"),E=U("new-game-dialog");return m(),P("div",null,[n("div",hi,[n("div",{class:"btn btn-big",onClick:t[0]||(t[0]=S=>e.dialog="new-image")},"Upload your image"),gi]),n("div",null,[e.tags.length>0?(m(),P("label",mi,[fi,(m(!0),P(re,null,ye(e.relevantTags,(S,B)=>(m(),P("span",{class:Fe(["bit is-clickable",{on:e.filters.tags.includes(S.slug)}]),key:B,onClick:y=>e.toggleTag(S)},I(S.title)+" ("+I(S.total)+")",11,yi))),128))])):ee("",!0),n("label",null,[_i,L(n("select",{"onUpdate:modelValue":t[1]||(t[1]=S=>e.filters.sort=S),onChange:t[2]||(t[2]=(...S)=>e.filtersChanged&&e.filtersChanged(...S))},Ci,544),[[cn,e.filters.sort]])])]),F(r,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),L(F(u,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=S=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[ue,e.dialog==="new-image"]]),L(F(f,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=S=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[ue,e.dialog==="edit-image"]]),e.image&&e.dialog==="new-game"?(m(),ae(E,{key:0,onBgclick:t[5]||(t[5]=S=>e.dialog=""),onNewGame:e.onNewGame,image:e.image,forcePrivate:e.newGameForcePrivate},null,8,["onNewGame","image","forcePrivate"])):ee("",!0)])}var Si=j(pi,[["render",bi]]);const Ti=Q({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),$i={class:"scores"},Ai=n("div",null,"Scores",-1),Oi=n("td",null,"\u26A1",-1),Ni=n("td",null,"\u{1F4A4}",-1);function ki(e,t,o,s,i,l){return m(),P("div",$i,[Ai,n("table",null,[(m(!0),P(re,null,ye(e.actives,(r,u)=>(m(),P("tr",{key:u,style:Re({color:r.color})},[Oi,n("td",null,I(r.name),1),n("td",null,I(r.points),1)],4))),128)),(m(!0),P(re,null,ye(e.idles,(r,u)=>(m(),P("tr",{key:u,style:Re({color:r.color})},[Ni,n("td",null,I(r.name),1),n("td",null,I(r.points),1)],4))),128))])])}var St=j(Ti,[["render",ki]]);const Ui=Q({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return _e.durationStr(this.status.duration)}}}),Ri={class:"puzzle-status"};function Vi(e,t,o,s,i,l){return m(),P("div",Ri,[n("div",null," \u{1F9E9} "+I(e.status.piecesDone)+"/"+I(e.status.piecesTotal),1),n("div",null,I(e.icon)+" "+I(e.durationStr),1)])}var Tt=j(Ui,[["render",Vi]]);const Li=Q({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.otherPlayerClickSoundEnabled=!!e.otherPlayerClickSoundEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,otherPlayerClickSoundEnabled:this.otherPlayerClickSoundEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch(()=>this.background,this.emitChanges)),this.watches.push(this.$watch(()=>this.color,this.emitChanges)),this.watches.push(this.$watch(()=>this.name,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.otherPlayerClickSoundEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsVolume,this.emitChanges)),this.watches.push(this.$watch(()=>this.showPlayerNames,this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue),this.$watch(()=>this.modelValue,e=>{this.apply(e)},{deep:!0})}}),$e=e=>(dn("data-v-2d20a1a6"),e=e(),pn(),e),zi={class:"settings"},Mi=$e(()=>n("td",null,[n("label",null,"Background: ")],-1)),Di=$e(()=>n("td",null,[n("label",null,"Color: ")],-1)),Fi=$e(()=>n("td",null,[n("label",null,"Name: ")],-1)),Gi=$e(()=>n("td",null,[n("label",null,"Sounds: ")],-1)),Ii=$e(()=>n("td",null,[n("label",null,"Piece connect sounds of others: ")],-1)),Bi=["disabled"],Yi=$e(()=>n("td",null,[n("label",null,"Sounds Volume: ")],-1)),xi={class:"sound-volume"},Wi=["disabled","value"],Zi=$e(()=>n("td",null,[n("label",null,"Show player names: ")],-1));function Hi(e,t,o,s,i,l){const r=U("overlay");return m(),ae(r,{class:"transparent"},{default:ne(()=>[n("table",zi,[n("tr",null,[Mi,n("td",null,[L(n("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=u=>e.background=u)},null,512),[[be,e.background]])])]),n("tr",null,[Di,n("td",null,[L(n("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=u=>e.color=u)},null,512),[[be,e.color]])])]),n("tr",null,[Fi,n("td",null,[L(n("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=u=>e.name=u)},null,512),[[be,e.name]])])]),n("tr",null,[Gi,n("td",null,[L(n("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=u=>e.soundsEnabled=u)},null,512),[[Ge,e.soundsEnabled]])])]),n("tr",null,[Ii,n("td",null,[L(n("input",{type:"checkbox",disabled:!e.soundsEnabled,"onUpdate:modelValue":t[4]||(t[4]=u=>e.otherPlayerClickSoundEnabled=u)},null,8,Bi),[[Ge,e.otherPlayerClickSoundEnabled]])])]),n("tr",null,[Yi,n("td",xi,[n("span",{onClick:t[5]||(t[5]=(...u)=>e.decreaseVolume&&e.decreaseVolume(...u))},"\u{1F509}"),n("input",{disabled:!e.soundsEnabled,type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[6]||(t[6]=(...u)=>e.updateVolume&&e.updateVolume(...u))},null,40,Wi),n("span",{onClick:t[7]||(t[7]=(...u)=>e.increaseVolume&&e.increaseVolume(...u))},"\u{1F50A}")])]),n("tr",null,[Zi,n("td",null,[L(n("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=u=>e.showPlayerNames=u)},null,512),[[Ge,e.showPlayerNames]])])])])]),_:1})}var $t=j(Li,[["render",Hi],["__scopeId","data-v-2d20a1a6"]]);const ji=Q({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),Ki={class:"preview"};function qi(e,t,o,s,i,l){const r=U("overlay");return m(),ae(r,{class:"preview-overlay",animate:!1},{default:ne(()=>[n("div",Ki,[n("div",{class:"img",style:Re(e.previewStyle)},null,4)])]),_:1})}var At=j(ji,[["render",qi]]);const Qi=Q({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case we.ANY:return["Any","Score when pieces are connected to each other or on final location"];case we.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ve.FLAT:return["Flat","All pieces flat on all sides"];case Ve.ANY:return["Any","Flat pieces can occur anywhere"];case Ve.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case Te.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case Te.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),Xi={class:"help"},Ji=n("tr",null,[n("td",{colspan:"2"},"Info about this puzzle")],-1),el=n("td",null,"Image Title: ",-1),tl=n("td",null,"Scoring: ",-1),ol=["title"],nl=n("td",null,"Shapes: ",-1),sl=["title"],il=n("td",null,"Snapping: ",-1),ll=["title"];function rl(e,t,o,s,i,l){const r=U("overlay");return m(),ae(r,{class:"transparent"},{default:ne(()=>[n("table",Xi,[Ji,n("tr",null,[el,n("td",null,I(e.game.puzzle.info.image.title),1)]),n("tr",null,[tl,n("td",null,[n("span",{title:e.snapMode[1]},I(e.scoreMode[0]),9,ol)])]),n("tr",null,[nl,n("td",null,[n("span",{title:e.snapMode[1]},I(e.shapeMode[0]),9,sl)])]),n("tr",null,[il,n("td",null,[n("span",{title:e.snapMode[1]},I(e.snapMode[0]),9,ll)])])])]),_:1})}var Ot=j(Qi,[["render",rl]]);const al=2,ul=1,cl=4,dl=2,pl=3,hl=1,gl=2,ml=4,fl=3,yl=1,_l=2,El=3,vl=4,wl=5,Pl=6,Cl=7,bl=8,Sl=9,Tl=10,$l=11,Al=12,Ol=13,Nl=14,kl=15,Ul=16,Rl=17,Vl=18,Ll=19,zl=20,Ml=21,Dl=1,Fl=2,Gl=3;var d={EV_SERVER_EVENT:ul,EV_SERVER_INIT:cl,EV_CLIENT_EVENT:dl,EV_CLIENT_INIT:pl,GAME_VERSION:al,LOG_HEADER:hl,LOG_ADD_PLAYER:gl,LOG_UPDATE_PLAYER:ml,LOG_HANDLE_INPUT:fl,INPUT_EV_MOVE:Sl,INPUT_EV_MOUSE_DOWN:yl,INPUT_EV_MOUSE_UP:_l,INPUT_EV_MOUSE_MOVE:El,INPUT_EV_ZOOM_IN:vl,INPUT_EV_ZOOM_OUT:wl,INPUT_EV_BG_COLOR:Pl,INPUT_EV_PLAYER_COLOR:Cl,INPUT_EV_PLAYER_NAME:bl,INPUT_EV_TOGGLE_PREVIEW:Tl,INPUT_EV_TOGGLE_SOUNDS:$l,INPUT_EV_REPLAY_TOGGLE_PAUSE:Al,INPUT_EV_REPLAY_SPEED_UP:Ol,INPUT_EV_REPLAY_SPEED_DOWN:Nl,INPUT_EV_TOGGLE_PLAYER_NAMES:kl,INPUT_EV_CENTER_FIT_PUZZLE:Ul,INPUT_EV_TOGGLE_FIXED_PIECES:Rl,INPUT_EV_TOGGLE_LOOSE_PIECES:Vl,INPUT_EV_STORE_POS:Ll,INPUT_EV_RESTORE_POS:zl,INPUT_EV_CONNECTION_CLOSE:Ml,CHANGE_DATA:Dl,CHANGE_TILE:Fl,CHANGE_PLAYER:Gl};const Il=_t("Communication.js"),Bl=1001,Nt=4e3,To=0,kt=1,Ut=2,$o=3,Ao=4;let pe,Rt=[],Vt=e=>{Rt.push(e)},Lt=[],zt=e=>{Lt.push(e)};function Yl(e){Vt=e;for(const t of Rt)Vt(t);Rt=[]}function xl(e){zt=e;for(const t of Lt)zt(t);Lt=[]}let Mt=To;const Ie=e=>{Mt!==e&&(Mt=e,zt(e))};function Oo(e){if(Mt===Ut)try{pe.send(JSON.stringify(e))}catch{Il.info("unable to send message.. maybe because ws is invalid?")}}let Le,ze,Dt=0;function No(e=2e4){pe.readyState==pe.OPEN&&pe.send(""),Dt=setTimeout(No,e)}function ko(){Dt&&clearTimeout(Dt)}function Wl(e,t,o){return Le=0,ze={},Ie($o),new Promise(s=>{pe=new WebSocket(e,o+"|"+t),pe.onopen=()=>{Ie(Ut),Oo([d.EV_CLIENT_INIT]),No()},pe.onmessage=i=>{const l=JSON.parse(i.data),r=l[0];if(r===d.EV_SERVER_INIT){const u=l[1];s(u)}else if(r===d.EV_SERVER_EVENT){const u=l[1],f=l[2];if(u===o&&ze[f]){delete ze[f];return}Vt(l)}else throw`[ 2021-05-09 invalid connect msgType ${r} ]`},pe.onerror=()=>{throw ko(),Ie(kt),"[ 2021-05-15 onerror ]"},pe.onclose=i=>{ko(),i.code===Nt||i.code===Bl?Ie(Ao):Ie(kt)}})}async function Zl(e,t){const o={gameId:e,offset:t};return await(await ce.get(`/api/replay-data${D.asQueryArgs(o)}`,{})).json()}function Hl(){pe&&pe.close(Nt),Le=0,ze={}}function jl(e){Le++,ze[Le]=e,Oo([d.EV_CLIENT_EVENT,Le,ze[Le]])}var Pe={connect:Wl,requestReplayData:Zl,disconnect:Hl,sendClientEvent:jl,onServerChange:Yl,onConnectionStateChange:xl,CODE_CUSTOM_DISCONNECT:Nt,CONN_STATE_NOT_CONNECTED:To,CONN_STATE_DISCONNECTED:kt,CONN_STATE_CLOSED:Ao,CONN_STATE_CONNECTED:Ut,CONN_STATE_CONNECTING:$o};const Kl=Q({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Pe.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Pe.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),ql={key:0},Ql={key:2};function Xl(e,t,o,s,i,l){const r=U("overlay");return L((m(),ae(r,{class:"connection-lost"},{default:ne(()=>[e.lostConnection?(m(),P("div",ql,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):ee("",!0),e.lostConnection?(m(),P("span",{key:1,class:"btn",onClick:t[0]||(t[0]=u=>e.$emit("reconnect"))},"Reconnect")):ee("",!0),e.connecting?(m(),P("div",Ql,"Connecting...")):ee("",!0)]),_:1},512)),[[ue,e.show]])}var Uo=j(Kl,[["render",Xl]]);const Jl=Q({}),er=n("table",{class:"help"},[n("tr",null,[n("td",null,"\u2B06\uFE0F Move up:"),n("td",null,[n("div",null,[n("kbd",null,"W"),k("/"),n("kbd",null,"\u2191"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u2B07\uFE0F Move down:"),n("td",null,[n("div",null,[n("kbd",null,"S"),k("/"),n("kbd",null,"\u2193"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u2B05\uFE0F Move left:"),n("td",null,[n("div",null,[n("kbd",null,"A"),k("/"),n("kbd",null,"\u2190"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u27A1\uFE0F Move right:"),n("td",null,[n("div",null,[n("kbd",null,"D"),k("/"),n("kbd",null,"\u2192"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td"),n("td",null,[n("div",null,[k("Move faster by holding "),n("kbd",null,"Shift")])])]),n("tr",null,[n("td",null,"\u{1F50D}+ Zoom in:"),n("td",null,[n("div",null,[n("kbd",null,"E"),k("/\u{1F5B1}\uFE0F-Wheel")])])]),n("tr",null,[n("td",null,"\u{1F50D}- Zoom out:"),n("td",null,[n("div",null,[n("kbd",null,"Q"),k("/\u{1F5B1}\uFE0F-Wheel")])])]),n("tr",null,[n("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),n("td",null,[n("div",null,[n("kbd",null,"Space")])])]),n("tr",null,[n("td",null,"\u{1F3AF} Center puzzle in screen:"),n("td",null,[n("div",null,[n("kbd",null,"C")])])]),n("tr",null,[n("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),n("td",null,[n("div",null,[n("kbd",null,"F")])])]),n("tr",null,[n("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),n("td",null,[n("div",null,[n("kbd",null,"G")])])]),n("tr",null,[n("td",null,"\u{1F464} Toggle player names:"),n("td",null,[n("div",null,[n("kbd",null,"N")])])]),n("tr",null,[n("td",null,"\u{1F509} Toggle sounds:"),n("td",null,[n("div",null,[n("kbd",null,"M")])])]),n("tr",null,[n("td",null,"\u{1F3AF} Store position [0-9]:"),n("td",null,[n("div",null,[n("kbd",null,"Shift"),k(" + "),n("kbd",null,"0"),k("-"),n("kbd",null,"9")])])]),n("tr",null,[n("td",null,"\u{1F3AF} Restore position [0-9]:"),n("td",null,[n("div",null,[n("kbd",null,"0"),k("-"),n("kbd",null,"9")])])]),n("tr",null,[n("td",null,"\u23EB Speed up (replay):"),n("td",null,[n("div",null,[n("kbd",null,"I")])])]),n("tr",null,[n("td",null,"\u23EC Speed down (replay):"),n("td",null,[n("div",null,[n("kbd",null,"O")])])]),n("tr",null,[n("td",null,"\u23F8\uFE0F Pause (replay):"),n("td",null,[n("div",null,[n("kbd",null,"P")])])])],-1);function tr(e,t,o,s,i,l){const r=U("overlay");return m(),ae(r,{class:"transparent"},{default:ne(()=>[er]),_:1})}var Ft=j(Jl,[["render",tr]]),or="/assets/click.bb97cb07.mp3",nr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:or}),sr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",ir=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:sr}),lr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",rr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:lr}),ar="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",ur=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:ar}),cr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",dr=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:cr});const pr=e=>{let t=!1;const o=()=>{t=!0},s=e.fps||60,i=e.slow||1,l=e.update,r=e.render,u=window.requestAnimationFrame,f=1/s,E=i*f;let S,B=0,y=window.performance.now();const h=()=>{for(S=window.performance.now(),B=B+Math.min(1,(S-y)/1e3);B>E;)B=B-E,l(f);r(B/i),y=S,t||u(h)};return u(h),{stop:o}},hr=.1,gr=6,mr=.05;class Gt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,o){this.x+=t/this.curZoom,this.y+=o/this.curZoom}calculateNewZoom(t){const o=t==="in"?1:-1,s=this.curZoom+mr*this.curZoom*o;return Math.min(Math.max(s,hr),gr)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,o){if(this.curZoom==t)return!1;const s=1-this.curZoom/t;return this.move(-o.x*s,-o.y*s),this.curZoom=t,!0}zoom(t,o){return this.setZoom(this.calculateNewZoom(t),o)}viewportToWorld(t){const{x:o,y:s}=this.viewportToWorldRaw(t);return{x:Math.round(o),y:Math.round(s)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:o,y:s}=this.worldToViewportRaw(t);return{x:Math.round(o),y:Math.round(s)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:o,h:s}=this.worldDimToViewportRaw(t);return{w:Math.round(o),h:Math.round(s)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:o,h:s}=this.viewportDimToWorldRaw(t);return{w:Math.round(o),h:Math.round(s)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function It(e=0,t=0){const o=document.createElement("canvas");return o.width=e,o.height=t,o}async function fr(e){return new Promise(t=>{const o=new Image;o.onload=()=>{createImageBitmap(o).then(t)},o.src=e})}async function yr(e,t,o){const s=It(t,o);return s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,o),await createImageBitmap(s)}function _r(e,t,o){const s=It(e.width,e.height),i=s.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=o,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),s}var he={createCanvas:It,loadImageToBitmap:fr,resizeBitmap:yr,colorizedCanvas:_r};const Er=_t("Debug.js");let Bt=0,Ro=0;const vr=e=>{Bt=performance.now(),Ro=e},wr=e=>{const t=performance.now(),o=t-Bt;o>Ro&&Er.log(e+": "+o),Bt=t};var Ae={checkpoint_start:vr,checkpoint:wr};function Pr(e,t){return{x:e.x-t.x,y:e.y-t.y}}function Cr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Vo(e,t){const o=e.x-t.x,s=e.y-t.y;return Math.sqrt(o*o+s*s)}function br(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Yt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function Sr(e,t,o){return{x:e.x+t,y:e.y+o,w:e.w,h:e.h}}function Tr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function $r(e,t){return Vo(Yt(e),Yt(t))}var Z={pointSub:Pr,pointAdd:Cr,pointDistance:Vo,pointInBounds:br,rectCenter:Yt,rectMoved:Sr,rectCenterDistance:$r,rectsOverlap:Tr};const Lo=_t("PuzzleGraphics.js");async function Ar(e,t,o){Lo.log("start createPuzzleTileBitmaps");const s=o.tileSize,i=o.tileMarginWidth,l=o.tileDrawSize,r=s/100,u=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],f=new Array(t.length),E={};function S(_){const Y=`${_.top}${_.right}${_.left}${_.bottom}`;if(E[Y])return E[Y];const N=new Path2D,T={x:i,y:i},w=Z.pointAdd(T,{x:s,y:0}),c=Z.pointAdd(w,{x:0,y:s}),G=Z.pointSub(c,{x:s,y:0});if(N.moveTo(T.x,T.y),_.top!==0)for(let v=0;v<u.length/6;v++){const X=Z.pointAdd(T,{x:u[v*6+0]*r,y:_.top*u[v*6+1]*r}),q=Z.pointAdd(T,{x:u[v*6+2]*r,y:_.top*u[v*6+3]*r}),J=Z.pointAdd(T,{x:u[v*6+4]*r,y:_.top*u[v*6+5]*r});N.bezierCurveTo(X.x,X.y,q.x,q.y,J.x,J.y)}else N.lineTo(w.x,w.y);if(_.right!==0)for(let v=0;v<u.length/6;v++){const X=Z.pointAdd(w,{x:-_.right*u[v*6+1]*r,y:u[v*6+0]*r}),q=Z.pointAdd(w,{x:-_.right*u[v*6+3]*r,y:u[v*6+2]*r}),J=Z.pointAdd(w,{x:-_.right*u[v*6+5]*r,y:u[v*6+4]*r});N.bezierCurveTo(X.x,X.y,q.x,q.y,J.x,J.y)}else N.lineTo(c.x,c.y);if(_.bottom!==0)for(let v=0;v<u.length/6;v++){const X=Z.pointSub(c,{x:u[v*6+0]*r,y:_.bottom*u[v*6+1]*r}),q=Z.pointSub(c,{x:u[v*6+2]*r,y:_.bottom*u[v*6+3]*r}),J=Z.pointSub(c,{x:u[v*6+4]*r,y:_.bottom*u[v*6+5]*r});N.bezierCurveTo(X.x,X.y,q.x,q.y,J.x,J.y)}else N.lineTo(G.x,G.y);if(_.left!==0)for(let v=0;v<u.length/6;v++){const X=Z.pointSub(G,{x:-_.left*u[v*6+1]*r,y:u[v*6+0]*r}),q=Z.pointSub(G,{x:-_.left*u[v*6+3]*r,y:u[v*6+2]*r}),J=Z.pointSub(G,{x:-_.left*u[v*6+5]*r,y:u[v*6+4]*r});N.bezierCurveTo(X.x,X.y,q.x,q.y,J.x,J.y)}else N.lineTo(T.x,T.y);return E[Y]=N,N}const B=he.createCanvas(l,l),y=B.getContext("2d"),h=he.createCanvas(l,l),O=h.getContext("2d");for(const _ of t){const Y=D.decodePiece(_),N=Or(o,Y.idx),T=S(D.decodeShape(o.shapes[Y.idx]));y.clearRect(0,0,l,l),y.save(),y.lineWidth=2,y.stroke(T),y.globalCompositeOperation="source-in",y.drawImage(e,N.x-i,N.y-i,l,l,0,0,l,l),y.restore(),y.save(),y.globalCompositeOperation="source-in",y.globalAlpha=.2,y.fillStyle="black",y.fillRect(0,0,B.width,B.height),y.restore(),y.save(),y.clip(T),y.drawImage(e,N.x-i,N.y-i,l,l,0,0,l,l),y.restore(),y.save(),y.clip(T),y.strokeStyle="rgba(0,0,0,.4)",y.lineWidth=0,y.shadowColor="black",y.shadowBlur=2,y.shadowOffsetX=-1,y.shadowOffsetY=-1,y.stroke(T),y.restore(),y.save(),y.clip(T),y.strokeStyle="rgba(255,255,255,.4)",y.lineWidth=0,y.shadowColor="white",y.shadowBlur=2,y.shadowOffsetX=1,y.shadowOffsetY=1,y.stroke(T),y.restore(),O.clearRect(0,0,l,l),O.save(),O.lineWidth=1,O.stroke(T),O.globalCompositeOperation="source-in",O.drawImage(e,N.x-i,N.y-i,l,l,0,0,l,l),O.restore(),y.drawImage(h,0,0),f[Y.idx]=await createImageBitmap(B)}return Lo.log("end createPuzzleTileBitmaps"),f}function Or(e,t){const o=D.coordByPieceIdx(e,t);return{x:o.x*e.tileSize,y:o.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function Nr(e){const t=await he.loadImageToBitmap(e.info.imageUrl),o=await he.resizeBitmap(t,e.info.width,e.info.height);return await Ar(o,e.tiles,e.info)}var kr={loadPuzzleBitmaps:Nr};const zo=30,b={};function Ur(e){return!!b[e]||!1}function Rr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function Vr(e,t){b[e]=t}function et(e,t){let o=0;for(const s of b[e].players){if(D.decodePlayer(s).id===t)return o;o++}return-1}function Lr(e,t){return b[e].players.length>t?D.decodePlayer(b[e].players[t]).id:null}function Oe(e,t){const o=et(e,t);return o===-1?null:D.decodePlayer(b[e].players[o])}function xt(e,t,o){const s=et(e,t);s===-1?b[e].players.push(D.encodePlayer(o)):b[e].players[s]=D.encodePlayer(o)}function zr(e,t,o){b[e].puzzle.tiles[t]=D.encodePiece(o)}function Mr(e,t){b[e].puzzle.data=t}function Mo(e,t){return et(e,t)!==-1}function Dr(e,t){const o=t-zo*_e.SEC;return Fo(e).filter(s=>s.ts>=o)}function Fr(e,t){const o=t-zo*_e.SEC;return Fo(e).filter(s=>s.ts<o&&s.points>0)}function Gr(e,t,o){Mo(e,t)?ie(e,t,{ts:o}):xt(e,t,Rr(t,o))}function Ir(){return Do().filter(e=>!e.private)}function Do(){return Object.values(b).sort((e,t)=>{const o=Io(e.id);return o===Io(t.id)?o?t.puzzle.data.finished-e.puzzle.data.finished:t.puzzle.data.started-e.puzzle.data.started:o?1:-1})}function Fo(e){return b[e]?b[e].players.map(D.decodePlayer):[]}function Br(e){return b[e]||null}function tt(e){return b[e].puzzle.tiles.length}function Yr(e){var o;const t=((o=b[e].puzzle.info.image)==null?void 0:o.url)||b[e].puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Wt(e){return b[e].scoreMode}function Go(e){return b[e].snapMode}function Io(e){return ot(e)===tt(e)}function ot(e){let t=0;for(const o of b[e].puzzle.tiles)D.decodePiece(o).owner===-1&&t++;return t}function xr(e){return b[e].puzzle.tiles.map(D.decodePiece).sort((o,s)=>o.z-s.z)}function ie(e,t,o){const s=Oe(e,t);if(s!==null){for(const i of Object.keys(o))s[i]=o[i];xt(e,t,s)}}function nt(e,t){for(const o of Object.keys(t))b[e].puzzle.data[o]=t[o]}function Ne(e,t,o){for(const s of Object.keys(o)){const i=D.decodePiece(b[e].puzzle.tiles[t]);i[s]=o[s],b[e].puzzle.tiles[t]=D.encodePiece(i)}}const ke=(e,t)=>D.decodePiece(b[e].puzzle.tiles[t]),st=(e,t)=>ke(e,t).group,Wr=(e,t)=>{const o=b[e].puzzle.info;return t===0||t===o.tilesX-1||t===o.tiles-o.tilesX||t===o.tiles-1},Bo=(e,t)=>{const o=b[e].puzzle.info,s={x:(o.table.width-o.width)/2,y:(o.table.height-o.height)/2},i=Jr(e,t);return Z.pointAdd(s,i)},it=(e,t)=>ke(e,t).pos,Zr=e=>{const t=Ko(e),o=qo(e),s=Math.round(t/4),i=Math.round(o/4);return{x:0-s,y:0-i,w:t+2*s,h:o+2*i}},Hr=(e,t)=>ke(e,t).z,Be=(e,t)=>{for(const o of b[e].puzzle.tiles){const s=D.decodePiece(o);if(s.owner===t)return s.idx}return-1},jr=(e,t)=>{const o=Be(e,t);return o<0?null:b[e].puzzle.tiles[o]},Kr=e=>b[e].puzzle.info.tileDrawOffset,Yo=e=>b[e].puzzle.info.tileDrawSize,qr=e=>b[e].puzzle.data.started,Qr=e=>b[e].puzzle.data.finished,xo=e=>b[e].puzzle.data.maxGroup,Wo=e=>b[e].puzzle.data.maxZ,Xr=(e,t)=>{let o=0;for(const s of t){const i=Hr(e,s);i>o&&(o=i)}return o};function Jr(e,t){const o=b[e].puzzle.info,s=D.coordByPieceIdx(o,t),i=s.x*o.tileSize,l=s.y*o.tileSize;return{x:i,y:l}}function ea(e,t){const o=b[e].puzzle.info,s=D.coordByPieceIdx(o,t);return[s.y>0?t-o.tilesX:-1,s.x<o.tilesX-1?t+1:-1,s.y<o.tilesY-1?t+o.tilesX:-1,s.x>0?t-1:-1]}const Zo=(e,t,o)=>{for(const s of t)Ne(e,s,{z:o})},ta=(e,t,o)=>{const s=it(e,t),i=Z.pointAdd(s,o);Ne(e,t,{pos:i})},lt=(e,t,o)=>{const s=Yo(e),i=Zr(e),l=o;for(const r of t){const u=ke(e,r);u.pos.x+o.x<i.x?l.x=Math.max(i.x-u.pos.x,l.x):u.pos.x+s+o.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-u.pos.x+s,l.x)),u.pos.y+o.y<i.y?l.y=Math.max(i.y-u.pos.y,l.y):u.pos.y+s+o.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-u.pos.y+s,l.y))}if(!l.x&&!l.y)return!1;for(const r of t)ta(e,r,l);return!0},oa=e=>e.owner===-1,na=(e,t)=>sa(e,t)===-1,sa=(e,t)=>ke(e,t).owner,Ho=(e,t)=>{for(const o of t)Ne(e,o,{owner:-1,z:1})},Zt=(e,t,o)=>{for(const s of t)Ne(e,s,{owner:o})};function ia(e,t){return Ee(e,t).length}function Ee(e,t){const o=b[e].puzzle.tiles,s=D.decodePiece(o[t]),i=[];if(s.group)for(const l of o){const r=D.decodePiece(l);r.group===s.group&&i.push(r.idx)}else i.push(s.idx);return i}const la=(e,t)=>{const o=b[e].puzzle.info,s=b[e].puzzle.tiles;let i=-1,l=-1;for(let r=0;r<s.length;r++){const u=D.decodePiece(s[r]);if(u.owner!==0)continue;const f={x:u.pos.x,y:u.pos.y,w:o.tileSize,h:o.tileSize};Z.pointInBounds(t,f)&&(i===-1||u.z>i)&&(i=u.z,l=r)}return l},ra=(e,t)=>{const o=Oe(e,t);return o?o.bgcolor:null},aa=(e,t)=>{const o=Oe(e,t);return o?o.color:null},ua=(e,t)=>{const o=Oe(e,t);return o?o.name:null},jo=(e,t)=>{const o=Oe(e,t);return o?o.points:0},ca=(e,t,o)=>{const s=st(e,t),i=st(e,o);return!!(s&&s===i)},Ko=e=>b[e].puzzle.info.table.width,qo=e=>b[e].puzzle.info.table.height,da=e=>b[e].puzzle,pa=e=>b[e].rng.obj,ha=e=>b[e].puzzle.info.width,ga=e=>b[e].puzzle.info.height,ma=(e,t)=>{if(Go(e)===Te.REAL){for(const o of t)if(Wr(e,o))return!0;return!1}return!0};function fa(e,t,o,s,i){const l=b[e].puzzle,r=[],u=()=>{r.push([d.CHANGE_DATA,l.data])},f=h=>{r.push([d.CHANGE_TILE,D.encodePiece(ke(e,h))])},E=h=>{for(const O of h)f(O)},S=()=>{const h=Oe(e,t);!h||r.push([d.CHANGE_PLAYER,D.encodePlayer(h)])},B=(h,O,_)=>{const Y=b[h].puzzle.tiles,N=st(h,O),T=st(h,_);let w;const c=[];if(N&&c.push(N),T&&c.push(T),N)w=N;else if(T)w=T;else{const G=xo(h)+1;nt(h,{maxGroup:G}),u(),w=xo(h)}if(Ne(h,O,{group:w}),f(O),Ne(h,_,{group:w}),f(_),c.length>0)for(const G of Y){const v=D.decodePiece(G);c.includes(v.group)&&(Ne(h,v.idx,{group:w}),f(v.idx))}},y=o[0];if(y===d.INPUT_EV_CONNECTION_CLOSE){const h=Be(e,t);if(h>=0){const O=Ee(e,h);Zt(e,O,0),E(O)}}else if(y===d.INPUT_EV_BG_COLOR){const h=o[1];ie(e,t,{bgcolor:h,ts:s}),S()}else if(y===d.INPUT_EV_PLAYER_COLOR){const h=o[1];ie(e,t,{color:h,ts:s}),S()}else if(y===d.INPUT_EV_PLAYER_NAME){const h=`${o[1]}`.substr(0,16);ie(e,t,{name:h,ts:s}),S()}else if(y===d.INPUT_EV_MOVE){const h=o[1],O=o[2],_=Oe(e,t);if(_){const Y=_.x-h,N=_.y-O;ie(e,t,{ts:s,x:Y,y:N}),S();const T=Be(e,t);if(T>=0){const w=Ee(e,T),c={x:-h,y:-O};lt(e,w,c)&&E(w)}}}else if(y===d.INPUT_EV_MOUSE_DOWN){const h=o[1],O=o[2],_={x:h,y:O};ie(e,t,{d:1,ts:s}),S();const Y=la(e,_);if(Y>=0){const N=Wo(e)+1;nt(e,{maxZ:N}),u();const T=Ee(e,Y);Zo(e,T,Wo(e)),Zt(e,T,t),E(T)}}else if(y===d.INPUT_EV_MOUSE_MOVE){const h=o[1],O=o[2];if(!o[5])ie(e,t,{x:h,y:O,ts:s}),S();else{const Y=Be(e,t);if(Y<0)ie(e,t,{ts:s}),S();else{const N=o[1],T=o[2],w=o[3],c=o[4];ie(e,t,{x:N,y:T,ts:s}),S();const G=Ee(e,Y);lt(e,G,{x:w,y:c})&&E(G)}}}else if(y===d.INPUT_EV_MOUSE_UP){const h=0,O=Be(e,t);if(O>=0){const _=Ee(e,O);Zt(e,_,0),E(_);const Y=it(e,O),N=Bo(e,O);if(ma(e,_)&&Z.pointDistance(N,Y)<l.info.snapDistance){const T=Z.pointSub(N,Y);lt(e,_,T),Ho(e,_),E(_);let w=jo(e,t);Wt(e)===we.FINAL?w+=_.length:Wt(e)===we.ANY&&(w+=1),ie(e,t,{d:h,ts:s,points:w}),S(),ot(e)===tt(e)&&(nt(e,{finished:s}),u()),i&&i(t)}else{const T=(c,G,v,X)=>{const q=b[c].puzzle.info;if(v<0||ca(c,G,v))return!1;const J=it(c,G),ve=Z.pointAdd(it(c,v),{x:X[0]*q.tileSize,y:X[1]*q.tileSize});if(Z.pointDistance(J,ve)<q.snapDistance){const Ce=Z.pointSub(ve,J);let de=Ee(c,G);if(lt(c,de,Ce),B(c,G,v),de=Ee(c,G),na(c,v))Ho(c,de);else{const Ue=Xr(c,de);Zo(c,de,Ue)}return E(de),!0}return!1};let w=!1;for(const c of Ee(e,O)){const G=ea(e,c);if(T(e,c,G[0],[0,1])||T(e,c,G[1],[-1,0])||T(e,c,G[2],[0,-1])||T(e,c,G[3],[1,0])){w=!0;break}}if(w&&Wt(e)===we.ANY){const c=jo(e,t)+1;ie(e,t,{d:h,ts:s,points:c}),S()}else ie(e,t,{d:h,ts:s}),S();w&&Go(e)===Te.REAL&&ot(e)===tt(e)&&(nt(e,{finished:s}),u()),w&&i&&i(t)}}else ie(e,t,{d:h,ts:s}),S()}else if(y===d.INPUT_EV_ZOOM_IN){const h=o[1],O=o[2];ie(e,t,{x:h,y:O,ts:s}),S()}else if(y===d.INPUT_EV_ZOOM_OUT){const h=o[1],O=o[2];ie(e,t,{x:h,y:O,ts:s}),S()}else ie(e,t,{ts:s}),S();return r}var $={setGame:Vr,exists:Ur,playerExists:Mo,getActivePlayers:Dr,getIdlePlayers:Fr,addPlayer:Gr,getFinishedPiecesCount:ot,getPieceCount:tt,getImageUrl:Yr,get:Br,getPiece:ke,getGroupedPieceCount:ia,getAllGames:Do,getAllPublicGames:Ir,getPlayerBgColor:ra,getPlayerColor:aa,getPlayerName:ua,getPlayerIndexById:et,getPlayerIdByIndex:Lr,changePlayer:ie,setPlayer:xt,setPiece:zr,setPuzzleData:Mr,getTableWidth:Ko,getTableHeight:qo,getPuzzle:da,getRng:pa,getPuzzleWidth:ha,getPuzzleHeight:ga,getPiecesSortedByZIndex:xr,getFirstOwnedPiece:jr,getPieceDrawOffset:Kr,getPieceDrawSize:Yo,getFinalPiecePos:Bo,getStartTs:qr,getFinishTs:Qr,handleInput:fa,PieceIsFinished:oa};let Qo=-10,Xo=20,Ht=2,Jo=15;const ya=5,_a=5,jt=1,Ea=200,en=10,va=100,wa=10,Pa=1,Ca=5;function ba(e){const t=e.random(0,255),o=e.random(0,255),s=e.random(0,255);return"rgba("+t+","+o+","+s+", 0.8)"}class tn{constructor(t){this.radius=en,this.previousRadius=en,this.explodingDuration=va,this.hasExploded=!1,this.alive=!0,this.color=ba(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Qo+Math.random()*Xo,this.vy=(Ht+Math.random()*Jo)*-1,this.duration=0}update(t){if(this.hasExploded){const o=Ea-this.radius;this.previousRadius=this.radius,this.radius+=o/wa,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=jt,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const o=3+Math.floor(Math.random()*3);for(let s=0;s<o;s++){const i=10+Math.floor(Math.random()*21),l=ya+Math.random()*_a,r=2*Math.PI/i,u=Math.random()*r;for(let f=0;f<i;f++)t.push(new Sa(this,f*r+u,l))}}}class Sa{constructor(t,o,s){this.px=t.px,this.py=t.py,this.vx=Math.cos(o)*s,this.vy=Math.sin(o)*s,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=jt/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class Ta{constructor(t,o){this.canvas=t,this.rng=o,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,o=0;for(;t<this.canvas.height&&o>=0;)o+=jt,t+=o;Ht=o/2,Jo=o-Ht;const s=1/4*this.canvas.width/(o/2);Qo=-s,Xo=2*s}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<Pa;t++)this.readyBombs.push(new tn(this.rng))}update(){Math.random()*100<Ca&&this.readyBombs.push(new tn(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const o=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):o.push(i)}this.readyBombs=o;const s=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&s.push(i)}this.particles=s}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function $a(e,t,o,s){let i=[],l=!0,r=!1,u=!1,f=!1,E=!1,S=!1,B=!1,y=!1;const h=(g,R)=>{const z=o.viewportToWorld({x:g,y:R});return[z.x,z.y]},O=(g,R)=>{const z=o.viewportDimToWorld({w:g,h:R});return[z.w,z.h]},_=g=>h(g.offsetX,g.offsetY),Y=()=>h(e.width/2,e.height/2),N=(g,R)=>{!l||(R.code==="ShiftLeft"||R.code==="ShiftRight"?y=g:R.code==="ArrowUp"||R.code==="KeyW"?f=g:R.code==="ArrowDown"||R.code==="KeyS"?E=g:R.code==="ArrowLeft"||R.code==="KeyA"?r=g:R.code==="ArrowRight"||R.code==="KeyD"?u=g:R.code==="KeyQ"?B=g:R.code==="KeyE"&&(S=g))};let T=!1,w=null,c=null;const G=g=>{c=_(g),w=[g.offsetX,g.offsetY],g.button===0&&(T=!0,H([d.INPUT_EV_MOUSE_DOWN,...c]))},v=g=>{c=_(g),w=[g.offsetX,g.offsetY],g.button===0&&(T=!1,H([d.INPUT_EV_MOUSE_UP,...c]))},X=g=>{if(!w)return;c=_(g);const R=O(-(w[0]-g.offsetX),-(w[1]-g.offsetY));H([d.INPUT_EV_MOUSE_MOVE,...c,...R,T?1:0]),w=[g.offsetX,g.offsetY]},q=g=>{if(c=_(g),o.canZoom(g.deltaY<0?"in":"out")){const R=g.deltaY<0?d.INPUT_EV_ZOOM_IN:d.INPUT_EV_ZOOM_OUT;H([R,...c])}},J=g=>N(!0,g),ve=g=>N(!1,g),Ce=g=>{if(!!l){if(s===me&&(g.code==="KeyI"?H([d.INPUT_EV_REPLAY_SPEED_UP]):g.code==="KeyO"?H([d.INPUT_EV_REPLAY_SPEED_DOWN]):g.code==="KeyP"&&H([d.INPUT_EV_REPLAY_TOGGLE_PAUSE])),g.code==="Space")H([d.INPUT_EV_TOGGLE_PREVIEW]);else if(g.code==="KeyF")H([d.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(g.code==="KeyG")H([d.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(g.code==="KeyM")H([d.INPUT_EV_TOGGLE_SOUNDS]);else if(g.code==="KeyN")H([d.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(g.code==="KeyC")H([d.INPUT_EV_CENTER_FIT_PUZZLE]);else for(let R=0;R<=9;R++)if(g.code===`Digit${R}`){const z=g.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;H([z,R]);break}}},de=()=>{e.addEventListener("mousedown",G),e.addEventListener("mouseup",v),e.addEventListener("mousemove",X),e.addEventListener("wheel",q),t.addEventListener("keydown",J),t.addEventListener("keyup",ve),t.addEventListener("keypress",Ce)},Ue=()=>{e.removeEventListener("mousedown",G),e.removeEventListener("mouseup",v),e.removeEventListener("mousemove",X),e.removeEventListener("wheel",q),t.removeEventListener("keydown",J),t.removeEventListener("keyup",ve),t.removeEventListener("keypress",Ce)},at=(g,R)=>{if(!w||!c)return;const z=new Gt(g).viewportToWorld({x:w[0],y:w[1]}),A=new Gt(R).viewportToWorld({x:w[0],y:w[1]}),ut=[-(z.x-A.x),-(z.y-A.y)];H([d.INPUT_EV_MOUSE_MOVE,...c,...ut,T?1:0])},H=g=>{i.push(g)};return{registerEvents:de,unregisterEvents:Ue,addEvent:H,consumeAll:()=>{if(i.length===0)return[];const g=i.slice();return i=[],g},createKeyEvents:()=>{const g=(r?1:0)-(u?1:0),R=(f?1:0)-(E?1:0);if(g!==0||R!==0){const z=(y?24:12)*Math.sqrt(o.getCurrentZoom()),A=o.viewportDimToWorld({w:g*z,h:R*z});H([d.INPUT_EV_MOVE,A.w,A.h]),c&&(c[0]-=A.w,c[1]-=A.h)}if(!(S&&B)){if(S){if(o.canZoom("in")){const z=c||Y();H([d.INPUT_EV_ZOOM_IN,...z])}}else if(B&&o.canZoom("out")){const z=c||Y();H([d.INPUT_EV_ZOOM_OUT,...z])}}},createSnapshotEvents:at,setHotkeys:g=>{l=g}}}const rt={"./grab.png":ir,"./grab_mask.png":rr,"./hand.png":ur,"./hand_mask.png":dr},Aa={"./click.mp3":nr},Ye="play",me="replay";let xe=!0,We=!0;const Oa=e=>e.owner===-1?xe:We;let K=!0;async function on(e,t,o,s,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const r=a=>s===me||a.id!==t,u=Aa["./click.mp3"].default,f=new Audio(u),E=await he.loadImageToBitmap(rt["./grab.png"].default),S=await he.loadImageToBitmap(rt["./hand.png"].default),B=await he.loadImageToBitmap(rt["./grab_mask.png"].default),y=await he.loadImageToBitmap(rt["./hand_mask.png"].default),h=E.width,O=Math.round(h/2),_=E.height,Y=Math.round(_/2),N={},T=async a=>{const p=a.color+" "+a.d;if(!N[p]){const C=a.d?E:S;if(a.color){const W=a.d?B:y;N[p]=await createImageBitmap(he.colorizedCanvas(C,W,a.color))}else N[p]=C}return N[p]},w=i,c={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Pe.onConnectionStateChange(a=>{l.emit("connectionState",a)});const G=async a=>{const p=c.dataOffset;c.dataOffset+=1e4;const C=await Pe.requestReplayData(a,p);return c.log=c.log.slice(c.logPointer),c.logPointer=0,c.log.push(...C.log),C.log.length===0&&(c.final=!0),C};let v=()=>0;const X=async()=>{if(s===Ye){const a=await Pe.connect(o,e,t),p=D.decodeGame(a);$.setGame(p.id,p),v=()=>_e.timestamp()}else if(s===me){const a=await G(e);if(!a.game)throw"[ 2021-05-29 no game received ]";const p=D.decodeGame(a.game);$.setGame(p.id,p),c.lastRealTs=_e.timestamp(),c.gameStartTs=parseInt(a.log[0][4],10),c.lastGameTs=c.gameStartTs,v=()=>c.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";K=!0};await X();const q=$.getPieceDrawOffset(e),J=$.getPieceDrawSize(e),ve=$.getPuzzleWidth(e),Ce=$.getPuzzleHeight(e),de=$.getTableWidth(e),Ue=$.getTableHeight(e),at={x:(de-ve)/2,y:(Ue-Ce)/2},H={w:ve,h:Ce},Kt={w:J,h:J},qt=await kr.loadPuzzleBitmaps($.getPuzzle(e)),Ze=new Ta(w,$.getRng(e));Ze.init();const g=w.getContext("2d");w.classList.add("loaded"),l.emit("puzzleCut");let R="";const z={},A=new Gt,ut=()=>{A.reset(),A.move(-(de-w.width)/2,-(Ue-w.height)/2);const a=A.worldDimToViewportRaw(H),p=20,C=w.width-p*2,W=w.height-p*2;if(a.w>C||a.h>W||a.w<C&&a.h<W){const x=Math.min(C/a.w,W/a.h),V={x:w.width/2,y:w.height/2};A.setZoom(x,V)}},le=$a(w,window,A,s);le.registerEvents();const He=a=>{if(z.last&&R===a){const p=A.snapshot(),C=z.last;A.fromSnapshot(C),le.createSnapshotEvents(p,C),delete z.last}else if(z[a]){const p=z[a],C=A.snapshot();z.last=C,R=a,A.fromSnapshot(p),le.createSnapshotEvents(C,p)}};ut(),z.center=A.snapshot();const ln=$.getImageUrl(e),je=a=>{const p=$.getStartTs(e),C=$.getFinishTs(e);l.emit("status",{finished:!!C,duration:(C||a)-p,piecesDone:$.getFinishedPiecesCount(e),piecesTotal:$.getPieceCount(e)}),l.emit("players",{active:$.getActivePlayers(e,a),idle:$.getIdlePlayers(e,a)})};je(v());const Qt=!!$.getFinishTs(e);let ct=Qt;const Xt=()=>ct&&!Qt,Jt=()=>te.getInt(se.SOUND_VOLUME,ge.SOUND_VOLUME),eo=()=>te.getBool(se.OTHER_PLAYER_CLICK_SOUND_ENABLED,ge.OTHER_PLAYER_CLICK_SOUND_ENABLED),dt=()=>te.getBool(se.SOUND_ENABLED,ge.SOUND_ENABLED),to=()=>te.getBool(se.SHOW_PLAYER_NAMES,ge.SHOW_PLAYER_NAMES),oo=()=>s===me?te.getStr(se.COLOR_BACKGROUND,ge.COLOR_BACKGROUND):$.getPlayerBgColor(e,t)||te.getStr(se.COLOR_BACKGROUND,ge.COLOR_BACKGROUND),no=()=>s===me?te.getStr(se.PLAYER_COLOR,ge.PLAYER_COLOR):$.getPlayerColor(e,t)||te.getStr(se.PLAYER_COLOR,ge.PLAYER_COLOR),rn=()=>s===me?te.getStr(se.PLAYER_NAME,ge.PLAYER_NAME):$.getPlayerName(e,t)||te.getStr(se.PLAYER_NAME,ge.PLAYER_NAME),pt=()=>{const a=Jt();f.volume=a/100,f.play()},oe={background:oo(),color:no(),name:rn(),soundsEnabled:dt(),otherPlayerClickSoundEnabled:eo(),soundsVolume:Jt(),showPlayerNames:to()};le.addEvent([d.INPUT_EV_BG_COLOR,oe.background]),le.addEvent([d.INPUT_EV_PLAYER_COLOR,oe.color]),le.addEvent([d.INPUT_EV_PLAYER_NAME,oe.name]);let so="",io="",lo=!1;const Me=a=>{lo=a;const[p,C]=a?[so,"grab"]:[io,"default"];w.style.cursor=`url('${p}') ${O} ${Y}, ${C}`},ht=a=>{so=he.colorizedCanvas(E,B,a).toDataURL(),io=he.colorizedCanvas(S,y,a).toDataURL(),Me(lo)};ht(no());const Ke=()=>{l.emit("replaySpeed",c.speeds[c.speedIdx]),l.emit("replayPaused",c.paused)},ro=()=>{c.speedIdx+1<c.speeds.length&&(c.speedIdx++,Ke())},ao=()=>{c.speedIdx>=1&&(c.speedIdx--,Ke())},uo=()=>{c.paused=!c.paused,Ke()};l.on("replayOnSpeedUp",()=>{ro()}),l.on("replayOnSpeedDown",()=>{ao()}),l.on("replayOnPauseToggle",()=>{uo()}),l.on("onBgChange",a=>{oe.background!==a&&(oe.background=a,te.setStr(se.COLOR_BACKGROUND,a),le.addEvent([d.INPUT_EV_BG_COLOR,a]))}),l.on("onColorChange",a=>{oe.color!==a&&(oe.color=a,te.setStr(se.PLAYER_COLOR,a),le.addEvent([d.INPUT_EV_PLAYER_COLOR,a]))}),l.on("onNameChange",a=>{oe.name!==a&&(oe.name=a,te.setStr(se.PLAYER_NAME,a),le.addEvent([d.INPUT_EV_PLAYER_NAME,a]))}),l.on("onOtherPlayerClickSoundEnabledChange",a=>{oe.otherPlayerClickSoundEnabled!==a&&(oe.otherPlayerClickSoundEnabled=a,te.setBool(se.OTHER_PLAYER_CLICK_SOUND_ENABLED,a))}),l.on("onSoundsEnabledChange",a=>{oe.soundsEnabled!==a&&(oe.soundsEnabled=a,te.setBool(se.SOUND_ENABLED,a))}),l.on("onSoundsVolumeChange",a=>{oe.soundsVolume!==a&&(oe.soundsVolume=a,te.setInt(se.SOUND_VOLUME,a),pt())}),l.on("onShowPlayerNamesChange",a=>{oe.showPlayerNames!==a&&(oe.showPlayerNames=a,te.setBool(se.SHOW_PLAYER_NAMES,a))}),l.on("setHotkeys",a=>{le.setHotkeys(a)}),l.on("requireRerender",()=>{K=!0});const co=[];let qe;const an=()=>{co.forEach(a=>{clearInterval(a)}),qe&&clearTimeout(qe)};let gt;const un=()=>{an(),gt&&gt.stop(),le&&le.unregisterEvents()};if(s===Ye?co.push(setInterval(()=>{je(v())},1e3)):s===me&&Ke(),s===Ye)Pe.onServerChange(a=>{a[0],a[1],a[2];const p=a[3];let C=!1;const W=x=>{const V=D.decodePiece(x);if(C)return $.setPiece(e,V.idx,V),!0;const M=$.getPiece(e,V.idx);if(!$.PieceIsFinished(M)&&$.PieceIsFinished(V))return $.setPiece(e,V.idx,V),!0;const fe=$.getGroupedPieceCount(e,V.idx);return $.setPiece(e,V.idx,V),$.getGroupedPieceCount(e,V.idx)>fe};for(const[x,V]of p)switch(x){case d.CHANGE_PLAYER:{const M=D.decodePlayer(V);M.id!==t&&($.setPlayer(e,M.id,M),K=!0)}break;case d.CHANGE_TILE:W(V)&&(C=!0),K=!0;break;case d.CHANGE_DATA:$.setPuzzleData(e,V),K=!0;break}C&&dt()&&eo()&&pt(),ct=!!$.getFinishTs(e)});else if(s===me){const a=(W,x)=>{const V=W;if(V[0]===d.LOG_ADD_PLAYER){const M=V[1];return $.addPlayer(e,M,x),!0}if(V[0]===d.LOG_UPDATE_PLAYER){const M=$.getPlayerIdByIndex(e,V[1]);if(!M)throw"[ 2021-05-17 player not found (update player) ]";return $.addPlayer(e,M,x),!0}if(V[0]===d.LOG_HANDLE_INPUT){const M=$.getPlayerIdByIndex(e,V[1]);if(!M)throw"[ 2021-05-17 player not found (handle input) ]";const fe=V[2];return $.handleInput(e,M,fe,x),!0}return!1};let p=c.lastGameTs;const C=async()=>{c.logPointer+1>=c.log.length&&await G(e);const W=_e.timestamp();if(c.paused){c.lastRealTs=W,qe=setTimeout(C,50);return}const V=(W-c.lastRealTs)*c.speeds[c.speedIdx];let M=c.lastGameTs+V;do{if(c.paused)break;const fe=c.logPointer+1;if(fe>=c.log.length)break;const De=c.log[c.logPointer],po=p+De[De.length-1],mt=c.log[fe],ho=mt[mt.length-1],ft=po+ho;if(ft>M){M+500*_e.MS<ft&&(M+=ho);break}p=po,a(mt,ft)&&(K=!0),c.logPointer=fe}while(!0);c.lastRealTs=W,c.lastGameTs=M,je(v()),c.final||(qe=setTimeout(C,50))};C()}return gt=pr({update:()=>{le.createKeyEvents();for(const a of le.consumeAll())if(s===Ye){const p=a[0];if(p===d.INPUT_EV_MOVE){const x=A.worldDimToViewportRaw({w:a[1],h:a[2]});K=!0,A.move(x.w,x.h),delete z.last}else if(p===d.INPUT_EV_MOUSE_MOVE){if(a[5]&&!$.getFirstOwnedPiece(e,t)){const V=A.worldDimToViewportRaw({w:a[3],h:a[4]});K=!0,A.move(V.w,V.h),delete z.last}}else if(p===d.INPUT_EV_PLAYER_COLOR)ht(a[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Me(!0);else if(p===d.INPUT_EV_MOUSE_UP)Me(!1);else if(p===d.INPUT_EV_ZOOM_IN){const x={x:a[1],y:a[2]};K=!0,A.zoom("in",A.worldToViewportRaw(x)),delete z.last}else if(p===d.INPUT_EV_ZOOM_OUT){const x={x:a[1],y:a[2]};K=!0,A.zoom("out",A.worldToViewportRaw(x)),delete z.last}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(p===d.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE)He("center");else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)xe=!xe,K=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)We=!We,K=!0;else if(p===d.INPUT_EV_STORE_POS){const x=`${a[1]}`;z[x]=A.snapshot()}else if(p===d.INPUT_EV_RESTORE_POS){const x=`${a[1]}`;He(x)}const C=v();$.handleInput(e,t,a,C,x=>{dt()&&pt()}).length>0&&(K=!0),Pe.sendClientEvent(a)}else if(s===me){const p=a[0];if(p===d.INPUT_EV_REPLAY_TOGGLE_PAUSE)uo();else if(p===d.INPUT_EV_REPLAY_SPEED_DOWN)ao();else if(p===d.INPUT_EV_REPLAY_SPEED_UP)ro();else if(p===d.INPUT_EV_MOVE){const C=A.worldDimToViewportRaw({w:a[1],h:a[2]});K=!0,A.move(C.w,C.h)}else if(p===d.INPUT_EV_MOUSE_MOVE){if(a[5]){const W=A.worldDimToViewportRaw({w:a[3],h:a[4]});K=!0,A.move(W.w,W.h)}}else if(p===d.INPUT_EV_PLAYER_COLOR)ht(a[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Me(!0);else if(p===d.INPUT_EV_MOUSE_UP)Me(!1);else if(p===d.INPUT_EV_ZOOM_IN){const C={x:a[1],y:a[2]};K=!0,A.zoom("in",A.worldToViewportRaw(C))}else if(p===d.INPUT_EV_ZOOM_OUT){const C={x:a[1],y:a[2]};K=!0,A.zoom("out",A.worldToViewportRaw(C))}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(p===d.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE)He("center");else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)xe=!xe,K=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)We=!We,K=!0;else if(p===d.INPUT_EV_STORE_POS){const C=`${a[1]}`;z[C]=A.snapshot()}else if(p===d.INPUT_EV_RESTORE_POS){const C=`${a[1]}`;He(C)}}ct=!!$.getFinishTs(e),Xt()&&(Ze.update(),K=!0)},render:async()=>{if(!K)return;const a=v();let p,C,W;window.DEBUG&&Ae.checkpoint_start(0),g.fillStyle=oo(),g.fillRect(0,0,w.width,w.height),window.DEBUG&&Ae.checkpoint("clear done"),p=A.worldToViewportRaw(at),C=A.worldDimToViewportRaw(H),g.fillStyle="rgba(255, 255, 255, .3)",g.fillRect(p.x,p.y,C.w,C.h),window.DEBUG&&Ae.checkpoint("board done");const x=$.getPiecesSortedByZIndex(e);window.DEBUG&&Ae.checkpoint("get tiles done"),C=A.worldDimToViewportRaw(Kt);for(const M of x)!Oa(M)||(W=qt[M.idx],p=A.worldToViewportRaw({x:q+M.pos.x,y:q+M.pos.y}),g.drawImage(W,0,0,W.width,W.height,p.x,p.y,C.w,C.h));window.DEBUG&&Ae.checkpoint("tiles done");const V=[];for(const M of $.getActivePlayers(e,a))r(M)&&(W=await T(M),p=A.worldToViewport(M),g.drawImage(W,p.x-O,p.y-Y),to()&&V.push([`${M.name} (${M.points})`,p.x,p.y+_]));g.fillStyle="white",g.textAlign="center";for(const[M,fe,De]of V)g.fillText(M,fe,De);window.DEBUG&&Ae.checkpoint("players done"),je(a),window.DEBUG&&Ae.checkpoint("HUD done"),Xt()&&Ze.render(),K=!1}}),{previewImageUrl:ln,player:oe,game:$.get(e),disconnect:Pe.disconnect,connect:X,unload:un}}const Na=Q({name:"game",components:{PuzzleStatusComponent:Tt,Scores:St,SettingsOverlay:$t,PreviewOverlay:At,InfoOverlay:Ot,ConnectionOverlay:Uo,HelpOverlay:Ft},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:go(),g:{player:mo(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await on(`${this.$route.params.id}`,ce.clientId(),this.$config.WS_ADDRESS,Ye,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}}}),ka={id:"game"},Ua=n("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),Ra={class:"menu-left"},Va={key:0,class:"switch-game-replay"},La=k("\u21AA\uFE0F Watch replay"),za={class:"menu"},Ma={class:"tabs"},Da=k("\u{1F9E9} Puzzles"),Fa={class:"menu-right"},Ga={ref:"canvas"};function Ia(e,t,o,s,i,l){const r=U("settings-overlay"),u=U("preview-overlay"),f=U("info-overlay"),E=U("help-overlay"),S=U("overlay"),B=U("connection-overlay"),y=U("puzzle-status"),h=U("router-link"),O=U("scores");return m(),P("div",ka,[L(F(r,{onClose:t[0]||(t[0]=_=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=_=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=_=>e.g.player=_)},null,8,["modelValue"]),[[ue,e.overlay==="settings"]]),L(F(u,{onClose:t[3]||(t[3]=_=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=_=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[ue,e.overlay==="preview"]]),e.g.game?L((m(),ae(f,{key:0,onClose:t[5]||(t[5]=_=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=_=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[ue,e.overlay==="info"]]):ee("",!0),L(F(E,{onClose:t[7]||(t[7]=_=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=_=>e.toggle("help",!0))},null,512),[[ue,e.overlay==="help"]]),L(F(S,null,{default:ne(()=>[Ua]),_:1},512),[[ue,e.cuttingPuzzle]]),F(B,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),n("div",Ra,[F(y,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(m(),P("div",Va,[F(h,{to:{name:"replay",params:{id:e.g.game.id}}},{default:ne(()=>[La]),_:1},8,["to"])])):ee("",!0)]),n("div",za,[n("div",Ma,[F(h,{class:"opener",to:{name:"index"},target:"_blank"},{default:ne(()=>[Da]),_:1}),n("div",{class:"opener",onClick:t[9]||(t[9]=_=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),n("div",{class:"opener",onClick:t[10]||(t[10]=_=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),n("div",{class:"opener",onClick:t[11]||(t[11]=_=>e.toggle("info",!0))},"\u2139\uFE0F Info"),n("div",{class:"opener",onClick:t[12]||(t[12]=_=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),n("div",Fa,[F(O,{players:e.players},null,8,["players"])]),n("canvas",Ga,null,512)])}var Ba=j(Na,[["render",Ia]]);const Ya=Q({name:"replay",components:{PuzzleStatusComponent:Tt,Scores:St,SettingsOverlay:$t,PreviewOverlay:At,InfoOverlay:Ot,HelpOverlay:Ft},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:go(),g:{player:mo(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await on(`${this.$route.params.id}`,ce.clientId(),this.$config.WS_ADDRESS,me,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),xa={id:"replay"},Wa={key:1,class:"overlay"},Za=n("div",{class:"overlay-content"},[n("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),Ha=[Za],ja={class:"menu-left"},Ka={class:"playback-control"},qa={key:0,class:"switch-game-replay"},Qa=k("\u{1F9E9} To the game"),Xa={class:"menu"},Ja={class:"tabs"},eu=k("\u{1F9E9} Puzzles"),tu={class:"menu-right"},ou={ref:"canvas"};function nu(e,t,o,s,i,l){const r=U("settings-overlay"),u=U("preview-overlay"),f=U("info-overlay"),E=U("help-overlay"),S=U("puzzle-status"),B=U("router-link"),y=U("scores");return m(),P("div",xa,[L(F(r,{onClose:t[0]||(t[0]=h=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=h=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=h=>e.g.player=h)},null,8,["modelValue"]),[[ue,e.overlay==="settings"]]),L(F(u,{onClose:t[3]||(t[3]=h=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=h=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[ue,e.overlay==="preview"]]),e.g.game?L((m(),ae(f,{key:0,onClose:t[5]||(t[5]=h=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=h=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[ue,e.overlay==="info"]]):ee("",!0),L(F(E,{onClose:t[7]||(t[7]=h=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=h=>e.toggle("help",!0))},null,512),[[ue,e.overlay==="help"]]),e.cuttingPuzzle?(m(),P("div",Wa,Ha)):ee("",!0),n("div",ja,[F(S,{status:e.status},null,8,["status"]),n("div",Ka,[n("div",null,I(e.replayText),1),n("button",{class:"btn",onClick:t[9]||(t[9]=h=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),n("button",{class:"btn",onClick:t[10]||(t[10]=h=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),n("button",{class:"btn",onClick:t[11]||(t[11]=h=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")]),e.g.game?(m(),P("div",qa,[F(B,{to:{name:"game",params:{id:e.g.game.id}}},{default:ne(()=>[Qa]),_:1},8,["to"])])):ee("",!0)]),n("div",Xa,[n("div",Ja,[F(B,{class:"opener",to:{name:"index"},target:"_blank"},{default:ne(()=>[eu]),_:1}),n("div",{class:"opener",onClick:t[12]||(t[12]=h=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),n("div",{class:"opener",onClick:t[13]||(t[13]=h=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),n("div",{class:"opener",onClick:t[14]||(t[14]=h=>e.toggle("info",!0))},"\u2139\uFE0F Info"),n("div",{class:"opener",onClick:t[15]||(t[15]=h=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),n("div",tu,[F(y,{players:e.players},null,8,["players"])]),n("canvas",ou,null,512)])}var su=j(Ya,[["render",nu]]);let nn=null;async function iu(){nn=await(await ce.get("/api/me",{})).json()}var sn={getMe:()=>nn,init:iu};const lu=Q({props:{image:{type:Object,required:!0}},data:()=>({me:sn.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function ru(e,t,o,s,i,l){return m(),P("div",{class:"imageteaser",style:Re(e.style),onClick:t[1]||(t[1]=(...r)=>e.onClick&&e.onClick(...r))},[e.canEdit?(m(),P("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=hn((...r)=>e.onEditClick&&e.onEditClick(...r),["stop"]))},"\u270F\uFE0F")):ee("",!0)],4)}var au=j(lu,[["render",ru]]);const uu=Q({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),cu={class:"overlay"};function du(e,t,o,s,i,l){return m(),P("div",cu,[n("div",{class:Fe(["overlay-background",e.classes.map(r=>"overlay-background-"+r)]),onClick:t[0]||(t[0]=r=>e.$emit("bgclick"))},null,2),n("div",{class:Fe(["overlay-content",e.classes.map(r=>"overlay-content-"+r)])},[gn(e.$slots,"default")],2)])}var pu=j(uu,[["render",du]]);const hu={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},gu=["title"];function mu(e,t,o,s,i,l){return m(),P("div",{style:Re(l.style),title:o.title},null,12,gu)}var fu=j(hu,[["render",mu]]);const yu=Q({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),_u={key:0,class:"autocomplete"},Eu=["onClick"],vu=["onClick"];function wu(e,t,o,s,i,l){return m(),P("div",null,[L(n("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=r=>e.input=r),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...r)=>e.onChange&&e.onChange(...r)),onKeydown:t[2]||(t[2]=mn((...r)=>e.add&&e.add(...r),["enter"])),onKeyup:t[3]||(t[3]=(...r)=>e.onKeyUp&&e.onKeyUp(...r))},null,544),[[be,e.input]]),e.autocomplete.values?(m(),P("div",_u,[n("ul",null,[(m(!0),P(re,null,ye(e.autocomplete.values,(r,u)=>(m(),P("li",{key:u,class:Fe({active:u===e.autocomplete.idx}),onClick:f=>e.addVal(r)},I(r),11,Eu))),128))])])):ee("",!0),(m(!0),P(re,null,ye(e.values,(r,u)=>(m(),P("span",{key:u,class:"bit is-clickable",onClick:f=>e.rm(r)},I(r)+" \u2716",9,vu))),128))])}var Pu=j(yu,[["render",wu],["__scopeId","data-v-d5073870"]]);const Cu=Q({props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const o=t.files[0];if(!o)return;const s=new FormData;s.append("file",o,o.name);const l=await(await ce.post("/upload",{body:s})).json();this.$emit("uploaded",l)}}}),bu=["accept"],Su={class:"btn"};function Tu(e,t,o,s,i,l){return m(),P("label",null,[n("input",{type:"file",style:{display:"none"},onChange:t[0]||(t[0]=(...r)=>e.upload&&e.upload(...r)),accept:e.accept},null,40,bu),n("span",Su,I(e.label||"Upload File"),1)])}var $u=j(Cu,[["render",Tu]]);(async()=>{ce.init(),await sn.init();const t=await(await ce.get("/api/conf",{})).json(),o=fn({history:yn(),routes:[{name:"index",path:"/",component:is},{name:"new-game",path:"/new-game",component:Si},{name:"game",path:"/g/:id",component:Ba},{name:"replay",path:"/replay/:id",component:su}]});o.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const s=_n(Tn);s.config.globalProperties.$config=t,s.use(o),s.component("connection-overlay",Uo),s.component("edit-image-dialog",Co),s.component("game-teaser",vo),s.component("help-overlay",Ft),s.component("image-library",wo),s.component("image-teaser",au),s.component("info-overlay",Ot),s.component("new-game-dialog",So),s.component("new-image-dialog",Po),s.component("overlay",pu),s.component("preview-overlay",At),s.component("puzzle-status",Tt),s.component("responsive-image",fu),s.component("scores",St),s.component("settings-overlay",$t),s.component("tags-input",Pu),s.component("upload",$u),s.mount("#app")})();
//# sourceMappingURL=index.25a26b5c.js.map
