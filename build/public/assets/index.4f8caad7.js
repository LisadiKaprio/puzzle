import{d as ie,r as V,o as d,c as _,a as o,b as ee,w as re,e as U,f,g as te,n as Be,t as F,F as ae,h as ye,i as Xe,j as Z,v as Re,k as Ue,l as Pe,m as Gs,p as Is,q as Bs,s as Yo,u as Wo,x as Tt,y as xs,z as Oo,A as Ys,B as Ws,C as Fs}from"./vendor.4bfcbb49.js";const Zs=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}};Zs();var oe=(e,t)=>{const s=e.__vccOpts||e;for(const[n,i]of t)s[n]=i;return s};const Hs=ie({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),js={id:"app"},Ks={key:0,class:"nav"},qs=f("Games overview"),Xs=f("New game"),Qs=o("li",null,[o("a",{href:"https://ec.europa.eu/info/strategy/priorities-2019-2024/stronger-europe-world/eu-solidarity-ukraine/eu-assistance-ukraine/eu-stands-ukraine_en",class:"btn btn-ukraine",target:"_blank"},[o("i",{class:"icon icon-ukraine-heart"}),f(" Stand with Ukraine "),o("i",{class:"icon icon-ukraine-heart"})])],-1);function Js(e,t,s,n,i,r){const a=V("router-link"),u=V("router-view");return d(),_("div",js,[e.showNav?(d(),_("ul",Ks,[o("li",null,[ee(a,{class:"btn",to:{name:"index"}},{default:re(()=>[qs]),_:1})]),o("li",null,[ee(a,{class:"btn",to:{name:"new-game"}},{default:re(()=>[Xs]),_:1})]),Qs])):U("",!0),ee(u)])}var en=oe(Hs,[["render",Js]]);class dt{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,s){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const n=(this.rand_high>>>0)/4294967295;return t+n*(s-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const s=t.slice();for(let n=0;n<=s.length-2;n++){const i=this.random(n,s.length-1),r=s[n];s[n]=s[i],s[i]=r}return s}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const s=new dt(0);return s.rand_high=t.rand_high,s.rand_low=t.rand_low,s}}const tn=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},lt=(e,t)=>{const s=`${e}`;return s.length>=t.length?s:t.substr(0,t.length-s.length)+s},It=(...e)=>{const t=s=>(...n)=>{const i=new Date,r=lt(i.getHours(),"00"),a=lt(i.getMinutes(),"00"),u=lt(i.getSeconds(),"00");console[s](`${r}:${a}:${u}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},on=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function sn(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function nn(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function ln(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function rn(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function an(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function un(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function cn(e){return[e.id,e.rng.type||"",dt.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion,e.private]}function dn(e){return{id:e[0],rng:{type:e[1],obj:dt.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10],private:e[11]}}function hn(e,t){const s=e.width/e.tileSize;return{x:t%s,y:Math.floor(t/s)}}function pn(e,t){const s=e.width/e.pieceSize;return{x:t%s,y:Math.floor(t/s)}}const gn=e=>{let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t|=0}return t};function fn(e){const t=[];for(const s in e){const n=[s,e[s]].map(encodeURIComponent);t.push(n.join("="))}return t.length===0?"":`?${t.join("&")}`}var B={hash:gn,slug:tn,pad:lt,uniqId:on,encodeShape:sn,decodeShape:nn,encodePiece:ln,decodePiece:rn,encodePlayer:an,decodePlayer:un,encodeGame:cn,decodeGame:dn,coordByPieceIdxDeprecated:hn,coordByPieceIdx:pn,asQueryArgs:fn};const X={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",OTHER_PLAYER_CLICK_SOUND_ENABLED:"other_player_click_sound_enabled",COLOR_BACKGROUND:"bg_color",SHOW_TABLE:"show_table",TABLE_TEXTURE:"table_texture",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},pe={SOUND_VOLUME:100,SOUND_ENABLED:!0,OTHER_PLAYER_CLICK_SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",SHOW_TABLE:!0,TABLE_TEXTURE:"dark",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},Fo=()=>({background:"",showTable:!0,tableTexture:"dark",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0}),Bt=(e,t)=>{localStorage.setItem(e,t)},xt=e=>localStorage.getItem(e),mn=(e,t)=>{Bt(e,`${t}`)},_n=(e,t)=>{const s=xt(e);if(s===null)return t;const n=parseInt(s,10);return isNaN(n)?t:n},yn=(e,t)=>{Bt(e,t?"1":"0")},wn=(e,t)=>{const s=xt(e);return s===null?t:s==="1"},vn=(e,t)=>{Bt(e,t)},En=(e,t)=>{const s=xt(e);return s===null?t:s};var K={setInt:mn,getInt:_n,setBool:yn,getBool:wn,setStr:vn,getStr:En};let $t="",Zo="";const vt=async(e,t,s)=>new Promise((n,i)=>{const r=new window.XMLHttpRequest;r.open(e,t,!0),r.withCredentials=!0;for(const a in s.headers||{})r.setRequestHeader(a,s.headers[a]);r.setRequestHeader("Client-Id",$t),r.setRequestHeader("Client-Secret",Zo),r.addEventListener("load",function(a){n({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),r.addEventListener("error",function(a){i(new Error("xhr error"))}),r.upload&&s.onUploadProgress&&r.upload.addEventListener("progress",function(a){s.onUploadProgress&&s.onUploadProgress(a)}),r.send(s.body||null)}),No=e=>{let t=K.getStr(e,"");return t||(t=B.uniqId(),K.setStr(e,t)),t};var _e={init:()=>{$t=No("ID"),Zo=No("SECRET")},request:vt,get:(e,t)=>vt("get",e,t),post:(e,t)=>vt("post",e,t),clientId:()=>$t};const Ho=1,Yt=Ho*1e3,at=Yt*60,ut=at*60,St=ut*24,Pn=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},jo=e=>{const t=Math.floor(e/St);e=e%St;const s=Math.floor(e/ut);e=e%ut;const n=Math.floor(e/at);e=e%at;const i=Math.floor(e/Yt);return`${t}d ${s}h ${n}m ${i}s`},bn=(e,t)=>jo(t-e);var Te={MS:Ho,SEC:Yt,MIN:at,HOUR:ut,DAY:St,timestamp:Pn,timeDiffStr:bn,durationStr:jo};const Tn=ie({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const s=e,n=t||Te.timestamp();return`${Te.timeDiffStr(s,n)}`}}}),$n={class:"game-info-text"},Sn=o("i",{class:"icon icon-puzzle-piece"},null,-1),Cn=o("br",null,null,-1),kn=o("i",{class:"icon icon-sillouette"},null,-1),An=o("br",null,null,-1),On={key:0,class:"icon icon-clock"},Nn={key:1,class:"icon icon-flag"},Un=o("br",null,null,-1),Rn=o("i",{class:"icon icon-replay"},null,-1),Ln=f(" Watch replay ");function Vn(e,t,s,n,i,r){const a=V("router-link");return d(),_("div",{class:"game-teaser",style:Be(e.style)},[ee(a,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:re(()=>[o("span",$n,[Sn,f(" "+F(e.game.piecesFinished)+"/"+F(e.game.piecesTotal),1),Cn,kn,f(" "+F(e.game.players),1),An,e.game.finished?(d(),_("i",Nn)):(d(),_("i",On)),f(" "+F(e.time(e.game.started,e.game.finished)),1),Un])]),_:1},8,["to"]),e.game.hasReplay?(d(),te(a,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:re(()=>[Rn,Ln]),_:1},8,["to"])):U("",!0)],4)}var Ko=oe(Tn,[["render",Vn]]);const Mn=ie({components:{GameTeaser:Ko},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await _e.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),zn=o("h1",null,"Running games",-1),Dn=o("h1",null,"Finished games",-1);function Gn(e,t,s,n,i,r){const a=V("game-teaser");return d(),_("div",null,[zn,(d(!0),_(ae,null,ye(e.gamesRunning,(u,m)=>(d(),_("div",{class:"game-teaser-wrap",key:m},[ee(a,{game:u},null,8,["game"])]))),128)),Dn,(d(!0),_(ae,null,ye(e.gamesFinished,(u,m)=>(d(),_("div",{class:"game-teaser-wrap",key:m},[ee(a,{game:u},null,8,["game"])]))),128))])}var In=oe(Mn,[["render",Gn]]);const Bn=ie({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function xn(e,t,s,n,i,r){const a=V("image-teaser");return d(),_("div",null,[(d(!0),_(ae,null,ye(e.images,(u,m)=>(d(),te(a,{image:u,onClick:g=>e.imageClicked(u),onEditClick:g=>e.imageEditClicked(u),key:m},null,8,["image","onClick","onEditClick"]))),128))])}var qo=oe(Bn,[["render",xn]]);const Yn=async e=>{const t=await Fn(e),s=await Wn(t);return Xo(s.toDataURL())},Wn=async e=>{const t=document.createElement("canvas"),s=t.getContext("2d");return t.width=e.width,t.height=e.height,s.drawImage(e,0,0),t},Fn=async e=>new Promise((t,s)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{t(n)},n.onerror=i=>{s(i)},n.src=e});function Xo(e){for(var t=e.split(","),s=t[0].match(/:(.*?);/)[1],n=atob(t[1]),i=n.length,r=new Uint8Array(i);i--;)r[i]=n.charCodeAt(i);return new Blob([r],{type:s})}const Zn=ie({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:["setupGameClick","postToGalleryClick","close"],data(){return{previewUrl:"",file:null,title:"",tags:[],isPrivate:!1,droppable:!1,inputFocused:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},mounted(){window.addEventListener("paste",this.onPaste)},unmounted(){window.removeEventListener("paste",this.onPaste)},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.isPrivate=!1,this.droppable=!1},imageFromDragEvt(e){var n;const t=(n=e.dataTransfer)==null?void 0:n.items;if(!t||t.length===0)return null;const s=t[0];return s.type.startsWith("image/")?s:null},async onPaste(e){const t=e.clipboardData.getData("text");if(t){if(this.inputFocused)return;if(t.match(/^https?:\/\//)){const n="/api/proxy?"+new URLSearchParams({url:t});try{const i=await Yn(n);this.preview(i)}catch(i){console.error("unable to transform image http url into blob",i)}}else if(t.match(/^data:image\/([a-z]+);base64,/))try{const n=Xo(t);this.preview(n)}catch(n){console.error("unable to transform image data url into blob",n)}else console.log(t)}const s=e.clipboardData.files[0];!s||this.preview(s)},onFileSelect(e){const t=e.target;if(!t.files)return;const s=t.files[0];!s||this.preview(s)},preview(e){if(!e.type.startsWith("image/")){console.error("file type is not supported",e.type);return}const t=new FileReader;t.readAsDataURL(e),t.onload=s=>{this.previewUrl=s.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const s=t.getAsFile();return s&&(this.file=s,this.preview(s),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),Hn=o("div",{class:"drop-target"},null,-1),jn={key:0,class:"has-image"},Kn={key:1},qn={class:"upload"},Xn=o("div",{class:"upload-content"},[f(" How to upload an image? Choose any of the following methods: "),o("ul",null,[o("li",null,"Click this area to select an image for upload "),o("li",null,"Drag and drop an image into the area"),o("li",null,"Paste an image URL"),o("li",null,"Paste an image")]),o("div",{class:"hint"},` Don't worry, the image will not show up in the gallery unless "Post to gallery" was clicked. `)],-1),Qn={class:"area-settings"},Jn=o("td",null,[o("label",null,"Title")],-1),ei=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),ti=o("td",null,[o("label",null,"Private Image")],-1),oi=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Private images won't show up in the gallery.")])],-1),si=o("td",null,[o("label",null,"Tags")],-1),ni={class:"area-buttons"},ii=["disabled"],li=o("i",{class:"icon icon-preview"},null,-1),ri=f(" Post to gallery"),ai=["disabled"],ui=o("i",{class:"icon icon-puzzle-piece"},null,-1),ci=f(" Set up game"),di=o("i",{class:"icon icon-puzzle-piece"},null,-1),hi=f(" Post to gallery "),pi=o("br",null,null,-1),gi=f(" + set up game");function fi(e,t,s,n,i,r){const a=V("responsive-image"),u=V("tags-input"),m=V("overlay");return d(),te(m,{class:"new-image-dialog"},{default:re(()=>[o("div",{class:Xe(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...g)=>e.onDrop&&e.onDrop(...g)),onDragover:t[3]||(t[3]=(...g)=>e.onDragover&&e.onDragover(...g)),onDragleave:t[4]||(t[4]=(...g)=>e.onDragleave&&e.onDragleave(...g))},[Hn,e.previewUrl?(d(),_("div",jn,[o("span",{class:"remove btn",onClick:t[0]||(t[0]=g=>e.previewUrl="")},"X"),ee(a,{src:e.previewUrl},null,8,["src"])])):(d(),_("div",Kn,[o("label",qn,[o("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...g)=>e.onFileSelect&&e.onFileSelect(...g)),accept:"image/*"},null,32),Xn])]))],34),o("div",Qn,[o("table",null,[o("tr",null,[Jn,o("td",null,[Z(o("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=g=>e.title=g),placeholder:"Flower by @artist",onFocus:t[6]||(t[6]=g=>e.inputFocused=!0),onBlur:t[7]||(t[7]=g=>e.inputFocused=!1)},null,544),[[Re,e.title]])])]),ei,o("tr",null,[ti,o("td",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=g=>e.isPrivate=g)},null,512),[[Ue,e.isPrivate]])])]),oi,o("tr",null,[si,o("td",null,[ee(u,{modelValue:e.tags,"onUpdate:modelValue":t[9]||(t[9]=g=>e.tags=g),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",ni,[e.isPrivate?U("",!0):(d(),_("button",{key:0,class:"btn",disabled:!e.canPostToGallery,onClick:t[10]||(t[10]=(...g)=>e.postToGallery&&e.postToGallery(...g))},[e.uploading==="postToGallery"?(d(),_(ae,{key:0},[f("Uploading ("+F(e.uploadProgressPercent)+"%)",1)],64)):(d(),_(ae,{key:1},[li,ri],64))],8,ii)),o("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[11]||(t[11]=(...g)=>e.setupGameClick&&e.setupGameClick(...g))},[e.uploading==="setupGame"?(d(),_(ae,{key:0},[f("Uploading ("+F(e.uploadProgressPercent)+"%)",1)],64)):e.isPrivate?(d(),_(ae,{key:1},[ui,ci],64)):(d(),_(ae,{key:2},[di,hi,pi,gi],64))],8,ai),o("button",{class:"btn",onClick:t[12]||(t[12]=g=>e.$emit("close"))},"Cancel")])]),_:1})}var Qo=oe(Zn,[["render",fi]]);const mi=ie({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:["saveClick","close"],data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),_i={class:"area-image"},yi={class:"has-image"},wi={class:"area-settings"},vi=o("td",null,[o("label",null,"Title")],-1),Ei=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Pi=o("td",null,[o("label",null,"Tags")],-1),bi={class:"area-buttons"},Ti=o("i",{class:"icon icon-preview"},null,-1),$i=f(" Save image"),Si=[Ti,$i];function Ci(e,t,s,n,i,r){const a=V("responsive-image"),u=V("tags-input"),m=V("overlay");return d(),te(m,{class:"edit-image-dialog"},{default:re(()=>[o("div",_i,[o("div",yi,[ee(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),o("div",wi,[o("table",null,[o("tr",null,[vi,o("td",null,[Z(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=g=>e.title=g),placeholder:"Flower by @artist"},null,512),[[Re,e.title]])])]),Ei,o("tr",null,[Pi,o("td",null,[ee(u,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=g=>e.tags=g),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",bi,[o("button",{class:"btn",onClick:t[2]||(t[2]=(...g)=>e.saveImage&&e.saveImage(...g))},Si),o("button",{class:"btn",onClick:t[3]||(t[3]=g=>e.$emit("close"))},"Cancel")])]),_:1})}var Jo=oe(mi,[["render",Ci]]),Le=(e=>(e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY",e))(Le||{}),Ke=(e=>(e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT",e))(Ke||{}),xe=(e=>(e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL",e))(xe||{});const ki=ie({props:{image:{type:Object,required:!0},forcePrivate:{type:Boolean,default:!1}},emits:["newGame","close"],data(){return{tiles:1e3,isPrivate:!1,scoreMode:Le.ANY,shapeMode:Ke.NORMAL,snapMode:xe.NORMAL}},mounted(){this.isPrivate=this.forcePrivate},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,private:this.isPrivate,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Ai={class:"area-image"},Oi={class:"has-image"},Ni={key:0,class:"image-title"},Ui={key:0,class:"image-title-title"},Ri={key:1,class:"image-title-dim"},Li={class:"area-settings"},Vi=o("td",null,[o("label",null,"Pieces")],-1),Mi=o("td",null,[o("label",null,"Scoring: ")],-1),zi=f(" Any (Score when pieces are connected to each other or on final location)"),Di=o("br",null,null,-1),Gi=f(" Final (Score when pieces are put to their final location)"),Ii=o("td",null,[o("label",null,"Shapes: ")],-1),Bi=f(" Normal"),xi=o("br",null,null,-1),Yi=f(" Any (Flat pieces can occur anywhere)"),Wi=o("br",null,null,-1),Fi=f(" Flat (All pieces flat on all sides)"),Zi=o("td",null,[o("label",null,"Snapping: ")],-1),Hi=f(" Normal (Pieces snap to final destination and to each other)"),ji=o("br",null,null,-1),Ki=f(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),qi=o("td",null,[o("label",null,"Private Game")],-1),Xi=["disabled"],Qi=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Private games won't show up in the game overview.")])],-1),Ji={key:0},el=o("td",null,[o("label",null,"Tags: ")],-1),tl={class:"area-buttons"},ol=["disabled"],sl=o("i",{class:"icon icon-puzzle-piece"},null,-1),nl=f(" Generate Puzzle "),il=[sl,nl];function ll(e,t,s,n,i,r){const a=V("responsive-image"),u=V("overlay");return d(),te(u,{class:"new-game-dialog"},{default:re(()=>[o("div",Ai,[o("div",Oi,[ee(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(d(),_("div",Ni,[e.image.title?(d(),_("span",Ui,'"'+F(e.image.title)+'"',1)):U("",!0),e.image.width||e.image.height?(d(),_("span",Ri,"("+F(e.image.width)+" \u2715 "+F(e.image.height)+")",1)):U("",!0)])):U("",!0)]),o("div",Li,[o("table",null,[o("tr",null,[Vi,o("td",null,[Z(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=m=>e.tiles=m)},null,512),[[Re,e.tiles]])])]),o("tr",null,[Mi,o("td",null,[o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=m=>e.scoreMode=m),value:"1"},null,512),[[Pe,e.scoreMode]]),zi]),Di,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=m=>e.scoreMode=m),value:"0"},null,512),[[Pe,e.scoreMode]]),Gi])])]),o("tr",null,[Ii,o("td",null,[o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=m=>e.shapeMode=m),value:"0"},null,512),[[Pe,e.shapeMode]]),Bi]),xi,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=m=>e.shapeMode=m),value:"1"},null,512),[[Pe,e.shapeMode]]),Yi]),Wi,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=m=>e.shapeMode=m),value:"2"},null,512),[[Pe,e.shapeMode]]),Fi])])]),o("tr",null,[Zi,o("td",null,[o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=m=>e.snapMode=m),value:"0"},null,512),[[Pe,e.snapMode]]),Hi]),ji,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=m=>e.snapMode=m),value:"1"},null,512),[[Pe,e.snapMode]]),Ki])])]),o("tr",null,[qi,o("td",null,[Z(o("input",{disabled:e.forcePrivate,type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=m=>e.isPrivate=m)},null,8,Xi),[[Ue,e.isPrivate]])])]),Qi,e.image.tags.length?(d(),_("tr",Ji,[el,o("td",null,[(d(!0),_(ae,null,ye(e.image.tags,(m,g)=>(d(),_("span",{key:g,class:"bit"},F(m.title),1))),128))])])):U("",!0)])]),o("div",tl,[o("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[9]||(t[9]=(...m)=>e.onNewGameClick&&e.onNewGameClick(...m))},il,8,ol),o("button",{class:"btn",onClick:t[10]||(t[10]=m=>e.$emit("close"))},"Cancel")])]),_:1})}var es=oe(ki,[["render",ll]]);const rl=ie({components:{ImageLibrary:qo,NewImageDialog:Qo,EditImageDialog:Jo,NewGameDialog:es},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",newGameForcePrivate:!1,uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(s=>!t.includes(s.title)&&s.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(s=>s.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await _e.get(`/api/newgame-data${B.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.newGameForcePrivate=!1,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags),t.append("private",e.isPrivate);const s=await _e.post("/api/upload",{body:t,onUploadProgress:n=>{this.uploadProgress=n.loaded/n.total}});return this.uploadProgress=1,await s.json()},async saveImage(e){return await(await _e.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.newGameForcePrivate=e.isPrivate,this.dialog="new-game"},async onNewGame(e){const t=await _e.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const s=await t.json();this.$router.push({name:"game",params:{id:s.id}})}}}}),al={class:"upload-image-teaser"},ul=o("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),cl={key:0},dl=f(" Tags: "),hl=["onClick"],pl=f(" Sort by: "),gl=o("option",{value:"date_desc"},"Newest first",-1),fl=o("option",{value:"date_asc"},"Oldest first",-1),ml=o("option",{value:"alpha_asc"},"A-Z",-1),_l=o("option",{value:"alpha_desc"},"Z-A",-1),yl=[gl,fl,ml,_l];function wl(e,t,s,n,i,r){const a=V("image-library"),u=V("new-image-dialog"),m=V("edit-image-dialog"),g=V("new-game-dialog");return d(),_("div",null,[o("div",al,[o("div",{class:"btn btn-big",onClick:t[0]||(t[0]=O=>e.dialog="new-image")},"Upload your image"),ul]),o("div",null,[e.tags.length>0?(d(),_("label",cl,[dl,(d(!0),_(ae,null,ye(e.relevantTags,(O,D)=>(d(),_("span",{class:Xe(["bit is-clickable",{on:e.filters.tags.includes(O.slug)}]),key:D,onClick:P=>e.toggleTag(O)},F(O.title)+" ("+F(O.total)+")",11,hl))),128))])):U("",!0),o("label",null,[pl,Z(o("select",{"onUpdate:modelValue":t[1]||(t[1]=O=>e.filters.sort=O),onChange:t[2]||(t[2]=(...O)=>e.filtersChanged&&e.filtersChanged(...O))},yl,544),[[Gs,e.filters.sort]])])]),ee(a,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),e.dialog==="new-image"?(d(),te(u,{key:0,autocompleteTags:e.autocompleteTags,onClose:t[3]||(t[3]=O=>e.dialog=""),onBgclick:t[4]||(t[4]=O=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"])):U("",!0),e.dialog==="edit-image"?(d(),te(m,{key:1,autocompleteTags:e.autocompleteTags,onClose:t[5]||(t[5]=O=>e.dialog=""),onBgclick:t[6]||(t[6]=O=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"])):U("",!0),e.image&&e.dialog==="new-game"?(d(),te(g,{key:2,onClose:t[7]||(t[7]=O=>e.dialog=""),onBgclick:t[8]||(t[8]=O=>e.dialog=""),onNewGame:e.onNewGame,image:e.image,forcePrivate:e.newGameForcePrivate},null,8,["onNewGame","image","forcePrivate"])):U("",!0)])}var vl=oe(rl,[["render",wl]]);const El=ie({props:{players:{type:Object,required:!0}},methods:{playerStyle(e){return e.color==="ukraine"?{backgroundImage:"linear-gradient(180deg, rgba(0,87,183,1) 0%, rgba(0,87,183,1) 50%, rgba(255,221,0,1) 50%)","-webkit-background-clip":"text","-webkit-text-fill-color":"transparent"}:{color:e.color}}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),Pl={class:"scores"},bl=o("div",null,"Scores",-1),Tl=o("td",null,[o("i",{class:"icon icon-lightning"})],-1),$l=o("td",null,[o("i",{class:"icon icon-zzz"})],-1);function Sl(e,t,s,n,i,r){return d(),_("div",Pl,[bl,o("table",null,[(d(!0),_(ae,null,ye(e.actives,(a,u)=>(d(),_("tr",{key:u,style:Be(e.playerStyle(a))},[Tl,o("td",null,F(a.name),1),o("td",null,F(a.points),1)],4))),128)),(d(!0),_(ae,null,ye(e.idles,(a,u)=>(d(),_("tr",{key:u,style:Be(e.playerStyle(a))},[$l,o("td",null,F(a.name),1),o("td",null,F(a.points),1)],4))),128))])])}var Wt=oe(El,[["render",Sl]]);const Cl=ie({props:{status:{type:Object,required:!0}},computed:{durationStr(){return Te.durationStr(this.status.duration)}}}),kl={class:"puzzle-status"},Al=o("i",{class:"icon icon-puzzle-piece"},null,-1),Ol={key:0,class:"icon icon-clock"},Nl={key:1,class:"icon icon-flag"};function Ul(e,t,s,n,i,r){return d(),_("div",kl,[o("div",null,[Al,f(" "+F(e.status.piecesDone)+"/"+F(e.status.piecesTotal),1)]),o("div",null,[this.status.finished?(d(),_("i",Nl)):(d(),_("i",Ol)),f(" "+F(e.durationStr),1)])])}var Ft=oe(Cl,[["render",Ul]]);const Rl=ie({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({showTable:!1,tableTexture:"dark",background:"",color:"",isUkraineColor:!1,name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.showTable=!!e.showTable,this.tableTexture=e.tableTexture,this.background=`${e.background}`,this.color=`${e.color}`,this.isUkraineColor=this.color==="ukraine",this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.otherPlayerClickSoundEnabled=!!e.otherPlayerClickSoundEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{showTable:this.showTable,tableTexture:this.tableTexture,background:this.background,color:this.isUkraineColor?"ukraine":this.color,name:this.name,soundsEnabled:this.soundsEnabled,otherPlayerClickSoundEnabled:this.otherPlayerClickSoundEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch(()=>this.isUkraineColor,this.emitChanges)),this.watches.push(this.$watch(()=>this.background,this.emitChanges)),this.watches.push(this.$watch(()=>this.showTable,this.emitChanges)),this.watches.push(this.$watch(()=>this.tableTexture,this.emitChanges)),this.watches.push(this.$watch(()=>this.color,this.emitChanges)),this.watches.push(this.$watch(()=>this.name,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.otherPlayerClickSoundEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsVolume,this.emitChanges)),this.watches.push(this.$watch(()=>this.showPlayerNames,this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue)}}),we=e=>(Is("data-v-6b022e04"),e=e(),Bs(),e),Ll={class:"settings"},Vl=we(()=>o("td",null,[o("label",null,"Background: ")],-1)),Ml=we(()=>o("td",null,[o("label",null,"Table: ")],-1)),zl=f("Show"),Dl={key:0},Gl=f(" Dark"),Il={key:1},Bl=f(" Brown"),xl={key:2},Yl=f(" Light"),Wl=we(()=>o("td",null,[o("label",null,"Color: ")],-1)),Fl=we(()=>o("i",{class:"icon icon-ukraine-heart"},null,-1)),Zl=we(()=>o("td",null,[o("label",null,"Name: ")],-1)),Hl=we(()=>o("td",null,[o("label",null,"Sounds: ")],-1)),jl=we(()=>o("td",null,[o("label",null,"Piece connect sounds of others: ")],-1)),Kl=["disabled"],ql=we(()=>o("td",null,[o("label",null,"Sounds Volume: ")],-1)),Xl={class:"sound-volume"},Ql=we(()=>o("i",{class:"icon icon-volume-down"},null,-1)),Jl=[Ql],er=["disabled","value"],tr=we(()=>o("i",{class:"icon icon-volume-up"},null,-1)),or=[tr],sr=we(()=>o("td",null,[o("label",null,"Show player names: ")],-1));function nr(e,t,s,n,i,r){const a=V("overlay");return d(),te(a,{class:"transparent"},{default:re(()=>[o("table",Ll,[o("tr",null,[Vl,o("td",null,[Z(o("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=u=>e.background=u)},null,512),[[Re,e.background]])])]),o("tr",null,[Ml,o("td",null,[o("label",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=u=>e.showTable=u)},null,512),[[Ue,e.showTable]]),zl]),e.showTable?(d(),_("label",Dl,[Z(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=u=>e.tableTexture=u),value:"dark"},null,512),[[Pe,e.tableTexture]]),Gl])):U("",!0),e.showTable?(d(),_("label",Il,[Z(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=u=>e.tableTexture=u),value:"brown"},null,512),[[Pe,e.tableTexture]]),Bl])):U("",!0),e.showTable?(d(),_("label",xl,[Z(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=u=>e.tableTexture=u),value:"light"},null,512),[[Pe,e.tableTexture]]),Yl])):U("",!0)])]),o("tr",null,[Wl,o("td",null,[e.isUkraineColor?U("",!0):Z((d(),_("input",{key:0,type:"color","onUpdate:modelValue":t[5]||(t[5]=u=>e.color=u)},null,512)),[[Re,e.color]]),o("label",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=u=>e.isUkraineColor=u)},null,512),[[Ue,e.isUkraineColor]]),Fl])])]),o("tr",null,[Zl,o("td",null,[Z(o("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[7]||(t[7]=u=>e.name=u)},null,512),[[Re,e.name]])])]),o("tr",null,[Hl,o("td",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=u=>e.soundsEnabled=u)},null,512),[[Ue,e.soundsEnabled]])])]),o("tr",null,[jl,o("td",null,[Z(o("input",{type:"checkbox",disabled:!e.soundsEnabled,"onUpdate:modelValue":t[9]||(t[9]=u=>e.otherPlayerClickSoundEnabled=u)},null,8,Kl),[[Ue,e.otherPlayerClickSoundEnabled]])])]),o("tr",null,[ql,o("td",Xl,[o("span",{onClick:t[10]||(t[10]=(...u)=>e.decreaseVolume&&e.decreaseVolume(...u))},Jl),o("input",{disabled:!e.soundsEnabled,type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[11]||(t[11]=(...u)=>e.updateVolume&&e.updateVolume(...u))},null,40,er),o("span",{onClick:t[12]||(t[12]=(...u)=>e.increaseVolume&&e.increaseVolume(...u))},or)])]),o("tr",null,[sr,o("td",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[13]||(t[13]=u=>e.showPlayerNames=u)},null,512),[[Ue,e.showPlayerNames]])])])])]),_:1})}var Zt=oe(Rl,[["render",nr],["__scopeId","data-v-6b022e04"]]);const ir=ie({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),lr={class:"preview"};function rr(e,t,s,n,i,r){const a=V("overlay");return d(),te(a,{class:"preview-overlay",animate:!1},{default:re(()=>[o("div",lr,[o("div",{class:"img",style:Be(e.previewStyle)},null,4)])]),_:1})}var Ht=oe(ir,[["render",rr]]);const ar=ie({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case Le.ANY:return["Any","Score when pieces are connected to each other or on final location"];case Le.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ke.FLAT:return["Flat","All pieces flat on all sides"];case Ke.ANY:return["Any","Flat pieces can occur anywhere"];case Ke.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case xe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case xe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),ur={class:"help"},cr=o("tr",null,[o("td",{colspan:"2"},"Info about this puzzle")],-1),dr=o("td",null,"Image Title: ",-1),hr=o("td",null,"Scoring: ",-1),pr=["title"],gr=o("td",null,"Shapes: ",-1),fr=["title"],mr=o("td",null,"Snapping: ",-1),_r=["title"];function yr(e,t,s,n,i,r){const a=V("overlay");return d(),te(a,{class:"transparent"},{default:re(()=>[o("table",ur,[cr,o("tr",null,[dr,o("td",null,F(e.game.puzzle.info.image.title),1)]),o("tr",null,[hr,o("td",null,[o("span",{title:e.snapMode[1]},F(e.scoreMode[0]),9,pr)])]),o("tr",null,[gr,o("td",null,[o("span",{title:e.snapMode[1]},F(e.shapeMode[0]),9,fr)])]),o("tr",null,[mr,o("td",null,[o("span",{title:e.snapMode[1]},F(e.snapMode[0]),9,_r)])])])]),_:1})}var jt=oe(ar,[["render",yr]]);const wr=4,vr=1,Er=4,Pr=2,br=3,Tr=1,$r=2,Sr=4,Cr=3,kr=1,Ar=2,Or=3,Nr=4,Ur=5,Rr=6,Lr=7,Vr=8,Mr=9,zr=10,Dr=11,Gr=12,Ir=13,Br=14,xr=15,Yr=16,Wr=17,Fr=18,Zr=19,Hr=20,jr=21,Kr=22,qr=23,Xr=1,Qr=2,Jr=3,ea=4;var p={EV_SERVER_EVENT:vr,EV_SERVER_INIT:Er,EV_CLIENT_EVENT:Pr,EV_CLIENT_INIT:br,GAME_VERSION:wr,LOG_HEADER:Tr,LOG_ADD_PLAYER:$r,LOG_UPDATE_PLAYER:Sr,LOG_HANDLE_INPUT:Cr,INPUT_EV_MOVE:Mr,INPUT_EV_MOUSE_DOWN:kr,INPUT_EV_MOUSE_UP:Ar,INPUT_EV_MOUSE_MOVE:Or,INPUT_EV_ZOOM_IN:Nr,INPUT_EV_ZOOM_OUT:Ur,INPUT_EV_BG_COLOR:Rr,INPUT_EV_PLAYER_COLOR:Lr,INPUT_EV_PLAYER_NAME:Vr,INPUT_EV_TOGGLE_INTERFACE:qr,INPUT_EV_TOGGLE_PREVIEW:zr,INPUT_EV_TOGGLE_SOUNDS:Dr,INPUT_EV_REPLAY_TOGGLE_PAUSE:Gr,INPUT_EV_REPLAY_SPEED_UP:Ir,INPUT_EV_REPLAY_SPEED_DOWN:Br,INPUT_EV_TOGGLE_PLAYER_NAMES:xr,INPUT_EV_CENTER_FIT_PUZZLE:Yr,INPUT_EV_TOGGLE_FIXED_PIECES:Wr,INPUT_EV_TOGGLE_LOOSE_PIECES:Fr,INPUT_EV_TOGGLE_TABLE:Kr,INPUT_EV_STORE_POS:Zr,INPUT_EV_RESTORE_POS:Hr,INPUT_EV_CONNECTION_CLOSE:jr,CHANGE_DATA:Xr,CHANGE_PIECE:Qr,CHANGE_PLAYER:Jr,PLAYER_SNAP:ea};const ta=It("Communication.js"),oa=1001,Kt=4e3,ts=0,Ct=1,qt=2,os=3,ss=4;let me,kt=[],At=e=>{kt.push(e)},Ot=[],Nt=e=>{Ot.push(e)};function sa(e){At=e;for(const t of kt)At(t);kt=[]}function na(e){Nt=e;for(const t of Ot)Nt(t);Ot=[]}let Ut=ts;const Ze=e=>{Ut!==e&&(Ut=e,Nt(e))};function ns(e){if(Ut===qt)try{me.send(JSON.stringify(e))}catch{ta.info("unable to send message.. maybe because ws is invalid?")}}let Ge,Ie,Rt=0;function is(e=2e4){me.readyState==me.OPEN&&me.send(""),Rt=setTimeout(is,e)}function Uo(){Rt&&clearTimeout(Rt)}function ia(e,t,s){return Ge=0,Ie={},Ze(os),new Promise(n=>{me=new WebSocket(e,s+"|"+t),me.onopen=()=>{Ze(qt),ns([p.EV_CLIENT_INIT]),is()},me.onmessage=i=>{const r=JSON.parse(i.data),a=r[0];if(a===p.EV_SERVER_INIT){const u=r[1];n(u)}else if(a===p.EV_SERVER_EVENT){const u=r[1],m=r[2];if(u===s&&Ie[m]){delete Ie[m];return}At(r)}else throw`[ 2021-05-09 invalid connect msgType ${a} ]`},me.onerror=()=>{throw Uo(),Ze(Ct),"[ 2021-05-15 onerror ]"},me.onclose=i=>{Uo(),i.code===Kt||i.code===oa?Ze(ss):Ze(Ct)}})}async function la(e,t){const s={gameId:e,offset:t};return await(await _e.get(`/api/replay-data${B.asQueryArgs(s)}`,{})).json()}function ra(){me&&me.close(Kt),Ge=0,Ie={}}function aa(e){Ge++,Ie[Ge]=e,ns([p.EV_CLIENT_EVENT,Ge,Ie[Ge]])}var Ce={connect:ia,requestReplayData:la,disconnect:ra,sendClientEvent:aa,onServerChange:sa,onConnectionStateChange:na,CODE_CUSTOM_DISCONNECT:Kt,CONN_STATE_NOT_CONNECTED:ts,CONN_STATE_DISCONNECTED:Ct,CONN_STATE_CLOSED:ss,CONN_STATE_CONNECTED:qt,CONN_STATE_CONNECTING:os};const ua=ie({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Ce.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Ce.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),ca={key:0},da=o("i",{class:"icon icon-disconnect"},null,-1),ha=f(" LOST CONNECTION "),pa=o("i",{class:"icon icon-disconnect"},null,-1),ga=[da,ha,pa],fa={key:2};function ma(e,t,s,n,i,r){const a=V("overlay");return Z((d(),te(a,{class:"connection-lost"},{default:re(()=>[e.lostConnection?(d(),_("div",ca,ga)):U("",!0),e.lostConnection?(d(),_("span",{key:1,class:"btn",onClick:t[0]||(t[0]=u=>e.$emit("reconnect"))},"Reconnect")):U("",!0),e.connecting?(d(),_("div",fa,"Connecting...")):U("",!0)]),_:1},512)),[[Yo,e.show]])}var ls=oe(ua,[["render",ma]]);const _a=ie({}),ya=o("table",{class:"help"},[o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-up"}),f(" Move up:")]),o("td",null,[o("div",null,[o("kbd",null,"W"),f("/"),o("kbd",null,"\u2191"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-down"}),f(" Move down:")]),o("td",null,[o("div",null,[o("kbd",null,"S"),f("/"),o("kbd",null,"\u2193"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-left"}),f(" Move left:")]),o("td",null,[o("div",null,[o("kbd",null,"A"),f("/"),o("kbd",null,"\u2190"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-right"}),f(" Move right:")]),o("td",null,[o("div",null,[o("kbd",null,"D"),f("/"),o("kbd",null,"\u2192"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td"),o("td",null,[o("div",null,[f("Move faster by holding "),o("kbd",null,"Shift")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-zoom-in"}),f(" Zoom in:")]),o("td",null,[o("div",null,[o("kbd",null,"E"),f("/"),o("i",{class:"icon icon-mouse-wheel"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-zoom-out"}),f(" Zoom out:")]),o("td",null,[o("div",null,[o("kbd",null,"Q"),f("/"),o("i",{class:"icon icon-mouse-wheel"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-preview"}),f(" Toggle preview:")]),o("td",null,[o("div",null,[o("kbd",null,"Space")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-center"}),f(" Center puzzle in screen:")]),o("td",null,[o("div",null,[o("kbd",null,"C")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-puzzle-piece-locked"}),f(" Toggle fixed pieces:")]),o("td",null,[o("div",null,[o("kbd",null,"F")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-puzzle-piece-free"}),f(" Toggle loose pieces:")]),o("td",null,[o("div",null,[o("kbd",null,"G")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-table"}),f(" Toggle table:")]),o("td",null,[o("div",null,[o("kbd",null,"T")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-eye"}),f(" Toggle interface:")]),o("td",null,[o("div",null,[o("kbd",null,"H")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-player-name"}),f(" Toggle player names:")]),o("td",null,[o("div",null,[o("kbd",null,"N")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-volume-up"}),f(" Toggle sounds:")]),o("td",null,[o("div",null,[o("kbd",null,"M")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-save-pos"}),f(" Store position [0-9]:")]),o("td",null,[o("div",null,[o("kbd",null,"Shift"),f(" + "),o("kbd",null,"0"),f("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-load-pos"}),f(" Restore position [0-9]:")]),o("td",null,[o("div",null,[o("kbd",null,"0"),f("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-speed-up"}),f(" Speed up (replay):")]),o("td",null,[o("div",null,[o("kbd",null,"I")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-speed-down"}),f(" Speed down (replay):")]),o("td",null,[o("div",null,[o("kbd",null,"O")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-pause"}),f(" Pause (replay):")]),o("td",null,[o("div",null,[o("kbd",null,"P")])])])],-1);function wa(e,t,s,n,i,r){const a=V("overlay");return d(),te(a,{class:"transparent"},{default:re(()=>[ya]),_:1})}var Xt=oe(_a,[["render",wa]]),va="/assets/click.bb97cb07.mp3",Ea=Object.freeze(Object.defineProperty({__proto__:null,default:va},Symbol.toStringTag,{value:"Module"})),Pa="/assets/click2.98536db5.mp3",ba=Object.freeze(Object.defineProperty({__proto__:null,default:Pa},Symbol.toStringTag,{value:"Module"})),Ta="/assets/Oak-none-3275x2565mm-Architextures.cc917130.jpg",$a=Object.freeze(Object.defineProperty({__proto__:null,default:Ta},Symbol.toStringTag,{value:"Module"})),Sa="/assets/wood-dark.1e21ffc1.jpg",Ca=Object.freeze(Object.defineProperty({__proto__:null,default:Sa},Symbol.toStringTag,{value:"Module"})),ka="/assets/wood-light.ae1bd383.jpg",Aa=Object.freeze(Object.defineProperty({__proto__:null,default:ka},Symbol.toStringTag,{value:"Module"})),Oa="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",Na=Object.freeze(Object.defineProperty({__proto__:null,default:Oa},Symbol.toStringTag,{value:"Module"})),Ua="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",Ra=Object.freeze(Object.defineProperty({__proto__:null,default:Ua},Symbol.toStringTag,{value:"Module"})),La="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Va=Object.freeze(Object.defineProperty({__proto__:null,default:La},Symbol.toStringTag,{value:"Module"})),Ma="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",za=Object.freeze(Object.defineProperty({__proto__:null,default:Ma},Symbol.toStringTag,{value:"Module"}));const Da=e=>{let t=!1;const s=()=>{t=!0},n=e.fps||60,i=e.slow||1,r=e.update,a=e.render,u=window.requestAnimationFrame,m=1/n,g=i*m;let O,D=0,P=window.performance.now();const y=()=>{for(O=window.performance.now(),D=D+Math.min(1,(O-P)/1e3);D>g;)D=D-g,r(m);a(D/i),P=O,t||u(y)};return u(y),{stop:s}};let Ro=.1;const Ga=6,Ia=.05;class Lt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}calculateZoomCapping(t,s,n,i){Ro=Math.max(.1,t/n,s/i)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,s){this.x+=t/this.curZoom,this.y+=s/this.curZoom}calculateNewZoom(t){const s=t==="in"?1:-1,n=this.curZoom+Ia*this.curZoom*s;return Math.min(Math.max(n,Ro),Ga)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,s){if(this.curZoom==t)return!1;const n=1-this.curZoom/t;return this.move(-s.x*n,-s.y*n),this.curZoom=t,!0}zoom(t,s){return this.setZoom(this.calculateNewZoom(t),s)}viewportToWorld(t){const{x:s,y:n}=this.viewportToWorldRaw(t);return{x:Math.round(s),y:Math.round(n)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:s,y:n}=this.worldToViewportRaw(t);return{x:Math.round(s),y:Math.round(n)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:s,h:n}=this.worldDimToViewportRaw(t);return{w:Math.round(s),h:Math.round(n)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:s,h:n}=this.viewportDimToWorldRaw(t);return{w:Math.round(s),h:Math.round(n)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function qe(e=0,t=0){const s=document.createElement("canvas");return s.width=e,s.height=t,s}async function Ba(e){return new Promise(t=>{const s=new Image;s.onload=()=>{createImageBitmap(s).then(t)},s.src=e})}async function xa(e,t,s){const n=qe(t,s);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,s),await createImageBitmap(n)}function Ya(e,t,s){if(s==="ukraine"){const r=qe(e.width,e.height),a=r.getContext("2d"),u=t.height/1.75;a.save(),a.drawImage(t,0,0),a.fillStyle="#0057B7",a.globalCompositeOperation="source-in",a.fillRect(0,0,t.width,u),a.restore(),a.save(),a.globalCompositeOperation="destination-over",a.drawImage(e,0,0),a.restore();const m=qe(e.width,e.height/2),g=m.getContext("2d");return g.save(),g.drawImage(t,0,-u),g.fillStyle="#FFDD00",g.globalCompositeOperation="source-in",g.fillRect(0,0,t.width,t.height),g.restore(),g.save(),g.globalCompositeOperation="destination-over",g.drawImage(e,0,-u),g.restore(),a.drawImage(m,0,u),r}const n=qe(e.width,e.height),i=n.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=s,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),n}var de={createCanvas:qe,loadImageToBitmap:Ba,resizeBitmap:xa,colorizedCanvas:Ya};const Wa=It("Debug.js");let Vt=0,rs=0;const Fa=e=>{Vt=performance.now(),rs=e},Za=e=>{const t=performance.now(),s=t-Vt;s>rs&&Wa.log(e+": "+s),Vt=t};var Ae={checkpoint_start:Fa,checkpoint:Za};function Ha(e,t){return{x:e.x-t.x,y:e.y-t.y}}function ja(e,t){return{x:e.x+t.x,y:e.y+t.y}}function as(e,t){const s=e.x-t.x,n=e.y-t.y;return Math.sqrt(s*s+n*n)}function Ka(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Mt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function qa(e,t,s){return{x:e.x+t,y:e.y+s,w:e.w,h:e.h}}function Xa(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function Qa(e,t){return as(Mt(e),Mt(t))}var Q={pointSub:Ha,pointAdd:ja,pointDistance:as,pointInBounds:Ka,rectCenter:Mt,rectMoved:qa,rectCenterDistance:Qa,rectsOverlap:Xa};const Lo=It("PuzzleGraphics.js");async function Ja(e,t,s){Lo.log("start createPuzzleTileBitmaps");const n=s.tileSize,i=s.tileMarginWidth,r=s.tileDrawSize,a=n/100,u=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],m=new Array(t.length),g={};function O(E){const Y=`${E.top}${E.right}${E.left}${E.bottom}`;if(g[Y])return g[Y];const L=new Path2D,S={x:i,y:i},C=Q.pointAdd(S,{x:n,y:0}),b=Q.pointAdd(C,{x:0,y:n}),N=Q.pointSub(b,{x:n,y:0});if(L.moveTo(S.x,S.y),E.top!==0)for(let h=0;h<u.length/6;h++){const se=Q.pointAdd(S,{x:u[h*6+0]*a,y:E.top*u[h*6+1]*a}),H=Q.pointAdd(S,{x:u[h*6+2]*a,y:E.top*u[h*6+3]*a}),ne=Q.pointAdd(S,{x:u[h*6+4]*a,y:E.top*u[h*6+5]*a});L.bezierCurveTo(se.x,se.y,H.x,H.y,ne.x,ne.y)}else L.lineTo(C.x,C.y);if(E.right!==0)for(let h=0;h<u.length/6;h++){const se=Q.pointAdd(C,{x:-E.right*u[h*6+1]*a,y:u[h*6+0]*a}),H=Q.pointAdd(C,{x:-E.right*u[h*6+3]*a,y:u[h*6+2]*a}),ne=Q.pointAdd(C,{x:-E.right*u[h*6+5]*a,y:u[h*6+4]*a});L.bezierCurveTo(se.x,se.y,H.x,H.y,ne.x,ne.y)}else L.lineTo(b.x,b.y);if(E.bottom!==0)for(let h=0;h<u.length/6;h++){const se=Q.pointSub(b,{x:u[h*6+0]*a,y:E.bottom*u[h*6+1]*a}),H=Q.pointSub(b,{x:u[h*6+2]*a,y:E.bottom*u[h*6+3]*a}),ne=Q.pointSub(b,{x:u[h*6+4]*a,y:E.bottom*u[h*6+5]*a});L.bezierCurveTo(se.x,se.y,H.x,H.y,ne.x,ne.y)}else L.lineTo(N.x,N.y);if(E.left!==0)for(let h=0;h<u.length/6;h++){const se=Q.pointSub(N,{x:-E.left*u[h*6+1]*a,y:u[h*6+0]*a}),H=Q.pointSub(N,{x:-E.left*u[h*6+3]*a,y:u[h*6+2]*a}),ne=Q.pointSub(N,{x:-E.left*u[h*6+5]*a,y:u[h*6+4]*a});L.bezierCurveTo(se.x,se.y,H.x,H.y,ne.x,ne.y)}else L.lineTo(S.x,S.y);return g[Y]=L,L}const D=de.createCanvas(r,r),P=D.getContext("2d"),y=de.createCanvas(r,r),k=y.getContext("2d");for(const E of t){const Y=B.decodePiece(E),L=eu(s,Y.idx),S=O(B.decodeShape(s.shapes[Y.idx]));P.clearRect(0,0,r,r),P.save(),P.lineWidth=2,P.stroke(S),P.globalCompositeOperation="source-in",P.drawImage(e,L.x-i,L.y-i,r,r,0,0,r,r),P.restore(),P.save(),P.globalCompositeOperation="source-in",P.globalAlpha=.2,P.fillStyle="black",P.fillRect(0,0,D.width,D.height),P.restore(),P.save(),P.clip(S),P.drawImage(e,L.x-i,L.y-i,r,r,0,0,r,r),P.restore(),P.save(),P.clip(S),P.strokeStyle="rgba(0,0,0,.4)",P.lineWidth=0,P.shadowColor="black",P.shadowBlur=2,P.shadowOffsetX=-1,P.shadowOffsetY=-1,P.stroke(S),P.restore(),P.save(),P.clip(S),P.strokeStyle="rgba(255,255,255,.4)",P.lineWidth=0,P.shadowColor="white",P.shadowBlur=2,P.shadowOffsetX=1,P.shadowOffsetY=1,P.stroke(S),P.restore(),k.clearRect(0,0,r,r),k.save(),k.lineWidth=1,k.stroke(S),k.globalCompositeOperation="source-in",k.drawImage(e,L.x-i,L.y-i,r,r,0,0,r,r),k.restore(),P.drawImage(y,0,0),m[Y.idx]=await createImageBitmap(D)}return Lo.log("end createPuzzleTileBitmaps"),m}function eu(e,t){const s=B.coordByPieceIdxDeprecated(e,t);return{x:s.x*e.tileSize,y:s.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function tu(e){const t=await de.loadImageToBitmap(e.info.imageUrl),s=await de.resizeBitmap(t,e.info.width,e.info.height);return await Ja(s,e.tiles,e.info)}var ou={loadPuzzleBitmaps:tu};const us=30,T={};function su(e){return!!T[e]||!1}function nu(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function iu(e,t){T[e]=t}function lu(e){delete T[e]}function ht(e,t){let s=0;for(const n of T[e].players){if(B.decodePlayer(n).id===t)return s;s++}return-1}function ru(e,t){return T[e].players.length>t?B.decodePlayer(T[e].players[t]).id:null}function Me(e,t){const s=ht(e,t);return s===-1?null:B.decodePlayer(T[e].players[s])}function Qt(e,t,s){const n=ht(e,t);n===-1?T[e].players.push(B.encodePlayer(s)):T[e].players[n]=B.encodePlayer(s)}function au(e,t,s){T[e].puzzle.tiles[t]=B.encodePiece(s)}function uu(e,t){T[e].puzzle.data=t}function cs(e,t){return ht(e,t)!==-1}function cu(e,t){return ws(T[e],t)}function du(e,t){return xu(T[e],t)}function hu(e,t,s){cs(e,t)?le(e,t,{ts:s}):Qt(e,t,nu(t,s))}function pu(e){return T[e]||null}function zt(e){return no(T[e])}function gu(e){return vs(T[e])}function Et(e){return T[e].scoreMode}function ds(e){return T[e].snapMode}function hs(e){return T[e].gameVersion}function Dt(e){return so(T[e])}function fu(e){return T[e].puzzle.tiles.map(B.decodePiece).sort((s,n)=>s.z-n.z)}function le(e,t,s){const n=Me(e,t);if(n!==null){for(const i of Object.keys(s))n[i]=s[i];Qt(e,t,n)}}function st(e,t){for(const s of Object.keys(t))T[e].puzzle.data[s]=t[s]}function Ve(e,t,s){for(const n of Object.keys(s)){const i=B.decodePiece(T[e].puzzle.tiles[t]);i[n]=s[n],T[e].puzzle.tiles[t]=B.encodePiece(i)}}const ze=(e,t)=>B.decodePiece(T[e].puzzle.tiles[t]),ct=(e,t)=>ze(e,t).group,mu=(e,t)=>{const s=T[e].puzzle.info;return t===0||t===s.tilesX-1||t===s.tiles-s.tilesX||t===s.tiles-1},ps=(e,t)=>{const s=T[e].puzzle.info,n={x:(s.table.width-s.width)/2,y:(s.table.height-s.height)/2},i=Tu(e,t);return Q.pointAdd(n,i)},rt=(e,t)=>ze(e,t).pos,Jt=e=>hs(e)<=3?yu(e):_u(e),_u=e=>({x:0,y:0,w:to(e),h:oo(e)}),yu=e=>{const t=to(e),s=oo(e),n=Math.round(t/4),i=Math.round(s/4);return{x:0-n,y:0-i,w:t+2*n,h:s+2*i}},wu=(e,t)=>ze(e,t).z,He=(e,t)=>{for(const s of T[e].puzzle.tiles){const n=B.decodePiece(s);if(n.owner===t)return n.idx}return-1},vu=(e,t)=>{const s=He(e,t);return s<0?null:T[e].puzzle.tiles[s]},gs=e=>T[e].puzzle.info.tileDrawOffset,eo=e=>T[e].puzzle.info.tileDrawSize,Eu=e=>ms(T[e]),Pu=e=>_s(T[e]),Vo=e=>T[e].puzzle.data.maxGroup,Mo=e=>T[e].puzzle.data.maxZ,bu=(e,t)=>{let s=0;for(const n of t){const i=wu(e,n);i>s&&(s=i)}return s};function Tu(e,t){const s=T[e].puzzle.info,n=B.coordByPieceIdxDeprecated(s,t),i=n.x*s.tileSize,r=n.y*s.tileSize;return{x:i,y:r}}function $u(e,t){const s=T[e].puzzle.info,n=B.coordByPieceIdxDeprecated(s,t);return[n.y>0?t-s.tilesX:-1,n.x<s.tilesX-1?t+1:-1,n.y<s.tilesY-1?t+s.tilesX:-1,n.x>0?t-1:-1]}const zo=(e,t,s)=>{for(const n of t)Ve(e,n,{z:s})},fs=(e,t,s)=>{const n=rt(e,t),i=Q.pointAdd(n,s);Ve(e,t,{pos:i})},nt=(e,t,s)=>hs(e)>=3?Cu(e,t,s):Su(e,t,s),Su=(e,t,s)=>{const n=eo(e),i=Jt(e),r=s;for(const a of t){const u=ze(e,a);u.pos.x+s.x<i.x?r.x=Math.max(i.x-u.pos.x,r.x):u.pos.x+n+s.x>i.x+i.w&&(r.x=Math.min(i.x+i.w-u.pos.x+n,r.x)),u.pos.y+s.y<i.y?r.y=Math.max(i.y-u.pos.y,r.y):u.pos.y+n+s.y>i.y+i.h&&(r.y=Math.min(i.y+i.h-u.pos.y+n,r.y))}if(!r.x&&!r.y)return!1;for(const a of t)fs(e,a,r);return!0},Cu=(e,t,s)=>{const n=Jt(e),i=eo(e)+2*gs(e),r=n.x,a=n.y,u=r+n.w-i,m=a+n.h-i,g=s;for(const O of t){const D=ze(e,O);s.x<0?g.x=Math.max(r-D.pos.x,g.x):g.x=Math.min(u-D.pos.x,g.x),s.y<0?g.y=Math.max(a-D.pos.y,g.y):g.y=Math.min(m-D.pos.y,g.y)}if(!g.x&&!g.y)return!1;for(const O of t)fs(e,O,g);return!0},ku=(e,t)=>Au(e,t)===-1,Au=(e,t)=>ze(e,t).owner,Do=(e,t)=>{for(const s of t)Ve(e,s,{owner:-1,z:1})},Pt=(e,t,s)=>{for(const n of t)Ve(e,n,{owner:s})};function Ou(e,t){return be(e,t).length}function be(e,t){const s=T[e].puzzle.tiles,n=B.decodePiece(s[t]),i=[];if(n.group)for(const r of s){const a=B.decodePiece(r);a.group===n.group&&i.push(a.idx)}else i.push(n.idx);return i}const Nu=(e,t)=>{const s=T[e].puzzle.info,n=T[e].puzzle.tiles;let i=-1,r=-1;for(let a=0;a<n.length;a++){const u=B.decodePiece(n[a]);if(u.owner!==0)continue;const m={x:u.pos.x,y:u.pos.y,w:s.tileSize,h:s.tileSize};Q.pointInBounds(t,m)&&(i===-1||u.z>i)&&(i=u.z,r=a)}return r},Uu=(e,t)=>{const s=Me(e,t);return s?s.bgcolor:null},Ru=(e,t)=>{const s=Me(e,t);return s?s.color:null},Lu=(e,t)=>{const s=Me(e,t);return s?s.name:null},Go=(e,t)=>{const s=Me(e,t);return s?s.points:0},Vu=(e,t,s)=>{const n=ct(e,t),i=ct(e,s);return!!(n&&n===i)},to=e=>T[e].puzzle.info.table.width,oo=e=>T[e].puzzle.info.table.height,Mu=e=>T[e].puzzle,zu=e=>T[e].rng.obj,Du=e=>T[e].puzzle.info.width,Gu=e=>T[e].puzzle.info.height,Iu=(e,t)=>{if(ds(e)===xe.REAL){for(const s of t)if(mu(e,s))return!0;return!1}return!0};function Bu(e,t,s,n){const i=T[e].puzzle,r=[],a=()=>{r.push([p.CHANGE_DATA,i.data])},u=y=>{r.push([p.CHANGE_PIECE,B.encodePiece(ze(e,y))])},m=y=>{for(const k of y)u(k)},g=()=>{const y=Me(e,t);!y||r.push([p.CHANGE_PLAYER,B.encodePlayer(y)])};let O=!1;const D=(y,k,E)=>{const Y=T[y].puzzle.tiles,L=ct(y,k),S=ct(y,E);let C;const b=[];if(L&&b.push(L),S&&b.push(S),L)C=L;else if(S)C=S;else{const N=Vo(y)+1;st(y,{maxGroup:N}),a(),C=Vo(y)}if(Ve(y,k,{group:C}),u(k),Ve(y,E,{group:C}),u(E),b.length>0)for(const N of Y){const h=B.decodePiece(N);b.includes(h.group)&&(Ve(y,h.idx,{group:C}),u(h.idx))}},P=s[0];if(P===p.INPUT_EV_CONNECTION_CLOSE){const y=He(e,t);if(y>=0){const k=be(e,y);Pt(e,k,0),m(k)}}else if(P===p.INPUT_EV_BG_COLOR){const y=s[1];le(e,t,{bgcolor:y,ts:n}),g()}else if(P===p.INPUT_EV_PLAYER_COLOR){const y=s[1];le(e,t,{color:y,ts:n}),g()}else if(P===p.INPUT_EV_PLAYER_NAME){const y=`${s[1]}`.substr(0,16);le(e,t,{name:y,ts:n}),g()}else if(P===p.INPUT_EV_MOVE){const y=s[1],k=s[2],E=Me(e,t);if(E){const Y=E.x-y,L=E.y-k;le(e,t,{ts:n,x:Y,y:L}),g();const S=He(e,t);if(S>=0){const C=be(e,S),b={x:-y,y:-k};nt(e,C,b)&&m(C)}}}else if(P===p.INPUT_EV_MOUSE_DOWN){const y=s[1],k=s[2],E={x:y,y:k};le(e,t,{d:1,ts:n}),g();const Y=Nu(e,E);if(Y>=0){const L=Mo(e)+1;st(e,{maxZ:L}),a();const S=be(e,Y);zo(e,S,Mo(e)),Pt(e,S,t),m(S)}}else if(P===p.INPUT_EV_MOUSE_MOVE){const y=s[1],k=s[2];if(!s[5])le(e,t,{x:y,y:k,ts:n}),g();else{const Y=He(e,t);if(Y<0)le(e,t,{ts:n}),g();else{const L=s[1],S=s[2],C=s[3],b=s[4];le(e,t,{x:L,y:S,ts:n}),g();const N=be(e,Y);nt(e,N,{x:C,y:b})&&m(N)}}}else if(P===p.INPUT_EV_MOUSE_UP){const k=He(e,t);if(k>=0){const E=be(e,k);Pt(e,E,0),m(E);const Y=rt(e,k),L=ps(e,k);if(Iu(e,E)&&Q.pointDistance(L,Y)<i.info.snapDistance){const S=Q.pointSub(L,Y);nt(e,E,S),Do(e,E),m(E);let C=Go(e,t);Et(e)===Le.FINAL?C+=E.length:Et(e)===Le.ANY&&(C+=1),le(e,t,{d:0,ts:n,points:C}),g(),Dt(e)===zt(e)&&(st(e,{finished:n}),a()),O=!0}else{const S=(b,N,h,se)=>{const H=T[b].puzzle.info;if(h<0||Vu(b,N,h))return!1;const ne=rt(b,N),$e=Q.pointAdd(rt(b,h),{x:se[0]*H.tileSize,y:se[1]*H.tileSize});if(Q.pointDistance(ne,$e)<H.snapDistance){const ke=Q.pointSub($e,ne);let ge=be(b,N);if(nt(b,ge,ke),D(b,N,h),ge=be(b,N),ku(b,h))Do(b,ge);else{const De=bu(b,ge);zo(b,ge,De)}return m(ge),!0}return!1};let C=!1;for(const b of be(e,k)){const N=$u(e,b);if(S(e,b,N[0],[0,1])||S(e,b,N[1],[-1,0])||S(e,b,N[2],[0,-1])||S(e,b,N[3],[1,0])){C=!0;break}}if(C&&Et(e)===Le.ANY){const b=Go(e,t)+1;le(e,t,{d:0,ts:n,points:b}),g()}else le(e,t,{d:0,ts:n}),g();C&&ds(e)===xe.REAL&&Dt(e)===zt(e)&&(st(e,{finished:n}),a()),C&&(O=!0)}}else le(e,t,{d:0,ts:n}),g()}else if(P===p.INPUT_EV_ZOOM_IN){const y=s[1],k=s[2];le(e,t,{x:y,y:k,ts:n}),g()}else if(P===p.INPUT_EV_ZOOM_OUT){const y=s[1],k=s[2];le(e,t,{x:y,y:k,ts:n}),g()}else le(e,t,{ts:n}),g();return O&&r.push([p.PLAYER_SNAP,t]),r}function ms(e){return e.puzzle.data.started}function _s(e){return e.puzzle.data.finished}function so(e){let t=0;for(const s of e.puzzle.tiles)B.decodePiece(s).owner===-1&&t++;return t}function no(e){return e.puzzle.tiles.length}function ys(e){return e.players.map(B.decodePlayer)}function ws(e,t){const s=t-us*Te.SEC;return ys(e).filter(n=>n.ts>=s)}function xu(e,t){const s=t-us*Te.SEC;return ys(e).filter(n=>n.ts<s&&n.points>0)}function vs(e){var s;const t=((s=e.puzzle.info.image)==null?void 0:s.url)||e.puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Yu(e){return so(e)===no(e)}var M={setGame:iu,unsetGame:lu,loaded:su,playerExists:cs,getActivePlayers:cu,getIdlePlayers:du,addPlayer:hu,getFinishedPiecesCount:Dt,getPieceCount:zt,getImageUrl:gu,get:pu,getGroupedPieceCount:Ou,getPlayerBgColor:Uu,getPlayerColor:Ru,getPlayerName:Lu,getPlayerIndexById:ht,getPlayerIdByIndex:ru,changePlayer:le,setPlayer:Qt,setPiece:au,setPuzzleData:uu,getBounds:Jt,getTableWidth:to,getTableHeight:oo,getPuzzle:Mu,getRng:zu,getPuzzleWidth:Du,getPuzzleHeight:Gu,getPiecesSortedByZIndex:fu,getFirstOwnedPiece:vu,getPieceDrawOffset:gs,getPieceDrawSize:eo,getFinalPiecePos:ps,getStartTs:Eu,getFinishTs:Pu,handleInput:Bu,Game_getStartTs:ms,Game_getFinishTs:_s,Game_getFinishedPiecesCount:so,Game_getPieceCount:no,Game_getActivePlayers:ws,Game_getImageUrl:vs,Game_isFinished:Yu};let Es=-10,Ps=20,Gt=2,bs=15;const Wu=5,Fu=5,io=1,Zu=200,Io=10,Hu=100,ju=10,Ku=1,qu=5;function Xu(e){const t=e.random(0,255),s=e.random(0,255),n=e.random(0,255);return"rgba("+t+","+s+","+n+", 0.8)"}class Bo{constructor(t){this.radius=Io,this.previousRadius=Io,this.explodingDuration=Hu,this.hasExploded=!1,this.alive=!0,this.color=Xu(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Es+Math.random()*Ps,this.vy=(Gt+Math.random()*bs)*-1,this.duration=0}update(t){if(this.hasExploded){const s=Zu-this.radius;this.previousRadius=this.radius,this.radius+=s/ju,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=io,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const s=3+Math.floor(Math.random()*3);for(let n=0;n<s;n++){const i=10+Math.floor(Math.random()*21),r=Wu+Math.random()*Fu,a=2*Math.PI/i,u=Math.random()*a;for(let m=0;m<i;m++)t.push(new Qu(this,m*a+u,r))}}}class Qu{constructor(t,s,n){this.px=t.px,this.py=t.py,this.vx=Math.cos(s)*n,this.vy=Math.sin(s)*n,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=io/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class Ju{constructor(t,s){this.canvas=t,this.rng=s,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,s=0;for(;t<this.canvas.height&&s>=0;)s+=io,t+=s;Gt=s/2,bs=s-Gt;const n=1/4*this.canvas.width/(s/2);Es=-n,Ps=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<Ku;t++)this.readyBombs.push(new Bo(this.rng))}update(){Math.random()*100<qu&&this.readyBombs.push(new Bo(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const s=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):s.push(i)}this.readyBombs=s;const n=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&n.push(i)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function ec(e,t,s,n){let i=[],r=!0,a=!1,u=!1,m=!1,g=!1,O=!1,D=!1,P=!1;const y=(v,G)=>{const A=s.viewportToWorld({x:v,y:G});return[A.x,A.y]},k=(v,G)=>{const A=s.viewportDimToWorld({w:v,h:G});return[A.w,A.h]},E=v=>y(v.offsetX,v.offsetY),Y=()=>y(e.width/2,e.height/2),L=(v,G)=>{!r||(G.code==="ShiftLeft"||G.code==="ShiftRight"?P=v:G.code==="ArrowUp"||G.code==="KeyW"?m=v:G.code==="ArrowDown"||G.code==="KeyS"?g=v:G.code==="ArrowLeft"||G.code==="KeyA"?a=v:G.code==="ArrowRight"||G.code==="KeyD"?u=v:G.code==="KeyQ"?D=v:G.code==="KeyE"&&(O=v))};let S=!1,C=null,b=null;const N=v=>{b=E(v),C=[v.offsetX,v.offsetY],v.button===0&&(S=!0,q([p.INPUT_EV_MOUSE_DOWN,...b]))},h=v=>{b=E(v),C=[v.offsetX,v.offsetY],v.button===0&&(S=!1,q([p.INPUT_EV_MOUSE_UP,...b]))},se=v=>{if(!C)return;b=E(v);const G=k(-(C[0]-v.offsetX),-(C[1]-v.offsetY));q([p.INPUT_EV_MOUSE_MOVE,...b,...G,S?1:0]),C=[v.offsetX,v.offsetY]},H=v=>{if(b=E(v),s.canZoom(v.deltaY<0?"in":"out")){const G=v.deltaY<0?p.INPUT_EV_ZOOM_IN:p.INPUT_EV_ZOOM_OUT;q([G,...b])}},ne=v=>L(!0,v),$e=v=>L(!1,v),ke=v=>{if(!!r){if(n===Ee&&(v.code==="KeyI"?q([p.INPUT_EV_REPLAY_SPEED_UP]):v.code==="KeyO"?q([p.INPUT_EV_REPLAY_SPEED_DOWN]):v.code==="KeyP"&&q([p.INPUT_EV_REPLAY_TOGGLE_PAUSE])),v.code==="KeyH")q([p.INPUT_EV_TOGGLE_INTERFACE]);else if(v.code==="Space")q([p.INPUT_EV_TOGGLE_PREVIEW]);else if(v.code==="KeyF")q([p.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(v.code==="KeyG")q([p.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(v.code==="KeyM")q([p.INPUT_EV_TOGGLE_SOUNDS]);else if(v.code==="KeyN")q([p.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(v.code==="KeyT")q([p.INPUT_EV_TOGGLE_TABLE]);else if(v.code==="KeyC")q([p.INPUT_EV_CENTER_FIT_PUZZLE]);else for(let G=0;G<=9;G++)if(v.code===`Digit${G}`){const A=v.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;q([A,G]);break}}},ge=()=>{e.addEventListener("mousedown",N),e.addEventListener("mouseup",h),e.addEventListener("mousemove",se),e.addEventListener("wheel",H),t.addEventListener("keydown",ne),t.addEventListener("keyup",$e),t.addEventListener("keypress",ke)},De=()=>{e.removeEventListener("mousedown",N),e.removeEventListener("mouseup",h),e.removeEventListener("mousemove",se),e.removeEventListener("wheel",H),t.removeEventListener("keydown",ne),t.removeEventListener("keyup",$e),t.removeEventListener("keypress",ke)},Ye=(v,G)=>{if(!C||!b)return;const A=new Lt(v).viewportToWorld({x:C[0],y:C[1]}),ve=new Lt(G).viewportToWorld({x:C[0],y:C[1]}),ue=[-(A.x-ve.x),-(A.y-ve.y)];q([p.INPUT_EV_MOUSE_MOVE,...b,...ue,S?1:0])},q=v=>{i.push(v)};return{registerEvents:ge,unregisterEvents:De,addEvent:q,consumeAll:()=>{if(i.length===0)return[];const v=i.slice();return i=[],v},createKeyEvents:()=>{const v=(a?1:0)-(u?1:0),G=(m?1:0)-(g?1:0);if(v!==0||G!==0){const A=(P?24:12)*Math.sqrt(s.getCurrentZoom()),ve=s.viewportDimToWorld({w:v*A,h:G*A});q([p.INPUT_EV_MOVE,ve.w,ve.h]),b&&(b[0]-=ve.w,b[1]-=ve.h)}if(!(O&&D)){if(O){if(s.canZoom("in")){const A=b||Y();q([p.INPUT_EV_ZOOM_IN,...A])}}else if(D&&s.canZoom("out")){const A=b||Y();q([p.INPUT_EV_ZOOM_OUT,...A])}}},createSnapshotEvents:Ye,setHotkeys:v=>{r=v}}}const it={"./grab.png":Na,"./grab_mask.png":Ra,"./hand.png":Va,"./hand_mask.png":za},bt={"./assets/textures/Oak-none-3275x2565mm-Architextures.jpg":$a,"./assets/textures/wood-dark.jpg":Ca,"./assets/textures/wood-light.jpg":Aa},xo={"./click.mp3":Ea,"./click2.mp3":ba},je="play",Ee="replay";let Oe=!0,Ne=!0;const tc=e=>e.owner===-1?Oe:Ne;let J=!0;async function Ts(e,t,s,n,i,r){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const a=l=>n===Ee||l.id!==t,u=xo["./click.mp3"].default,m=xo["./click2.mp3"].default,g=new Audio(u),O=new Audio(m),D=await de.loadImageToBitmap(it["./grab.png"].default),P=await de.loadImageToBitmap(it["./hand.png"].default),y=await de.loadImageToBitmap(it["./grab_mask.png"].default),k=await de.loadImageToBitmap(it["./hand_mask.png"].default),E=D.width,Y=Math.round(E/2),L=D.height,S=Math.round(L/2),C={},b=async l=>{const c=l.color+" "+l.d;if(!C[c]){const w=l.d?D:P;if(l.color){const I=l.d?y:k;C[c]=await createImageBitmap(de.colorizedCanvas(w,I,l.color))}else C[c]=w}return C[c]},N=i,h={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Ce.onConnectionStateChange(l=>{r.emit("connectionState",l)});const se=async l=>{const c=h.dataOffset;h.dataOffset+=1e4;const w=await Ce.requestReplayData(l,c);return h.log=h.log.slice(h.logPointer),h.logPointer=0,h.log.push(...w.log),w.log.length===0&&(h.final=!0),w};let H=()=>0;const ne=async()=>{if(n===je){const l=await Ce.connect(s,e,t),c=B.decodeGame(l);M.setGame(c.id,c),H=()=>Te.timestamp()}else if(n===Ee){const l=await se(e);if(!l.game)throw"[ 2021-05-29 no game received ]";const c=B.decodeGame(l.game);M.setGame(c.id,c),h.lastRealTs=Te.timestamp(),h.gameStartTs=parseInt(l.log[0][4],10),h.lastGameTs=h.gameStartTs,H=()=>h.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";J=!0};await ne();const $e=M.getPieceDrawOffset(e),ke=M.getPieceDrawSize(e),ge=M.getPuzzleWidth(e),De=M.getPuzzleHeight(e),Ye=M.getTableWidth(e),q=M.getTableHeight(e),lo={x:(Ye-ge)/2,y:(q-De)/2},pt={w:ge,h:De},ro={w:ke,h:ke},v=await ou.loadPuzzleBitmaps(M.getPuzzle(e)),G=new Ju(N,M.getRng(e));G.init();const A=N.getContext("2d");N.classList.add("loaded"),r.emit("puzzleCut");let ve="";const ue={},R=new Lt;R.calculateZoomCapping(window.innerWidth,window.innerHeight,Ye,q);const Cs=()=>{R.reset(),R.move(-(Ye-N.width)/2,-(q-N.height)/2);const l=R.worldDimToViewportRaw(pt),c=20,w=N.width-c*2,I=N.height-c*2;if(l.w>w||l.h>I||l.w<w&&l.h<I){const x=Math.min(w/l.w,I/l.h),W={x:N.width/2,y:N.height/2};R.setZoom(x,W)}},ce=ec(N,window,R,n);ce.registerEvents();const Qe=l=>{if(ue.last&&ve===l){const c=R.snapshot(),w=ue.last;return R.fromSnapshot(w),ce.createSnapshotEvents(c,w),delete ue.last,"last"}else if(ue[l]){const c=ue[l],w=R.snapshot();return ue.last=w,ve=l,R.fromSnapshot(c),ce.createSnapshotEvents(w,c),l}else return null};Cs(),ue.center=R.snapshot();const ks=M.getImageUrl(e),Je=l=>{const c=M.getStartTs(e),w=M.getFinishTs(e);r.emit("status",{finished:!!w,duration:(w||l)-c,piecesDone:M.getFinishedPiecesCount(e),piecesTotal:M.getPieceCount(e)}),r.emit("players",{active:M.getActivePlayers(e,l),idle:M.getIdlePlayers(e,l)})};Je(H());const ao=!!M.getFinishTs(e);let gt=ao;const uo=()=>gt&&!ao,ft=()=>K.getInt(X.SOUND_VOLUME,pe.SOUND_VOLUME),co=()=>K.getBool(X.OTHER_PLAYER_CLICK_SOUND_ENABLED,pe.OTHER_PLAYER_CLICK_SOUND_ENABLED),mt=()=>K.getBool(X.SOUND_ENABLED,pe.SOUND_ENABLED),ho=()=>K.getBool(X.SHOW_PLAYER_NAMES,pe.SHOW_PLAYER_NAMES),As=()=>K.getBool(X.SHOW_TABLE,pe.SHOW_TABLE),Os=()=>K.getStr(X.TABLE_TEXTURE,pe.TABLE_TEXTURE),po=()=>n===Ee?K.getStr(X.COLOR_BACKGROUND,pe.COLOR_BACKGROUND):M.getPlayerBgColor(e,t)||K.getStr(X.COLOR_BACKGROUND,pe.COLOR_BACKGROUND),go=()=>n===Ee?K.getStr(X.PLAYER_COLOR,pe.PLAYER_COLOR):M.getPlayerColor(e,t)||K.getStr(X.PLAYER_COLOR,pe.PLAYER_COLOR),Ns=()=>n===Ee?K.getStr(X.PLAYER_NAME,pe.PLAYER_NAME):M.getPlayerName(e,t)||K.getStr(X.PLAYER_NAME,pe.PLAYER_NAME),fo=()=>{const l=ft();g.volume=l/100,g.play()},Us=()=>{const l=ft();O.volume=l/100,O.play()},z={background:po(),showTable:As(),tableTexture:Os(),color:go(),name:Ns(),soundsEnabled:mt(),otherPlayerClickSoundEnabled:co(),soundsVolume:ft(),showPlayerNames:ho()};ce.addEvent([p.INPUT_EV_BG_COLOR,z.background]),ce.addEvent([p.INPUT_EV_PLAYER_COLOR,z.color]),ce.addEvent([p.INPUT_EV_PLAYER_NAME,z.name]);let mo="",_o="",yo=!1;const We=l=>{yo=l;const[c,w]=l?[mo,"grab"]:[_o,"default"];N.style.cursor=`url('${c}') ${Y} ${S}, ${w}`},_t=l=>{mo=de.colorizedCanvas(D,y,l).toDataURL(),_o=de.colorizedCanvas(P,k,l).toDataURL(),We(yo)};_t(go());const et=()=>{r.emit("replaySpeed",h.speeds[h.speedIdx]),r.emit("replayPaused",h.paused)},j=(l,c=void 0)=>{r.emit("statusMessage",{what:l,value:c})},wo=()=>{h.speedIdx+1<h.speeds.length&&(h.speedIdx++,et(),j("Speed Up"))},vo=()=>{h.speedIdx>=1&&(h.speedIdx--,et(),j("Speed Down"))},Eo=()=>{h.paused=!h.paused,et(),j(h.paused?"Paused":"Playing")};let tt=!0;const Po=()=>{tt=!tt,r.emit("toggleInterface",tt),j("Interface",tt)};let Fe=!1;const bo=()=>{Fe=!Fe,r.emit("togglePreview",Fe)},To=()=>{z.soundsEnabled=!z.soundsEnabled;const l=z.soundsEnabled;r.emit("toggleSoundsEnabled",l),K.setBool(X.SOUND_ENABLED,l),j("Sounds",l)},$o=()=>{z.showPlayerNames=!z.showPlayerNames;const l=z.showPlayerNames;r.emit("togglePlayerNames",l),K.setBool(X.SHOW_PLAYER_NAMES,l),j("Player names",l)},So=()=>{z.showTable=!z.showTable;const l=z.showTable;r.emit("toggleShowTable",l),K.setBool(X.SHOW_TABLE,l),j("Table",l)};r.on("replayOnSpeedUp",()=>{wo()}),r.on("replayOnSpeedDown",()=>{vo()}),r.on("replayOnPauseToggle",()=>{Eo()}),r.on("onPreviewChange",l=>{Fe!==l&&(Fe=l)}),r.on("onBgChange",l=>{z.background!==l&&(z.background=l,K.setStr(X.COLOR_BACKGROUND,l),ce.addEvent([p.INPUT_EV_BG_COLOR,l]),j("Background",l))}),r.on("onTableTextureChange",l=>{z.tableTexture!==l&&(z.tableTexture=l,K.setStr(X.TABLE_TEXTURE,l),j("Table texture",l),J=!0)}),r.on("onShowTableChange",l=>{z.showTable!==l&&(z.showTable=l,K.setStr(X.SHOW_TABLE,l),j("Table",l),J=!0)}),r.on("onColorChange",l=>{z.color!==l&&(z.color=l,K.setStr(X.PLAYER_COLOR,l),ce.addEvent([p.INPUT_EV_PLAYER_COLOR,l]),j("Color",l))}),r.on("onNameChange",l=>{z.name!==l&&(z.name=l,K.setStr(X.PLAYER_NAME,l),ce.addEvent([p.INPUT_EV_PLAYER_NAME,l]),j("Name",l))}),r.on("onOtherPlayerClickSoundEnabledChange",l=>{z.otherPlayerClickSoundEnabled!==l&&(z.otherPlayerClickSoundEnabled=l,K.setBool(X.OTHER_PLAYER_CLICK_SOUND_ENABLED,l),j("Other player sounds",l))}),r.on("onSoundsEnabledChange",l=>{z.soundsEnabled!==l&&(z.soundsEnabled=l,K.setBool(X.SOUND_ENABLED,l),j("Sounds",l))}),r.on("onSoundsVolumeChange",l=>{z.soundsVolume!==l&&(z.soundsVolume=l,K.setInt(X.SOUND_VOLUME,l),fo(),j("Volume",l))}),r.on("onShowPlayerNamesChange",l=>{z.showPlayerNames!==l&&(z.showPlayerNames=l,K.setBool(X.SHOW_PLAYER_NAMES,l),j("Player names",l))}),r.on("setHotkeys",l=>{ce.setHotkeys(l)}),r.on("requireRerender",()=>{J=!0});const Co=[];let ot;const Rs=()=>{Co.forEach(l=>{clearInterval(l)}),ot&&clearTimeout(ot)};if(n===je?Co.push(setInterval(()=>{Je(H())},1e3)):n===Ee&&et(),n===je)Ce.onServerChange(l=>{l[0],l[1],l[2];const c=l[3];let w=!1,I=!1;for(const[x,W]of c)switch(x){case p.CHANGE_PLAYER:{const $=B.decodePlayer(W);$.id!==t&&(M.setPlayer(e,$.id,$),w=!0)}break;case p.CHANGE_PIECE:{const $=B.decodePiece(W);M.setPiece(e,$.idx,$),w=!0}break;case p.CHANGE_DATA:M.setPuzzleData(e,W),w=!0;break;case p.PLAYER_SNAP:W!==t&&(I=!0);break}I&&mt()&&co()&&Us(),w&&(J=!0),gt=!!M.getFinishTs(e)});else if(n===Ee){const l=(I,x)=>{const W=I;if(W[0]===p.LOG_ADD_PLAYER){const $=W[1];return M.addPlayer(e,$,x),!0}if(W[0]===p.LOG_UPDATE_PLAYER){const $=M.getPlayerIdByIndex(e,W[1]);if(!$)throw"[ 2021-05-17 player not found (update player) ]";return M.addPlayer(e,$,x),!0}if(W[0]===p.LOG_HANDLE_INPUT){const $=M.getPlayerIdByIndex(e,W[1]);if(!$)throw"[ 2021-05-17 player not found (handle input) ]";const fe=W[2];return M.handleInput(e,$,fe,x),!0}return!1};let c=h.lastGameTs;const w=async()=>{h.logPointer+1>=h.log.length&&await se(e);const I=Te.timestamp();if(h.paused){h.lastRealTs=I,ot=setTimeout(w,50);return}const W=(I-h.lastRealTs)*h.speeds[h.speedIdx];let $=h.lastGameTs+W,fe=!0;do if(h.paused)fe=!1;else{const Se=h.logPointer+1;if(Se>=h.log.length)fe=!1;else{const he=h.log[h.logPointer],ko=c+he[he.length-1],yt=h.log[Se],Ao=yt[yt.length-1],wt=ko+Ao;wt>$?($+500*Te.MS<wt&&($+=Ao),fe=!1):(c=ko,l(yt,wt)&&(J=!0),h.logPointer=Se)}}while(fe);h.lastRealTs=I,h.lastGameTs=$,Je(H()),h.final||(ot=setTimeout(w,50))};w()}const Ls=()=>{ce.createKeyEvents();for(const l of ce.consumeAll())if(n===je){const c=l[0];if(c===p.INPUT_EV_MOVE){const x=R.worldDimToViewportRaw({w:l[1],h:l[2]});J=!0,R.move(x.w,x.h),delete ue.last}else if(c===p.INPUT_EV_MOUSE_MOVE){if(l[5]&&!M.getFirstOwnedPiece(e,t)){const W=R.worldDimToViewportRaw({w:l[3],h:l[4]});J=!0,R.move(W.w,W.h),delete ue.last}}else if(c===p.INPUT_EV_PLAYER_COLOR)_t(l[1]);else if(c===p.INPUT_EV_MOUSE_DOWN)We(!0);else if(c===p.INPUT_EV_MOUSE_UP)We(!1);else if(c===p.INPUT_EV_ZOOM_IN){const x={x:l[1],y:l[2]};J=!0,R.zoom("in",R.worldToViewportRaw(x)),delete ue.last}else if(c===p.INPUT_EV_ZOOM_OUT){const x={x:l[1],y:l[2]};J=!0,R.zoom("out",R.worldToViewportRaw(x)),delete ue.last}else if(c===p.INPUT_EV_TOGGLE_INTERFACE)Po();else if(c===p.INPUT_EV_TOGGLE_PREVIEW)bo();else if(c===p.INPUT_EV_TOGGLE_SOUNDS)To();else if(c===p.INPUT_EV_TOGGLE_PLAYER_NAMES)$o();else if(c===p.INPUT_EV_CENTER_FIT_PUZZLE){const x="center",W=Qe(x);j(W?`Restored position "${W}"`:`Position "${x}" not set`)}else if(c===p.INPUT_EV_TOGGLE_FIXED_PIECES)Oe=!Oe,j(`${Oe?"Showing":"Hiding"} finished pieces`),J=!0;else if(c===p.INPUT_EV_TOGGLE_LOOSE_PIECES)Ne=!Ne,j(`${Ne?"Showing":"Hiding"} unfinished pieces`),J=!0;else if(c===p.INPUT_EV_TOGGLE_TABLE)So();else if(c===p.INPUT_EV_STORE_POS){const x=`${l[1]}`;ue[x]=R.snapshot(),j(`Stored position ${x}`)}else if(c===p.INPUT_EV_RESTORE_POS){const x=`${l[1]}`,W=Qe(x);j(W?`Restored position "${W}"`:`Position "${x}" not set`)}const w=H(),I=M.handleInput(e,t,l,w);mt()&&I.find(x=>x[0]===p.PLAYER_SNAP)&&fo(),I.length>0&&(J=!0),Ce.sendClientEvent(l)}else if(n===Ee){const c=l[0];if(c===p.INPUT_EV_REPLAY_TOGGLE_PAUSE)Eo();else if(c===p.INPUT_EV_REPLAY_SPEED_DOWN)vo();else if(c===p.INPUT_EV_REPLAY_SPEED_UP)wo();else if(c===p.INPUT_EV_MOVE){const w=R.worldDimToViewportRaw({w:l[1],h:l[2]});J=!0,R.move(w.w,w.h)}else if(c===p.INPUT_EV_MOUSE_MOVE){if(l[5]){const I=R.worldDimToViewportRaw({w:l[3],h:l[4]});J=!0,R.move(I.w,I.h)}}else if(c===p.INPUT_EV_PLAYER_COLOR)_t(l[1]);else if(c===p.INPUT_EV_MOUSE_DOWN)We(!0);else if(c===p.INPUT_EV_MOUSE_UP)We(!1);else if(c===p.INPUT_EV_ZOOM_IN){const w={x:l[1],y:l[2]};J=!0,R.zoom("in",R.worldToViewportRaw(w))}else if(c===p.INPUT_EV_ZOOM_OUT){const w={x:l[1],y:l[2]};J=!0,R.zoom("out",R.worldToViewportRaw(w))}else if(c===p.INPUT_EV_TOGGLE_INTERFACE)Po();else if(c===p.INPUT_EV_TOGGLE_PREVIEW)bo();else if(c===p.INPUT_EV_TOGGLE_SOUNDS)To();else if(c===p.INPUT_EV_TOGGLE_PLAYER_NAMES)$o();else if(c===p.INPUT_EV_CENTER_FIT_PUZZLE){const w="center",I=Qe(w);j(I?`Restored position "${I}"`:`Position "${w}" not set`)}else if(c===p.INPUT_EV_TOGGLE_FIXED_PIECES)Oe=!Oe,j(`${Oe?"Showing":"Hiding"} finished pieces`),J=!0;else if(c===p.INPUT_EV_TOGGLE_LOOSE_PIECES)Ne=!Ne,j(`${Ne?"Showing":"Hiding"} unfinished pieces`),J=!0;else if(c===p.INPUT_EV_TOGGLE_TABLE)So();else if(c===p.INPUT_EV_STORE_POS){const w=`${l[1]}`;ue[w]=R.snapshot(),j(`Stored position ${w}`)}else if(c===p.INPUT_EV_RESTORE_POS){const w=`${l[1]}`,I=Qe(w);j(I?`Restored position "${I}"`:`Position "${w}" not set`)}}gt=!!M.getFinishTs(e),uo()&&(G.update(),J=!0)},Vs=new DOMMatrix([1,0,0,1,0,0]),Ms={dark:await de.loadImageToBitmap(bt["./assets/textures/wood-dark.jpg"].default),light:await de.loadImageToBitmap(bt["./assets/textures/wood-light.jpg"].default),brown:await de.loadImageToBitmap(bt["./assets/textures/Oak-none-3275x2565mm-Architextures.jpg"].default)},zs=Da({update:Ls,render:async()=>{if(!J)return;const l=H();let c,w,I;if(window.DEBUG&&Ae.checkpoint_start(0),A.fillStyle=po(),A.fillRect(0,0,N.width,N.height),z.showTable){const $=Ms[z.tableTexture];if($){const fe=M.getBounds(e);c=R.worldToViewportRaw(fe),w=R.worldDimToViewportRaw(fe);const Se=A.createPattern($,"repeat");Se.setTransform(Vs.translate(c.x,c.y).scale(R.getCurrentZoom()*3)),A.fillStyle=Se,A.fillRect(c.x,c.y,w.w,w.h);const he=R.worldDimToViewportRaw({w:16,h:16});A.fillStyle="rgba(0, 0, 0, .5)",A.fillRect(c.x,c.y,w.w,he.h),A.fillRect(c.x,c.y+he.h,he.w,w.h-2*he.h),A.fillRect(c.x+w.w-he.w,c.y+he.h,he.w,w.h-2*he.h),A.fillRect(c.x,c.y+w.h-he.h,w.w,he.w)}}if(window.DEBUG&&Ae.checkpoint("clear done"),c=R.worldToViewportRaw(lo),w=R.worldDimToViewportRaw(pt),z.showTable){const $=R.worldDimToViewportRaw({w:8,h:8});A.fillStyle="rgba(0, 0, 0, .5)",A.fillRect(c.x-$.w,c.y-$.h,w.w+2*$.w,$.h),A.fillRect(c.x-$.w,c.y,$.h,w.h),A.fillRect(c.x+w.w,c.y,$.w,w.h),A.fillRect(c.x-$.w,c.y+w.h,w.w+2*$.w,$.h)}z.showTable&&["dark","brown"].includes(z.tableTexture)?A.fillStyle="rgba(0, 0, 0, .3)":A.fillStyle="rgba(255, 255, 255, .3)",A.fillRect(c.x,c.y,w.w,w.h),window.DEBUG&&Ae.checkpoint("board done");const x=M.getPiecesSortedByZIndex(e);window.DEBUG&&Ae.checkpoint("get pieces done"),w=R.worldDimToViewportRaw(ro);for(const $ of x)!tc($)||(I=v[$.idx],c=R.worldToViewportRaw({x:$e+$.pos.x,y:$e+$.pos.y}),A.drawImage(I,0,0,I.width,I.height,c.x,c.y,w.w,w.h));window.DEBUG&&Ae.checkpoint("pieces done");const W=[];for(const $ of M.getActivePlayers(e,l))a($)&&(I=await b($),c=R.worldToViewport($),A.drawImage(I,c.x-Y,c.y-S),ho()&&W.push([`${$.name} (${$.points})`,c.x,c.y+L]));A.fillStyle="white",A.textAlign="center";for(const[$,fe,Se]of W)A.fillText($,fe,Se);window.DEBUG&&Ae.checkpoint("players done"),Je(l),window.DEBUG&&Ae.checkpoint("HUD done"),uo()&&G.render(),J=!1}}),Ds=()=>{Rs(),zs.stop(),ce&&ce.unregisterEvents()};return{previewImageUrl:ks,player:z,game:M.get(e),disconnect:Ce.disconnect,connect:ne,unload:Ds}}const oc=ie({name:"game",components:{PuzzleStatusComponent:Ft,Scores:Wt,SettingsOverlay:Zt,PreviewOverlay:Ht,InfoOverlay:jt,ConnectionOverlay:ls,HelpOverlay:Xt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,interface:!0,eventBus:Wo(),g:{player:Fo(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleInterface",t=>{this.interface=!!t}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("toggleShowTable",t=>{this.g.player.showTable=!!t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.showTable,t=>{this.eventBus.emit("onShowTableChange",t)}),this.$watch(()=>this.g.player.tableTexture,t=>{this.eventBus.emit("onTableTextureChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Ts(`${this.$route.params.id}`,_e.clientId(),this.$config.WS_ADDRESS,je,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}}}),sc={id:"game"},nc=o("div",null,[o("i",{class:"icon icon-hourglass"}),f(" Cutting puzzle, please wait... "),o("i",{class:"icon icon-hourglass"})],-1),ic={key:4,class:"menu-left"},lc={key:0,class:"switch-game-replay"},rc=o("i",{class:"icon icon-replay"},null,-1),ac=f(" Watch replay"),uc={key:5,class:"menu"},cc=o("i",{class:"icon icon-puzzle-piece"},null,-1),dc=f(" Puzzles"),hc=o("i",{class:"icon icon-preview"},null,-1),pc=f(" Preview"),gc=[hc,pc],fc=o("i",{class:"icon icon-settings"},null,-1),mc=f(" Settings"),_c=[fc,mc],yc=o("i",{class:"icon icon-info"},null,-1),wc=f(" Info"),vc=[yc,wc],Ec=o("i",{class:"icon icon-hotkey"},null,-1),Pc=f(" Hotkeys"),bc=[Ec,Pc],Tc=o("a",{class:"opener",href:"https://ec.europa.eu/info/strategy/priorities-2019-2024/stronger-europe-world/eu-solidarity-ukraine/eu-assistance-ukraine/eu-stands-ukraine_en",target:"_blank"},[o("i",{class:"icon icon-ukraine-heart"}),f(" Stand with Ukraine ")],-1),$c={key:6,class:"menu-right"},Sc={key:7,class:"status-messages"},Cc={ref:"canvas"};function kc(e,t,s,n,i,r){const a=V("settings-overlay"),u=V("preview-overlay"),m=V("info-overlay"),g=V("help-overlay"),O=V("overlay"),D=V("connection-overlay"),P=V("puzzle-status"),y=V("router-link"),k=V("scores");return d(),_("div",sc,[e.overlay==="settings"?(d(),te(a,{key:0,onClose:t[0]||(t[0]=E=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=E=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=E=>e.g.player=E)},null,8,["modelValue"])):U("",!0),e.overlay==="preview"?(d(),te(u,{key:1,onClose:t[3]||(t[3]=E=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=E=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):U("",!0),e.g.game&&e.overlay==="info"?(d(),te(m,{key:2,onClose:t[5]||(t[5]=E=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=E=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):U("",!0),e.overlay==="help"?(d(),te(g,{key:3,onClose:t[7]||(t[7]=E=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=E=>e.toggle("help",!0))})):U("",!0),Z(ee(O,null,{default:re(()=>[nc]),_:1},512),[[Yo,e.cuttingPuzzle]]),ee(D,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),e.interface?(d(),_("div",ic,[ee(P,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(d(),_("div",lc,[ee(y,{to:{name:"replay",params:{id:e.g.game.id}}},{default:re(()=>[rc,ac]),_:1},8,["to"])])):U("",!0)])):U("",!0),e.interface?(d(),_("div",uc,[ee(y,{class:"opener",to:{name:"index"},target:"_blank"},{default:re(()=>[cc,dc]),_:1}),o("div",{class:"opener",onClick:t[9]||(t[9]=E=>e.toggle("preview",!1))},gc),o("div",{class:"opener",onClick:t[10]||(t[10]=E=>e.toggle("settings",!0))},_c),o("div",{class:"opener",onClick:t[11]||(t[11]=E=>e.toggle("info",!0))},vc),o("div",{class:"opener",onClick:t[12]||(t[12]=E=>e.toggle("help",!0))},bc),Tc])):U("",!0),e.interface?(d(),_("div",$c,[ee(k,{players:e.players},null,8,["players"])])):U("",!0),e.statusMessages.length?(d(),_("div",Sc,[(d(!0),_(ae,null,ye(e.statusMessages,(E,Y)=>(d(),_("div",{key:Y},F(E),1))),128))])):U("",!0),o("canvas",Cc,null,512)])}var Ac=oe(oc,[["render",kc]]);const Oc=ie({name:"replay",components:{PuzzleStatusComponent:Ft,Scores:Wt,SettingsOverlay:Zt,PreviewOverlay:Ht,InfoOverlay:jt,HelpOverlay:Xt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,interface:!0,eventBus:Wo(),g:{player:Fo(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleInterface",t=>{this.interface=!!t}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("toggleShowTable",t=>{this.g.player.showTable=!!t}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.showTable,t=>{this.eventBus.emit("onShowTableChange",t)}),this.$watch(()=>this.g.player.tableTexture,t=>{this.eventBus.emit("onTableTextureChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Ts(`${this.$route.params.id}`,_e.clientId(),this.$config.WS_ADDRESS,Ee,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Nc={id:"replay"},Uc={key:4,class:"overlay"},Rc=o("div",{class:"overlay-content"},[o("div",null,[o("i",{class:"icon icon-hourglass"}),f(" Cutting puzzle, please wait... "),o("i",{class:"icon icon-hourglass"})])],-1),Lc=[Rc],Vc={key:5,class:"menu-left"},Mc={class:"playback-control"},zc=o("i",{class:"icon icon-speed-up"},null,-1),Dc=[zc],Gc=o("i",{class:"icon icon-speed-down"},null,-1),Ic=[Gc],Bc=o("i",{class:"icon icon-pause"},null,-1),xc=[Bc],Yc={key:0,class:"switch-game-replay"},Wc=o("i",{class:"icon icon-puzzle-piece"},null,-1),Fc=f(" To the game"),Zc={key:6,class:"menu"},Hc=o("i",{class:"icon icon-puzzle-piece"},null,-1),jc=f(" Puzzles"),Kc=o("i",{class:"icon icon-preview"},null,-1),qc=f(" Preview"),Xc=[Kc,qc],Qc=o("i",{class:"icon icon-settings"},null,-1),Jc=f(" Settings"),ed=[Qc,Jc],td=o("i",{class:"icon icon-info"},null,-1),od=f(" Info"),sd=[td,od],nd=o("i",{class:"icon icon-hotkey"},null,-1),id=f(" Hotkeys"),ld=[nd,id],rd=o("a",{class:"opener",href:"https://ec.europa.eu/info/strategy/priorities-2019-2024/stronger-europe-world/eu-solidarity-ukraine/eu-assistance-ukraine/eu-stands-ukraine_en",target:"_blank"},[o("i",{class:"icon icon-ukraine-heart"}),f(" Stand with Ukraine ")],-1),ad={key:7,class:"menu-right"},ud={key:8,class:"status-messages"},cd={ref:"canvas"};function dd(e,t,s,n,i,r){const a=V("settings-overlay"),u=V("preview-overlay"),m=V("info-overlay"),g=V("help-overlay"),O=V("puzzle-status"),D=V("router-link"),P=V("scores");return d(),_("div",Nc,[e.overlay==="settings"?(d(),te(a,{key:0,onClose:t[0]||(t[0]=y=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=y=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=y=>e.g.player=y)},null,8,["modelValue"])):U("",!0),e.overlay==="preview"?(d(),te(u,{key:1,onClose:t[3]||(t[3]=y=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=y=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):U("",!0),e.g.game&&e.overlay==="info"?(d(),te(m,{key:2,onClose:t[5]||(t[5]=y=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=y=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):U("",!0),e.overlay==="help"?(d(),te(g,{key:3,onClose:t[7]||(t[7]=y=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=y=>e.toggle("help",!0))})):U("",!0),e.cuttingPuzzle?(d(),_("div",Uc,Lc)):U("",!0),e.interface?(d(),_("div",Vc,[ee(O,{status:e.status},null,8,["status"]),o("div",Mc,[o("div",null,F(e.replayText),1),o("button",{class:"btn",onClick:t[9]||(t[9]=y=>e.eventBus.emit("replayOnSpeedUp"))},Dc),o("button",{class:"btn",onClick:t[10]||(t[10]=y=>e.eventBus.emit("replayOnSpeedDown"))},Ic),o("button",{class:"btn",onClick:t[11]||(t[11]=y=>e.eventBus.emit("replayOnPauseToggle"))},xc)]),e.g.game?(d(),_("div",Yc,[ee(D,{to:{name:"game",params:{id:e.g.game.id}}},{default:re(()=>[Wc,Fc]),_:1},8,["to"])])):U("",!0)])):U("",!0),e.interface?(d(),_("div",Zc,[ee(D,{class:"opener",to:{name:"index"},target:"_blank"},{default:re(()=>[Hc,jc]),_:1}),o("div",{class:"opener",onClick:t[12]||(t[12]=y=>e.toggle("preview",!1))},Xc),o("div",{class:"opener",onClick:t[13]||(t[13]=y=>e.toggle("settings",!0))},ed),o("div",{class:"opener",onClick:t[14]||(t[14]=y=>e.toggle("info",!0))},sd),o("div",{class:"opener",onClick:t[15]||(t[15]=y=>e.toggle("help",!0))},ld),rd])):U("",!0),e.interface?(d(),_("div",ad,[ee(P,{players:e.players},null,8,["players"])])):U("",!0),e.statusMessages.length?(d(),_("div",ud,[(d(!0),_(ae,null,ye(e.statusMessages,(y,k)=>(d(),_("div",{key:k},F(y),1))),128))])):U("",!0),o("canvas",cd,null,512)])}var hd=oe(Oc,[["render",dd]]);let $s=null;async function pd(){$s=await(await _e.get("/api/me",{})).json()}var Ss={getMe:()=>$s,init:pd};const gd=ie({props:{image:{type:Object,required:!0}},data:()=>({me:Ss.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}}),fd=o("i",{class:"icon icon-edit"},null,-1),md=[fd];function _d(e,t,s,n,i,r){return d(),_("div",{class:"imageteaser",style:Be(e.style),onClick:t[1]||(t[1]=(...a)=>e.onClick&&e.onClick(...a))},[e.canEdit?(d(),_("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=Tt((...a)=>e.onEditClick&&e.onEditClick(...a),["stop"]))},md)):U("",!0)],4)}var yd=oe(gd,[["render",_d]]);const wd=ie({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),vd={class:"overlay"};function Ed(e,t,s,n,i,r){return d(),_("div",vd,[o("div",{class:Xe(["overlay-background",e.classes.map(a=>"overlay-background-"+a)]),onClick:t[0]||(t[0]=a=>e.$emit("bgclick"))},null,2),o("div",{class:Xe(["overlay-content",e.classes.map(a=>"overlay-content-"+a)])},[xs(e.$slots,"default")],2)])}var Pd=oe(wd,[["render",Ed]]);const bd={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Td=["title"];function $d(e,t,s,n,i,r){return d(),_("div",{style:Be(r.style),title:s.title},null,12,Td)}var Sd=oe(bd,[["render",$d]]);const Cd=ie({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;if(e.code==="Escape")return this.autocomplete.values=[],this.autocomplete.idx=-1,e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),kd={class:"input-holder"},Ad={key:0,class:"enter-hint color-highlight"},Od={key:0,class:"autocomplete"},Nd=["onClick"],Ud=["onClick"];function Rd(e,t,s,n,i,r){return d(),_("div",null,[o("div",kd,[Z(o("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=a=>e.input=a),placeholder:"Plants, People",onKeydown:[t[1]||(t[1]=Oo(Tt((...a)=>e.add&&e.add(...a),["prevent"]),["enter"])),t[2]||(t[2]=Oo(Tt((...a)=>e.add&&e.add(...a),["prevent"]),["tab"]))],onKeyup:t[3]||(t[3]=(...a)=>e.onKeyUp&&e.onKeyUp(...a))},null,544),[[Re,e.input]]),e.input?(d(),_("div",Ad,"[Press ENTER/TAB to add]")):U("",!0)]),e.autocomplete.values?(d(),_("div",Od,[o("ul",null,[(d(!0),_(ae,null,ye(e.autocomplete.values,(a,u)=>(d(),_("li",{key:u,class:Xe({active:u===e.autocomplete.idx}),onClick:m=>e.addVal(a)},F(a),11,Nd))),128))])])):U("",!0),(d(!0),_(ae,null,ye(e.values,(a,u)=>(d(),_("span",{key:u,class:"bit is-clickable",onClick:m=>e.rm(a)},F(a)+" \u2716",9,Ud))),128))])}var Ld=oe(Cd,[["render",Rd],["__scopeId","data-v-8e01df40"]]);(async()=>{_e.init(),await Ss.init();const t=await(await _e.get("/api/conf",{})).json(),s=Ys({history:Ws(),routes:[{name:"index",path:"/",component:In},{name:"new-game",path:"/new-game",component:vl},{name:"game",path:"/g/:id",component:Ac},{name:"replay",path:"/replay/:id",component:hd}]});s.beforeEach((i,r)=>{r.name&&document.documentElement.classList.remove(`view-${String(r.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const n=Fs(en);n.config.globalProperties.$config=t,n.use(s),n.component("connection-overlay",ls),n.component("edit-image-dialog",Jo),n.component("game-teaser",Ko),n.component("help-overlay",Xt),n.component("image-library",qo),n.component("image-teaser",yd),n.component("info-overlay",jt),n.component("new-game-dialog",es),n.component("new-image-dialog",Qo),n.component("overlay",Pd),n.component("preview-overlay",Ht),n.component("puzzle-status",Ft),n.component("responsive-image",Sd),n.component("scores",Wt),n.component("settings-overlay",Zt),n.component("tags-input",Ld),n.mount("#app")})();
//# sourceMappingURL=index.4f8caad7.js.map
