import{d as oe,r as k,o as d,c as v,a as s,b as _,w as le,e as M,f as y,g as H,n as Me,t as W,F as ae,h as ge,i as Ue,j,v as Re,k as Ne,l as Ee,m as xs,p as Ys,q as Fo,s as Zo,u as Tt,x as Ho,y as Oo,z as Ws,A as No,B as Fs,C as Zs,D as Uo,E as ot,G as Hs,H as js,I as Ks,J as qs}from"./vendor.f410875e.js";const Xs=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const a of l.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}};Xs();var se=(e,t)=>{const o=e.__vccOpts||e;for(const[n,i]of t)o[n]=i;return o};const Qs=oe({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),Js={id:"app"},en={key:0,class:"nav"},tn=y("Games overview"),on=y("New game"),sn={href:"https://stand-with-ukraine.pp.ua/",class:"btn btn-ukraine",target:"_blank"},nn=y(" Stand with Ukraine ");function ln(e,t,o,n,i,l){const a=k("router-link"),u=k("icon"),h=k("router-view");return d(),v("div",Js,[e.showNav?(d(),v("ul",en,[s("li",null,[_(a,{class:"btn",to:{name:"index"}},{default:le(()=>[tn]),_:1})]),s("li",null,[_(a,{class:"btn",to:{name:"new-game"}},{default:le(()=>[on]),_:1})]),s("li",null,[s("a",sn,[_(u,{icon:"ukraine-heart"}),nn,_(u,{icon:"ukraine-heart"})])])])):M("",!0),_(h)])}var rn=se(Qs,[["render",ln]]);class dt{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,o){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const n=(this.rand_high>>>0)/4294967295;return t+n*(o-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const o=t.slice();for(let n=0;n<=o.length-2;n++){const i=this.random(n,o.length-1),l=o[n];o[n]=o[i],o[i]=l}return o}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const o=new dt(0);return o.rand_high=t.rand_high,o.rand_low=t.rand_low,o}}const an=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},lt=(e,t)=>{const o=`${e}`;return o.length>=t.length?o:t.substr(0,t.length-o.length)+o},Gt=(...e)=>{const t=o=>(...n)=>{const i=new Date,l=lt(i.getHours(),"00"),a=lt(i.getMinutes(),"00"),u=lt(i.getSeconds(),"00");console[o](`${l}:${a}:${u}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},un=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function cn(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function dn(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function hn(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function pn(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function gn(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function mn(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function fn(e){return[e.id,e.rng.type||"",dt.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion,e.private]}function _n(e){return{id:e[0],rng:{type:e[1],obj:dt.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10],private:e[11]}}function yn(e,t){const o=e.width/e.tileSize;return{x:t%o,y:Math.floor(t/o)}}function wn(e,t){const o=e.width/e.pieceSize;return{x:t%o,y:Math.floor(t/o)}}const vn=e=>{let t=0;for(let o=0;o<e.length;o++){const n=e.charCodeAt(o);t=(t<<5)-t+n,t|=0}return t};function En(e){const t=[];for(const o in e){const n=[o,e[o]].map(encodeURIComponent);t.push(n.join("="))}return t.length===0?"":`?${t.join("&")}`}var Y={hash:vn,slug:an,pad:lt,uniqId:un,encodeShape:cn,decodeShape:dn,encodePiece:hn,decodePiece:pn,encodePlayer:gn,decodePlayer:mn,encodeGame:fn,decodeGame:_n,coordByPieceIdxDeprecated:yn,coordByPieceIdx:wn,asQueryArgs:En};const J={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",OTHER_PLAYER_CLICK_SOUND_ENABLED:"other_player_click_sound_enabled",COLOR_BACKGROUND:"bg_color",SHOW_TABLE:"show_table",TABLE_TEXTURE:"table_texture",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},pe={SOUND_VOLUME:100,SOUND_ENABLED:!0,OTHER_PLAYER_CLICK_SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",SHOW_TABLE:!0,TABLE_TEXTURE:"dark",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},jo=()=>({background:"",showTable:!0,tableTexture:"dark",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0}),It=(e,t)=>{localStorage.setItem(e,t)},xt=e=>localStorage.getItem(e),Pn=(e,t)=>{It(e,`${t}`)},bn=(e,t)=>{const o=xt(e);if(o===null)return t;const n=parseInt(o,10);return isNaN(n)?t:n},Tn=(e,t)=>{It(e,t?"1":"0")},Cn=(e,t)=>{const o=xt(e);return o===null?t:o==="1"},$n=(e,t)=>{It(e,t)},Sn=(e,t)=>{const o=xt(e);return o===null?t:o};var X={setInt:Pn,getInt:bn,setBool:Tn,getBool:Cn,setStr:$n,getStr:Sn};let Ct="",Ko="";const vt=async(e,t,o)=>new Promise((n,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const a in o.headers||{})l.setRequestHeader(a,o.headers[a]);l.setRequestHeader("Client-Id",Ct),l.setRequestHeader("Client-Secret",Ko),l.addEventListener("load",function(a){n({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(a){i(new Error("xhr error"))}),l.upload&&o.onUploadProgress&&l.upload.addEventListener("progress",function(a){o.onUploadProgress&&o.onUploadProgress(a)}),l.send(o.body||null)}),Ro=e=>{let t=X.getStr(e,"");return t||(t=Y.uniqId(),X.setStr(e,t)),t};var ye={init:()=>{Ct=Ro("ID"),Ko=Ro("SECRET")},request:vt,get:(e,t)=>vt("get",e,t),post:(e,t)=>vt("post",e,t),clientId:()=>Ct};const qo=1,Yt=qo*1e3,at=Yt*60,ut=at*60,$t=ut*24,kn=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},Xo=e=>{const t=Math.floor(e/$t);e=e%$t;const o=Math.floor(e/ut);e=e%ut;const n=Math.floor(e/at);e=e%at;const i=Math.floor(e/Yt);return`${t}d ${o}h ${n}m ${i}s`},An=(e,t)=>Xo(t-e);var be={MS:qo,SEC:Yt,MIN:at,HOUR:ut,DAY:$t,timestamp:kn,timeDiffStr:An,durationStr:Xo};const On=oe({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const o=e,n=t||be.timestamp();return`${be.timeDiffStr(o,n)}`}}}),Nn={class:"game-teaser"},Un={class:"game-info-text"},Rn=s("br",null,null,-1),Ln=s("br",null,null,-1),Vn=s("br",null,null,-1),Mn=y(" Watch replay ");function zn(e,t,o,n,i,l){const a=k("icon"),u=k("router-link");return d(),v("div",Nn,[s("div",{class:"game-teaser-inner",style:Me(e.style)},[_(u,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:le(()=>[s("span",Un,[_(a,{icon:"puzzle-piece"}),y(" "+W(e.game.piecesFinished)+"/"+W(e.game.piecesTotal),1),Rn,_(a,{icon:"sillouette"}),y(" "+W(e.game.players),1),Ln,e.game.finished?(d(),H(a,{key:1,icon:"flag"})):(d(),H(a,{key:0,icon:"clock"})),y(" "+W(e.time(e.game.started,e.game.finished)),1),Vn])]),_:1},8,["to"]),e.game.hasReplay?(d(),H(u,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:le(()=>[_(a,{icon:"replay"}),Mn]),_:1},8,["to"])):M("",!0)],4)])}var Qo=se(On,[["render",zn]]);const Dn=oe({components:{GameTeaser:Qo},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ye.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),Bn=s("h1",null,"Running games",-1),Gn=s("h1",null,"Finished games",-1);function In(e,t,o,n,i,l){const a=k("game-teaser");return d(),v("div",null,[Bn,(d(!0),v(ae,null,ge(e.gamesRunning,(u,h)=>(d(),H(a,{key:h,game:u},null,8,["game"]))),128)),Gn,(d(!0),v(ae,null,ge(e.gamesFinished,(u,h)=>(d(),H(a,{key:h,game:u},null,8,["game"]))),128))])}var xn=se(Dn,[["render",In]]);const Yn=oe({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function Wn(e,t,o,n,i,l){const a=k("image-teaser"),u=k("masonry-wall");return d(),H(u,{items:e.images,"column-width":320,gap:10},{default:le(({item:h,index:g})=>[(d(),H(a,{image:h,onClick:p=>e.imageClicked(h),onEditClick:p=>e.imageEditClicked(h),key:g},null,8,["image","onClick","onEditClick"]))]),_:1},8,["items"])}var Jo=se(Yn,[["render",Wn]]);const Fn=async e=>{const t=await Hn(e),o=await Zn(t);return es(o.toDataURL())},Zn=async e=>{const t=document.createElement("canvas"),o=t.getContext("2d");return t.width=e.width,t.height=e.height,o.drawImage(e,0,0),t},Hn=async e=>new Promise((t,o)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{t(n)},n.onerror=i=>{o(i)},n.src=e});function es(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],n=atob(t[1]),i=n.length,l=new Uint8Array(i);i--;)l[i]=n.charCodeAt(i);return new Blob([l],{type:o})}const jn=oe({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:["setupGameClick","postToGalleryClick","close"],data(){return{previewUrl:"",file:null,title:"",tags:[],isPrivate:!1,droppable:!1,inputFocused:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},mounted(){window.addEventListener("paste",this.onPaste)},unmounted(){window.removeEventListener("paste",this.onPaste)},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.isPrivate=!1,this.droppable=!1},imageFromDragEvt(e){var n;const t=(n=e.dataTransfer)==null?void 0:n.items;if(!t||t.length===0)return null;const o=t[0];return o.type.startsWith("image/")?o:null},async onPaste(e){const t=e.clipboardData.getData("text");if(t){if(this.inputFocused)return;if(t.match(/^https?:\/\//)){const n="/api/proxy?"+new URLSearchParams({url:t});try{const i=await Fn(n);this.preview(i)}catch(i){console.error("unable to transform image http url into blob",i)}}else if(t.match(/^data:image\/([a-z]+);base64,/))try{const n=es(t);this.preview(n)}catch(n){console.error("unable to transform image data url into blob",n)}else console.log(t)}const o=e.clipboardData.files[0];!o||this.preview(o)},onFileSelect(e){const t=e.target;if(!t.files)return;const o=t.files[0];!o||this.preview(o)},preview(e){if(!e.type.startsWith("image/")){console.error("file type is not supported",e.type);return}const t=new FileReader;t.readAsDataURL(e),t.onload=o=>{this.previewUrl=o.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const o=t.getAsFile();return o&&(this.file=o,this.preview(o),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),Kn=s("div",{class:"drop-target"},null,-1),qn={key:0,class:"has-image"},Xn={key:1},Qn={class:"upload"},Jn=s("div",{class:"upload-content"},[y(" How to upload an image? Choose any of the following methods: "),s("ul",null,[s("li",null,"Click this area to select an image for upload "),s("li",null,"Drag and drop an image into the area"),s("li",null,"Paste an image URL"),s("li",null,"Paste an image")]),s("div",{class:"hint"},` Don't worry, the image will not show up in the gallery unless "Post to gallery" was clicked. `)],-1),ei={class:"area-settings"},ti=s("td",null,[s("label",null,"Title")],-1),oi=s("tr",null,[s("td",{colspan:"2"},[s("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),si=s("td",null,[s("label",null,"Private Image")],-1),ni={class:"checkbox-only"},ii=s("tr",null,[s("td",{colspan:"2"},[s("div",{class:"hint"},"Private images won't show up in the gallery.")])],-1),li=s("td",null,[s("label",null,"Tags")],-1),ri={class:"area-buttons"},ai=["disabled"],ui=y(" Post to gallery"),ci=["disabled"],di=y(" Set up game"),hi=y(" Post to gallery "),pi=s("br",null,null,-1),gi=y(" + set up game");function mi(e,t,o,n,i,l){const a=k("responsive-image"),u=k("tags-input"),h=k("icon"),g=k("overlay");return d(),H(g,{class:"new-image-dialog"},{default:le(()=>[s("div",{class:Ue(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...p)=>e.onDrop&&e.onDrop(...p)),onDragover:t[3]||(t[3]=(...p)=>e.onDragover&&e.onDragover(...p)),onDragleave:t[4]||(t[4]=(...p)=>e.onDragleave&&e.onDragleave(...p))},[Kn,e.previewUrl?(d(),v("div",qn,[s("span",{class:"remove btn",onClick:t[0]||(t[0]=p=>e.previewUrl="")},"X"),_(a,{src:e.previewUrl},null,8,["src"])])):(d(),v("div",Xn,[s("label",Qn,[s("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...p)=>e.onFileSelect&&e.onFileSelect(...p)),accept:"image/*"},null,32),Jn])]))],34),s("div",ei,[s("table",null,[s("tr",null,[ti,s("td",null,[j(s("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=p=>e.title=p),placeholder:"Flower by @artist",onFocus:t[6]||(t[6]=p=>e.inputFocused=!0),onBlur:t[7]||(t[7]=p=>e.inputFocused=!1)},null,544),[[Re,e.title]])])]),oi,s("tr",null,[si,s("td",ni,[j(s("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=p=>e.isPrivate=p)},null,512),[[Ne,e.isPrivate]])])]),ii,s("tr",null,[li,s("td",null,[_(u,{modelValue:e.tags,"onUpdate:modelValue":t[9]||(t[9]=p=>e.tags=p),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),s("div",ri,[e.isPrivate?M("",!0):(d(),v("button",{key:0,class:"btn",disabled:!e.canPostToGallery,onClick:t[10]||(t[10]=(...p)=>e.postToGallery&&e.postToGallery(...p))},[e.uploading==="postToGallery"?(d(),v(ae,{key:0},[y("Uploading ("+W(e.uploadProgressPercent)+"%)",1)],64)):(d(),v(ae,{key:1},[_(h,{icon:"preview"}),ui],64))],8,ai)),s("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[11]||(t[11]=(...p)=>e.setupGameClick&&e.setupGameClick(...p))},[e.uploading==="setupGame"?(d(),v(ae,{key:0},[y("Uploading ("+W(e.uploadProgressPercent)+"%)",1)],64)):e.isPrivate?(d(),v(ae,{key:1},[_(h,{icon:"puzzle-piece"}),di],64)):(d(),v(ae,{key:2},[_(h,{icon:"puzzle-piece"}),hi,pi,gi],64))],8,ci),s("button",{class:"btn",onClick:t[12]||(t[12]=p=>e.$emit("close"))},"Cancel")])]),_:1})}var ts=se(jn,[["render",mi]]);const fi=oe({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:["saveClick","close"],data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),_i={class:"area-image"},yi={class:"has-image"},wi={class:"area-settings"},vi=s("td",null,[s("label",null,"Title")],-1),Ei=s("tr",null,[s("td",{colspan:"2"},[s("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Pi=s("td",null,[s("label",null,"Tags")],-1),bi={class:"area-buttons"},Ti=y(" Save image");function Ci(e,t,o,n,i,l){const a=k("responsive-image"),u=k("tags-input"),h=k("icon"),g=k("overlay");return d(),H(g,{class:"edit-image-dialog"},{default:le(()=>[s("div",_i,[s("div",yi,[_(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),s("div",wi,[s("table",null,[s("tr",null,[vi,s("td",null,[j(s("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=p=>e.title=p),placeholder:"Flower by @artist"},null,512),[[Re,e.title]])])]),Ei,s("tr",null,[Pi,s("td",null,[_(u,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=p=>e.tags=p),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),s("div",bi,[s("button",{class:"btn",onClick:t[2]||(t[2]=(...p)=>e.saveImage&&e.saveImage(...p))},[_(h,{icon:"preview"}),Ti]),s("button",{class:"btn",onClick:t[3]||(t[3]=p=>e.$emit("close"))},"Cancel")])]),_:1})}var os=se(fi,[["render",Ci]]),Le=(e=>(e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY",e))(Le||{}),Ke=(e=>(e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT",e))(Ke||{}),xe=(e=>(e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL",e))(xe||{});const $i=oe({props:{image:{type:Object,required:!0},forcePrivate:{type:Boolean,default:!1}},emits:["newGame","close"],data(){return{tiles:1e3,isPrivate:!1,scoreMode:Le.ANY,shapeMode:Ke.NORMAL,snapMode:xe.NORMAL}},mounted(){this.isPrivate=this.forcePrivate},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,private:this.isPrivate,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Si={class:"area-image"},ki={class:"has-image"},Ai={key:0,class:"image-title"},Oi={key:0,class:"image-title-title"},Ni={key:1,class:"image-title-dim"},Ui={class:"area-settings"},Ri=s("td",null,[s("label",null,"Pieces")],-1),Li=s("td",null,[s("label",null,"Scoring: ")],-1),Vi=y(" Any (Score when pieces are connected to each other or on final location)"),Mi=s("br",null,null,-1),zi=y(" Final (Score when pieces are put to their final location)"),Di=s("td",null,[s("label",null,"Shapes: ")],-1),Bi=y(" Normal"),Gi=s("br",null,null,-1),Ii=y(" Any (Flat pieces can occur anywhere)"),xi=s("br",null,null,-1),Yi=y(" Flat (All pieces flat on all sides)"),Wi=s("td",null,[s("label",null,"Snapping: ")],-1),Fi=y(" Normal (Pieces snap to final destination and to each other)"),Zi=s("br",null,null,-1),Hi=y(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),ji=s("td",null,[s("label",null,"Private Game")],-1),Ki={class:"checkbox-only"},qi=["disabled"],Xi=s("tr",null,[s("td",{colspan:"2"},[s("div",{class:"hint"},"Private games won't show up in the game overview.")])],-1),Qi={key:0},Ji=s("td",null,[s("label",null,"Tags: ")],-1),el={class:"area-buttons"},tl=["disabled"],ol=y(" Generate Puzzle ");function sl(e,t,o,n,i,l){const a=k("responsive-image"),u=k("icon"),h=k("overlay");return d(),H(h,{class:"new-game-dialog"},{default:le(()=>[s("div",Si,[s("div",ki,[_(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(d(),v("div",Ai,[e.image.title?(d(),v("span",Oi,'"'+W(e.image.title)+'"',1)):M("",!0),e.image.width||e.image.height?(d(),v("span",Ni,"("+W(e.image.width)+" \u2715 "+W(e.image.height)+")",1)):M("",!0)])):M("",!0)]),s("div",Ui,[s("table",null,[s("tr",null,[Ri,s("td",null,[j(s("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=g=>e.tiles=g)},null,512),[[Re,e.tiles]])])]),s("tr",null,[Li,s("td",null,[s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=g=>e.scoreMode=g),value:"1"},null,512),[[Ee,e.scoreMode]]),Vi]),Mi,s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=g=>e.scoreMode=g),value:"0"},null,512),[[Ee,e.scoreMode]]),zi])])]),s("tr",null,[Di,s("td",null,[s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=g=>e.shapeMode=g),value:"0"},null,512),[[Ee,e.shapeMode]]),Bi]),Gi,s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=g=>e.shapeMode=g),value:"1"},null,512),[[Ee,e.shapeMode]]),Ii]),xi,s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=g=>e.shapeMode=g),value:"2"},null,512),[[Ee,e.shapeMode]]),Yi])])]),s("tr",null,[Wi,s("td",null,[s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=g=>e.snapMode=g),value:"0"},null,512),[[Ee,e.snapMode]]),Fi]),Zi,s("label",null,[j(s("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=g=>e.snapMode=g),value:"1"},null,512),[[Ee,e.snapMode]]),Hi])])]),s("tr",null,[ji,s("td",Ki,[j(s("input",{disabled:e.forcePrivate,type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=g=>e.isPrivate=g)},null,8,qi),[[Ne,e.isPrivate]])])]),Xi,e.image.tags.length?(d(),v("tr",Qi,[Ji,s("td",null,[(d(!0),v(ae,null,ge(e.image.tags,(g,p)=>(d(),v("span",{key:p,class:"bit"},W(g.title),1))),128))])])):M("",!0)])]),s("div",el,[s("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[9]||(t[9]=(...g)=>e.onNewGameClick&&e.onNewGameClick(...g))},[_(u,{icon:"puzzle-piece"}),ol],8,tl),s("button",{class:"btn",onClick:t[10]||(t[10]=g=>e.$emit("close"))},"Cancel")])]),_:1})}var ss=se($i,[["render",sl]]);const nl=oe({components:{ImageLibrary:Jo,NewImageDialog:ts,EditImageDialog:os,NewGameDialog:ss},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",newGameForcePrivate:!1,uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(o=>!t.includes(o.title)&&o.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(o=>o.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ye.get(`/api/newgame-data${Y.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.newGameForcePrivate=!1,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags),t.append("private",e.isPrivate);const o=await ye.post("/api/upload",{body:t,onUploadProgress:n=>{this.uploadProgress=n.loaded/n.total}});return this.uploadProgress=1,await o.json()},async saveImage(e){return await(await ye.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.newGameForcePrivate=e.isPrivate,this.dialog="new-game"},async onNewGame(e){const t=await ye.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const o=await t.json();this.$router.push({name:"game",params:{id:o.id}})}}}}),il=s("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),ll={key:0},rl=y(" Tags: "),al=["onClick"],ul=y(" Sort by: "),cl=Ys('<option value="date_desc">Newest first</option><option value="date_asc">Oldest first</option><option value="alpha_asc">A-Z</option><option value="alpha_desc">Z-A</option><option value="game_count_asc">Most plays first</option><option value="game_count_desc">Least plays first</option>',6),dl=[cl];function hl(e,t,o,n,i,l){const a=k("image-library"),u=k("new-image-dialog"),h=k("edit-image-dialog"),g=k("new-game-dialog");return d(),v("div",null,[s("div",{class:Ue(["upload-image-teaser",{blurred:e.dialog!==""}])},[s("div",{class:"btn is-big",onClick:t[0]||(t[0]=p=>e.dialog="new-image")},"Upload your image"),il],2),s("div",{class:Ue({blurred:e.dialog!==""})},[e.tags.length>0?(d(),v("label",ll,[rl,(d(!0),v(ae,null,ge(e.relevantTags,(p,B)=>(d(),v("span",{class:Ue(["bit is-clickable",{on:e.filters.tags.includes(p.slug)}]),key:B,onClick:P=>e.toggleTag(p)},W(p.title)+" ("+W(p.total)+")",11,al))),128))])):M("",!0),s("label",null,[ul,j(s("select",{"onUpdate:modelValue":t[1]||(t[1]=p=>e.filters.sort=p),onChange:t[2]||(t[2]=(...p)=>e.filtersChanged&&e.filtersChanged(...p))},dl,544),[[xs,e.filters.sort]])])],2),_(a,{class:Ue({blurred:e.dialog!==""}),images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["class","images","onImageClicked","onImageEditClicked"]),e.dialog==="new-image"?(d(),H(u,{key:0,autocompleteTags:e.autocompleteTags,onClose:t[3]||(t[3]=p=>e.dialog=""),onBgclick:t[4]||(t[4]=p=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"])):M("",!0),e.dialog==="edit-image"?(d(),H(h,{key:1,autocompleteTags:e.autocompleteTags,onClose:t[5]||(t[5]=p=>e.dialog=""),onBgclick:t[6]||(t[6]=p=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"])):M("",!0),e.image&&e.dialog==="new-game"?(d(),H(g,{key:2,onClose:t[7]||(t[7]=p=>e.dialog=""),onBgclick:t[8]||(t[8]=p=>e.dialog=""),onNewGame:e.onNewGame,image:e.image,forcePrivate:e.newGameForcePrivate},null,8,["onNewGame","image","forcePrivate"])):M("",!0)])}var pl=se(nl,[["render",hl]]);const gl=oe({props:{players:{type:Object,required:!0}},methods:{playerStyle(e){return e.color==="ukraine"?{backgroundImage:"linear-gradient(180deg, rgba(0,87,183,1) 0%, rgba(0,87,183,1) 50%, rgba(255,221,0,1) 50%)","-webkit-background-clip":"text","-webkit-text-fill-color":"transparent"}:{color:e.color}}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),ml={class:"scores"},fl=s("div",null,"Scores",-1);function _l(e,t,o,n,i,l){const a=k("icon");return d(),v("div",ml,[fl,s("table",null,[(d(!0),v(ae,null,ge(e.actives,(u,h)=>(d(),v("tr",{key:h,style:Me(e.playerStyle(u))},[s("td",null,[_(a,{icon:"lightning"})]),s("td",null,W(u.name),1),s("td",null,W(u.points),1)],4))),128)),(d(!0),v(ae,null,ge(e.idles,(u,h)=>(d(),v("tr",{key:h,style:Me(e.playerStyle(u))},[s("td",null,[_(a,{icon:"zzz"})]),s("td",null,W(u.name),1),s("td",null,W(u.points),1)],4))),128))])])}var Wt=se(gl,[["render",_l]]);const yl=oe({props:{status:{type:Object,required:!0}},computed:{durationStr(){return be.durationStr(this.status.duration)}}}),wl={class:"puzzle-status"};function vl(e,t,o,n,i,l){const a=k("icon");return d(),v("div",wl,[s("div",null,[_(a,{icon:"puzzle-piece"}),y(" "+W(e.status.piecesDone)+"/"+W(e.status.piecesTotal),1)]),s("div",null,[e.status.finished?(d(),H(a,{key:1,icon:"flag"})):(d(),H(a,{key:0,icon:"clock"})),y(" "+W(e.durationStr),1)])])}var Ft=se(yl,[["render",vl]]);const El=oe({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({showTable:!1,tableTexture:"dark",background:"",color:"",isUkraineColor:!1,name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.showTable=!!e.showTable,this.tableTexture=e.tableTexture,this.background=`${e.background}`,this.color=`${e.color}`,this.isUkraineColor=this.color==="ukraine",this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.otherPlayerClickSoundEnabled=!!e.otherPlayerClickSoundEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{showTable:this.showTable,tableTexture:this.tableTexture,background:this.background,color:this.isUkraineColor?"ukraine":this.color,name:this.name,soundsEnabled:this.soundsEnabled,otherPlayerClickSoundEnabled:this.otherPlayerClickSoundEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch(()=>this.isUkraineColor,this.emitChanges)),this.watches.push(this.$watch(()=>this.background,this.emitChanges)),this.watches.push(this.$watch(()=>this.showTable,this.emitChanges)),this.watches.push(this.$watch(()=>this.tableTexture,this.emitChanges)),this.watches.push(this.$watch(()=>this.color,this.emitChanges)),this.watches.push(this.$watch(()=>this.name,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.otherPlayerClickSoundEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsVolume,this.emitChanges)),this.watches.push(this.$watch(()=>this.showPlayerNames,this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue)}}),Pl={class:"settings"},bl=s("td",null,[s("label",null,"Background: ")],-1),Tl=s("td",null,[s("label",null,"Table: ")],-1),Cl=y("Show"),$l={key:0},Sl=y(" Dark"),kl={key:1},Al=y(" Brown"),Ol={key:2},Nl=y(" Light"),Ul=s("td",null,[s("label",null,"Color: ")],-1),Rl=s("td",null,[s("label",null,"Name: ")],-1),Ll=s("td",null,[s("label",null,"Sounds: ")],-1),Vl=s("td",null,[s("label",null,"Piece connect sounds of others: ")],-1),Ml=["disabled"],zl=s("td",null,[s("label",null,"Sounds Volume: ")],-1),Dl={class:"sound-volume"},Bl=["disabled","value"],Gl=s("td",null,[s("label",null,"Show player names: ")],-1);function Il(e,t,o,n,i,l){const a=k("icon"),u=k("overlay");return d(),H(u,{class:"transparent"},{default:le(()=>[s("table",Pl,[s("tr",null,[bl,s("td",null,[j(s("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=h=>e.background=h)},null,512),[[Re,e.background]])])]),s("tr",null,[Tl,s("td",null,[s("label",null,[j(s("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=h=>e.showTable=h)},null,512),[[Ne,e.showTable]]),Cl]),e.showTable?(d(),v("label",$l,[j(s("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=h=>e.tableTexture=h),value:"dark"},null,512),[[Ee,e.tableTexture]]),Sl])):M("",!0),e.showTable?(d(),v("label",kl,[j(s("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=h=>e.tableTexture=h),value:"brown"},null,512),[[Ee,e.tableTexture]]),Al])):M("",!0),e.showTable?(d(),v("label",Ol,[j(s("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=h=>e.tableTexture=h),value:"light"},null,512),[[Ee,e.tableTexture]]),Nl])):M("",!0)])]),s("tr",null,[Ul,s("td",null,[e.isUkraineColor?M("",!0):j((d(),v("input",{key:0,type:"color","onUpdate:modelValue":t[5]||(t[5]=h=>e.color=h)},null,512)),[[Re,e.color]]),s("label",null,[j(s("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=h=>e.isUkraineColor=h)},null,512),[[Ne,e.isUkraineColor]]),_(a,{icon:"ukraine-heart"})])])]),s("tr",null,[Rl,s("td",null,[j(s("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[7]||(t[7]=h=>e.name=h)},null,512),[[Re,e.name]])])]),s("tr",null,[Ll,s("td",null,[j(s("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=h=>e.soundsEnabled=h)},null,512),[[Ne,e.soundsEnabled]])])]),s("tr",null,[Vl,s("td",null,[j(s("input",{type:"checkbox",disabled:!e.soundsEnabled,"onUpdate:modelValue":t[9]||(t[9]=h=>e.otherPlayerClickSoundEnabled=h)},null,8,Ml),[[Ne,e.otherPlayerClickSoundEnabled]])])]),s("tr",null,[zl,s("td",Dl,[s("span",{onClick:t[10]||(t[10]=(...h)=>e.decreaseVolume&&e.decreaseVolume(...h))},[_(a,{icon:"volume-down"})]),s("input",{disabled:!e.soundsEnabled,type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[11]||(t[11]=(...h)=>e.updateVolume&&e.updateVolume(...h))},null,40,Bl),s("span",{onClick:t[12]||(t[12]=(...h)=>e.increaseVolume&&e.increaseVolume(...h))},[_(a,{icon:"volume-up"})])])]),s("tr",null,[Gl,s("td",null,[j(s("input",{type:"checkbox","onUpdate:modelValue":t[13]||(t[13]=h=>e.showPlayerNames=h)},null,512),[[Ne,e.showPlayerNames]])])])])]),_:1})}var Zt=se(El,[["render",Il]]);const xl=oe({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),Yl={class:"preview"};function Wl(e,t,o,n,i,l){const a=k("overlay");return d(),H(a,{class:"preview-overlay"},{default:le(()=>[s("div",Yl,[s("div",{class:"img",style:Me(e.previewStyle)},null,4)])]),_:1})}var Ht=se(xl,[["render",Wl]]);const Fl=oe({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case Le.ANY:return["Any","Score when pieces are connected to each other or on final location"];case Le.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ke.FLAT:return["Flat","All pieces flat on all sides"];case Ke.ANY:return["Any","Flat pieces can occur anywhere"];case Ke.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case xe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case xe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),Zl={class:"help"},Hl=s("tr",null,[s("td",{colspan:"2"},"Info about this puzzle")],-1),jl=s("td",null,"Image Title: ",-1),Kl=s("td",null,"Scoring: ",-1),ql=["title"],Xl=s("td",null,"Shapes: ",-1),Ql=["title"],Jl=s("td",null,"Snapping: ",-1),er=["title"];function tr(e,t,o,n,i,l){const a=k("overlay");return d(),H(a,{class:"transparent"},{default:le(()=>[s("table",Zl,[Hl,s("tr",null,[jl,s("td",null,W(e.game.puzzle.info.image.title),1)]),s("tr",null,[Kl,s("td",null,[s("span",{title:e.snapMode[1]},W(e.scoreMode[0]),9,ql)])]),s("tr",null,[Xl,s("td",null,[s("span",{title:e.snapMode[1]},W(e.shapeMode[0]),9,Ql)])]),s("tr",null,[Jl,s("td",null,[s("span",{title:e.snapMode[1]},W(e.snapMode[0]),9,er)])])])]),_:1})}var jt=se(Fl,[["render",tr]]);const or=4,sr=1,nr=4,ir=2,lr=3,rr=1,ar=2,ur=4,cr=3,dr=1,hr=2,pr=3,gr=4,mr=5,fr=6,_r=7,yr=8,wr=9,vr=10,Er=11,Pr=12,br=13,Tr=14,Cr=15,$r=16,Sr=17,kr=18,Ar=19,Or=20,Nr=21,Ur=22,Rr=23,Lr=1,Vr=2,Mr=3,zr=4;var f={EV_SERVER_EVENT:sr,EV_SERVER_INIT:nr,EV_CLIENT_EVENT:ir,EV_CLIENT_INIT:lr,GAME_VERSION:or,LOG_HEADER:rr,LOG_ADD_PLAYER:ar,LOG_UPDATE_PLAYER:ur,LOG_HANDLE_INPUT:cr,INPUT_EV_MOVE:wr,INPUT_EV_MOUSE_DOWN:dr,INPUT_EV_MOUSE_UP:hr,INPUT_EV_MOUSE_MOVE:pr,INPUT_EV_ZOOM_IN:gr,INPUT_EV_ZOOM_OUT:mr,INPUT_EV_BG_COLOR:fr,INPUT_EV_PLAYER_COLOR:_r,INPUT_EV_PLAYER_NAME:yr,INPUT_EV_TOGGLE_INTERFACE:Rr,INPUT_EV_TOGGLE_PREVIEW:vr,INPUT_EV_TOGGLE_SOUNDS:Er,INPUT_EV_REPLAY_TOGGLE_PAUSE:Pr,INPUT_EV_REPLAY_SPEED_UP:br,INPUT_EV_REPLAY_SPEED_DOWN:Tr,INPUT_EV_TOGGLE_PLAYER_NAMES:Cr,INPUT_EV_CENTER_FIT_PUZZLE:$r,INPUT_EV_TOGGLE_FIXED_PIECES:Sr,INPUT_EV_TOGGLE_LOOSE_PIECES:kr,INPUT_EV_TOGGLE_TABLE:Ur,INPUT_EV_STORE_POS:Ar,INPUT_EV_RESTORE_POS:Or,INPUT_EV_CONNECTION_CLOSE:Nr,CHANGE_DATA:Lr,CHANGE_PIECE:Vr,CHANGE_PLAYER:Mr,PLAYER_SNAP:zr};const Dr=Gt("Communication.js"),Br=1001,Kt=4e3,ns=0,St=1,qt=2,is=3,ls=4;let _e,kt=[],At=e=>{kt.push(e)},Ot=[],Nt=e=>{Ot.push(e)};function Gr(e){At=e;for(const t of kt)At(t);kt=[]}function Ir(e){Nt=e;for(const t of Ot)Nt(t);Ot=[]}let Ut=ns;const Ze=e=>{Ut!==e&&(Ut=e,Nt(e))};function rs(e){if(Ut===qt)try{_e.send(JSON.stringify(e))}catch{Dr.info("unable to send message.. maybe because ws is invalid?")}}let Ge,Ie,Rt=0;function as(e=2e4){_e.readyState==_e.OPEN&&_e.send(""),Rt=setTimeout(as,e)}function Lo(){Rt&&clearTimeout(Rt)}function xr(e,t,o){return Ge=0,Ie={},Ze(is),new Promise(n=>{_e=new WebSocket(e,o+"|"+t),_e.onopen=()=>{Ze(qt),rs([f.EV_CLIENT_INIT]),as()},_e.onmessage=i=>{const l=JSON.parse(i.data),a=l[0];if(a===f.EV_SERVER_INIT){const u=l[1];n(u)}else if(a===f.EV_SERVER_EVENT){const u=l[1],h=l[2];if(u===o&&Ie[h]){delete Ie[h];return}At(l)}else throw`[ 2021-05-09 invalid connect msgType ${a} ]`},_e.onerror=()=>{throw Lo(),Ze(St),"[ 2021-05-15 onerror ]"},_e.onclose=i=>{Lo(),i.code===Kt||i.code===Br?Ze(ls):Ze(St)}})}async function Yr(e,t){const o={gameId:e,offset:t};return await(await ye.get(`/api/replay-data${Y.asQueryArgs(o)}`,{})).json()}function Wr(){_e&&_e.close(Kt),Ge=0,Ie={}}function Fr(e){Ge++,Ie[Ge]=e,rs([f.EV_CLIENT_EVENT,Ge,Ie[Ge]])}var $e={connect:xr,requestReplayData:Yr,disconnect:Wr,sendClientEvent:Fr,onServerChange:Gr,onConnectionStateChange:Ir,CODE_CUSTOM_DISCONNECT:Kt,CONN_STATE_NOT_CONNECTED:ns,CONN_STATE_DISCONNECTED:St,CONN_STATE_CLOSED:ls,CONN_STATE_CONNECTED:qt,CONN_STATE_CONNECTING:is};const Zr=oe({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===$e.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===$e.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),Hr={key:0},jr=y(" LOST CONNECTION "),Kr={key:2};function qr(e,t,o,n,i,l){const a=k("icon"),u=k("overlay");return j((d(),H(u,{class:"connection-lost"},{default:le(()=>[e.lostConnection?(d(),v("div",Hr,[_(a,{icon:"disconnect"}),jr,_(a,{icon:"disconnect"})])):M("",!0),e.lostConnection?(d(),v("span",{key:1,class:"btn",onClick:t[0]||(t[0]=h=>e.$emit("reconnect"))},"Reconnect")):M("",!0),e.connecting?(d(),v("div",Kr,"Connecting...")):M("",!0)]),_:1},512)),[[Fo,e.show]])}var us=se(Zr,[["render",qr]]);const Xr={},Qr={class:"help"},Jr=y(" Move up:"),ea=s("kbd",null,"W",-1),ta=y("/"),oa=s("kbd",null,"\u2191",-1),sa=y("/"),na=y(" Move down:"),ia=s("kbd",null,"S",-1),la=y("/"),ra=s("kbd",null,"\u2193",-1),aa=y("/"),ua=y(" Move left:"),ca=s("kbd",null,"A",-1),da=y("/"),ha=s("kbd",null,"\u2190",-1),pa=y("/"),ga=y(" Move right:"),ma=s("kbd",null,"D",-1),fa=y("/"),_a=s("kbd",null,"\u2192",-1),ya=y("/"),wa=s("tr",null,[s("td"),s("td",null,[s("div",null,[y("Move faster by holding "),s("kbd",null,"Shift")])])],-1),va=y(" Zoom in:"),Ea=s("kbd",null,"E",-1),Pa=y("/"),ba=y(" Zoom out:"),Ta=s("kbd",null,"Q",-1),Ca=y("/"),$a=y(" Toggle preview:"),Sa=s("td",null,[s("div",null,[s("kbd",null,"Space")])],-1),ka=y(" Center puzzle in screen:"),Aa=s("td",null,[s("div",null,[s("kbd",null,"C")])],-1),Oa=y(" Toggle fixed pieces:"),Na=s("td",null,[s("div",null,[s("kbd",null,"F")])],-1),Ua=y(" Toggle loose pieces:"),Ra=s("td",null,[s("div",null,[s("kbd",null,"G")])],-1),La=y(" Toggle table:"),Va=s("td",null,[s("div",null,[s("kbd",null,"T")])],-1),Ma=y(" Toggle interface:"),za=s("td",null,[s("div",null,[s("kbd",null,"H")])],-1),Da=y(" Toggle player names:"),Ba=s("td",null,[s("div",null,[s("kbd",null,"N")])],-1),Ga=y(" Toggle sounds:"),Ia=s("td",null,[s("div",null,[s("kbd",null,"M")])],-1),xa=y(" Store position [0-9]:"),Ya=s("td",null,[s("div",null,[s("kbd",null,"Shift"),y(" + "),s("kbd",null,"0"),y("-"),s("kbd",null,"9")])],-1),Wa=y(" Restore position [0-9]:"),Fa=s("td",null,[s("div",null,[s("kbd",null,"0"),y("-"),s("kbd",null,"9")])],-1),Za=y(" Speed up (replay):"),Ha=s("td",null,[s("div",null,[s("kbd",null,"I")])],-1),ja=y(" Speed down (replay):"),Ka=s("td",null,[s("div",null,[s("kbd",null,"O")])],-1),qa=y(" Pause (replay):"),Xa=s("td",null,[s("div",null,[s("kbd",null,"P")])],-1);function Qa(e,t){const o=k("icon"),n=k("overlay");return d(),H(n,{class:"transparent"},{default:le(()=>[s("table",Qr,[s("tr",null,[s("td",null,[_(o,{icon:"arrow-up"}),Jr]),s("td",null,[s("div",null,[ea,ta,oa,sa,_(o,{icon:"mouse-left"})])])]),s("tr",null,[s("td",null,[_(o,{icon:"arrow-down"}),na]),s("td",null,[s("div",null,[ia,la,ra,aa,_(o,{icon:"mouse-left"})])])]),s("tr",null,[s("td",null,[_(o,{icon:"arrow-left"}),ua]),s("td",null,[s("div",null,[ca,da,ha,pa,_(o,{icon:"mouse-left"})])])]),s("tr",null,[s("td",null,[_(o,{icon:"arrow-right"}),ga]),s("td",null,[s("div",null,[ma,fa,_a,ya,_(o,{icon:"mouse-left"})])])]),wa,s("tr",null,[s("td",null,[_(o,{icon:"zoom-in"}),va]),s("td",null,[s("div",null,[Ea,Pa,_(o,{icon:"mouse-wheel"})])])]),s("tr",null,[s("td",null,[_(o,{icon:"zoom-out"}),ba]),s("td",null,[s("div",null,[Ta,Ca,_(o,{icon:"mouse-wheel"})])])]),s("tr",null,[s("td",null,[_(o,{icon:"preview"}),$a]),Sa]),s("tr",null,[s("td",null,[_(o,{icon:"center"}),ka]),Aa]),s("tr",null,[s("td",null,[_(o,{icon:"puzzle-piece-locked"}),Oa]),Na]),s("tr",null,[s("td",null,[_(o,{icon:"puzzle-piece-free"}),Ua]),Ra]),s("tr",null,[s("td",null,[_(o,{icon:"table"}),La]),Va]),s("tr",null,[s("td",null,[_(o,{icon:"eye"}),Ma]),za]),s("tr",null,[s("td",null,[_(o,{icon:"player-name"}),Da]),Ba]),s("tr",null,[s("td",null,[_(o,{icon:"volume-up"}),Ga]),Ia]),s("tr",null,[s("td",null,[_(o,{icon:"save-pos"}),xa]),Ya]),s("tr",null,[s("td",null,[_(o,{icon:"load-pos"}),Wa]),Fa]),s("tr",null,[s("td",null,[_(o,{icon:"speed-up"}),Za]),Ha]),s("tr",null,[s("td",null,[_(o,{icon:"speed-down"}),ja]),Ka]),s("tr",null,[s("td",null,[_(o,{icon:"pause"}),qa]),Xa])])]),_:1})}var Xt=se(Xr,[["render",Qa]]),Ja="/assets/click.bb97cb07.mp3",eu=Object.freeze(Object.defineProperty({__proto__:null,default:Ja},Symbol.toStringTag,{value:"Module"})),tu="/assets/click2.98536db5.mp3",ou=Object.freeze(Object.defineProperty({__proto__:null,default:tu},Symbol.toStringTag,{value:"Module"})),su="/assets/Oak-none-3275x2565mm-Architextures.cc917130.jpg",nu=Object.freeze(Object.defineProperty({__proto__:null,default:su},Symbol.toStringTag,{value:"Module"})),iu="/assets/wood-dark.1e21ffc1.jpg",lu=Object.freeze(Object.defineProperty({__proto__:null,default:iu},Symbol.toStringTag,{value:"Module"})),ru="/assets/wood-light.ae1bd383.jpg",au=Object.freeze(Object.defineProperty({__proto__:null,default:ru},Symbol.toStringTag,{value:"Module"})),uu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",cu=Object.freeze(Object.defineProperty({__proto__:null,default:uu},Symbol.toStringTag,{value:"Module"})),du="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",hu=Object.freeze(Object.defineProperty({__proto__:null,default:du},Symbol.toStringTag,{value:"Module"})),pu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",gu=Object.freeze(Object.defineProperty({__proto__:null,default:pu},Symbol.toStringTag,{value:"Module"})),mu="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",fu=Object.freeze(Object.defineProperty({__proto__:null,default:mu},Symbol.toStringTag,{value:"Module"}));const _u=e=>{let t=!1;const o=()=>{t=!0},n=e.fps||60,i=e.slow||1,l=e.update,a=e.render,u=window.requestAnimationFrame,h=1/n,g=i*h;let p,B=0,P=window.performance.now();const C=()=>{for(p=window.performance.now(),B=B+Math.min(1,(p-P)/1e3);B>g;)B=B-g,l(h);a(B/i),P=p,t||u(C)};return u(C),{stop:o}};let Vo=.1;const yu=6,wu=.05;class Lt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}calculateZoomCapping(t,o,n,i){Vo=Math.max(.1,t/n,o/i)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,o){this.x+=t/this.curZoom,this.y+=o/this.curZoom}calculateNewZoom(t){const o=t==="in"?1:-1,n=this.curZoom+wu*this.curZoom*o;return Math.min(Math.max(n,Vo),yu)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,o){if(this.curZoom==t)return!1;const n=1-this.curZoom/t;return this.move(-o.x*n,-o.y*n),this.curZoom=t,!0}zoom(t,o){return this.setZoom(this.calculateNewZoom(t),o)}viewportToWorld(t){const{x:o,y:n}=this.viewportToWorldRaw(t);return{x:Math.round(o),y:Math.round(n)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:o,y:n}=this.worldToViewportRaw(t);return{x:Math.round(o),y:Math.round(n)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:o,h:n}=this.worldDimToViewportRaw(t);return{w:Math.round(o),h:Math.round(n)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:o,h:n}=this.viewportDimToWorldRaw(t);return{w:Math.round(o),h:Math.round(n)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function qe(e=0,t=0){const o=document.createElement("canvas");return o.width=e,o.height=t,o}async function vu(e){return new Promise(t=>{const o=new Image;o.onload=()=>{createImageBitmap(o).then(t)},o.src=e})}async function Eu(e,t,o){const n=qe(t,o);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,o),await createImageBitmap(n)}function Pu(e,t,o){if(o==="ukraine"){const l=qe(e.width,e.height),a=l.getContext("2d"),u=t.height/1.75;a.save(),a.drawImage(t,0,0),a.fillStyle="#0057B7",a.globalCompositeOperation="source-in",a.fillRect(0,0,t.width,u),a.restore(),a.save(),a.globalCompositeOperation="destination-over",a.drawImage(e,0,0),a.restore();const h=qe(e.width,e.height/2),g=h.getContext("2d");return g.save(),g.drawImage(t,0,-u),g.fillStyle="#FFDD00",g.globalCompositeOperation="source-in",g.fillRect(0,0,t.width,t.height),g.restore(),g.save(),g.globalCompositeOperation="destination-over",g.drawImage(e,0,-u),g.restore(),a.drawImage(h,0,u),l}const n=qe(e.width,e.height),i=n.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=o,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),n}var de={createCanvas:qe,loadImageToBitmap:vu,resizeBitmap:Eu,colorizedCanvas:Pu};const bu=Gt("Debug.js");let Vt=0,cs=0;const Tu=e=>{Vt=performance.now(),cs=e},Cu=e=>{const t=performance.now(),o=t-Vt;o>cs&&bu.log(e+": "+o),Vt=t};var ke={checkpoint_start:Tu,checkpoint:Cu};function $u(e,t){return{x:e.x-t.x,y:e.y-t.y}}function Su(e,t){return{x:e.x+t.x,y:e.y+t.y}}function ds(e,t){const o=e.x-t.x,n=e.y-t.y;return Math.sqrt(o*o+n*n)}function ku(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Mt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function Au(e,t,o){return{x:e.x+t,y:e.y+o,w:e.w,h:e.h}}function Ou(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function Nu(e,t){return ds(Mt(e),Mt(t))}var ee={pointSub:$u,pointAdd:Su,pointDistance:ds,pointInBounds:ku,rectCenter:Mt,rectMoved:Au,rectCenterDistance:Nu,rectsOverlap:Ou};const Mo=Gt("PuzzleGraphics.js");async function Uu(e,t,o){Mo.log("start createPuzzleTileBitmaps");const n=o.tileSize,i=o.tileMarginWidth,l=o.tileDrawSize,a=n/100,u=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],h=new Array(t.length),g={};function p(E){const O=`${E.top}${E.right}${E.left}${E.bottom}`;if(g[O])return g[O];const U=new Path2D,A={x:i,y:i},S=ee.pointAdd(A,{x:n,y:0}),$=ee.pointAdd(S,{x:0,y:n}),V=ee.pointSub($,{x:n,y:0});if(U.moveTo(A.x,A.y),E.top!==0)for(let m=0;m<u.length/6;m++){const ne=ee.pointAdd(A,{x:u[m*6+0]*a,y:E.top*u[m*6+1]*a}),K=ee.pointAdd(A,{x:u[m*6+2]*a,y:E.top*u[m*6+3]*a}),ie=ee.pointAdd(A,{x:u[m*6+4]*a,y:E.top*u[m*6+5]*a});U.bezierCurveTo(ne.x,ne.y,K.x,K.y,ie.x,ie.y)}else U.lineTo(S.x,S.y);if(E.right!==0)for(let m=0;m<u.length/6;m++){const ne=ee.pointAdd(S,{x:-E.right*u[m*6+1]*a,y:u[m*6+0]*a}),K=ee.pointAdd(S,{x:-E.right*u[m*6+3]*a,y:u[m*6+2]*a}),ie=ee.pointAdd(S,{x:-E.right*u[m*6+5]*a,y:u[m*6+4]*a});U.bezierCurveTo(ne.x,ne.y,K.x,K.y,ie.x,ie.y)}else U.lineTo($.x,$.y);if(E.bottom!==0)for(let m=0;m<u.length/6;m++){const ne=ee.pointSub($,{x:u[m*6+0]*a,y:E.bottom*u[m*6+1]*a}),K=ee.pointSub($,{x:u[m*6+2]*a,y:E.bottom*u[m*6+3]*a}),ie=ee.pointSub($,{x:u[m*6+4]*a,y:E.bottom*u[m*6+5]*a});U.bezierCurveTo(ne.x,ne.y,K.x,K.y,ie.x,ie.y)}else U.lineTo(V.x,V.y);if(E.left!==0)for(let m=0;m<u.length/6;m++){const ne=ee.pointSub(V,{x:-E.left*u[m*6+1]*a,y:u[m*6+0]*a}),K=ee.pointSub(V,{x:-E.left*u[m*6+3]*a,y:u[m*6+2]*a}),ie=ee.pointSub(V,{x:-E.left*u[m*6+5]*a,y:u[m*6+4]*a});U.bezierCurveTo(ne.x,ne.y,K.x,K.y,ie.x,ie.y)}else U.lineTo(A.x,A.y);return g[O]=U,U}const B=de.createCanvas(l,l),P=B.getContext("2d"),C=de.createCanvas(l,l),T=C.getContext("2d");for(const E of t){const O=Y.decodePiece(E),U=Ru(o,O.idx),A=p(Y.decodeShape(o.shapes[O.idx]));P.clearRect(0,0,l,l),P.save(),P.lineWidth=2,P.stroke(A),P.globalCompositeOperation="source-in",P.drawImage(e,U.x-i,U.y-i,l,l,0,0,l,l),P.restore(),P.save(),P.globalCompositeOperation="source-in",P.globalAlpha=.2,P.fillStyle="black",P.fillRect(0,0,B.width,B.height),P.restore(),P.save(),P.clip(A),P.drawImage(e,U.x-i,U.y-i,l,l,0,0,l,l),P.restore(),P.save(),P.clip(A),P.strokeStyle="rgba(0,0,0,.4)",P.lineWidth=0,P.shadowColor="black",P.shadowBlur=2,P.shadowOffsetX=-1,P.shadowOffsetY=-1,P.stroke(A),P.restore(),P.save(),P.clip(A),P.strokeStyle="rgba(255,255,255,.4)",P.lineWidth=0,P.shadowColor="white",P.shadowBlur=2,P.shadowOffsetX=1,P.shadowOffsetY=1,P.stroke(A),P.restore(),T.clearRect(0,0,l,l),T.save(),T.lineWidth=1,T.stroke(A),T.globalCompositeOperation="source-in",T.drawImage(e,U.x-i,U.y-i,l,l,0,0,l,l),T.restore(),P.drawImage(C,0,0),h[O.idx]=await createImageBitmap(B)}return Mo.log("end createPuzzleTileBitmaps"),h}function Ru(e,t){const o=Y.coordByPieceIdxDeprecated(e,t);return{x:o.x*e.tileSize,y:o.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function Lu(e){const t=await de.loadImageToBitmap(e.info.imageUrl),o=await de.resizeBitmap(t,e.info.width,e.info.height);return await Uu(o,e.tiles,e.info)}var Vu={loadPuzzleBitmaps:Lu};const hs=30,N={};function Mu(e){return!!N[e]||!1}function zu(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function Du(e,t){N[e]=t}function Bu(e){delete N[e]}function ht(e,t){let o=0;for(const n of N[e].players){if(Y.decodePlayer(n).id===t)return o;o++}return-1}function Gu(e,t){return N[e].players.length>t?Y.decodePlayer(N[e].players[t]).id:null}function ze(e,t){const o=ht(e,t);return o===-1?null:Y.decodePlayer(N[e].players[o])}function Qt(e,t,o){const n=ht(e,t);n===-1?N[e].players.push(Y.encodePlayer(o)):N[e].players[n]=Y.encodePlayer(o)}function Iu(e,t,o){N[e].puzzle.tiles[t]=Y.encodePiece(o)}function xu(e,t){N[e].puzzle.data=t}function ps(e,t){return ht(e,t)!==-1}function Yu(e,t){return Ps(N[e],t)}function Wu(e,t){return Ec(N[e],t)}function Fu(e,t,o){ps(e,t)?re(e,t,{ts:o}):Qt(e,t,zu(t,o))}function Zu(e){return N[e]||null}function zt(e){return no(N[e])}function Hu(e){return bs(N[e])}function Et(e){return N[e].scoreMode}function gs(e){return N[e].snapMode}function ms(e){return N[e].gameVersion}function Dt(e){return so(N[e])}function ju(e){return N[e].puzzle.tiles.map(Y.decodePiece).sort((o,n)=>o.z-n.z)}function re(e,t,o){const n=ze(e,t);if(n!==null){for(const i of Object.keys(o))n[i]=o[i];Qt(e,t,n)}}function st(e,t){for(const o of Object.keys(t))N[e].puzzle.data[o]=t[o]}function Ve(e,t,o){for(const n of Object.keys(o)){const i=Y.decodePiece(N[e].puzzle.tiles[t]);i[n]=o[n],N[e].puzzle.tiles[t]=Y.encodePiece(i)}}const De=(e,t)=>Y.decodePiece(N[e].puzzle.tiles[t]),ct=(e,t)=>De(e,t).group,Ku=(e,t)=>{const o=N[e].puzzle.info;return t===0||t===o.tilesX-1||t===o.tiles-o.tilesX||t===o.tiles-1},fs=(e,t)=>{const o=N[e].puzzle.info,n={x:(o.table.width-o.width)/2,y:(o.table.height-o.height)/2},i=sc(e,t);return ee.pointAdd(n,i)},rt=(e,t)=>De(e,t).pos,Jt=e=>ms(e)<=3?Xu(e):qu(e),qu=e=>({x:0,y:0,w:to(e),h:oo(e)}),Xu=e=>{const t=to(e),o=oo(e),n=Math.round(t/4),i=Math.round(o/4);return{x:0-n,y:0-i,w:t+2*n,h:o+2*i}},Qu=(e,t)=>De(e,t).z,He=(e,t)=>{for(const o of N[e].puzzle.tiles){const n=Y.decodePiece(o);if(n.owner===t)return n.idx}return-1},Ju=(e,t)=>{const o=He(e,t);return o<0?null:N[e].puzzle.tiles[o]},_s=e=>N[e].puzzle.info.tileDrawOffset,eo=e=>N[e].puzzle.info.tileDrawSize,ec=e=>ws(N[e]),tc=e=>vs(N[e]),zo=e=>N[e].puzzle.data.maxGroup,Do=e=>N[e].puzzle.data.maxZ,oc=(e,t)=>{let o=0;for(const n of t){const i=Qu(e,n);i>o&&(o=i)}return o};function sc(e,t){const o=N[e].puzzle.info,n=Y.coordByPieceIdxDeprecated(o,t),i=n.x*o.tileSize,l=n.y*o.tileSize;return{x:i,y:l}}function nc(e,t){const o=N[e].puzzle.info,n=Y.coordByPieceIdxDeprecated(o,t);return[n.y>0?t-o.tilesX:-1,n.x<o.tilesX-1?t+1:-1,n.y<o.tilesY-1?t+o.tilesX:-1,n.x>0?t-1:-1]}const Bo=(e,t,o)=>{for(const n of t)Ve(e,n,{z:o})},ys=(e,t,o)=>{const n=rt(e,t),i=ee.pointAdd(n,o);Ve(e,t,{pos:i})},nt=(e,t,o)=>ms(e)>=3?lc(e,t,o):ic(e,t,o),ic=(e,t,o)=>{const n=eo(e),i=Jt(e),l=o;for(const a of t){const u=De(e,a);u.pos.x+o.x<i.x?l.x=Math.max(i.x-u.pos.x,l.x):u.pos.x+n+o.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-u.pos.x+n,l.x)),u.pos.y+o.y<i.y?l.y=Math.max(i.y-u.pos.y,l.y):u.pos.y+n+o.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-u.pos.y+n,l.y))}if(!l.x&&!l.y)return!1;for(const a of t)ys(e,a,l);return!0},lc=(e,t,o)=>{const n=Jt(e),i=eo(e)+2*_s(e),l=n.x,a=n.y,u=l+n.w-i,h=a+n.h-i,g=o;for(const p of t){const B=De(e,p);o.x<0?g.x=Math.max(l-B.pos.x,g.x):g.x=Math.min(u-B.pos.x,g.x),o.y<0?g.y=Math.max(a-B.pos.y,g.y):g.y=Math.min(h-B.pos.y,g.y)}if(!g.x&&!g.y)return!1;for(const p of t)ys(e,p,g);return!0},rc=(e,t)=>ac(e,t)===-1,ac=(e,t)=>De(e,t).owner,Go=(e,t)=>{for(const o of t)Ve(e,o,{owner:-1,z:1})},Pt=(e,t,o)=>{for(const n of t)Ve(e,n,{owner:o})};function uc(e,t){return Pe(e,t).length}function Pe(e,t){const o=N[e].puzzle.tiles,n=Y.decodePiece(o[t]),i=[];if(n.group)for(const l of o){const a=Y.decodePiece(l);a.group===n.group&&i.push(a.idx)}else i.push(n.idx);return i}const cc=(e,t)=>{const o=N[e].puzzle.info,n=N[e].puzzle.tiles;let i=-1,l=-1;for(let a=0;a<n.length;a++){const u=Y.decodePiece(n[a]);if(u.owner!==0)continue;const h={x:u.pos.x,y:u.pos.y,w:o.tileSize,h:o.tileSize};ee.pointInBounds(t,h)&&(i===-1||u.z>i)&&(i=u.z,l=a)}return l},dc=(e,t)=>{const o=ze(e,t);return o?o.bgcolor:null},hc=(e,t)=>{const o=ze(e,t);return o?o.color:null},pc=(e,t)=>{const o=ze(e,t);return o?o.name:null},Io=(e,t)=>{const o=ze(e,t);return o?o.points:0},gc=(e,t,o)=>{const n=ct(e,t),i=ct(e,o);return!!(n&&n===i)},to=e=>N[e].puzzle.info.table.width,oo=e=>N[e].puzzle.info.table.height,mc=e=>N[e].puzzle,fc=e=>N[e].rng.obj,_c=e=>N[e].puzzle.info.width,yc=e=>N[e].puzzle.info.height,wc=(e,t)=>{if(gs(e)===xe.REAL){for(const o of t)if(Ku(e,o))return!0;return!1}return!0};function vc(e,t,o,n){const i=N[e].puzzle,l=[],a=()=>{l.push([f.CHANGE_DATA,i.data])},u=C=>{l.push([f.CHANGE_PIECE,Y.encodePiece(De(e,C))])},h=C=>{for(const T of C)u(T)},g=()=>{const C=ze(e,t);!C||l.push([f.CHANGE_PLAYER,Y.encodePlayer(C)])};let p=!1;const B=(C,T,E)=>{const O=N[C].puzzle.tiles,U=ct(C,T),A=ct(C,E);let S;const $=[];if(U&&$.push(U),A&&$.push(A),U)S=U;else if(A)S=A;else{const V=zo(C)+1;st(C,{maxGroup:V}),a(),S=zo(C)}if(Ve(C,T,{group:S}),u(T),Ve(C,E,{group:S}),u(E),$.length>0)for(const V of O){const m=Y.decodePiece(V);$.includes(m.group)&&(Ve(C,m.idx,{group:S}),u(m.idx))}},P=o[0];if(P===f.INPUT_EV_CONNECTION_CLOSE){const C=He(e,t);if(C>=0){const T=Pe(e,C);Pt(e,T,0),h(T)}}else if(P===f.INPUT_EV_BG_COLOR){const C=o[1];re(e,t,{bgcolor:C,ts:n}),g()}else if(P===f.INPUT_EV_PLAYER_COLOR){const C=o[1];re(e,t,{color:C,ts:n}),g()}else if(P===f.INPUT_EV_PLAYER_NAME){const C=`${o[1]}`.substr(0,16);re(e,t,{name:C,ts:n}),g()}else if(P===f.INPUT_EV_MOVE){const C=o[1],T=o[2],E=ze(e,t);if(E){const O=E.x-C,U=E.y-T;re(e,t,{ts:n,x:O,y:U}),g();const A=He(e,t);if(A>=0){const S=Pe(e,A),$={x:-C,y:-T};nt(e,S,$)&&h(S)}}}else if(P===f.INPUT_EV_MOUSE_DOWN){const C=o[1],T=o[2],E={x:C,y:T};re(e,t,{d:1,ts:n}),g();const O=cc(e,E);if(O>=0){const U=Do(e)+1;st(e,{maxZ:U}),a();const A=Pe(e,O);Bo(e,A,Do(e)),Pt(e,A,t),h(A)}}else if(P===f.INPUT_EV_MOUSE_MOVE){const C=o[1],T=o[2];if(!o[5])re(e,t,{x:C,y:T,ts:n}),g();else{const O=He(e,t);if(O<0)re(e,t,{ts:n}),g();else{const U=o[1],A=o[2],S=o[3],$=o[4];re(e,t,{x:U,y:A,ts:n}),g();const V=Pe(e,O);nt(e,V,{x:S,y:$})&&h(V)}}}else if(P===f.INPUT_EV_MOUSE_UP){const T=He(e,t);if(T>=0){const E=Pe(e,T);Pt(e,E,0),h(E);const O=rt(e,T),U=fs(e,T);if(wc(e,E)&&ee.pointDistance(U,O)<i.info.snapDistance){const A=ee.pointSub(U,O);nt(e,E,A),Go(e,E),h(E);let S=Io(e,t);Et(e)===Le.FINAL?S+=E.length:Et(e)===Le.ANY&&(S+=1),re(e,t,{d:0,ts:n,points:S}),g(),Dt(e)===zt(e)&&(st(e,{finished:n}),a()),p=!0}else{const A=($,V,m,ne)=>{const K=N[$].puzzle.info;if(m<0||gc($,V,m))return!1;const ie=rt($,V),Te=ee.pointAdd(rt($,m),{x:ne[0]*K.tileSize,y:ne[1]*K.tileSize});if(ee.pointDistance(ie,Te)<K.snapDistance){const Se=ee.pointSub(Te,ie);let me=Pe($,V);if(nt($,me,Se),B($,V,m),me=Pe($,V),rc($,m))Go($,me);else{const Be=oc($,me);Bo($,me,Be)}return h(me),!0}return!1};let S=!1;for(const $ of Pe(e,T)){const V=nc(e,$);if(A(e,$,V[0],[0,1])||A(e,$,V[1],[-1,0])||A(e,$,V[2],[0,-1])||A(e,$,V[3],[1,0])){S=!0;break}}if(S&&Et(e)===Le.ANY){const $=Io(e,t)+1;re(e,t,{d:0,ts:n,points:$}),g()}else re(e,t,{d:0,ts:n}),g();S&&gs(e)===xe.REAL&&Dt(e)===zt(e)&&(st(e,{finished:n}),a()),S&&(p=!0)}}else re(e,t,{d:0,ts:n}),g()}else if(P===f.INPUT_EV_ZOOM_IN){const C=o[1],T=o[2];re(e,t,{x:C,y:T,ts:n}),g()}else if(P===f.INPUT_EV_ZOOM_OUT){const C=o[1],T=o[2];re(e,t,{x:C,y:T,ts:n}),g()}else re(e,t,{ts:n}),g();return p&&l.push([f.PLAYER_SNAP,t]),l}function ws(e){return e.puzzle.data.started}function vs(e){return e.puzzle.data.finished}function so(e){let t=0;for(const o of e.puzzle.tiles)Y.decodePiece(o).owner===-1&&t++;return t}function no(e){return e.puzzle.tiles.length}function Es(e){return e.players.map(Y.decodePlayer)}function Ps(e,t){const o=t-hs*be.SEC;return Es(e).filter(n=>n.ts>=o)}function Ec(e,t){const o=t-hs*be.SEC;return Es(e).filter(n=>n.ts<o&&n.points>0)}function bs(e){var o;const t=((o=e.puzzle.info.image)==null?void 0:o.url)||e.puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Pc(e){return so(e)===no(e)}var D={setGame:Du,unsetGame:Bu,loaded:Mu,playerExists:ps,getActivePlayers:Yu,getIdlePlayers:Wu,addPlayer:Fu,getFinishedPiecesCount:Dt,getPieceCount:zt,getImageUrl:Hu,get:Zu,getGroupedPieceCount:uc,getPlayerBgColor:dc,getPlayerColor:hc,getPlayerName:pc,getPlayerIndexById:ht,getPlayerIdByIndex:Gu,changePlayer:re,setPlayer:Qt,setPiece:Iu,setPuzzleData:xu,getBounds:Jt,getTableWidth:to,getTableHeight:oo,getPuzzle:mc,getRng:fc,getPuzzleWidth:_c,getPuzzleHeight:yc,getPiecesSortedByZIndex:ju,getFirstOwnedPiece:Ju,getPieceDrawOffset:_s,getPieceDrawSize:eo,getFinalPiecePos:fs,getStartTs:ec,getFinishTs:tc,handleInput:vc,Game_getStartTs:ws,Game_getFinishTs:vs,Game_getFinishedPiecesCount:so,Game_getPieceCount:no,Game_getActivePlayers:Ps,Game_getImageUrl:bs,Game_isFinished:Pc};let Ts=-10,Cs=20,Bt=2,$s=15;const bc=5,Tc=5,io=1,Cc=200,xo=10,$c=100,Sc=10,kc=1,Ac=5;function Oc(e){const t=e.random(0,255),o=e.random(0,255),n=e.random(0,255);return"rgba("+t+","+o+","+n+", 0.8)"}class Yo{constructor(t){this.radius=xo,this.previousRadius=xo,this.explodingDuration=$c,this.hasExploded=!1,this.alive=!0,this.color=Oc(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Ts+Math.random()*Cs,this.vy=(Bt+Math.random()*$s)*-1,this.duration=0}update(t){if(this.hasExploded){const o=Cc-this.radius;this.previousRadius=this.radius,this.radius+=o/Sc,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=io,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const o=3+Math.floor(Math.random()*3);for(let n=0;n<o;n++){const i=10+Math.floor(Math.random()*21),l=bc+Math.random()*Tc,a=2*Math.PI/i,u=Math.random()*a;for(let h=0;h<i;h++)t.push(new Nc(this,h*a+u,l))}}}class Nc{constructor(t,o,n){this.px=t.px,this.py=t.py,this.vx=Math.cos(o)*n,this.vy=Math.sin(o)*n,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=io/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class Uc{constructor(t,o){this.canvas=t,this.rng=o,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,o=0;for(;t<this.canvas.height&&o>=0;)o+=io,t+=o;Bt=o/2,$s=o-Bt;const n=1/4*this.canvas.width/(o/2);Ts=-n,Cs=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<kc;t++)this.readyBombs.push(new Yo(this.rng))}update(){Math.random()*100<Ac&&this.readyBombs.push(new Yo(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const o=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):o.push(i)}this.readyBombs=o;const n=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&n.push(i)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function Rc(e,t,o,n){let i=[],l=!0,a=!1,u=!1,h=!1,g=!1,p=!1,B=!1,P=!1;const C=(b,I)=>{const L=o.viewportToWorld({x:b,y:I});return[L.x,L.y]},T=(b,I)=>{const L=o.viewportDimToWorld({w:b,h:I});return[L.w,L.h]},E=b=>C(b.offsetX,b.offsetY),O=()=>C(e.width/2,e.height/2),U=(b,I)=>{!l||(I.code==="ShiftLeft"||I.code==="ShiftRight"?P=b:I.code==="ArrowUp"||I.code==="KeyW"?h=b:I.code==="ArrowDown"||I.code==="KeyS"?g=b:I.code==="ArrowLeft"||I.code==="KeyA"?a=b:I.code==="ArrowRight"||I.code==="KeyD"?u=b:I.code==="KeyQ"?B=b:I.code==="KeyE"&&(p=b))};let A=!1,S=null,$=null;const V=b=>{$=E(b),S=[b.offsetX,b.offsetY],b.button===0&&(A=!0,Q([f.INPUT_EV_MOUSE_DOWN,...$]))},m=b=>{$=E(b),S=[b.offsetX,b.offsetY],b.button===0&&(A=!1,Q([f.INPUT_EV_MOUSE_UP,...$]))},ne=b=>{if(!S)return;$=E(b);const I=T(-(S[0]-b.offsetX),-(S[1]-b.offsetY));Q([f.INPUT_EV_MOUSE_MOVE,...$,...I,A?1:0]),S=[b.offsetX,b.offsetY]},K=b=>{if($=E(b),o.canZoom(b.deltaY<0?"in":"out")){const I=b.deltaY<0?f.INPUT_EV_ZOOM_IN:f.INPUT_EV_ZOOM_OUT;Q([I,...$])}},ie=b=>U(!0,b),Te=b=>U(!1,b),Se=b=>{if(!!l){if(n===ve&&(b.code==="KeyI"?Q([f.INPUT_EV_REPLAY_SPEED_UP]):b.code==="KeyO"?Q([f.INPUT_EV_REPLAY_SPEED_DOWN]):b.code==="KeyP"&&Q([f.INPUT_EV_REPLAY_TOGGLE_PAUSE])),b.code==="KeyH")Q([f.INPUT_EV_TOGGLE_INTERFACE]);else if(b.code==="Space")Q([f.INPUT_EV_TOGGLE_PREVIEW]);else if(b.code==="KeyF")Q([f.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(b.code==="KeyG")Q([f.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(b.code==="KeyM")Q([f.INPUT_EV_TOGGLE_SOUNDS]);else if(b.code==="KeyN")Q([f.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(b.code==="KeyT")Q([f.INPUT_EV_TOGGLE_TABLE]);else if(b.code==="KeyC")Q([f.INPUT_EV_CENTER_FIT_PUZZLE]);else for(let I=0;I<=9;I++)if(b.code===`Digit${I}`){const L=b.shiftKey?f.INPUT_EV_STORE_POS:f.INPUT_EV_RESTORE_POS;Q([L,I]);break}}},me=()=>{e.addEventListener("mousedown",V),e.addEventListener("mouseup",m),e.addEventListener("mousemove",ne),e.addEventListener("wheel",K),t.addEventListener("keydown",ie),t.addEventListener("keyup",Te),t.addEventListener("keypress",Se)},Be=()=>{e.removeEventListener("mousedown",V),e.removeEventListener("mouseup",m),e.removeEventListener("mousemove",ne),e.removeEventListener("wheel",K),t.removeEventListener("keydown",ie),t.removeEventListener("keyup",Te),t.removeEventListener("keypress",Se)},Ye=(b,I)=>{if(!S||!$)return;const L=new Lt(b).viewportToWorld({x:S[0],y:S[1]}),we=new Lt(I).viewportToWorld({x:S[0],y:S[1]}),ue=[-(L.x-we.x),-(L.y-we.y)];Q([f.INPUT_EV_MOUSE_MOVE,...$,...ue,A?1:0])},Q=b=>{i.push(b)};return{registerEvents:me,unregisterEvents:Be,addEvent:Q,consumeAll:()=>{if(i.length===0)return[];const b=i.slice();return i=[],b},createKeyEvents:()=>{const b=(a?1:0)-(u?1:0),I=(h?1:0)-(g?1:0);if(b!==0||I!==0){const L=(P?24:12)*Math.sqrt(o.getCurrentZoom()),we=o.viewportDimToWorld({w:b*L,h:I*L});Q([f.INPUT_EV_MOVE,we.w,we.h]),$&&($[0]-=we.w,$[1]-=we.h)}if(!(p&&B)){if(p){if(o.canZoom("in")){const L=$||O();Q([f.INPUT_EV_ZOOM_IN,...L])}}else if(B&&o.canZoom("out")){const L=$||O();Q([f.INPUT_EV_ZOOM_OUT,...L])}}},createSnapshotEvents:Ye,setHotkeys:b=>{l=b}}}const it={"./grab.png":cu,"./grab_mask.png":hu,"./hand.png":gu,"./hand_mask.png":fu},bt={"./assets/textures/Oak-none-3275x2565mm-Architextures.jpg":nu,"./assets/textures/wood-dark.jpg":lu,"./assets/textures/wood-light.jpg":au},Wo={"./click.mp3":eu,"./click2.mp3":ou},je="play",ve="replay";let Ae=!0,Oe=!0;const Lc=e=>e.owner===-1?Ae:Oe;let te=!0;async function Ss(e,t,o,n,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const a=r=>n===ve||r.id!==t,u=Wo["./click.mp3"].default,h=Wo["./click2.mp3"].default,g=new Audio(u),p=new Audio(h),B=await de.loadImageToBitmap(it["./grab.png"].default),P=await de.loadImageToBitmap(it["./hand.png"].default),C=await de.loadImageToBitmap(it["./grab_mask.png"].default),T=await de.loadImageToBitmap(it["./hand_mask.png"].default),E=B.width,O=Math.round(E/2),U=B.height,A=Math.round(U/2),S={},$=async r=>{const c=r.color+" "+r.d;if(!S[c]){const w=r.d?B:P;if(r.color){const x=r.d?C:T;S[c]=await createImageBitmap(de.colorizedCanvas(w,x,r.color))}else S[c]=w}return S[c]},V=i,m={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};$e.onConnectionStateChange(r=>{l.emit("connectionState",r)});const ne=async r=>{const c=m.dataOffset;m.dataOffset+=1e4;const w=await $e.requestReplayData(r,c);return m.log=m.log.slice(m.logPointer),m.logPointer=0,m.log.push(...w.log),w.log.length===0&&(m.final=!0),w};let K=()=>0;const ie=async()=>{if(n===je){const r=await $e.connect(o,e,t),c=Y.decodeGame(r);D.setGame(c.id,c),K=()=>be.timestamp()}else if(n===ve){const r=await ne(e);if(!r.game)throw"[ 2021-05-29 no game received ]";const c=Y.decodeGame(r.game);D.setGame(c.id,c),m.lastRealTs=be.timestamp(),m.gameStartTs=parseInt(r.log[0][4],10),m.lastGameTs=m.gameStartTs,K=()=>m.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";te=!0};await ie();const Te=D.getPieceDrawOffset(e),Se=D.getPieceDrawSize(e),me=D.getPuzzleWidth(e),Be=D.getPuzzleHeight(e),Ye=D.getTableWidth(e),Q=D.getTableHeight(e),lo={x:(Ye-me)/2,y:(Q-Be)/2},pt={w:me,h:Be},ro={w:Se,h:Se},b=await Vu.loadPuzzleBitmaps(D.getPuzzle(e)),I=new Uc(V,D.getRng(e));I.init();const L=V.getContext("2d");V.classList.add("loaded"),l.emit("puzzleCut");let we="";const ue={},z=new Lt;z.calculateZoomCapping(window.innerWidth,window.innerHeight,Ye,Q);const Os=()=>{z.reset(),z.move(-(Ye-V.width)/2,-(Q-V.height)/2);const r=z.worldDimToViewportRaw(pt),c=20,w=V.width-c*2,x=V.height-c*2;if(r.w>w||r.h>x||r.w<w&&r.h<x){const F=Math.min(w/r.w,x/r.h),Z={x:V.width/2,y:V.height/2};z.setZoom(F,Z)}},ce=Rc(V,window,z,n);ce.registerEvents();const Xe=r=>{if(ue.last&&we===r){const c=z.snapshot(),w=ue.last;return z.fromSnapshot(w),ce.createSnapshotEvents(c,w),delete ue.last,"last"}else if(ue[r]){const c=ue[r],w=z.snapshot();return ue.last=w,we=r,z.fromSnapshot(c),ce.createSnapshotEvents(w,c),r}else return null};Os(),ue.center=z.snapshot();const Ns=D.getImageUrl(e),Qe=r=>{const c=D.getStartTs(e),w=D.getFinishTs(e);l.emit("status",{finished:!!w,duration:(w||r)-c,piecesDone:D.getFinishedPiecesCount(e),piecesTotal:D.getPieceCount(e)}),l.emit("players",{active:D.getActivePlayers(e,r),idle:D.getIdlePlayers(e,r)})};Qe(K());const ao=!!D.getFinishTs(e);let gt=ao;const uo=()=>gt&&!ao,mt=()=>X.getInt(J.SOUND_VOLUME,pe.SOUND_VOLUME),co=()=>X.getBool(J.OTHER_PLAYER_CLICK_SOUND_ENABLED,pe.OTHER_PLAYER_CLICK_SOUND_ENABLED),ft=()=>X.getBool(J.SOUND_ENABLED,pe.SOUND_ENABLED),ho=()=>X.getBool(J.SHOW_PLAYER_NAMES,pe.SHOW_PLAYER_NAMES),Us=()=>X.getBool(J.SHOW_TABLE,pe.SHOW_TABLE),Rs=()=>X.getStr(J.TABLE_TEXTURE,pe.TABLE_TEXTURE),po=()=>n===ve?X.getStr(J.COLOR_BACKGROUND,pe.COLOR_BACKGROUND):D.getPlayerBgColor(e,t)||X.getStr(J.COLOR_BACKGROUND,pe.COLOR_BACKGROUND),go=()=>n===ve?X.getStr(J.PLAYER_COLOR,pe.PLAYER_COLOR):D.getPlayerColor(e,t)||X.getStr(J.PLAYER_COLOR,pe.PLAYER_COLOR),Ls=()=>n===ve?X.getStr(J.PLAYER_NAME,pe.PLAYER_NAME):D.getPlayerName(e,t)||X.getStr(J.PLAYER_NAME,pe.PLAYER_NAME),mo=()=>{const r=mt();g.volume=r/100,g.play()},Vs=()=>{const r=mt();p.volume=r/100,p.play()},G={background:po(),showTable:Us(),tableTexture:Rs(),color:go(),name:Ls(),soundsEnabled:ft(),otherPlayerClickSoundEnabled:co(),soundsVolume:mt(),showPlayerNames:ho()};ce.addEvent([f.INPUT_EV_BG_COLOR,G.background]),ce.addEvent([f.INPUT_EV_PLAYER_COLOR,G.color]),ce.addEvent([f.INPUT_EV_PLAYER_NAME,G.name]);let fo="",_o="",yo=!1;const We=r=>{yo=r;const[c,w]=r?[fo,"grab"]:[_o,"default"];V.style.cursor=`url('${c}') ${O} ${A}, ${w}`},_t=r=>{fo=de.colorizedCanvas(B,C,r).toDataURL(),_o=de.colorizedCanvas(P,T,r).toDataURL(),We(yo)};_t(go());const Je=()=>{l.emit("replaySpeed",m.speeds[m.speedIdx]),l.emit("replayPaused",m.paused)},q=(r,c=void 0)=>{l.emit("statusMessage",{what:r,value:c})},wo=()=>{m.speedIdx+1<m.speeds.length&&(m.speedIdx++,Je(),q("Speed Up"))},vo=()=>{m.speedIdx>=1&&(m.speedIdx--,Je(),q("Speed Down"))},Eo=()=>{m.paused=!m.paused,Je(),q(m.paused?"Paused":"Playing")};let et=!0;const Po=()=>{et=!et,l.emit("toggleInterface",et),q("Interface",et)};let Fe=!1;const bo=()=>{Fe=!Fe,l.emit("togglePreview",Fe)},To=()=>{G.soundsEnabled=!G.soundsEnabled;const r=G.soundsEnabled;l.emit("toggleSoundsEnabled",r),X.setBool(J.SOUND_ENABLED,r),q("Sounds",r)},Co=()=>{G.showPlayerNames=!G.showPlayerNames;const r=G.showPlayerNames;l.emit("togglePlayerNames",r),X.setBool(J.SHOW_PLAYER_NAMES,r),q("Player names",r)},$o=()=>{G.showTable=!G.showTable;const r=G.showTable;l.emit("toggleShowTable",r),X.setBool(J.SHOW_TABLE,r),q("Table",r)};l.on("replayOnSpeedUp",()=>{wo()}),l.on("replayOnSpeedDown",()=>{vo()}),l.on("replayOnPauseToggle",()=>{Eo()}),l.on("onPreviewChange",r=>{Fe!==r&&(Fe=r)}),l.on("onBgChange",r=>{G.background!==r&&(G.background=r,X.setStr(J.COLOR_BACKGROUND,r),ce.addEvent([f.INPUT_EV_BG_COLOR,r]),q("Background",r))}),l.on("onTableTextureChange",r=>{G.tableTexture!==r&&(G.tableTexture=r,X.setStr(J.TABLE_TEXTURE,r),q("Table texture",r),te=!0)}),l.on("onShowTableChange",r=>{G.showTable!==r&&(G.showTable=r,X.setStr(J.SHOW_TABLE,r),q("Table",r),te=!0)}),l.on("onColorChange",r=>{G.color!==r&&(G.color=r,X.setStr(J.PLAYER_COLOR,r),ce.addEvent([f.INPUT_EV_PLAYER_COLOR,r]),q("Color",r))}),l.on("onNameChange",r=>{G.name!==r&&(G.name=r,X.setStr(J.PLAYER_NAME,r),ce.addEvent([f.INPUT_EV_PLAYER_NAME,r]),q("Name",r))}),l.on("onOtherPlayerClickSoundEnabledChange",r=>{G.otherPlayerClickSoundEnabled!==r&&(G.otherPlayerClickSoundEnabled=r,X.setBool(J.OTHER_PLAYER_CLICK_SOUND_ENABLED,r),q("Other player sounds",r))}),l.on("onSoundsEnabledChange",r=>{G.soundsEnabled!==r&&(G.soundsEnabled=r,X.setBool(J.SOUND_ENABLED,r),q("Sounds",r))}),l.on("onSoundsVolumeChange",r=>{G.soundsVolume!==r&&(G.soundsVolume=r,X.setInt(J.SOUND_VOLUME,r),mo(),q("Volume",r))}),l.on("onShowPlayerNamesChange",r=>{G.showPlayerNames!==r&&(G.showPlayerNames=r,X.setBool(J.SHOW_PLAYER_NAMES,r),q("Player names",r))}),l.on("setHotkeys",r=>{ce.setHotkeys(r)}),l.on("requireRerender",()=>{te=!0});const So=[];let tt;const Ms=()=>{So.forEach(r=>{clearInterval(r)}),tt&&clearTimeout(tt)};if(n===je?So.push(setInterval(()=>{Qe(K())},1e3)):n===ve&&Je(),n===je)$e.onServerChange(r=>{r[0],r[1],r[2];const c=r[3];let w=!1,x=!1;for(const[F,Z]of c)switch(F){case f.CHANGE_PLAYER:{const R=Y.decodePlayer(Z);R.id!==t&&(D.setPlayer(e,R.id,R),w=!0)}break;case f.CHANGE_PIECE:{const R=Y.decodePiece(Z);D.setPiece(e,R.idx,R),w=!0}break;case f.CHANGE_DATA:D.setPuzzleData(e,Z),w=!0;break;case f.PLAYER_SNAP:Z!==t&&(x=!0);break}x&&ft()&&co()&&Vs(),w&&(te=!0),gt=!!D.getFinishTs(e)});else if(n===ve){const r=(x,F)=>{const Z=x;if(Z[0]===f.LOG_ADD_PLAYER){const R=Z[1];return D.addPlayer(e,R,F),!0}if(Z[0]===f.LOG_UPDATE_PLAYER){const R=D.getPlayerIdByIndex(e,Z[1]);if(!R)throw"[ 2021-05-17 player not found (update player) ]";return D.addPlayer(e,R,F),!0}if(Z[0]===f.LOG_HANDLE_INPUT){const R=D.getPlayerIdByIndex(e,Z[1]);if(!R)throw"[ 2021-05-17 player not found (handle input) ]";const fe=Z[2];return D.handleInput(e,R,fe,F),!0}return!1};let c=m.lastGameTs;const w=async()=>{m.logPointer+1>=m.log.length&&await ne(e);const x=be.timestamp();if(m.paused){m.lastRealTs=x,tt=setTimeout(w,50);return}const Z=(x-m.lastRealTs)*m.speeds[m.speedIdx];let R=m.lastGameTs+Z,fe=!0;do if(m.paused)fe=!1;else{const Ce=m.logPointer+1;if(Ce>=m.log.length)fe=!1;else{const he=m.log[m.logPointer],ko=c+he[he.length-1],yt=m.log[Ce],Ao=yt[yt.length-1],wt=ko+Ao;wt>R?(R+500*be.MS<wt&&(R+=Ao),fe=!1):(c=ko,r(yt,wt)&&(te=!0),m.logPointer=Ce)}}while(fe);m.lastRealTs=x,m.lastGameTs=R,Qe(K()),m.final||(tt=setTimeout(w,50))};w()}const zs=()=>{ce.createKeyEvents();for(const r of ce.consumeAll())if(n===je){const c=r[0];if(c===f.INPUT_EV_MOVE){const F=z.worldDimToViewportRaw({w:r[1],h:r[2]});te=!0,z.move(F.w,F.h),delete ue.last}else if(c===f.INPUT_EV_MOUSE_MOVE){if(r[5]&&!D.getFirstOwnedPiece(e,t)){const Z=z.worldDimToViewportRaw({w:r[3],h:r[4]});te=!0,z.move(Z.w,Z.h),delete ue.last}}else if(c===f.INPUT_EV_PLAYER_COLOR)_t(r[1]);else if(c===f.INPUT_EV_MOUSE_DOWN)We(!0);else if(c===f.INPUT_EV_MOUSE_UP)We(!1);else if(c===f.INPUT_EV_ZOOM_IN){const F={x:r[1],y:r[2]};te=!0,z.zoom("in",z.worldToViewportRaw(F)),delete ue.last}else if(c===f.INPUT_EV_ZOOM_OUT){const F={x:r[1],y:r[2]};te=!0,z.zoom("out",z.worldToViewportRaw(F)),delete ue.last}else if(c===f.INPUT_EV_TOGGLE_INTERFACE)Po();else if(c===f.INPUT_EV_TOGGLE_PREVIEW)bo();else if(c===f.INPUT_EV_TOGGLE_SOUNDS)To();else if(c===f.INPUT_EV_TOGGLE_PLAYER_NAMES)Co();else if(c===f.INPUT_EV_CENTER_FIT_PUZZLE){const F="center",Z=Xe(F);q(Z?`Restored position "${Z}"`:`Position "${F}" not set`)}else if(c===f.INPUT_EV_TOGGLE_FIXED_PIECES)Ae=!Ae,q(`${Ae?"Showing":"Hiding"} finished pieces`),te=!0;else if(c===f.INPUT_EV_TOGGLE_LOOSE_PIECES)Oe=!Oe,q(`${Oe?"Showing":"Hiding"} unfinished pieces`),te=!0;else if(c===f.INPUT_EV_TOGGLE_TABLE)$o();else if(c===f.INPUT_EV_STORE_POS){const F=`${r[1]}`;ue[F]=z.snapshot(),q(`Stored position ${F}`)}else if(c===f.INPUT_EV_RESTORE_POS){const F=`${r[1]}`,Z=Xe(F);q(Z?`Restored position "${Z}"`:`Position "${F}" not set`)}const w=K(),x=D.handleInput(e,t,r,w);ft()&&x.find(F=>F[0]===f.PLAYER_SNAP)&&mo(),x.length>0&&(te=!0),$e.sendClientEvent(r)}else if(n===ve){const c=r[0];if(c===f.INPUT_EV_REPLAY_TOGGLE_PAUSE)Eo();else if(c===f.INPUT_EV_REPLAY_SPEED_DOWN)vo();else if(c===f.INPUT_EV_REPLAY_SPEED_UP)wo();else if(c===f.INPUT_EV_MOVE){const w=z.worldDimToViewportRaw({w:r[1],h:r[2]});te=!0,z.move(w.w,w.h)}else if(c===f.INPUT_EV_MOUSE_MOVE){if(r[5]){const x=z.worldDimToViewportRaw({w:r[3],h:r[4]});te=!0,z.move(x.w,x.h)}}else if(c===f.INPUT_EV_PLAYER_COLOR)_t(r[1]);else if(c===f.INPUT_EV_MOUSE_DOWN)We(!0);else if(c===f.INPUT_EV_MOUSE_UP)We(!1);else if(c===f.INPUT_EV_ZOOM_IN){const w={x:r[1],y:r[2]};te=!0,z.zoom("in",z.worldToViewportRaw(w))}else if(c===f.INPUT_EV_ZOOM_OUT){const w={x:r[1],y:r[2]};te=!0,z.zoom("out",z.worldToViewportRaw(w))}else if(c===f.INPUT_EV_TOGGLE_INTERFACE)Po();else if(c===f.INPUT_EV_TOGGLE_PREVIEW)bo();else if(c===f.INPUT_EV_TOGGLE_SOUNDS)To();else if(c===f.INPUT_EV_TOGGLE_PLAYER_NAMES)Co();else if(c===f.INPUT_EV_CENTER_FIT_PUZZLE){const w="center",x=Xe(w);q(x?`Restored position "${x}"`:`Position "${w}" not set`)}else if(c===f.INPUT_EV_TOGGLE_FIXED_PIECES)Ae=!Ae,q(`${Ae?"Showing":"Hiding"} finished pieces`),te=!0;else if(c===f.INPUT_EV_TOGGLE_LOOSE_PIECES)Oe=!Oe,q(`${Oe?"Showing":"Hiding"} unfinished pieces`),te=!0;else if(c===f.INPUT_EV_TOGGLE_TABLE)$o();else if(c===f.INPUT_EV_STORE_POS){const w=`${r[1]}`;ue[w]=z.snapshot(),q(`Stored position ${w}`)}else if(c===f.INPUT_EV_RESTORE_POS){const w=`${r[1]}`,x=Xe(w);q(x?`Restored position "${x}"`:`Position "${w}" not set`)}}gt=!!D.getFinishTs(e),uo()&&(I.update(),te=!0)},Ds=new DOMMatrix([1,0,0,1,0,0]),Bs={dark:await de.loadImageToBitmap(bt["./assets/textures/wood-dark.jpg"].default),light:await de.loadImageToBitmap(bt["./assets/textures/wood-light.jpg"].default),brown:await de.loadImageToBitmap(bt["./assets/textures/Oak-none-3275x2565mm-Architextures.jpg"].default)},Gs=_u({update:zs,render:async()=>{if(!te)return;const r=K();let c,w,x;if(window.DEBUG&&ke.checkpoint_start(0),L.fillStyle=po(),L.fillRect(0,0,V.width,V.height),G.showTable){const R=Bs[G.tableTexture];if(R){const fe=D.getBounds(e);c=z.worldToViewportRaw(fe),w=z.worldDimToViewportRaw(fe);const Ce=L.createPattern(R,"repeat");Ce.setTransform(Ds.translate(c.x,c.y).scale(z.getCurrentZoom()*3)),L.fillStyle=Ce,L.fillRect(c.x,c.y,w.w,w.h);const he=z.worldDimToViewportRaw({w:16,h:16});L.fillStyle="rgba(0, 0, 0, .5)",L.fillRect(c.x,c.y,w.w,he.h),L.fillRect(c.x,c.y+he.h,he.w,w.h-2*he.h),L.fillRect(c.x+w.w-he.w,c.y+he.h,he.w,w.h-2*he.h),L.fillRect(c.x,c.y+w.h-he.h,w.w,he.w)}}if(window.DEBUG&&ke.checkpoint("clear done"),c=z.worldToViewportRaw(lo),w=z.worldDimToViewportRaw(pt),G.showTable){const R=z.worldDimToViewportRaw({w:8,h:8});L.fillStyle="rgba(0, 0, 0, .5)",L.fillRect(c.x-R.w,c.y-R.h,w.w+2*R.w,R.h),L.fillRect(c.x-R.w,c.y,R.h,w.h),L.fillRect(c.x+w.w,c.y,R.w,w.h),L.fillRect(c.x-R.w,c.y+w.h,w.w+2*R.w,R.h)}G.showTable&&["dark","brown"].includes(G.tableTexture)?L.fillStyle="rgba(0, 0, 0, .3)":L.fillStyle="rgba(255, 255, 255, .3)",L.fillRect(c.x,c.y,w.w,w.h),window.DEBUG&&ke.checkpoint("board done");const F=D.getPiecesSortedByZIndex(e);window.DEBUG&&ke.checkpoint("get pieces done"),w=z.worldDimToViewportRaw(ro);for(const R of F)!Lc(R)||(x=b[R.idx],c=z.worldToViewportRaw({x:Te+R.pos.x,y:Te+R.pos.y}),L.drawImage(x,0,0,x.width,x.height,c.x,c.y,w.w,w.h));window.DEBUG&&ke.checkpoint("pieces done");const Z=[];for(const R of D.getActivePlayers(e,r))a(R)&&(x=await $(R),c=z.worldToViewport(R),L.drawImage(x,c.x-O,c.y-A),ho()&&Z.push([`${R.name} (${R.points})`,c.x,c.y+U]));L.fillStyle="white",L.textAlign="center";for(const[R,fe,Ce]of Z)L.fillText(R,fe,Ce);window.DEBUG&&ke.checkpoint("players done"),Qe(r),window.DEBUG&&ke.checkpoint("HUD done"),uo()&&I.render(),te=!1}}),Is=()=>{Ms(),Gs.stop(),ce&&ce.unregisterEvents()};return{previewImageUrl:Ns,player:G,game:D.get(e),disconnect:$e.disconnect,connect:ie,unload:Is}}const Vc=oe({name:"game",components:{PuzzleStatusComponent:Ft,Scores:Wt,SettingsOverlay:Zt,PreviewOverlay:Ht,InfoOverlay:jt,ConnectionOverlay:us,HelpOverlay:Xt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,interface:!0,eventBus:Zo(),g:{player:jo(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleInterface",t=>{this.interface=!!t}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("toggleShowTable",t=>{this.g.player.showTable=!!t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.showTable,t=>{this.eventBus.emit("onShowTableChange",t)}),this.$watch(()=>this.g.player.tableTexture,t=>{this.eventBus.emit("onTableTextureChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Ss(`${this.$route.params.id}`,ye.clientId(),this.$config.WS_ADDRESS,je,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggleTo(e,t,o){t===!1?(this.overlay="",o&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,o&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}}}),Mc={id:"game"},zc=y(" Cutting puzzle, please wait... "),Dc={key:4,class:"menu-left"},Bc={key:0,class:"switch-game-replay"},Gc=y(" Watch replay"),Ic={key:5,class:"menu"},xc=y(" Puzzles"),Yc=y(" Preview"),Wc=y(" Settings"),Fc=y(" Info"),Zc=y(" Hotkeys"),Hc={class:"opener",href:"https://stand-with-ukraine.pp.ua/",target:"_blank"},jc=y(" Stand with Ukraine "),Kc={key:6,class:"menu-right"},qc={key:7,class:"status-messages"},Xc={ref:"canvas"};function Qc(e,t,o,n,i,l){const a=k("settings-overlay"),u=k("preview-overlay"),h=k("info-overlay"),g=k("help-overlay"),p=k("icon"),B=k("overlay"),P=k("connection-overlay"),C=k("puzzle-status"),T=k("router-link"),E=k("scores");return d(),v("div",Mc,[e.overlay==="settings"?(d(),H(a,{key:0,onClose:t[0]||(t[0]=O=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=O=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=O=>e.g.player=O)},null,8,["modelValue"])):M("",!0),e.overlay==="preview"?(d(),H(u,{key:1,onClose:t[3]||(t[3]=O=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=O=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):M("",!0),e.g.game&&e.overlay==="info"?(d(),H(h,{key:2,onClose:t[5]||(t[5]=O=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=O=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):M("",!0),e.overlay==="help"?(d(),H(g,{key:3,onClose:t[7]||(t[7]=O=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=O=>e.toggle("help",!0))})):M("",!0),j(_(B,null,{default:le(()=>[s("div",null,[_(p,{icon:"hourglass"}),zc,_(p,{icon:"hourglass"})])]),_:1},512),[[Fo,e.cuttingPuzzle]]),_(P,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),e.interface?(d(),v("div",Dc,[_(C,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(d(),v("div",Bc,[_(T,{to:{name:"replay",params:{id:e.g.game.id}}},{default:le(()=>[_(p,{icon:"replay"}),Gc]),_:1},8,["to"])])):M("",!0)])):M("",!0),e.interface?(d(),v("div",Ic,[_(T,{class:"opener",to:{name:"index"},target:"_blank"},{default:le(()=>[_(p,{icon:"puzzle-piece"}),xc]),_:1}),s("div",{class:"opener",onClick:t[9]||(t[9]=O=>e.toggle("preview",!1))},[_(p,{icon:"preview"}),Yc]),s("div",{class:"opener",onClick:t[10]||(t[10]=O=>e.toggle("settings",!0))},[_(p,{icon:"settings"}),Wc]),s("div",{class:"opener",onClick:t[11]||(t[11]=O=>e.toggle("info",!0))},[_(p,{icon:"info"}),Fc]),s("div",{class:"opener",onClick:t[12]||(t[12]=O=>e.toggle("help",!0))},[_(p,{icon:"hotkey"}),Zc]),s("a",Hc,[_(p,{icon:"ukraine-heart"}),jc])])):M("",!0),e.interface?(d(),v("div",Kc,[_(E,{players:e.players},null,8,["players"])])):M("",!0),e.statusMessages.length?(d(),v("div",qc,[(d(!0),v(ae,null,ge(e.statusMessages,(O,U)=>(d(),v("div",{key:U},W(O),1))),128))])):M("",!0),s("canvas",Xc,null,512)])}var Jc=se(Vc,[["render",Qc]]);const ed=oe({name:"replay",components:{PuzzleStatusComponent:Ft,Scores:Wt,SettingsOverlay:Zt,PreviewOverlay:Ht,InfoOverlay:jt,HelpOverlay:Xt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,interface:!0,eventBus:Zo(),g:{player:jo(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleInterface",t=>{this.interface=!!t}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("toggleShowTable",t=>{this.g.player.showTable=!!t}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.showTable,t=>{this.eventBus.emit("onShowTableChange",t)}),this.$watch(()=>this.g.player.tableTexture,t=>{this.eventBus.emit("onTableTextureChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Ss(`${this.$route.params.id}`,ye.clientId(),this.$config.WS_ADDRESS,ve,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggleTo(e,t,o){t===!1?(this.overlay="",o&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,o&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),td={id:"replay"},od={key:4,class:"overlay"},sd={class:"overlay-content"},nd=y(" Cutting puzzle, please wait... "),id={key:5,class:"menu-left"},ld={class:"playback-control"},rd={key:0,class:"switch-game-replay"},ad=y(" To the game"),ud={key:6,class:"menu"},cd=y(" Puzzles"),dd=y(" Preview"),hd=y(" Settings"),pd=y(" Info"),gd=y(" Hotkeys"),md={class:"opener",href:"https://stand-with-ukraine.pp.ua/",target:"_blank"},fd=y(" Stand with Ukraine "),_d={key:7,class:"menu-right"},yd={key:8,class:"status-messages"},wd={ref:"canvas"};function vd(e,t,o,n,i,l){const a=k("settings-overlay"),u=k("preview-overlay"),h=k("info-overlay"),g=k("help-overlay"),p=k("icon"),B=k("puzzle-status"),P=k("router-link"),C=k("scores");return d(),v("div",td,[e.overlay==="settings"?(d(),H(a,{key:0,onClose:t[0]||(t[0]=T=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=T=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=T=>e.g.player=T)},null,8,["modelValue"])):M("",!0),e.overlay==="preview"?(d(),H(u,{key:1,onClose:t[3]||(t[3]=T=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=T=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):M("",!0),e.g.game&&e.overlay==="info"?(d(),H(h,{key:2,onClose:t[5]||(t[5]=T=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=T=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):M("",!0),e.overlay==="help"?(d(),H(g,{key:3,onClose:t[7]||(t[7]=T=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=T=>e.toggle("help",!0))})):M("",!0),e.cuttingPuzzle?(d(),v("div",od,[s("div",sd,[s("div",null,[_(p,{icon:"hourglass"}),nd,_(p,{icon:"hourglass"})])])])):M("",!0),e.interface?(d(),v("div",id,[_(B,{status:e.status},null,8,["status"]),s("div",ld,[s("div",null,W(e.replayText),1),s("button",{class:"btn",onClick:t[9]||(t[9]=T=>e.eventBus.emit("replayOnSpeedUp"))},[_(p,{icon:"speed-up"})]),s("button",{class:"btn",onClick:t[10]||(t[10]=T=>e.eventBus.emit("replayOnSpeedDown"))},[_(p,{icon:"speed-down"})]),s("button",{class:"btn",onClick:t[11]||(t[11]=T=>e.eventBus.emit("replayOnPauseToggle"))},[_(p,{icon:"pause"})])]),e.g.game?(d(),v("div",rd,[_(P,{to:{name:"game",params:{id:e.g.game.id}}},{default:le(()=>[_(p,{icon:"puzzle-piece"}),ad]),_:1},8,["to"])])):M("",!0)])):M("",!0),e.interface?(d(),v("div",ud,[_(P,{class:"opener",to:{name:"index"},target:"_blank"},{default:le(()=>[_(p,{icon:"puzzle-piece"}),cd]),_:1}),s("div",{class:"opener",onClick:t[12]||(t[12]=T=>e.toggle("preview",!1))},[_(p,{icon:"preview"}),dd]),s("div",{class:"opener",onClick:t[13]||(t[13]=T=>e.toggle("settings",!0))},[_(p,{icon:"settings"}),hd]),s("div",{class:"opener",onClick:t[14]||(t[14]=T=>e.toggle("info",!0))},[_(p,{icon:"info"}),pd]),s("div",{class:"opener",onClick:t[15]||(t[15]=T=>e.toggle("help",!0))},[_(p,{icon:"hotkey"}),gd]),s("a",md,[_(p,{icon:"ukraine-heart"}),fd])])):M("",!0),e.interface?(d(),v("div",_d,[_(C,{players:e.players},null,8,["players"])])):M("",!0),e.statusMessages.length?(d(),v("div",yd,[(d(!0),v(ae,null,ge(e.statusMessages,(T,E)=>(d(),v("div",{key:E},W(T),1))),128))])):M("",!0),s("canvas",wd,null,512)])}var Ed=se(ed,[["render",vd]]);const Pd=oe({props:{icon:null},setup(e){return(t,o)=>(d(),v("i",{class:Ue(["icon",`icon-${e.icon}`])},null,2))}});let ks=null;async function bd(){ks=await(await ye.get("/api/me",{})).json()}var As={getMe:()=>ks,init:bd};const Td=oe({props:{image:{type:Object,required:!0}},data:()=>({me:As.getMe()}),computed:{url(){return this.image.url.replace("uploads/","uploads/r/")+"-375x0.webp"},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}}),Cd=["src"],$d={class:"imageteaser-info"};function Sd(e,t,o,n,i,l){const a=k("icon");return d(),v("div",{class:"imageteaser",onClick:t[1]||(t[1]=(...u)=>e.onClick&&e.onClick(...u))},[s("img",{src:e.url},null,8,Cd),e.canEdit?(d(),v("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=Tt((...u)=>e.onEditClick&&e.onEditClick(...u),["stop"]))},[_(a,{icon:"edit"})])):M("",!0),s("div",$d,W(e.image.gameCount)+"x plays ",1)])}var kd=se(Td,[["render",Sd]]);const Ad=oe({emits:{bgclick:null,close:null},methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Od={class:"overlay"},Nd={class:"overlay-content"};function Ud(e,t,o,n,i,l){return d(),v("div",Od,[s("div",{class:"overlay-background",onClick:t[0]||(t[0]=a=>e.$emit("bgclick"))}),s("div",Nd,[Ho(e.$slots,"default")])])}var Rd=se(Ad,[["render",Ud]]);const Ld={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Vd=["title"];function Md(e,t,o,n,i,l){return d(),v("div",{style:Me(l.style),title:o.title},null,12,Vd)}var zd=se(Ld,[["render",Md]]);const Dd=oe({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;if(e.code==="Escape")return this.autocomplete.values=[],this.autocomplete.idx=-1,e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),Bd={class:"input-holder"},Gd={key:0,class:"enter-hint color-highlight"},Id={key:0,class:"autocomplete"},xd=["onClick"],Yd=["onClick"];function Wd(e,t,o,n,i,l){return d(),v("div",null,[s("div",Bd,[j(s("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=a=>e.input=a),placeholder:"Plants, People",onKeydown:[t[1]||(t[1]=Oo(Tt((...a)=>e.add&&e.add(...a),["prevent"]),["enter"])),t[2]||(t[2]=Oo(Tt((...a)=>e.add&&e.add(...a),["prevent"]),["tab"]))],onKeyup:t[3]||(t[3]=(...a)=>e.onKeyUp&&e.onKeyUp(...a))},null,544),[[Re,e.input]]),e.input?(d(),v("div",Gd,"[Press ENTER/TAB to add]")):M("",!0)]),e.autocomplete.values?(d(),v("div",Id,[s("ul",null,[(d(!0),v(ae,null,ge(e.autocomplete.values,(a,u)=>(d(),v("li",{key:u,class:Ue({active:u===e.autocomplete.idx}),onClick:h=>e.addVal(a)},W(a),11,xd))),128))])])):M("",!0),(d(!0),v(ae,null,ge(e.values,(a,u)=>(d(),v("span",{key:u,class:"bit is-clickable",onClick:h=>e.rm(a)},W(a)+" \u2716",9,Yd))),128))])}var Fd=se(Dd,[["render",Wd]]);const Zd=["data-index"],Hd=oe({props:{columnWidth:{default:400},items:null,gap:{default:0},rtl:{type:Boolean,default:!1},ssrColumns:{default:0}},emits:["redraw","redraw-skip"],setup(e,{emit:t}){const o=e,{columnWidth:n,items:i,gap:l,rtl:a,ssrColumns:u}=Ws(o),h=No([]),g=No();function p(){g.value.getBoundingClientRect().width+l.value,n.value+l.value;const E=Math.floor((g.value.getBoundingClientRect().width+l.value)/(n.value+l.value));return E>0?E:1}function B(E){return[...new Array(E)].map(()=>[])}if(u.value>0){const E=B(u.value);i.value.forEach((O,U)=>E[U%u.value].push(U)),h.value=E}async function P(E){if(E>=i.value.length)return;await Hs();const O=[...g.value.children];a.value&&O.reverse();const U=O.reduce((A,S)=>S.getBoundingClientRect().height<A.getBoundingClientRect().height?S:A);h.value[+U.dataset.index].push(E),await P(E+1)}async function C(E=!1){if(h.value.length===p()&&!E){t("redraw-skip");return}h.value=B(p());const O=window.scrollY;await P(0),window.scrollTo({top:O}),t("redraw")}const T=new ResizeObserver(()=>C());return Fs(()=>{C(),T.observe(g.value)}),Zs(()=>T.unobserve(g.value)),Uo([i,a],()=>C(!0)),Uo([n,l],()=>C()),(E,O)=>(d(),v("div",{ref_key:"wall",ref:g,class:"masonry-wall",style:Me({display:"flex",gap:`${ot(l)}px`})},[(d(!0),v(ae,null,ge(h.value,(U,A)=>(d(),v("div",{key:A,class:"masonry-column","data-index":A,style:Me({display:"flex",flexBasis:0,flexDirection:"column",flexGrow:1,height:["-webkit-max-content","-moz-max-content","max-content"],gap:`${ot(l)}px`})},[(d(!0),v(ae,null,ge(U,S=>(d(),v("div",{key:S,class:"masonry-item"},[Ho(E.$slots,"default",{item:ot(i)[S],index:S},()=>[y(W(ot(i)[S]),1)])]))),128))],12,Zd))),128))],4))}});(async()=>{ye.init(),await As.init();const t=await(await ye.get("/api/conf",{})).json(),o=js({history:Ks(),routes:[{name:"index",path:"/",component:xn},{name:"new-game",path:"/new-game",component:pl},{name:"game",path:"/g/:id",component:Jc},{name:"replay",path:"/replay/:id",component:Ed}]});o.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const n=qs(rn);n.config.globalProperties.$config=t,n.use(o),n.component("connection-overlay",us),n.component("edit-image-dialog",os),n.component("game-teaser",Qo),n.component("help-overlay",Xt),n.component("icon",Pd),n.component("image-library",Jo),n.component("image-teaser",kd),n.component("info-overlay",jt),n.component("masonry-wall",Hd),n.component("new-game-dialog",ss),n.component("new-image-dialog",ts),n.component("overlay",Rd),n.component("preview-overlay",Ht),n.component("puzzle-status",Ft),n.component("responsive-image",zd),n.component("scores",Wt),n.component("settings-overlay",Zt),n.component("tags-input",Fd),n.mount("#app")})();
//# sourceMappingURL=index.00b2e388.js.map
