import{d as j,r as N,o as E,c as T,a as o,b as z,w as X,e as J,f as R,g as re,n as be,t as I,F as ie,h as pe,i as Ve,j as M,v as we,k as ve,l as to,m as le,p as sn,q as no,s as oo,u as ln,x as so,y as io,z as lo,A as ro,B as ao,C as uo}from"./vendor.0dfaad5f.js";const co=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function n(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=n(i);fetch(i.href,l)}};co();var W=(e,t)=>{const n=e.__vccOpts||e;for(const[s,i]of t)n[s]=i;return n};const po=j({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),ho={id:"app"},go={key:0,class:"nav"},fo=R("Games overview"),mo=R("New game");function yo(e,t,n,s,i,l){const r=N("router-link"),a=N("router-view");return E(),T("div",ho,[e.showNav?(E(),T("ul",go,[o("li",null,[z(r,{class:"btn",to:{name:"index"}},{default:X(()=>[fo]),_:1})]),o("li",null,[z(r,{class:"btn",to:{name:"new-game"}},{default:X(()=>[mo]),_:1})])])):J("",!0),z(a)])}var _o=W(po,[["render",yo]]);class He{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,n){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const s=(this.rand_high>>>0)/4294967295;return t+s*(n-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const n=t.slice();for(let s=0;s<=n.length-2;s++){const i=this.random(s,n.length-1),l=n[s];n[s]=n[i],n[i]=l}return n}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const n=new He(0);return n.rand_high=t.rand_high,n.rand_low=t.rand_low,n}}const Eo=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},ut=(e,t)=>{const n=`${e}`;return n.length>=t.length?n:t.substr(0,t.length-n.length)+n},ct=(...e)=>{const t=n=>(...s)=>{const i=new Date,l=ut(i.getHours(),"00"),r=ut(i.getMinutes(),"00"),a=ut(i.getSeconds(),"00");console[n](`${l}:${r}:${a}`,...e,...s)};return{log:t("log"),error:t("error"),info:t("info")}},wo=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function vo(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Po(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function To(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function Co(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function So(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function $o(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function bo(e){return[e.id,e.rng.type||"",He.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion]}function Ao(e){return{id:e[0],rng:{type:e[1],obj:He.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10]}}function Oo(e,t){const n=e.width/e.tileSize;return{x:t%n,y:Math.floor(t/n)}}const No=e=>{let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t|=0}return t};function Uo(e){const t=[];for(const n in e){const s=[n,e[n]].map(encodeURIComponent);t.push(s.join("="))}return t.length===0?"":`?${t.join("&")}`}var L={hash:No,slug:Eo,uniqId:wo,encodeShape:vo,decodeShape:Po,encodePiece:To,decodePiece:Co,encodePlayer:So,decodePlayer:$o,encodeGame:bo,decodeGame:Ao,coordByPieceIdx:Oo,asQueryArgs:Uo};const ne={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},he={SOUND_VOLUME:100,SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},dt=(e,t)=>{localStorage.setItem(e,t)},pt=e=>localStorage.getItem(e),ko=(e,t)=>{dt(e,`${t}`)},Ro=(e,t)=>{const n=pt(e);if(n===null)return t;const s=parseInt(n,10);return isNaN(s)?t:s},Vo=(e,t)=>{dt(e,t?"1":"0")},zo=(e,t)=>{const n=pt(e);return n===null?t:n==="1"},Lo=(e,t)=>{dt(e,t)},Mo=(e,t)=>{const n=pt(e);return n===null?t:n};var ee={setInt:ko,getInt:Ro,setBool:Vo,getBool:zo,setStr:Lo,getStr:Mo};let ht="",rn="";const gt=async(e,t,n)=>new Promise((s,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const r in n.headers||{})l.setRequestHeader(r,n.headers[r]);l.setRequestHeader("Client-Id",ht),l.setRequestHeader("Client-Secret",rn),l.addEventListener("load",function(r){s({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(r){i(new Error("xhr error"))}),l.upload&&n.onUploadProgress&&l.upload.addEventListener("progress",function(r){n.onUploadProgress&&n.onUploadProgress(r)}),l.send(n.body||null)}),an=e=>{let t=ee.getStr(e,"");return t||(t=L.uniqId(),ee.setStr(e,t)),t};var ae={init:()=>{ht=an("ID"),rn=an("SECRET")},request:gt,get:(e,t)=>gt("get",e,t),post:(e,t)=>gt("post",e,t),clientId:()=>ht};const un=1,ft=un*1e3,je=ft*60,Ze=je*60,mt=Ze*24,Do=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},cn=e=>{const t=Math.floor(e/mt);e=e%mt;const n=Math.floor(e/Ze);e=e%Ze;const s=Math.floor(e/je);e=e%je;const i=Math.floor(e/ft);return`${t}d ${n}h ${s}m ${i}s`},Fo=(e,t)=>cn(t-e);var ge={MS:un,SEC:ft,MIN:je,HOUR:Ze,DAY:mt,timestamp:Do,timeDiffStr:Fo,durationStr:cn};const Go=j({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const n=t?"\u{1F3C1}":"\u23F3",s=e,i=t||ge.timestamp(),l=ge.timeDiffStr(s,i);return`${n} ${l}`}}}),Io={class:"game-info-text"},Bo=o("br",null,null,-1),Yo=o("br",null,null,-1),xo=o("br",null,null,-1),Wo=R(" \u21AA\uFE0F Watch replay ");function Ho(e,t,n,s,i,l){const r=N("router-link");return E(),T("div",{class:"game-teaser",style:be(e.style)},[z(r,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:X(()=>[o("span",Io,[R(" \u{1F9E9} "+I(e.game.tilesFinished)+"/"+I(e.game.tilesTotal),1),Bo,R(" \u{1F465} "+I(e.game.players),1),Yo,R(" "+I(e.time(e.game.started,e.game.finished)),1),xo])]),_:1},8,["to"]),e.game.hasReplay?(E(),re(r,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:X(()=>[Wo]),_:1},8,["to"])):J("",!0)],4)}var dn=W(Go,[["render",Ho]]);const jo=j({components:{GameTeaser:dn},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ae.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),Zo=o("h1",null,"Running games",-1),Ko=o("h1",null,"Finished games",-1);function qo(e,t,n,s,i,l){const r=N("game-teaser");return E(),T("div",null,[Zo,(E(!0),T(ie,null,pe(e.gamesRunning,(a,y)=>(E(),T("div",{class:"game-teaser-wrap",key:y},[z(r,{game:a},null,8,["game"])]))),128)),Ko,(E(!0),T(ie,null,pe(e.gamesFinished,(a,y)=>(E(),T("div",{class:"game-teaser-wrap",key:y},[z(r,{game:a},null,8,["game"])]))),128))])}var Qo=W(jo,[["render",qo]]);const Xo=j({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function Jo(e,t,n,s,i,l){const r=N("image-teaser");return E(),T("div",null,[(E(!0),T(ie,null,pe(e.images,(a,y)=>(E(),re(r,{image:a,onClick:v=>e.imageClicked(a),onEditClick:v=>e.imageEditClicked(a),key:y},null,8,["image","onClick","onEditClick"]))),128))])}var pn=W(Xo,[["render",Jo]]);const es=j({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.droppable=!1},imageFromDragEvt(e){var s;const t=(s=e.dataTransfer)==null?void 0:s.items;if(!t||t.length===0)return null;const n=t[0];return n.type.startsWith("image/")?n:null},onFileSelect(e){const t=e.target;if(!t.files)return;const n=t.files[0];!n||this.preview(n)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=n=>{this.previewUrl=n.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const n=t.getAsFile();return n&&(this.file=n,this.preview(n),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),ts=o("div",{class:"drop-target"},null,-1),ns={key:0,class:"has-image"},os={key:1},ss={class:"upload"},is=o("span",{class:"btn"},"Upload File",-1),ls={class:"area-settings"},rs=o("td",null,[o("label",null,"Title")],-1),as=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),us=o("td",null,[o("label",null,"Tags")],-1),cs={class:"area-buttons"},ds=["disabled"],ps=R("\u{1F5BC}\uFE0F Post to gallery"),hs=["disabled"],gs=R("\u{1F9E9} Post to gallery "),fs=o("br",null,null,-1),ms=R(" + set up game");function ys(e,t,n,s,i,l){const r=N("responsive-image"),a=N("tags-input"),y=N("overlay");return E(),re(y,{class:"new-image-dialog"},{default:X(()=>[o("div",{class:Ve(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...v)=>e.onDrop&&e.onDrop(...v)),onDragover:t[3]||(t[3]=(...v)=>e.onDragover&&e.onDragover(...v)),onDragleave:t[4]||(t[4]=(...v)=>e.onDragleave&&e.onDragleave(...v))},[ts,e.previewUrl?(E(),T("div",ns,[o("span",{class:"remove btn",onClick:t[0]||(t[0]=v=>e.previewUrl="")},"X"),z(r,{src:e.previewUrl},null,8,["src"])])):(E(),T("div",os,[o("label",ss,[o("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...v)=>e.onFileSelect&&e.onFileSelect(...v)),accept:"image/*"},null,32),is])]))],34),o("div",ls,[o("table",null,[o("tr",null,[rs,o("td",null,[M(o("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=v=>e.title=v),placeholder:"Flower by @artist"},null,512),[[we,e.title]])])]),as,o("tr",null,[us,o("td",null,[z(a,{modelValue:e.tags,"onUpdate:modelValue":t[6]||(t[6]=v=>e.tags=v),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",cs,[o("button",{class:"btn",disabled:!e.canPostToGallery,onClick:t[7]||(t[7]=(...v)=>e.postToGallery&&e.postToGallery(...v))},[e.uploading==="postToGallery"?(E(),T(ie,{key:0},[R("Uploading ("+I(e.uploadProgressPercent)+"%)",1)],64)):(E(),T(ie,{key:1},[ps],64))],8,ds),o("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[8]||(t[8]=(...v)=>e.setupGameClick&&e.setupGameClick(...v))},[e.uploading==="setupGame"?(E(),T(ie,{key:0},[R("Uploading ("+I(e.uploadProgressPercent)+"%)",1)],64)):(E(),T(ie,{key:1},[gs,fs,ms],64))],8,hs)])]),_:1})}var hn=W(es,[["render",ys]]);const _s=j({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),Es={class:"area-image"},ws={class:"has-image"},vs={class:"area-settings"},Ps=o("td",null,[o("label",null,"Title")],-1),Ts=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Cs=o("td",null,[o("label",null,"Tags")],-1),Ss={class:"area-buttons"};function $s(e,t,n,s,i,l){const r=N("responsive-image"),a=N("tags-input"),y=N("overlay");return E(),re(y,{class:"edit-image-dialog"},{default:X(()=>[o("div",Es,[o("div",ws,[z(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),o("div",vs,[o("table",null,[o("tr",null,[Ps,o("td",null,[M(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=v=>e.title=v),placeholder:"Flower by @artist"},null,512),[[we,e.title]])])]),Ts,o("tr",null,[Cs,o("td",null,[z(a,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=v=>e.tags=v),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",Ss,[o("button",{class:"btn",onClick:t[2]||(t[2]=(...v)=>e.saveImage&&e.saveImage(...v))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var gn=W(_s,[["render",$s]]),fn;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(fn||(fn={}));var fe;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(fe||(fe={}));var Ae;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(Ae||(Ae={}));var Pe;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(Pe||(Pe={}));const bs=j({props:{image:{type:Object,required:!0}},emits:{newGame:null},data(){return{tiles:1e3,scoreMode:fe.ANY,shapeMode:Ae.NORMAL,snapMode:Pe.NORMAL}},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),As={class:"area-image"},Os={class:"has-image"},Ns={key:0,class:"image-title"},Us={key:0,class:"image-title-title"},ks={key:1,class:"image-title-dim"},Rs={class:"area-settings"},Vs=o("td",null,[o("label",null,"Pieces")],-1),zs=o("td",null,[o("label",null,"Scoring: ")],-1),Ls=R(" Any (Score when pieces are connected to each other or on final location)"),Ms=o("br",null,null,-1),Ds=R(" Final (Score when pieces are put to their final location)"),Fs=o("td",null,[o("label",null,"Shapes: ")],-1),Gs=R(" Normal"),Is=o("br",null,null,-1),Bs=R(" Any (Flat pieces can occur anywhere)"),Ys=o("br",null,null,-1),xs=R(" Flat (All pieces flat on all sides)"),Ws=o("td",null,[o("label",null,"Snapping: ")],-1),Hs=R(" Normal (Pieces snap to final destination and to each other)"),js=o("br",null,null,-1),Zs=R(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),Ks={key:0},qs=o("td",null,[o("label",null,"Tags: ")],-1),Qs={class:"area-buttons"},Xs=["disabled"];function Js(e,t,n,s,i,l){const r=N("responsive-image"),a=N("overlay");return E(),re(a,{class:"new-game-dialog"},{default:X(()=>[o("div",As,[o("div",Os,[z(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(E(),T("div",Ns,[e.image.title?(E(),T("span",Us,'"'+I(e.image.title)+'"',1)):J("",!0),e.image.width||e.image.height?(E(),T("span",ks,"("+I(e.image.width)+" \u2715 "+I(e.image.height)+")",1)):J("",!0)])):J("",!0)]),o("div",Rs,[o("table",null,[o("tr",null,[Vs,o("td",null,[M(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=y=>e.tiles=y)},null,512),[[we,e.tiles]])])]),o("tr",null,[zs,o("td",null,[o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=y=>e.scoreMode=y),value:"1"},null,512),[[ve,e.scoreMode]]),Ls]),Ms,o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=y=>e.scoreMode=y),value:"0"},null,512),[[ve,e.scoreMode]]),Ds])])]),o("tr",null,[Fs,o("td",null,[o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=y=>e.shapeMode=y),value:"0"},null,512),[[ve,e.shapeMode]]),Gs]),Is,o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=y=>e.shapeMode=y),value:"1"},null,512),[[ve,e.shapeMode]]),Bs]),Ys,o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=y=>e.shapeMode=y),value:"2"},null,512),[[ve,e.shapeMode]]),xs])])]),o("tr",null,[Ws,o("td",null,[o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=y=>e.snapMode=y),value:"0"},null,512),[[ve,e.snapMode]]),Hs]),js,o("label",null,[M(o("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=y=>e.snapMode=y),value:"1"},null,512),[[ve,e.snapMode]]),Zs])])]),e.image.tags.length?(E(),T("tr",Ks,[qs,o("td",null,[(E(!0),T(ie,null,pe(e.image.tags,(y,v)=>(E(),T("span",{key:v,class:"bit"},I(y.title),1))),128))])])):J("",!0)])]),o("div",Qs,[o("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[8]||(t[8]=(...y)=>e.onNewGameClick&&e.onNewGameClick(...y))}," \u{1F9E9} Generate Puzzle ",8,Xs)])]),_:1})}var mn=W(bs,[["render",Js]]);const ei=j({components:{ImageLibrary:pn,NewImageDialog:hn,EditImageDialog:gn,NewGameDialog:mn},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(n=>!t.includes(n.title)&&n.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(n=>n.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ae.get(`/api/newgame-data${L.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags);const n=await ae.post("/api/upload",{body:t,onUploadProgress:s=>{this.uploadProgress=s.loaded/s.total}});return this.uploadProgress=1,await n.json()},async saveImage(e){return await(await ae.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.dialog="new-game"},async onNewGame(e){const t=await ae.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const n=await t.json();this.$router.push({name:"game",params:{id:n.id}})}}}}),ti={class:"upload-image-teaser"},ni=o("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),oi={key:0},si=R(" Tags: "),ii=["onClick"],li=R(" Sort by: "),ri=o("option",{value:"date_desc"},"Newest first",-1),ai=o("option",{value:"date_asc"},"Oldest first",-1),ui=o("option",{value:"alpha_asc"},"A-Z",-1),ci=o("option",{value:"alpha_desc"},"Z-A",-1),di=[ri,ai,ui,ci];function pi(e,t,n,s,i,l){const r=N("image-library"),a=N("new-image-dialog"),y=N("edit-image-dialog"),v=N("new-game-dialog");return E(),T("div",null,[o("div",ti,[o("div",{class:"btn btn-big",onClick:t[0]||(t[0]=S=>e.dialog="new-image")},"Upload your image"),ni]),o("div",null,[e.tags.length>0?(E(),T("label",oi,[si,(E(!0),T(ie,null,pe(e.relevantTags,(S,D)=>(E(),T("span",{class:Ve(["bit is-clickable",{on:e.filters.tags.includes(S.slug)}]),key:D,onClick:m=>e.toggleTag(S)},I(S.title)+" ("+I(S.total)+")",11,ii))),128))])):J("",!0),o("label",null,[li,M(o("select",{"onUpdate:modelValue":t[1]||(t[1]=S=>e.filters.sort=S),onChange:t[2]||(t[2]=(...S)=>e.filtersChanged&&e.filtersChanged(...S))},di,544),[[to,e.filters.sort]])])]),z(r,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),M(z(a,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=S=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[le,e.dialog==="new-image"]]),M(z(y,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=S=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[le,e.dialog==="edit-image"]]),M(z(v,{onBgclick:t[5]||(t[5]=S=>e.dialog=""),onNewGame:e.onNewGame,image:e.image},null,8,["onNewGame","image"]),[[le,e.image&&e.dialog==="new-game"]])])}var hi=W(ei,[["render",pi]]);const gi=j({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),fi={class:"scores"},mi=o("div",null,"Scores",-1),yi=o("td",null,"\u26A1",-1),_i=o("td",null,"\u{1F4A4}",-1);function Ei(e,t,n,s,i,l){return E(),T("div",fi,[mi,o("table",null,[(E(!0),T(ie,null,pe(e.actives,(r,a)=>(E(),T("tr",{key:a,style:be({color:r.color})},[yi,o("td",null,I(r.name),1),o("td",null,I(r.points),1)],4))),128)),(E(!0),T(ie,null,pe(e.idles,(r,a)=>(E(),T("tr",{key:a,style:be({color:r.color})},[_i,o("td",null,I(r.name),1),o("td",null,I(r.points),1)],4))),128))])])}var yt=W(gi,[["render",Ei]]);const wi=j({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return ge.durationStr(this.status.duration)}}}),vi={class:"puzzle-status"};function Pi(e,t,n,s,i,l){return E(),T("div",vi,[o("div",null," \u{1F9E9} "+I(e.status.piecesDone)+"/"+I(e.status.piecesTotal),1),o("div",null,I(e.icon)+" "+I(e.durationStr),1)])}var _t=W(wi,[["render",Pi]]);const Ti=j({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch("background",this.emitChanges)),this.watches.push(this.$watch("color",this.emitChanges)),this.watches.push(this.$watch("name",this.emitChanges)),this.watches.push(this.$watch("soundsEnabled",this.emitChanges)),this.watches.push(this.$watch("soundsVolume",this.emitChanges)),this.watches.push(this.$watch("showPlayerNames",this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue),this.$watch("modelValue",e=>{this.apply(e)})}}),Oe=e=>(no("data-v-39db9680"),e=e(),oo(),e),Ci={class:"settings"},Si=Oe(()=>o("td",null,[o("label",null,"Background: ")],-1)),$i=Oe(()=>o("td",null,[o("label",null,"Color: ")],-1)),bi=Oe(()=>o("td",null,[o("label",null,"Name: ")],-1)),Ai=Oe(()=>o("td",null,[o("label",null,"Sounds: ")],-1)),Oi=Oe(()=>o("td",null,[o("label",null,"Sounds Volume: ")],-1)),Ni={class:"sound-volume"},Ui=["value"],ki=Oe(()=>o("td",null,[o("label",null,"Show player names: ")],-1));function Ri(e,t,n,s,i,l){const r=N("overlay");return E(),re(r,{class:"transparent"},{default:X(()=>[o("table",Ci,[o("tr",null,[Si,o("td",null,[M(o("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=a=>e.background=a)},null,512),[[we,e.background]])])]),o("tr",null,[$i,o("td",null,[M(o("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=a=>e.color=a)},null,512),[[we,e.color]])])]),o("tr",null,[bi,o("td",null,[M(o("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=a=>e.name=a)},null,512),[[we,e.name]])])]),o("tr",null,[Ai,o("td",null,[M(o("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=a=>e.soundsEnabled=a)},null,512),[[sn,e.soundsEnabled]])])]),o("tr",null,[Oi,o("td",Ni,[o("span",{onClick:t[4]||(t[4]=(...a)=>e.decreaseVolume&&e.decreaseVolume(...a))},"\u{1F509}"),o("input",{type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[5]||(t[5]=(...a)=>e.updateVolume&&e.updateVolume(...a))},null,40,Ui),o("span",{onClick:t[6]||(t[6]=(...a)=>e.increaseVolume&&e.increaseVolume(...a))},"\u{1F50A}")])]),o("tr",null,[ki,o("td",null,[M(o("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=a=>e.showPlayerNames=a)},null,512),[[sn,e.showPlayerNames]])])])])]),_:1})}var Et=W(Ti,[["render",Ri],["__scopeId","data-v-39db9680"]]);const Vi=j({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),zi={class:"preview"};function Li(e,t,n,s,i,l){const r=N("overlay");return E(),re(r,{class:"preview-overlay",animate:!1},{default:X(()=>[o("div",zi,[o("div",{class:"img",style:be(e.previewStyle)},null,4)])]),_:1})}var wt=W(Vi,[["render",Li]]);const Mi=j({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case fe.ANY:return["Any","Score when pieces are connected to each other or on final location"];case fe.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ae.FLAT:return["Flat","All pieces flat on all sides"];case Ae.ANY:return["Any","Flat pieces can occur anywhere"];case Ae.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case Pe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case Pe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),Di={class:"help"},Fi=o("tr",null,[o("td",{colspan:"2"},"Info about this puzzle")],-1),Gi=o("td",null,"Image Title: ",-1),Ii=o("td",null,"Scoring: ",-1),Bi=["title"],Yi=o("td",null,"Shapes: ",-1),xi=["title"],Wi=o("td",null,"Snapping: ",-1),Hi=["title"];function ji(e,t,n,s,i,l){const r=N("overlay");return E(),re(r,{class:"transparent"},{default:X(()=>[o("table",Di,[Fi,o("tr",null,[Gi,o("td",null,I(e.game.puzzle.info.image.title),1)]),o("tr",null,[Ii,o("td",null,[o("span",{title:e.snapMode[1]},I(e.scoreMode[0]),9,Bi)])]),o("tr",null,[Yi,o("td",null,[o("span",{title:e.snapMode[1]},I(e.shapeMode[0]),9,xi)])]),o("tr",null,[Wi,o("td",null,[o("span",{title:e.snapMode[1]},I(e.snapMode[0]),9,Hi)])])])]),_:1})}var vt=W(Mi,[["render",ji]]);const Zi=2,Ki=1,qi=4,Qi=2,Xi=3,Ji=1,el=2,tl=4,nl=3,ol=1,sl=2,il=3,ll=4,rl=5,al=6,ul=7,cl=8,dl=9,pl=10,hl=11,gl=12,fl=13,ml=14,yl=15,_l=16,El=17,wl=18,vl=19,Pl=20,Tl=21,Cl=1,Sl=2,$l=3;var p={EV_SERVER_EVENT:Ki,EV_SERVER_INIT:qi,EV_CLIENT_EVENT:Qi,EV_CLIENT_INIT:Xi,GAME_VERSION:Zi,LOG_HEADER:Ji,LOG_ADD_PLAYER:el,LOG_UPDATE_PLAYER:tl,LOG_HANDLE_INPUT:nl,INPUT_EV_MOVE:dl,INPUT_EV_MOUSE_DOWN:ol,INPUT_EV_MOUSE_UP:sl,INPUT_EV_MOUSE_MOVE:il,INPUT_EV_ZOOM_IN:ll,INPUT_EV_ZOOM_OUT:rl,INPUT_EV_BG_COLOR:al,INPUT_EV_PLAYER_COLOR:ul,INPUT_EV_PLAYER_NAME:cl,INPUT_EV_TOGGLE_PREVIEW:pl,INPUT_EV_TOGGLE_SOUNDS:hl,INPUT_EV_REPLAY_TOGGLE_PAUSE:gl,INPUT_EV_REPLAY_SPEED_UP:fl,INPUT_EV_REPLAY_SPEED_DOWN:ml,INPUT_EV_TOGGLE_PLAYER_NAMES:yl,INPUT_EV_CENTER_FIT_PUZZLE:_l,INPUT_EV_TOGGLE_FIXED_PIECES:El,INPUT_EV_TOGGLE_LOOSE_PIECES:wl,INPUT_EV_STORE_POS:vl,INPUT_EV_RESTORE_POS:Pl,INPUT_EV_CONNECTION_CLOSE:Tl,CHANGE_DATA:Cl,CHANGE_TILE:Sl,CHANGE_PLAYER:$l};const bl=ct("Communication.js"),Al=1001,Pt=4e3,yn=0,Tt=1,Ct=2,_n=3,En=4;let me,St=[],$t=e=>{St.push(e)},bt=[],At=e=>{bt.push(e)};function Ol(e){$t=e;for(const t of St)$t(t);St=[]}function Nl(e){At=e;for(const t of bt)At(t);bt=[]}let Ot=yn;const ze=e=>{Ot!==e&&(Ot=e,At(e))};function wn(e){if(Ot===Ct)try{me.send(JSON.stringify(e))}catch{bl.info("unable to send message.. maybe because ws is invalid?")}}let Ne,Ue;function Ul(e,t,n){return Ne=0,Ue={},ze(_n),new Promise(s=>{me=new WebSocket(e,n+"|"+t),me.onopen=()=>{ze(Ct),wn([p.EV_CLIENT_INIT])},me.onmessage=i=>{const l=JSON.parse(i.data),r=l[0];if(r===p.EV_SERVER_INIT){const a=l[1];s(a)}else if(r===p.EV_SERVER_EVENT){const a=l[1],y=l[2];if(a===n&&Ue[y]){delete Ue[y];return}$t(l)}else throw`[ 2021-05-09 invalid connect msgType ${r} ]`},me.onerror=()=>{throw ze(Tt),"[ 2021-05-15 onerror ]"},me.onclose=i=>{i.code===Pt||i.code===Al?ze(En):ze(Tt)}})}async function kl(e,t){const n={gameId:e,offset:t};return await(await ae.get(`/api/replay-data${L.asQueryArgs(n)}`,{})).json()}function Rl(){me&&me.close(Pt),Ne=0,Ue={}}function Vl(e){Ne++,Ue[Ne]=e,wn([p.EV_CLIENT_EVENT,Ne,Ue[Ne]])}var ye={connect:Ul,requestReplayData:kl,disconnect:Rl,sendClientEvent:Vl,onServerChange:Ol,onConnectionStateChange:Nl,CODE_CUSTOM_DISCONNECT:Pt,CONN_STATE_NOT_CONNECTED:yn,CONN_STATE_DISCONNECTED:Tt,CONN_STATE_CLOSED:En,CONN_STATE_CONNECTED:Ct,CONN_STATE_CONNECTING:_n};const zl=j({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===ye.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===ye.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),Ll={key:0},Ml={key:2};function Dl(e,t,n,s,i,l){const r=N("overlay");return M((E(),re(r,{class:"connection-lost"},{default:X(()=>[e.lostConnection?(E(),T("div",Ll,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):J("",!0),e.lostConnection?(E(),T("span",{key:1,class:"btn",onClick:t[0]||(t[0]=a=>e.$emit("reconnect"))},"Reconnect")):J("",!0),e.connecting?(E(),T("div",Ml,"Connecting...")):J("",!0)]),_:1},512)),[[le,e.show]])}var vn=W(zl,[["render",Dl]]);const Fl=j({}),Gl=o("table",{class:"help"},[o("tr",null,[o("td",null,"\u2B06\uFE0F Move up:"),o("td",null,[o("div",null,[o("kbd",null,"W"),R("/"),o("kbd",null,"\u2191"),R("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B07\uFE0F Move down:"),o("td",null,[o("div",null,[o("kbd",null,"S"),R("/"),o("kbd",null,"\u2193"),R("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B05\uFE0F Move left:"),o("td",null,[o("div",null,[o("kbd",null,"A"),R("/"),o("kbd",null,"\u2190"),R("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u27A1\uFE0F Move right:"),o("td",null,[o("div",null,[o("kbd",null,"D"),R("/"),o("kbd",null,"\u2192"),R("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td"),o("td",null,[o("div",null,[R("Move faster by holding "),o("kbd",null,"Shift")])])]),o("tr",null,[o("td",null,"\u{1F50D}+ Zoom in:"),o("td",null,[o("div",null,[o("kbd",null,"E"),R("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F50D}- Zoom out:"),o("td",null,[o("div",null,[o("kbd",null,"Q"),R("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),o("td",null,[o("div",null,[o("kbd",null,"Space")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Center puzzle in screen:"),o("td",null,[o("div",null,[o("kbd",null,"C")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),o("td",null,[o("div",null,[o("kbd",null,"F")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),o("td",null,[o("div",null,[o("kbd",null,"G")])])]),o("tr",null,[o("td",null,"\u{1F464} Toggle player names:"),o("td",null,[o("div",null,[o("kbd",null,"N")])])]),o("tr",null,[o("td",null,"\u{1F509} Toggle sounds:"),o("td",null,[o("div",null,[o("kbd",null,"M")])])]),o("tr",null,[o("td",null,"\u23EB Speed up (replay):"),o("td",null,[o("div",null,[o("kbd",null,"I")])])]),o("tr",null,[o("td",null,"\u23EC Speed down (replay):"),o("td",null,[o("div",null,[o("kbd",null,"O")])])]),o("tr",null,[o("td",null,"\u23F8\uFE0F Pause (replay):"),o("td",null,[o("div",null,[o("kbd",null,"P")])])])],-1);function Il(e,t,n,s,i,l){const r=N("overlay");return E(),re(r,{class:"transparent"},{default:X(()=>[Gl]),_:1})}var Nt=W(Fl,[["render",Il]]),Bl="/assets/click.bb97cb07.mp3",Yl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Bl}),xl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",Wl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:xl}),Hl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",jl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Hl}),Zl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Kl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Zl}),ql="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",Ql=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:ql});const Xl=e=>{let t=!1;const n=()=>{t=!0},s=e.fps||60,i=e.slow||1,l=e.update,r=e.render,a=window.requestAnimationFrame,y=1/s,v=i*y;let S,D=0,m=window.performance.now();const g=()=>{for(S=window.performance.now(),D=D+Math.min(1,(S-m)/1e3);D>v;)D=D-v,l(y);r(D/i),m=S,t||a(g)};return a(g),{stop:n}},Jl=.1,er=6,tr=.05;function nr(){let e=0,t=0,n=1;const s=()=>({x:e,y:t,curZoom:n}),i=d=>{e=d.x,t=d.y,n=d.curZoom},l=()=>{e=0,t=0,n=1},r=(d,u)=>{e+=d/n,t+=u/n},a=d=>{const u=d==="in"?1:-1,w=n+tr*n*u;return Math.min(Math.max(w,Jl),er)},y=d=>n!=a(d),v=(d,u)=>{if(n==d)return!1;const w=1-n/d;return r(-u.x*w,-u.y*w),n=d,!0},S=(d,u)=>v(a(d),u),D=d=>{const{x:u,y:w}=m(d);return{x:Math.round(u),y:Math.round(w)}},m=d=>({x:d.x/n-e,y:d.y/n-t}),g=d=>{const{x:u,y:w}=b(d);return{x:Math.round(u),y:Math.round(w)}},b=d=>({x:(d.x+e)*n,y:(d.y+t)*n}),_=d=>{const{w:u,h:w}=F(d);return{w:Math.round(u),h:Math.round(w)}},F=d=>({w:d.w*n,h:d.h*n}),A=d=>{const{w:u,h:w}=$(d);return{w:Math.round(u),h:Math.round(w)}},$=d=>({w:d.w/n,h:d.h/n});return{getCurrentZoom:()=>n,reset:l,move:r,canZoom:y,zoom:S,setZoom:v,worldToViewport:g,worldToViewportRaw:b,worldDimToViewport:_,worldDimToViewportRaw:F,viewportToWorld:D,viewportToWorldRaw:m,viewportDimToWorld:A,viewportDimToWorldRaw:$,snapshot:s,fromSnapshot:i}}function Ut(e=0,t=0){const n=document.createElement("canvas");return n.width=e,n.height=t,n}async function or(e){return new Promise(t=>{const n=new Image;n.onload=()=>{createImageBitmap(n).then(t)},n.src=e})}async function sr(e,t,n){const s=Ut(t,n);return s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,n),await createImageBitmap(s)}function ir(e,t,n){const s=Ut(e.width,e.height),i=s.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=n,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),s}var ue={createCanvas:Ut,loadImageToBitmap:or,resizeBitmap:sr,colorizedCanvas:ir};const lr=ct("Debug.js");let kt=0,Pn=0;const rr=e=>{kt=performance.now(),Pn=e},ar=e=>{const t=performance.now(),n=t-kt;n>Pn&&lr.log(e+": "+n),kt=t};var Te={checkpoint_start:rr,checkpoint:ar};function ur(e,t){return{x:e.x-t.x,y:e.y-t.y}}function cr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Tn(e,t){const n=e.x-t.x,s=e.y-t.y;return Math.sqrt(n*n+s*s)}function dr(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Rt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function pr(e,t,n){return{x:e.x+t,y:e.y+n,w:e.w,h:e.h}}function hr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function gr(e,t){return Tn(Rt(e),Rt(t))}var x={pointSub:ur,pointAdd:cr,pointDistance:Tn,pointInBounds:dr,rectCenter:Rt,rectMoved:pr,rectCenterDistance:gr,rectsOverlap:hr};const Cn=ct("PuzzleGraphics.js");async function fr(e,t,n){Cn.log("start createPuzzleTileBitmaps");const s=n.tileSize,i=n.tileMarginWidth,l=n.tileDrawSize,r=s/100,a=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],y=new Array(t.length),v={};function S(_){const F=`${_.top}${_.right}${_.left}${_.bottom}`;if(v[F])return v[F];const A=new Path2D,$={x:i,y:i},d=x.pointAdd($,{x:s,y:0}),u=x.pointAdd(d,{x:0,y:s}),w=x.pointSub(u,{x:s,y:0});if(A.moveTo($.x,$.y),_.top!==0)for(let P=0;P<a.length/6;P++){const K=x.pointAdd($,{x:a[P*6+0]*r,y:_.top*a[P*6+1]*r}),Z=x.pointAdd($,{x:a[P*6+2]*r,y:_.top*a[P*6+3]*r}),h=x.pointAdd($,{x:a[P*6+4]*r,y:_.top*a[P*6+5]*r});A.bezierCurveTo(K.x,K.y,Z.x,Z.y,h.x,h.y)}else A.lineTo(d.x,d.y);if(_.right!==0)for(let P=0;P<a.length/6;P++){const K=x.pointAdd(d,{x:-_.right*a[P*6+1]*r,y:a[P*6+0]*r}),Z=x.pointAdd(d,{x:-_.right*a[P*6+3]*r,y:a[P*6+2]*r}),h=x.pointAdd(d,{x:-_.right*a[P*6+5]*r,y:a[P*6+4]*r});A.bezierCurveTo(K.x,K.y,Z.x,Z.y,h.x,h.y)}else A.lineTo(u.x,u.y);if(_.bottom!==0)for(let P=0;P<a.length/6;P++){const K=x.pointSub(u,{x:a[P*6+0]*r,y:_.bottom*a[P*6+1]*r}),Z=x.pointSub(u,{x:a[P*6+2]*r,y:_.bottom*a[P*6+3]*r}),h=x.pointSub(u,{x:a[P*6+4]*r,y:_.bottom*a[P*6+5]*r});A.bezierCurveTo(K.x,K.y,Z.x,Z.y,h.x,h.y)}else A.lineTo(w.x,w.y);if(_.left!==0)for(let P=0;P<a.length/6;P++){const K=x.pointSub(w,{x:-_.left*a[P*6+1]*r,y:a[P*6+0]*r}),Z=x.pointSub(w,{x:-_.left*a[P*6+3]*r,y:a[P*6+2]*r}),h=x.pointSub(w,{x:-_.left*a[P*6+5]*r,y:a[P*6+4]*r});A.bezierCurveTo(K.x,K.y,Z.x,Z.y,h.x,h.y)}else A.lineTo($.x,$.y);return v[F]=A,A}const D=ue.createCanvas(l,l),m=D.getContext("2d"),g=ue.createCanvas(l,l),b=g.getContext("2d");for(const _ of t){const F=L.decodePiece(_),A=mr(n,F.idx),$=S(L.decodeShape(n.shapes[F.idx]));m.clearRect(0,0,l,l),m.save(),m.lineWidth=2,m.stroke($),m.globalCompositeOperation="source-in",m.drawImage(e,A.x-i,A.y-i,l,l,0,0,l,l),m.restore(),m.save(),m.globalCompositeOperation="source-in",m.globalAlpha=.2,m.fillStyle="black",m.fillRect(0,0,D.width,D.height),m.restore(),m.save(),m.clip($),m.drawImage(e,A.x-i,A.y-i,l,l,0,0,l,l),m.restore(),m.save(),m.clip($),m.strokeStyle="rgba(0,0,0,.4)",m.lineWidth=0,m.shadowColor="black",m.shadowBlur=2,m.shadowOffsetX=-1,m.shadowOffsetY=-1,m.stroke($),m.restore(),m.save(),m.clip($),m.strokeStyle="rgba(255,255,255,.4)",m.lineWidth=0,m.shadowColor="white",m.shadowBlur=2,m.shadowOffsetX=1,m.shadowOffsetY=1,m.stroke($),m.restore(),b.clearRect(0,0,l,l),b.save(),b.lineWidth=1,b.stroke($),b.globalCompositeOperation="source-in",b.drawImage(e,A.x-i,A.y-i,l,l,0,0,l,l),b.restore(),m.drawImage(g,0,0),y[F.idx]=await createImageBitmap(D)}return Cn.log("end createPuzzleTileBitmaps"),y}function mr(e,t){const n=L.coordByPieceIdx(e,t);return{x:n.x*e.tileSize,y:n.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function yr(e){const t=await ue.loadImageToBitmap(e.info.imageUrl),n=await ue.resizeBitmap(t,e.info.width,e.info.height);return await fr(n,e.tiles,e.info)}var _r={loadPuzzleBitmaps:yr};const Sn=30,C={};function Er(e){return!!C[e]||!1}function wr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function vr(e,t){C[e]=t}function Ke(e,t){let n=0;for(const s of C[e].players){if(L.decodePlayer(s).id===t)return n;n++}return-1}function Pr(e,t){return C[e].players.length>t?L.decodePlayer(C[e].players[t]).id:null}function Ce(e,t){const n=Ke(e,t);return n===-1?null:L.decodePlayer(C[e].players[n])}function Vt(e,t,n){const s=Ke(e,t);s===-1?C[e].players.push(L.encodePlayer(n)):C[e].players[s]=L.encodePlayer(n)}function Tr(e,t,n){C[e].puzzle.tiles[t]=L.encodePiece(n)}function Cr(e,t){C[e].puzzle.data=t}function $n(e,t){return Ke(e,t)!==-1}function Sr(e,t){const n=t-Sn*ge.SEC;return bn(e).filter(s=>s.ts>=n)}function $r(e,t){const n=t-Sn*ge.SEC;return bn(e).filter(s=>s.ts<n&&s.points>0)}function br(e,t,n){$n(e,t)?te(e,t,{ts:n}):Vt(e,t,wr(t,n))}function Ar(){return Object.values(C).sort((e,t)=>{const n=On(e.id);return n===On(t.id)?n?t.puzzle.data.finished-e.puzzle.data.finished:t.puzzle.data.started-e.puzzle.data.started:n?1:-1})}function bn(e){return C[e]?C[e].players.map(L.decodePlayer):[]}function Or(e){return C[e]||null}function qe(e){return C[e].puzzle.tiles.length}function Nr(e){var n;const t=((n=C[e].puzzle.info.image)==null?void 0:n.url)||C[e].puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function zt(e){return C[e].scoreMode}function An(e){return C[e].snapMode}function On(e){return Qe(e)===qe(e)}function Qe(e){let t=0;for(const n of C[e].puzzle.tiles)L.decodePiece(n).owner===-1&&t++;return t}function Ur(e){return C[e].puzzle.tiles.map(L.decodePiece).sort((n,s)=>n.z-s.z)}function te(e,t,n){const s=Ce(e,t);if(s!==null){for(const i of Object.keys(n))s[i]=n[i];Vt(e,t,s)}}function Xe(e,t){for(const n of Object.keys(t))C[e].puzzle.data[n]=t[n]}function Se(e,t,n){for(const s of Object.keys(n)){const i=L.decodePiece(C[e].puzzle.tiles[t]);i[s]=n[s],C[e].puzzle.tiles[t]=L.encodePiece(i)}}const ke=(e,t)=>L.decodePiece(C[e].puzzle.tiles[t]),Je=(e,t)=>ke(e,t).group,kr=(e,t)=>{const n=C[e].puzzle.info;return t===0||t===n.tilesX-1||t===n.tiles-n.tilesX||t===n.tiles-1},Nn=(e,t)=>{const n=C[e].puzzle.info,s={x:(n.table.width-n.width)/2,y:(n.table.height-n.height)/2},i=Gr(e,t);return x.pointAdd(s,i)},et=(e,t)=>ke(e,t).pos,Rr=e=>{const t=Mn(e),n=Dn(e),s=Math.round(t/4),i=Math.round(n/4);return{x:0-s,y:0-i,w:t+2*s,h:n+2*i}},Vr=(e,t)=>ke(e,t).z,Le=(e,t)=>{for(const n of C[e].puzzle.tiles){const s=L.decodePiece(n);if(s.owner===t)return s.idx}return-1},zr=(e,t)=>{const n=Le(e,t);return n<0?null:C[e].puzzle.tiles[n]},Lr=e=>C[e].puzzle.info.tileDrawOffset,Un=e=>C[e].puzzle.info.tileDrawSize,Mr=e=>C[e].puzzle.data.started,Dr=e=>C[e].puzzle.data.finished,kn=e=>C[e].puzzle.data.maxGroup,Rn=e=>C[e].puzzle.data.maxZ,Fr=(e,t)=>{let n=0;for(const s of t){const i=Vr(e,s);i>n&&(n=i)}return n};function Gr(e,t){const n=C[e].puzzle.info,s=L.coordByPieceIdx(n,t),i=s.x*n.tileSize,l=s.y*n.tileSize;return{x:i,y:l}}function Ir(e,t){const n=C[e].puzzle.info,s=L.coordByPieceIdx(n,t);return[s.y>0?t-n.tilesX:-1,s.x<n.tilesX-1?t+1:-1,s.y<n.tilesY-1?t+n.tilesX:-1,s.x>0?t-1:-1]}const Vn=(e,t,n)=>{for(const s of t)Se(e,s,{z:n})},Br=(e,t,n)=>{const s=et(e,t),i=x.pointAdd(s,n);Se(e,t,{pos:i})},tt=(e,t,n)=>{const s=Un(e),i=Rr(e),l=n;for(const r of t){const a=ke(e,r);a.pos.x+n.x<i.x?l.x=Math.max(i.x-a.pos.x,l.x):a.pos.x+s+n.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-a.pos.x+s,l.x)),a.pos.y+n.y<i.y?l.y=Math.max(i.y-a.pos.y,l.y):a.pos.y+s+n.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-a.pos.y+s,l.y))}if(!l.x&&!l.y)return!1;for(const r of t)Br(e,r,l);return!0},Yr=(e,t)=>xr(e,t)===-1,xr=(e,t)=>ke(e,t).owner,zn=(e,t)=>{for(const n of t)Se(e,n,{owner:-1,z:1})},Lt=(e,t,n)=>{for(const s of t)Se(e,s,{owner:n})};function _e(e,t){const n=C[e].puzzle.tiles,s=L.decodePiece(n[t]),i=[];if(s.group)for(const l of n){const r=L.decodePiece(l);r.group===s.group&&i.push(r.idx)}else i.push(s.idx);return i}const Wr=(e,t)=>{const n=C[e].puzzle.info,s=C[e].puzzle.tiles;let i=-1,l=-1;for(let r=0;r<s.length;r++){const a=L.decodePiece(s[r]);if(a.owner!==0)continue;const y={x:a.pos.x,y:a.pos.y,w:n.tileSize,h:n.tileSize};x.pointInBounds(t,y)&&(i===-1||a.z>i)&&(i=a.z,l=r)}return l},Hr=(e,t)=>{const n=Ce(e,t);return n?n.bgcolor:null},jr=(e,t)=>{const n=Ce(e,t);return n?n.color:null},Zr=(e,t)=>{const n=Ce(e,t);return n?n.name:null},Ln=(e,t)=>{const n=Ce(e,t);return n?n.points:0},Kr=(e,t,n)=>{const s=Je(e,t),i=Je(e,n);return!!(s&&s===i)},Mn=e=>C[e].puzzle.info.table.width,Dn=e=>C[e].puzzle.info.table.height,qr=e=>C[e].puzzle,Qr=e=>C[e].rng.obj,Xr=e=>C[e].puzzle.info.width,Jr=e=>C[e].puzzle.info.height,ea=(e,t)=>{if(An(e)===Pe.REAL){for(const n of t)if(kr(e,n))return!0;return!1}return!0};function ta(e,t,n,s,i){const l=C[e].puzzle,r=[],a=()=>{r.push([p.CHANGE_DATA,l.data])},y=g=>{r.push([p.CHANGE_TILE,L.encodePiece(ke(e,g))])},v=g=>{for(const b of g)y(b)},S=()=>{const g=Ce(e,t);!g||r.push([p.CHANGE_PLAYER,L.encodePlayer(g)])},D=(g,b,_)=>{const F=C[g].puzzle.tiles,A=Je(g,b),$=Je(g,_);let d;const u=[];if(A&&u.push(A),$&&u.push($),A)d=A;else if($)d=$;else{const w=kn(g)+1;Xe(g,{maxGroup:w}),a(),d=kn(g)}if(Se(g,b,{group:d}),y(b),Se(g,_,{group:d}),y(_),u.length>0)for(const w of F){const P=L.decodePiece(w);u.includes(P.group)&&(Se(g,P.idx,{group:d}),y(P.idx))}},m=n[0];if(m===p.INPUT_EV_CONNECTION_CLOSE){const g=Le(e,t);if(g>=0){const b=_e(e,g);Lt(e,b,0),v(b)}}else if(m===p.INPUT_EV_BG_COLOR){const g=n[1];te(e,t,{bgcolor:g,ts:s}),S()}else if(m===p.INPUT_EV_PLAYER_COLOR){const g=n[1];te(e,t,{color:g,ts:s}),S()}else if(m===p.INPUT_EV_PLAYER_NAME){const g=`${n[1]}`.substr(0,16);te(e,t,{name:g,ts:s}),S()}else if(m===p.INPUT_EV_MOVE){const g=n[1],b=n[2],_=Ce(e,t);if(_){const F=_.x-g,A=_.y-b;te(e,t,{ts:s,x:F,y:A}),S();const $=Le(e,t);if($>=0){const d=_e(e,$),u={x:-g,y:-b};tt(e,d,u)&&v(d)}}}else if(m===p.INPUT_EV_MOUSE_DOWN){const g=n[1],b=n[2],_={x:g,y:b};te(e,t,{d:1,ts:s}),S();const F=Wr(e,_);if(F>=0){const A=Rn(e)+1;Xe(e,{maxZ:A}),a();const $=_e(e,F);Vn(e,$,Rn(e)),Lt(e,$,t),v($)}}else if(m===p.INPUT_EV_MOUSE_MOVE){const g=n[1],b=n[2];if(!n[5])te(e,t,{x:g,y:b,ts:s}),S();else{const F=Le(e,t);if(F<0)te(e,t,{ts:s}),S();else{const A=n[1],$=n[2],d=n[3],u=n[4];te(e,t,{x:A,y:$,ts:s}),S();const w=_e(e,F);tt(e,w,{x:d,y:u})&&v(w)}}}else if(m===p.INPUT_EV_MOUSE_UP){const g=0,b=Le(e,t);if(b>=0){const _=_e(e,b);Lt(e,_,0),v(_);const F=et(e,b),A=Nn(e,b);if(ea(e,_)&&x.pointDistance(A,F)<l.info.snapDistance){const $=x.pointSub(A,F);tt(e,_,$),zn(e,_),v(_);let d=Ln(e,t);zt(e)===fe.FINAL?d+=_.length:zt(e)===fe.ANY&&(d+=1),te(e,t,{d:g,ts:s,points:d}),S(),Qe(e)===qe(e)&&(Xe(e,{finished:s}),a()),i&&i(t)}else{const $=(u,w,P,K)=>{const Z=C[u].puzzle.info;if(P<0||Kr(u,w,P))return!1;const h=et(u,w),k=x.pointAdd(et(u,P),{x:K[0]*Z.tileSize,y:K[1]*Z.tileSize});if(x.pointDistance(h,k)<Z.snapDistance){const q=x.pointSub(k,h);let oe=_e(u,w);if(tt(u,oe,q),D(u,w,P),oe=_e(u,w),Yr(u,P))zn(u,oe);else{const Ge=Fr(u,oe);Vn(u,oe,Ge)}return v(oe),!0}return!1};let d=!1;for(const u of _e(e,b)){const w=Ir(e,u);if($(e,u,w[0],[0,1])||$(e,u,w[1],[-1,0])||$(e,u,w[2],[0,-1])||$(e,u,w[3],[1,0])){d=!0;break}}if(d&&zt(e)===fe.ANY){const u=Ln(e,t)+1;te(e,t,{d:g,ts:s,points:u}),S()}else te(e,t,{d:g,ts:s}),S();d&&An(e)===Pe.REAL&&Qe(e)===qe(e)&&(Xe(e,{finished:s}),a()),d&&i&&i(t)}}else te(e,t,{d:g,ts:s}),S()}else if(m===p.INPUT_EV_ZOOM_IN){const g=n[1],b=n[2];te(e,t,{x:g,y:b,ts:s}),S()}else if(m===p.INPUT_EV_ZOOM_OUT){const g=n[1],b=n[2];te(e,t,{x:g,y:b,ts:s}),S()}else te(e,t,{ts:s}),S();return r}var U={setGame:vr,exists:Er,playerExists:$n,getActivePlayers:Sr,getIdlePlayers:$r,addPlayer:br,getFinishedPiecesCount:Qe,getPieceCount:qe,getImageUrl:Nr,get:Or,getAllGames:Ar,getPlayerBgColor:Hr,getPlayerColor:jr,getPlayerName:Zr,getPlayerIndexById:Ke,getPlayerIdByIndex:Pr,changePlayer:te,setPlayer:Vt,setPiece:Tr,setPuzzleData:Cr,getTableWidth:Mn,getTableHeight:Dn,getPuzzle:qr,getRng:Qr,getPuzzleWidth:Xr,getPuzzleHeight:Jr,getPiecesSortedByZIndex:Ur,getFirstOwnedPiece:zr,getPieceDrawOffset:Lr,getPieceDrawSize:Un,getFinalPiecePos:Nn,getStartTs:Mr,getFinishTs:Dr,handleInput:ta};let Fn=-10,Gn=20,Mt=2,In=15;const na=5,oa=5,Dt=1,sa=200,Bn=10,ia=100,la=10,ra=1,aa=5;function ua(e){const t=e.random(0,255),n=e.random(0,255),s=e.random(0,255);return"rgba("+t+","+n+","+s+", 0.8)"}class Yn{constructor(t){this.radius=Bn,this.previousRadius=Bn,this.explodingDuration=ia,this.hasExploded=!1,this.alive=!0,this.color=ua(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Fn+Math.random()*Gn,this.vy=(Mt+Math.random()*In)*-1,this.duration=0}update(t){if(this.hasExploded){const n=sa-this.radius;this.previousRadius=this.radius,this.radius+=n/la,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=Dt,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const n=3+Math.floor(Math.random()*3);for(let s=0;s<n;s++){const i=10+Math.floor(Math.random()*21),l=na+Math.random()*oa,r=2*Math.PI/i,a=Math.random()*r;for(let y=0;y<i;y++)t.push(new ca(this,y*r+a,l))}}}class ca{constructor(t,n,s){this.px=t.px,this.py=t.py,this.vx=Math.cos(n)*s,this.vy=Math.sin(n)*s,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=Dt/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class da{constructor(t,n){this.canvas=t,this.rng=n,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,n=0;for(;t<this.canvas.height&&n>=0;)n+=Dt,t+=n;Mt=n/2,In=n-Mt;const s=1/4*this.canvas.width/(n/2);Fn=-s,Gn=2*s}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<ra;t++)this.readyBombs.push(new Yn(this.rng))}update(){Math.random()*100<aa&&this.readyBombs.push(new Yn(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const n=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):n.push(i)}this.readyBombs=n;const s=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&s.push(i)}this.particles=s}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function pa(e,t,n,s){let i=[],l=!0,r=!1,a=!1,y=!1,v=!1,S=!1,D=!1,m=!1;const g=(h,k)=>{const q=n.viewportToWorld({x:h,y:k});return[q.x,q.y]},b=(h,k)=>{const q=n.viewportDimToWorld({w:h,h:k});return[q.w,q.h]},_=h=>g(h.offsetX,h.offsetY),F=()=>g(e.width/2,e.height/2),A=(h,k)=>{!l||(k.code==="ShiftLeft"||k.code==="ShiftRight"?m=h:k.code==="ArrowUp"||k.code==="KeyW"?y=h:k.code==="ArrowDown"||k.code==="KeyS"?v=h:k.code==="ArrowLeft"||k.code==="KeyA"?r=h:k.code==="ArrowRight"||k.code==="KeyD"?a=h:k.code==="KeyQ"?D=h:k.code==="KeyE"&&(S=h))};let $=!1,d=null,u=null;e.addEventListener("mousedown",h=>{u=_(h),d=[h.offsetX,h.offsetY],h.button===0&&($=!0,w([p.INPUT_EV_MOUSE_DOWN,...u]))}),e.addEventListener("mouseup",h=>{u=_(h),d=[h.offsetX,h.offsetY],h.button===0&&($=!1,w([p.INPUT_EV_MOUSE_UP,...u]))}),e.addEventListener("mousemove",h=>{if(!d)return;u=_(h);const k=b(-(d[0]-h.offsetX),-(d[1]-h.offsetY));w([p.INPUT_EV_MOUSE_MOVE,...u,...k,$?1:0]),d=[h.offsetX,h.offsetY]}),e.addEventListener("wheel",h=>{if(u=_(h),n.canZoom(h.deltaY<0?"in":"out")){const k=h.deltaY<0?p.INPUT_EV_ZOOM_IN:p.INPUT_EV_ZOOM_OUT;w([k,...u])}}),t.addEventListener("keydown",h=>A(!0,h)),t.addEventListener("keyup",h=>A(!1,h)),t.addEventListener("keypress",h=>{if(!!l){if(s===ce&&(h.code==="KeyI"?w([p.INPUT_EV_REPLAY_SPEED_UP]):h.code==="KeyO"?w([p.INPUT_EV_REPLAY_SPEED_DOWN]):h.code==="KeyP"&&w([p.INPUT_EV_REPLAY_TOGGLE_PAUSE])),h.code==="Space")w([p.INPUT_EV_TOGGLE_PREVIEW]);else if(h.code==="KeyF")w([p.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(h.code==="KeyG")w([p.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(h.code==="KeyM")w([p.INPUT_EV_TOGGLE_SOUNDS]);else if(h.code==="KeyN")w([p.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(h.code==="KeyC")w([p.INPUT_EV_CENTER_FIT_PUZZLE]);else if(h.code==="Digit1"){const k=h.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;w([k,1])}else if(h.code==="Digit2"){const k=h.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;w([k,2])}else if(h.code==="Digit3"){const k=h.shiftKey?p.INPUT_EV_STORE_POS:p.INPUT_EV_RESTORE_POS;w([k,3])}}});const w=h=>{i.push(h)};return{addEvent:w,consumeAll:()=>{if(i.length===0)return[];const h=i.slice();return i=[],h},createKeyEvents:()=>{const h=(r?1:0)-(a?1:0),k=(y?1:0)-(v?1:0);if(h!==0||k!==0){const q=(m?24:12)*Math.sqrt(n.getCurrentZoom()),oe=n.viewportDimToWorld({w:h*q,h:k*q});w([p.INPUT_EV_MOVE,oe.w,oe.h]),u&&(u[0]-=oe.w,u[1]-=oe.h)}if(!(S&&D)){if(S){if(n.canZoom("in")){const q=u||F();w([p.INPUT_EV_ZOOM_IN,...q])}}else if(D&&n.canZoom("out")){const q=u||F();w([p.INPUT_EV_ZOOM_OUT,...q])}}},setHotkeys:h=>{l=h}}}const nt={"./grab.png":Wl,"./grab_mask.png":jl,"./hand.png":Kl,"./hand_mask.png":Ql},ha={"./click.mp3":Yl},Me="play",ce="replay";let De=!0,Fe=!0;const ga=e=>e.owner===-1?De:Fe;let H=!0;async function xn(e,t,n,s,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const r=c=>s===ce||c.id!==t,a=ha["./click.mp3"].default,y=new Audio(a),v=await ue.loadImageToBitmap(nt["./grab.png"].default),S=await ue.loadImageToBitmap(nt["./hand.png"].default),D=await ue.loadImageToBitmap(nt["./grab_mask.png"].default),m=await ue.loadImageToBitmap(nt["./hand_mask.png"].default),g=v.width,b=Math.round(g/2),_=v.height,F=Math.round(_/2),A={},$=async c=>{const f=c.color+" "+c.d;if(!A[f]){const O=c.d?v:S;if(c.color){const B=c.d?D:m;A[f]=await createImageBitmap(ue.colorizedCanvas(O,B,c.color))}else A[f]=O}return A[f]},d=i,u={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};ye.onConnectionStateChange(c=>{l.emit("connectionState",c)});const w=async c=>{const f=u.dataOffset;u.dataOffset+=1e4;const O=await ye.requestReplayData(c,f);return u.log=u.log.slice(u.logPointer),u.logPointer=0,u.log.push(...O.log),O.log.length===0&&(u.final=!0),O};let P=()=>0;const K=async()=>{if(s===Me){const c=await ye.connect(n,e,t),f=L.decodeGame(c);U.setGame(f.id,f),P=()=>ge.timestamp()}else if(s===ce){const c=await w(e);if(!c.game)throw"[ 2021-05-29 no game received ]";const f=L.decodeGame(c.game);U.setGame(f.id,f),u.lastRealTs=ge.timestamp(),u.gameStartTs=parseInt(c.log[0][4],10),u.lastGameTs=u.gameStartTs,P=()=>u.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";H=!0};await K();const Z=U.getPieceDrawOffset(e),h=U.getPieceDrawSize(e),k=U.getPuzzleWidth(e),q=U.getPuzzleHeight(e),oe=U.getTableWidth(e),Ge=U.getTableHeight(e),jn={x:(oe-k)/2,y:(Ge-q)/2},Ft={w:k,h:q},Zn={w:h,h},Kn=await _r.loadPuzzleBitmaps(U.getPuzzle(e)),ot=new da(d,U.getRng(e));ot.init();const de=d.getContext("2d");d.classList.add("loaded"),l.emit("puzzleCut");let Gt="";const se={},V=nr(),qn=()=>{V.reset(),V.move(-(oe-d.width)/2,-(Ge-d.height)/2);const c=V.worldDimToViewportRaw(Ft),f=20,O=d.width-f*2,B=d.height-f*2;if(c.w>O||c.h>B||c.w<O&&c.h<B){const G=Math.min(O/c.w,B/c.h),Q={x:d.width/2,y:d.height/2};V.setZoom(G,Q)}},Ie=c=>{se.last&&Gt===c?(V.fromSnapshot(se.last),delete se.last):se[c]&&(se.last=V.snapshot(),Gt=c,V.fromSnapshot(se[c]))};qn(),se.center=V.snapshot();const $e=pa(d,window,V,s),Qn=U.getImageUrl(e),Be=c=>{const f=U.getStartTs(e),O=U.getFinishTs(e);l.emit("status",{finished:!!O,duration:(O||c)-f,piecesDone:U.getFinishedPiecesCount(e),piecesTotal:U.getPieceCount(e)}),l.emit("players",{active:U.getActivePlayers(e,c),idle:U.getIdlePlayers(e,c)})};Be(P());const It=!!U.getFinishTs(e);let st=It;const Bt=()=>st&&!It,Yt=()=>ee.getInt(ne.SOUND_VOLUME,he.SOUND_VOLUME),xt=()=>ee.getBool(ne.SOUND_ENABLED,he.SOUND_ENABLED),Wt=()=>ee.getBool(ne.SHOW_PLAYER_NAMES,he.SHOW_PLAYER_NAMES),Ht=()=>{const c=Yt();y.volume=c/100,y.play()},jt=()=>s===ce?ee.getStr(ne.COLOR_BACKGROUND,he.COLOR_BACKGROUND):U.getPlayerBgColor(e,t)||ee.getStr(ne.COLOR_BACKGROUND,he.COLOR_BACKGROUND),Zt=()=>s===ce?ee.getStr(ne.PLAYER_COLOR,he.PLAYER_COLOR):U.getPlayerColor(e,t)||ee.getStr(ne.PLAYER_COLOR,he.PLAYER_COLOR),Xn=()=>s===ce?ee.getStr(ne.PLAYER_NAME,he.PLAYER_NAME):U.getPlayerName(e,t)||ee.getStr(ne.PLAYER_NAME,he.PLAYER_NAME);let Kt="",qt="",Qt=!1;const Re=c=>{Qt=c;const[f,O]=c?[Kt,"grab"]:[qt,"default"];d.style.cursor=`url('${f}') ${b} ${F}, ${O}`},it=c=>{Kt=ue.colorizedCanvas(v,D,c).toDataURL(),qt=ue.colorizedCanvas(S,m,c).toDataURL(),Re(Qt)};it(Zt());const Ye=()=>{l.emit("replaySpeed",u.speeds[u.speedIdx]),l.emit("replayPaused",u.paused)},Xt=()=>{u.speedIdx+1<u.speeds.length&&(u.speedIdx++,Ye())},Jt=()=>{u.speedIdx>=1&&(u.speedIdx--,Ye())},en=()=>{u.paused=!u.paused,Ye()};l.on("replayOnSpeedUp",()=>{Xt()}),l.on("replayOnSpeedDown",()=>{Jt()}),l.on("replayOnPauseToggle",()=>{en()}),l.on("onBgChange",c=>{ee.setStr(ne.COLOR_BACKGROUND,c),$e.addEvent([p.INPUT_EV_BG_COLOR,c])}),l.on("onColorChange",c=>{ee.setStr(ne.PLAYER_COLOR,c),$e.addEvent([p.INPUT_EV_PLAYER_COLOR,c])}),l.on("onNameChange",c=>{ee.setStr(ne.PLAYER_NAME,c),$e.addEvent([p.INPUT_EV_PLAYER_NAME,c])}),l.on("onSoundsEnabledChange",c=>{ee.setBool(ne.SOUND_ENABLED,c)}),l.on("onSoundsVolumeChange",c=>{ee.setInt(ne.SOUND_VOLUME,c),Ht()}),l.on("onShowPlayerNamesChange",c=>{ee.setBool(ne.SHOW_PLAYER_NAMES,c)}),l.on("setHotkeys",c=>{$e.setHotkeys(c)}),l.on("requireRerender",()=>{H=!0});const tn=[];let xe;const Jn=()=>{tn.forEach(c=>{clearInterval(c)}),xe&&clearTimeout(xe)};let lt;const eo=()=>{Jn(),lt&&lt.stop()};if(s===Me?tn.push(setInterval(()=>{Be(P())},1e3)):s===ce&&Ye(),s===Me)ye.onServerChange(c=>{c[0],c[1],c[2];const f=c[3];for(const[O,B]of f)switch(O){case p.CHANGE_PLAYER:{const G=L.decodePlayer(B);G.id!==t&&(U.setPlayer(e,G.id,G),H=!0)}break;case p.CHANGE_TILE:{const G=L.decodePiece(B);U.setPiece(e,G.idx,G),H=!0}break;case p.CHANGE_DATA:U.setPuzzleData(e,B),H=!0;break}st=!!U.getFinishTs(e)});else if(s===ce){const c=(B,G)=>{const Q=B;if(Q[0]===p.LOG_ADD_PLAYER){const Y=Q[1];return U.addPlayer(e,Y,G),!0}if(Q[0]===p.LOG_UPDATE_PLAYER){const Y=U.getPlayerIdByIndex(e,Q[1]);if(!Y)throw"[ 2021-05-17 player not found (update player) ]";return U.addPlayer(e,Y,G),!0}if(Q[0]===p.LOG_HANDLE_INPUT){const Y=U.getPlayerIdByIndex(e,Q[1]);if(!Y)throw"[ 2021-05-17 player not found (handle input) ]";const Ee=Q[2];return U.handleInput(e,Y,Ee,G),!0}return!1};let f=u.lastGameTs;const O=async()=>{u.logPointer+1>=u.log.length&&await w(e);const B=ge.timestamp();if(u.paused){u.lastRealTs=B,xe=setTimeout(O,50);return}const Q=(B-u.lastRealTs)*u.speeds[u.speedIdx];let Y=u.lastGameTs+Q;do{if(u.paused)break;const Ee=u.logPointer+1;if(Ee>=u.log.length)break;const We=u.log[u.logPointer],nn=f+We[We.length-1],rt=u.log[Ee],on=rt[rt.length-1],at=nn+on;if(at>Y){Y+500*ge.MS<at&&(Y+=on);break}f=nn,c(rt,at)&&(H=!0),u.logPointer=Ee}while(!0);u.lastRealTs=B,u.lastGameTs=Y,Be(P()),u.final||(xe=setTimeout(O,50))};O()}return lt=Xl({update:()=>{$e.createKeyEvents();for(const c of $e.consumeAll())if(s===Me){const f=c[0];if(f===p.INPUT_EV_MOVE){const G=V.worldDimToViewportRaw({w:c[1],h:c[2]});H=!0,V.move(G.w,G.h),delete se.last}else if(f===p.INPUT_EV_MOUSE_MOVE){if(c[5]&&!U.getFirstOwnedPiece(e,t)){const Q=V.worldDimToViewportRaw({w:c[3],h:c[4]});H=!0,V.move(Q.w,Q.h),delete se.last}}else if(f===p.INPUT_EV_PLAYER_COLOR)it(c[1]);else if(f===p.INPUT_EV_MOUSE_DOWN)Re(!0);else if(f===p.INPUT_EV_MOUSE_UP)Re(!1);else if(f===p.INPUT_EV_ZOOM_IN){const G={x:c[1],y:c[2]};H=!0,V.zoom("in",V.worldToViewportRaw(G)),delete se.last}else if(f===p.INPUT_EV_ZOOM_OUT){const G={x:c[1],y:c[2]};H=!0,V.zoom("out",V.worldToViewportRaw(G)),delete se.last}else if(f===p.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(f===p.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(f===p.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(f===p.INPUT_EV_CENTER_FIT_PUZZLE)Ie("center");else if(f===p.INPUT_EV_TOGGLE_FIXED_PIECES)De=!De,H=!0;else if(f===p.INPUT_EV_TOGGLE_LOOSE_PIECES)Fe=!Fe,H=!0;else if(f===p.INPUT_EV_STORE_POS){const G=`${c[1]}`;se[G]=V.snapshot()}else if(f===p.INPUT_EV_RESTORE_POS){const G=`${c[1]}`;Ie(G)}const O=P();U.handleInput(e,t,c,O,G=>{xt()&&Ht()}).length>0&&(H=!0),ye.sendClientEvent(c)}else if(s===ce){const f=c[0];if(f===p.INPUT_EV_REPLAY_TOGGLE_PAUSE)en();else if(f===p.INPUT_EV_REPLAY_SPEED_DOWN)Jt();else if(f===p.INPUT_EV_REPLAY_SPEED_UP)Xt();else if(f===p.INPUT_EV_MOVE){const O=V.worldDimToViewportRaw({w:c[1],h:c[2]});H=!0,V.move(O.w,O.h)}else if(f===p.INPUT_EV_MOUSE_MOVE){if(c[5]){const B=V.worldDimToViewportRaw({w:c[3],h:c[4]});H=!0,V.move(B.w,B.h)}}else if(f===p.INPUT_EV_PLAYER_COLOR)it(c[1]);else if(f===p.INPUT_EV_MOUSE_DOWN)Re(!0);else if(f===p.INPUT_EV_MOUSE_UP)Re(!1);else if(f===p.INPUT_EV_ZOOM_IN){const O={x:c[1],y:c[2]};H=!0,V.zoom("in",V.worldToViewportRaw(O))}else if(f===p.INPUT_EV_ZOOM_OUT){const O={x:c[1],y:c[2]};H=!0,V.zoom("out",V.worldToViewportRaw(O))}else if(f===p.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(f===p.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(f===p.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(f===p.INPUT_EV_CENTER_FIT_PUZZLE)Ie("center");else if(f===p.INPUT_EV_TOGGLE_FIXED_PIECES)De=!De,H=!0;else if(f===p.INPUT_EV_TOGGLE_LOOSE_PIECES)Fe=!Fe,H=!0;else if(f===p.INPUT_EV_STORE_POS){const O=`${c[1]}`;se[O]=V.snapshot()}else if(f===p.INPUT_EV_RESTORE_POS){const O=`${c[1]}`;Ie(O)}}st=!!U.getFinishTs(e),Bt()&&(ot.update(),H=!0)},render:async()=>{if(!H)return;const c=P();let f,O,B;window.DEBUG&&Te.checkpoint_start(0),de.fillStyle=jt(),de.fillRect(0,0,d.width,d.height),window.DEBUG&&Te.checkpoint("clear done"),f=V.worldToViewportRaw(jn),O=V.worldDimToViewportRaw(Ft),de.fillStyle="rgba(255, 255, 255, .3)",de.fillRect(f.x,f.y,O.w,O.h),window.DEBUG&&Te.checkpoint("board done");const G=U.getPiecesSortedByZIndex(e);window.DEBUG&&Te.checkpoint("get tiles done"),O=V.worldDimToViewportRaw(Zn);for(const Y of G)!ga(Y)||(B=Kn[Y.idx],f=V.worldToViewportRaw({x:Z+Y.pos.x,y:Z+Y.pos.y}),de.drawImage(B,0,0,B.width,B.height,f.x,f.y,O.w,O.h));window.DEBUG&&Te.checkpoint("tiles done");const Q=[];for(const Y of U.getActivePlayers(e,c))r(Y)&&(B=await $(Y),f=V.worldToViewport(Y),de.drawImage(B,f.x-b,f.y-F),Wt()&&Q.push([`${Y.name} (${Y.points})`,f.x,f.y+_]));de.fillStyle="white",de.textAlign="center";for(const[Y,Ee,We]of Q)de.fillText(Y,Ee,We);window.DEBUG&&Te.checkpoint("players done"),Be(c),window.DEBUG&&Te.checkpoint("HUD done"),Bt()&&ot.render(),H=!1}}),{previewImageUrl:Qn,player:{background:jt(),color:Zt(),name:Xn(),soundsEnabled:xt(),soundsVolume:Yt(),showPlayerNames:Wt()},game:U.get(e),disconnect:ye.disconnect,connect:K,unload:eo}}const fa=j({name:"game",components:{PuzzleStatusComponent:_t,Scores:yt,SettingsOverlay:Et,PreviewOverlay:wt,InfoOverlay:vt,ConnectionOverlay:vn,HelpOverlay:Nt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:ln(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)}),this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await xn(`${this.$route.params.id}`,ae.clientId(),this.$config.WS_ADDRESS,Me,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}}}),ma={id:"game"},ya=o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),_a={class:"menu-left"},Ea={key:0,class:"switch-game-replay"},wa=R("\u21AA\uFE0F Watch replay"),va={class:"menu"},Pa={class:"tabs"},Ta=R("\u{1F9E9} Puzzles"),Ca={class:"menu-right"},Sa={ref:"canvas"};function $a(e,t,n,s,i,l){const r=N("settings-overlay"),a=N("preview-overlay"),y=N("info-overlay"),v=N("help-overlay"),S=N("overlay"),D=N("connection-overlay"),m=N("puzzle-status"),g=N("router-link"),b=N("scores");return E(),T("div",ma,[M(z(r,{onClose:t[0]||(t[0]=_=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=_=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=_=>e.g.player=_)},null,8,["modelValue"]),[[le,e.overlay==="settings"]]),M(z(a,{onClose:t[3]||(t[3]=_=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=_=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[le,e.overlay==="preview"]]),e.g.game?M((E(),re(y,{key:0,onClose:t[5]||(t[5]=_=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=_=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[le,e.overlay==="info"]]):J("",!0),M(z(v,{onClose:t[7]||(t[7]=_=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=_=>e.toggle("help",!0))},null,512),[[le,e.overlay==="help"]]),M(z(S,null,{default:X(()=>[ya]),_:1},512),[[le,e.cuttingPuzzle]]),z(D,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),o("div",_a,[z(m,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(E(),T("div",Ea,[z(g,{to:{name:"replay",params:{id:e.g.game.id}}},{default:X(()=>[wa]),_:1},8,["to"])])):J("",!0)]),o("div",va,[o("div",Pa,[z(g,{class:"opener",to:{name:"index"},target:"_blank"},{default:X(()=>[Ta]),_:1}),o("div",{class:"opener",onClick:t[9]||(t[9]=_=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[10]||(t[10]=_=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[11]||(t[11]=_=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[12]||(t[12]=_=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",Ca,[z(b,{players:e.players},null,8,["players"])]),o("canvas",Sa,null,512)])}var ba=W(fa,[["render",$a]]);const Aa=j({name:"replay",components:{PuzzleStatusComponent:_t,Scores:yt,SettingsOverlay:Et,PreviewOverlay:wt,InfoOverlay:vt,HelpOverlay:Nt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:ln(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)}),this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await xn(`${this.$route.params.id}`,ae.clientId(),this.$config.WS_ADDRESS,ce,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Oa={id:"replay"},Na={key:1,class:"overlay"},Ua=o("div",{class:"overlay-content"},[o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),ka=[Ua],Ra={class:"menu-left"},Va={class:"playback-control"},za={key:0,class:"switch-game-replay"},La=R("\u{1F9E9} To the game"),Ma={class:"menu"},Da={class:"tabs"},Fa=R("\u{1F9E9} Puzzles"),Ga={class:"menu-right"},Ia={ref:"canvas"};function Ba(e,t,n,s,i,l){const r=N("settings-overlay"),a=N("preview-overlay"),y=N("info-overlay"),v=N("help-overlay"),S=N("puzzle-status"),D=N("router-link"),m=N("scores");return E(),T("div",Oa,[M(z(r,{onClose:t[0]||(t[0]=g=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=g=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=g=>e.g.player=g)},null,8,["modelValue"]),[[le,e.overlay==="settings"]]),M(z(a,{onClose:t[3]||(t[3]=g=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=g=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[le,e.overlay==="preview"]]),e.g.game?M((E(),re(y,{key:0,onClose:t[5]||(t[5]=g=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=g=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[le,e.overlay==="info"]]):J("",!0),M(z(v,{onClose:t[7]||(t[7]=g=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=g=>e.toggle("help",!0))},null,512),[[le,e.overlay==="help"]]),e.cuttingPuzzle?(E(),T("div",Na,ka)):J("",!0),o("div",Ra,[z(S,{status:e.status},null,8,["status"]),o("div",Va,[o("div",null,I(e.replayText),1),o("button",{class:"btn",onClick:t[9]||(t[9]=g=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),o("button",{class:"btn",onClick:t[10]||(t[10]=g=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),o("button",{class:"btn",onClick:t[11]||(t[11]=g=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")]),e.g.game?(E(),T("div",za,[z(D,{to:{name:"game",params:{id:e.g.game.id}}},{default:X(()=>[La]),_:1},8,["to"])])):J("",!0)]),o("div",Ma,[o("div",Da,[z(D,{class:"opener",to:{name:"index"},target:"_blank"},{default:X(()=>[Fa]),_:1}),o("div",{class:"opener",onClick:t[12]||(t[12]=g=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[13]||(t[13]=g=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[14]||(t[14]=g=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[15]||(t[15]=g=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",Ga,[z(m,{players:e.players},null,8,["players"])]),o("canvas",Ia,null,512)])}var Ya=W(Aa,[["render",Ba]]);let Wn=null;async function xa(){Wn=await(await ae.get("/api/me",{})).json()}var Hn={getMe:()=>Wn,init:xa};const Wa=j({props:{image:{type:Object,required:!0}},data:()=>({me:Hn.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function Ha(e,t,n,s,i,l){return E(),T("div",{class:"imageteaser",style:be(e.style),onClick:t[1]||(t[1]=(...r)=>e.onClick&&e.onClick(...r))},[e.canEdit?(E(),T("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=so((...r)=>e.onEditClick&&e.onEditClick(...r),["stop"]))},"\u270F\uFE0F")):J("",!0)],4)}var ja=W(Wa,[["render",Ha]]);const Za=j({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Ka={class:"overlay"};function qa(e,t,n,s,i,l){return E(),T("div",Ka,[o("div",{class:Ve(["overlay-background",e.classes.map(r=>"overlay-background-"+r)]),onClick:t[0]||(t[0]=r=>e.$emit("bgclick"))},null,2),o("div",{class:Ve(["overlay-content",e.classes.map(r=>"overlay-content-"+r)])},[io(e.$slots,"default")],2)])}var Qa=W(Za,[["render",qa]]);const Xa={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Ja=["title"];function eu(e,t,n,s,i,l){return E(),T("div",{style:be(l.style),title:n.title},null,12,Ja)}var tu=W(Xa,[["render",eu]]);const nu=j({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),ou={key:0,class:"autocomplete"},su=["onClick"],iu=["onClick"];function lu(e,t,n,s,i,l){return E(),T("div",null,[M(o("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=r=>e.input=r),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...r)=>e.onChange&&e.onChange(...r)),onKeydown:t[2]||(t[2]=lo((...r)=>e.add&&e.add(...r),["enter"])),onKeyup:t[3]||(t[3]=(...r)=>e.onKeyUp&&e.onKeyUp(...r))},null,544),[[we,e.input]]),e.autocomplete.values?(E(),T("div",ou,[o("ul",null,[(E(!0),T(ie,null,pe(e.autocomplete.values,(r,a)=>(E(),T("li",{key:a,class:Ve({active:a===e.autocomplete.idx}),onClick:y=>e.addVal(r)},I(r),11,su))),128))])])):J("",!0),(E(!0),T(ie,null,pe(e.values,(r,a)=>(E(),T("span",{key:a,class:"bit is-clickable",onClick:y=>e.rm(r)},I(r)+" \u2716",9,iu))),128))])}var ru=W(nu,[["render",lu],["__scopeId","data-v-d5073870"]]);const au=j({props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const n=t.files[0];if(!n)return;const s=new FormData;s.append("file",n,n.name);const l=await(await ae.post("/upload",{body:s})).json();this.$emit("uploaded",l)}}}),uu=["accept"],cu={class:"btn"};function du(e,t,n,s,i,l){return E(),T("label",null,[o("input",{type:"file",style:{display:"none"},onChange:t[0]||(t[0]=(...r)=>e.upload&&e.upload(...r)),accept:e.accept},null,40,uu),o("span",cu,I(e.label||"Upload File"),1)])}var pu=W(au,[["render",du]]);(async()=>{ae.init(),await Hn.init();const t=await(await ae.get("/api/conf",{})).json(),n=ro({history:ao(),routes:[{name:"index",path:"/",component:Qo},{name:"new-game",path:"/new-game",component:hi},{name:"game",path:"/g/:id",component:ba},{name:"replay",path:"/replay/:id",component:Ya}]});n.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const s=uo(_o);s.config.globalProperties.$config=t,s.use(n),s.component("connection-overlay",vn),s.component("edit-image-dialog",gn),s.component("game-teaser",dn),s.component("help-overlay",Nt),s.component("image-library",pn),s.component("image-teaser",ja),s.component("info-overlay",vt),s.component("new-game-dialog",mn),s.component("new-image-dialog",hn),s.component("overlay",Qa),s.component("preview-overlay",wt),s.component("puzzle-status",_t),s.component("responsive-image",tu),s.component("scores",yt),s.component("settings-overlay",Et),s.component("tags-input",ru),s.component("upload",pu),s.mount("#app")})();
//# sourceMappingURL=index.240f2539.js.map
