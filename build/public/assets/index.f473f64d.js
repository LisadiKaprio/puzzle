import{d as oe,r as V,o as d,c as w,a as o,b as ee,w as le,e as R,f,g as te,n as Me,t as Y,F as re,h as ge,i as Xe,j as Z,v as Re,k as Ue,l as Pe,m as Ys,p as Ws,q as Fs,s as Zs,u as Zo,x as Ho,y as $t,z as jo,A as No,B as Hs,C as Uo,D as js,E as Ks,G as Ro,H as st,I as qs,J as Xs,K as Qs,L as Js}from"./vendor.77210948.js";const en=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=s(i);fetch(i.href,l)}};en();var se=(e,t)=>{const s=e.__vccOpts||e;for(const[n,i]of t)s[n]=i;return s};const tn=oe({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),on={id:"app"},sn={key:0,class:"nav"},nn=f("Games overview"),ln=f("New game"),an=o("li",null,[o("a",{href:"https://stand-with-ukraine.pp.ua/",class:"btn btn-ukraine",target:"_blank"},[o("i",{class:"icon icon-ukraine-heart"}),f(" Stand with Ukraine "),o("i",{class:"icon icon-ukraine-heart"})])],-1);function rn(e,t,s,n,i,l){const r=V("router-link"),u=V("router-view");return d(),w("div",on,[e.showNav?(d(),w("ul",sn,[o("li",null,[ee(r,{class:"btn",to:{name:"index"}},{default:le(()=>[nn]),_:1})]),o("li",null,[ee(r,{class:"btn",to:{name:"new-game"}},{default:le(()=>[ln]),_:1})]),an])):R("",!0),ee(u)])}var un=se(tn,[["render",rn]]);class ht{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,s){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const n=(this.rand_high>>>0)/4294967295;return t+n*(s-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const s=t.slice();for(let n=0;n<=s.length-2;n++){const i=this.random(n,s.length-1),l=s[n];s[n]=s[i],s[i]=l}return s}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const s=new ht(0);return s.rand_high=t.rand_high,s.rand_low=t.rand_low,s}}const cn=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},at=(e,t)=>{const s=`${e}`;return s.length>=t.length?s:t.substr(0,t.length-s.length)+s},It=(...e)=>{const t=s=>(...n)=>{const i=new Date,l=at(i.getHours(),"00"),r=at(i.getMinutes(),"00"),u=at(i.getSeconds(),"00");console[s](`${l}:${r}:${u}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},dn=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function hn(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function pn(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function gn(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function fn(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function mn(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function _n(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function yn(e){return[e.id,e.rng.type||"",ht.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion,e.private]}function wn(e){return{id:e[0],rng:{type:e[1],obj:ht.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10],private:e[11]}}function vn(e,t){const s=e.width/e.tileSize;return{x:t%s,y:Math.floor(t/s)}}function En(e,t){const s=e.width/e.pieceSize;return{x:t%s,y:Math.floor(t/s)}}const Pn=e=>{let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t|=0}return t};function bn(e){const t=[];for(const s in e){const n=[s,e[s]].map(encodeURIComponent);t.push(n.join("="))}return t.length===0?"":`?${t.join("&")}`}var x={hash:Pn,slug:cn,pad:at,uniqId:dn,encodeShape:hn,decodeShape:pn,encodePiece:gn,decodePiece:fn,encodePlayer:mn,decodePlayer:_n,encodeGame:yn,decodeGame:wn,coordByPieceIdxDeprecated:vn,coordByPieceIdx:En,asQueryArgs:bn};const X={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",OTHER_PLAYER_CLICK_SOUND_ENABLED:"other_player_click_sound_enabled",COLOR_BACKGROUND:"bg_color",SHOW_TABLE:"show_table",TABLE_TEXTURE:"table_texture",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},pe={SOUND_VOLUME:100,SOUND_ENABLED:!0,OTHER_PLAYER_CLICK_SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",SHOW_TABLE:!0,TABLE_TEXTURE:"dark",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},Ko=()=>({background:"",showTable:!0,tableTexture:"dark",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0}),xt=(e,t)=>{localStorage.setItem(e,t)},Yt=e=>localStorage.getItem(e),Tn=(e,t)=>{xt(e,`${t}`)},$n=(e,t)=>{const s=Yt(e);if(s===null)return t;const n=parseInt(s,10);return isNaN(n)?t:n},Cn=(e,t)=>{xt(e,t?"1":"0")},Sn=(e,t)=>{const s=Yt(e);return s===null?t:s==="1"},kn=(e,t)=>{xt(e,t)},An=(e,t)=>{const s=Yt(e);return s===null?t:s};var K={setInt:Tn,getInt:$n,setBool:Cn,getBool:Sn,setStr:kn,getStr:An};let Ct="",qo="";const Et=async(e,t,s)=>new Promise((n,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const r in s.headers||{})l.setRequestHeader(r,s.headers[r]);l.setRequestHeader("Client-Id",Ct),l.setRequestHeader("Client-Secret",qo),l.addEventListener("load",function(r){n({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(r){i(new Error("xhr error"))}),l.upload&&s.onUploadProgress&&l.upload.addEventListener("progress",function(r){s.onUploadProgress&&s.onUploadProgress(r)}),l.send(s.body||null)}),Lo=e=>{let t=K.getStr(e,"");return t||(t=x.uniqId(),K.setStr(e,t)),t};var ye={init:()=>{Ct=Lo("ID"),qo=Lo("SECRET")},request:Et,get:(e,t)=>Et("get",e,t),post:(e,t)=>Et("post",e,t),clientId:()=>Ct};const Xo=1,Wt=Xo*1e3,ut=Wt*60,ct=ut*60,St=ct*24,On=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},Qo=e=>{const t=Math.floor(e/St);e=e%St;const s=Math.floor(e/ct);e=e%ct;const n=Math.floor(e/ut);e=e%ut;const i=Math.floor(e/Wt);return`${t}d ${s}h ${n}m ${i}s`},Nn=(e,t)=>Qo(t-e);var Te={MS:Xo,SEC:Wt,MIN:ut,HOUR:ct,DAY:St,timestamp:On,timeDiffStr:Nn,durationStr:Qo};const Un=oe({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const s=e,n=t||Te.timestamp();return`${Te.timeDiffStr(s,n)}`}}}),Rn={class:"game-info-text"},Ln=o("i",{class:"icon icon-puzzle-piece"},null,-1),Vn=o("br",null,null,-1),Mn=o("i",{class:"icon icon-sillouette"},null,-1),zn=o("br",null,null,-1),Dn={key:0,class:"icon icon-clock"},Bn={key:1,class:"icon icon-flag"},Gn=o("br",null,null,-1),In=o("i",{class:"icon icon-replay"},null,-1),xn=f(" Watch replay ");function Yn(e,t,s,n,i,l){const r=V("router-link");return d(),w("div",{class:"game-teaser",style:Me(e.style)},[ee(r,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:le(()=>[o("span",Rn,[Ln,f(" "+Y(e.game.piecesFinished)+"/"+Y(e.game.piecesTotal),1),Vn,Mn,f(" "+Y(e.game.players),1),zn,e.game.finished?(d(),w("i",Bn)):(d(),w("i",Dn)),f(" "+Y(e.time(e.game.started,e.game.finished)),1),Gn])]),_:1},8,["to"]),e.game.hasReplay?(d(),te(r,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:le(()=>[In,xn]),_:1},8,["to"])):R("",!0)],4)}var Jo=se(Un,[["render",Yn]]);const Wn=oe({components:{GameTeaser:Jo},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ye.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),Fn=o("h1",null,"Running games",-1),Zn=o("h1",null,"Finished games",-1);function Hn(e,t,s,n,i,l){const r=V("game-teaser");return d(),w("div",null,[Fn,(d(!0),w(re,null,ge(e.gamesRunning,(u,m)=>(d(),w("div",{class:"game-teaser-wrap",key:m},[ee(r,{game:u},null,8,["game"])]))),128)),Zn,(d(!0),w(re,null,ge(e.gamesFinished,(u,m)=>(d(),w("div",{class:"game-teaser-wrap",key:m},[ee(r,{game:u},null,8,["game"])]))),128))])}var jn=se(Wn,[["render",Hn]]);const Kn=oe({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function qn(e,t,s,n,i,l){const r=V("image-teaser"),u=V("masonry-wall");return d(),te(u,{items:e.images,"column-width":320,gap:10},{default:le(({item:m,index:h})=>[(d(),te(r,{image:m,onClick:k=>e.imageClicked(m),onEditClick:k=>e.imageEditClicked(m),key:h},null,8,["image","onClick","onEditClick"]))]),_:1},8,["items"])}var es=se(Kn,[["render",qn]]);const Xn=async e=>{const t=await Jn(e),s=await Qn(t);return ts(s.toDataURL())},Qn=async e=>{const t=document.createElement("canvas"),s=t.getContext("2d");return t.width=e.width,t.height=e.height,s.drawImage(e,0,0),t},Jn=async e=>new Promise((t,s)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>{t(n)},n.onerror=i=>{s(i)},n.src=e});function ts(e){for(var t=e.split(","),s=t[0].match(/:(.*?);/)[1],n=atob(t[1]),i=n.length,l=new Uint8Array(i);i--;)l[i]=n.charCodeAt(i);return new Blob([l],{type:s})}const ei=oe({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:["setupGameClick","postToGalleryClick","close"],data(){return{previewUrl:"",file:null,title:"",tags:[],isPrivate:!1,droppable:!1,inputFocused:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},mounted(){window.addEventListener("paste",this.onPaste)},unmounted(){window.removeEventListener("paste",this.onPaste)},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.isPrivate=!1,this.droppable=!1},imageFromDragEvt(e){var n;const t=(n=e.dataTransfer)==null?void 0:n.items;if(!t||t.length===0)return null;const s=t[0];return s.type.startsWith("image/")?s:null},async onPaste(e){const t=e.clipboardData.getData("text");if(t){if(this.inputFocused)return;if(t.match(/^https?:\/\//)){const n="/api/proxy?"+new URLSearchParams({url:t});try{const i=await Xn(n);this.preview(i)}catch(i){console.error("unable to transform image http url into blob",i)}}else if(t.match(/^data:image\/([a-z]+);base64,/))try{const n=ts(t);this.preview(n)}catch(n){console.error("unable to transform image data url into blob",n)}else console.log(t)}const s=e.clipboardData.files[0];!s||this.preview(s)},onFileSelect(e){const t=e.target;if(!t.files)return;const s=t.files[0];!s||this.preview(s)},preview(e){if(!e.type.startsWith("image/")){console.error("file type is not supported",e.type);return}const t=new FileReader;t.readAsDataURL(e),t.onload=s=>{this.previewUrl=s.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const s=t.getAsFile();return s&&(this.file=s,this.preview(s),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),ti=o("div",{class:"drop-target"},null,-1),oi={key:0,class:"has-image"},si={key:1},ni={class:"upload"},ii=o("div",{class:"upload-content"},[f(" How to upload an image? Choose any of the following methods: "),o("ul",null,[o("li",null,"Click this area to select an image for upload "),o("li",null,"Drag and drop an image into the area"),o("li",null,"Paste an image URL"),o("li",null,"Paste an image")]),o("div",{class:"hint"},` Don't worry, the image will not show up in the gallery unless "Post to gallery" was clicked. `)],-1),li={class:"area-settings"},ai=o("td",null,[o("label",null,"Title")],-1),ri=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),ui=o("td",null,[o("label",null,"Private Image")],-1),ci=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Private images won't show up in the gallery.")])],-1),di=o("td",null,[o("label",null,"Tags")],-1),hi={class:"area-buttons"},pi=["disabled"],gi=o("i",{class:"icon icon-preview"},null,-1),fi=f(" Post to gallery"),mi=["disabled"],_i=o("i",{class:"icon icon-puzzle-piece"},null,-1),yi=f(" Set up game"),wi=o("i",{class:"icon icon-puzzle-piece"},null,-1),vi=f(" Post to gallery "),Ei=o("br",null,null,-1),Pi=f(" + set up game");function bi(e,t,s,n,i,l){const r=V("responsive-image"),u=V("tags-input"),m=V("overlay");return d(),te(m,{class:"new-image-dialog"},{default:le(()=>[o("div",{class:Xe(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...h)=>e.onDrop&&e.onDrop(...h)),onDragover:t[3]||(t[3]=(...h)=>e.onDragover&&e.onDragover(...h)),onDragleave:t[4]||(t[4]=(...h)=>e.onDragleave&&e.onDragleave(...h))},[ti,e.previewUrl?(d(),w("div",oi,[o("span",{class:"remove btn",onClick:t[0]||(t[0]=h=>e.previewUrl="")},"X"),ee(r,{src:e.previewUrl},null,8,["src"])])):(d(),w("div",si,[o("label",ni,[o("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...h)=>e.onFileSelect&&e.onFileSelect(...h)),accept:"image/*"},null,32),ii])]))],34),o("div",li,[o("table",null,[o("tr",null,[ai,o("td",null,[Z(o("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=h=>e.title=h),placeholder:"Flower by @artist",onFocus:t[6]||(t[6]=h=>e.inputFocused=!0),onBlur:t[7]||(t[7]=h=>e.inputFocused=!1)},null,544),[[Re,e.title]])])]),ri,o("tr",null,[ui,o("td",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=h=>e.isPrivate=h)},null,512),[[Ue,e.isPrivate]])])]),ci,o("tr",null,[di,o("td",null,[ee(u,{modelValue:e.tags,"onUpdate:modelValue":t[9]||(t[9]=h=>e.tags=h),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",hi,[e.isPrivate?R("",!0):(d(),w("button",{key:0,class:"btn",disabled:!e.canPostToGallery,onClick:t[10]||(t[10]=(...h)=>e.postToGallery&&e.postToGallery(...h))},[e.uploading==="postToGallery"?(d(),w(re,{key:0},[f("Uploading ("+Y(e.uploadProgressPercent)+"%)",1)],64)):(d(),w(re,{key:1},[gi,fi],64))],8,pi)),o("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[11]||(t[11]=(...h)=>e.setupGameClick&&e.setupGameClick(...h))},[e.uploading==="setupGame"?(d(),w(re,{key:0},[f("Uploading ("+Y(e.uploadProgressPercent)+"%)",1)],64)):e.isPrivate?(d(),w(re,{key:1},[_i,yi],64)):(d(),w(re,{key:2},[wi,vi,Ei,Pi],64))],8,mi),o("button",{class:"btn",onClick:t[12]||(t[12]=h=>e.$emit("close"))},"Cancel")])]),_:1})}var os=se(ei,[["render",bi]]);const Ti=oe({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:["saveClick","close"],data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),$i={class:"area-image"},Ci={class:"has-image"},Si={class:"area-settings"},ki=o("td",null,[o("label",null,"Title")],-1),Ai=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Oi=o("td",null,[o("label",null,"Tags")],-1),Ni={class:"area-buttons"},Ui=o("i",{class:"icon icon-preview"},null,-1),Ri=f(" Save image"),Li=[Ui,Ri];function Vi(e,t,s,n,i,l){const r=V("responsive-image"),u=V("tags-input"),m=V("overlay");return d(),te(m,{class:"edit-image-dialog"},{default:le(()=>[o("div",$i,[o("div",Ci,[ee(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),o("div",Si,[o("table",null,[o("tr",null,[ki,o("td",null,[Z(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=h=>e.title=h),placeholder:"Flower by @artist"},null,512),[[Re,e.title]])])]),Ai,o("tr",null,[Oi,o("td",null,[ee(u,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=h=>e.tags=h),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",Ni,[o("button",{class:"btn",onClick:t[2]||(t[2]=(...h)=>e.saveImage&&e.saveImage(...h))},Li),o("button",{class:"btn",onClick:t[3]||(t[3]=h=>e.$emit("close"))},"Cancel")])]),_:1})}var ss=se(Ti,[["render",Vi]]),Le=(e=>(e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY",e))(Le||{}),Ke=(e=>(e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT",e))(Ke||{}),xe=(e=>(e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL",e))(xe||{});const Mi=oe({props:{image:{type:Object,required:!0},forcePrivate:{type:Boolean,default:!1}},emits:["newGame","close"],data(){return{tiles:1e3,isPrivate:!1,scoreMode:Le.ANY,shapeMode:Ke.NORMAL,snapMode:xe.NORMAL}},mounted(){this.isPrivate=this.forcePrivate},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,private:this.isPrivate,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),zi={class:"area-image"},Di={class:"has-image"},Bi={key:0,class:"image-title"},Gi={key:0,class:"image-title-title"},Ii={key:1,class:"image-title-dim"},xi={class:"area-settings"},Yi=o("td",null,[o("label",null,"Pieces")],-1),Wi=o("td",null,[o("label",null,"Scoring: ")],-1),Fi=f(" Any (Score when pieces are connected to each other or on final location)"),Zi=o("br",null,null,-1),Hi=f(" Final (Score when pieces are put to their final location)"),ji=o("td",null,[o("label",null,"Shapes: ")],-1),Ki=f(" Normal"),qi=o("br",null,null,-1),Xi=f(" Any (Flat pieces can occur anywhere)"),Qi=o("br",null,null,-1),Ji=f(" Flat (All pieces flat on all sides)"),el=o("td",null,[o("label",null,"Snapping: ")],-1),tl=f(" Normal (Pieces snap to final destination and to each other)"),ol=o("br",null,null,-1),sl=f(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),nl=o("td",null,[o("label",null,"Private Game")],-1),il=["disabled"],ll=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Private games won't show up in the game overview.")])],-1),al={key:0},rl=o("td",null,[o("label",null,"Tags: ")],-1),ul={class:"area-buttons"},cl=["disabled"],dl=o("i",{class:"icon icon-puzzle-piece"},null,-1),hl=f(" Generate Puzzle "),pl=[dl,hl];function gl(e,t,s,n,i,l){const r=V("responsive-image"),u=V("overlay");return d(),te(u,{class:"new-game-dialog"},{default:le(()=>[o("div",zi,[o("div",Di,[ee(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(d(),w("div",Bi,[e.image.title?(d(),w("span",Gi,'"'+Y(e.image.title)+'"',1)):R("",!0),e.image.width||e.image.height?(d(),w("span",Ii,"("+Y(e.image.width)+" \u2715 "+Y(e.image.height)+")",1)):R("",!0)])):R("",!0)]),o("div",xi,[o("table",null,[o("tr",null,[Yi,o("td",null,[Z(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=m=>e.tiles=m)},null,512),[[Re,e.tiles]])])]),o("tr",null,[Wi,o("td",null,[o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=m=>e.scoreMode=m),value:"1"},null,512),[[Pe,e.scoreMode]]),Fi]),Zi,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=m=>e.scoreMode=m),value:"0"},null,512),[[Pe,e.scoreMode]]),Hi])])]),o("tr",null,[ji,o("td",null,[o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=m=>e.shapeMode=m),value:"0"},null,512),[[Pe,e.shapeMode]]),Ki]),qi,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=m=>e.shapeMode=m),value:"1"},null,512),[[Pe,e.shapeMode]]),Xi]),Qi,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=m=>e.shapeMode=m),value:"2"},null,512),[[Pe,e.shapeMode]]),Ji])])]),o("tr",null,[el,o("td",null,[o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=m=>e.snapMode=m),value:"0"},null,512),[[Pe,e.snapMode]]),tl]),ol,o("label",null,[Z(o("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=m=>e.snapMode=m),value:"1"},null,512),[[Pe,e.snapMode]]),sl])])]),o("tr",null,[nl,o("td",null,[Z(o("input",{disabled:e.forcePrivate,type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=m=>e.isPrivate=m)},null,8,il),[[Ue,e.isPrivate]])])]),ll,e.image.tags.length?(d(),w("tr",al,[rl,o("td",null,[(d(!0),w(re,null,ge(e.image.tags,(m,h)=>(d(),w("span",{key:h,class:"bit"},Y(m.title),1))),128))])])):R("",!0)])]),o("div",ul,[o("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[9]||(t[9]=(...m)=>e.onNewGameClick&&e.onNewGameClick(...m))},pl,8,cl),o("button",{class:"btn",onClick:t[10]||(t[10]=m=>e.$emit("close"))},"Cancel")])]),_:1})}var ns=se(Mi,[["render",gl]]);const fl=oe({components:{ImageLibrary:es,NewImageDialog:os,EditImageDialog:ss,NewGameDialog:ns},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",newGameForcePrivate:!1,uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(s=>!t.includes(s.title)&&s.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(s=>s.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ye.get(`/api/newgame-data${x.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.newGameForcePrivate=!1,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags),t.append("private",e.isPrivate);const s=await ye.post("/api/upload",{body:t,onUploadProgress:n=>{this.uploadProgress=n.loaded/n.total}});return this.uploadProgress=1,await s.json()},async saveImage(e){return await(await ye.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.newGameForcePrivate=e.isPrivate,this.dialog="new-game"},async onNewGame(e){const t=await ye.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const s=await t.json();this.$router.push({name:"game",params:{id:s.id}})}}}}),ml={class:"upload-image-teaser"},_l=o("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),yl={key:0},wl=f(" Tags: "),vl=["onClick"],El=f(" Sort by: "),Pl=Ws('<option value="date_desc">Newest first</option><option value="date_asc">Oldest first</option><option value="alpha_asc">A-Z</option><option value="alpha_desc">Z-A</option><option value="game_count_asc">Most plays first</option><option value="game_count_desc">Least plays first</option>',6),bl=[Pl];function Tl(e,t,s,n,i,l){const r=V("image-library"),u=V("new-image-dialog"),m=V("edit-image-dialog"),h=V("new-game-dialog");return d(),w("div",null,[o("div",ml,[o("div",{class:"btn btn-big",onClick:t[0]||(t[0]=k=>e.dialog="new-image")},"Upload your image"),_l]),o("div",null,[e.tags.length>0?(d(),w("label",yl,[wl,(d(!0),w(re,null,ge(e.relevantTags,(k,M)=>(d(),w("span",{class:Xe(["bit is-clickable",{on:e.filters.tags.includes(k.slug)}]),key:M,onClick:E=>e.toggleTag(k)},Y(k.title)+" ("+Y(k.total)+")",11,vl))),128))])):R("",!0),o("label",null,[El,Z(o("select",{"onUpdate:modelValue":t[1]||(t[1]=k=>e.filters.sort=k),onChange:t[2]||(t[2]=(...k)=>e.filtersChanged&&e.filtersChanged(...k))},bl,544),[[Ys,e.filters.sort]])])]),ee(r,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),e.dialog==="new-image"?(d(),te(u,{key:0,autocompleteTags:e.autocompleteTags,onClose:t[3]||(t[3]=k=>e.dialog=""),onBgclick:t[4]||(t[4]=k=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"])):R("",!0),e.dialog==="edit-image"?(d(),te(m,{key:1,autocompleteTags:e.autocompleteTags,onClose:t[5]||(t[5]=k=>e.dialog=""),onBgclick:t[6]||(t[6]=k=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"])):R("",!0),e.image&&e.dialog==="new-game"?(d(),te(h,{key:2,onClose:t[7]||(t[7]=k=>e.dialog=""),onBgclick:t[8]||(t[8]=k=>e.dialog=""),onNewGame:e.onNewGame,image:e.image,forcePrivate:e.newGameForcePrivate},null,8,["onNewGame","image","forcePrivate"])):R("",!0)])}var $l=se(fl,[["render",Tl]]);const Cl=oe({props:{players:{type:Object,required:!0}},methods:{playerStyle(e){return e.color==="ukraine"?{backgroundImage:"linear-gradient(180deg, rgba(0,87,183,1) 0%, rgba(0,87,183,1) 50%, rgba(255,221,0,1) 50%)","-webkit-background-clip":"text","-webkit-text-fill-color":"transparent"}:{color:e.color}}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),Sl={class:"scores"},kl=o("div",null,"Scores",-1),Al=o("td",null,[o("i",{class:"icon icon-lightning"})],-1),Ol=o("td",null,[o("i",{class:"icon icon-zzz"})],-1);function Nl(e,t,s,n,i,l){return d(),w("div",Sl,[kl,o("table",null,[(d(!0),w(re,null,ge(e.actives,(r,u)=>(d(),w("tr",{key:u,style:Me(e.playerStyle(r))},[Al,o("td",null,Y(r.name),1),o("td",null,Y(r.points),1)],4))),128)),(d(!0),w(re,null,ge(e.idles,(r,u)=>(d(),w("tr",{key:u,style:Me(e.playerStyle(r))},[Ol,o("td",null,Y(r.name),1),o("td",null,Y(r.points),1)],4))),128))])])}var Ft=se(Cl,[["render",Nl]]);const Ul=oe({props:{status:{type:Object,required:!0}},computed:{durationStr(){return Te.durationStr(this.status.duration)}}}),Rl={class:"puzzle-status"},Ll=o("i",{class:"icon icon-puzzle-piece"},null,-1),Vl={key:0,class:"icon icon-clock"},Ml={key:1,class:"icon icon-flag"};function zl(e,t,s,n,i,l){return d(),w("div",Rl,[o("div",null,[Ll,f(" "+Y(e.status.piecesDone)+"/"+Y(e.status.piecesTotal),1)]),o("div",null,[this.status.finished?(d(),w("i",Ml)):(d(),w("i",Vl)),f(" "+Y(e.durationStr),1)])])}var Zt=se(Ul,[["render",zl]]);const Dl=oe({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({showTable:!1,tableTexture:"dark",background:"",color:"",isUkraineColor:!1,name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.showTable=!!e.showTable,this.tableTexture=e.tableTexture,this.background=`${e.background}`,this.color=`${e.color}`,this.isUkraineColor=this.color==="ukraine",this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.otherPlayerClickSoundEnabled=!!e.otherPlayerClickSoundEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{showTable:this.showTable,tableTexture:this.tableTexture,background:this.background,color:this.isUkraineColor?"ukraine":this.color,name:this.name,soundsEnabled:this.soundsEnabled,otherPlayerClickSoundEnabled:this.otherPlayerClickSoundEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch(()=>this.isUkraineColor,this.emitChanges)),this.watches.push(this.$watch(()=>this.background,this.emitChanges)),this.watches.push(this.$watch(()=>this.showTable,this.emitChanges)),this.watches.push(this.$watch(()=>this.tableTexture,this.emitChanges)),this.watches.push(this.$watch(()=>this.color,this.emitChanges)),this.watches.push(this.$watch(()=>this.name,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.otherPlayerClickSoundEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsVolume,this.emitChanges)),this.watches.push(this.$watch(()=>this.showPlayerNames,this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue)}}),we=e=>(Fs("data-v-6b022e04"),e=e(),Zs(),e),Bl={class:"settings"},Gl=we(()=>o("td",null,[o("label",null,"Background: ")],-1)),Il=we(()=>o("td",null,[o("label",null,"Table: ")],-1)),xl=f("Show"),Yl={key:0},Wl=f(" Dark"),Fl={key:1},Zl=f(" Brown"),Hl={key:2},jl=f(" Light"),Kl=we(()=>o("td",null,[o("label",null,"Color: ")],-1)),ql=we(()=>o("i",{class:"icon icon-ukraine-heart"},null,-1)),Xl=we(()=>o("td",null,[o("label",null,"Name: ")],-1)),Ql=we(()=>o("td",null,[o("label",null,"Sounds: ")],-1)),Jl=we(()=>o("td",null,[o("label",null,"Piece connect sounds of others: ")],-1)),ea=["disabled"],ta=we(()=>o("td",null,[o("label",null,"Sounds Volume: ")],-1)),oa={class:"sound-volume"},sa=we(()=>o("i",{class:"icon icon-volume-down"},null,-1)),na=[sa],ia=["disabled","value"],la=we(()=>o("i",{class:"icon icon-volume-up"},null,-1)),aa=[la],ra=we(()=>o("td",null,[o("label",null,"Show player names: ")],-1));function ua(e,t,s,n,i,l){const r=V("overlay");return d(),te(r,{class:"transparent"},{default:le(()=>[o("table",Bl,[o("tr",null,[Gl,o("td",null,[Z(o("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=u=>e.background=u)},null,512),[[Re,e.background]])])]),o("tr",null,[Il,o("td",null,[o("label",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[1]||(t[1]=u=>e.showTable=u)},null,512),[[Ue,e.showTable]]),xl]),e.showTable?(d(),w("label",Yl,[Z(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=u=>e.tableTexture=u),value:"dark"},null,512),[[Pe,e.tableTexture]]),Wl])):R("",!0),e.showTable?(d(),w("label",Fl,[Z(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=u=>e.tableTexture=u),value:"brown"},null,512),[[Pe,e.tableTexture]]),Zl])):R("",!0),e.showTable?(d(),w("label",Hl,[Z(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=u=>e.tableTexture=u),value:"light"},null,512),[[Pe,e.tableTexture]]),jl])):R("",!0)])]),o("tr",null,[Kl,o("td",null,[e.isUkraineColor?R("",!0):Z((d(),w("input",{key:0,type:"color","onUpdate:modelValue":t[5]||(t[5]=u=>e.color=u)},null,512)),[[Re,e.color]]),o("label",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=u=>e.isUkraineColor=u)},null,512),[[Ue,e.isUkraineColor]]),ql])])]),o("tr",null,[Xl,o("td",null,[Z(o("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[7]||(t[7]=u=>e.name=u)},null,512),[[Re,e.name]])])]),o("tr",null,[Ql,o("td",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=u=>e.soundsEnabled=u)},null,512),[[Ue,e.soundsEnabled]])])]),o("tr",null,[Jl,o("td",null,[Z(o("input",{type:"checkbox",disabled:!e.soundsEnabled,"onUpdate:modelValue":t[9]||(t[9]=u=>e.otherPlayerClickSoundEnabled=u)},null,8,ea),[[Ue,e.otherPlayerClickSoundEnabled]])])]),o("tr",null,[ta,o("td",oa,[o("span",{onClick:t[10]||(t[10]=(...u)=>e.decreaseVolume&&e.decreaseVolume(...u))},na),o("input",{disabled:!e.soundsEnabled,type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[11]||(t[11]=(...u)=>e.updateVolume&&e.updateVolume(...u))},null,40,ia),o("span",{onClick:t[12]||(t[12]=(...u)=>e.increaseVolume&&e.increaseVolume(...u))},aa)])]),o("tr",null,[ra,o("td",null,[Z(o("input",{type:"checkbox","onUpdate:modelValue":t[13]||(t[13]=u=>e.showPlayerNames=u)},null,512),[[Ue,e.showPlayerNames]])])])])]),_:1})}var Ht=se(Dl,[["render",ua],["__scopeId","data-v-6b022e04"]]);const ca=oe({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),da={class:"preview"};function ha(e,t,s,n,i,l){const r=V("overlay");return d(),te(r,{class:"preview-overlay",animate:!1},{default:le(()=>[o("div",da,[o("div",{class:"img",style:Me(e.previewStyle)},null,4)])]),_:1})}var jt=se(ca,[["render",ha]]);const pa=oe({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case Le.ANY:return["Any","Score when pieces are connected to each other or on final location"];case Le.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ke.FLAT:return["Flat","All pieces flat on all sides"];case Ke.ANY:return["Any","Flat pieces can occur anywhere"];case Ke.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case xe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case xe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),ga={class:"help"},fa=o("tr",null,[o("td",{colspan:"2"},"Info about this puzzle")],-1),ma=o("td",null,"Image Title: ",-1),_a=o("td",null,"Scoring: ",-1),ya=["title"],wa=o("td",null,"Shapes: ",-1),va=["title"],Ea=o("td",null,"Snapping: ",-1),Pa=["title"];function ba(e,t,s,n,i,l){const r=V("overlay");return d(),te(r,{class:"transparent"},{default:le(()=>[o("table",ga,[fa,o("tr",null,[ma,o("td",null,Y(e.game.puzzle.info.image.title),1)]),o("tr",null,[_a,o("td",null,[o("span",{title:e.snapMode[1]},Y(e.scoreMode[0]),9,ya)])]),o("tr",null,[wa,o("td",null,[o("span",{title:e.snapMode[1]},Y(e.shapeMode[0]),9,va)])]),o("tr",null,[Ea,o("td",null,[o("span",{title:e.snapMode[1]},Y(e.snapMode[0]),9,Pa)])])])]),_:1})}var Kt=se(pa,[["render",ba]]);const Ta=4,$a=1,Ca=4,Sa=2,ka=3,Aa=1,Oa=2,Na=4,Ua=3,Ra=1,La=2,Va=3,Ma=4,za=5,Da=6,Ba=7,Ga=8,Ia=9,xa=10,Ya=11,Wa=12,Fa=13,Za=14,Ha=15,ja=16,Ka=17,qa=18,Xa=19,Qa=20,Ja=21,er=22,tr=23,or=1,sr=2,nr=3,ir=4;var g={EV_SERVER_EVENT:$a,EV_SERVER_INIT:Ca,EV_CLIENT_EVENT:Sa,EV_CLIENT_INIT:ka,GAME_VERSION:Ta,LOG_HEADER:Aa,LOG_ADD_PLAYER:Oa,LOG_UPDATE_PLAYER:Na,LOG_HANDLE_INPUT:Ua,INPUT_EV_MOVE:Ia,INPUT_EV_MOUSE_DOWN:Ra,INPUT_EV_MOUSE_UP:La,INPUT_EV_MOUSE_MOVE:Va,INPUT_EV_ZOOM_IN:Ma,INPUT_EV_ZOOM_OUT:za,INPUT_EV_BG_COLOR:Da,INPUT_EV_PLAYER_COLOR:Ba,INPUT_EV_PLAYER_NAME:Ga,INPUT_EV_TOGGLE_INTERFACE:tr,INPUT_EV_TOGGLE_PREVIEW:xa,INPUT_EV_TOGGLE_SOUNDS:Ya,INPUT_EV_REPLAY_TOGGLE_PAUSE:Wa,INPUT_EV_REPLAY_SPEED_UP:Fa,INPUT_EV_REPLAY_SPEED_DOWN:Za,INPUT_EV_TOGGLE_PLAYER_NAMES:Ha,INPUT_EV_CENTER_FIT_PUZZLE:ja,INPUT_EV_TOGGLE_FIXED_PIECES:Ka,INPUT_EV_TOGGLE_LOOSE_PIECES:qa,INPUT_EV_TOGGLE_TABLE:er,INPUT_EV_STORE_POS:Xa,INPUT_EV_RESTORE_POS:Qa,INPUT_EV_CONNECTION_CLOSE:Ja,CHANGE_DATA:or,CHANGE_PIECE:sr,CHANGE_PLAYER:nr,PLAYER_SNAP:ir};const lr=It("Communication.js"),ar=1001,qt=4e3,is=0,kt=1,Xt=2,ls=3,as=4;let _e,At=[],Ot=e=>{At.push(e)},Nt=[],Ut=e=>{Nt.push(e)};function rr(e){Ot=e;for(const t of At)Ot(t);At=[]}function ur(e){Ut=e;for(const t of Nt)Ut(t);Nt=[]}let Rt=is;const Ze=e=>{Rt!==e&&(Rt=e,Ut(e))};function rs(e){if(Rt===Xt)try{_e.send(JSON.stringify(e))}catch{lr.info("unable to send message.. maybe because ws is invalid?")}}let Ge,Ie,Lt=0;function us(e=2e4){_e.readyState==_e.OPEN&&_e.send(""),Lt=setTimeout(us,e)}function Vo(){Lt&&clearTimeout(Lt)}function cr(e,t,s){return Ge=0,Ie={},Ze(ls),new Promise(n=>{_e=new WebSocket(e,s+"|"+t),_e.onopen=()=>{Ze(Xt),rs([g.EV_CLIENT_INIT]),us()},_e.onmessage=i=>{const l=JSON.parse(i.data),r=l[0];if(r===g.EV_SERVER_INIT){const u=l[1];n(u)}else if(r===g.EV_SERVER_EVENT){const u=l[1],m=l[2];if(u===s&&Ie[m]){delete Ie[m];return}Ot(l)}else throw`[ 2021-05-09 invalid connect msgType ${r} ]`},_e.onerror=()=>{throw Vo(),Ze(kt),"[ 2021-05-15 onerror ]"},_e.onclose=i=>{Vo(),i.code===qt||i.code===ar?Ze(as):Ze(kt)}})}async function dr(e,t){const s={gameId:e,offset:t};return await(await ye.get(`/api/replay-data${x.asQueryArgs(s)}`,{})).json()}function hr(){_e&&_e.close(qt),Ge=0,Ie={}}function pr(e){Ge++,Ie[Ge]=e,rs([g.EV_CLIENT_EVENT,Ge,Ie[Ge]])}var Se={connect:cr,requestReplayData:dr,disconnect:hr,sendClientEvent:pr,onServerChange:rr,onConnectionStateChange:ur,CODE_CUSTOM_DISCONNECT:qt,CONN_STATE_NOT_CONNECTED:is,CONN_STATE_DISCONNECTED:kt,CONN_STATE_CLOSED:as,CONN_STATE_CONNECTED:Xt,CONN_STATE_CONNECTING:ls};const gr=oe({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Se.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Se.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),fr={key:0},mr=o("i",{class:"icon icon-disconnect"},null,-1),_r=f(" LOST CONNECTION "),yr=o("i",{class:"icon icon-disconnect"},null,-1),wr=[mr,_r,yr],vr={key:2};function Er(e,t,s,n,i,l){const r=V("overlay");return Z((d(),te(r,{class:"connection-lost"},{default:le(()=>[e.lostConnection?(d(),w("div",fr,wr)):R("",!0),e.lostConnection?(d(),w("span",{key:1,class:"btn",onClick:t[0]||(t[0]=u=>e.$emit("reconnect"))},"Reconnect")):R("",!0),e.connecting?(d(),w("div",vr,"Connecting...")):R("",!0)]),_:1},512)),[[Zo,e.show]])}var cs=se(gr,[["render",Er]]);const Pr=oe({}),br=o("table",{class:"help"},[o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-up"}),f(" Move up:")]),o("td",null,[o("div",null,[o("kbd",null,"W"),f("/"),o("kbd",null,"\u2191"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-down"}),f(" Move down:")]),o("td",null,[o("div",null,[o("kbd",null,"S"),f("/"),o("kbd",null,"\u2193"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-left"}),f(" Move left:")]),o("td",null,[o("div",null,[o("kbd",null,"A"),f("/"),o("kbd",null,"\u2190"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-arrow-right"}),f(" Move right:")]),o("td",null,[o("div",null,[o("kbd",null,"D"),f("/"),o("kbd",null,"\u2192"),f("/"),o("i",{class:"icon icon-mouse-left"})])])]),o("tr",null,[o("td"),o("td",null,[o("div",null,[f("Move faster by holding "),o("kbd",null,"Shift")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-zoom-in"}),f(" Zoom in:")]),o("td",null,[o("div",null,[o("kbd",null,"E"),f("/"),o("i",{class:"icon icon-mouse-wheel"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-zoom-out"}),f(" Zoom out:")]),o("td",null,[o("div",null,[o("kbd",null,"Q"),f("/"),o("i",{class:"icon icon-mouse-wheel"})])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-preview"}),f(" Toggle preview:")]),o("td",null,[o("div",null,[o("kbd",null,"Space")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-center"}),f(" Center puzzle in screen:")]),o("td",null,[o("div",null,[o("kbd",null,"C")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-puzzle-piece-locked"}),f(" Toggle fixed pieces:")]),o("td",null,[o("div",null,[o("kbd",null,"F")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-puzzle-piece-free"}),f(" Toggle loose pieces:")]),o("td",null,[o("div",null,[o("kbd",null,"G")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-table"}),f(" Toggle table:")]),o("td",null,[o("div",null,[o("kbd",null,"T")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-eye"}),f(" Toggle interface:")]),o("td",null,[o("div",null,[o("kbd",null,"H")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-player-name"}),f(" Toggle player names:")]),o("td",null,[o("div",null,[o("kbd",null,"N")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-volume-up"}),f(" Toggle sounds:")]),o("td",null,[o("div",null,[o("kbd",null,"M")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-save-pos"}),f(" Store position [0-9]:")]),o("td",null,[o("div",null,[o("kbd",null,"Shift"),f(" + "),o("kbd",null,"0"),f("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-load-pos"}),f(" Restore position [0-9]:")]),o("td",null,[o("div",null,[o("kbd",null,"0"),f("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-speed-up"}),f(" Speed up (replay):")]),o("td",null,[o("div",null,[o("kbd",null,"I")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-speed-down"}),f(" Speed down (replay):")]),o("td",null,[o("div",null,[o("kbd",null,"O")])])]),o("tr",null,[o("td",null,[o("i",{class:"icon icon-pause"}),f(" Pause (replay):")]),o("td",null,[o("div",null,[o("kbd",null,"P")])])])],-1);function Tr(e,t,s,n,i,l){const r=V("overlay");return d(),te(r,{class:"transparent"},{default:le(()=>[br]),_:1})}var Qt=se(Pr,[["render",Tr]]),$r="/assets/click.bb97cb07.mp3",Cr=Object.freeze(Object.defineProperty({__proto__:null,default:$r},Symbol.toStringTag,{value:"Module"})),Sr="/assets/click2.98536db5.mp3",kr=Object.freeze(Object.defineProperty({__proto__:null,default:Sr},Symbol.toStringTag,{value:"Module"})),Ar="/assets/Oak-none-3275x2565mm-Architextures.cc917130.jpg",Or=Object.freeze(Object.defineProperty({__proto__:null,default:Ar},Symbol.toStringTag,{value:"Module"})),Nr="/assets/wood-dark.1e21ffc1.jpg",Ur=Object.freeze(Object.defineProperty({__proto__:null,default:Nr},Symbol.toStringTag,{value:"Module"})),Rr="/assets/wood-light.ae1bd383.jpg",Lr=Object.freeze(Object.defineProperty({__proto__:null,default:Rr},Symbol.toStringTag,{value:"Module"})),Vr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",Mr=Object.freeze(Object.defineProperty({__proto__:null,default:Vr},Symbol.toStringTag,{value:"Module"})),zr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",Dr=Object.freeze(Object.defineProperty({__proto__:null,default:zr},Symbol.toStringTag,{value:"Module"})),Br="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Gr=Object.freeze(Object.defineProperty({__proto__:null,default:Br},Symbol.toStringTag,{value:"Module"})),Ir="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",xr=Object.freeze(Object.defineProperty({__proto__:null,default:Ir},Symbol.toStringTag,{value:"Module"}));const Yr=e=>{let t=!1;const s=()=>{t=!0},n=e.fps||60,i=e.slow||1,l=e.update,r=e.render,u=window.requestAnimationFrame,m=1/n,h=i*m;let k,M=0,E=window.performance.now();const y=()=>{for(k=window.performance.now(),M=M+Math.min(1,(k-E)/1e3);M>h;)M=M-h,l(m);r(M/i),E=k,t||u(y)};return u(y),{stop:s}};let Mo=.1;const Wr=6,Fr=.05;class Vt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}calculateZoomCapping(t,s,n,i){Mo=Math.max(.1,t/n,s/i)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,s){this.x+=t/this.curZoom,this.y+=s/this.curZoom}calculateNewZoom(t){const s=t==="in"?1:-1,n=this.curZoom+Fr*this.curZoom*s;return Math.min(Math.max(n,Mo),Wr)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,s){if(this.curZoom==t)return!1;const n=1-this.curZoom/t;return this.move(-s.x*n,-s.y*n),this.curZoom=t,!0}zoom(t,s){return this.setZoom(this.calculateNewZoom(t),s)}viewportToWorld(t){const{x:s,y:n}=this.viewportToWorldRaw(t);return{x:Math.round(s),y:Math.round(n)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:s,y:n}=this.worldToViewportRaw(t);return{x:Math.round(s),y:Math.round(n)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:s,h:n}=this.worldDimToViewportRaw(t);return{w:Math.round(s),h:Math.round(n)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:s,h:n}=this.viewportDimToWorldRaw(t);return{w:Math.round(s),h:Math.round(n)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function qe(e=0,t=0){const s=document.createElement("canvas");return s.width=e,s.height=t,s}async function Zr(e){return new Promise(t=>{const s=new Image;s.onload=()=>{createImageBitmap(s).then(t)},s.src=e})}async function Hr(e,t,s){const n=qe(t,s);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,s),await createImageBitmap(n)}function jr(e,t,s){if(s==="ukraine"){const l=qe(e.width,e.height),r=l.getContext("2d"),u=t.height/1.75;r.save(),r.drawImage(t,0,0),r.fillStyle="#0057B7",r.globalCompositeOperation="source-in",r.fillRect(0,0,t.width,u),r.restore(),r.save(),r.globalCompositeOperation="destination-over",r.drawImage(e,0,0),r.restore();const m=qe(e.width,e.height/2),h=m.getContext("2d");return h.save(),h.drawImage(t,0,-u),h.fillStyle="#FFDD00",h.globalCompositeOperation="source-in",h.fillRect(0,0,t.width,t.height),h.restore(),h.save(),h.globalCompositeOperation="destination-over",h.drawImage(e,0,-u),h.restore(),r.drawImage(m,0,u),l}const n=qe(e.width,e.height),i=n.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=s,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),n}var de={createCanvas:qe,loadImageToBitmap:Zr,resizeBitmap:Hr,colorizedCanvas:jr};const Kr=It("Debug.js");let Mt=0,ds=0;const qr=e=>{Mt=performance.now(),ds=e},Xr=e=>{const t=performance.now(),s=t-Mt;s>ds&&Kr.log(e+": "+s),Mt=t};var Ae={checkpoint_start:qr,checkpoint:Xr};function Qr(e,t){return{x:e.x-t.x,y:e.y-t.y}}function Jr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function hs(e,t){const s=e.x-t.x,n=e.y-t.y;return Math.sqrt(s*s+n*n)}function eu(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function zt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function tu(e,t,s){return{x:e.x+t,y:e.y+s,w:e.w,h:e.h}}function ou(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function su(e,t){return hs(zt(e),zt(t))}var Q={pointSub:Qr,pointAdd:Jr,pointDistance:hs,pointInBounds:eu,rectCenter:zt,rectMoved:tu,rectCenterDistance:su,rectsOverlap:ou};const zo=It("PuzzleGraphics.js");async function nu(e,t,s){zo.log("start createPuzzleTileBitmaps");const n=s.tileSize,i=s.tileMarginWidth,l=s.tileDrawSize,r=n/100,u=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],m=new Array(t.length),h={};function k(_){const B=`${_.top}${_.right}${_.left}${_.bottom}`;if(h[B])return h[B];const O=new Path2D,$={x:i,y:i},T=Q.pointAdd($,{x:n,y:0}),b=Q.pointAdd(T,{x:0,y:n}),U=Q.pointSub(b,{x:n,y:0});if(O.moveTo($.x,$.y),_.top!==0)for(let p=0;p<u.length/6;p++){const ne=Q.pointAdd($,{x:u[p*6+0]*r,y:_.top*u[p*6+1]*r}),H=Q.pointAdd($,{x:u[p*6+2]*r,y:_.top*u[p*6+3]*r}),ie=Q.pointAdd($,{x:u[p*6+4]*r,y:_.top*u[p*6+5]*r});O.bezierCurveTo(ne.x,ne.y,H.x,H.y,ie.x,ie.y)}else O.lineTo(T.x,T.y);if(_.right!==0)for(let p=0;p<u.length/6;p++){const ne=Q.pointAdd(T,{x:-_.right*u[p*6+1]*r,y:u[p*6+0]*r}),H=Q.pointAdd(T,{x:-_.right*u[p*6+3]*r,y:u[p*6+2]*r}),ie=Q.pointAdd(T,{x:-_.right*u[p*6+5]*r,y:u[p*6+4]*r});O.bezierCurveTo(ne.x,ne.y,H.x,H.y,ie.x,ie.y)}else O.lineTo(b.x,b.y);if(_.bottom!==0)for(let p=0;p<u.length/6;p++){const ne=Q.pointSub(b,{x:u[p*6+0]*r,y:_.bottom*u[p*6+1]*r}),H=Q.pointSub(b,{x:u[p*6+2]*r,y:_.bottom*u[p*6+3]*r}),ie=Q.pointSub(b,{x:u[p*6+4]*r,y:_.bottom*u[p*6+5]*r});O.bezierCurveTo(ne.x,ne.y,H.x,H.y,ie.x,ie.y)}else O.lineTo(U.x,U.y);if(_.left!==0)for(let p=0;p<u.length/6;p++){const ne=Q.pointSub(U,{x:-_.left*u[p*6+1]*r,y:u[p*6+0]*r}),H=Q.pointSub(U,{x:-_.left*u[p*6+3]*r,y:u[p*6+2]*r}),ie=Q.pointSub(U,{x:-_.left*u[p*6+5]*r,y:u[p*6+4]*r});O.bezierCurveTo(ne.x,ne.y,H.x,H.y,ie.x,ie.y)}else O.lineTo($.x,$.y);return h[B]=O,O}const M=de.createCanvas(l,l),E=M.getContext("2d"),y=de.createCanvas(l,l),A=y.getContext("2d");for(const _ of t){const B=x.decodePiece(_),O=iu(s,B.idx),$=k(x.decodeShape(s.shapes[B.idx]));E.clearRect(0,0,l,l),E.save(),E.lineWidth=2,E.stroke($),E.globalCompositeOperation="source-in",E.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),E.restore(),E.save(),E.globalCompositeOperation="source-in",E.globalAlpha=.2,E.fillStyle="black",E.fillRect(0,0,M.width,M.height),E.restore(),E.save(),E.clip($),E.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),E.restore(),E.save(),E.clip($),E.strokeStyle="rgba(0,0,0,.4)",E.lineWidth=0,E.shadowColor="black",E.shadowBlur=2,E.shadowOffsetX=-1,E.shadowOffsetY=-1,E.stroke($),E.restore(),E.save(),E.clip($),E.strokeStyle="rgba(255,255,255,.4)",E.lineWidth=0,E.shadowColor="white",E.shadowBlur=2,E.shadowOffsetX=1,E.shadowOffsetY=1,E.stroke($),E.restore(),A.clearRect(0,0,l,l),A.save(),A.lineWidth=1,A.stroke($),A.globalCompositeOperation="source-in",A.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),A.restore(),E.drawImage(y,0,0),m[B.idx]=await createImageBitmap(M)}return zo.log("end createPuzzleTileBitmaps"),m}function iu(e,t){const s=x.coordByPieceIdxDeprecated(e,t);return{x:s.x*e.tileSize,y:s.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function lu(e){const t=await de.loadImageToBitmap(e.info.imageUrl),s=await de.resizeBitmap(t,e.info.width,e.info.height);return await nu(s,e.tiles,e.info)}var au={loadPuzzleBitmaps:lu};const ps=30,C={};function ru(e){return!!C[e]||!1}function uu(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function cu(e,t){C[e]=t}function du(e){delete C[e]}function pt(e,t){let s=0;for(const n of C[e].players){if(x.decodePlayer(n).id===t)return s;s++}return-1}function hu(e,t){return C[e].players.length>t?x.decodePlayer(C[e].players[t]).id:null}function ze(e,t){const s=pt(e,t);return s===-1?null:x.decodePlayer(C[e].players[s])}function Jt(e,t,s){const n=pt(e,t);n===-1?C[e].players.push(x.encodePlayer(s)):C[e].players[n]=x.encodePlayer(s)}function pu(e,t,s){C[e].puzzle.tiles[t]=x.encodePiece(s)}function gu(e,t){C[e].puzzle.data=t}function gs(e,t){return pt(e,t)!==-1}function fu(e,t){return bs(C[e],t)}function mu(e,t){return Hu(C[e],t)}function _u(e,t,s){gs(e,t)?ae(e,t,{ts:s}):Jt(e,t,uu(t,s))}function yu(e){return C[e]||null}function Dt(e){return io(C[e])}function wu(e){return Ts(C[e])}function Pt(e){return C[e].scoreMode}function fs(e){return C[e].snapMode}function ms(e){return C[e].gameVersion}function Bt(e){return no(C[e])}function vu(e){return C[e].puzzle.tiles.map(x.decodePiece).sort((s,n)=>s.z-n.z)}function ae(e,t,s){const n=ze(e,t);if(n!==null){for(const i of Object.keys(s))n[i]=s[i];Jt(e,t,n)}}function nt(e,t){for(const s of Object.keys(t))C[e].puzzle.data[s]=t[s]}function Ve(e,t,s){for(const n of Object.keys(s)){const i=x.decodePiece(C[e].puzzle.tiles[t]);i[n]=s[n],C[e].puzzle.tiles[t]=x.encodePiece(i)}}const De=(e,t)=>x.decodePiece(C[e].puzzle.tiles[t]),dt=(e,t)=>De(e,t).group,Eu=(e,t)=>{const s=C[e].puzzle.info;return t===0||t===s.tilesX-1||t===s.tiles-s.tilesX||t===s.tiles-1},_s=(e,t)=>{const s=C[e].puzzle.info,n={x:(s.table.width-s.width)/2,y:(s.table.height-s.height)/2},i=Au(e,t);return Q.pointAdd(n,i)},rt=(e,t)=>De(e,t).pos,eo=e=>ms(e)<=3?bu(e):Pu(e),Pu=e=>({x:0,y:0,w:oo(e),h:so(e)}),bu=e=>{const t=oo(e),s=so(e),n=Math.round(t/4),i=Math.round(s/4);return{x:0-n,y:0-i,w:t+2*n,h:s+2*i}},Tu=(e,t)=>De(e,t).z,He=(e,t)=>{for(const s of C[e].puzzle.tiles){const n=x.decodePiece(s);if(n.owner===t)return n.idx}return-1},$u=(e,t)=>{const s=He(e,t);return s<0?null:C[e].puzzle.tiles[s]},ys=e=>C[e].puzzle.info.tileDrawOffset,to=e=>C[e].puzzle.info.tileDrawSize,Cu=e=>vs(C[e]),Su=e=>Es(C[e]),Do=e=>C[e].puzzle.data.maxGroup,Bo=e=>C[e].puzzle.data.maxZ,ku=(e,t)=>{let s=0;for(const n of t){const i=Tu(e,n);i>s&&(s=i)}return s};function Au(e,t){const s=C[e].puzzle.info,n=x.coordByPieceIdxDeprecated(s,t),i=n.x*s.tileSize,l=n.y*s.tileSize;return{x:i,y:l}}function Ou(e,t){const s=C[e].puzzle.info,n=x.coordByPieceIdxDeprecated(s,t);return[n.y>0?t-s.tilesX:-1,n.x<s.tilesX-1?t+1:-1,n.y<s.tilesY-1?t+s.tilesX:-1,n.x>0?t-1:-1]}const Go=(e,t,s)=>{for(const n of t)Ve(e,n,{z:s})},ws=(e,t,s)=>{const n=rt(e,t),i=Q.pointAdd(n,s);Ve(e,t,{pos:i})},it=(e,t,s)=>ms(e)>=3?Uu(e,t,s):Nu(e,t,s),Nu=(e,t,s)=>{const n=to(e),i=eo(e),l=s;for(const r of t){const u=De(e,r);u.pos.x+s.x<i.x?l.x=Math.max(i.x-u.pos.x,l.x):u.pos.x+n+s.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-u.pos.x+n,l.x)),u.pos.y+s.y<i.y?l.y=Math.max(i.y-u.pos.y,l.y):u.pos.y+n+s.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-u.pos.y+n,l.y))}if(!l.x&&!l.y)return!1;for(const r of t)ws(e,r,l);return!0},Uu=(e,t,s)=>{const n=eo(e),i=to(e)+2*ys(e),l=n.x,r=n.y,u=l+n.w-i,m=r+n.h-i,h=s;for(const k of t){const M=De(e,k);s.x<0?h.x=Math.max(l-M.pos.x,h.x):h.x=Math.min(u-M.pos.x,h.x),s.y<0?h.y=Math.max(r-M.pos.y,h.y):h.y=Math.min(m-M.pos.y,h.y)}if(!h.x&&!h.y)return!1;for(const k of t)ws(e,k,h);return!0},Ru=(e,t)=>Lu(e,t)===-1,Lu=(e,t)=>De(e,t).owner,Io=(e,t)=>{for(const s of t)Ve(e,s,{owner:-1,z:1})},bt=(e,t,s)=>{for(const n of t)Ve(e,n,{owner:s})};function Vu(e,t){return be(e,t).length}function be(e,t){const s=C[e].puzzle.tiles,n=x.decodePiece(s[t]),i=[];if(n.group)for(const l of s){const r=x.decodePiece(l);r.group===n.group&&i.push(r.idx)}else i.push(n.idx);return i}const Mu=(e,t)=>{const s=C[e].puzzle.info,n=C[e].puzzle.tiles;let i=-1,l=-1;for(let r=0;r<n.length;r++){const u=x.decodePiece(n[r]);if(u.owner!==0)continue;const m={x:u.pos.x,y:u.pos.y,w:s.tileSize,h:s.tileSize};Q.pointInBounds(t,m)&&(i===-1||u.z>i)&&(i=u.z,l=r)}return l},zu=(e,t)=>{const s=ze(e,t);return s?s.bgcolor:null},Du=(e,t)=>{const s=ze(e,t);return s?s.color:null},Bu=(e,t)=>{const s=ze(e,t);return s?s.name:null},xo=(e,t)=>{const s=ze(e,t);return s?s.points:0},Gu=(e,t,s)=>{const n=dt(e,t),i=dt(e,s);return!!(n&&n===i)},oo=e=>C[e].puzzle.info.table.width,so=e=>C[e].puzzle.info.table.height,Iu=e=>C[e].puzzle,xu=e=>C[e].rng.obj,Yu=e=>C[e].puzzle.info.width,Wu=e=>C[e].puzzle.info.height,Fu=(e,t)=>{if(fs(e)===xe.REAL){for(const s of t)if(Eu(e,s))return!0;return!1}return!0};function Zu(e,t,s,n){const i=C[e].puzzle,l=[],r=()=>{l.push([g.CHANGE_DATA,i.data])},u=y=>{l.push([g.CHANGE_PIECE,x.encodePiece(De(e,y))])},m=y=>{for(const A of y)u(A)},h=()=>{const y=ze(e,t);!y||l.push([g.CHANGE_PLAYER,x.encodePlayer(y)])};let k=!1;const M=(y,A,_)=>{const B=C[y].puzzle.tiles,O=dt(y,A),$=dt(y,_);let T;const b=[];if(O&&b.push(O),$&&b.push($),O)T=O;else if($)T=$;else{const U=Do(y)+1;nt(y,{maxGroup:U}),r(),T=Do(y)}if(Ve(y,A,{group:T}),u(A),Ve(y,_,{group:T}),u(_),b.length>0)for(const U of B){const p=x.decodePiece(U);b.includes(p.group)&&(Ve(y,p.idx,{group:T}),u(p.idx))}},E=s[0];if(E===g.INPUT_EV_CONNECTION_CLOSE){const y=He(e,t);if(y>=0){const A=be(e,y);bt(e,A,0),m(A)}}else if(E===g.INPUT_EV_BG_COLOR){const y=s[1];ae(e,t,{bgcolor:y,ts:n}),h()}else if(E===g.INPUT_EV_PLAYER_COLOR){const y=s[1];ae(e,t,{color:y,ts:n}),h()}else if(E===g.INPUT_EV_PLAYER_NAME){const y=`${s[1]}`.substr(0,16);ae(e,t,{name:y,ts:n}),h()}else if(E===g.INPUT_EV_MOVE){const y=s[1],A=s[2],_=ze(e,t);if(_){const B=_.x-y,O=_.y-A;ae(e,t,{ts:n,x:B,y:O}),h();const $=He(e,t);if($>=0){const T=be(e,$),b={x:-y,y:-A};it(e,T,b)&&m(T)}}}else if(E===g.INPUT_EV_MOUSE_DOWN){const y=s[1],A=s[2],_={x:y,y:A};ae(e,t,{d:1,ts:n}),h();const B=Mu(e,_);if(B>=0){const O=Bo(e)+1;nt(e,{maxZ:O}),r();const $=be(e,B);Go(e,$,Bo(e)),bt(e,$,t),m($)}}else if(E===g.INPUT_EV_MOUSE_MOVE){const y=s[1],A=s[2];if(!s[5])ae(e,t,{x:y,y:A,ts:n}),h();else{const B=He(e,t);if(B<0)ae(e,t,{ts:n}),h();else{const O=s[1],$=s[2],T=s[3],b=s[4];ae(e,t,{x:O,y:$,ts:n}),h();const U=be(e,B);it(e,U,{x:T,y:b})&&m(U)}}}else if(E===g.INPUT_EV_MOUSE_UP){const A=He(e,t);if(A>=0){const _=be(e,A);bt(e,_,0),m(_);const B=rt(e,A),O=_s(e,A);if(Fu(e,_)&&Q.pointDistance(O,B)<i.info.snapDistance){const $=Q.pointSub(O,B);it(e,_,$),Io(e,_),m(_);let T=xo(e,t);Pt(e)===Le.FINAL?T+=_.length:Pt(e)===Le.ANY&&(T+=1),ae(e,t,{d:0,ts:n,points:T}),h(),Bt(e)===Dt(e)&&(nt(e,{finished:n}),r()),k=!0}else{const $=(b,U,p,ne)=>{const H=C[b].puzzle.info;if(p<0||Gu(b,U,p))return!1;const ie=rt(b,U),$e=Q.pointAdd(rt(b,p),{x:ne[0]*H.tileSize,y:ne[1]*H.tileSize});if(Q.pointDistance(ie,$e)<H.snapDistance){const ke=Q.pointSub($e,ie);let fe=be(b,U);if(it(b,fe,ke),M(b,U,p),fe=be(b,U),Ru(b,p))Io(b,fe);else{const Be=ku(b,fe);Go(b,fe,Be)}return m(fe),!0}return!1};let T=!1;for(const b of be(e,A)){const U=Ou(e,b);if($(e,b,U[0],[0,1])||$(e,b,U[1],[-1,0])||$(e,b,U[2],[0,-1])||$(e,b,U[3],[1,0])){T=!0;break}}if(T&&Pt(e)===Le.ANY){const b=xo(e,t)+1;ae(e,t,{d:0,ts:n,points:b}),h()}else ae(e,t,{d:0,ts:n}),h();T&&fs(e)===xe.REAL&&Bt(e)===Dt(e)&&(nt(e,{finished:n}),r()),T&&(k=!0)}}else ae(e,t,{d:0,ts:n}),h()}else if(E===g.INPUT_EV_ZOOM_IN){const y=s[1],A=s[2];ae(e,t,{x:y,y:A,ts:n}),h()}else if(E===g.INPUT_EV_ZOOM_OUT){const y=s[1],A=s[2];ae(e,t,{x:y,y:A,ts:n}),h()}else ae(e,t,{ts:n}),h();return k&&l.push([g.PLAYER_SNAP,t]),l}function vs(e){return e.puzzle.data.started}function Es(e){return e.puzzle.data.finished}function no(e){let t=0;for(const s of e.puzzle.tiles)x.decodePiece(s).owner===-1&&t++;return t}function io(e){return e.puzzle.tiles.length}function Ps(e){return e.players.map(x.decodePlayer)}function bs(e,t){const s=t-ps*Te.SEC;return Ps(e).filter(n=>n.ts>=s)}function Hu(e,t){const s=t-ps*Te.SEC;return Ps(e).filter(n=>n.ts<s&&n.points>0)}function Ts(e){var s;const t=((s=e.puzzle.info.image)==null?void 0:s.url)||e.puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function ju(e){return no(e)===io(e)}var z={setGame:cu,unsetGame:du,loaded:ru,playerExists:gs,getActivePlayers:fu,getIdlePlayers:mu,addPlayer:_u,getFinishedPiecesCount:Bt,getPieceCount:Dt,getImageUrl:wu,get:yu,getGroupedPieceCount:Vu,getPlayerBgColor:zu,getPlayerColor:Du,getPlayerName:Bu,getPlayerIndexById:pt,getPlayerIdByIndex:hu,changePlayer:ae,setPlayer:Jt,setPiece:pu,setPuzzleData:gu,getBounds:eo,getTableWidth:oo,getTableHeight:so,getPuzzle:Iu,getRng:xu,getPuzzleWidth:Yu,getPuzzleHeight:Wu,getPiecesSortedByZIndex:vu,getFirstOwnedPiece:$u,getPieceDrawOffset:ys,getPieceDrawSize:to,getFinalPiecePos:_s,getStartTs:Cu,getFinishTs:Su,handleInput:Zu,Game_getStartTs:vs,Game_getFinishTs:Es,Game_getFinishedPiecesCount:no,Game_getPieceCount:io,Game_getActivePlayers:bs,Game_getImageUrl:Ts,Game_isFinished:ju};let $s=-10,Cs=20,Gt=2,Ss=15;const Ku=5,qu=5,lo=1,Xu=200,Yo=10,Qu=100,Ju=10,ec=1,tc=5;function oc(e){const t=e.random(0,255),s=e.random(0,255),n=e.random(0,255);return"rgba("+t+","+s+","+n+", 0.8)"}class Wo{constructor(t){this.radius=Yo,this.previousRadius=Yo,this.explodingDuration=Qu,this.hasExploded=!1,this.alive=!0,this.color=oc(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=$s+Math.random()*Cs,this.vy=(Gt+Math.random()*Ss)*-1,this.duration=0}update(t){if(this.hasExploded){const s=Xu-this.radius;this.previousRadius=this.radius,this.radius+=s/Ju,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=lo,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const s=3+Math.floor(Math.random()*3);for(let n=0;n<s;n++){const i=10+Math.floor(Math.random()*21),l=Ku+Math.random()*qu,r=2*Math.PI/i,u=Math.random()*r;for(let m=0;m<i;m++)t.push(new sc(this,m*r+u,l))}}}class sc{constructor(t,s,n){this.px=t.px,this.py=t.py,this.vx=Math.cos(s)*n,this.vy=Math.sin(s)*n,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=lo/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class nc{constructor(t,s){this.canvas=t,this.rng=s,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,s=0;for(;t<this.canvas.height&&s>=0;)s+=lo,t+=s;Gt=s/2,Ss=s-Gt;const n=1/4*this.canvas.width/(s/2);$s=-n,Cs=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<ec;t++)this.readyBombs.push(new Wo(this.rng))}update(){Math.random()*100<tc&&this.readyBombs.push(new Wo(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const s=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):s.push(i)}this.readyBombs=s;const n=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&n.push(i)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function ic(e,t,s,n){let i=[],l=!0,r=!1,u=!1,m=!1,h=!1,k=!1,M=!1,E=!1;const y=(P,G)=>{const N=s.viewportToWorld({x:P,y:G});return[N.x,N.y]},A=(P,G)=>{const N=s.viewportDimToWorld({w:P,h:G});return[N.w,N.h]},_=P=>y(P.offsetX,P.offsetY),B=()=>y(e.width/2,e.height/2),O=(P,G)=>{!l||(G.code==="ShiftLeft"||G.code==="ShiftRight"?E=P:G.code==="ArrowUp"||G.code==="KeyW"?m=P:G.code==="ArrowDown"||G.code==="KeyS"?h=P:G.code==="ArrowLeft"||G.code==="KeyA"?r=P:G.code==="ArrowRight"||G.code==="KeyD"?u=P:G.code==="KeyQ"?M=P:G.code==="KeyE"&&(k=P))};let $=!1,T=null,b=null;const U=P=>{b=_(P),T=[P.offsetX,P.offsetY],P.button===0&&($=!0,q([g.INPUT_EV_MOUSE_DOWN,...b]))},p=P=>{b=_(P),T=[P.offsetX,P.offsetY],P.button===0&&($=!1,q([g.INPUT_EV_MOUSE_UP,...b]))},ne=P=>{if(!T)return;b=_(P);const G=A(-(T[0]-P.offsetX),-(T[1]-P.offsetY));q([g.INPUT_EV_MOUSE_MOVE,...b,...G,$?1:0]),T=[P.offsetX,P.offsetY]},H=P=>{if(b=_(P),s.canZoom(P.deltaY<0?"in":"out")){const G=P.deltaY<0?g.INPUT_EV_ZOOM_IN:g.INPUT_EV_ZOOM_OUT;q([G,...b])}},ie=P=>O(!0,P),$e=P=>O(!1,P),ke=P=>{if(!!l){if(n===Ee&&(P.code==="KeyI"?q([g.INPUT_EV_REPLAY_SPEED_UP]):P.code==="KeyO"?q([g.INPUT_EV_REPLAY_SPEED_DOWN]):P.code==="KeyP"&&q([g.INPUT_EV_REPLAY_TOGGLE_PAUSE])),P.code==="KeyH")q([g.INPUT_EV_TOGGLE_INTERFACE]);else if(P.code==="Space")q([g.INPUT_EV_TOGGLE_PREVIEW]);else if(P.code==="KeyF")q([g.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(P.code==="KeyG")q([g.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(P.code==="KeyM")q([g.INPUT_EV_TOGGLE_SOUNDS]);else if(P.code==="KeyN")q([g.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(P.code==="KeyT")q([g.INPUT_EV_TOGGLE_TABLE]);else if(P.code==="KeyC")q([g.INPUT_EV_CENTER_FIT_PUZZLE]);else for(let G=0;G<=9;G++)if(P.code===`Digit${G}`){const N=P.shiftKey?g.INPUT_EV_STORE_POS:g.INPUT_EV_RESTORE_POS;q([N,G]);break}}},fe=()=>{e.addEventListener("mousedown",U),e.addEventListener("mouseup",p),e.addEventListener("mousemove",ne),e.addEventListener("wheel",H),t.addEventListener("keydown",ie),t.addEventListener("keyup",$e),t.addEventListener("keypress",ke)},Be=()=>{e.removeEventListener("mousedown",U),e.removeEventListener("mouseup",p),e.removeEventListener("mousemove",ne),e.removeEventListener("wheel",H),t.removeEventListener("keydown",ie),t.removeEventListener("keyup",$e),t.removeEventListener("keypress",ke)},Ye=(P,G)=>{if(!T||!b)return;const N=new Vt(P).viewportToWorld({x:T[0],y:T[1]}),ve=new Vt(G).viewportToWorld({x:T[0],y:T[1]}),ue=[-(N.x-ve.x),-(N.y-ve.y)];q([g.INPUT_EV_MOUSE_MOVE,...b,...ue,$?1:0])},q=P=>{i.push(P)};return{registerEvents:fe,unregisterEvents:Be,addEvent:q,consumeAll:()=>{if(i.length===0)return[];const P=i.slice();return i=[],P},createKeyEvents:()=>{const P=(r?1:0)-(u?1:0),G=(m?1:0)-(h?1:0);if(P!==0||G!==0){const N=(E?24:12)*Math.sqrt(s.getCurrentZoom()),ve=s.viewportDimToWorld({w:P*N,h:G*N});q([g.INPUT_EV_MOVE,ve.w,ve.h]),b&&(b[0]-=ve.w,b[1]-=ve.h)}if(!(k&&M)){if(k){if(s.canZoom("in")){const N=b||B();q([g.INPUT_EV_ZOOM_IN,...N])}}else if(M&&s.canZoom("out")){const N=b||B();q([g.INPUT_EV_ZOOM_OUT,...N])}}},createSnapshotEvents:Ye,setHotkeys:P=>{l=P}}}const lt={"./grab.png":Mr,"./grab_mask.png":Dr,"./hand.png":Gr,"./hand_mask.png":xr},Tt={"./assets/textures/Oak-none-3275x2565mm-Architextures.jpg":Or,"./assets/textures/wood-dark.jpg":Ur,"./assets/textures/wood-light.jpg":Lr},Fo={"./click.mp3":Cr,"./click2.mp3":kr},je="play",Ee="replay";let Oe=!0,Ne=!0;const lc=e=>e.owner===-1?Oe:Ne;let J=!0;async function ks(e,t,s,n,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const r=a=>n===Ee||a.id!==t,u=Fo["./click.mp3"].default,m=Fo["./click2.mp3"].default,h=new Audio(u),k=new Audio(m),M=await de.loadImageToBitmap(lt["./grab.png"].default),E=await de.loadImageToBitmap(lt["./hand.png"].default),y=await de.loadImageToBitmap(lt["./grab_mask.png"].default),A=await de.loadImageToBitmap(lt["./hand_mask.png"].default),_=M.width,B=Math.round(_/2),O=M.height,$=Math.round(O/2),T={},b=async a=>{const c=a.color+" "+a.d;if(!T[c]){const v=a.d?M:E;if(a.color){const I=a.d?y:A;T[c]=await createImageBitmap(de.colorizedCanvas(v,I,a.color))}else T[c]=v}return T[c]},U=i,p={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Se.onConnectionStateChange(a=>{l.emit("connectionState",a)});const ne=async a=>{const c=p.dataOffset;p.dataOffset+=1e4;const v=await Se.requestReplayData(a,c);return p.log=p.log.slice(p.logPointer),p.logPointer=0,p.log.push(...v.log),v.log.length===0&&(p.final=!0),v};let H=()=>0;const ie=async()=>{if(n===je){const a=await Se.connect(s,e,t),c=x.decodeGame(a);z.setGame(c.id,c),H=()=>Te.timestamp()}else if(n===Ee){const a=await ne(e);if(!a.game)throw"[ 2021-05-29 no game received ]";const c=x.decodeGame(a.game);z.setGame(c.id,c),p.lastRealTs=Te.timestamp(),p.gameStartTs=parseInt(a.log[0][4],10),p.lastGameTs=p.gameStartTs,H=()=>p.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";J=!0};await ie();const $e=z.getPieceDrawOffset(e),ke=z.getPieceDrawSize(e),fe=z.getPuzzleWidth(e),Be=z.getPuzzleHeight(e),Ye=z.getTableWidth(e),q=z.getTableHeight(e),ao={x:(Ye-fe)/2,y:(q-Be)/2},gt={w:fe,h:Be},ro={w:ke,h:ke},P=await au.loadPuzzleBitmaps(z.getPuzzle(e)),G=new nc(U,z.getRng(e));G.init();const N=U.getContext("2d");U.classList.add("loaded"),l.emit("puzzleCut");let ve="";const ue={},L=new Vt;L.calculateZoomCapping(window.innerWidth,window.innerHeight,Ye,q);const Ns=()=>{L.reset(),L.move(-(Ye-U.width)/2,-(q-U.height)/2);const a=L.worldDimToViewportRaw(gt),c=20,v=U.width-c*2,I=U.height-c*2;if(a.w>v||a.h>I||a.w<v&&a.h<I){const W=Math.min(v/a.w,I/a.h),F={x:U.width/2,y:U.height/2};L.setZoom(W,F)}},ce=ic(U,window,L,n);ce.registerEvents();const Qe=a=>{if(ue.last&&ve===a){const c=L.snapshot(),v=ue.last;return L.fromSnapshot(v),ce.createSnapshotEvents(c,v),delete ue.last,"last"}else if(ue[a]){const c=ue[a],v=L.snapshot();return ue.last=v,ve=a,L.fromSnapshot(c),ce.createSnapshotEvents(v,c),a}else return null};Ns(),ue.center=L.snapshot();const Us=z.getImageUrl(e),Je=a=>{const c=z.getStartTs(e),v=z.getFinishTs(e);l.emit("status",{finished:!!v,duration:(v||a)-c,piecesDone:z.getFinishedPiecesCount(e),piecesTotal:z.getPieceCount(e)}),l.emit("players",{active:z.getActivePlayers(e,a),idle:z.getIdlePlayers(e,a)})};Je(H());const uo=!!z.getFinishTs(e);let ft=uo;const co=()=>ft&&!uo,mt=()=>K.getInt(X.SOUND_VOLUME,pe.SOUND_VOLUME),ho=()=>K.getBool(X.OTHER_PLAYER_CLICK_SOUND_ENABLED,pe.OTHER_PLAYER_CLICK_SOUND_ENABLED),_t=()=>K.getBool(X.SOUND_ENABLED,pe.SOUND_ENABLED),po=()=>K.getBool(X.SHOW_PLAYER_NAMES,pe.SHOW_PLAYER_NAMES),Rs=()=>K.getBool(X.SHOW_TABLE,pe.SHOW_TABLE),Ls=()=>K.getStr(X.TABLE_TEXTURE,pe.TABLE_TEXTURE),go=()=>n===Ee?K.getStr(X.COLOR_BACKGROUND,pe.COLOR_BACKGROUND):z.getPlayerBgColor(e,t)||K.getStr(X.COLOR_BACKGROUND,pe.COLOR_BACKGROUND),fo=()=>n===Ee?K.getStr(X.PLAYER_COLOR,pe.PLAYER_COLOR):z.getPlayerColor(e,t)||K.getStr(X.PLAYER_COLOR,pe.PLAYER_COLOR),Vs=()=>n===Ee?K.getStr(X.PLAYER_NAME,pe.PLAYER_NAME):z.getPlayerName(e,t)||K.getStr(X.PLAYER_NAME,pe.PLAYER_NAME),mo=()=>{const a=mt();h.volume=a/100,h.play()},Ms=()=>{const a=mt();k.volume=a/100,k.play()},D={background:go(),showTable:Rs(),tableTexture:Ls(),color:fo(),name:Vs(),soundsEnabled:_t(),otherPlayerClickSoundEnabled:ho(),soundsVolume:mt(),showPlayerNames:po()};ce.addEvent([g.INPUT_EV_BG_COLOR,D.background]),ce.addEvent([g.INPUT_EV_PLAYER_COLOR,D.color]),ce.addEvent([g.INPUT_EV_PLAYER_NAME,D.name]);let _o="",yo="",wo=!1;const We=a=>{wo=a;const[c,v]=a?[_o,"grab"]:[yo,"default"];U.style.cursor=`url('${c}') ${B} ${$}, ${v}`},yt=a=>{_o=de.colorizedCanvas(M,y,a).toDataURL(),yo=de.colorizedCanvas(E,A,a).toDataURL(),We(wo)};yt(fo());const et=()=>{l.emit("replaySpeed",p.speeds[p.speedIdx]),l.emit("replayPaused",p.paused)},j=(a,c=void 0)=>{l.emit("statusMessage",{what:a,value:c})},vo=()=>{p.speedIdx+1<p.speeds.length&&(p.speedIdx++,et(),j("Speed Up"))},Eo=()=>{p.speedIdx>=1&&(p.speedIdx--,et(),j("Speed Down"))},Po=()=>{p.paused=!p.paused,et(),j(p.paused?"Paused":"Playing")};let tt=!0;const bo=()=>{tt=!tt,l.emit("toggleInterface",tt),j("Interface",tt)};let Fe=!1;const To=()=>{Fe=!Fe,l.emit("togglePreview",Fe)},$o=()=>{D.soundsEnabled=!D.soundsEnabled;const a=D.soundsEnabled;l.emit("toggleSoundsEnabled",a),K.setBool(X.SOUND_ENABLED,a),j("Sounds",a)},Co=()=>{D.showPlayerNames=!D.showPlayerNames;const a=D.showPlayerNames;l.emit("togglePlayerNames",a),K.setBool(X.SHOW_PLAYER_NAMES,a),j("Player names",a)},So=()=>{D.showTable=!D.showTable;const a=D.showTable;l.emit("toggleShowTable",a),K.setBool(X.SHOW_TABLE,a),j("Table",a)};l.on("replayOnSpeedUp",()=>{vo()}),l.on("replayOnSpeedDown",()=>{Eo()}),l.on("replayOnPauseToggle",()=>{Po()}),l.on("onPreviewChange",a=>{Fe!==a&&(Fe=a)}),l.on("onBgChange",a=>{D.background!==a&&(D.background=a,K.setStr(X.COLOR_BACKGROUND,a),ce.addEvent([g.INPUT_EV_BG_COLOR,a]),j("Background",a))}),l.on("onTableTextureChange",a=>{D.tableTexture!==a&&(D.tableTexture=a,K.setStr(X.TABLE_TEXTURE,a),j("Table texture",a),J=!0)}),l.on("onShowTableChange",a=>{D.showTable!==a&&(D.showTable=a,K.setStr(X.SHOW_TABLE,a),j("Table",a),J=!0)}),l.on("onColorChange",a=>{D.color!==a&&(D.color=a,K.setStr(X.PLAYER_COLOR,a),ce.addEvent([g.INPUT_EV_PLAYER_COLOR,a]),j("Color",a))}),l.on("onNameChange",a=>{D.name!==a&&(D.name=a,K.setStr(X.PLAYER_NAME,a),ce.addEvent([g.INPUT_EV_PLAYER_NAME,a]),j("Name",a))}),l.on("onOtherPlayerClickSoundEnabledChange",a=>{D.otherPlayerClickSoundEnabled!==a&&(D.otherPlayerClickSoundEnabled=a,K.setBool(X.OTHER_PLAYER_CLICK_SOUND_ENABLED,a),j("Other player sounds",a))}),l.on("onSoundsEnabledChange",a=>{D.soundsEnabled!==a&&(D.soundsEnabled=a,K.setBool(X.SOUND_ENABLED,a),j("Sounds",a))}),l.on("onSoundsVolumeChange",a=>{D.soundsVolume!==a&&(D.soundsVolume=a,K.setInt(X.SOUND_VOLUME,a),mo(),j("Volume",a))}),l.on("onShowPlayerNamesChange",a=>{D.showPlayerNames!==a&&(D.showPlayerNames=a,K.setBool(X.SHOW_PLAYER_NAMES,a),j("Player names",a))}),l.on("setHotkeys",a=>{ce.setHotkeys(a)}),l.on("requireRerender",()=>{J=!0});const ko=[];let ot;const zs=()=>{ko.forEach(a=>{clearInterval(a)}),ot&&clearTimeout(ot)};if(n===je?ko.push(setInterval(()=>{Je(H())},1e3)):n===Ee&&et(),n===je)Se.onServerChange(a=>{a[0],a[1],a[2];const c=a[3];let v=!1,I=!1;for(const[W,F]of c)switch(W){case g.CHANGE_PLAYER:{const S=x.decodePlayer(F);S.id!==t&&(z.setPlayer(e,S.id,S),v=!0)}break;case g.CHANGE_PIECE:{const S=x.decodePiece(F);z.setPiece(e,S.idx,S),v=!0}break;case g.CHANGE_DATA:z.setPuzzleData(e,F),v=!0;break;case g.PLAYER_SNAP:F!==t&&(I=!0);break}I&&_t()&&ho()&&Ms(),v&&(J=!0),ft=!!z.getFinishTs(e)});else if(n===Ee){const a=(I,W)=>{const F=I;if(F[0]===g.LOG_ADD_PLAYER){const S=F[1];return z.addPlayer(e,S,W),!0}if(F[0]===g.LOG_UPDATE_PLAYER){const S=z.getPlayerIdByIndex(e,F[1]);if(!S)throw"[ 2021-05-17 player not found (update player) ]";return z.addPlayer(e,S,W),!0}if(F[0]===g.LOG_HANDLE_INPUT){const S=z.getPlayerIdByIndex(e,F[1]);if(!S)throw"[ 2021-05-17 player not found (handle input) ]";const me=F[2];return z.handleInput(e,S,me,W),!0}return!1};let c=p.lastGameTs;const v=async()=>{p.logPointer+1>=p.log.length&&await ne(e);const I=Te.timestamp();if(p.paused){p.lastRealTs=I,ot=setTimeout(v,50);return}const F=(I-p.lastRealTs)*p.speeds[p.speedIdx];let S=p.lastGameTs+F,me=!0;do if(p.paused)me=!1;else{const Ce=p.logPointer+1;if(Ce>=p.log.length)me=!1;else{const he=p.log[p.logPointer],Ao=c+he[he.length-1],wt=p.log[Ce],Oo=wt[wt.length-1],vt=Ao+Oo;vt>S?(S+500*Te.MS<vt&&(S+=Oo),me=!1):(c=Ao,a(wt,vt)&&(J=!0),p.logPointer=Ce)}}while(me);p.lastRealTs=I,p.lastGameTs=S,Je(H()),p.final||(ot=setTimeout(v,50))};v()}const Ds=()=>{ce.createKeyEvents();for(const a of ce.consumeAll())if(n===je){const c=a[0];if(c===g.INPUT_EV_MOVE){const W=L.worldDimToViewportRaw({w:a[1],h:a[2]});J=!0,L.move(W.w,W.h),delete ue.last}else if(c===g.INPUT_EV_MOUSE_MOVE){if(a[5]&&!z.getFirstOwnedPiece(e,t)){const F=L.worldDimToViewportRaw({w:a[3],h:a[4]});J=!0,L.move(F.w,F.h),delete ue.last}}else if(c===g.INPUT_EV_PLAYER_COLOR)yt(a[1]);else if(c===g.INPUT_EV_MOUSE_DOWN)We(!0);else if(c===g.INPUT_EV_MOUSE_UP)We(!1);else if(c===g.INPUT_EV_ZOOM_IN){const W={x:a[1],y:a[2]};J=!0,L.zoom("in",L.worldToViewportRaw(W)),delete ue.last}else if(c===g.INPUT_EV_ZOOM_OUT){const W={x:a[1],y:a[2]};J=!0,L.zoom("out",L.worldToViewportRaw(W)),delete ue.last}else if(c===g.INPUT_EV_TOGGLE_INTERFACE)bo();else if(c===g.INPUT_EV_TOGGLE_PREVIEW)To();else if(c===g.INPUT_EV_TOGGLE_SOUNDS)$o();else if(c===g.INPUT_EV_TOGGLE_PLAYER_NAMES)Co();else if(c===g.INPUT_EV_CENTER_FIT_PUZZLE){const W="center",F=Qe(W);j(F?`Restored position "${F}"`:`Position "${W}" not set`)}else if(c===g.INPUT_EV_TOGGLE_FIXED_PIECES)Oe=!Oe,j(`${Oe?"Showing":"Hiding"} finished pieces`),J=!0;else if(c===g.INPUT_EV_TOGGLE_LOOSE_PIECES)Ne=!Ne,j(`${Ne?"Showing":"Hiding"} unfinished pieces`),J=!0;else if(c===g.INPUT_EV_TOGGLE_TABLE)So();else if(c===g.INPUT_EV_STORE_POS){const W=`${a[1]}`;ue[W]=L.snapshot(),j(`Stored position ${W}`)}else if(c===g.INPUT_EV_RESTORE_POS){const W=`${a[1]}`,F=Qe(W);j(F?`Restored position "${F}"`:`Position "${W}" not set`)}const v=H(),I=z.handleInput(e,t,a,v);_t()&&I.find(W=>W[0]===g.PLAYER_SNAP)&&mo(),I.length>0&&(J=!0),Se.sendClientEvent(a)}else if(n===Ee){const c=a[0];if(c===g.INPUT_EV_REPLAY_TOGGLE_PAUSE)Po();else if(c===g.INPUT_EV_REPLAY_SPEED_DOWN)Eo();else if(c===g.INPUT_EV_REPLAY_SPEED_UP)vo();else if(c===g.INPUT_EV_MOVE){const v=L.worldDimToViewportRaw({w:a[1],h:a[2]});J=!0,L.move(v.w,v.h)}else if(c===g.INPUT_EV_MOUSE_MOVE){if(a[5]){const I=L.worldDimToViewportRaw({w:a[3],h:a[4]});J=!0,L.move(I.w,I.h)}}else if(c===g.INPUT_EV_PLAYER_COLOR)yt(a[1]);else if(c===g.INPUT_EV_MOUSE_DOWN)We(!0);else if(c===g.INPUT_EV_MOUSE_UP)We(!1);else if(c===g.INPUT_EV_ZOOM_IN){const v={x:a[1],y:a[2]};J=!0,L.zoom("in",L.worldToViewportRaw(v))}else if(c===g.INPUT_EV_ZOOM_OUT){const v={x:a[1],y:a[2]};J=!0,L.zoom("out",L.worldToViewportRaw(v))}else if(c===g.INPUT_EV_TOGGLE_INTERFACE)bo();else if(c===g.INPUT_EV_TOGGLE_PREVIEW)To();else if(c===g.INPUT_EV_TOGGLE_SOUNDS)$o();else if(c===g.INPUT_EV_TOGGLE_PLAYER_NAMES)Co();else if(c===g.INPUT_EV_CENTER_FIT_PUZZLE){const v="center",I=Qe(v);j(I?`Restored position "${I}"`:`Position "${v}" not set`)}else if(c===g.INPUT_EV_TOGGLE_FIXED_PIECES)Oe=!Oe,j(`${Oe?"Showing":"Hiding"} finished pieces`),J=!0;else if(c===g.INPUT_EV_TOGGLE_LOOSE_PIECES)Ne=!Ne,j(`${Ne?"Showing":"Hiding"} unfinished pieces`),J=!0;else if(c===g.INPUT_EV_TOGGLE_TABLE)So();else if(c===g.INPUT_EV_STORE_POS){const v=`${a[1]}`;ue[v]=L.snapshot(),j(`Stored position ${v}`)}else if(c===g.INPUT_EV_RESTORE_POS){const v=`${a[1]}`,I=Qe(v);j(I?`Restored position "${I}"`:`Position "${v}" not set`)}}ft=!!z.getFinishTs(e),co()&&(G.update(),J=!0)},Bs=new DOMMatrix([1,0,0,1,0,0]),Gs={dark:await de.loadImageToBitmap(Tt["./assets/textures/wood-dark.jpg"].default),light:await de.loadImageToBitmap(Tt["./assets/textures/wood-light.jpg"].default),brown:await de.loadImageToBitmap(Tt["./assets/textures/Oak-none-3275x2565mm-Architextures.jpg"].default)},Is=Yr({update:Ds,render:async()=>{if(!J)return;const a=H();let c,v,I;if(window.DEBUG&&Ae.checkpoint_start(0),N.fillStyle=go(),N.fillRect(0,0,U.width,U.height),D.showTable){const S=Gs[D.tableTexture];if(S){const me=z.getBounds(e);c=L.worldToViewportRaw(me),v=L.worldDimToViewportRaw(me);const Ce=N.createPattern(S,"repeat");Ce.setTransform(Bs.translate(c.x,c.y).scale(L.getCurrentZoom()*3)),N.fillStyle=Ce,N.fillRect(c.x,c.y,v.w,v.h);const he=L.worldDimToViewportRaw({w:16,h:16});N.fillStyle="rgba(0, 0, 0, .5)",N.fillRect(c.x,c.y,v.w,he.h),N.fillRect(c.x,c.y+he.h,he.w,v.h-2*he.h),N.fillRect(c.x+v.w-he.w,c.y+he.h,he.w,v.h-2*he.h),N.fillRect(c.x,c.y+v.h-he.h,v.w,he.w)}}if(window.DEBUG&&Ae.checkpoint("clear done"),c=L.worldToViewportRaw(ao),v=L.worldDimToViewportRaw(gt),D.showTable){const S=L.worldDimToViewportRaw({w:8,h:8});N.fillStyle="rgba(0, 0, 0, .5)",N.fillRect(c.x-S.w,c.y-S.h,v.w+2*S.w,S.h),N.fillRect(c.x-S.w,c.y,S.h,v.h),N.fillRect(c.x+v.w,c.y,S.w,v.h),N.fillRect(c.x-S.w,c.y+v.h,v.w+2*S.w,S.h)}D.showTable&&["dark","brown"].includes(D.tableTexture)?N.fillStyle="rgba(0, 0, 0, .3)":N.fillStyle="rgba(255, 255, 255, .3)",N.fillRect(c.x,c.y,v.w,v.h),window.DEBUG&&Ae.checkpoint("board done");const W=z.getPiecesSortedByZIndex(e);window.DEBUG&&Ae.checkpoint("get pieces done"),v=L.worldDimToViewportRaw(ro);for(const S of W)!lc(S)||(I=P[S.idx],c=L.worldToViewportRaw({x:$e+S.pos.x,y:$e+S.pos.y}),N.drawImage(I,0,0,I.width,I.height,c.x,c.y,v.w,v.h));window.DEBUG&&Ae.checkpoint("pieces done");const F=[];for(const S of z.getActivePlayers(e,a))r(S)&&(I=await b(S),c=L.worldToViewport(S),N.drawImage(I,c.x-B,c.y-$),po()&&F.push([`${S.name} (${S.points})`,c.x,c.y+O]));N.fillStyle="white",N.textAlign="center";for(const[S,me,Ce]of F)N.fillText(S,me,Ce);window.DEBUG&&Ae.checkpoint("players done"),Je(a),window.DEBUG&&Ae.checkpoint("HUD done"),co()&&G.render(),J=!1}}),xs=()=>{zs(),Is.stop(),ce&&ce.unregisterEvents()};return{previewImageUrl:Us,player:D,game:z.get(e),disconnect:Se.disconnect,connect:ie,unload:xs}}const ac=oe({name:"game",components:{PuzzleStatusComponent:Zt,Scores:Ft,SettingsOverlay:Ht,PreviewOverlay:jt,InfoOverlay:Kt,ConnectionOverlay:cs,HelpOverlay:Qt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,interface:!0,eventBus:Ho(),g:{player:Ko(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleInterface",t=>{this.interface=!!t}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("toggleShowTable",t=>{this.g.player.showTable=!!t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.showTable,t=>{this.eventBus.emit("onShowTableChange",t)}),this.$watch(()=>this.g.player.tableTexture,t=>{this.eventBus.emit("onTableTextureChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await ks(`${this.$route.params.id}`,ye.clientId(),this.$config.WS_ADDRESS,je,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}}}),rc={id:"game"},uc=o("div",null,[o("i",{class:"icon icon-hourglass"}),f(" Cutting puzzle, please wait... "),o("i",{class:"icon icon-hourglass"})],-1),cc={key:4,class:"menu-left"},dc={key:0,class:"switch-game-replay"},hc=o("i",{class:"icon icon-replay"},null,-1),pc=f(" Watch replay"),gc={key:5,class:"menu"},fc=o("i",{class:"icon icon-puzzle-piece"},null,-1),mc=f(" Puzzles"),_c=o("i",{class:"icon icon-preview"},null,-1),yc=f(" Preview"),wc=[_c,yc],vc=o("i",{class:"icon icon-settings"},null,-1),Ec=f(" Settings"),Pc=[vc,Ec],bc=o("i",{class:"icon icon-info"},null,-1),Tc=f(" Info"),$c=[bc,Tc],Cc=o("i",{class:"icon icon-hotkey"},null,-1),Sc=f(" Hotkeys"),kc=[Cc,Sc],Ac=o("a",{class:"opener",href:"https://stand-with-ukraine.pp.ua/",target:"_blank"},[o("i",{class:"icon icon-ukraine-heart"}),f(" Stand with Ukraine ")],-1),Oc={key:6,class:"menu-right"},Nc={key:7,class:"status-messages"},Uc={ref:"canvas"};function Rc(e,t,s,n,i,l){const r=V("settings-overlay"),u=V("preview-overlay"),m=V("info-overlay"),h=V("help-overlay"),k=V("overlay"),M=V("connection-overlay"),E=V("puzzle-status"),y=V("router-link"),A=V("scores");return d(),w("div",rc,[e.overlay==="settings"?(d(),te(r,{key:0,onClose:t[0]||(t[0]=_=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=_=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=_=>e.g.player=_)},null,8,["modelValue"])):R("",!0),e.overlay==="preview"?(d(),te(u,{key:1,onClose:t[3]||(t[3]=_=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=_=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):R("",!0),e.g.game&&e.overlay==="info"?(d(),te(m,{key:2,onClose:t[5]||(t[5]=_=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=_=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):R("",!0),e.overlay==="help"?(d(),te(h,{key:3,onClose:t[7]||(t[7]=_=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=_=>e.toggle("help",!0))})):R("",!0),Z(ee(k,null,{default:le(()=>[uc]),_:1},512),[[Zo,e.cuttingPuzzle]]),ee(M,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),e.interface?(d(),w("div",cc,[ee(E,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(d(),w("div",dc,[ee(y,{to:{name:"replay",params:{id:e.g.game.id}}},{default:le(()=>[hc,pc]),_:1},8,["to"])])):R("",!0)])):R("",!0),e.interface?(d(),w("div",gc,[ee(y,{class:"opener",to:{name:"index"},target:"_blank"},{default:le(()=>[fc,mc]),_:1}),o("div",{class:"opener",onClick:t[9]||(t[9]=_=>e.toggle("preview",!1))},wc),o("div",{class:"opener",onClick:t[10]||(t[10]=_=>e.toggle("settings",!0))},Pc),o("div",{class:"opener",onClick:t[11]||(t[11]=_=>e.toggle("info",!0))},$c),o("div",{class:"opener",onClick:t[12]||(t[12]=_=>e.toggle("help",!0))},kc),Ac])):R("",!0),e.interface?(d(),w("div",Oc,[ee(A,{players:e.players},null,8,["players"])])):R("",!0),e.statusMessages.length?(d(),w("div",Nc,[(d(!0),w(re,null,ge(e.statusMessages,(_,B)=>(d(),w("div",{key:B},Y(_),1))),128))])):R("",!0),o("canvas",Uc,null,512)])}var Lc=se(ac,[["render",Rc]]);const Vc=oe({name:"replay",components:{PuzzleStatusComponent:Zt,Scores:Ft,SettingsOverlay:Ht,PreviewOverlay:jt,InfoOverlay:Kt,HelpOverlay:Qt},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,interface:!0,eventBus:Ho(),g:{player:Ko(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleInterface",t=>{this.interface=!!t}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("toggleShowTable",t=>{this.g.player.showTable=!!t}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.showTable,t=>{this.eventBus.emit("onShowTableChange",t)}),this.$watch(()=>this.g.player.tableTexture,t=>{this.eventBus.emit("onTableTextureChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await ks(`${this.$route.params.id}`,ye.clientId(),this.$config.WS_ADDRESS,Ee,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Mc={id:"replay"},zc={key:4,class:"overlay"},Dc=o("div",{class:"overlay-content"},[o("div",null,[o("i",{class:"icon icon-hourglass"}),f(" Cutting puzzle, please wait... "),o("i",{class:"icon icon-hourglass"})])],-1),Bc=[Dc],Gc={key:5,class:"menu-left"},Ic={class:"playback-control"},xc=o("i",{class:"icon icon-speed-up"},null,-1),Yc=[xc],Wc=o("i",{class:"icon icon-speed-down"},null,-1),Fc=[Wc],Zc=o("i",{class:"icon icon-pause"},null,-1),Hc=[Zc],jc={key:0,class:"switch-game-replay"},Kc=o("i",{class:"icon icon-puzzle-piece"},null,-1),qc=f(" To the game"),Xc={key:6,class:"menu"},Qc=o("i",{class:"icon icon-puzzle-piece"},null,-1),Jc=f(" Puzzles"),ed=o("i",{class:"icon icon-preview"},null,-1),td=f(" Preview"),od=[ed,td],sd=o("i",{class:"icon icon-settings"},null,-1),nd=f(" Settings"),id=[sd,nd],ld=o("i",{class:"icon icon-info"},null,-1),ad=f(" Info"),rd=[ld,ad],ud=o("i",{class:"icon icon-hotkey"},null,-1),cd=f(" Hotkeys"),dd=[ud,cd],hd=o("a",{class:"opener",href:"https://stand-with-ukraine.pp.ua/",target:"_blank"},[o("i",{class:"icon icon-ukraine-heart"}),f(" Stand with Ukraine ")],-1),pd={key:7,class:"menu-right"},gd={key:8,class:"status-messages"},fd={ref:"canvas"};function md(e,t,s,n,i,l){const r=V("settings-overlay"),u=V("preview-overlay"),m=V("info-overlay"),h=V("help-overlay"),k=V("puzzle-status"),M=V("router-link"),E=V("scores");return d(),w("div",Mc,[e.overlay==="settings"?(d(),te(r,{key:0,onClose:t[0]||(t[0]=y=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=y=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=y=>e.g.player=y)},null,8,["modelValue"])):R("",!0),e.overlay==="preview"?(d(),te(u,{key:1,onClose:t[3]||(t[3]=y=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=y=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):R("",!0),e.g.game&&e.overlay==="info"?(d(),te(m,{key:2,onClose:t[5]||(t[5]=y=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=y=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):R("",!0),e.overlay==="help"?(d(),te(h,{key:3,onClose:t[7]||(t[7]=y=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=y=>e.toggle("help",!0))})):R("",!0),e.cuttingPuzzle?(d(),w("div",zc,Bc)):R("",!0),e.interface?(d(),w("div",Gc,[ee(k,{status:e.status},null,8,["status"]),o("div",Ic,[o("div",null,Y(e.replayText),1),o("button",{class:"btn",onClick:t[9]||(t[9]=y=>e.eventBus.emit("replayOnSpeedUp"))},Yc),o("button",{class:"btn",onClick:t[10]||(t[10]=y=>e.eventBus.emit("replayOnSpeedDown"))},Fc),o("button",{class:"btn",onClick:t[11]||(t[11]=y=>e.eventBus.emit("replayOnPauseToggle"))},Hc)]),e.g.game?(d(),w("div",jc,[ee(M,{to:{name:"game",params:{id:e.g.game.id}}},{default:le(()=>[Kc,qc]),_:1},8,["to"])])):R("",!0)])):R("",!0),e.interface?(d(),w("div",Xc,[ee(M,{class:"opener",to:{name:"index"},target:"_blank"},{default:le(()=>[Qc,Jc]),_:1}),o("div",{class:"opener",onClick:t[12]||(t[12]=y=>e.toggle("preview",!1))},od),o("div",{class:"opener",onClick:t[13]||(t[13]=y=>e.toggle("settings",!0))},id),o("div",{class:"opener",onClick:t[14]||(t[14]=y=>e.toggle("info",!0))},rd),o("div",{class:"opener",onClick:t[15]||(t[15]=y=>e.toggle("help",!0))},dd),hd])):R("",!0),e.interface?(d(),w("div",pd,[ee(E,{players:e.players},null,8,["players"])])):R("",!0),e.statusMessages.length?(d(),w("div",gd,[(d(!0),w(re,null,ge(e.statusMessages,(y,A)=>(d(),w("div",{key:A},Y(y),1))),128))])):R("",!0),o("canvas",fd,null,512)])}var _d=se(Vc,[["render",md]]);let As=null;async function yd(){As=await(await ye.get("/api/me",{})).json()}var Os={getMe:()=>As,init:yd};const wd=oe({props:{image:{type:Object,required:!0}},data:()=>({me:Os.getMe()}),computed:{url(){return this.image.url.replace("uploads/","uploads/r/")+"-375x0.webp"},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}}),vd=["src"],Ed=o("i",{class:"icon icon-edit"},null,-1),Pd=[Ed],bd={class:"imageteaser-info"};function Td(e,t,s,n,i,l){return d(),w("div",{class:"imageteaser",onClick:t[1]||(t[1]=(...r)=>e.onClick&&e.onClick(...r))},[o("img",{src:e.url},null,8,vd),e.canEdit?(d(),w("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=$t((...r)=>e.onEditClick&&e.onEditClick(...r),["stop"]))},Pd)):R("",!0),o("div",bd,Y(e.image.gameCount)+"x plays ",1)])}var $d=se(wd,[["render",Td]]);const Cd=oe({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Sd={class:"overlay"};function kd(e,t,s,n,i,l){return d(),w("div",Sd,[o("div",{class:Xe(["overlay-background",e.classes.map(r=>"overlay-background-"+r)]),onClick:t[0]||(t[0]=r=>e.$emit("bgclick"))},null,2),o("div",{class:Xe(["overlay-content",e.classes.map(r=>"overlay-content-"+r)])},[jo(e.$slots,"default")],2)])}var Ad=se(Cd,[["render",kd]]);const Od={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Nd=["title"];function Ud(e,t,s,n,i,l){return d(),w("div",{style:Me(l.style),title:s.title},null,12,Nd)}var Rd=se(Od,[["render",Ud]]);const Ld=oe({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;if(e.code==="Escape")return this.autocomplete.values=[],this.autocomplete.idx=-1,e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),Vd={class:"input-holder"},Md={key:0,class:"enter-hint color-highlight"},zd={key:0,class:"autocomplete"},Dd=["onClick"],Bd=["onClick"];function Gd(e,t,s,n,i,l){return d(),w("div",null,[o("div",Vd,[Z(o("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=r=>e.input=r),placeholder:"Plants, People",onKeydown:[t[1]||(t[1]=No($t((...r)=>e.add&&e.add(...r),["prevent"]),["enter"])),t[2]||(t[2]=No($t((...r)=>e.add&&e.add(...r),["prevent"]),["tab"]))],onKeyup:t[3]||(t[3]=(...r)=>e.onKeyUp&&e.onKeyUp(...r))},null,544),[[Re,e.input]]),e.input?(d(),w("div",Md,"[Press ENTER/TAB to add]")):R("",!0)]),e.autocomplete.values?(d(),w("div",zd,[o("ul",null,[(d(!0),w(re,null,ge(e.autocomplete.values,(r,u)=>(d(),w("li",{key:u,class:Xe({active:u===e.autocomplete.idx}),onClick:m=>e.addVal(r)},Y(r),11,Dd))),128))])])):R("",!0),(d(!0),w(re,null,ge(e.values,(r,u)=>(d(),w("span",{key:u,class:"bit is-clickable",onClick:m=>e.rm(r)},Y(r)+" \u2716",9,Bd))),128))])}var Id=se(Ld,[["render",Gd],["__scopeId","data-v-8e01df40"]]);const xd=["data-index"],Yd=oe({props:{columnWidth:{default:400},items:null,gap:{default:0},rtl:{type:Boolean,default:!1},ssrColumns:{default:0}},emits:["redraw","redraw-skip"],setup(e,{emit:t}){const s=e,{columnWidth:n,items:i,gap:l,rtl:r,ssrColumns:u}=Hs(s),m=Uo([]),h=Uo();function k(){h.value.getBoundingClientRect().width+l.value,n.value+l.value;const _=Math.floor((h.value.getBoundingClientRect().width+l.value)/(n.value+l.value));return _>0?_:1}function M(_){return[...new Array(_)].map(()=>[])}if(u.value>0){const _=M(u.value);i.value.forEach((B,O)=>_[O%u.value].push(O)),m.value=_}async function E(_){if(_>=i.value.length)return;await qs();const B=[...h.value.children];r.value&&B.reverse();const O=B.reduce(($,T)=>T.getBoundingClientRect().height<$.getBoundingClientRect().height?T:$);m.value[+O.dataset.index].push(_),await E(_+1)}async function y(_=!1){if(m.value.length===k()&&!_){t("redraw-skip");return}m.value=M(k());const B=window.scrollY;await E(0),window.scrollTo({top:B}),t("redraw")}const A=new ResizeObserver(()=>y());return js(()=>{y(),A.observe(h.value)}),Ks(()=>A.unobserve(h.value)),Ro([i,r],()=>y(!0)),Ro([n,l],()=>y()),(_,B)=>(d(),w("div",{ref_key:"wall",ref:h,class:"masonry-wall",style:Me({display:"flex",gap:`${st(l)}px`})},[(d(!0),w(re,null,ge(m.value,(O,$)=>(d(),w("div",{key:$,class:"masonry-column","data-index":$,style:Me({display:"flex","flex-basis":0,"flex-direction":"column","flex-grow":1,height:["-webkit-max-content","-moz-max-content","max-content"],gap:`${st(l)}px`})},[(d(!0),w(re,null,ge(O,T=>(d(),w("div",{key:T,class:"masonry-item"},[jo(_.$slots,"default",{item:st(i)[T],index:T},()=>[f(Y(st(i)[T]),1)])]))),128))],12,xd))),128))],4))}});(async()=>{ye.init(),await Os.init();const t=await(await ye.get("/api/conf",{})).json(),s=Xs({history:Qs(),routes:[{name:"index",path:"/",component:jn},{name:"new-game",path:"/new-game",component:$l},{name:"game",path:"/g/:id",component:Lc},{name:"replay",path:"/replay/:id",component:_d}]});s.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const n=Js(un);n.config.globalProperties.$config=t,n.use(s),n.component("masonry-wall",Yd),n.component("connection-overlay",cs),n.component("edit-image-dialog",ss),n.component("game-teaser",Jo),n.component("help-overlay",Qt),n.component("image-library",es),n.component("image-teaser",$d),n.component("info-overlay",Kt),n.component("new-game-dialog",ns),n.component("new-image-dialog",os),n.component("overlay",Ad),n.component("preview-overlay",jt),n.component("puzzle-status",Zt),n.component("responsive-image",Rd),n.component("scores",Ft),n.component("settings-overlay",Ht),n.component("tags-input",Id),n.mount("#app")})();
//# sourceMappingURL=index.f473f64d.js.map
