import{d as Z,r as U,o as E,c as S,a as o,b as x,w as X,e as ee,f as M,g as ie,n as Ne,t as Y,F as le,h as me,i as Fe,j as I,v as ve,k as we,l as oo,m as oe,p as cn,q as so,s as io,u as dn,x as lo,y as ro,z as ao,A as uo,B as co,C as po}from"./vendor.0dfaad5f.js";const ho=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}};ho();var H=(e,t)=>{const n=e.__vccOpts||e;for(const[s,i]of t)n[s]=i;return n};const go=Z({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),fo={id:"app"},mo={key:0,class:"nav"},_o=M("Games overview"),yo=M("New game");function Eo(e,t,n,s,i,r){const l=U("router-link"),a=U("router-view");return E(),S("div",fo,[e.showNav?(E(),S("ul",mo,[o("li",null,[x(l,{class:"btn",to:{name:"index"}},{default:X(()=>[_o]),_:1})]),o("li",null,[x(l,{class:"btn",to:{name:"new-game"}},{default:X(()=>[yo]),_:1})])])):ee("",!0),x(a)])}var vo=H(go,[["render",Eo]]);class qe{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,n){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const s=(this.rand_high>>>0)/4294967295;return t+s*(n-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const n=t.slice();for(let s=0;s<=n.length-2;s++){const i=this.random(s,n.length-1),r=n[s];n[s]=n[i],n[i]=r}return n}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const n=new qe(0);return n.rand_high=t.rand_high,n.rand_low=t.rand_low,n}}const wo=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},ht=(e,t)=>{const n=`${e}`;return n.length>=t.length?n:t.substr(0,t.length-n.length)+n},gt=(...e)=>{const t=n=>(...s)=>{const i=new Date,r=ht(i.getHours(),"00"),l=ht(i.getMinutes(),"00"),a=ht(i.getSeconds(),"00");console[n](`${r}:${l}:${a}`,...e,...s)};return{log:t("log"),error:t("error"),info:t("info")}},Po=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function To(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Co(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function So(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function bo(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function $o(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function Ao(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function Oo(e){return[e.id,e.rng.type||"",qe.serialize(e.rng.obj),e.puzzle,e.players,e.evtInfos,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId]}function No(e){return{id:e[0],rng:{type:e[1],obj:qe.unserialize(e[2])},puzzle:e[3],players:e[4],evtInfos:e[5],scoreMode:e[6],shapeMode:e[7],snapMode:e[8],creatorUserId:e[9]}}function Uo(e,t){const n=e.width/e.tileSize;return{x:t%n,y:Math.floor(t/n)}}const ko=e=>{let t=0;for(let n=0;n<e.length;n++){const s=e.charCodeAt(n);t=(t<<5)-t+s,t|=0}return t};function Ro(e){const t=[];for(const n in e){const s=[n,e[n]].map(encodeURIComponent);t.push(s.join("="))}return t.length===0?"":`?${t.join("&")}`}var F={hash:ko,slug:wo,uniqId:Po,encodeShape:To,decodeShape:Co,encodePiece:So,decodePiece:bo,encodePlayer:$o,decodePlayer:Ao,encodeGame:Oo,decodeGame:No,coordByPieceIdx:Uo,asQueryArgs:Ro};const J={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},pe={SOUND_VOLUME:100,SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},ft=(e,t)=>{localStorage.setItem(e,t)},mt=e=>localStorage.getItem(e),Vo=(e,t)=>{ft(e,`${t}`)},zo=(e,t)=>{const n=mt(e);if(n===null)return t;const s=parseInt(n,10);return isNaN(s)?t:s},Lo=(e,t)=>{ft(e,t?"1":"0")},Mo=(e,t)=>{const n=mt(e);return n===null?t:n==="1"},Do=(e,t)=>{ft(e,t)},Fo=(e,t)=>{const n=mt(e);return n===null?t:n};var q={setInt:Vo,getInt:zo,setBool:Lo,getBool:Mo,setStr:Do,getStr:Fo};let _t="",pn="";const yt=async(e,t,n)=>new Promise((s,i)=>{const r=new window.XMLHttpRequest;r.open(e,t,!0),r.withCredentials=!0;for(const l in n.headers||{})r.setRequestHeader(l,n.headers[l]);r.setRequestHeader("Client-Id",_t),r.setRequestHeader("Client-Secret",pn),r.addEventListener("load",function(l){s({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),r.addEventListener("error",function(l){i(new Error("xhr error"))}),r.upload&&n.onUploadProgress&&r.upload.addEventListener("progress",function(l){n.onUploadProgress&&n.onUploadProgress(l)}),r.send(n.body||null)}),hn=e=>{let t=q.getStr(e,"");return t||(t=F.uniqId(),q.setStr(e,t)),t};var re={init:()=>{_t=hn("ID"),pn=hn("SECRET")},request:yt,get:(e,t)=>yt("get",e,t),post:(e,t)=>yt("post",e,t),clientId:()=>_t};const gn=1,Et=gn*1e3,Qe=Et*60,Xe=Qe*60,vt=Xe*24,Go=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},fn=e=>{const t=Math.floor(e/vt);e=e%vt;const n=Math.floor(e/Xe);e=e%Xe;const s=Math.floor(e/Qe);e=e%Qe;const i=Math.floor(e/Et);return`${t}d ${n}h ${s}m ${i}s`},Io=(e,t)=>fn(t-e);var he={MS:gn,SEC:Et,MIN:Qe,HOUR:Xe,DAY:vt,timestamp:Go,timeDiffStr:Io,durationStr:fn};const Bo=Z({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const n=t?"\u{1F3C1}":"\u23F3",s=e,i=t||he.timestamp(),r=he.timeDiffStr(s,i);return`${n} ${r}`}}}),xo={class:"game-info-text"},Yo=o("br",null,null,-1),Wo=o("br",null,null,-1),Ho=o("br",null,null,-1),jo=M(" \u21AA\uFE0F Watch replay ");function Zo(e,t,n,s,i,r){const l=U("router-link");return E(),S("div",{class:"game-teaser",style:Ne(e.style)},[x(l,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:X(()=>[o("span",xo,[M(" \u{1F9E9} "+Y(e.game.tilesFinished)+"/"+Y(e.game.tilesTotal),1),Yo,M(" \u{1F465} "+Y(e.game.players),1),Wo,M(" "+Y(e.time(e.game.started,e.game.finished)),1),Ho])]),_:1},8,["to"]),e.game.hasReplay?(E(),ie(l,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:X(()=>[jo]),_:1},8,["to"])):ee("",!0)],4)}var mn=H(Bo,[["render",Zo]]);const Ko=Z({components:{GameTeaser:mn},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await re.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),qo=o("h1",null,"Running games",-1),Qo=o("h1",null,"Finished games",-1);function Xo(e,t,n,s,i,r){const l=U("game-teaser");return E(),S("div",null,[qo,(E(!0),S(le,null,me(e.gamesRunning,(a,m)=>(E(),S("div",{class:"game-teaser-wrap",key:m},[x(l,{game:a},null,8,["game"])]))),128)),Qo,(E(!0),S(le,null,me(e.gamesFinished,(a,m)=>(E(),S("div",{class:"game-teaser-wrap",key:m},[x(l,{game:a},null,8,["game"])]))),128))])}var Jo=H(Ko,[["render",Xo]]);const es=Z({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function ts(e,t,n,s,i,r){const l=U("image-teaser");return E(),S("div",null,[(E(!0),S(le,null,me(e.images,(a,m)=>(E(),ie(l,{image:a,onClick:P=>e.imageClicked(a),onEditClick:P=>e.imageEditClicked(a),key:m},null,8,["image","onClick","onEditClick"]))),128))])}var _n=H(es,[["render",ts]]);const ns=Z({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.droppable=!1},imageFromDragEvt(e){var s;const t=(s=e.dataTransfer)==null?void 0:s.items;if(!t||t.length===0)return null;const n=t[0];return n.type.startsWith("image/")?n:null},onFileSelect(e){const t=e.target;if(!t.files)return;const n=t.files[0];!n||this.preview(n)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=n=>{this.previewUrl=n.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const n=t.getAsFile();return n&&(this.file=n,this.preview(n),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),os=o("div",{class:"drop-target"},null,-1),ss={key:0,class:"has-image"},is={key:1},ls={class:"upload"},rs=o("span",{class:"btn"},"Upload File",-1),as={class:"area-settings"},us=o("td",null,[o("label",null,"Title")],-1),cs=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),ds=o("td",null,[o("label",null,"Tags")],-1),ps={class:"area-buttons"},hs=["disabled"],gs=M("\u{1F5BC}\uFE0F Post to gallery"),fs=["disabled"],ms=M("\u{1F9E9} Post to gallery "),_s=o("br",null,null,-1),ys=M(" + set up game");function Es(e,t,n,s,i,r){const l=U("responsive-image"),a=U("tags-input"),m=U("overlay");return E(),ie(m,{class:"new-image-dialog"},{default:X(()=>[o("div",{class:Fe(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...P)=>e.onDrop&&e.onDrop(...P)),onDragover:t[3]||(t[3]=(...P)=>e.onDragover&&e.onDragover(...P)),onDragleave:t[4]||(t[4]=(...P)=>e.onDragleave&&e.onDragleave(...P))},[os,e.previewUrl?(E(),S("div",ss,[o("span",{class:"remove btn",onClick:t[0]||(t[0]=P=>e.previewUrl="")},"X"),x(l,{src:e.previewUrl},null,8,["src"])])):(E(),S("div",is,[o("label",ls,[o("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...P)=>e.onFileSelect&&e.onFileSelect(...P)),accept:"image/*"},null,32),rs])]))],34),o("div",as,[o("table",null,[o("tr",null,[us,o("td",null,[I(o("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=P=>e.title=P),placeholder:"Flower by @artist"},null,512),[[ve,e.title]])])]),cs,o("tr",null,[ds,o("td",null,[x(a,{modelValue:e.tags,"onUpdate:modelValue":t[6]||(t[6]=P=>e.tags=P),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",ps,[o("button",{class:"btn",disabled:!e.canPostToGallery,onClick:t[7]||(t[7]=(...P)=>e.postToGallery&&e.postToGallery(...P))},[e.uploading==="postToGallery"?(E(),S(le,{key:0},[M("Uploading ("+Y(e.uploadProgressPercent)+"%)",1)],64)):(E(),S(le,{key:1},[gs],64))],8,hs),o("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[8]||(t[8]=(...P)=>e.setupGameClick&&e.setupGameClick(...P))},[e.uploading==="setupGame"?(E(),S(le,{key:0},[M("Uploading ("+Y(e.uploadProgressPercent)+"%)",1)],64)):(E(),S(le,{key:1},[ms,_s,ys],64))],8,fs)])]),_:1})}var yn=H(ns,[["render",Es]]);const vs=Z({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),ws={class:"area-image"},Ps={class:"has-image"},Ts={class:"area-settings"},Cs=o("td",null,[o("label",null,"Title")],-1),Ss=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),bs=o("td",null,[o("label",null,"Tags")],-1),$s={class:"area-buttons"};function As(e,t,n,s,i,r){const l=U("responsive-image"),a=U("tags-input"),m=U("overlay");return E(),ie(m,{class:"edit-image-dialog"},{default:X(()=>[o("div",ws,[o("div",Ps,[x(l,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),o("div",Ts,[o("table",null,[o("tr",null,[Cs,o("td",null,[I(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=P=>e.title=P),placeholder:"Flower by @artist"},null,512),[[ve,e.title]])])]),Ss,o("tr",null,[bs,o("td",null,[x(a,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=P=>e.tags=P),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",$s,[o("button",{class:"btn",onClick:t[2]||(t[2]=(...P)=>e.saveImage&&e.saveImage(...P))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var En=H(vs,[["render",As]]),vn;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(vn||(vn={}));var _e;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(_e||(_e={}));var Ue;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(Ue||(Ue={}));var Pe;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(Pe||(Pe={}));const Os=Z({props:{image:{type:Object,required:!0}},emits:{newGame:null},data(){return{tiles:1e3,scoreMode:_e.ANY,shapeMode:Ue.NORMAL,snapMode:Pe.NORMAL}},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Ns={class:"area-image"},Us={class:"has-image"},ks={key:0,class:"image-title"},Rs={key:0,class:"image-title-title"},Vs={key:1,class:"image-title-dim"},zs={class:"area-settings"},Ls=o("td",null,[o("label",null,"Pieces")],-1),Ms=o("td",null,[o("label",null,"Scoring: ")],-1),Ds=M(" Any (Score when pieces are connected to each other or on final location)"),Fs=o("br",null,null,-1),Gs=M(" Final (Score when pieces are put to their final location)"),Is=o("td",null,[o("label",null,"Shapes: ")],-1),Bs=M(" Normal"),xs=o("br",null,null,-1),Ys=M(" Any (Flat pieces can occur anywhere)"),Ws=o("br",null,null,-1),Hs=M(" Flat (All pieces flat on all sides)"),js=o("td",null,[o("label",null,"Snapping: ")],-1),Zs=M(" Normal (Pieces snap to final destination and to each other)"),Ks=o("br",null,null,-1),qs=M(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),Qs={class:"area-buttons"},Xs=["disabled"];function Js(e,t,n,s,i,r){const l=U("responsive-image"),a=U("overlay");return E(),ie(a,{class:"new-game-dialog"},{default:X(()=>[o("div",Ns,[o("div",Us,[x(l,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(E(),S("div",ks,[e.image.title?(E(),S("span",Rs,'"'+Y(e.image.title)+'"',1)):ee("",!0),e.image.width||e.image.height?(E(),S("span",Vs,"("+Y(e.image.width)+" \u2715 "+Y(e.image.height)+")",1)):ee("",!0)])):ee("",!0)]),o("div",zs,[o("table",null,[o("tr",null,[Ls,o("td",null,[I(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=m=>e.tiles=m)},null,512),[[ve,e.tiles]])])]),o("tr",null,[Ms,o("td",null,[o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=m=>e.scoreMode=m),value:"1"},null,512),[[we,e.scoreMode]]),Ds]),Fs,o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=m=>e.scoreMode=m),value:"0"},null,512),[[we,e.scoreMode]]),Gs])])]),o("tr",null,[Is,o("td",null,[o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=m=>e.shapeMode=m),value:"0"},null,512),[[we,e.shapeMode]]),Bs]),xs,o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=m=>e.shapeMode=m),value:"1"},null,512),[[we,e.shapeMode]]),Ys]),Ws,o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=m=>e.shapeMode=m),value:"2"},null,512),[[we,e.shapeMode]]),Hs])])]),o("tr",null,[js,o("td",null,[o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=m=>e.snapMode=m),value:"0"},null,512),[[we,e.snapMode]]),Zs]),Ks,o("label",null,[I(o("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=m=>e.snapMode=m),value:"1"},null,512),[[we,e.snapMode]]),qs])])])])]),o("div",Qs,[o("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[8]||(t[8]=(...m)=>e.onNewGameClick&&e.onNewGameClick(...m))}," \u{1F9E9} Generate Puzzle ",8,Xs)])]),_:1})}var wn=H(Os,[["render",Js]]);const ei=Z({components:{ImageLibrary:_n,NewImageDialog:yn,EditImageDialog:En,NewGameDialog:wn},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(n=>!t.includes(n.title)&&n.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(n=>n.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await re.get(`/api/newgame-data${F.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags);const n=await re.post("/api/upload",{body:t,onUploadProgress:s=>{this.uploadProgress=s.loaded/s.total}});return this.uploadProgress=1,await n.json()},async saveImage(e){return await(await re.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.dialog="new-game"},async onNewGame(e){const t=await re.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const n=await t.json();this.$router.push({name:"game",params:{id:n.id}})}}}}),ti={class:"upload-image-teaser"},ni=o("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),oi={key:0},si=M(" Tags: "),ii=["onClick"],li=M(" Sort by: "),ri=o("option",{value:"date_desc"},"Newest first",-1),ai=o("option",{value:"date_asc"},"Oldest first",-1),ui=o("option",{value:"alpha_asc"},"A-Z",-1),ci=o("option",{value:"alpha_desc"},"Z-A",-1),di=[ri,ai,ui,ci];function pi(e,t,n,s,i,r){const l=U("image-library"),a=U("new-image-dialog"),m=U("edit-image-dialog"),P=U("new-game-dialog");return E(),S("div",null,[o("div",ti,[o("div",{class:"btn btn-big",onClick:t[0]||(t[0]=N=>e.dialog="new-image")},"Upload your image"),ni]),o("div",null,[e.tags.length>0?(E(),S("label",oi,[si,(E(!0),S(le,null,me(e.relevantTags,(N,$)=>(E(),S("span",{class:Fe(["bit",{on:e.filters.tags.includes(N.slug)}]),key:$,onClick:v=>e.toggleTag(N)},Y(N.title)+" ("+Y(N.total)+")",11,ii))),128))])):ee("",!0),o("label",null,[li,I(o("select",{"onUpdate:modelValue":t[1]||(t[1]=N=>e.filters.sort=N),onChange:t[2]||(t[2]=(...N)=>e.filtersChanged&&e.filtersChanged(...N))},di,544),[[oo,e.filters.sort]])])]),x(l,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),I(x(a,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=N=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[oe,e.dialog==="new-image"]]),I(x(m,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=N=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[oe,e.dialog==="edit-image"]]),I(x(P,{onBgclick:t[5]||(t[5]=N=>e.dialog=""),onNewGame:e.onNewGame,image:e.image},null,8,["onNewGame","image"]),[[oe,e.image&&e.dialog==="new-game"]])])}var hi=H(ei,[["render",pi]]);const gi=Z({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),fi={class:"scores"},mi=o("div",null,"Scores",-1),_i=o("td",null,"\u26A1",-1),yi=o("td",null,"\u{1F4A4}",-1);function Ei(e,t,n,s,i,r){return E(),S("div",fi,[mi,o("table",null,[(E(!0),S(le,null,me(e.actives,(l,a)=>(E(),S("tr",{key:a,style:Ne({color:l.color})},[_i,o("td",null,Y(l.name),1),o("td",null,Y(l.points),1)],4))),128)),(E(!0),S(le,null,me(e.idles,(l,a)=>(E(),S("tr",{key:a,style:Ne({color:l.color})},[yi,o("td",null,Y(l.name),1),o("td",null,Y(l.points),1)],4))),128))])])}var wt=H(gi,[["render",Ei]]);const vi=Z({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return he.durationStr(this.status.duration)}}}),wi={class:"puzzle-status"};function Pi(e,t,n,s,i,r){return E(),S("div",wi,[o("div",null," \u{1F9E9} "+Y(e.status.piecesDone)+"/"+Y(e.status.piecesTotal),1),o("div",null,Y(e.icon)+" "+Y(e.durationStr),1)])}var Pt=H(vi,[["render",Pi]]);const Ti=Z({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch("background",this.emitChanges)),this.watches.push(this.$watch("color",this.emitChanges)),this.watches.push(this.$watch("name",this.emitChanges)),this.watches.push(this.$watch("soundsEnabled",this.emitChanges)),this.watches.push(this.$watch("soundsVolume",this.emitChanges)),this.watches.push(this.$watch("showPlayerNames",this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue),this.$watch("modelValue",e=>{this.apply(e)})}}),ke=e=>(so("data-v-39db9680"),e=e(),io(),e),Ci={class:"settings"},Si=ke(()=>o("td",null,[o("label",null,"Background: ")],-1)),bi=ke(()=>o("td",null,[o("label",null,"Color: ")],-1)),$i=ke(()=>o("td",null,[o("label",null,"Name: ")],-1)),Ai=ke(()=>o("td",null,[o("label",null,"Sounds: ")],-1)),Oi=ke(()=>o("td",null,[o("label",null,"Sounds Volume: ")],-1)),Ni={class:"sound-volume"},Ui=["value"],ki=ke(()=>o("td",null,[o("label",null,"Show player names: ")],-1));function Ri(e,t,n,s,i,r){const l=U("overlay");return E(),ie(l,{class:"transparent"},{default:X(()=>[o("table",Ci,[o("tr",null,[Si,o("td",null,[I(o("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=a=>e.background=a)},null,512),[[ve,e.background]])])]),o("tr",null,[bi,o("td",null,[I(o("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=a=>e.color=a)},null,512),[[ve,e.color]])])]),o("tr",null,[$i,o("td",null,[I(o("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=a=>e.name=a)},null,512),[[ve,e.name]])])]),o("tr",null,[Ai,o("td",null,[I(o("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=a=>e.soundsEnabled=a)},null,512),[[cn,e.soundsEnabled]])])]),o("tr",null,[Oi,o("td",Ni,[o("span",{onClick:t[4]||(t[4]=(...a)=>e.decreaseVolume&&e.decreaseVolume(...a))},"\u{1F509}"),o("input",{type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[5]||(t[5]=(...a)=>e.updateVolume&&e.updateVolume(...a))},null,40,Ui),o("span",{onClick:t[6]||(t[6]=(...a)=>e.increaseVolume&&e.increaseVolume(...a))},"\u{1F50A}")])]),o("tr",null,[ki,o("td",null,[I(o("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=a=>e.showPlayerNames=a)},null,512),[[cn,e.showPlayerNames]])])])])]),_:1})}var Tt=H(Ti,[["render",Ri],["__scopeId","data-v-39db9680"]]);const Vi=Z({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),zi={class:"preview"};function Li(e,t,n,s,i,r){const l=U("overlay");return E(),ie(l,{class:"preview-overlay",animate:!1},{default:X(()=>[o("div",zi,[o("div",{class:"img",style:Ne(e.previewStyle)},null,4)])]),_:1})}var Ct=H(Vi,[["render",Li]]);const Mi=Z({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case _e.ANY:return["Any","Score when pieces are connected to each other or on final location"];case _e.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ue.FLAT:return["Flat","All pieces flat on all sides"];case Ue.ANY:return["Any","Flat pieces can occur anywhere"];case Ue.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case Pe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case Pe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),Di={class:"help"},Fi=o("tr",null,[o("td",{colspan:"2"},"Info about this puzzle")],-1),Gi=o("td",null,"Image Title: ",-1),Ii=o("td",null,"Scoring: ",-1),Bi=["title"],xi=o("td",null,"Shapes: ",-1),Yi=["title"],Wi=o("td",null,"Snapping: ",-1),Hi=["title"];function ji(e,t,n,s,i,r){const l=U("overlay");return E(),ie(l,{class:"transparent"},{default:X(()=>[o("table",Di,[Fi,o("tr",null,[Gi,o("td",null,Y(e.game.puzzle.info.image.title),1)]),o("tr",null,[Ii,o("td",null,[o("span",{title:e.snapMode[1]},Y(e.scoreMode[0]),9,Bi)])]),o("tr",null,[xi,o("td",null,[o("span",{title:e.snapMode[1]},Y(e.shapeMode[0]),9,Yi)])]),o("tr",null,[Wi,o("td",null,[o("span",{title:e.snapMode[1]},Y(e.snapMode[0]),9,Hi)])])])]),_:1})}var St=H(Mi,[["render",ji]]);const Zi=1,Ki=4,qi=2,Qi=3,Xi=1,Ji=2,el=4,tl=3,nl=1,ol=2,sl=3,il=4,ll=5,rl=6,al=7,ul=8,cl=9,dl=10,pl=11,hl=12,gl=13,fl=14,ml=15,_l=16,yl=17,El=18,vl=19,wl=20,Pl=21,Tl=1,Cl=2,Sl=3;var d={EV_SERVER_EVENT:Zi,EV_SERVER_INIT:Ki,EV_CLIENT_EVENT:qi,EV_CLIENT_INIT:Qi,LOG_HEADER:Xi,LOG_ADD_PLAYER:Ji,LOG_UPDATE_PLAYER:el,LOG_HANDLE_INPUT:tl,INPUT_EV_MOVE:cl,INPUT_EV_MOUSE_DOWN:nl,INPUT_EV_MOUSE_UP:ol,INPUT_EV_MOUSE_MOVE:sl,INPUT_EV_ZOOM_IN:il,INPUT_EV_ZOOM_OUT:ll,INPUT_EV_BG_COLOR:rl,INPUT_EV_PLAYER_COLOR:al,INPUT_EV_PLAYER_NAME:ul,INPUT_EV_TOGGLE_PREVIEW:dl,INPUT_EV_TOGGLE_SOUNDS:pl,INPUT_EV_REPLAY_TOGGLE_PAUSE:hl,INPUT_EV_REPLAY_SPEED_UP:gl,INPUT_EV_REPLAY_SPEED_DOWN:fl,INPUT_EV_TOGGLE_PLAYER_NAMES:ml,INPUT_EV_CENTER_FIT_PUZZLE:_l,INPUT_EV_TOGGLE_FIXED_PIECES:yl,INPUT_EV_TOGGLE_LOOSE_PIECES:El,INPUT_EV_STORE_POS:vl,INPUT_EV_RESTORE_POS:wl,INPUT_EV_CONNECTION_CLOSE:Pl,CHANGE_DATA:Tl,CHANGE_TILE:Cl,CHANGE_PLAYER:Sl};const bl=gt("Communication.js"),$l=1001,bt=4e3,Pn=0,$t=1,At=2,Tn=3,Cn=4;let ye,Ot=[],Nt=e=>{Ot.push(e)},Ut=[],kt=e=>{Ut.push(e)};function Al(e){Nt=e;for(const t of Ot)Nt(t);Ot=[]}function Ol(e){kt=e;for(const t of Ut)kt(t);Ut=[]}let Rt=Pn;const Ge=e=>{Rt!==e&&(Rt=e,kt(e))};function Sn(e){if(Rt===At)try{ye.send(JSON.stringify(e))}catch{bl.info("unable to send message.. maybe because ws is invalid?")}}let Re,Ve;function Nl(e,t,n){return Re=0,Ve={},Ge(Tn),new Promise(s=>{ye=new WebSocket(e,n+"|"+t),ye.onopen=()=>{Ge(At),Sn([d.EV_CLIENT_INIT])},ye.onmessage=i=>{const r=JSON.parse(i.data),l=r[0];if(l===d.EV_SERVER_INIT){const a=r[1];s(a)}else if(l===d.EV_SERVER_EVENT){const a=r[1],m=r[2];if(a===n&&Ve[m]){delete Ve[m];return}Nt(r)}else throw`[ 2021-05-09 invalid connect msgType ${l} ]`},ye.onerror=()=>{throw Ge($t),"[ 2021-05-15 onerror ]"},ye.onclose=i=>{i.code===bt||i.code===$l?Ge(Cn):Ge($t)}})}async function Ul(e,t){const n={gameId:e,offset:t};return await(await re.get(`/api/replay-data${F.asQueryArgs(n)}`,{})).json()}function kl(){ye&&ye.close(bt),Re=0,Ve={}}function Rl(e){Re++,Ve[Re]=e,Sn([d.EV_CLIENT_EVENT,Re,Ve[Re]])}var Ee={connect:Nl,requestReplayData:Ul,disconnect:kl,sendClientEvent:Rl,onServerChange:Al,onConnectionStateChange:Ol,CODE_CUSTOM_DISCONNECT:bt,CONN_STATE_NOT_CONNECTED:Pn,CONN_STATE_DISCONNECTED:$t,CONN_STATE_CLOSED:Cn,CONN_STATE_CONNECTED:At,CONN_STATE_CONNECTING:Tn};const Vl=Z({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Ee.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Ee.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),zl={key:0},Ll={key:2};function Ml(e,t,n,s,i,r){const l=U("overlay");return I((E(),ie(l,{class:"connection-lost"},{default:X(()=>[e.lostConnection?(E(),S("div",zl,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):ee("",!0),e.lostConnection?(E(),S("span",{key:1,class:"btn",onClick:t[0]||(t[0]=a=>e.$emit("reconnect"))},"Reconnect")):ee("",!0),e.connecting?(E(),S("div",Ll,"Connecting...")):ee("",!0)]),_:1},512)),[[oe,e.show]])}var bn=H(Vl,[["render",Ml]]);const Dl=Z({}),Fl=o("table",{class:"help"},[o("tr",null,[o("td",null,"\u2B06\uFE0F Move up:"),o("td",null,[o("div",null,[o("kbd",null,"W"),M("/"),o("kbd",null,"\u2191"),M("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B07\uFE0F Move down:"),o("td",null,[o("div",null,[o("kbd",null,"S"),M("/"),o("kbd",null,"\u2193"),M("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B05\uFE0F Move left:"),o("td",null,[o("div",null,[o("kbd",null,"A"),M("/"),o("kbd",null,"\u2190"),M("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u27A1\uFE0F Move right:"),o("td",null,[o("div",null,[o("kbd",null,"D"),M("/"),o("kbd",null,"\u2192"),M("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td"),o("td",null,[o("div",null,[M("Move faster by holding "),o("kbd",null,"Shift")])])]),o("tr",null,[o("td",null,"\u{1F50D}+ Zoom in:"),o("td",null,[o("div",null,[o("kbd",null,"E"),M("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F50D}- Zoom out:"),o("td",null,[o("div",null,[o("kbd",null,"Q"),M("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),o("td",null,[o("div",null,[o("kbd",null,"Space")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Center puzzle in screen:"),o("td",null,[o("div",null,[o("kbd",null,"C")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),o("td",null,[o("div",null,[o("kbd",null,"F")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),o("td",null,[o("div",null,[o("kbd",null,"G")])])]),o("tr",null,[o("td",null,"\u{1F464} Toggle player names:"),o("td",null,[o("div",null,[o("kbd",null,"N")])])]),o("tr",null,[o("td",null,"\u{1F509} Toggle sounds:"),o("td",null,[o("div",null,[o("kbd",null,"M")])])]),o("tr",null,[o("td",null,"\u23EB Speed up (replay):"),o("td",null,[o("div",null,[o("kbd",null,"I")])])]),o("tr",null,[o("td",null,"\u23EC Speed down (replay):"),o("td",null,[o("div",null,[o("kbd",null,"O")])])]),o("tr",null,[o("td",null,"\u23F8\uFE0F Pause (replay):"),o("td",null,[o("div",null,[o("kbd",null,"P")])])])],-1);function Gl(e,t,n,s,i,r){const l=U("overlay");return E(),ie(l,{class:"transparent"},{default:X(()=>[Fl]),_:1})}var Vt=H(Dl,[["render",Gl]]),Il="/assets/click.bb97cb07.mp3",Bl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Il}),xl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",Yl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:xl}),Wl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",Hl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Wl}),jl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Zl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:jl}),Kl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",ql=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Kl});const Ql=e=>{let t=!1;const n=()=>{t=!0},s=e.fps||60,i=e.slow||1,r=e.update,l=e.render,a=window.requestAnimationFrame,m=1/s,P=i*m;let N,$=0,v=window.performance.now();const A=()=>{for(N=window.performance.now(),$=$+Math.min(1,(N-v)/1e3);$>P;)$=$-P,r(m);l($/i),v=N,t||a(A)};return a(A),{stop:n}},Xl=.1,Jl=6,er=.05;function tr(){let e=0,t=0,n=1;const s=()=>({x:e,y:t,curZoom:n}),i=h=>{e=h.x,t=h.y,n=h.curZoom},r=()=>{e=0,t=0,n=1},l=(h,p)=>{e+=h/n,t+=p/n},a=h=>{const p=h==="in"?1:-1,V=n+er*n*p;return Math.min(Math.max(V,Xl),Jl)},m=h=>n!=a(h),P=(h,p)=>{if(n==h)return!1;const V=1-n/h;return l(-p.x*V,-p.y*V),n=h,!0},N=(h,p)=>P(a(h),p),$=h=>{const{x:p,y:V}=v(h);return{x:Math.round(p),y:Math.round(V)}},v=h=>({x:h.x/n-e,y:h.y/n-t}),A=h=>{const{x:p,y:V}=_(h);return{x:Math.round(p),y:Math.round(V)}},_=h=>({x:(h.x+e)*n,y:(h.y+t)*n}),f=h=>{const{w:p,h:V}=R(h);return{w:Math.round(p),h:Math.round(V)}},R=h=>({w:h.w*n,h:h.h*n}),w=h=>{const{w:p,h:V}=y(h);return{w:Math.round(p),h:Math.round(V)}},y=h=>({w:h.w/n,h:h.h/n});return{getCurrentZoom:()=>n,reset:r,move:l,canZoom:m,zoom:N,setZoom:P,worldToViewport:A,worldToViewportRaw:_,worldDimToViewport:f,worldDimToViewportRaw:R,viewportToWorld:$,viewportToWorldRaw:v,viewportDimToWorld:w,viewportDimToWorldRaw:y,snapshot:s,fromSnapshot:i}}function zt(e=0,t=0){const n=document.createElement("canvas");return n.width=e,n.height=t,n}async function nr(e){return new Promise(t=>{const n=new Image;n.onload=()=>{createImageBitmap(n).then(t)},n.src=e})}async function or(e,t,n){const s=zt(t,n);return s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,n),await createImageBitmap(s)}function sr(e,t,n){const s=zt(e.width,e.height),i=s.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=n,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),s}var ae={createCanvas:zt,loadImageToBitmap:nr,resizeBitmap:or,colorizedCanvas:sr};const ir=gt("Debug.js");let Lt=0,$n=0;const lr=e=>{Lt=performance.now(),$n=e},rr=e=>{const t=performance.now(),n=t-Lt;n>$n&&ir.log(e+": "+n),Lt=t};var Te={checkpoint_start:lr,checkpoint:rr};function ar(e,t){return{x:e.x-t.x,y:e.y-t.y}}function ur(e,t){return{x:e.x+t.x,y:e.y+t.y}}function An(e,t){const n=e.x-t.x,s=e.y-t.y;return Math.sqrt(n*n+s*s)}function cr(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Mt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function dr(e,t,n){return{x:e.x+t,y:e.y+n,w:e.w,h:e.h}}function pr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function hr(e,t){return An(Mt(e),Mt(t))}var W={pointSub:ar,pointAdd:ur,pointDistance:An,pointInBounds:cr,rectCenter:Mt,rectMoved:dr,rectCenterDistance:hr,rectsOverlap:pr};const On=gt("PuzzleGraphics.js");async function gr(e,t,n){On.log("start createPuzzleTileBitmaps");const s=n.tileSize,i=n.tileMarginWidth,r=n.tileDrawSize,l=s/100,a=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],m=new Array(t.length),P={};function N(f){const R=`${f.top}${f.right}${f.left}${f.bottom}`;if(P[R])return P[R];const w=new Path2D,y={x:i,y:i},h=W.pointAdd(y,{x:s,y:0}),p=W.pointAdd(h,{x:0,y:s}),V=W.pointSub(p,{x:s,y:0});if(w.moveTo(y.x,y.y),f.top!==0)for(let u=0;u<a.length/6;u++){const T=W.pointAdd(y,{x:a[u*6+0]*l,y:f.top*a[u*6+1]*l}),z=W.pointAdd(y,{x:a[u*6+2]*l,y:f.top*a[u*6+3]*l}),O=W.pointAdd(y,{x:a[u*6+4]*l,y:f.top*a[u*6+5]*l});w.bezierCurveTo(T.x,T.y,z.x,z.y,O.x,O.y)}else w.lineTo(h.x,h.y);if(f.right!==0)for(let u=0;u<a.length/6;u++){const T=W.pointAdd(h,{x:-f.right*a[u*6+1]*l,y:a[u*6+0]*l}),z=W.pointAdd(h,{x:-f.right*a[u*6+3]*l,y:a[u*6+2]*l}),O=W.pointAdd(h,{x:-f.right*a[u*6+5]*l,y:a[u*6+4]*l});w.bezierCurveTo(T.x,T.y,z.x,z.y,O.x,O.y)}else w.lineTo(p.x,p.y);if(f.bottom!==0)for(let u=0;u<a.length/6;u++){const T=W.pointSub(p,{x:a[u*6+0]*l,y:f.bottom*a[u*6+1]*l}),z=W.pointSub(p,{x:a[u*6+2]*l,y:f.bottom*a[u*6+3]*l}),O=W.pointSub(p,{x:a[u*6+4]*l,y:f.bottom*a[u*6+5]*l});w.bezierCurveTo(T.x,T.y,z.x,z.y,O.x,O.y)}else w.lineTo(V.x,V.y);if(f.left!==0)for(let u=0;u<a.length/6;u++){const T=W.pointSub(V,{x:-f.left*a[u*6+1]*l,y:a[u*6+0]*l}),z=W.pointSub(V,{x:-f.left*a[u*6+3]*l,y:a[u*6+2]*l}),O=W.pointSub(V,{x:-f.left*a[u*6+5]*l,y:a[u*6+4]*l});w.bezierCurveTo(T.x,T.y,z.x,z.y,O.x,O.y)}else w.lineTo(y.x,y.y);return P[R]=w,w}const $=ae.createCanvas(r,r),v=$.getContext("2d"),A=ae.createCanvas(r,r),_=A.getContext("2d");for(const f of t){const R=F.decodePiece(f),w=fr(n,R.idx),y=N(F.decodeShape(n.shapes[R.idx]));v.clearRect(0,0,r,r),v.save(),v.lineWidth=2,v.stroke(y),v.globalCompositeOperation="source-in",v.drawImage(e,w.x-i,w.y-i,r,r,0,0,r,r),v.restore(),v.save(),v.globalCompositeOperation="source-in",v.globalAlpha=.2,v.fillStyle="black",v.fillRect(0,0,$.width,$.height),v.restore(),v.save(),v.clip(y),v.drawImage(e,w.x-i,w.y-i,r,r,0,0,r,r),v.restore(),v.save(),v.clip(y),v.strokeStyle="rgba(0,0,0,.4)",v.lineWidth=0,v.shadowColor="black",v.shadowBlur=2,v.shadowOffsetX=-1,v.shadowOffsetY=-1,v.stroke(y),v.restore(),v.save(),v.clip(y),v.strokeStyle="rgba(255,255,255,.4)",v.lineWidth=0,v.shadowColor="white",v.shadowBlur=2,v.shadowOffsetX=1,v.shadowOffsetY=1,v.stroke(y),v.restore(),_.clearRect(0,0,r,r),_.save(),_.lineWidth=1,_.stroke(y),_.globalCompositeOperation="source-in",_.drawImage(e,w.x-i,w.y-i,r,r,0,0,r,r),_.restore(),v.drawImage(A,0,0),m[R.idx]=await createImageBitmap($)}return On.log("end createPuzzleTileBitmaps"),m}function fr(e,t){const n=F.coordByPieceIdx(e,t);return{x:n.x*e.tileSize,y:n.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function mr(e){const t=await ae.loadImageToBitmap(e.info.imageUrl),n=await ae.resizeBitmap(t,e.info.width,e.info.height);return await gr(n,e.tiles,e.info)}var _r={loadPuzzleBitmaps:mr};const Nn=30,C={};function yr(e){return!!C[e]||!1}function Er(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function vr(e,t){C[e]=t}function Je(e,t){let n=0;for(const s of C[e].players){if(F.decodePlayer(s).id===t)return n;n++}return-1}function wr(e,t){return C[e].players.length>t?F.decodePlayer(C[e].players[t]).id:null}function Ce(e,t){const n=Je(e,t);return n===-1?null:F.decodePlayer(C[e].players[n])}function Dt(e,t,n){const s=Je(e,t);s===-1?C[e].players.push(F.encodePlayer(n)):C[e].players[s]=F.encodePlayer(n)}function Pr(e,t,n){C[e].puzzle.tiles[t]=F.encodePiece(n)}function Tr(e,t){C[e].puzzle.data=t}function Un(e,t){return Je(e,t)!==-1}function Cr(e,t){const n=t-Nn*he.SEC;return kn(e).filter(s=>s.ts>=n)}function Sr(e,t){const n=t-Nn*he.SEC;return kn(e).filter(s=>s.ts<n&&s.points>0)}function br(e,t,n){Un(e,t)?Q(e,t,{ts:n}):Dt(e,t,Er(t,n))}function $r(e,t){return t in C[e].evtInfos?C[e].evtInfos[t]:{_last_mouse:null,_last_mouse_down:null}}function Ar(e,t,n){C[e].evtInfos[t]=n}function Or(){return Object.values(C).sort((e,t)=>{const n=Vn(e.id);return n===Vn(t.id)?n?t.puzzle.data.finished-e.puzzle.data.finished:t.puzzle.data.started-e.puzzle.data.started:n?1:-1})}function kn(e){return C[e]?C[e].players.map(F.decodePlayer):[]}function Nr(e){return C[e]||null}function et(e){return C[e].puzzle.tiles.length}function Ur(e){var n;const t=((n=C[e].puzzle.info.image)==null?void 0:n.url)||C[e].puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Ft(e){return C[e].scoreMode}function Rn(e){return C[e].snapMode}function Vn(e){return tt(e)===et(e)}function tt(e){let t=0;for(const n of C[e].puzzle.tiles)F.decodePiece(n).owner===-1&&t++;return t}function kr(e){return C[e].puzzle.tiles.map(F.decodePiece).sort((n,s)=>n.z-s.z)}function Q(e,t,n){const s=Ce(e,t);if(s!==null){for(const i of Object.keys(n))s[i]=n[i];Dt(e,t,s)}}function nt(e,t){for(const n of Object.keys(t))C[e].puzzle.data[n]=t[n]}function Se(e,t,n){for(const s of Object.keys(n)){const i=F.decodePiece(C[e].puzzle.tiles[t]);i[s]=n[s],C[e].puzzle.tiles[t]=F.encodePiece(i)}}const be=(e,t)=>F.decodePiece(C[e].puzzle.tiles[t]),ot=(e,t)=>be(e,t).group,Rr=(e,t)=>{const n=C[e].puzzle.info;return t===0||t===n.tilesX-1||t===n.tiles-n.tilesX||t===n.tiles-1},zn=(e,t)=>{const n=C[e].puzzle.info,s={x:(n.table.width-n.width)/2,y:(n.table.height-n.height)/2},i=Br(e,t);return W.pointAdd(s,i)},st=(e,t)=>be(e,t).pos,Gt=e=>{const t=Bn(e),n=xn(e),s=Math.round(t/4),i=Math.round(n/4);return{x:0-s,y:0-i,w:t+2*s,h:n+2*i}},Vr=(e,t)=>{const n=Dr(e),s=be(e,t);return{x:s.pos.x,y:s.pos.y,w:n,h:n}},zr=(e,t)=>be(e,t).z,it=(e,t)=>{for(const n of C[e].puzzle.tiles){const s=F.decodePiece(n);if(s.owner===t)return s.idx}return-1},Lr=(e,t)=>{const n=it(e,t);return n<0?null:C[e].puzzle.tiles[n]},Mr=e=>C[e].puzzle.info.tileDrawOffset,Ln=e=>C[e].puzzle.info.tileDrawSize,Dr=e=>C[e].puzzle.info.tileSize,Fr=e=>C[e].puzzle.data.started,Gr=e=>C[e].puzzle.data.finished,Mn=e=>C[e].puzzle.data.maxGroup,Dn=e=>C[e].puzzle.data.maxZ,Ir=(e,t)=>{let n=0;for(const s of t){const i=zr(e,s);i>n&&(n=i)}return n};function Br(e,t){const n=C[e].puzzle.info,s=F.coordByPieceIdx(n,t),i=s.x*n.tileSize,r=s.y*n.tileSize;return{x:i,y:r}}function xr(e,t){const n=C[e].puzzle.info,s=F.coordByPieceIdx(n,t);return[s.y>0?t-n.tilesX:-1,s.x<n.tilesX-1?t+1:-1,s.y<n.tilesY-1?t+n.tilesX:-1,s.x>0?t-1:-1]}const Fn=(e,t,n)=>{for(const s of t)Se(e,s,{z:n})},Yr=(e,t,n)=>{const s=st(e,t),i=W.pointAdd(s,n);Se(e,t,{pos:i})},It=(e,t,n)=>{const s=Ln(e),i=Gt(e),r=n;for(const l of t){const a=be(e,l);a.pos.x+n.x<i.x?r.x=Math.max(i.x-a.pos.x,r.x):a.pos.x+s+n.x>i.x+i.w&&(r.x=Math.min(i.x+i.w-a.pos.x+s,r.x)),a.pos.y+n.y<i.y?r.y=Math.max(i.y-a.pos.y,r.y):a.pos.y+s+n.y>i.y+i.h&&(r.y=Math.min(i.y+i.h-a.pos.y+s,r.y))}for(const l of t)Yr(e,l,r)},Wr=(e,t)=>Hr(e,t)===-1,Hr=(e,t)=>be(e,t).owner,Gn=(e,t)=>{for(const n of t)Se(e,n,{owner:-1,z:1})},Bt=(e,t,n)=>{for(const s of t)Se(e,s,{owner:n})};function $e(e,t){const n=C[e].puzzle.tiles,s=F.decodePiece(n[t]),i=[];if(s.group)for(const r of n){const l=F.decodePiece(r);l.group===s.group&&i.push(l.idx)}else i.push(s.idx);return i}const jr=(e,t)=>{const n=C[e].puzzle.info,s=C[e].puzzle.tiles;let i=-1,r=-1;for(let l=0;l<s.length;l++){const a=F.decodePiece(s[l]);if(a.owner!==0)continue;const m={x:a.pos.x,y:a.pos.y,w:n.tileSize,h:n.tileSize};W.pointInBounds(t,m)&&(i===-1||a.z>i)&&(i=a.z,r=l)}return r},Zr=(e,t)=>{const n=Ce(e,t);return n?n.bgcolor:null},Kr=(e,t)=>{const n=Ce(e,t);return n?n.color:null},qr=(e,t)=>{const n=Ce(e,t);return n?n.name:null},In=(e,t)=>{const n=Ce(e,t);return n?n.points:0},Qr=(e,t,n)=>{const s=ot(e,t),i=ot(e,n);return!!(s&&s===i)},Bn=e=>C[e].puzzle.info.table.width,xn=e=>C[e].puzzle.info.table.height,Xr=e=>C[e].puzzle,Jr=e=>C[e].rng.obj,ea=e=>C[e].puzzle.info.width,ta=e=>C[e].puzzle.info.height;function na(e,t,n,s,i){const r=C[e].puzzle,l=$r(e,t),a=[],m=()=>{a.push([d.CHANGE_DATA,r.data])},P=_=>{a.push([d.CHANGE_TILE,F.encodePiece(be(e,_))])},N=_=>{for(const f of _)P(f)},$=()=>{const _=Ce(e,t);!_||a.push([d.CHANGE_PLAYER,F.encodePlayer(_)])},v=(_,f,R)=>{const w=C[_].puzzle.tiles,y=ot(_,f),h=ot(_,R);let p;const V=[];if(y&&V.push(y),h&&V.push(h),y)p=y;else if(h)p=h;else{const u=Mn(_)+1;nt(_,{maxGroup:u}),m(),p=Mn(_)}if(Se(_,f,{group:p}),P(f),Se(_,R,{group:p}),P(R),V.length>0)for(const u of w){const T=F.decodePiece(u);V.includes(T.group)&&(Se(_,T.idx,{group:p}),P(T.idx))}},A=n[0];if(A===d.INPUT_EV_CONNECTION_CLOSE){const _=it(e,t);if(_>=0){const f=$e(e,_);Bt(e,f,0),N(f)}}else if(A===d.INPUT_EV_BG_COLOR){const _=n[1];Q(e,t,{bgcolor:_,ts:s}),$()}else if(A===d.INPUT_EV_PLAYER_COLOR){const _=n[1];Q(e,t,{color:_,ts:s}),$()}else if(A===d.INPUT_EV_PLAYER_NAME){const _=`${n[1]}`.substr(0,16);Q(e,t,{name:_,ts:s}),$()}else if(A===d.INPUT_EV_MOVE){const _=n[1],f=n[2],R=Ce(e,t);if(R){const w=R.x-_,y=R.y-f;Q(e,t,{ts:s,x:w,y}),$()}}else if(A===d.INPUT_EV_MOUSE_DOWN){const _=n[1],f=n[2],R={x:_,y:f};Q(e,t,{d:1,ts:s}),$(),l._last_mouse_down=R;const w=jr(e,R);if(w>=0){const y=Dn(e)+1;nt(e,{maxZ:y}),m();const h=$e(e,w);Fn(e,h,Dn(e)),Bt(e,h,t),N(h)}l._last_mouse=R}else if(A===d.INPUT_EV_MOUSE_MOVE){const _=n[1],f=n[2],R={x:_,y:f};if(l._last_mouse_down===null)Q(e,t,{x:_,y:f,ts:s}),$();else{const w=it(e,t);if(w>=0){Q(e,t,{x:_,y:f,ts:s}),$();const y=$e(e,w);let h=W.pointInBounds(R,Gt(e))&&W.pointInBounds(l._last_mouse_down,Gt(e));for(const p of y){const V=Vr(e,p);if(W.pointInBounds(R,V)){h=!0;break}}if(h){const p=_-l._last_mouse_down.x,V=f-l._last_mouse_down.y;It(e,y,{x:p,y:V}),N(y)}}else Q(e,t,{ts:s}),$();l._last_mouse_down=R}l._last_mouse=R}else if(A===d.INPUT_EV_MOUSE_UP){const _=n[1],f=n[2],R={x:_,y:f},w=0;l._last_mouse_down=null;const y=it(e,t);if(y>=0){const h=$e(e,y);Bt(e,h,0),N(h);const p=st(e,y),V=zn(e,y);let u=!1;if(Rn(e)===Pe.REAL){for(const T of h)if(Rr(e,T)){u=!0;break}}else u=!0;if(u&&W.pointDistance(V,p)<r.info.snapDistance){const T=W.pointSub(V,p);It(e,h,T),Gn(e,h),N(h);let z=In(e,t);Ft(e)===_e.FINAL?z+=h.length:Ft(e)===_e.ANY&&(z+=1),Q(e,t,{d:w,ts:s,points:z}),$(),tt(e)===et(e)&&(nt(e,{finished:s}),m()),i&&i(t)}else{const T=(O,te,ge,ze)=>{const Ae=C[O].puzzle.info;if(ge<0||Qr(O,te,ge))return!1;const Ye=st(O,te),Le=W.pointAdd(st(O,ge),{x:ze[0]*Ae.tileSize,y:ze[1]*Ae.tileSize});if(W.pointDistance(Ye,Le)<Ae.snapDistance){const rt=W.pointSub(Le,Ye);let fe=$e(O,te);if(It(O,fe,rt),v(O,te,ge),fe=$e(O,te),Wr(O,ge))Gn(O,fe);else{const Me=Ir(O,fe);Fn(O,fe,Me)}return N(fe),!0}return!1};let z=!1;for(const O of $e(e,y)){const te=xr(e,O);if(T(e,O,te[0],[0,1])||T(e,O,te[1],[-1,0])||T(e,O,te[2],[0,-1])||T(e,O,te[3],[1,0])){z=!0;break}}if(z&&Ft(e)===_e.ANY){const O=In(e,t)+1;Q(e,t,{d:w,ts:s,points:O}),$()}else Q(e,t,{d:w,ts:s}),$();z&&Rn(e)===Pe.REAL&&tt(e)===et(e)&&(nt(e,{finished:s}),m()),z&&i&&i(t)}}else Q(e,t,{d:w,ts:s}),$();l._last_mouse=R}else if(A===d.INPUT_EV_ZOOM_IN){const _=n[1],f=n[2];Q(e,t,{x:_,y:f,ts:s}),$(),l._last_mouse={x:_,y:f}}else if(A===d.INPUT_EV_ZOOM_OUT){const _=n[1],f=n[2];Q(e,t,{x:_,y:f,ts:s}),$(),l._last_mouse={x:_,y:f}}else Q(e,t,{ts:s}),$();return Ar(e,t,l),a}var k={setGame:vr,exists:yr,playerExists:Un,getActivePlayers:Cr,getIdlePlayers:Sr,addPlayer:br,getFinishedPiecesCount:tt,getPieceCount:et,getImageUrl:Ur,get:Nr,getAllGames:Or,getPlayerBgColor:Zr,getPlayerColor:Kr,getPlayerName:qr,getPlayerIndexById:Je,getPlayerIdByIndex:wr,changePlayer:Q,setPlayer:Dt,setPiece:Pr,setPuzzleData:Tr,getTableWidth:Bn,getTableHeight:xn,getPuzzle:Xr,getRng:Jr,getPuzzleWidth:ea,getPuzzleHeight:ta,getPiecesSortedByZIndex:kr,getFirstOwnedPiece:Lr,getPieceDrawOffset:Mr,getPieceDrawSize:Ln,getFinalPiecePos:zn,getStartTs:Fr,getFinishTs:Gr,handleInput:na};let Yn=-10,Wn=20,xt=2,Hn=15;const oa=5,sa=5,Yt=1,ia=200,jn=10,la=100,ra=10,aa=1,ua=5;function ca(e){const t=e.random(0,255),n=e.random(0,255),s=e.random(0,255);return"rgba("+t+","+n+","+s+", 0.8)"}class Zn{constructor(t){this.radius=jn,this.previousRadius=jn,this.explodingDuration=la,this.hasExploded=!1,this.alive=!0,this.color=ca(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Yn+Math.random()*Wn,this.vy=(xt+Math.random()*Hn)*-1,this.duration=0}update(t){if(this.hasExploded){const n=ia-this.radius;this.previousRadius=this.radius,this.radius+=n/ra,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=Yt,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const n=3+Math.floor(Math.random()*3);for(let s=0;s<n;s++){const i=10+Math.floor(Math.random()*21),r=oa+Math.random()*sa,l=2*Math.PI/i,a=Math.random()*l;for(let m=0;m<i;m++)t.push(new da(this,m*l+a,r))}}}class da{constructor(t,n,s){this.px=t.px,this.py=t.py,this.vx=Math.cos(n)*s,this.vy=Math.sin(n)*s,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=Yt/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class pa{constructor(t,n){this.canvas=t,this.rng=n,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,n=0;for(;t<this.canvas.height&&n>=0;)n+=Yt,t+=n;xt=n/2,Hn=n-xt;const s=1/4*this.canvas.width/(n/2);Yn=-s,Wn=2*s}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<aa;t++)this.readyBombs.push(new Zn(this.rng))}update(){Math.random()*100<ua&&this.readyBombs.push(new Zn(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const n=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):n.push(i)}this.readyBombs=n;const s=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&s.push(i)}this.particles=s}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function ha(e,t,n,s){let i=[],r=!0,l=!1,a=!1,m=!1,P=!1,N=!1,$=!1,v=!1;const A=(u,T)=>{const z=n.viewportToWorld({x:u,y:T});return[z.x,z.y]},_=u=>A(u.offsetX,u.offsetY),f=()=>A(e.width/2,e.height/2),R=(u,T)=>{!r||(T.code==="ShiftLeft"||T.code==="ShiftRight"?v=u:T.code==="ArrowUp"||T.code==="KeyW"?m=u:T.code==="ArrowDown"||T.code==="KeyS"?P=u:T.code==="ArrowLeft"||T.code==="KeyA"?l=u:T.code==="ArrowRight"||T.code==="KeyD"?a=u:T.code==="KeyQ"?$=u:T.code==="KeyE"&&(N=u))};let w=null;e.addEventListener("mousedown",u=>{w=_(u),u.button===0&&y([d.INPUT_EV_MOUSE_DOWN,...w])}),e.addEventListener("mouseup",u=>{w=_(u),u.button===0&&y([d.INPUT_EV_MOUSE_UP,...w])}),e.addEventListener("mousemove",u=>{w=_(u),y([d.INPUT_EV_MOUSE_MOVE,...w])}),e.addEventListener("wheel",u=>{if(w=_(u),n.canZoom(u.deltaY<0?"in":"out")){const T=u.deltaY<0?d.INPUT_EV_ZOOM_IN:d.INPUT_EV_ZOOM_OUT;y([T,...w])}}),t.addEventListener("keydown",u=>R(!0,u)),t.addEventListener("keyup",u=>R(!1,u)),t.addEventListener("keypress",u=>{if(!!r){if(s===ue&&(u.code==="KeyI"?y([d.INPUT_EV_REPLAY_SPEED_UP]):u.code==="KeyO"?y([d.INPUT_EV_REPLAY_SPEED_DOWN]):u.code==="KeyP"&&y([d.INPUT_EV_REPLAY_TOGGLE_PAUSE])),u.code==="Space")y([d.INPUT_EV_TOGGLE_PREVIEW]);else if(u.code==="KeyF")y([d.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(u.code==="KeyG")y([d.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(u.code==="KeyM")y([d.INPUT_EV_TOGGLE_SOUNDS]);else if(u.code==="KeyN")y([d.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(u.code==="KeyC")y([d.INPUT_EV_CENTER_FIT_PUZZLE]);else if(u.code==="Digit1"){const T=u.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;y([T,1])}else if(u.code==="Digit2"){const T=u.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;y([T,2])}else if(u.code==="Digit3"){const T=u.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;y([T,3])}}});const y=u=>{i.push(u)};return{addEvent:y,consumeAll:()=>{if(i.length===0)return[];const u=i.slice();return i=[],u},createKeyEvents:()=>{const u=(l?1:0)-(a?1:0),T=(m?1:0)-(P?1:0);if(u!==0||T!==0){const z=(v?24:12)*Math.sqrt(n.getCurrentZoom()),O=n.viewportDimToWorld({w:u*z,h:T*z});y([d.INPUT_EV_MOVE,O.w,O.h]),w&&(w[0]-=O.w,w[1]-=O.h)}if(!(N&&$)){if(N){if(n.canZoom("in")){const z=w||f();y([d.INPUT_EV_ZOOM_IN,...z])}}else if($&&n.canZoom("out")){const z=w||f();y([d.INPUT_EV_ZOOM_OUT,...z])}}},setHotkeys:u=>{r=u}}}const lt={"./grab.png":Yl,"./grab_mask.png":Hl,"./hand.png":Zl,"./hand_mask.png":ql},ga={"./click.mp3":Bl},Ie="play",ue="replay";let Be=!0,xe=!0;const fa=e=>e.owner===-1?Be:xe;let j=!0;async function Kn(e,t,n,s,i,r){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const l=c=>s===ue||c.id!==t,a=ga["./click.mp3"].default,m=new Audio(a),P=await ae.loadImageToBitmap(lt["./grab.png"].default),N=await ae.loadImageToBitmap(lt["./hand.png"].default),$=await ae.loadImageToBitmap(lt["./grab_mask.png"].default),v=await ae.loadImageToBitmap(lt["./hand_mask.png"].default),A=P.width,_=Math.round(A/2),f=P.height,R=Math.round(f/2),w={},y=async c=>{const g=c.color+" "+c.d;if(!w[g]){const b=c.d?P:N;if(c.color){const B=c.d?$:v;w[g]=await createImageBitmap(ae.colorizedCanvas(b,B,c.color))}else w[g]=b}return w[g]},h=i,p={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Ee.onConnectionStateChange(c=>{r.emit("connectionState",c)});const V=async c=>{const g=p.dataOffset;p.dataOffset+=1e4;const b=await Ee.requestReplayData(c,g);return p.log=p.log.slice(p.logPointer),p.logPointer=0,p.log.push(...b.log),b.log.length===0&&(p.final=!0),b};let u=()=>0;const T=async()=>{if(s===Ie){const c=await Ee.connect(n,e,t),g=F.decodeGame(c);k.setGame(g.id,g),u=()=>he.timestamp()}else if(s===ue){const c=await V(e);if(!c.game)throw"[ 2021-05-29 no game received ]";const g=F.decodeGame(c.game);k.setGame(g.id,g),p.lastRealTs=he.timestamp(),p.gameStartTs=parseInt(c.log[0][4],10),p.lastGameTs=p.gameStartTs,u=()=>p.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";j=!0};await T();const z=k.getPieceDrawOffset(e),O=k.getPieceDrawSize(e),te=k.getPuzzleWidth(e),ge=k.getPuzzleHeight(e),ze=k.getTableWidth(e),Ae=k.getTableHeight(e),Ye={x:(ze-te)/2,y:(Ae-ge)/2},Le={w:te,h:ge},rt={w:O,h:O},fe=await _r.loadPuzzleBitmaps(k.getPuzzle(e)),Me=new pa(h,k.getRng(e));Me.init();const ce=h.getContext("2d");h.classList.add("loaded"),r.emit("puzzleCut");let Wt="";const ne={},L=tr(),Xn=()=>{L.reset(),L.move(-(ze-h.width)/2,-(Ae-h.height)/2);const c=L.worldDimToViewport(Le),g=20,b=h.width-g*2,B=h.height-g*2;if(c.w>b||c.h>B||c.w<b&&c.h<B){const D=Math.min(b/c.w,B/c.h);L.setZoom(D,{x:h.width/2,y:h.height/2})}},We=c=>{ne.last&&Wt===c?(L.fromSnapshot(ne.last),delete ne.last):ne[c]&&(ne.last=L.snapshot(),Wt=c,L.fromSnapshot(ne[c]))};Xn(),ne.center=L.snapshot();const Oe=ha(h,window,L,s),Jn=k.getImageUrl(e),He=c=>{const g=k.getStartTs(e),b=k.getFinishTs(e);r.emit("status",{finished:!!b,duration:(b||c)-g,piecesDone:k.getFinishedPiecesCount(e),piecesTotal:k.getPieceCount(e)}),r.emit("players",{active:k.getActivePlayers(e,c),idle:k.getIdlePlayers(e,c)})};He(u());const Ht=!!k.getFinishTs(e);let at=Ht;const jt=()=>at&&!Ht,Zt=()=>q.getInt(J.SOUND_VOLUME,pe.SOUND_VOLUME),Kt=()=>q.getBool(J.SOUND_ENABLED,pe.SOUND_ENABLED),qt=()=>q.getBool(J.SHOW_PLAYER_NAMES,pe.SHOW_PLAYER_NAMES),Qt=()=>{const c=Zt();m.volume=c/100,m.play()},Xt=()=>s===ue?q.getStr(J.COLOR_BACKGROUND,pe.COLOR_BACKGROUND):k.getPlayerBgColor(e,t)||q.getStr(J.COLOR_BACKGROUND,pe.COLOR_BACKGROUND),Jt=()=>s===ue?q.getStr(J.PLAYER_COLOR,pe.PLAYER_COLOR):k.getPlayerColor(e,t)||q.getStr(J.PLAYER_COLOR,pe.PLAYER_COLOR),eo=()=>s===ue?q.getStr(J.PLAYER_NAME,pe.PLAYER_NAME):k.getPlayerName(e,t)||q.getStr(J.PLAYER_NAME,pe.PLAYER_NAME);let en="",tn="",nn=!1;const De=c=>{nn=c;const[g,b]=c?[en,"grab"]:[tn,"default"];h.style.cursor=`url('${g}') ${_} ${R}, ${b}`},ut=c=>{en=ae.colorizedCanvas(P,$,c).toDataURL(),tn=ae.colorizedCanvas(N,v,c).toDataURL(),De(nn)};ut(Jt());const je=()=>{r.emit("replaySpeed",p.speeds[p.speedIdx]),r.emit("replayPaused",p.paused)},on=()=>{p.speedIdx+1<p.speeds.length&&(p.speedIdx++,je())},sn=()=>{p.speedIdx>=1&&(p.speedIdx--,je())},ln=()=>{p.paused=!p.paused,je()};r.on("replayOnSpeedUp",()=>{on()}),r.on("replayOnSpeedDown",()=>{sn()}),r.on("replayOnPauseToggle",()=>{ln()}),r.on("onBgChange",c=>{q.setStr(J.COLOR_BACKGROUND,c),Oe.addEvent([d.INPUT_EV_BG_COLOR,c])}),r.on("onColorChange",c=>{q.setStr(J.PLAYER_COLOR,c),Oe.addEvent([d.INPUT_EV_PLAYER_COLOR,c])}),r.on("onNameChange",c=>{q.setStr(J.PLAYER_NAME,c),Oe.addEvent([d.INPUT_EV_PLAYER_NAME,c])}),r.on("onSoundsEnabledChange",c=>{q.setBool(J.SOUND_ENABLED,c)}),r.on("onSoundsVolumeChange",c=>{q.setInt(J.SOUND_VOLUME,c),Qt()}),r.on("onShowPlayerNamesChange",c=>{q.setBool(J.SHOW_PLAYER_NAMES,c)}),r.on("setHotkeys",c=>{Oe.setHotkeys(c)}),r.on("requireRerender",()=>{j=!0});const rn=[];let Ze;const to=()=>{rn.forEach(c=>{clearInterval(c)}),Ze&&clearTimeout(Ze)};let ct;const no=()=>{to(),ct&&ct.stop()};if(s===Ie?rn.push(setInterval(()=>{He(u())},1e3)):s===ue&&je(),s===Ie)Ee.onServerChange(c=>{c[0],c[1],c[2];const g=c[3];for(const[b,B]of g)switch(b){case d.CHANGE_PLAYER:{const D=F.decodePlayer(B);D.id!==t&&(k.setPlayer(e,D.id,D),j=!0)}break;case d.CHANGE_TILE:{const D=F.decodePiece(B);k.setPiece(e,D.idx,D),j=!0}break;case d.CHANGE_DATA:k.setPuzzleData(e,B),j=!0;break}at=!!k.getFinishTs(e)});else if(s===ue){const c=(B,D)=>{const K=B;if(K[0]===d.LOG_ADD_PLAYER){const G=K[1];return k.addPlayer(e,G,D),!0}if(K[0]===d.LOG_UPDATE_PLAYER){const G=k.getPlayerIdByIndex(e,K[1]);if(!G)throw"[ 2021-05-17 player not found (update player) ]";return k.addPlayer(e,G,D),!0}if(K[0]===d.LOG_HANDLE_INPUT){const G=k.getPlayerIdByIndex(e,K[1]);if(!G)throw"[ 2021-05-17 player not found (handle input) ]";const de=K[2];return k.handleInput(e,G,de,D),!0}return!1};let g=p.lastGameTs;const b=async()=>{p.logPointer+1>=p.log.length&&await V(e);const B=he.timestamp();if(p.paused){p.lastRealTs=B,Ze=setTimeout(b,50);return}const K=(B-p.lastRealTs)*p.speeds[p.speedIdx];let G=p.lastGameTs+K;do{if(p.paused)break;const de=p.logPointer+1;if(de>=p.log.length)break;const Ke=p.log[p.logPointer],an=g+Ke[Ke.length-1],dt=p.log[de],un=dt[dt.length-1],pt=an+un;if(pt>G){G+500*he.MS<pt&&(G+=un);break}g=an,c(dt,pt)&&(j=!0),p.logPointer=de}while(!0);p.lastRealTs=B,p.lastGameTs=G,He(u()),p.final||(Ze=setTimeout(b,50))};b()}let se=null;return ct=Ql({update:()=>{Oe.createKeyEvents();for(const c of Oe.consumeAll())if(s===Ie){const g=c[0];if(g===d.INPUT_EV_MOVE){const D=c[1],K=c[2],G=L.worldDimToViewport({w:D,h:K});j=!0,L.move(G.w,G.h),delete ne.last}else if(g===d.INPUT_EV_MOUSE_MOVE){if(se&&!k.getFirstOwnedPiece(e,t)){const D={x:c[1],y:c[2]},K=L.worldToViewport(D),G=Math.round(K.x-se.x),de=Math.round(K.y-se.y);j=!0,L.move(G,de),se=K,delete ne.last}}else if(g===d.INPUT_EV_PLAYER_COLOR)ut(c[1]);else if(g===d.INPUT_EV_MOUSE_DOWN){const D={x:c[1],y:c[2]};se=L.worldToViewport(D),De(!0)}else if(g===d.INPUT_EV_MOUSE_UP)se=null,De(!1);else if(g===d.INPUT_EV_ZOOM_IN){const D={x:c[1],y:c[2]};j=!0,L.zoom("in",L.worldToViewport(D)),delete ne.last}else if(g===d.INPUT_EV_ZOOM_OUT){const D={x:c[1],y:c[2]};j=!0,L.zoom("out",L.worldToViewport(D)),delete ne.last}else if(g===d.INPUT_EV_TOGGLE_PREVIEW)r.emit("togglePreview");else if(g===d.INPUT_EV_TOGGLE_SOUNDS)r.emit("toggleSoundsEnabled");else if(g===d.INPUT_EV_TOGGLE_PLAYER_NAMES)r.emit("togglePlayerNames");else if(g===d.INPUT_EV_CENTER_FIT_PUZZLE)We("center");else if(g===d.INPUT_EV_TOGGLE_FIXED_PIECES)Be=!Be,j=!0;else if(g===d.INPUT_EV_TOGGLE_LOOSE_PIECES)xe=!xe,j=!0;else if(g===d.INPUT_EV_STORE_POS){const D=`${c[1]}`;ne[D]=L.snapshot()}else if(g===d.INPUT_EV_RESTORE_POS){const D=`${c[1]}`;We(D)}const b=u();k.handleInput(e,t,c,b,D=>{Kt()&&Qt()}).length>0&&(j=!0),Ee.sendClientEvent(c)}else if(s===ue){const g=c[0];if(g===d.INPUT_EV_REPLAY_TOGGLE_PAUSE)ln();else if(g===d.INPUT_EV_REPLAY_SPEED_DOWN)sn();else if(g===d.INPUT_EV_REPLAY_SPEED_UP)on();else if(g===d.INPUT_EV_MOVE){const b=c[1],B=c[2];j=!0,L.move(b,B)}else if(g===d.INPUT_EV_MOUSE_MOVE){if(se){const b={x:c[1],y:c[2]},B=L.worldToViewport(b),D=Math.round(B.x-se.x),K=Math.round(B.y-se.y);j=!0,L.move(D,K),se=B}}else if(g===d.INPUT_EV_PLAYER_COLOR)ut(c[1]);else if(g===d.INPUT_EV_MOUSE_DOWN){const b={x:c[1],y:c[2]};se=L.worldToViewport(b),De(!0)}else if(g===d.INPUT_EV_MOUSE_UP)se=null,De(!1);else if(g===d.INPUT_EV_ZOOM_IN){const b={x:c[1],y:c[2]};j=!0,L.zoom("in",L.worldToViewport(b))}else if(g===d.INPUT_EV_ZOOM_OUT){const b={x:c[1],y:c[2]};j=!0,L.zoom("out",L.worldToViewport(b))}else if(g===d.INPUT_EV_TOGGLE_PREVIEW)r.emit("togglePreview");else if(g===d.INPUT_EV_TOGGLE_SOUNDS)r.emit("toggleSoundsEnabled");else if(g===d.INPUT_EV_TOGGLE_PLAYER_NAMES)r.emit("togglePlayerNames");else if(g===d.INPUT_EV_CENTER_FIT_PUZZLE)We("center");else if(g===d.INPUT_EV_TOGGLE_FIXED_PIECES)Be=!Be,j=!0;else if(g===d.INPUT_EV_TOGGLE_LOOSE_PIECES)xe=!xe,j=!0;else if(g===d.INPUT_EV_STORE_POS){const b=`${c[1]}`;ne[b]=L.snapshot()}else if(g===d.INPUT_EV_RESTORE_POS){const b=`${c[1]}`;We(b)}}at=!!k.getFinishTs(e),jt()&&(Me.update(),j=!0)},render:async()=>{if(!j)return;const c=u();let g,b,B;window.DEBUG&&Te.checkpoint_start(0),ce.fillStyle=Xt(),ce.fillRect(0,0,h.width,h.height),window.DEBUG&&Te.checkpoint("clear done"),g=L.worldToViewportRaw(Ye),b=L.worldDimToViewportRaw(Le),ce.fillStyle="rgba(255, 255, 255, .3)",ce.fillRect(g.x,g.y,b.w,b.h),window.DEBUG&&Te.checkpoint("board done");const D=k.getPiecesSortedByZIndex(e);window.DEBUG&&Te.checkpoint("get tiles done"),b=L.worldDimToViewportRaw(rt);for(const G of D)!fa(G)||(B=fe[G.idx],g=L.worldToViewportRaw({x:z+G.pos.x,y:z+G.pos.y}),ce.drawImage(B,0,0,B.width,B.height,g.x,g.y,b.w,b.h));window.DEBUG&&Te.checkpoint("tiles done");const K=[];for(const G of k.getActivePlayers(e,c))l(G)&&(B=await y(G),g=L.worldToViewport(G),ce.drawImage(B,g.x-_,g.y-R),qt()&&K.push([`${G.name} (${G.points})`,g.x,g.y+f]));ce.fillStyle="white",ce.textAlign="center";for(const[G,de,Ke]of K)ce.fillText(G,de,Ke);window.DEBUG&&Te.checkpoint("players done"),He(c),window.DEBUG&&Te.checkpoint("HUD done"),jt()&&Me.render(),j=!1}}),{previewImageUrl:Jn,player:{background:Xt(),color:Jt(),name:eo(),soundsEnabled:Kt(),soundsVolume:Zt(),showPlayerNames:qt()},game:k.get(e),disconnect:Ee.disconnect,connect:T,unload:no}}const ma=Z({name:"game",components:{PuzzleStatusComponent:Pt,Scores:wt,SettingsOverlay:Tt,PreviewOverlay:Ct,InfoOverlay:St,ConnectionOverlay:bn,HelpOverlay:Vt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:dn(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)}),this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Kn(`${this.$route.params.id}`,re.clientId(),this.$config.WS_ADDRESS,Ie,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}}}),_a={id:"game"},ya=o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),Ea={class:"menu-left"},va={class:"menu"},wa={class:"tabs"},Pa=M("\u{1F9E9} Puzzles"),Ta={class:"menu-right"},Ca={ref:"canvas"};function Sa(e,t,n,s,i,r){const l=U("settings-overlay"),a=U("preview-overlay"),m=U("info-overlay"),P=U("help-overlay"),N=U("overlay"),$=U("connection-overlay"),v=U("puzzle-status"),A=U("router-link"),_=U("scores");return E(),S("div",_a,[I(x(l,{onClose:t[0]||(t[0]=f=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=f=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=f=>e.g.player=f)},null,8,["modelValue"]),[[oe,e.overlay==="settings"]]),I(x(a,{onClose:t[3]||(t[3]=f=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=f=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[oe,e.overlay==="preview"]]),e.g.game?I((E(),ie(m,{key:0,onClose:t[5]||(t[5]=f=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=f=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[oe,e.overlay==="info"]]):ee("",!0),I(x(P,{onClose:t[7]||(t[7]=f=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=f=>e.toggle("help",!0))},null,512),[[oe,e.overlay==="help"]]),I(x(N,null,{default:X(()=>[ya]),_:1},512),[[oe,e.cuttingPuzzle]]),x($,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),o("div",Ea,[x(v,{status:e.status},null,8,["status"])]),o("div",va,[o("div",wa,[x(A,{class:"opener",to:{name:"index"},target:"_blank"},{default:X(()=>[Pa]),_:1}),o("div",{class:"opener",onClick:t[9]||(t[9]=f=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[10]||(t[10]=f=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[11]||(t[11]=f=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[12]||(t[12]=f=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",Ta,[x(_,{players:e.players},null,8,["players"])]),o("canvas",Ca,null,512)])}var ba=H(ma,[["render",Sa]]);const $a=Z({name:"replay",components:{PuzzleStatusComponent:Pt,Scores:wt,SettingsOverlay:Tt,PreviewOverlay:Ct,InfoOverlay:St,HelpOverlay:Vt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:dn(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)}),this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Kn(`${this.$route.params.id}`,re.clientId(),this.$config.WS_ADDRESS,ue,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Aa={id:"replay"},Oa={key:1,class:"overlay"},Na=o("div",{class:"overlay-content"},[o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),Ua=[Na],ka={class:"menu-left"},Ra={class:"playback-control"},Va={class:"menu"},za={class:"tabs"},La=M("\u{1F9E9} Puzzles"),Ma={class:"menu-right"},Da={ref:"canvas"};function Fa(e,t,n,s,i,r){const l=U("settings-overlay"),a=U("preview-overlay"),m=U("info-overlay"),P=U("help-overlay"),N=U("puzzle-status"),$=U("router-link"),v=U("scores");return E(),S("div",Aa,[I(x(l,{onClose:t[0]||(t[0]=A=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=A=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=A=>e.g.player=A)},null,8,["modelValue"]),[[oe,e.overlay==="settings"]]),I(x(a,{onClose:t[3]||(t[3]=A=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=A=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[oe,e.overlay==="preview"]]),e.g.game?I((E(),ie(m,{key:0,onClose:t[5]||(t[5]=A=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=A=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[oe,e.overlay==="info"]]):ee("",!0),I(x(P,{onClose:t[7]||(t[7]=A=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=A=>e.toggle("help",!0))},null,512),[[oe,e.overlay==="help"]]),e.cuttingPuzzle?(E(),S("div",Oa,Ua)):ee("",!0),o("div",ka,[x(N,{status:e.status},null,8,["status"]),o("div",Ra,[o("div",null,Y(e.replayText),1),o("button",{class:"btn",onClick:t[9]||(t[9]=A=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),o("button",{class:"btn",onClick:t[10]||(t[10]=A=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),o("button",{class:"btn",onClick:t[11]||(t[11]=A=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")])]),o("div",Va,[o("div",za,[x($,{class:"opener",to:{name:"index"},target:"_blank"},{default:X(()=>[La]),_:1}),o("div",{class:"opener",onClick:t[12]||(t[12]=A=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[13]||(t[13]=A=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[14]||(t[14]=A=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[15]||(t[15]=A=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",Ma,[x(v,{players:e.players},null,8,["players"])]),o("canvas",Da,null,512)])}var Ga=H($a,[["render",Fa]]);let qn=null;async function Ia(){qn=await(await re.get("/api/me",{})).json()}var Qn={getMe:()=>qn,init:Ia};const Ba=Z({props:{image:{type:Object,required:!0}},data:()=>({me:Qn.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function xa(e,t,n,s,i,r){return E(),S("div",{class:"imageteaser",style:Ne(e.style),onClick:t[1]||(t[1]=(...l)=>e.onClick&&e.onClick(...l))},[e.canEdit?(E(),S("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=lo((...l)=>e.onEditClick&&e.onEditClick(...l),["stop"]))},"\u270F\uFE0F")):ee("",!0)],4)}var Ya=H(Ba,[["render",xa]]);const Wa=Z({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Ha={class:"overlay"};function ja(e,t,n,s,i,r){return E(),S("div",Ha,[o("div",{class:Fe(["overlay-background",e.classes.map(l=>"overlay-background-"+l)]),onClick:t[0]||(t[0]=l=>e.$emit("bgclick"))},null,2),o("div",{class:Fe(["overlay-content",e.classes.map(l=>"overlay-content-"+l)])},[ro(e.$slots,"default")],2)])}var Za=H(Wa,[["render",ja]]);const Ka={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},qa=["title"];function Qa(e,t,n,s,i,r){return E(),S("div",{style:Ne(r.style),title:n.title},null,12,qa)}var Xa=H(Ka,[["render",Qa]]);const Ja=Z({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),eu={key:0,class:"autocomplete"},tu=["onClick"],nu=["onClick"];function ou(e,t,n,s,i,r){return E(),S("div",null,[I(o("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=l=>e.input=l),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...l)=>e.onChange&&e.onChange(...l)),onKeydown:t[2]||(t[2]=ao((...l)=>e.add&&e.add(...l),["enter"])),onKeyup:t[3]||(t[3]=(...l)=>e.onKeyUp&&e.onKeyUp(...l))},null,544),[[ve,e.input]]),e.autocomplete.values?(E(),S("div",eu,[o("ul",null,[(E(!0),S(le,null,me(e.autocomplete.values,(l,a)=>(E(),S("li",{key:a,class:Fe({active:a===e.autocomplete.idx}),onClick:m=>e.addVal(l)},Y(l),11,tu))),128))])])):ee("",!0),(E(!0),S(le,null,me(e.values,(l,a)=>(E(),S("span",{key:a,class:"bit",onClick:m=>e.rm(l)},Y(l)+" \u2716",9,nu))),128))])}var su=H(Ja,[["render",ou],["__scopeId","data-v-5e1cb3f9"]]);const iu=Z({props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const n=t.files[0];if(!n)return;const s=new FormData;s.append("file",n,n.name);const r=await(await re.post("/upload",{body:s})).json();this.$emit("uploaded",r)}}}),lu=["accept"],ru={class:"btn"};function au(e,t,n,s,i,r){return E(),S("label",null,[o("input",{type:"file",style:{display:"none"},onChange:t[0]||(t[0]=(...l)=>e.upload&&e.upload(...l)),accept:e.accept},null,40,lu),o("span",ru,Y(e.label||"Upload File"),1)])}var uu=H(iu,[["render",au]]);(async()=>{re.init(),await Qn.init();const t=await(await re.get("/api/conf",{})).json(),n=uo({history:co(),routes:[{name:"index",path:"/",component:Jo},{name:"new-game",path:"/new-game",component:hi},{name:"game",path:"/g/:id",component:ba},{name:"replay",path:"/replay/:id",component:Ga}]});n.beforeEach((i,r)=>{r.name&&document.documentElement.classList.remove(`view-${String(r.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const s=po(vo);s.config.globalProperties.$config=t,s.use(n),s.component("connection-overlay",bn),s.component("edit-image-dialog",En),s.component("game-teaser",mn),s.component("help-overlay",Vt),s.component("image-library",_n),s.component("image-teaser",Ya),s.component("info-overlay",St),s.component("new-game-dialog",wn),s.component("new-image-dialog",yn),s.component("overlay",Za),s.component("preview-overlay",Ct),s.component("puzzle-status",Pt),s.component("responsive-image",Xa),s.component("scores",wt),s.component("settings-overlay",Tt),s.component("tags-input",su),s.component("upload",uu),s.mount("#app")})();
//# sourceMappingURL=index.2209a495.js.map
