import{d as H,r as N,o as _,c as v,a as s,b as z,w as X,e as J,f as R,g as re,n as be,t as F,F as ie,h as he,i as Ve,j as M,v as we,k as ve,l as ns,m as le,p as io,q as is,s as ls,u as lo,x as rs,y as as,z as us,A as cs,B as ds,C as ps}from"./vendor.0dfaad5f.js";const hs=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}};hs();var Z=(e,t)=>{const o=e.__vccOpts||e;for(const[n,i]of t)o[n]=i;return o};const gs=H({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),ms={id:"app"},fs={key:0,class:"nav"},ys=R("Games overview"),_s=R("New game");function Es(e,t,o,n,i,l){const r=N("router-link"),a=N("router-view");return _(),v("div",ms,[e.showNav?(_(),v("ul",fs,[s("li",null,[z(r,{class:"btn",to:{name:"index"}},{default:X(()=>[ys]),_:1})]),s("li",null,[z(r,{class:"btn",to:{name:"new-game"}},{default:X(()=>[_s]),_:1})])])):J("",!0),z(a)])}var ws=Z(gs,[["render",Es]]);class We{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,o){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const n=(this.rand_high>>>0)/4294967295;return t+n*(o-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const o=t.slice();for(let n=0;n<=o.length-2;n++){const i=this.random(n,o.length-1),l=o[n];o[n]=o[i],o[i]=l}return o}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const o=new We(0);return o.rand_high=t.rand_high,o.rand_low=t.rand_low,o}}const vs=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},ut=(e,t)=>{const o=`${e}`;return o.length>=t.length?o:t.substr(0,t.length-o.length)+o},ct=(...e)=>{const t=o=>(...n)=>{const i=new Date,l=ut(i.getHours(),"00"),r=ut(i.getMinutes(),"00"),a=ut(i.getSeconds(),"00");console[o](`${l}:${r}:${a}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},Ps=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function Ts(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Cs(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function Ss(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function $s(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function bs(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function As(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function Os(e){return[e.id,e.rng.type||"",We.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion]}function Ns(e){return{id:e[0],rng:{type:e[1],obj:We.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10]}}function ks(e,t){const o=e.width/e.tileSize;return{x:t%o,y:Math.floor(t/o)}}const Us=e=>{let t=0;for(let o=0;o<e.length;o++){const n=e.charCodeAt(o);t=(t<<5)-t+n,t|=0}return t};function Rs(e){const t=[];for(const o in e){const n=[o,e[o]].map(encodeURIComponent);t.push(n.join("="))}return t.length===0?"":`?${t.join("&")}`}var L={hash:Us,slug:vs,uniqId:Ps,encodeShape:Ts,decodeShape:Cs,encodePiece:Ss,decodePiece:$s,encodePlayer:bs,decodePlayer:As,encodeGame:Os,decodeGame:Ns,coordByPieceIdx:ks,asQueryArgs:Rs};const oe={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},ge={SOUND_VOLUME:100,SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},dt=(e,t)=>{localStorage.setItem(e,t)},pt=e=>localStorage.getItem(e),Vs=(e,t)=>{dt(e,`${t}`)},zs=(e,t)=>{const o=pt(e);if(o===null)return t;const n=parseInt(o,10);return isNaN(n)?t:n},Ls=(e,t)=>{dt(e,t?"1":"0")},Ms=(e,t)=>{const o=pt(e);return o===null?t:o==="1"},Ds=(e,t)=>{dt(e,t)},Fs=(e,t)=>{const o=pt(e);return o===null?t:o};var ee={setInt:Vs,getInt:zs,setBool:Ls,getBool:Ms,setStr:Ds,getStr:Fs};let ht="",ro="";const gt=async(e,t,o)=>new Promise((n,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const r in o.headers||{})l.setRequestHeader(r,o.headers[r]);l.setRequestHeader("Client-Id",ht),l.setRequestHeader("Client-Secret",ro),l.addEventListener("load",function(r){n({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(r){i(new Error("xhr error"))}),l.upload&&o.onUploadProgress&&l.upload.addEventListener("progress",function(r){o.onUploadProgress&&o.onUploadProgress(r)}),l.send(o.body||null)}),ao=e=>{let t=ee.getStr(e,"");return t||(t=L.uniqId(),ee.setStr(e,t)),t};var ae={init:()=>{ht=ao("ID"),ro=ao("SECRET")},request:gt,get:(e,t)=>gt("get",e,t),post:(e,t)=>gt("post",e,t),clientId:()=>ht};const uo=1,mt=uo*1e3,He=mt*60,je=He*60,ft=je*24,Gs=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},co=e=>{const t=Math.floor(e/ft);e=e%ft;const o=Math.floor(e/je);e=e%je;const n=Math.floor(e/He);e=e%He;const i=Math.floor(e/mt);return`${t}d ${o}h ${n}m ${i}s`},Is=(e,t)=>co(t-e);var me={MS:uo,SEC:mt,MIN:He,HOUR:je,DAY:ft,timestamp:Gs,timeDiffStr:Is,durationStr:co};const Bs=H({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const o=t?"\u{1F3C1}":"\u23F3",n=e,i=t||me.timestamp(),l=me.timeDiffStr(n,i);return`${o} ${l}`}}}),xs={class:"game-info-text"},Ys=s("br",null,null,-1),Zs=s("br",null,null,-1),Ws=s("br",null,null,-1),Hs=R(" \u21AA\uFE0F Watch replay ");function js(e,t,o,n,i,l){const r=N("router-link");return _(),v("div",{class:"game-teaser",style:be(e.style)},[z(r,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:X(()=>[s("span",xs,[R(" \u{1F9E9} "+F(e.game.tilesFinished)+"/"+F(e.game.tilesTotal),1),Ys,R(" \u{1F465} "+F(e.game.players),1),Zs,R(" "+F(e.time(e.game.started,e.game.finished)),1),Ws])]),_:1},8,["to"]),e.game.hasReplay?(_(),re(r,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:X(()=>[Hs]),_:1},8,["to"])):J("",!0)],4)}var po=Z(Bs,[["render",js]]);const Ks=H({components:{GameTeaser:po},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ae.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),qs=s("h1",null,"Running games",-1),Qs=s("h1",null,"Finished games",-1);function Xs(e,t,o,n,i,l){const r=N("game-teaser");return _(),v("div",null,[qs,(_(!0),v(ie,null,he(e.gamesRunning,(a,m)=>(_(),v("div",{class:"game-teaser-wrap",key:m},[z(r,{game:a},null,8,["game"])]))),128)),Qs,(_(!0),v(ie,null,he(e.gamesFinished,(a,m)=>(_(),v("div",{class:"game-teaser-wrap",key:m},[z(r,{game:a},null,8,["game"])]))),128))])}var Js=Z(Ks,[["render",Xs]]);const en=H({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function tn(e,t,o,n,i,l){const r=N("image-teaser");return _(),v("div",null,[(_(!0),v(ie,null,he(e.images,(a,m)=>(_(),re(r,{image:a,onClick:E=>e.imageClicked(a),onEditClick:E=>e.imageEditClicked(a),key:m},null,8,["image","onClick","onEditClick"]))),128))])}var ho=Z(en,[["render",tn]]);const on=H({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.droppable=!1},imageFromDragEvt(e){var n;const t=(n=e.dataTransfer)==null?void 0:n.items;if(!t||t.length===0)return null;const o=t[0];return o.type.startsWith("image/")?o:null},onFileSelect(e){const t=e.target;if(!t.files)return;const o=t.files[0];!o||this.preview(o)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=o=>{this.previewUrl=o.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const o=t.getAsFile();return o&&(this.file=o,this.preview(o),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),sn=s("div",{class:"drop-target"},null,-1),nn={key:0,class:"has-image"},ln={key:1},rn={class:"upload"},an=s("span",{class:"btn"},"Upload File",-1),un={class:"area-settings"},cn=s("td",null,[s("label",null,"Title")],-1),dn=s("tr",null,[s("td",{colspan:"2"},[s("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),pn=s("td",null,[s("label",null,"Tags")],-1),hn={class:"area-buttons"},gn=["disabled"],mn=R("\u{1F5BC}\uFE0F Post to gallery"),fn=["disabled"],yn=R("\u{1F9E9} Post to gallery "),_n=s("br",null,null,-1),En=R(" + set up game");function wn(e,t,o,n,i,l){const r=N("responsive-image"),a=N("tags-input"),m=N("overlay");return _(),re(m,{class:"new-image-dialog"},{default:X(()=>[s("div",{class:Ve(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...E)=>e.onDrop&&e.onDrop(...E)),onDragover:t[3]||(t[3]=(...E)=>e.onDragover&&e.onDragover(...E)),onDragleave:t[4]||(t[4]=(...E)=>e.onDragleave&&e.onDragleave(...E))},[sn,e.previewUrl?(_(),v("div",nn,[s("span",{class:"remove btn",onClick:t[0]||(t[0]=E=>e.previewUrl="")},"X"),z(r,{src:e.previewUrl},null,8,["src"])])):(_(),v("div",ln,[s("label",rn,[s("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...E)=>e.onFileSelect&&e.onFileSelect(...E)),accept:"image/*"},null,32),an])]))],34),s("div",un,[s("table",null,[s("tr",null,[cn,s("td",null,[M(s("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=E=>e.title=E),placeholder:"Flower by @artist"},null,512),[[we,e.title]])])]),dn,s("tr",null,[pn,s("td",null,[z(a,{modelValue:e.tags,"onUpdate:modelValue":t[6]||(t[6]=E=>e.tags=E),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),s("div",hn,[s("button",{class:"btn",disabled:!e.canPostToGallery,onClick:t[7]||(t[7]=(...E)=>e.postToGallery&&e.postToGallery(...E))},[e.uploading==="postToGallery"?(_(),v(ie,{key:0},[R("Uploading ("+F(e.uploadProgressPercent)+"%)",1)],64)):(_(),v(ie,{key:1},[mn],64))],8,gn),s("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[8]||(t[8]=(...E)=>e.setupGameClick&&e.setupGameClick(...E))},[e.uploading==="setupGame"?(_(),v(ie,{key:0},[R("Uploading ("+F(e.uploadProgressPercent)+"%)",1)],64)):(_(),v(ie,{key:1},[yn,_n,En],64))],8,fn)])]),_:1})}var go=Z(on,[["render",wn]]);const vn=H({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),Pn={class:"area-image"},Tn={class:"has-image"},Cn={class:"area-settings"},Sn=s("td",null,[s("label",null,"Title")],-1),$n=s("tr",null,[s("td",{colspan:"2"},[s("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),bn=s("td",null,[s("label",null,"Tags")],-1),An={class:"area-buttons"};function On(e,t,o,n,i,l){const r=N("responsive-image"),a=N("tags-input"),m=N("overlay");return _(),re(m,{class:"edit-image-dialog"},{default:X(()=>[s("div",Pn,[s("div",Tn,[z(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),s("div",Cn,[s("table",null,[s("tr",null,[Sn,s("td",null,[M(s("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=E=>e.title=E),placeholder:"Flower by @artist"},null,512),[[we,e.title]])])]),$n,s("tr",null,[bn,s("td",null,[z(a,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=E=>e.tags=E),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),s("div",An,[s("button",{class:"btn",onClick:t[2]||(t[2]=(...E)=>e.saveImage&&e.saveImage(...E))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var mo=Z(vn,[["render",On]]),fo;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(fo||(fo={}));var fe;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(fe||(fe={}));var Ae;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(Ae||(Ae={}));var Pe;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(Pe||(Pe={}));const Nn=H({props:{image:{type:Object,required:!0}},emits:{newGame:null},data(){return{tiles:1e3,scoreMode:fe.ANY,shapeMode:Ae.NORMAL,snapMode:Pe.NORMAL}},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),kn={class:"area-image"},Un={class:"has-image"},Rn={key:0,class:"image-title"},Vn={key:0,class:"image-title-title"},zn={key:1,class:"image-title-dim"},Ln={class:"area-settings"},Mn=s("td",null,[s("label",null,"Pieces")],-1),Dn=s("td",null,[s("label",null,"Scoring: ")],-1),Fn=R(" Any (Score when pieces are connected to each other or on final location)"),Gn=s("br",null,null,-1),In=R(" Final (Score when pieces are put to their final location)"),Bn=s("td",null,[s("label",null,"Shapes: ")],-1),xn=R(" Normal"),Yn=s("br",null,null,-1),Zn=R(" Any (Flat pieces can occur anywhere)"),Wn=s("br",null,null,-1),Hn=R(" Flat (All pieces flat on all sides)"),jn=s("td",null,[s("label",null,"Snapping: ")],-1),Kn=R(" Normal (Pieces snap to final destination and to each other)"),qn=s("br",null,null,-1),Qn=R(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),Xn={key:0},Jn=s("td",null,[s("label",null,"Tags: ")],-1),ei={class:"area-buttons"},ti=["disabled"];function oi(e,t,o,n,i,l){const r=N("responsive-image"),a=N("overlay");return _(),re(a,{class:"new-game-dialog"},{default:X(()=>[s("div",kn,[s("div",Un,[z(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(_(),v("div",Rn,[e.image.title?(_(),v("span",Vn,'"'+F(e.image.title)+'"',1)):J("",!0),e.image.width||e.image.height?(_(),v("span",zn,"("+F(e.image.width)+" \u2715 "+F(e.image.height)+")",1)):J("",!0)])):J("",!0)]),s("div",Ln,[s("table",null,[s("tr",null,[Mn,s("td",null,[M(s("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=m=>e.tiles=m)},null,512),[[we,e.tiles]])])]),s("tr",null,[Dn,s("td",null,[s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=m=>e.scoreMode=m),value:"1"},null,512),[[ve,e.scoreMode]]),Fn]),Gn,s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=m=>e.scoreMode=m),value:"0"},null,512),[[ve,e.scoreMode]]),In])])]),s("tr",null,[Bn,s("td",null,[s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=m=>e.shapeMode=m),value:"0"},null,512),[[ve,e.shapeMode]]),xn]),Yn,s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=m=>e.shapeMode=m),value:"1"},null,512),[[ve,e.shapeMode]]),Zn]),Wn,s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=m=>e.shapeMode=m),value:"2"},null,512),[[ve,e.shapeMode]]),Hn])])]),s("tr",null,[jn,s("td",null,[s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=m=>e.snapMode=m),value:"0"},null,512),[[ve,e.snapMode]]),Kn]),qn,s("label",null,[M(s("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=m=>e.snapMode=m),value:"1"},null,512),[[ve,e.snapMode]]),Qn])])]),e.image.tags.length?(_(),v("tr",Xn,[Jn,s("td",null,[(_(!0),v(ie,null,he(e.image.tags,(m,E)=>(_(),v("span",{key:E,class:"bit"},F(m.title),1))),128))])])):J("",!0)])]),s("div",ei,[s("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[8]||(t[8]=(...m)=>e.onNewGameClick&&e.onNewGameClick(...m))}," \u{1F9E9} Generate Puzzle ",8,ti)])]),_:1})}var yo=Z(Nn,[["render",oi]]);const si=H({components:{ImageLibrary:ho,NewImageDialog:go,EditImageDialog:mo,NewGameDialog:yo},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(o=>!t.includes(o.title)&&o.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(o=>o.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ae.get(`/api/newgame-data${L.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags);const o=await ae.post("/api/upload",{body:t,onUploadProgress:n=>{this.uploadProgress=n.loaded/n.total}});return this.uploadProgress=1,await o.json()},async saveImage(e){return await(await ae.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.dialog="new-game"},async onNewGame(e){const t=await ae.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const o=await t.json();this.$router.push({name:"game",params:{id:o.id}})}}}}),ni={class:"upload-image-teaser"},ii=s("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),li={key:0},ri=R(" Tags: "),ai=["onClick"],ui=R(" Sort by: "),ci=s("option",{value:"date_desc"},"Newest first",-1),di=s("option",{value:"date_asc"},"Oldest first",-1),pi=s("option",{value:"alpha_asc"},"A-Z",-1),hi=s("option",{value:"alpha_desc"},"Z-A",-1),gi=[ci,di,pi,hi];function mi(e,t,o,n,i,l){const r=N("image-library"),a=N("new-image-dialog"),m=N("edit-image-dialog"),E=N("new-game-dialog");return _(),v("div",null,[s("div",ni,[s("div",{class:"btn btn-big",onClick:t[0]||(t[0]=S=>e.dialog="new-image")},"Upload your image"),ii]),s("div",null,[e.tags.length>0?(_(),v("label",li,[ri,(_(!0),v(ie,null,he(e.relevantTags,(S,G)=>(_(),v("span",{class:Ve(["bit is-clickable",{on:e.filters.tags.includes(S.slug)}]),key:G,onClick:f=>e.toggleTag(S)},F(S.title)+" ("+F(S.total)+")",11,ai))),128))])):J("",!0),s("label",null,[ui,M(s("select",{"onUpdate:modelValue":t[1]||(t[1]=S=>e.filters.sort=S),onChange:t[2]||(t[2]=(...S)=>e.filtersChanged&&e.filtersChanged(...S))},gi,544),[[ns,e.filters.sort]])])]),z(r,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),M(z(a,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=S=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[le,e.dialog==="new-image"]]),M(z(m,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=S=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[le,e.dialog==="edit-image"]]),M(z(E,{onBgclick:t[5]||(t[5]=S=>e.dialog=""),onNewGame:e.onNewGame,image:e.image},null,8,["onNewGame","image"]),[[le,e.image&&e.dialog==="new-game"]])])}var fi=Z(si,[["render",mi]]);const yi=H({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),_i={class:"scores"},Ei=s("div",null,"Scores",-1),wi=s("td",null,"\u26A1",-1),vi=s("td",null,"\u{1F4A4}",-1);function Pi(e,t,o,n,i,l){return _(),v("div",_i,[Ei,s("table",null,[(_(!0),v(ie,null,he(e.actives,(r,a)=>(_(),v("tr",{key:a,style:be({color:r.color})},[wi,s("td",null,F(r.name),1),s("td",null,F(r.points),1)],4))),128)),(_(!0),v(ie,null,he(e.idles,(r,a)=>(_(),v("tr",{key:a,style:be({color:r.color})},[vi,s("td",null,F(r.name),1),s("td",null,F(r.points),1)],4))),128))])])}var yt=Z(yi,[["render",Pi]]);const Ti=H({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return me.durationStr(this.status.duration)}}}),Ci={class:"puzzle-status"};function Si(e,t,o,n,i,l){return _(),v("div",Ci,[s("div",null," \u{1F9E9} "+F(e.status.piecesDone)+"/"+F(e.status.piecesTotal),1),s("div",null,F(e.icon)+" "+F(e.durationStr),1)])}var _t=Z(Ti,[["render",Si]]);const $i=H({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch("background",this.emitChanges)),this.watches.push(this.$watch("color",this.emitChanges)),this.watches.push(this.$watch("name",this.emitChanges)),this.watches.push(this.$watch("soundsEnabled",this.emitChanges)),this.watches.push(this.$watch("soundsVolume",this.emitChanges)),this.watches.push(this.$watch("showPlayerNames",this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue),this.$watch("modelValue",e=>{this.apply(e)})}}),Oe=e=>(is("data-v-39db9680"),e=e(),ls(),e),bi={class:"settings"},Ai=Oe(()=>s("td",null,[s("label",null,"Background: ")],-1)),Oi=Oe(()=>s("td",null,[s("label",null,"Color: ")],-1)),Ni=Oe(()=>s("td",null,[s("label",null,"Name: ")],-1)),ki=Oe(()=>s("td",null,[s("label",null,"Sounds: ")],-1)),Ui=Oe(()=>s("td",null,[s("label",null,"Sounds Volume: ")],-1)),Ri={class:"sound-volume"},Vi=["value"],zi=Oe(()=>s("td",null,[s("label",null,"Show player names: ")],-1));function Li(e,t,o,n,i,l){const r=N("overlay");return _(),re(r,{class:"transparent"},{default:X(()=>[s("table",bi,[s("tr",null,[Ai,s("td",null,[M(s("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=a=>e.background=a)},null,512),[[we,e.background]])])]),s("tr",null,[Oi,s("td",null,[M(s("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=a=>e.color=a)},null,512),[[we,e.color]])])]),s("tr",null,[Ni,s("td",null,[M(s("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=a=>e.name=a)},null,512),[[we,e.name]])])]),s("tr",null,[ki,s("td",null,[M(s("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=a=>e.soundsEnabled=a)},null,512),[[io,e.soundsEnabled]])])]),s("tr",null,[Ui,s("td",Ri,[s("span",{onClick:t[4]||(t[4]=(...a)=>e.decreaseVolume&&e.decreaseVolume(...a))},"\u{1F509}"),s("input",{type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[5]||(t[5]=(...a)=>e.updateVolume&&e.updateVolume(...a))},null,40,Vi),s("span",{onClick:t[6]||(t[6]=(...a)=>e.increaseVolume&&e.increaseVolume(...a))},"\u{1F50A}")])]),s("tr",null,[zi,s("td",null,[M(s("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=a=>e.showPlayerNames=a)},null,512),[[io,e.showPlayerNames]])])])])]),_:1})}var Et=Z($i,[["render",Li],["__scopeId","data-v-39db9680"]]);const Mi=H({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),Di={class:"preview"};function Fi(e,t,o,n,i,l){const r=N("overlay");return _(),re(r,{class:"preview-overlay",animate:!1},{default:X(()=>[s("div",Di,[s("div",{class:"img",style:be(e.previewStyle)},null,4)])]),_:1})}var wt=Z(Mi,[["render",Fi]]);const Gi=H({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case fe.ANY:return["Any","Score when pieces are connected to each other or on final location"];case fe.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case Ae.FLAT:return["Flat","All pieces flat on all sides"];case Ae.ANY:return["Any","Flat pieces can occur anywhere"];case Ae.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case Pe.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case Pe.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),Ii={class:"help"},Bi=s("tr",null,[s("td",{colspan:"2"},"Info about this puzzle")],-1),xi=s("td",null,"Image Title: ",-1),Yi=s("td",null,"Scoring: ",-1),Zi=["title"],Wi=s("td",null,"Shapes: ",-1),Hi=["title"],ji=s("td",null,"Snapping: ",-1),Ki=["title"];function qi(e,t,o,n,i,l){const r=N("overlay");return _(),re(r,{class:"transparent"},{default:X(()=>[s("table",Ii,[Bi,s("tr",null,[xi,s("td",null,F(e.game.puzzle.info.image.title),1)]),s("tr",null,[Yi,s("td",null,[s("span",{title:e.snapMode[1]},F(e.scoreMode[0]),9,Zi)])]),s("tr",null,[Wi,s("td",null,[s("span",{title:e.snapMode[1]},F(e.shapeMode[0]),9,Hi)])]),s("tr",null,[ji,s("td",null,[s("span",{title:e.snapMode[1]},F(e.snapMode[0]),9,Ki)])])])]),_:1})}var vt=Z(Gi,[["render",qi]]);const Qi=2,Xi=1,Ji=4,el=2,tl=3,ol=1,sl=2,nl=4,il=3,ll=1,rl=2,al=3,ul=4,cl=5,dl=6,pl=7,hl=8,gl=9,ml=10,fl=11,yl=12,_l=13,El=14,wl=15,vl=16,Pl=17,Tl=18,Cl=19,Sl=20,$l=21,bl=1,Al=2,Ol=3;var d={EV_SERVER_EVENT:Xi,EV_SERVER_INIT:Ji,EV_CLIENT_EVENT:el,EV_CLIENT_INIT:tl,GAME_VERSION:Qi,LOG_HEADER:ol,LOG_ADD_PLAYER:sl,LOG_UPDATE_PLAYER:nl,LOG_HANDLE_INPUT:il,INPUT_EV_MOVE:gl,INPUT_EV_MOUSE_DOWN:ll,INPUT_EV_MOUSE_UP:rl,INPUT_EV_MOUSE_MOVE:al,INPUT_EV_ZOOM_IN:ul,INPUT_EV_ZOOM_OUT:cl,INPUT_EV_BG_COLOR:dl,INPUT_EV_PLAYER_COLOR:pl,INPUT_EV_PLAYER_NAME:hl,INPUT_EV_TOGGLE_PREVIEW:ml,INPUT_EV_TOGGLE_SOUNDS:fl,INPUT_EV_REPLAY_TOGGLE_PAUSE:yl,INPUT_EV_REPLAY_SPEED_UP:_l,INPUT_EV_REPLAY_SPEED_DOWN:El,INPUT_EV_TOGGLE_PLAYER_NAMES:wl,INPUT_EV_CENTER_FIT_PUZZLE:vl,INPUT_EV_TOGGLE_FIXED_PIECES:Pl,INPUT_EV_TOGGLE_LOOSE_PIECES:Tl,INPUT_EV_STORE_POS:Cl,INPUT_EV_RESTORE_POS:Sl,INPUT_EV_CONNECTION_CLOSE:$l,CHANGE_DATA:bl,CHANGE_TILE:Al,CHANGE_PLAYER:Ol};const Nl=ct("Communication.js"),kl=1001,Pt=4e3,_o=0,Tt=1,Ct=2,Eo=3,wo=4;let ue,St=[],$t=e=>{St.push(e)},bt=[],At=e=>{bt.push(e)};function Ul(e){$t=e;for(const t of St)$t(t);St=[]}function Rl(e){At=e;for(const t of bt)At(t);bt=[]}let Ot=_o;const ze=e=>{Ot!==e&&(Ot=e,At(e))};function vo(e){if(Ot===Ct)try{ue.send(JSON.stringify(e))}catch{Nl.info("unable to send message.. maybe because ws is invalid?")}}let Ne,ke,Nt=0;function Po(e=2e4){ue.readyState==ue.OPEN&&ue.send(""),Nt=setTimeout(Po,e)}function To(){Nt&&clearTimeout(Nt)}function Vl(e,t,o){return Ne=0,ke={},ze(Eo),new Promise(n=>{ue=new WebSocket(e,o+"|"+t),ue.onopen=()=>{ze(Ct),vo([d.EV_CLIENT_INIT]),Po()},ue.onmessage=i=>{const l=JSON.parse(i.data),r=l[0];if(r===d.EV_SERVER_INIT){const a=l[1];n(a)}else if(r===d.EV_SERVER_EVENT){const a=l[1],m=l[2];if(a===o&&ke[m]){delete ke[m];return}$t(l)}else throw`[ 2021-05-09 invalid connect msgType ${r} ]`},ue.onerror=()=>{throw To(),ze(Tt),"[ 2021-05-15 onerror ]"},ue.onclose=i=>{To(),i.code===Pt||i.code===kl?ze(wo):ze(Tt)}})}async function zl(e,t){const o={gameId:e,offset:t};return await(await ae.get(`/api/replay-data${L.asQueryArgs(o)}`,{})).json()}function Ll(){ue&&ue.close(Pt),Ne=0,ke={}}function Ml(e){Ne++,ke[Ne]=e,vo([d.EV_CLIENT_EVENT,Ne,ke[Ne]])}var ye={connect:Vl,requestReplayData:zl,disconnect:Ll,sendClientEvent:Ml,onServerChange:Ul,onConnectionStateChange:Rl,CODE_CUSTOM_DISCONNECT:Pt,CONN_STATE_NOT_CONNECTED:_o,CONN_STATE_DISCONNECTED:Tt,CONN_STATE_CLOSED:wo,CONN_STATE_CONNECTED:Ct,CONN_STATE_CONNECTING:Eo};const Dl=H({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===ye.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===ye.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),Fl={key:0},Gl={key:2};function Il(e,t,o,n,i,l){const r=N("overlay");return M((_(),re(r,{class:"connection-lost"},{default:X(()=>[e.lostConnection?(_(),v("div",Fl,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):J("",!0),e.lostConnection?(_(),v("span",{key:1,class:"btn",onClick:t[0]||(t[0]=a=>e.$emit("reconnect"))},"Reconnect")):J("",!0),e.connecting?(_(),v("div",Gl,"Connecting...")):J("",!0)]),_:1},512)),[[le,e.show]])}var Co=Z(Dl,[["render",Il]]);const Bl=H({}),xl=s("table",{class:"help"},[s("tr",null,[s("td",null,"\u2B06\uFE0F Move up:"),s("td",null,[s("div",null,[s("kbd",null,"W"),R("/"),s("kbd",null,"\u2191"),R("/\u{1F5B1}\uFE0F")])])]),s("tr",null,[s("td",null,"\u2B07\uFE0F Move down:"),s("td",null,[s("div",null,[s("kbd",null,"S"),R("/"),s("kbd",null,"\u2193"),R("/\u{1F5B1}\uFE0F")])])]),s("tr",null,[s("td",null,"\u2B05\uFE0F Move left:"),s("td",null,[s("div",null,[s("kbd",null,"A"),R("/"),s("kbd",null,"\u2190"),R("/\u{1F5B1}\uFE0F")])])]),s("tr",null,[s("td",null,"\u27A1\uFE0F Move right:"),s("td",null,[s("div",null,[s("kbd",null,"D"),R("/"),s("kbd",null,"\u2192"),R("/\u{1F5B1}\uFE0F")])])]),s("tr",null,[s("td"),s("td",null,[s("div",null,[R("Move faster by holding "),s("kbd",null,"Shift")])])]),s("tr",null,[s("td",null,"\u{1F50D}+ Zoom in:"),s("td",null,[s("div",null,[s("kbd",null,"E"),R("/\u{1F5B1}\uFE0F-Wheel")])])]),s("tr",null,[s("td",null,"\u{1F50D}- Zoom out:"),s("td",null,[s("div",null,[s("kbd",null,"Q"),R("/\u{1F5B1}\uFE0F-Wheel")])])]),s("tr",null,[s("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),s("td",null,[s("div",null,[s("kbd",null,"Space")])])]),s("tr",null,[s("td",null,"\u{1F3AF} Center puzzle in screen:"),s("td",null,[s("div",null,[s("kbd",null,"C")])])]),s("tr",null,[s("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),s("td",null,[s("div",null,[s("kbd",null,"F")])])]),s("tr",null,[s("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),s("td",null,[s("div",null,[s("kbd",null,"G")])])]),s("tr",null,[s("td",null,"\u{1F464} Toggle player names:"),s("td",null,[s("div",null,[s("kbd",null,"N")])])]),s("tr",null,[s("td",null,"\u{1F509} Toggle sounds:"),s("td",null,[s("div",null,[s("kbd",null,"M")])])]),s("tr",null,[s("td",null,"\u23EB Speed up (replay):"),s("td",null,[s("div",null,[s("kbd",null,"I")])])]),s("tr",null,[s("td",null,"\u23EC Speed down (replay):"),s("td",null,[s("div",null,[s("kbd",null,"O")])])]),s("tr",null,[s("td",null,"\u23F8\uFE0F Pause (replay):"),s("td",null,[s("div",null,[s("kbd",null,"P")])])])],-1);function Yl(e,t,o,n,i,l){const r=N("overlay");return _(),re(r,{class:"transparent"},{default:X(()=>[xl]),_:1})}var kt=Z(Bl,[["render",Yl]]),Zl="/assets/click.bb97cb07.mp3",Wl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Zl}),Hl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",jl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Hl}),Kl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",ql=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Kl}),Ql="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Xl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Ql}),Jl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",er=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Jl});const tr=e=>{let t=!1;const o=()=>{t=!0},n=e.fps||60,i=e.slow||1,l=e.update,r=e.render,a=window.requestAnimationFrame,m=1/n,E=i*m;let S,G=0,f=window.performance.now();const h=()=>{for(S=window.performance.now(),G=G+Math.min(1,(S-f)/1e3);G>E;)G=G-E,l(m);r(G/i),f=S,t||a(h)};return a(h),{stop:o}},or=.1,sr=6,nr=.05;class ir{constructor(){this.x=0,this.y=0,this.curZoom=1}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,o){this.x+=t/this.curZoom,this.y+=o/this.curZoom}calculateNewZoom(t){const o=t==="in"?1:-1,n=this.curZoom+nr*this.curZoom*o;return Math.min(Math.max(n,or),sr)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,o){if(this.curZoom==t)return!1;const n=1-this.curZoom/t;return this.move(-o.x*n,-o.y*n),this.curZoom=t,!0}zoom(t,o){return this.setZoom(this.calculateNewZoom(t),o)}viewportToWorld(t){const{x:o,y:n}=this.viewportToWorldRaw(t);return{x:Math.round(o),y:Math.round(n)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:o,y:n}=this.worldToViewportRaw(t);return{x:Math.round(o),y:Math.round(n)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:o,h:n}=this.worldDimToViewportRaw(t);return{w:Math.round(o),h:Math.round(n)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:o,h:n}=this.viewportDimToWorldRaw(t);return{w:Math.round(o),h:Math.round(n)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function Ut(e=0,t=0){const o=document.createElement("canvas");return o.width=e,o.height=t,o}async function lr(e){return new Promise(t=>{const o=new Image;o.onload=()=>{createImageBitmap(o).then(t)},o.src=e})}async function rr(e,t,o){const n=Ut(t,o);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,o),await createImageBitmap(n)}function ar(e,t,o){const n=Ut(e.width,e.height),i=n.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=o,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),n}var ce={createCanvas:Ut,loadImageToBitmap:lr,resizeBitmap:rr,colorizedCanvas:ar};const ur=ct("Debug.js");let Rt=0,So=0;const cr=e=>{Rt=performance.now(),So=e},dr=e=>{const t=performance.now(),o=t-Rt;o>So&&ur.log(e+": "+o),Rt=t};var Te={checkpoint_start:cr,checkpoint:dr};function pr(e,t){return{x:e.x-t.x,y:e.y-t.y}}function hr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function $o(e,t){const o=e.x-t.x,n=e.y-t.y;return Math.sqrt(o*o+n*n)}function gr(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Vt(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function mr(e,t,o){return{x:e.x+t,y:e.y+o,w:e.w,h:e.h}}function fr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function yr(e,t){return $o(Vt(e),Vt(t))}var Y={pointSub:pr,pointAdd:hr,pointDistance:$o,pointInBounds:gr,rectCenter:Vt,rectMoved:mr,rectCenterDistance:yr,rectsOverlap:fr};const bo=ct("PuzzleGraphics.js");async function _r(e,t,o){bo.log("start createPuzzleTileBitmaps");const n=o.tileSize,i=o.tileMarginWidth,l=o.tileDrawSize,r=n/100,a=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],m=new Array(t.length),E={};function S(y){const I=`${y.top}${y.right}${y.left}${y.bottom}`;if(E[I])return E[I];const O=new Path2D,$={x:i,y:i},T=Y.pointAdd($,{x:n,y:0}),c=Y.pointAdd(T,{x:0,y:n}),C=Y.pointSub(c,{x:n,y:0});if(O.moveTo($.x,$.y),y.top!==0)for(let w=0;w<a.length/6;w++){const K=Y.pointAdd($,{x:a[w*6+0]*r,y:y.top*a[w*6+1]*r}),j=Y.pointAdd($,{x:a[w*6+2]*r,y:y.top*a[w*6+3]*r}),p=Y.pointAdd($,{x:a[w*6+4]*r,y:y.top*a[w*6+5]*r});O.bezierCurveTo(K.x,K.y,j.x,j.y,p.x,p.y)}else O.lineTo(T.x,T.y);if(y.right!==0)for(let w=0;w<a.length/6;w++){const K=Y.pointAdd(T,{x:-y.right*a[w*6+1]*r,y:a[w*6+0]*r}),j=Y.pointAdd(T,{x:-y.right*a[w*6+3]*r,y:a[w*6+2]*r}),p=Y.pointAdd(T,{x:-y.right*a[w*6+5]*r,y:a[w*6+4]*r});O.bezierCurveTo(K.x,K.y,j.x,j.y,p.x,p.y)}else O.lineTo(c.x,c.y);if(y.bottom!==0)for(let w=0;w<a.length/6;w++){const K=Y.pointSub(c,{x:a[w*6+0]*r,y:y.bottom*a[w*6+1]*r}),j=Y.pointSub(c,{x:a[w*6+2]*r,y:y.bottom*a[w*6+3]*r}),p=Y.pointSub(c,{x:a[w*6+4]*r,y:y.bottom*a[w*6+5]*r});O.bezierCurveTo(K.x,K.y,j.x,j.y,p.x,p.y)}else O.lineTo(C.x,C.y);if(y.left!==0)for(let w=0;w<a.length/6;w++){const K=Y.pointSub(C,{x:-y.left*a[w*6+1]*r,y:a[w*6+0]*r}),j=Y.pointSub(C,{x:-y.left*a[w*6+3]*r,y:a[w*6+2]*r}),p=Y.pointSub(C,{x:-y.left*a[w*6+5]*r,y:a[w*6+4]*r});O.bezierCurveTo(K.x,K.y,j.x,j.y,p.x,p.y)}else O.lineTo($.x,$.y);return E[I]=O,O}const G=ce.createCanvas(l,l),f=G.getContext("2d"),h=ce.createCanvas(l,l),A=h.getContext("2d");for(const y of t){const I=L.decodePiece(y),O=Er(o,I.idx),$=S(L.decodeShape(o.shapes[I.idx]));f.clearRect(0,0,l,l),f.save(),f.lineWidth=2,f.stroke($),f.globalCompositeOperation="source-in",f.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),f.restore(),f.save(),f.globalCompositeOperation="source-in",f.globalAlpha=.2,f.fillStyle="black",f.fillRect(0,0,G.width,G.height),f.restore(),f.save(),f.clip($),f.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),f.restore(),f.save(),f.clip($),f.strokeStyle="rgba(0,0,0,.4)",f.lineWidth=0,f.shadowColor="black",f.shadowBlur=2,f.shadowOffsetX=-1,f.shadowOffsetY=-1,f.stroke($),f.restore(),f.save(),f.clip($),f.strokeStyle="rgba(255,255,255,.4)",f.lineWidth=0,f.shadowColor="white",f.shadowBlur=2,f.shadowOffsetX=1,f.shadowOffsetY=1,f.stroke($),f.restore(),A.clearRect(0,0,l,l),A.save(),A.lineWidth=1,A.stroke($),A.globalCompositeOperation="source-in",A.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),A.restore(),f.drawImage(h,0,0),m[I.idx]=await createImageBitmap(G)}return bo.log("end createPuzzleTileBitmaps"),m}function Er(e,t){const o=L.coordByPieceIdx(e,t);return{x:o.x*e.tileSize,y:o.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function wr(e){const t=await ce.loadImageToBitmap(e.info.imageUrl),o=await ce.resizeBitmap(t,e.info.width,e.info.height);return await _r(o,e.tiles,e.info)}var vr={loadPuzzleBitmaps:wr};const Ao=30,P={};function Pr(e){return!!P[e]||!1}function Tr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function Cr(e,t){P[e]=t}function Ke(e,t){let o=0;for(const n of P[e].players){if(L.decodePlayer(n).id===t)return o;o++}return-1}function Sr(e,t){return P[e].players.length>t?L.decodePlayer(P[e].players[t]).id:null}function Ce(e,t){const o=Ke(e,t);return o===-1?null:L.decodePlayer(P[e].players[o])}function zt(e,t,o){const n=Ke(e,t);n===-1?P[e].players.push(L.encodePlayer(o)):P[e].players[n]=L.encodePlayer(o)}function $r(e,t,o){P[e].puzzle.tiles[t]=L.encodePiece(o)}function br(e,t){P[e].puzzle.data=t}function Oo(e,t){return Ke(e,t)!==-1}function Ar(e,t){const o=t-Ao*me.SEC;return No(e).filter(n=>n.ts>=o)}function Or(e,t){const o=t-Ao*me.SEC;return No(e).filter(n=>n.ts<o&&n.points>0)}function Nr(e,t,o){Oo(e,t)?te(e,t,{ts:o}):zt(e,t,Tr(t,o))}function kr(){return Object.values(P).sort((e,t)=>{const o=Uo(e.id);return o===Uo(t.id)?o?t.puzzle.data.finished-e.puzzle.data.finished:t.puzzle.data.started-e.puzzle.data.started:o?1:-1})}function No(e){return P[e]?P[e].players.map(L.decodePlayer):[]}function Ur(e){return P[e]||null}function qe(e){return P[e].puzzle.tiles.length}function Rr(e){var o;const t=((o=P[e].puzzle.info.image)==null?void 0:o.url)||P[e].puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Lt(e){return P[e].scoreMode}function ko(e){return P[e].snapMode}function Uo(e){return Qe(e)===qe(e)}function Qe(e){let t=0;for(const o of P[e].puzzle.tiles)L.decodePiece(o).owner===-1&&t++;return t}function Vr(e){return P[e].puzzle.tiles.map(L.decodePiece).sort((o,n)=>o.z-n.z)}function te(e,t,o){const n=Ce(e,t);if(n!==null){for(const i of Object.keys(o))n[i]=o[i];zt(e,t,n)}}function Xe(e,t){for(const o of Object.keys(t))P[e].puzzle.data[o]=t[o]}function Se(e,t,o){for(const n of Object.keys(o)){const i=L.decodePiece(P[e].puzzle.tiles[t]);i[n]=o[n],P[e].puzzle.tiles[t]=L.encodePiece(i)}}const Ue=(e,t)=>L.decodePiece(P[e].puzzle.tiles[t]),Je=(e,t)=>Ue(e,t).group,zr=(e,t)=>{const o=P[e].puzzle.info;return t===0||t===o.tilesX-1||t===o.tiles-o.tilesX||t===o.tiles-1},Ro=(e,t)=>{const o=P[e].puzzle.info,n={x:(o.table.width-o.width)/2,y:(o.table.height-o.height)/2},i=xr(e,t);return Y.pointAdd(n,i)},et=(e,t)=>Ue(e,t).pos,Lr=e=>{const t=Go(e),o=Io(e),n=Math.round(t/4),i=Math.round(o/4);return{x:0-n,y:0-i,w:t+2*n,h:o+2*i}},Mr=(e,t)=>Ue(e,t).z,Le=(e,t)=>{for(const o of P[e].puzzle.tiles){const n=L.decodePiece(o);if(n.owner===t)return n.idx}return-1},Dr=(e,t)=>{const o=Le(e,t);return o<0?null:P[e].puzzle.tiles[o]},Fr=e=>P[e].puzzle.info.tileDrawOffset,Vo=e=>P[e].puzzle.info.tileDrawSize,Gr=e=>P[e].puzzle.data.started,Ir=e=>P[e].puzzle.data.finished,zo=e=>P[e].puzzle.data.maxGroup,Lo=e=>P[e].puzzle.data.maxZ,Br=(e,t)=>{let o=0;for(const n of t){const i=Mr(e,n);i>o&&(o=i)}return o};function xr(e,t){const o=P[e].puzzle.info,n=L.coordByPieceIdx(o,t),i=n.x*o.tileSize,l=n.y*o.tileSize;return{x:i,y:l}}function Yr(e,t){const o=P[e].puzzle.info,n=L.coordByPieceIdx(o,t);return[n.y>0?t-o.tilesX:-1,n.x<o.tilesX-1?t+1:-1,n.y<o.tilesY-1?t+o.tilesX:-1,n.x>0?t-1:-1]}const Mo=(e,t,o)=>{for(const n of t)Se(e,n,{z:o})},Zr=(e,t,o)=>{const n=et(e,t),i=Y.pointAdd(n,o);Se(e,t,{pos:i})},tt=(e,t,o)=>{const n=Vo(e),i=Lr(e),l=o;for(const r of t){const a=Ue(e,r);a.pos.x+o.x<i.x?l.x=Math.max(i.x-a.pos.x,l.x):a.pos.x+n+o.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-a.pos.x+n,l.x)),a.pos.y+o.y<i.y?l.y=Math.max(i.y-a.pos.y,l.y):a.pos.y+n+o.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-a.pos.y+n,l.y))}if(!l.x&&!l.y)return!1;for(const r of t)Zr(e,r,l);return!0},Wr=(e,t)=>Hr(e,t)===-1,Hr=(e,t)=>Ue(e,t).owner,Do=(e,t)=>{for(const o of t)Se(e,o,{owner:-1,z:1})},Mt=(e,t,o)=>{for(const n of t)Se(e,n,{owner:o})};function _e(e,t){const o=P[e].puzzle.tiles,n=L.decodePiece(o[t]),i=[];if(n.group)for(const l of o){const r=L.decodePiece(l);r.group===n.group&&i.push(r.idx)}else i.push(n.idx);return i}const jr=(e,t)=>{const o=P[e].puzzle.info,n=P[e].puzzle.tiles;let i=-1,l=-1;for(let r=0;r<n.length;r++){const a=L.decodePiece(n[r]);if(a.owner!==0)continue;const m={x:a.pos.x,y:a.pos.y,w:o.tileSize,h:o.tileSize};Y.pointInBounds(t,m)&&(i===-1||a.z>i)&&(i=a.z,l=r)}return l},Kr=(e,t)=>{const o=Ce(e,t);return o?o.bgcolor:null},qr=(e,t)=>{const o=Ce(e,t);return o?o.color:null},Qr=(e,t)=>{const o=Ce(e,t);return o?o.name:null},Fo=(e,t)=>{const o=Ce(e,t);return o?o.points:0},Xr=(e,t,o)=>{const n=Je(e,t),i=Je(e,o);return!!(n&&n===i)},Go=e=>P[e].puzzle.info.table.width,Io=e=>P[e].puzzle.info.table.height,Jr=e=>P[e].puzzle,ea=e=>P[e].rng.obj,ta=e=>P[e].puzzle.info.width,oa=e=>P[e].puzzle.info.height,sa=(e,t)=>{if(ko(e)===Pe.REAL){for(const o of t)if(zr(e,o))return!0;return!1}return!0};function na(e,t,o,n,i){const l=P[e].puzzle,r=[],a=()=>{r.push([d.CHANGE_DATA,l.data])},m=h=>{r.push([d.CHANGE_TILE,L.encodePiece(Ue(e,h))])},E=h=>{for(const A of h)m(A)},S=()=>{const h=Ce(e,t);!h||r.push([d.CHANGE_PLAYER,L.encodePlayer(h)])},G=(h,A,y)=>{const I=P[h].puzzle.tiles,O=Je(h,A),$=Je(h,y);let T;const c=[];if(O&&c.push(O),$&&c.push($),O)T=O;else if($)T=$;else{const C=zo(h)+1;Xe(h,{maxGroup:C}),a(),T=zo(h)}if(Se(h,A,{group:T}),m(A),Se(h,y,{group:T}),m(y),c.length>0)for(const C of I){const w=L.decodePiece(C);c.includes(w.group)&&(Se(h,w.idx,{group:T}),m(w.idx))}},f=o[0];if(f===d.INPUT_EV_CONNECTION_CLOSE){const h=Le(e,t);if(h>=0){const A=_e(e,h);Mt(e,A,0),E(A)}}else if(f===d.INPUT_EV_BG_COLOR){const h=o[1];te(e,t,{bgcolor:h,ts:n}),S()}else if(f===d.INPUT_EV_PLAYER_COLOR){const h=o[1];te(e,t,{color:h,ts:n}),S()}else if(f===d.INPUT_EV_PLAYER_NAME){const h=`${o[1]}`.substr(0,16);te(e,t,{name:h,ts:n}),S()}else if(f===d.INPUT_EV_MOVE){const h=o[1],A=o[2],y=Ce(e,t);if(y){const I=y.x-h,O=y.y-A;te(e,t,{ts:n,x:I,y:O}),S();const $=Le(e,t);if($>=0){const T=_e(e,$),c={x:-h,y:-A};tt(e,T,c)&&E(T)}}}else if(f===d.INPUT_EV_MOUSE_DOWN){const h=o[1],A=o[2],y={x:h,y:A};te(e,t,{d:1,ts:n}),S();const I=jr(e,y);if(I>=0){const O=Lo(e)+1;Xe(e,{maxZ:O}),a();const $=_e(e,I);Mo(e,$,Lo(e)),Mt(e,$,t),E($)}}else if(f===d.INPUT_EV_MOUSE_MOVE){const h=o[1],A=o[2];if(!o[5])te(e,t,{x:h,y:A,ts:n}),S();else{const I=Le(e,t);if(I<0)te(e,t,{ts:n}),S();else{const O=o[1],$=o[2],T=o[3],c=o[4];te(e,t,{x:O,y:$,ts:n}),S();const C=_e(e,I);tt(e,C,{x:T,y:c})&&E(C)}}}else if(f===d.INPUT_EV_MOUSE_UP){const h=0,A=Le(e,t);if(A>=0){const y=_e(e,A);Mt(e,y,0),E(y);const I=et(e,A),O=Ro(e,A);if(sa(e,y)&&Y.pointDistance(O,I)<l.info.snapDistance){const $=Y.pointSub(O,I);tt(e,y,$),Do(e,y),E(y);let T=Fo(e,t);Lt(e)===fe.FINAL?T+=y.length:Lt(e)===fe.ANY&&(T+=1),te(e,t,{d:h,ts:n,points:T}),S(),Qe(e)===qe(e)&&(Xe(e,{finished:n}),a()),i&&i(t)}else{const $=(c,C,w,K)=>{const j=P[c].puzzle.info;if(w<0||Xr(c,C,w))return!1;const p=et(c,C),U=Y.pointAdd(et(c,w),{x:K[0]*j.tileSize,y:K[1]*j.tileSize});if(Y.pointDistance(p,U)<j.snapDistance){const q=Y.pointSub(U,p);let se=_e(c,C);if(tt(c,se,q),G(c,C,w),se=_e(c,C),Wr(c,w))Do(c,se);else{const Ge=Br(c,se);Mo(c,se,Ge)}return E(se),!0}return!1};let T=!1;for(const c of _e(e,A)){const C=Yr(e,c);if($(e,c,C[0],[0,1])||$(e,c,C[1],[-1,0])||$(e,c,C[2],[0,-1])||$(e,c,C[3],[1,0])){T=!0;break}}if(T&&Lt(e)===fe.ANY){const c=Fo(e,t)+1;te(e,t,{d:h,ts:n,points:c}),S()}else te(e,t,{d:h,ts:n}),S();T&&ko(e)===Pe.REAL&&Qe(e)===qe(e)&&(Xe(e,{finished:n}),a()),T&&i&&i(t)}}else te(e,t,{d:h,ts:n}),S()}else if(f===d.INPUT_EV_ZOOM_IN){const h=o[1],A=o[2];te(e,t,{x:h,y:A,ts:n}),S()}else if(f===d.INPUT_EV_ZOOM_OUT){const h=o[1],A=o[2];te(e,t,{x:h,y:A,ts:n}),S()}else te(e,t,{ts:n}),S();return r}var k={setGame:Cr,exists:Pr,playerExists:Oo,getActivePlayers:Ar,getIdlePlayers:Or,addPlayer:Nr,getFinishedPiecesCount:Qe,getPieceCount:qe,getImageUrl:Rr,get:Ur,getAllGames:kr,getPlayerBgColor:Kr,getPlayerColor:qr,getPlayerName:Qr,getPlayerIndexById:Ke,getPlayerIdByIndex:Sr,changePlayer:te,setPlayer:zt,setPiece:$r,setPuzzleData:br,getTableWidth:Go,getTableHeight:Io,getPuzzle:Jr,getRng:ea,getPuzzleWidth:ta,getPuzzleHeight:oa,getPiecesSortedByZIndex:Vr,getFirstOwnedPiece:Dr,getPieceDrawOffset:Fr,getPieceDrawSize:Vo,getFinalPiecePos:Ro,getStartTs:Gr,getFinishTs:Ir,handleInput:na};let Bo=-10,xo=20,Dt=2,Yo=15;const ia=5,la=5,Ft=1,ra=200,Zo=10,aa=100,ua=10,ca=1,da=5;function pa(e){const t=e.random(0,255),o=e.random(0,255),n=e.random(0,255);return"rgba("+t+","+o+","+n+", 0.8)"}class Wo{constructor(t){this.radius=Zo,this.previousRadius=Zo,this.explodingDuration=aa,this.hasExploded=!1,this.alive=!0,this.color=pa(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Bo+Math.random()*xo,this.vy=(Dt+Math.random()*Yo)*-1,this.duration=0}update(t){if(this.hasExploded){const o=ra-this.radius;this.previousRadius=this.radius,this.radius+=o/ua,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=Ft,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const o=3+Math.floor(Math.random()*3);for(let n=0;n<o;n++){const i=10+Math.floor(Math.random()*21),l=ia+Math.random()*la,r=2*Math.PI/i,a=Math.random()*r;for(let m=0;m<i;m++)t.push(new ha(this,m*r+a,l))}}}class ha{constructor(t,o,n){this.px=t.px,this.py=t.py,this.vx=Math.cos(o)*n,this.vy=Math.sin(o)*n,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=Ft/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class ga{constructor(t,o){this.canvas=t,this.rng=o,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,o=0;for(;t<this.canvas.height&&o>=0;)o+=Ft,t+=o;Dt=o/2,Yo=o-Dt;const n=1/4*this.canvas.width/(o/2);Bo=-n,xo=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<ca;t++)this.readyBombs.push(new Wo(this.rng))}update(){Math.random()*100<da&&this.readyBombs.push(new Wo(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const o=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):o.push(i)}this.readyBombs=o;const n=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&n.push(i)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function ma(e,t,o,n){let i=[],l=!0,r=!1,a=!1,m=!1,E=!1,S=!1,G=!1,f=!1;const h=(p,U)=>{const q=o.viewportToWorld({x:p,y:U});return[q.x,q.y]},A=(p,U)=>{const q=o.viewportDimToWorld({w:p,h:U});return[q.w,q.h]},y=p=>h(p.offsetX,p.offsetY),I=()=>h(e.width/2,e.height/2),O=(p,U)=>{!l||(U.code==="ShiftLeft"||U.code==="ShiftRight"?f=p:U.code==="ArrowUp"||U.code==="KeyW"?m=p:U.code==="ArrowDown"||U.code==="KeyS"?E=p:U.code==="ArrowLeft"||U.code==="KeyA"?r=p:U.code==="ArrowRight"||U.code==="KeyD"?a=p:U.code==="KeyQ"?G=p:U.code==="KeyE"&&(S=p))};let $=!1,T=null,c=null;e.addEventListener("mousedown",p=>{c=y(p),T=[p.offsetX,p.offsetY],p.button===0&&($=!0,C([d.INPUT_EV_MOUSE_DOWN,...c]))}),e.addEventListener("mouseup",p=>{c=y(p),T=[p.offsetX,p.offsetY],p.button===0&&($=!1,C([d.INPUT_EV_MOUSE_UP,...c]))}),e.addEventListener("mousemove",p=>{if(!T)return;c=y(p);const U=A(-(T[0]-p.offsetX),-(T[1]-p.offsetY));C([d.INPUT_EV_MOUSE_MOVE,...c,...U,$?1:0]),T=[p.offsetX,p.offsetY]}),e.addEventListener("wheel",p=>{if(c=y(p),o.canZoom(p.deltaY<0?"in":"out")){const U=p.deltaY<0?d.INPUT_EV_ZOOM_IN:d.INPUT_EV_ZOOM_OUT;C([U,...c])}}),t.addEventListener("keydown",p=>O(!0,p)),t.addEventListener("keyup",p=>O(!1,p)),t.addEventListener("keypress",p=>{if(!!l){if(n===de&&(p.code==="KeyI"?C([d.INPUT_EV_REPLAY_SPEED_UP]):p.code==="KeyO"?C([d.INPUT_EV_REPLAY_SPEED_DOWN]):p.code==="KeyP"&&C([d.INPUT_EV_REPLAY_TOGGLE_PAUSE])),p.code==="Space")C([d.INPUT_EV_TOGGLE_PREVIEW]);else if(p.code==="KeyF")C([d.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(p.code==="KeyG")C([d.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(p.code==="KeyM")C([d.INPUT_EV_TOGGLE_SOUNDS]);else if(p.code==="KeyN")C([d.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(p.code==="KeyC")C([d.INPUT_EV_CENTER_FIT_PUZZLE]);else if(p.code==="Digit1"){const U=p.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;C([U,1])}else if(p.code==="Digit2"){const U=p.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;C([U,2])}else if(p.code==="Digit3"){const U=p.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;C([U,3])}}});const C=p=>{i.push(p)};return{addEvent:C,consumeAll:()=>{if(i.length===0)return[];const p=i.slice();return i=[],p},createKeyEvents:()=>{const p=(r?1:0)-(a?1:0),U=(m?1:0)-(E?1:0);if(p!==0||U!==0){const q=(f?24:12)*Math.sqrt(o.getCurrentZoom()),se=o.viewportDimToWorld({w:p*q,h:U*q});C([d.INPUT_EV_MOVE,se.w,se.h]),c&&(c[0]-=se.w,c[1]-=se.h)}if(!(S&&G)){if(S){if(o.canZoom("in")){const q=c||I();C([d.INPUT_EV_ZOOM_IN,...q])}}else if(G&&o.canZoom("out")){const q=c||I();C([d.INPUT_EV_ZOOM_OUT,...q])}}},setHotkeys:p=>{l=p}}}const ot={"./grab.png":jl,"./grab_mask.png":ql,"./hand.png":Xl,"./hand_mask.png":er},fa={"./click.mp3":Wl},Me="play",de="replay";let De=!0,Fe=!0;const ya=e=>e.owner===-1?De:Fe;let W=!0;async function Ho(e,t,o,n,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const r=u=>n===de||u.id!==t,a=fa["./click.mp3"].default,m=new Audio(a),E=await ce.loadImageToBitmap(ot["./grab.png"].default),S=await ce.loadImageToBitmap(ot["./hand.png"].default),G=await ce.loadImageToBitmap(ot["./grab_mask.png"].default),f=await ce.loadImageToBitmap(ot["./hand_mask.png"].default),h=E.width,A=Math.round(h/2),y=E.height,I=Math.round(y/2),O={},$=async u=>{const g=u.color+" "+u.d;if(!O[g]){const b=u.d?E:S;if(u.color){const B=u.d?G:f;O[g]=await createImageBitmap(ce.colorizedCanvas(b,B,u.color))}else O[g]=b}return O[g]},T=i,c={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};ye.onConnectionStateChange(u=>{l.emit("connectionState",u)});const C=async u=>{const g=c.dataOffset;c.dataOffset+=1e4;const b=await ye.requestReplayData(u,g);return c.log=c.log.slice(c.logPointer),c.logPointer=0,c.log.push(...b.log),b.log.length===0&&(c.final=!0),b};let w=()=>0;const K=async()=>{if(n===Me){const u=await ye.connect(o,e,t),g=L.decodeGame(u);k.setGame(g.id,g),w=()=>me.timestamp()}else if(n===de){const u=await C(e);if(!u.game)throw"[ 2021-05-29 no game received ]";const g=L.decodeGame(u.game);k.setGame(g.id,g),c.lastRealTs=me.timestamp(),c.gameStartTs=parseInt(u.log[0][4],10),c.lastGameTs=c.gameStartTs,w=()=>c.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";W=!0};await K();const j=k.getPieceDrawOffset(e),p=k.getPieceDrawSize(e),U=k.getPuzzleWidth(e),q=k.getPuzzleHeight(e),se=k.getTableWidth(e),Ge=k.getTableHeight(e),qo={x:(se-U)/2,y:(Ge-q)/2},Gt={w:U,h:q},Qo={w:p,h:p},Xo=await vr.loadPuzzleBitmaps(k.getPuzzle(e)),st=new ga(T,k.getRng(e));st.init();const pe=T.getContext("2d");T.classList.add("loaded"),l.emit("puzzleCut");let It="";const ne={},V=new ir,Jo=()=>{V.reset(),V.move(-(se-T.width)/2,-(Ge-T.height)/2);const u=V.worldDimToViewportRaw(Gt),g=20,b=T.width-g*2,B=T.height-g*2;if(u.w>b||u.h>B||u.w<b&&u.h<B){const D=Math.min(b/u.w,B/u.h),Q={x:T.width/2,y:T.height/2};V.setZoom(D,Q)}},Ie=u=>{ne.last&&It===u?(V.fromSnapshot(ne.last),delete ne.last):ne[u]&&(ne.last=V.snapshot(),It=u,V.fromSnapshot(ne[u]))};Jo(),ne.center=V.snapshot();const $e=ma(T,window,V,n),es=k.getImageUrl(e),Be=u=>{const g=k.getStartTs(e),b=k.getFinishTs(e);l.emit("status",{finished:!!b,duration:(b||u)-g,piecesDone:k.getFinishedPiecesCount(e),piecesTotal:k.getPieceCount(e)}),l.emit("players",{active:k.getActivePlayers(e,u),idle:k.getIdlePlayers(e,u)})};Be(w());const Bt=!!k.getFinishTs(e);let nt=Bt;const xt=()=>nt&&!Bt,Yt=()=>ee.getInt(oe.SOUND_VOLUME,ge.SOUND_VOLUME),Zt=()=>ee.getBool(oe.SOUND_ENABLED,ge.SOUND_ENABLED),Wt=()=>ee.getBool(oe.SHOW_PLAYER_NAMES,ge.SHOW_PLAYER_NAMES),Ht=()=>{const u=Yt();m.volume=u/100,m.play()},jt=()=>n===de?ee.getStr(oe.COLOR_BACKGROUND,ge.COLOR_BACKGROUND):k.getPlayerBgColor(e,t)||ee.getStr(oe.COLOR_BACKGROUND,ge.COLOR_BACKGROUND),Kt=()=>n===de?ee.getStr(oe.PLAYER_COLOR,ge.PLAYER_COLOR):k.getPlayerColor(e,t)||ee.getStr(oe.PLAYER_COLOR,ge.PLAYER_COLOR),ts=()=>n===de?ee.getStr(oe.PLAYER_NAME,ge.PLAYER_NAME):k.getPlayerName(e,t)||ee.getStr(oe.PLAYER_NAME,ge.PLAYER_NAME);let qt="",Qt="",Xt=!1;const Re=u=>{Xt=u;const[g,b]=u?[qt,"grab"]:[Qt,"default"];T.style.cursor=`url('${g}') ${A} ${I}, ${b}`},it=u=>{qt=ce.colorizedCanvas(E,G,u).toDataURL(),Qt=ce.colorizedCanvas(S,f,u).toDataURL(),Re(Xt)};it(Kt());const xe=()=>{l.emit("replaySpeed",c.speeds[c.speedIdx]),l.emit("replayPaused",c.paused)},Jt=()=>{c.speedIdx+1<c.speeds.length&&(c.speedIdx++,xe())},eo=()=>{c.speedIdx>=1&&(c.speedIdx--,xe())},to=()=>{c.paused=!c.paused,xe()};l.on("replayOnSpeedUp",()=>{Jt()}),l.on("replayOnSpeedDown",()=>{eo()}),l.on("replayOnPauseToggle",()=>{to()}),l.on("onBgChange",u=>{ee.setStr(oe.COLOR_BACKGROUND,u),$e.addEvent([d.INPUT_EV_BG_COLOR,u])}),l.on("onColorChange",u=>{ee.setStr(oe.PLAYER_COLOR,u),$e.addEvent([d.INPUT_EV_PLAYER_COLOR,u])}),l.on("onNameChange",u=>{ee.setStr(oe.PLAYER_NAME,u),$e.addEvent([d.INPUT_EV_PLAYER_NAME,u])}),l.on("onSoundsEnabledChange",u=>{ee.setBool(oe.SOUND_ENABLED,u)}),l.on("onSoundsVolumeChange",u=>{ee.setInt(oe.SOUND_VOLUME,u),Ht()}),l.on("onShowPlayerNamesChange",u=>{ee.setBool(oe.SHOW_PLAYER_NAMES,u)}),l.on("setHotkeys",u=>{$e.setHotkeys(u)}),l.on("requireRerender",()=>{W=!0});const oo=[];let Ye;const os=()=>{oo.forEach(u=>{clearInterval(u)}),Ye&&clearTimeout(Ye)};let lt;const ss=()=>{os(),lt&&lt.stop()};if(n===Me?oo.push(setInterval(()=>{Be(w())},1e3)):n===de&&xe(),n===Me)ye.onServerChange(u=>{u[0],u[1],u[2];const g=u[3];for(const[b,B]of g)switch(b){case d.CHANGE_PLAYER:{const D=L.decodePlayer(B);D.id!==t&&(k.setPlayer(e,D.id,D),W=!0)}break;case d.CHANGE_TILE:{const D=L.decodePiece(B);k.setPiece(e,D.idx,D),W=!0}break;case d.CHANGE_DATA:k.setPuzzleData(e,B),W=!0;break}nt=!!k.getFinishTs(e)});else if(n===de){const u=(B,D)=>{const Q=B;if(Q[0]===d.LOG_ADD_PLAYER){const x=Q[1];return k.addPlayer(e,x,D),!0}if(Q[0]===d.LOG_UPDATE_PLAYER){const x=k.getPlayerIdByIndex(e,Q[1]);if(!x)throw"[ 2021-05-17 player not found (update player) ]";return k.addPlayer(e,x,D),!0}if(Q[0]===d.LOG_HANDLE_INPUT){const x=k.getPlayerIdByIndex(e,Q[1]);if(!x)throw"[ 2021-05-17 player not found (handle input) ]";const Ee=Q[2];return k.handleInput(e,x,Ee,D),!0}return!1};let g=c.lastGameTs;const b=async()=>{c.logPointer+1>=c.log.length&&await C(e);const B=me.timestamp();if(c.paused){c.lastRealTs=B,Ye=setTimeout(b,50);return}const Q=(B-c.lastRealTs)*c.speeds[c.speedIdx];let x=c.lastGameTs+Q;do{if(c.paused)break;const Ee=c.logPointer+1;if(Ee>=c.log.length)break;const Ze=c.log[c.logPointer],so=g+Ze[Ze.length-1],rt=c.log[Ee],no=rt[rt.length-1],at=so+no;if(at>x){x+500*me.MS<at&&(x+=no);break}g=so,u(rt,at)&&(W=!0),c.logPointer=Ee}while(!0);c.lastRealTs=B,c.lastGameTs=x,Be(w()),c.final||(Ye=setTimeout(b,50))};b()}return lt=tr({update:()=>{$e.createKeyEvents();for(const u of $e.consumeAll())if(n===Me){const g=u[0];if(g===d.INPUT_EV_MOVE){const D=V.worldDimToViewportRaw({w:u[1],h:u[2]});W=!0,V.move(D.w,D.h),delete ne.last}else if(g===d.INPUT_EV_MOUSE_MOVE){if(u[5]&&!k.getFirstOwnedPiece(e,t)){const Q=V.worldDimToViewportRaw({w:u[3],h:u[4]});W=!0,V.move(Q.w,Q.h),delete ne.last}}else if(g===d.INPUT_EV_PLAYER_COLOR)it(u[1]);else if(g===d.INPUT_EV_MOUSE_DOWN)Re(!0);else if(g===d.INPUT_EV_MOUSE_UP)Re(!1);else if(g===d.INPUT_EV_ZOOM_IN){const D={x:u[1],y:u[2]};W=!0,V.zoom("in",V.worldToViewportRaw(D)),delete ne.last}else if(g===d.INPUT_EV_ZOOM_OUT){const D={x:u[1],y:u[2]};W=!0,V.zoom("out",V.worldToViewportRaw(D)),delete ne.last}else if(g===d.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(g===d.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(g===d.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(g===d.INPUT_EV_CENTER_FIT_PUZZLE)Ie("center");else if(g===d.INPUT_EV_TOGGLE_FIXED_PIECES)De=!De,W=!0;else if(g===d.INPUT_EV_TOGGLE_LOOSE_PIECES)Fe=!Fe,W=!0;else if(g===d.INPUT_EV_STORE_POS){const D=`${u[1]}`;ne[D]=V.snapshot()}else if(g===d.INPUT_EV_RESTORE_POS){const D=`${u[1]}`;Ie(D)}const b=w();k.handleInput(e,t,u,b,D=>{Zt()&&Ht()}).length>0&&(W=!0),ye.sendClientEvent(u)}else if(n===de){const g=u[0];if(g===d.INPUT_EV_REPLAY_TOGGLE_PAUSE)to();else if(g===d.INPUT_EV_REPLAY_SPEED_DOWN)eo();else if(g===d.INPUT_EV_REPLAY_SPEED_UP)Jt();else if(g===d.INPUT_EV_MOVE){const b=V.worldDimToViewportRaw({w:u[1],h:u[2]});W=!0,V.move(b.w,b.h)}else if(g===d.INPUT_EV_MOUSE_MOVE){if(u[5]){const B=V.worldDimToViewportRaw({w:u[3],h:u[4]});W=!0,V.move(B.w,B.h)}}else if(g===d.INPUT_EV_PLAYER_COLOR)it(u[1]);else if(g===d.INPUT_EV_MOUSE_DOWN)Re(!0);else if(g===d.INPUT_EV_MOUSE_UP)Re(!1);else if(g===d.INPUT_EV_ZOOM_IN){const b={x:u[1],y:u[2]};W=!0,V.zoom("in",V.worldToViewportRaw(b))}else if(g===d.INPUT_EV_ZOOM_OUT){const b={x:u[1],y:u[2]};W=!0,V.zoom("out",V.worldToViewportRaw(b))}else if(g===d.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(g===d.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(g===d.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(g===d.INPUT_EV_CENTER_FIT_PUZZLE)Ie("center");else if(g===d.INPUT_EV_TOGGLE_FIXED_PIECES)De=!De,W=!0;else if(g===d.INPUT_EV_TOGGLE_LOOSE_PIECES)Fe=!Fe,W=!0;else if(g===d.INPUT_EV_STORE_POS){const b=`${u[1]}`;ne[b]=V.snapshot()}else if(g===d.INPUT_EV_RESTORE_POS){const b=`${u[1]}`;Ie(b)}}nt=!!k.getFinishTs(e),xt()&&(st.update(),W=!0)},render:async()=>{if(!W)return;const u=w();let g,b,B;window.DEBUG&&Te.checkpoint_start(0),pe.fillStyle=jt(),pe.fillRect(0,0,T.width,T.height),window.DEBUG&&Te.checkpoint("clear done"),g=V.worldToViewportRaw(qo),b=V.worldDimToViewportRaw(Gt),pe.fillStyle="rgba(255, 255, 255, .3)",pe.fillRect(g.x,g.y,b.w,b.h),window.DEBUG&&Te.checkpoint("board done");const D=k.getPiecesSortedByZIndex(e);window.DEBUG&&Te.checkpoint("get tiles done"),b=V.worldDimToViewportRaw(Qo);for(const x of D)!ya(x)||(B=Xo[x.idx],g=V.worldToViewportRaw({x:j+x.pos.x,y:j+x.pos.y}),pe.drawImage(B,0,0,B.width,B.height,g.x,g.y,b.w,b.h));window.DEBUG&&Te.checkpoint("tiles done");const Q=[];for(const x of k.getActivePlayers(e,u))r(x)&&(B=await $(x),g=V.worldToViewport(x),pe.drawImage(B,g.x-A,g.y-I),Wt()&&Q.push([`${x.name} (${x.points})`,g.x,g.y+y]));pe.fillStyle="white",pe.textAlign="center";for(const[x,Ee,Ze]of Q)pe.fillText(x,Ee,Ze);window.DEBUG&&Te.checkpoint("players done"),Be(u),window.DEBUG&&Te.checkpoint("HUD done"),xt()&&st.render(),W=!1}}),{previewImageUrl:es,player:{background:jt(),color:Kt(),name:ts(),soundsEnabled:Zt(),soundsVolume:Yt(),showPlayerNames:Wt()},game:k.get(e),disconnect:ye.disconnect,connect:K,unload:ss}}const _a=H({name:"game",components:{PuzzleStatusComponent:_t,Scores:yt,SettingsOverlay:Et,PreviewOverlay:wt,InfoOverlay:vt,ConnectionOverlay:Co,HelpOverlay:kt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:lo(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Ho(`${this.$route.params.id}`,ae.clientId(),this.$config.WS_ADDRESS,Me,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}}}),Ea={id:"game"},wa=s("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),va={class:"menu-left"},Pa={key:0,class:"switch-game-replay"},Ta=R("\u21AA\uFE0F Watch replay"),Ca={class:"menu"},Sa={class:"tabs"},$a=R("\u{1F9E9} Puzzles"),ba={class:"menu-right"},Aa={ref:"canvas"};function Oa(e,t,o,n,i,l){const r=N("settings-overlay"),a=N("preview-overlay"),m=N("info-overlay"),E=N("help-overlay"),S=N("overlay"),G=N("connection-overlay"),f=N("puzzle-status"),h=N("router-link"),A=N("scores");return _(),v("div",Ea,[M(z(r,{onClose:t[0]||(t[0]=y=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=y=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=y=>e.g.player=y)},null,8,["modelValue"]),[[le,e.overlay==="settings"]]),M(z(a,{onClose:t[3]||(t[3]=y=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=y=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[le,e.overlay==="preview"]]),e.g.game?M((_(),re(m,{key:0,onClose:t[5]||(t[5]=y=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=y=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[le,e.overlay==="info"]]):J("",!0),M(z(E,{onClose:t[7]||(t[7]=y=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=y=>e.toggle("help",!0))},null,512),[[le,e.overlay==="help"]]),M(z(S,null,{default:X(()=>[wa]),_:1},512),[[le,e.cuttingPuzzle]]),z(G,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),s("div",va,[z(f,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(_(),v("div",Pa,[z(h,{to:{name:"replay",params:{id:e.g.game.id}}},{default:X(()=>[Ta]),_:1},8,["to"])])):J("",!0)]),s("div",Ca,[s("div",Sa,[z(h,{class:"opener",to:{name:"index"},target:"_blank"},{default:X(()=>[$a]),_:1}),s("div",{class:"opener",onClick:t[9]||(t[9]=y=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),s("div",{class:"opener",onClick:t[10]||(t[10]=y=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),s("div",{class:"opener",onClick:t[11]||(t[11]=y=>e.toggle("info",!0))},"\u2139\uFE0F Info"),s("div",{class:"opener",onClick:t[12]||(t[12]=y=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),s("div",ba,[z(A,{players:e.players},null,8,["players"])]),s("canvas",Aa,null,512)])}var Na=Z(_a,[["render",Oa]]);const ka=H({name:"replay",components:{PuzzleStatusComponent:_t,Scores:yt,SettingsOverlay:Et,PreviewOverlay:wt,InfoOverlay:vt,HelpOverlay:kt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:lo(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Ho(`${this.$route.params.id}`,ae.clientId(),this.$config.WS_ADDRESS,de,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Ua={id:"replay"},Ra={key:1,class:"overlay"},Va=s("div",{class:"overlay-content"},[s("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),za=[Va],La={class:"menu-left"},Ma={class:"playback-control"},Da={key:0,class:"switch-game-replay"},Fa=R("\u{1F9E9} To the game"),Ga={class:"menu"},Ia={class:"tabs"},Ba=R("\u{1F9E9} Puzzles"),xa={class:"menu-right"},Ya={ref:"canvas"};function Za(e,t,o,n,i,l){const r=N("settings-overlay"),a=N("preview-overlay"),m=N("info-overlay"),E=N("help-overlay"),S=N("puzzle-status"),G=N("router-link"),f=N("scores");return _(),v("div",Ua,[M(z(r,{onClose:t[0]||(t[0]=h=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=h=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=h=>e.g.player=h)},null,8,["modelValue"]),[[le,e.overlay==="settings"]]),M(z(a,{onClose:t[3]||(t[3]=h=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=h=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[le,e.overlay==="preview"]]),e.g.game?M((_(),re(m,{key:0,onClose:t[5]||(t[5]=h=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=h=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[le,e.overlay==="info"]]):J("",!0),M(z(E,{onClose:t[7]||(t[7]=h=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=h=>e.toggle("help",!0))},null,512),[[le,e.overlay==="help"]]),e.cuttingPuzzle?(_(),v("div",Ra,za)):J("",!0),s("div",La,[z(S,{status:e.status},null,8,["status"]),s("div",Ma,[s("div",null,F(e.replayText),1),s("button",{class:"btn",onClick:t[9]||(t[9]=h=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),s("button",{class:"btn",onClick:t[10]||(t[10]=h=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),s("button",{class:"btn",onClick:t[11]||(t[11]=h=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")]),e.g.game?(_(),v("div",Da,[z(G,{to:{name:"game",params:{id:e.g.game.id}}},{default:X(()=>[Fa]),_:1},8,["to"])])):J("",!0)]),s("div",Ga,[s("div",Ia,[z(G,{class:"opener",to:{name:"index"},target:"_blank"},{default:X(()=>[Ba]),_:1}),s("div",{class:"opener",onClick:t[12]||(t[12]=h=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),s("div",{class:"opener",onClick:t[13]||(t[13]=h=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),s("div",{class:"opener",onClick:t[14]||(t[14]=h=>e.toggle("info",!0))},"\u2139\uFE0F Info"),s("div",{class:"opener",onClick:t[15]||(t[15]=h=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),s("div",xa,[z(f,{players:e.players},null,8,["players"])]),s("canvas",Ya,null,512)])}var Wa=Z(ka,[["render",Za]]);let jo=null;async function Ha(){jo=await(await ae.get("/api/me",{})).json()}var Ko={getMe:()=>jo,init:Ha};const ja=H({props:{image:{type:Object,required:!0}},data:()=>({me:Ko.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function Ka(e,t,o,n,i,l){return _(),v("div",{class:"imageteaser",style:be(e.style),onClick:t[1]||(t[1]=(...r)=>e.onClick&&e.onClick(...r))},[e.canEdit?(_(),v("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=rs((...r)=>e.onEditClick&&e.onEditClick(...r),["stop"]))},"\u270F\uFE0F")):J("",!0)],4)}var qa=Z(ja,[["render",Ka]]);const Qa=H({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Xa={class:"overlay"};function Ja(e,t,o,n,i,l){return _(),v("div",Xa,[s("div",{class:Ve(["overlay-background",e.classes.map(r=>"overlay-background-"+r)]),onClick:t[0]||(t[0]=r=>e.$emit("bgclick"))},null,2),s("div",{class:Ve(["overlay-content",e.classes.map(r=>"overlay-content-"+r)])},[as(e.$slots,"default")],2)])}var eu=Z(Qa,[["render",Ja]]);const tu={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},ou=["title"];function su(e,t,o,n,i,l){return _(),v("div",{style:be(l.style),title:o.title},null,12,ou)}var nu=Z(tu,[["render",su]]);const iu=H({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),lu={key:0,class:"autocomplete"},ru=["onClick"],au=["onClick"];function uu(e,t,o,n,i,l){return _(),v("div",null,[M(s("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=r=>e.input=r),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...r)=>e.onChange&&e.onChange(...r)),onKeydown:t[2]||(t[2]=us((...r)=>e.add&&e.add(...r),["enter"])),onKeyup:t[3]||(t[3]=(...r)=>e.onKeyUp&&e.onKeyUp(...r))},null,544),[[we,e.input]]),e.autocomplete.values?(_(),v("div",lu,[s("ul",null,[(_(!0),v(ie,null,he(e.autocomplete.values,(r,a)=>(_(),v("li",{key:a,class:Ve({active:a===e.autocomplete.idx}),onClick:m=>e.addVal(r)},F(r),11,ru))),128))])])):J("",!0),(_(!0),v(ie,null,he(e.values,(r,a)=>(_(),v("span",{key:a,class:"bit is-clickable",onClick:m=>e.rm(r)},F(r)+" \u2716",9,au))),128))])}var cu=Z(iu,[["render",uu],["__scopeId","data-v-d5073870"]]);const du=H({props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const o=t.files[0];if(!o)return;const n=new FormData;n.append("file",o,o.name);const l=await(await ae.post("/upload",{body:n})).json();this.$emit("uploaded",l)}}}),pu=["accept"],hu={class:"btn"};function gu(e,t,o,n,i,l){return _(),v("label",null,[s("input",{type:"file",style:{display:"none"},onChange:t[0]||(t[0]=(...r)=>e.upload&&e.upload(...r)),accept:e.accept},null,40,pu),s("span",hu,F(e.label||"Upload File"),1)])}var mu=Z(du,[["render",gu]]);(async()=>{ae.init(),await Ko.init();const t=await(await ae.get("/api/conf",{})).json(),o=cs({history:ds(),routes:[{name:"index",path:"/",component:Js},{name:"new-game",path:"/new-game",component:fi},{name:"game",path:"/g/:id",component:Na},{name:"replay",path:"/replay/:id",component:Wa}]});o.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const n=ps(ws);n.config.globalProperties.$config=t,n.use(o),n.component("connection-overlay",Co),n.component("edit-image-dialog",mo),n.component("game-teaser",po),n.component("help-overlay",kt),n.component("image-library",ho),n.component("image-teaser",qa),n.component("info-overlay",vt),n.component("new-game-dialog",yo),n.component("new-image-dialog",go),n.component("overlay",eu),n.component("preview-overlay",wt),n.component("puzzle-status",_t),n.component("responsive-image",nu),n.component("scores",yt),n.component("settings-overlay",Et),n.component("tags-input",cu),n.component("upload",mu),n.mount("#app")})();
//# sourceMappingURL=index.68aa1e4e.js.map
