import{d as e,c as t,a as n,w as l,b as i,r as o,o as a,e as s,t as r,F as d,f as c,g as u,h as g,v as p,i as h,j as m,k as y,l as f,m as w,n as v,p as b,q as x,s as C}from"./vendor.b622ee49.js";var k=e({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}});const A={id:"app"},T={key:0,class:"nav"},S=s("Index"),z=s("New game");k.render=function(e,s,r,d,c,u){const g=o("router-link"),p=o("router-view");return a(),t("div",A,[e.showNav?(a(),t("ul",T,[n("li",null,[n(g,{class:"btn",to:{name:"index"}},{default:l((()=>[S])),_:1})]),n("li",null,[n(g,{class:"btn",to:{name:"new-game"}},{default:l((()=>[z])),_:1})])])):i("",!0),n(p)])};const I=864e5,P=e=>{const t=Math.floor(e/I);e%=I;const n=Math.floor(e/36e5);e%=36e5;const l=Math.floor(e/6e4);e%=6e4;return`${t}d ${n}h ${l}m ${Math.floor(e/1e3)}s`};var _=1e3,D=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},B=(e,t)=>P(t-e),E=P,O=e({name:"game-teaser",props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const n=t?"🏁":"⏳",l=e,i=t||D();return`${n} ${B(l,i)}`}}});const U={class:"game-info-text"},N=n("br",null,null,-1),M=n("br",null,null,-1),G=n("br",null,null,-1),R=s(" ↪️ Watch replay ");O.render=function(e,d,c,u,g,p){const h=o("router-link");return a(),t("div",{class:"game-teaser",style:e.style},[n(h,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:l((()=>[n("span",U,[s(" 🧩 "+r(e.game.tilesFinished)+"/"+r(e.game.tilesTotal),1),N,s(" 👥 "+r(e.game.players),1),M,s(" "+r(e.time(e.game.started,e.game.finished)),1),G])])),_:1},8,["to"]),e.game.hasReplay?(a(),t(h,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:l((()=>[R])),_:1},8,["to"])):i("",!0)],4)};var $=e({components:{GameTeaser:O},data:()=>({gamesRunning:[],gamesFinished:[]}),async created(){const e=await fetch("/api/index-data"),t=await e.json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}});const V=n("h1",null,"Running games",-1),j=n("h1",null,"Finished games",-1);$.render=function(e,l,i,s,r,u){const g=o("game-teaser");return a(),t("div",null,[V,(a(!0),t(d,null,c(e.gamesRunning,((e,l)=>(a(),t("div",{class:"game-teaser-wrap",key:l},[n(g,{game:e},null,8,["game"])])))),128)),j,(a(!0),t(d,null,c(e.gamesFinished,((e,l)=>(a(),t("div",{class:"game-teaser-wrap",key:l},[n(g,{game:e},null,8,["game"])])))),128))])};var F=e({name:"image-teaser",props:{image:{type:Object,required:!0}},computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});F.render=function(e,l,i,o,s,r){return a(),t("div",{class:"imageteaser",style:e.style,onClick:l[2]||(l[2]=(...t)=>e.onClick&&e.onClick(...t))},[n("div",{class:"btn edit",onClick:l[1]||(l[1]=u(((...t)=>e.onEditClick&&e.onEditClick(...t)),["stop"]))},"✏️")],4)};var L=e({name:"image-library",components:{ImageTeaser:F},props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});L.render=function(e,n,l,i,s,r){const u=o("image-teaser");return a(),t("div",null,[(a(!0),t(d,null,c(e.images,((n,l)=>(a(),t(u,{image:n,onClick:t=>e.imageClicked(n),onEditClick:t=>e.imageEditClicked(n),key:l},null,8,["image","onClick","onEditClick"])))),128))])};const W={name:"responsive-image",props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}};W.render=function(e,n,l,i,o,s){return a(),t("div",{style:s.style,title:l.title},null,12,["title"])};var q=e({name:"tags-input",props:{modelValue:{type:Array,required:!0}},emits:{"update:modelValue":null},data:()=>({input:"",values:[]}),created(){this.values=this.modelValue},methods:{onKeyUp(e){if(","===e.key)return this.add(),e.stopPropagation(),!1},add(){const e=this.input.replace(/,/g,"").trim();e&&(this.values.includes(e)||this.values.push(e),this.input="",this.$emit("update:modelValue",this.values))},rm(e){this.values=this.values.filter((t=>t!==e)),this.$emit("update:modelValue",this.values)}}});const H=m()(((e,l,i,o,s,u)=>(a(),t("div",null,[g(n("input",{class:"input",type:"text","onUpdate:modelValue":l[1]||(l[1]=t=>e.input=t),placeholder:"Plants, People",onKeydown:l[2]||(l[2]=h(((...t)=>e.add&&e.add(...t)),["enter"])),onKeyup:l[3]||(l[3]=(...t)=>e.onKeyUp&&e.onKeyUp(...t))},null,544),[[p,e.input]]),(a(!0),t(d,null,c(e.values,((n,l)=>(a(),t("span",{key:l,class:"bit",onClick:t=>e.rm(n)},r(n)+" ✖",9,["onClick"])))),128))]))));q.render=H,q.__scopeId="data-v-771460ae";var Q=e({name:"new-image-dialog",components:{ResponsiveImage:W,TagsInput:q},emits:{bgclick:null,setupGameClick:null,postToGalleryClick:null},data:()=>({previewUrl:"",file:null,title:"",tags:[]}),computed:{canPostToGallery(){return!(!this.previewUrl||!this.file)},canSetupGameClick(){return!(!this.previewUrl||!this.file)}},methods:{preview(e){const t=e.target;if(!t.files)return;const n=t.files[0];if(!n)return;const l=new FileReader;l.readAsDataURL(n),l.onload=e=>{this.previewUrl=e.target.result,this.file=n}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags})},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags})}}});const Y={key:0,class:"has-image"},K={key:1},Z={class:"upload"},J=n("span",{class:"btn"},"Upload File",-1),X={class:"area-settings"},ee=n("td",null,[n("label",null,"Title")],-1),te=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),ne=n("td",null,[n("label",null,"Tags")],-1),le={class:"area-buttons"},ie=s("🧩 Post to gallery "),oe=n("br",null,null,-1),ae=s(" + set up game");Q.render=function(e,l,i,s,r,d){const c=o("responsive-image"),h=o("tags-input");return a(),t("div",{class:"overlay new-image-dialog",onClick:l[8]||(l[8]=t=>e.$emit("bgclick"))},[n("div",{class:"overlay-content",onClick:l[7]||(l[7]=u((()=>{}),["stop"]))},[n("div",{class:["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl}]},[e.previewUrl?(a(),t("div",Y,[n("span",{class:"remove btn",onClick:l[1]||(l[1]=t=>e.previewUrl="")},"X"),n(c,{src:e.previewUrl},null,8,["src"])])):(a(),t("div",K,[n("label",Z,[n("input",{type:"file",style:{display:"none"},onChange:l[2]||(l[2]=(...t)=>e.preview&&e.preview(...t)),accept:"image/*"},null,32),J])]))],2),n("div",X,[n("table",null,[n("tr",null,[ee,n("td",null,[g(n("input",{type:"text","onUpdate:modelValue":l[3]||(l[3]=t=>e.title=t),placeholder:"Flower by @artist"},null,512),[[p,e.title]])])]),te,n("tr",null,[ne,n("td",null,[n(h,{modelValue:e.tags,"onUpdate:modelValue":l[4]||(l[4]=t=>e.tags=t)},null,8,["modelValue"])])])])]),n("div",le,[n("button",{class:"btn",disabled:!e.canPostToGallery,onClick:l[5]||(l[5]=(...t)=>e.postToGallery&&e.postToGallery(...t))},"🖼️ Post to gallery",8,["disabled"]),n("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:l[6]||(l[6]=(...t)=>e.setupGameClick&&e.setupGameClick(...t))},[ie,oe,ae],8,["disabled"])])])])};var se=e({name:"edit-image-dialog",components:{ResponsiveImage:W,TagsInput:q},props:{image:{type:Object,required:!0}},emits:{bgclick:null,saveClick:null},data:()=>({title:"",tags:[]}),created(){this.title=this.image.title,this.tags=this.image.tags.map((e=>e.title))},methods:{saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}});const re={class:"area-image"},de={class:"has-image"},ce={class:"area-settings"},ue=n("td",null,[n("label",null,"Title")],-1),ge=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),pe=n("td",null,[n("label",null,"Tags")],-1),he={class:"area-buttons"};function me(e,t){const n=e.x-t.x,l=e.y-t.y;return Math.sqrt(n*n+l*l)}function ye(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}se.render=function(e,l,i,s,r,d){const c=o("responsive-image"),h=o("tags-input");return a(),t("div",{class:"overlay edit-image-dialog",onClick:l[5]||(l[5]=t=>e.$emit("bgclick"))},[n("div",{class:"overlay-content",onClick:l[4]||(l[4]=u((()=>{}),["stop"]))},[n("div",re,[n("div",de,[n(c,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),n("div",ce,[n("table",null,[n("tr",null,[ue,n("td",null,[g(n("input",{type:"text","onUpdate:modelValue":l[1]||(l[1]=t=>e.title=t),placeholder:"Flower by @artist"},null,512),[[p,e.title]])])]),ge,n("tr",null,[pe,n("td",null,[n(h,{modelValue:e.tags,"onUpdate:modelValue":l[2]||(l[2]=t=>e.tags=t)},null,8,["modelValue"])])])])]),n("div",he,[n("button",{class:"btn",onClick:l[3]||(l[3]=(...t)=>e.saveImage&&e.saveImage(...t))},"🖼️ Save image")])])])};var fe={pointSub:function(e,t){return{x:e.x-t.x,y:e.y-t.y}},pointAdd:function(e,t){return{x:e.x+t.x,y:e.y+t.y}},pointDistance:me,pointInBounds:function(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h},rectCenter:ye,rectMoved:function(e,t,n){return{x:e.x+t,y:e.y+n,w:e.w,h:e.h}},rectCenterDistance:function(e,t){return me(ye(e),ye(t))},rectsOverlap:function(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}};var we=1,ve=4,be=5,xe=2,Ce=3,ke=6,Ae=2,Te=4,Se=3,ze=9,Ie=1,Pe=2,_e=3,De=4,Be=5,Ee=6,Oe=7,Ue=8,Ne=10,Me=1,Ge=2,Re=3;class $e{constructor(e){this.rand_high=e||3735929054,this.rand_low=1231121986^e}random(e,t){return this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295,e+(this.rand_high>>>0)/4294967295*(t-e+1)|0}choice(e){return e[this.random(0,e.length-1)]}shuffle(e){const t=e.slice();for(let n=0;n<=t.length-2;n++){const e=this.random(n,t.length-1),l=t[n];t[n]=t[e],t[e]=l}return t}static serialize(e){return{rand_high:e.rand_high,rand_low:e.rand_low}}static unserialize(e){const t=new $e(0);return t.rand_high=e.rand_high,t.rand_low=e.rand_low,t}}const Ve=(e,t)=>{const n=`${e}`;return n.length>=t.length?n:t.substr(0,t.length-n.length)+n},je=(...e)=>{const t=t=>(...n)=>{const l=new Date,i=Ve(l.getHours(),"00"),o=Ve(l.getMinutes(),"00"),a=Ve(l.getSeconds(),"00");console[t](`${i}:${o}:${a}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}};var Fe,Le,We,qe,He={hash:e=>{let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t},slug:e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},uniqId:()=>Date.now().toString(36)+Math.random().toString(36).substring(2),encodeShape:function(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6},decodeShape:function(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}},encodeTile:function(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]},decodeTile:function(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}},encodePlayer:function(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]},decodePlayer:function(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}},encodeGame:function(e){return Array.isArray(e)?e:[e.id,e.rng.type,$e.serialize(e.rng.obj),e.puzzle,e.players,e.evtInfos,e.scoreMode]},decodeGame:function(e){return Array.isArray(e)?{id:e[0],rng:{type:e[1],obj:$e.unserialize(e[2])},puzzle:e[3],players:e[4],evtInfos:e[5],scoreMode:e[6]}:e},coordByTileIdx:function(e,t){const n=e.width/e.tileSize;return{x:t%n,y:Math.floor(t/n)}},asQueryArgs:function(e){const t=[];for(let n in e){const l=[n,e[n]].map(encodeURIComponent);t.push(l.join("="))}return 0===t.length?"":`?${t.join("&")}`}};(Le=Fe||(Fe={}))[Le.Flat=0]="Flat",Le[Le.Out=1]="Out",Le[Le.In=-1]="In",(qe=We||(We={}))[qe.FINAL=0]="FINAL",qe[qe.ANY=1]="ANY";const Qe={};function Ye(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function Ke(e,t){let n=0;for(let l of Qe[e].players){if(He.decodePlayer(l).id===t)return n;n++}return-1}function Ze(e,t){const n=Ke(e,t);return-1===n?null:He.decodePlayer(Qe[e].players[n])}function Je(e,t,n){const l=Ke(e,t);-1===l?Qe[e].players.push(He.encodePlayer(n)):Qe[e].players[l]=He.encodePlayer(n)}function Xe(e,t){return-1!==Ke(e,t)}function et(e){return Qe[e]?Qe[e].players.map(He.decodePlayer):[]}function tt(e){return Qe[e].puzzle.tiles.length}function nt(e){return Qe[e].scoreMode||0}function lt(e){return it(e)===tt(e)}function it(e){let t=0;for(let n of Qe[e].puzzle.tiles)-1===He.decodeTile(n).owner&&t++;return t}function ot(e,t,n){const l=Ze(e,t);if(null!==l){for(let e of Object.keys(n))l[e]=n[e];Je(e,t,l)}}function at(e,t){for(let n of Object.keys(t))Qe[e].puzzle.data[n]=t[n]}function st(e,t,n){for(let l of Object.keys(n)){const i=He.decodeTile(Qe[e].puzzle.tiles[t]);i[l]=n[l],Qe[e].puzzle.tiles[t]=He.encodeTile(i)}}const rt=(e,t)=>He.decodeTile(Qe[e].puzzle.tiles[t]),dt=(e,t)=>rt(e,t).group,ct=(e,t)=>{const n=Qe[e].puzzle.info,l={x:(n.table.width-n.width)/2,y:(n.table.height-n.height)/2},i=function(e,t){const n=Qe[e].puzzle.info,l=He.coordByTileIdx(n,t),i=l.x*n.tileSize,o=l.y*n.tileSize;return{x:i,y:o}}(e,t);return fe.pointAdd(l,i)},ut=(e,t)=>rt(e,t).pos,gt=e=>{const t=zt(e),n=It(e),l=Math.round(t/4),i=Math.round(n/4);return{x:0-l,y:0-i,w:t+2*l,h:n+2*i}},pt=(e,t)=>{const n=ft(e),l=rt(e,t);return{x:l.pos.x,y:l.pos.y,w:n,h:n}},ht=(e,t)=>rt(e,t).z,mt=(e,t)=>{for(let n of Qe[e].puzzle.tiles){const e=He.decodeTile(n);if(e.owner===t)return e.idx}return-1},yt=e=>Qe[e].puzzle.info.tileDrawSize,ft=e=>Qe[e].puzzle.info.tileSize,wt=e=>Qe[e].puzzle.data.maxGroup,vt=e=>Qe[e].puzzle.data.maxZ;function bt(e,t){const n=Qe[e].puzzle.info,l=He.coordByTileIdx(n,t);return[l.y>0?t-n.tilesX:-1,l.x<n.tilesX-1?t+1:-1,l.y<n.tilesY-1?t+n.tilesX:-1,l.x>0?t-1:-1]}const xt=(e,t,n)=>{for(let l of t)st(e,l,{z:n})},Ct=(e,t,n)=>{const l=ut(e,t);st(e,t,{pos:fe.pointAdd(l,n)})},kt=(e,t,n)=>{const l=yt(e),i=gt(e),o=n;for(let a of t){const t=rt(e,a);t.pos.x+n.x<i.x?o.x=Math.max(i.x-t.pos.x,o.x):t.pos.x+l+n.x>i.x+i.w&&(o.x=Math.min(i.x+i.w-t.pos.x+l,o.x)),t.pos.y+n.y<i.y?o.y=Math.max(i.y-t.pos.y,o.y):t.pos.y+l+n.y>i.y+i.h&&(o.y=Math.min(i.y+i.h-t.pos.y+l,o.y))}for(let a of t)Ct(e,a,o)},At=(e,t,n)=>{for(let l of t)st(e,l,{owner:n})};function Tt(e,t){const n=Qe[e].puzzle.tiles,l=He.decodeTile(n[t]),i=[];if(l.group)for(let o of n){const e=He.decodeTile(o);e.group===l.group&&i.push(e.idx)}else i.push(l.idx);return i}const St=(e,t)=>{const n=Ze(e,t);return n?n.points:0},zt=e=>Qe[e].puzzle.info.table.width,It=e=>Qe[e].puzzle.info.table.height;var Pt={__createPlayerObject:Ye,setGame:function(e,t){Qe[e]=t},exists:function(e){return!!Qe[e]||!1},playerExists:Xe,getActivePlayers:function(e,t){const n=t-30*_;return et(e).filter((e=>e.ts>=n))},getIdlePlayers:function(e,t){const n=t-30*_;return et(e).filter((e=>e.ts<n&&e.points>0))},addPlayer:function(e,t,n){Xe(e,t)?ot(e,t,{ts:n}):Je(e,t,Ye(t,n))},getFinishedTileCount:it,getTileCount:tt,getImageUrl:function(e){return Qe[e].puzzle.info.imageUrl},setImageUrl:function(e,t){Qe[e].puzzle.info.imageUrl=t},get:function(e){return Qe[e]},getAllGames:function(){return Object.values(Qe).sort(((e,t)=>lt(e.id)===lt(t.id)?t.puzzle.data.started-e.puzzle.data.started:lt(e.id)?1:-1))},getPlayerBgColor:(e,t)=>{const n=Ze(e,t);return n?n.bgcolor:null},getPlayerColor:(e,t)=>{const n=Ze(e,t);return n?n.color:null},getPlayerName:(e,t)=>{const n=Ze(e,t);return n?n.name:null},getPlayerIndexById:Ke,getPlayerIdByIndex:function(e,t){return Qe[e].players.length>t?He.decodePlayer(Qe[e].players[t]).id:null},changePlayer:ot,setPlayer:Je,setTile:function(e,t,n){Qe[e].puzzle.tiles[t]=He.encodeTile(n)},setPuzzleData:function(e,t){Qe[e].puzzle.data=t},getTableWidth:zt,getTableHeight:It,getPuzzle:e=>Qe[e].puzzle,getRng:e=>Qe[e].rng.obj,getPuzzleWidth:e=>Qe[e].puzzle.info.width,getPuzzleHeight:e=>Qe[e].puzzle.info.height,getTilesSortedByZIndex:function(e){return Qe[e].puzzle.tiles.map(He.decodeTile).sort(((e,t)=>e.z-t.z))},getFirstOwnedTile:(e,t)=>{const n=mt(e,t);return n<0?null:Qe[e].puzzle.tiles[n]},getTileDrawOffset:e=>Qe[e].puzzle.info.tileDrawOffset,getTileDrawSize:yt,getFinalTilePos:ct,getStartTs:e=>Qe[e].puzzle.data.started,getFinishTs:e=>Qe[e].puzzle.data.finished,handleInput:function(e,t,n,l){const i=Qe[e].puzzle,o=function(e,t){return t in Qe[e].evtInfos?Qe[e].evtInfos[t]:{_last_mouse:null,_last_mouse_down:null}}(e,t),a=[],s=()=>{a.push([Me,i.data])},r=t=>{a.push([Ge,He.encodeTile(rt(e,t))])},d=e=>{for(const t of e)r(t)},c=()=>{const n=Ze(e,t);n&&a.push([Re,He.encodePlayer(n)])},u=n[0];if(u===Ee){const i=n[1];ot(e,t,{bgcolor:i,ts:l}),c()}else if(u===Oe){const i=n[1];ot(e,t,{color:i,ts:l}),c()}else if(u===Ue){const i=`${n[1]}`.substr(0,16);ot(e,t,{name:i,ts:l}),c()}else if(u===Ie){const i={x:n[1],y:n[2]};ot(e,t,{d:1,ts:l}),c(),o._last_mouse_down=i;const a=((e,t)=>{let n=Qe[e].puzzle.info,l=Qe[e].puzzle.tiles,i=-1,o=-1;for(let a=0;a<l.length;a++){const e=He.decodeTile(l[a]);if(0!==e.owner)continue;const s={x:e.pos.x,y:e.pos.y,w:n.tileSize,h:n.tileSize};fe.pointInBounds(t,s)&&(-1===i||e.z>i)&&(i=e.z,o=a)}return o})(e,i);if(a>=0){let n=vt(e)+1;at(e,{maxZ:n}),s();const l=Tt(e,a);xt(e,l,vt(e)),At(e,l,t),d(l)}o._last_mouse=i}else if(u===_e){const i=n[1],a=n[2],s={x:i,y:a};if(null===o._last_mouse_down)ot(e,t,{x:i,y:a,ts:l}),c();else{let n=mt(e,t);if(n>=0){ot(e,t,{x:i,y:a,ts:l}),c();const r=Tt(e,n);let u=fe.pointInBounds(s,gt(e))&&fe.pointInBounds(o._last_mouse_down,gt(e));for(let t of r){const n=pt(e,t);if(fe.pointInBounds(s,n)){u=!0;break}}if(u){const t=i-o._last_mouse_down.x,n=a-o._last_mouse_down.y;kt(e,r,{x:t,y:n}),d(r)}}else ot(e,t,{ts:l}),c();o._last_mouse_down=s}o._last_mouse=s}else if(u===Pe){const a={x:n[1],y:n[2]},u=0;o._last_mouse_down=null;let g=mt(e,t);if(g>=0){let n=Tt(e,g);At(e,n,0),d(n);let o=ut(e,g),a=ct(e,g);if(fe.pointDistance(a,o)<i.info.snapDistance){let i=fe.pointSub(a,o);kt(e,n,i),((e,t)=>{for(let n of t)st(e,n,{owner:-1,z:1})})(e,n),d(n);let r=St(e,t);0===nt(e)?r+=n.length:1===nt(e)&&(r+=1),ot(e,t,{d:u,ts:l,points:r}),c(),it(e)===tt(e)&&(at(e,{finished:l}),s())}else{const n=(e,t,n,l)=>{let i=Qe[e].puzzle.info;if(n<0)return!1;if(((e,t,n)=>{const l=dt(e,t),i=dt(e,n);return!(!l||l!==i)})(e,t,n))return!1;const o=ut(e,t),a=fe.pointAdd(ut(e,n),{x:l[0]*i.tileSize,y:l[1]*i.tileSize});if(fe.pointDistance(o,a)<i.snapDistance){let l=fe.pointSub(a,o),i=Tt(e,t);kt(e,i,l),((e,t,n)=>{const l=Qe[e].puzzle.tiles,i=dt(e,t),o=dt(e,n);let a;const d=[];i&&d.push(i),o&&d.push(o),i?a=i:o?a=o:(at(e,{maxGroup:wt(e)+1}),s(),a=wt(e));if(st(e,t,{group:a}),r(t),st(e,n,{group:a}),r(n),d.length>0)for(const s of l){const t=He.decodeTile(s);d.includes(t.group)&&(st(e,t.idx,{group:a}),r(t.idx))}})(e,t,n),i=Tt(e,t);const c=((e,t)=>{let n=0;for(let l of t){let t=ht(e,l);t>n&&(n=t)}return n})(e,i);return xt(e,i,c),d(i),!0}return!1};let i=!1;for(let t of Tt(e,g)){let l=bt(e,t);if(n(e,t,l[0],[0,1])||n(e,t,l[1],[-1,0])||n(e,t,l[2],[0,-1])||n(e,t,l[3],[1,0])){i=!0;break}}if(i&&1===nt(e)){const n=St(e,t)+1;ot(e,t,{d:u,ts:l,points:n}),c()}else ot(e,t,{d:u,ts:l}),c()}}else ot(e,t,{d:u,ts:l}),c();o._last_mouse=a}else if(u===De){const i=n[1],a=n[2];ot(e,t,{x:i,y:a,ts:l}),c(),o._last_mouse={x:i,y:a}}else if(u===Be){const i=n[1],a=n[2];ot(e,t,{x:i,y:a,ts:l}),c(),o._last_mouse={x:i,y:a}}else ot(e,t,{ts:l}),c();return function(e,t,n){Qe[e].evtInfos[t]=n}(e,t,o),a}},_t=e({name:"new-game-dialog",components:{ResponsiveImage:W},props:{image:{type:Object,required:!0}},emits:{newGame:null,bgclick:null},data:()=>({tiles:1e3,scoreMode:We.ANY}),methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt})}},computed:{canStartNewGame(){return!!(this.tilesInt&&this.image&&this.image.url&&[0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}});const Dt={class:"area-image"},Bt={class:"has-image"},Et={class:"area-settings"},Ot=n("td",null,[n("label",null,"Pieces")],-1),Ut=n("td",null,[n("label",null,"Scoring: ")],-1),Nt=s(" Any (Score when pieces are connected to each other or on final location)"),Mt=n("br",null,null,-1),Gt=s(" Final (Score when pieces are put to their final location)"),Rt={class:"area-buttons"};_t.render=function(e,l,i,s,r,d){const c=o("responsive-image");return a(),t("div",{class:"overlay new-game-dialog",onClick:l[6]||(l[6]=t=>e.$emit("bgclick"))},[n("div",{class:"overlay-content",onClick:l[5]||(l[5]=u((()=>{}),["stop"]))},[n("div",Dt,[n("div",Bt,[n(c,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),n("div",Et,[n("table",null,[n("tr",null,[Ot,n("td",null,[g(n("input",{type:"text","onUpdate:modelValue":l[1]||(l[1]=t=>e.tiles=t)},null,512),[[p,e.tiles]])])]),n("tr",null,[Ut,n("td",null,[n("label",null,[g(n("input",{type:"radio","onUpdate:modelValue":l[2]||(l[2]=t=>e.scoreMode=t),value:"1"},null,512),[[y,e.scoreMode]]),Nt]),Mt,n("label",null,[g(n("input",{type:"radio","onUpdate:modelValue":l[3]||(l[3]=t=>e.scoreMode=t),value:"0"},null,512),[[y,e.scoreMode]]),Gt])])])])]),n("div",Rt,[n("button",{class:"btn",disabled:!e.canStartNewGame,onClick:l[4]||(l[4]=(...t)=>e.onNewGameClick&&e.onNewGameClick(...t))}," 🧩 Generate Puzzle ",8,["disabled"])])])])};var $t=e({components:{ImageLibrary:L,NewImageDialog:Q,EditImageDialog:se,NewGameDialog:_t},data:()=>({filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:""}),async created(){await this.loadImages()},methods:{toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter((t=>t!==e.slug)):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const e=await fetch(`/api/newgame-data${He.asQueryArgs(this.filters)}`),t=await e.json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags);const n=await fetch("/api/upload",{method:"post",body:t});return await n.json()},async saveImage(e){const t=await fetch("/api/save-image",{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})});return await t.json()},async onSaveImageClick(e){await this.saveImage(e),this.dialog="",await this.loadImages()},async postToGalleryClick(e){await this.uploadImage(e),this.dialog="",await this.loadImages()},async setupGameClick(e){const t=await this.uploadImage(e);this.loadImages(),this.image=t,this.dialog="new-game"},async onNewGame(e){const t=await fetch("/newgame",{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(200===t.status){const e=await t.json();this.$router.push({name:"game",params:{id:e.id}})}}}});const Vt={class:"upload-image-teaser"},jt=n("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),Ft={key:0},Lt=s(" Tags: "),Wt=s(" Sort by: "),qt=n("option",{value:"date_desc"},"Newest first",-1),Ht=n("option",{value:"date_asc"},"Oldest first",-1),Qt=n("option",{value:"alpha_asc"},"A-Z",-1),Yt=n("option",{value:"alpha_desc"},"Z-A",-1);$t.render=function(e,l,s,u,p,h){const m=o("image-library"),y=o("new-image-dialog"),w=o("edit-image-dialog"),v=o("new-game-dialog");return a(),t("div",null,[n("div",Vt,[n("div",{class:"btn btn-big",onClick:l[1]||(l[1]=t=>e.dialog="new-image")},"Upload your image"),jt]),n("div",null,[e.tags.length>0?(a(),t("label",Ft,[Lt,(a(!0),t(d,null,c(e.tags,((n,l)=>(a(),t("span",{class:["bit",{on:e.filters.tags.includes(n.slug)}],key:l,onClick:t=>e.toggleTag(n)},r(n.title),11,["onClick"])))),128))])):i("",!0),n("label",null,[Wt,g(n("select",{"onUpdate:modelValue":l[2]||(l[2]=t=>e.filters.sort=t),onChange:l[3]||(l[3]=(...t)=>e.filtersChanged&&e.filtersChanged(...t))},[qt,Ht,Qt,Yt],544),[[f,e.filters.sort]])])]),n(m,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),"new-image"===e.dialog?(a(),t(y,{key:0,onBgclick:l[4]||(l[4]=t=>e.dialog=""),onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["onPostToGalleryClick","onSetupGameClick"])):i("",!0),"edit-image"===e.dialog?(a(),t(w,{key:1,onBgclick:l[5]||(l[5]=t=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["onSaveClick","image"])):i("",!0),e.image&&"new-game"===e.dialog?(a(),t(v,{key:2,onBgclick:l[6]||(l[6]=t=>e.dialog=""),onNewGame:e.onNewGame,image:e.image},null,8,["onNewGame","image"])):i("",!0)])};var Kt=e({name:"scores",props:{activePlayers:{type:Array,required:!0},idlePlayers:{type:Array,required:!0}},computed:{actives(){return this.activePlayers.sort(((e,t)=>t.points-e.points)),this.activePlayers},idles(){return this.idlePlayers.sort(((e,t)=>t.points-e.points)),this.idlePlayers}}});const Zt={class:"scores"},Jt=n("div",null,"Scores",-1),Xt=n("td",null,"⚡",-1),en=n("td",null,"💤",-1);Kt.render=function(e,l,i,o,s,u){return a(),t("div",Zt,[Jt,n("table",null,[(a(!0),t(d,null,c(e.actives,((e,l)=>(a(),t("tr",{key:l,style:{color:e.color}},[Xt,n("td",null,r(e.name),1),n("td",null,r(e.points),1)],4)))),128)),(a(!0),t(d,null,c(e.idles,((e,l)=>(a(),t("tr",{key:l,style:{color:e.color}},[en,n("td",null,r(e.name),1),n("td",null,r(e.points),1)],4)))),128))])])};var tn=e({name:"puzzle-status",props:{finished:{type:Boolean,required:!0},duration:{type:Number,required:!0},piecesDone:{type:Number,required:!0},piecesTotal:{type:Number,required:!0}},computed:{icon(){return this.finished?"🏁":"⏳"},durationStr(){return E(this.duration)}}});const nn={class:"timer"};tn.render=function(e,l,i,o,s,d){return a(),t("div",nn,[n("div",null," 🧩 "+r(e.piecesDone)+"/"+r(e.piecesTotal),1),n("div",null,r(e.icon)+" "+r(e.durationStr),1),w(e.$slots,"default")])};var ln=e({name:"settings-overlay",emits:{bgclick:null,"update:modelValue":null},props:{modelValue:Object},created(){this.$watch("modelValue",(e=>{this.$emit("update:modelValue",e)}),{deep:!0})}});const on=n("td",null,[n("label",null,"Background: ")],-1),an=n("td",null,[n("label",null,"Color: ")],-1),sn=n("td",null,[n("label",null,"Name: ")],-1);ln.render=function(e,l,i,o,s,r){return a(),t("div",{class:"overlay transparent",onClick:l[5]||(l[5]=t=>e.$emit("bgclick"))},[n("table",{class:"overlay-content settings",onClick:l[4]||(l[4]=u((()=>{}),["stop"]))},[n("tr",null,[on,n("td",null,[g(n("input",{type:"color","onUpdate:modelValue":l[1]||(l[1]=t=>e.modelValue.background=t)},null,512),[[p,e.modelValue.background]])])]),n("tr",null,[an,n("td",null,[g(n("input",{type:"color","onUpdate:modelValue":l[2]||(l[2]=t=>e.modelValue.color=t)},null,512),[[p,e.modelValue.color]])])]),n("tr",null,[sn,n("td",null,[g(n("input",{type:"text",maxLength:"16","onUpdate:modelValue":l[3]||(l[3]=t=>e.modelValue.name=t)},null,512),[[p,e.modelValue.name]])])])])])};var rn=e({name:"preview-overlay",props:{img:String},emits:{bgclick:null},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}});const dn={class:"preview"};rn.render=function(e,l,i,o,s,r){return a(),t("div",{class:"overlay",onClick:l[1]||(l[1]=t=>e.$emit("bgclick"))},[n("div",dn,[n("div",{class:"img",style:e.previewStyle},null,4)])])};const cn=je("Communication.js");let un,gn=e=>{},pn=e=>{};let hn=0;const mn=e=>{hn!==e&&(hn=e,pn(e))};function yn(e){if(2===hn)try{un.send(JSON.stringify(e))}catch(t){cn.info("unable to send message.. maybe because ws is invalid?")}}let fn,wn;function vn(e,t){yn([ke,e,t])}var bn={connect:function(e,t,n){return fn=0,wn={},mn(3),new Promise((l=>{un=new WebSocket(e,n+"|"+t),un.onopen=e=>{mn(2),yn([Ce])},un.onmessage=e=>{const t=JSON.parse(e.data),i=t[0];if(i===ve){const e=t[1];l(e)}else{if(i!==we)throw`[ 2021-05-09 invalid connect msgType ${i} ]`;{const e=t[1],l=t[2];if(e===n&&wn[l])return void delete wn[l];gn(t)}}},un.onerror=e=>{throw mn(1),"[ 2021-05-15 onerror ]"},un.onclose=e=>{4e3===e.code||1001===e.code?mn(4):mn(1)}}))},connectReplay:function(e,t,n){return fn=0,wn={},mn(3),new Promise((l=>{un=new WebSocket(e,n+"|"+t),un.onopen=e=>{mn(2),vn(0,1e4)},un.onmessage=e=>{const t=JSON.parse(e.data),n=t[0];if(n!==be)throw`[ 2021-05-09 invalid connectReplay msgType ${n} ]`;{const e=t[1],n=t[2];if(null!==n){l({game:n,log:e})}else gn(t)}},un.onerror=e=>{throw mn(1),"[ 2021-05-15 onerror ]"},un.onclose=e=>{4e3===e.code||1001===e.code?mn(4):mn(1)}}))},requestReplayData:vn,disconnect:function(){un&&un.close(4e3),fn=0,wn={}},sendClientEvent:function(e){fn++,wn[fn]=e,yn([xe,fn,wn[fn]])},onServerChange:function(e){gn=e},onConnectionStateChange:function(e){pn=e},CODE_CUSTOM_DISCONNECT:4e3,CONN_STATE_NOT_CONNECTED:0,CONN_STATE_DISCONNECTED:1,CONN_STATE_CLOSED:4,CONN_STATE_CONNECTED:2,CONN_STATE_CONNECTING:3},xn=e({name:"connection-overlay",emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===bn.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===bn.CONN_STATE_CONNECTING},show(){return!(!this.lostConnection&&!this.connecting)}}});const Cn={key:0,class:"overlay connection-lost"},kn={key:0,class:"overlay-content"},An=n("div",null,"⁉️ LOST CONNECTION ⁉️",-1),Tn={key:1,class:"overlay-content"},Sn=n("div",null,"Connecting...",-1);xn.render=function(e,l,o,s,r,d){return e.show?(a(),t("div",Cn,[e.lostConnection?(a(),t("div",kn,[An,n("span",{class:"btn",onClick:l[1]||(l[1]=t=>e.$emit("reconnect"))},"Reconnect")])):i("",!0),e.connecting?(a(),t("div",Tn,[Sn])):i("",!0)])):i("",!0)};var zn=e({name:"help-overlay",emits:{bgclick:null}});const In=n("tr",null,[n("td",null,"⬆️ Move up:"),n("td",null,[n("div",null,[n("kbd",null,"W"),s("/"),n("kbd",null,"↑"),s("/🖱️")])])],-1),Pn=n("tr",null,[n("td",null,"⬇️ Move down:"),n("td",null,[n("div",null,[n("kbd",null,"S"),s("/"),n("kbd",null,"↓"),s("/🖱️")])])],-1),_n=n("tr",null,[n("td",null,"⬅️ Move left:"),n("td",null,[n("div",null,[n("kbd",null,"A"),s("/"),n("kbd",null,"←"),s("/🖱️")])])],-1),Dn=n("tr",null,[n("td",null,"➡️ Move right:"),n("td",null,[n("div",null,[n("kbd",null,"D"),s("/"),n("kbd",null,"→"),s("/🖱️")])])],-1),Bn=n("tr",null,[n("td"),n("td",null,[n("div",null,[s("Move faster by holding "),n("kbd",null,"Shift")])])],-1),En=n("tr",null,[n("td",null,"🔍+ Zoom in:"),n("td",null,[n("div",null,[n("kbd",null,"E"),s("/🖱️-Wheel")])])],-1),On=n("tr",null,[n("td",null,"🔍- Zoom out:"),n("td",null,[n("div",null,[n("kbd",null,"Q"),s("/🖱️-Wheel")])])],-1),Un=n("tr",null,[n("td",null,"🖼️ Toggle preview:"),n("td",null,[n("div",null,[n("kbd",null,"Space")])])],-1),Nn=n("tr",null,[n("td",null,"🧩✔️ Toggle fixed pieces:"),n("td",null,[n("div",null,[n("kbd",null,"F")])])],-1),Mn=n("tr",null,[n("td",null,"🧩❓ Toggle loose pieces:"),n("td",null,[n("div",null,[n("kbd",null,"G")])])],-1);zn.render=function(e,l,i,o,s,r){return a(),t("div",{class:"overlay transparent",onClick:l[2]||(l[2]=t=>e.$emit("bgclick"))},[n("table",{class:"overlay-content help",onClick:l[1]||(l[1]=u((()=>{}),["stop"]))},[In,Pn,_n,Dn,Bn,En,On,Un,Nn,Mn])])};var Gn=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg=="}),Rn=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII="}),$n=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII="}),Vn=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII="});function jn(){let e=0,t=0,n=1;const l=(l,i)=>{e+=l/n,t+=i/n},i=e=>{const t=n+.05*n*("in"===e?1:-1);return Math.min(Math.max(t,.1),6)},o=l=>({x:l.x/n-e,y:l.y/n-t}),a=l=>({x:(l.x+e)*n,y:(l.y+t)*n}),s=e=>({w:e.w*n,h:e.h*n});return{move:l,canZoom:e=>n!=i(e),zoom:(e,t)=>((e,t)=>{if(n==e)return!1;const i=1-n/e;return l(-t.x*i,-t.y*i),n=e,!0})(i(e),t),worldToViewport:e=>{const{x:t,y:n}=a(e);return{x:Math.round(t),y:Math.round(n)}},worldToViewportRaw:a,worldDimToViewport:e=>{const{w:t,h:n}=s(e);return{w:Math.round(t),h:Math.round(n)}},worldDimToViewportRaw:s,viewportToWorld:e=>{const{x:t,y:n}=o(e);return{x:Math.round(t),y:Math.round(n)}},viewportToWorldRaw:o}}function Fn(e=0,t=0){const n=document.createElement("canvas");return n.width=e,n.height=t,n}var Ln={createCanvas:Fn,loadImageToBitmap:async function(e){return new Promise((t=>{const n=new Image;n.onload=()=>{createImageBitmap(n).then(t)},n.src=e}))},resizeBitmap:async function(e,t,n){const l=Fn(t,n);return l.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,n),await createImageBitmap(l)},colorizedCanvas:function(e,t,n){const l=Fn(e.width,e.height),i=l.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=n,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),l}};const Wn=je("Debug.js");let qn=0,Hn=0;var Qn=e=>{qn=performance.now(),Hn=e},Yn=e=>{const t=performance.now(),n=t-qn;n>Hn&&Wn.log(e+": "+n),qn=t};const Kn=je("PuzzleGraphics.js");function Zn(e,t){const n=He.coordByTileIdx(e,t);return{x:n.x*e.tileSize,y:n.y*e.tileSize,w:e.tileSize,h:e.tileSize}}var Jn={loadPuzzleBitmaps:async function(e){const t=await Ln.loadImageToBitmap(e.info.imageUrl),n=await Ln.resizeBitmap(t,e.info.width,e.info.height);return await async function(e,t,n){Kn.log("start createPuzzleTileBitmaps");var l=n.tileSize,i=n.tileMarginWidth,o=n.tileDrawSize,a=l/100,s=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0];const r=new Array(t.length),d={};function c(e){const t=`${e.top}${e.right}${e.left}${e.bottom}`;if(d[t])return d[t];const n=new Path2D,o={x:i,y:i},r=fe.pointAdd(o,{x:l,y:0}),c=fe.pointAdd(r,{x:0,y:l}),u=fe.pointSub(c,{x:l,y:0});if(n.moveTo(o.x,o.y),0!==e.top)for(let l=0;l<s.length/6;l++){const t=fe.pointAdd(o,{x:s[6*l+0]*a,y:e.top*s[6*l+1]*a}),i=fe.pointAdd(o,{x:s[6*l+2]*a,y:e.top*s[6*l+3]*a}),r=fe.pointAdd(o,{x:s[6*l+4]*a,y:e.top*s[6*l+5]*a});n.bezierCurveTo(t.x,t.y,i.x,i.y,r.x,r.y)}else n.lineTo(r.x,r.y);if(0!==e.right)for(let l=0;l<s.length/6;l++){const t=fe.pointAdd(r,{x:-e.right*s[6*l+1]*a,y:s[6*l+0]*a}),i=fe.pointAdd(r,{x:-e.right*s[6*l+3]*a,y:s[6*l+2]*a}),o=fe.pointAdd(r,{x:-e.right*s[6*l+5]*a,y:s[6*l+4]*a});n.bezierCurveTo(t.x,t.y,i.x,i.y,o.x,o.y)}else n.lineTo(c.x,c.y);if(0!==e.bottom)for(let l=0;l<s.length/6;l++){let t=fe.pointSub(c,{x:s[6*l+0]*a,y:e.bottom*s[6*l+1]*a}),i=fe.pointSub(c,{x:s[6*l+2]*a,y:e.bottom*s[6*l+3]*a}),o=fe.pointSub(c,{x:s[6*l+4]*a,y:e.bottom*s[6*l+5]*a});n.bezierCurveTo(t.x,t.y,i.x,i.y,o.x,o.y)}else n.lineTo(u.x,u.y);if(0!==e.left)for(let l=0;l<s.length/6;l++){let t=fe.pointSub(u,{x:-e.left*s[6*l+1]*a,y:s[6*l+0]*a}),i=fe.pointSub(u,{x:-e.left*s[6*l+3]*a,y:s[6*l+2]*a}),o=fe.pointSub(u,{x:-e.left*s[6*l+5]*a,y:s[6*l+4]*a});n.bezierCurveTo(t.x,t.y,i.x,i.y,o.x,o.y)}else n.lineTo(o.x,o.y);return d[t]=n,n}const u=Ln.createCanvas(o,o),g=u.getContext("2d"),p=Ln.createCanvas(o,o),h=p.getContext("2d");for(const m of t){const t=He.decodeTile(m),l=Zn(n,t.idx),a=c(He.decodeShape(n.shapes[t.idx]));g.clearRect(0,0,o,o),g.save(),g.lineWidth=2,g.stroke(a),g.globalCompositeOperation="source-in",g.drawImage(e,l.x-i,l.y-i,o,o,0,0,o,o),g.restore(),g.save(),g.globalCompositeOperation="source-in",g.globalAlpha=.2,g.fillStyle="black",g.fillRect(0,0,u.width,u.height),g.restore(),g.save(),g.clip(a),g.drawImage(e,l.x-i,l.y-i,o,o,0,0,o,o),g.restore(),g.save(),g.clip(a),g.strokeStyle="rgba(0,0,0,.4)",g.lineWidth=0,g.shadowColor="black",g.shadowBlur=2,g.shadowOffsetX=-1,g.shadowOffsetY=-1,g.stroke(a),g.restore(),g.save(),g.clip(a),g.strokeStyle="rgba(255,255,255,.4)",g.lineWidth=0,g.shadowColor="white",g.shadowBlur=2,g.shadowOffsetX=1,g.shadowOffsetY=1,g.stroke(a),g.restore(),h.clearRect(0,0,o,o),h.save(),h.lineWidth=1,h.stroke(a),h.globalCompositeOperation="source-in",h.drawImage(e,l.x-i,l.y-i,o,o,0,0,o,o),h.restore(),g.drawImage(p,0,0),r[t.idx]=await createImageBitmap(u)}return Kn.log("end createPuzzleTileBitmaps"),r}(n,e.tiles,e.info)}};let Xn=-10,el=20,tl=2,nl=15;class ll{constructor(e){this.radius=10,this.previousRadius=10,this.explodingDuration=100,this.hasExploded=!1,this.alive=!0,this.color=function(e){return"rgba("+e.random(0,255)+","+e.random(0,255)+","+e.random(0,255)+", 0.8)"}(e),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=Xn+Math.random()*el,this.vy=-1*(tl+Math.random()*nl),this.duration=0}update(e){if(this.hasExploded){const e=200-this.radius;this.previousRadius=this.radius,this.radius+=e/10,this.explodingDuration--,0==this.explodingDuration&&(this.alive=!1)}else this.vx+=0,this.vy+=1,this.vy>=0&&e&&this.explode(e),this.px+=this.vx,this.py+=this.vy}draw(e){e.beginPath(),e.arc(this.px,this.py,this.previousRadius,0,2*Math.PI,!1),this.hasExploded||(e.fillStyle=this.color,e.lineWidth=1,e.fill())}explode(e){this.hasExploded=!0;const t=3+Math.floor(3*Math.random());for(let n=0;n<t;n++){const t=10+Math.floor(21*Math.random()),n=5+5*Math.random(),l=2*Math.PI/t,i=Math.random()*l;for(let o=0;o<t;o++)e.push(new il(this,o*l+i,n))}}}class il{constructor(e,t,n){this.px=e.px,this.py=e.py,this.vx=Math.cos(t)*n,this.vy=Math.sin(t)*n,this.color=e.color,this.duration=40+Math.floor(20*Math.random()),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=.1,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(e){e.beginPath(),e.arc(this.px,this.py,this.radius,0,2*Math.PI,!1),e.fillStyle=this.color,e.lineWidth=1,e.fill()}}class ol{constructor(e,t){this.canvas=e,this.rng=t,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",(()=>{this.resize()}))}setSpeedParams(){let e=0,t=0;for(;e<this.canvas.height&&t>=0;)t+=1,e+=t;tl=t/2,nl=t-tl;const n=1/4*this.canvas.width/(t/2);Xn=-n,el=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let e=0;e<1;e++)this.readyBombs.push(new ll(this.rng))}update(){100*Math.random()<5&&this.readyBombs.push(new ll(this.rng));const e=[];for(;this.explodedBombs.length>0;){const t=this.explodedBombs.shift();if(!t)break;t.update(),t.alive&&e.push(t)}this.explodedBombs=e;const t=[];for(;this.readyBombs.length>0;){const e=this.readyBombs.shift();if(!e)break;e.update(this.particles),e.hasExploded?this.explodedBombs.push(e):t.push(e)}this.readyBombs=t;const n=[];for(;this.particles.length>0;){const e=this.particles.shift();if(!e)break;e.update(),e.alive&&n.push(e)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let e=0;e<this.readyBombs.length;e++)this.readyBombs[e].draw(this.ctx);for(let e=0;e<this.explodedBombs.length;e++)this.explodedBombs[e].draw(this.ctx);for(let e=0;e<this.particles.length;e++)this.particles[e].draw(this.ctx)}}const al={"./grab.png":Gn,"./grab_mask.png":Rn,"./hand.png":$n,"./hand_mask.png":Vn};let sl=!0,rl=!0;let dl=!0;async function cl(e,t,n,l,i,o){void 0===window.DEBUG&&(window.DEBUG=!1);const a=await Ln.loadImageToBitmap(al["./grab.png"].default),s=await Ln.loadImageToBitmap(al["./hand.png"].default),r=await Ln.loadImageToBitmap(al["./grab_mask.png"].default),d=await Ln.loadImageToBitmap(al["./hand_mask.png"].default),c=a.width,u=Math.round(c/2),g=a.height,p=Math.round(g/2),h={},m=async e=>{const t=e.color+" "+e.d;if(!h[t]){const n=e.d?a:s;if(e.color){const l=e.d?r:d;h[t]=await createImageBitmap(Ln.colorizedCanvas(n,l,e.color))}else h[t]=n}return h[t]},y=function(e,t){return t.width=window.innerWidth,t.height=window.innerHeight,e.appendChild(t),window.addEventListener("resize",(()=>{t.width=window.innerWidth,t.height=window.innerHeight,dl=!0})),t}(i,Ln.createCanvas()),f={final:!1,requesting:!0,log:[],logPointer:0,logIdx:0,speeds:[.5,1,2,5,10,20,50],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0};bn.onConnectionStateChange((e=>{o.setConnectionState(e)}));let w=()=>0;const v=async()=>{if("play"===l){const l=await bn.connect(n,e,t),i=He.decodeGame(l);Pt.setGame(i.id,i),w=()=>D()}else{if("replay"!==l)throw"[ 2020-12-22 MODE invalid, must be play|replay ]";{bn.onServerChange((e=>{const t=e[1];f.log=f.log.slice(f.logPointer),f.logPointer=0,f.log.push(...e[1]),t.length<1e4&&(f.final=!0),f.requesting=!1}));const l=await bn.connectReplay(n,e,t),i=He.decodeGame(l.game);Pt.setGame(i.id,i),f.requesting=!1,f.log=l.log,f.lastRealTs=D(),f.gameStartTs=parseInt(f.log[0][4],10),f.lastGameTs=f.gameStartTs,w=()=>f.lastGameTs}}dl=!0};await v();const b=Pt.getTileDrawOffset(e),x=Pt.getTileDrawSize(e),C=Pt.getPuzzleWidth(e),k=Pt.getPuzzleHeight(e),A=Pt.getTableWidth(e),T=Pt.getTableHeight(e),S={x:(A-C)/2,y:(T-k)/2},z={w:C,h:k},I={w:x,h:x},P=await Jn.loadPuzzleBitmaps(Pt.getPuzzle(e)),_=new ol(y,Pt.getRng(e));_.init();const B=y.getContext("2d");y.classList.add("loaded");const E=jn();E.move(-(A-y.width)/2,-(T-y.height)/2);const O=function(e,t,n){let l=[],i=!0,o=!1,a=!1,s=!1,r=!1,d=!1,c=!1,u=!1;const g=(e,t)=>{const l=n.viewportToWorld({x:e,y:t});return[l.x,l.y]},p=e=>g(e.offsetX,e.offsetY),h=()=>g(e.width/2,e.height/2),m=(e,t)=>{i&&("Shift"===t.key?u=e:"ArrowUp"===t.key||"w"===t.key||"W"===t.key?s=e:"ArrowDown"===t.key||"s"===t.key||"S"===t.key?r=e:"ArrowLeft"===t.key||"a"===t.key||"A"===t.key?o=e:"ArrowRight"===t.key||"d"===t.key||"D"===t.key?a=e:"q"===t.key?c=e:"e"===t.key&&(d=e))};e.addEventListener("mousedown",(e=>{0===e.button&&y([Ie,...p(e)])})),e.addEventListener("mouseup",(e=>{0===e.button&&y([Pe,...p(e)])})),e.addEventListener("mousemove",(e=>{y([_e,...p(e)])})),e.addEventListener("wheel",(e=>{if(n.canZoom(e.deltaY<0?"in":"out")){const t=e.deltaY<0?De:Be;y([t,...p(e)])}})),t.addEventListener("keydown",(e=>m(!0,e))),t.addEventListener("keyup",(e=>m(!1,e))),t.addEventListener("keypress",(e=>{i&&(" "===e.key&&y([Ne]),"F"!==e.key&&"f"!==e.key||(sl=!sl,dl=!0),"G"!==e.key&&"g"!==e.key||(rl=!rl,dl=!0))}));const y=e=>{l.push(e)};return{addEvent:y,consumeAll:()=>{if(0===l.length)return[];const e=l.slice();return l=[],e},createKeyEvents:()=>{const e=u?20:10,t=(o?e:0)-(a?e:0),l=(s?e:0)-(r?e:0);0===t&&0===l||y([ze,t,l]),d&&c||(d?n.canZoom("in")&&y([De,...h()]):c&&n.canZoom("out")&&y([Be,...h()]))},setHotkeys:e=>{i=e}}}(y,window,E),U=Pt.getImageUrl(e),N=()=>{const t=Pt.getStartTs(e),n=Pt.getFinishTs(e),l=w();o.setFinished(!!n),o.setDuration((n||l)-t)};N(),o.setPiecesDone(Pt.getFinishedTileCount(e)),o.setPiecesTotal(Pt.getTileCount(e));const M=w();o.setActivePlayers(Pt.getActivePlayers(e,M)),o.setIdlePlayers(Pt.getIdlePlayers(e,M));const G=!!Pt.getFinishTs(e);let R=G;const $=()=>R&&!G,V=()=>Pt.getPlayerBgColor(e,t)||localStorage.getItem("bg_color")||"#222222",j=()=>Pt.getPlayerColor(e,t)||localStorage.getItem("player_color")||"#ffffff";let F="",L="",W=!1;const q=e=>{W=e;const[t,n]=e?[F,"grab"]:[L,"default"];y.style.cursor=`url('${t}') ${u} ${p}, ${n}`},H=e=>{F=Ln.colorizedCanvas(a,r,e).toDataURL(),L=Ln.colorizedCanvas(s,d,e).toDataURL(),q(W)};H(j());const Q=()=>{o.setReplaySpeed&&o.setReplaySpeed(f.speeds[f.speedIdx]),o.setReplayPaused&&o.setReplayPaused(f.paused)};if("play"===l?setInterval(N,1e3):"replay"===l&&Q(),"play"===l)bn.onServerChange((n=>{n[0],n[1],n[2];const l=n[3];for(const[i,o]of l)switch(i){case Re:{const n=He.decodePlayer(o);n.id!==t&&(Pt.setPlayer(e,n.id,n),dl=!0)}break;case Ge:{const t=He.decodeTile(o);Pt.setTile(e,t.idx,t),dl=!0}break;case Me:Pt.setPuzzleData(e,o),dl=!0}R=!!Pt.getFinishTs(e)}));else if("replay"===l){let t=setInterval((()=>{const n=D();if(f.requesting)return void(f.lastRealTs=n);if(f.logPointer+1>=f.log.length)return f.lastRealTs=n,f.requesting=!0,void bn.requestReplayData(f.logIdx,1e4);if(f.paused)return void(f.lastRealTs=n);const l=(n-f.lastRealTs)*f.speeds[f.speedIdx],i=f.lastGameTs+l;for(;;){if(f.paused)break;const n=f.logPointer+1;if(n>=f.log.length){f.final&&clearInterval(t);break}const l=f.log[n],o=f.gameStartTs+l[l.length-1];if(o>i)break;const a=l.slice();if(a[0]===Ae){const t=a[1];Pt.addPlayer(e,t,o),dl=!0}else if(a[0]===Te){const t=Pt.getPlayerIdByIndex(e,a[1]);if(!t)throw"[ 2021-05-17 player not found (update player) ]";Pt.addPlayer(e,t,o),dl=!0}else if(a[0]===Se){const t=Pt.getPlayerIdByIndex(e,a[1]);if(!t)throw"[ 2021-05-17 player not found (handle input) ]";const n=a[2];Pt.handleInput(e,t,n,o),dl=!0}f.logPointer=n,f.logIdx++}f.lastRealTs=n,f.lastGameTs=i,N()}),50)}let Y=null;return(e=>{const t=e.fps||60,n=e.slow||1,l=e.update,i=e.render,o=window.requestAnimationFrame,a=1/t,s=n*a;let r,d=0,c=window.performance.now();const u=()=>{for(r=window.performance.now(),d+=Math.min(1,(r-c)/1e3);d>s;)d-=s,l(a);i(d/n),c=r,o(u)};o(u)})({update:()=>{O.createKeyEvents();for(const n of O.consumeAll())if("play"===l){const l=n[0];if(l===ze){const e=n[1],t=n[2];dl=!0,E.move(e,t)}else if(l===_e){if(Y&&!Pt.getFirstOwnedTile(e,t)){const e={x:n[1],y:n[2]},t=E.worldToViewport(e),l=Math.round(t.x-Y.x),i=Math.round(t.y-Y.y);dl=!0,E.move(l,i),Y=t}}else if(l===Oe)H(n[1]);else if(l===Ie){const e={x:n[1],y:n[2]};Y=E.worldToViewport(e),q(!0)}else if(l===Pe)Y=null,q(!1);else if(l===De){const e={x:n[1],y:n[2]};dl=!0,E.zoom("in",E.worldToViewport(e))}else if(l===Be){const e={x:n[1],y:n[2]};dl=!0,E.zoom("out",E.worldToViewport(e))}else l===Ne&&o.togglePreview();const i=w();Pt.handleInput(e,t,n,i).length>0&&(dl=!0),bn.sendClientEvent(n)}else if("replay"===l){const e=n[0];if(e===ze){const e=n[1],t=n[2];dl=!0,E.move(e,t)}else if(e===_e){if(Y){const e={x:n[1],y:n[2]},t=E.worldToViewport(e),l=Math.round(t.x-Y.x),i=Math.round(t.y-Y.y);dl=!0,E.move(l,i),Y=t}}else if(e===Ie){const e={x:n[1],y:n[2]};Y=E.worldToViewport(e)}else if(e===Pe)Y=null;else if(e===De){const e={x:n[1],y:n[2]};dl=!0,E.zoom("in",E.worldToViewport(e))}else if(e===Be){const e={x:n[1],y:n[2]};dl=!0,E.zoom("out",E.worldToViewport(e))}else e===Ne&&o.togglePreview()}R=!!Pt.getFinishTs(e),$()&&(_.update(),dl=!0)},render:async()=>{if(!dl)return;const n=w();let i,a,s;window.DEBUG&&Qn(0),B.fillStyle=V(),B.fillRect(0,0,y.width,y.height),window.DEBUG&&Yn("clear done"),i=E.worldToViewportRaw(S),a=E.worldDimToViewportRaw(z),B.fillStyle="rgba(255, 255, 255, .3)",B.fillRect(i.x,i.y,a.w,a.h),window.DEBUG&&Yn("board done");const r=Pt.getTilesSortedByZIndex(e);window.DEBUG&&Yn("get tiles done"),a=E.worldDimToViewportRaw(I);for(const e of r)(-1===e.owner?sl:rl)&&(s=P[e.idx],i=E.worldToViewportRaw({x:b+e.pos.x,y:b+e.pos.y}),B.drawImage(s,0,0,s.width,s.height,i.x,i.y,a.w,a.h));window.DEBUG&&Yn("tiles done");const d=[];for(const o of Pt.getActivePlayers(e,n))c=o,("replay"===l||c.id!==t)&&(s=await m(o),i=E.worldToViewport(o),B.drawImage(s,i.x-u,i.y-p),d.push([`${o.name} (${o.points})`,i.x,i.y+g]));var c;B.fillStyle="white",B.textAlign="center";for(const[e,t,l]of d)B.fillText(e,t,l);window.DEBUG&&Yn("players done"),o.setActivePlayers(Pt.getActivePlayers(e,n)),o.setIdlePlayers(Pt.getIdlePlayers(e,n)),o.setPiecesDone(Pt.getFinishedTileCount(e)),window.DEBUG&&Yn("HUD done"),$()&&_.render(),dl=!1}}),{setHotkeys:e=>{O.setHotkeys(e)},onBgChange:e=>{localStorage.setItem("bg_color",e),O.addEvent([Ee,e])},onColorChange:e=>{localStorage.setItem("player_color",e),O.addEvent([Oe,e])},onNameChange:e=>{localStorage.setItem("player_name",e),O.addEvent([Ue,e])},replayOnSpeedUp:()=>{f.speedIdx+1<f.speeds.length&&(f.speedIdx++,Q())},replayOnSpeedDown:()=>{f.speedIdx>=1&&(f.speedIdx--,Q())},replayOnPauseToggle:()=>{f.paused=!f.paused,Q()},previewImageUrl:U,player:{background:V(),color:j(),name:Pt.getPlayerName(e,t)||localStorage.getItem("player_name")||"anon"},disconnect:bn.disconnect,connect:v}}var ul=e({name:"game",components:{PuzzleStatus:tn,Scores:Kt,SettingsOverlay:ln,PreviewOverlay:rn,ConnectionOverlay:xn,HelpOverlay:zn},data:()=>({activePlayers:[],idlePlayers:[],finished:!1,duration:0,piecesDone:0,piecesTotal:0,overlay:"",connectionState:0,g:{player:{background:"",color:"",name:""},previewImageUrl:"",setHotkeys:e=>{},onBgChange:e=>{},onColorChange:e=>{},onNameChange:e=>{},disconnect:()=>{},connect:()=>{}}}),async mounted(){this.$route.params.id&&(this.$watch((()=>this.g.player.background),(e=>{this.g.onBgChange(e)})),this.$watch((()=>this.g.player.color),(e=>{this.g.onColorChange(e)})),this.$watch((()=>this.g.player.name),(e=>{this.g.onNameChange(e)})),this.g=await cl(`${this.$route.params.id}`,this.$clientId,this.$config.WS_ADDRESS,"play",this.$el,{setActivePlayers:e=>{this.activePlayers=e},setIdlePlayers:e=>{this.idlePlayers=e},setFinished:e=>{this.finished=e},setDuration:e=>{this.duration=e},setPiecesDone:e=>{this.piecesDone=e},setPiecesTotal:e=>{this.piecesTotal=e},setConnectionState:e=>{this.connectionState=e},togglePreview:()=>{this.toggle("preview",!1)}}))},unmounted(){this.g.disconnect()},methods:{reconnect(){this.g.connect()},toggle(e,t){""===this.overlay?(this.overlay=e,t&&this.g.setHotkeys(!1)):(this.overlay="",t&&this.g.setHotkeys(!0))}}});const gl={id:"game"},pl={class:"menu"},hl={class:"tabs"},ml=s("🧩 Puzzles");ul.render=function(e,i,s,r,d,c){const u=o("settings-overlay"),p=o("preview-overlay"),h=o("help-overlay"),m=o("connection-overlay"),y=o("puzzle-status"),f=o("router-link"),w=o("scores");return a(),t("div",gl,[g(n(u,{onBgclick:i[1]||(i[1]=t=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":i[2]||(i[2]=t=>e.g.player=t)},null,8,["modelValue"]),[[v,"settings"===e.overlay]]),g(n(p,{onBgclick:i[3]||(i[3]=t=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[v,"preview"===e.overlay]]),g(n(h,{onBgclick:i[4]||(i[4]=t=>e.toggle("help",!0))},null,512),[[v,"help"===e.overlay]]),n(m,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),n(y,{finished:e.finished,duration:e.duration,piecesDone:e.piecesDone,piecesTotal:e.piecesTotal},null,8,["finished","duration","piecesDone","piecesTotal"]),n("div",pl,[n("div",hl,[n(f,{class:"opener",to:{name:"index"},target:"_blank"},{default:l((()=>[ml])),_:1}),n("div",{class:"opener",onClick:i[5]||(i[5]=t=>e.toggle("preview",!1))},"🖼️ Preview"),n("div",{class:"opener",onClick:i[6]||(i[6]=t=>e.toggle("settings",!0))},"🛠️ Settings"),n("div",{class:"opener",onClick:i[7]||(i[7]=t=>e.toggle("help",!0))},"ℹ️ Help")])]),n(w,{activePlayers:e.activePlayers,idlePlayers:e.idlePlayers},null,8,["activePlayers","idlePlayers"])])};var yl=e({name:"replay",components:{PuzzleStatus:tn,Scores:Kt,SettingsOverlay:ln,PreviewOverlay:rn,HelpOverlay:zn},data:()=>({activePlayers:[],idlePlayers:[],finished:!1,duration:0,piecesDone:0,piecesTotal:0,overlay:"",connectionState:0,g:{player:{background:"",color:"",name:""},previewImageUrl:"",setHotkeys:e=>{},onBgChange:e=>{},onColorChange:e=>{},onNameChange:e=>{},replayOnSpeedUp:()=>{},replayOnSpeedDown:()=>{},replayOnPauseToggle:()=>{},disconnect:()=>{}},replay:{speed:1,paused:!1}}),async mounted(){this.$route.params.id&&(this.$watch((()=>this.g.player.background),(e=>{this.g.onBgChange(e)})),this.$watch((()=>this.g.player.color),(e=>{this.g.onColorChange(e)})),this.$watch((()=>this.g.player.name),(e=>{this.g.onNameChange(e)})),this.g=await cl(`${this.$route.params.id}`,this.$clientId,this.$config.WS_ADDRESS,"replay",this.$el,{setActivePlayers:e=>{this.activePlayers=e},setIdlePlayers:e=>{this.idlePlayers=e},setFinished:e=>{this.finished=e},setDuration:e=>{this.duration=e},setPiecesDone:e=>{this.piecesDone=e},setPiecesTotal:e=>{this.piecesTotal=e},togglePreview:()=>{this.toggle("preview",!1)},setConnectionState:e=>{this.connectionState=e},setReplaySpeed:e=>{this.replay.speed=e},setReplayPaused:e=>{this.replay.paused=e}}))},unmounted(){this.g.disconnect()},methods:{toggle(e,t){""===this.overlay?(this.overlay=e,t&&this.g.setHotkeys(!1)):(this.overlay="",t&&this.g.setHotkeys(!0))}},computed:{replayText(){return"Replay-Speed: "+this.replay.speed+"x"+(this.replay.paused?" Paused":"")}}});const fl={id:"replay"},wl={class:"menu"},vl={class:"tabs"},bl=s("🧩 Puzzles");yl.render=function(e,i,s,d,c,u){const p=o("settings-overlay"),h=o("preview-overlay"),m=o("help-overlay"),y=o("puzzle-status"),f=o("router-link"),w=o("scores");return a(),t("div",fl,[g(n(p,{onBgclick:i[1]||(i[1]=t=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":i[2]||(i[2]=t=>e.g.player=t)},null,8,["modelValue"]),[[v,"settings"===e.overlay]]),g(n(h,{onBgclick:i[3]||(i[3]=t=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[v,"preview"===e.overlay]]),g(n(m,{onBgclick:i[4]||(i[4]=t=>e.toggle("help",!0))},null,512),[[v,"help"===e.overlay]]),n(y,{finished:e.finished,duration:e.duration,piecesDone:e.piecesDone,piecesTotal:e.piecesTotal},{default:l((()=>[n("div",null,[n("div",null,r(e.replayText),1),n("button",{class:"btn",onClick:i[5]||(i[5]=t=>e.g.replayOnSpeedUp())},"⏫"),n("button",{class:"btn",onClick:i[6]||(i[6]=t=>e.g.replayOnSpeedDown())},"⏬"),n("button",{class:"btn",onClick:i[7]||(i[7]=t=>e.g.replayOnPauseToggle())},"⏸️")])])),_:1},8,["finished","duration","piecesDone","piecesTotal"]),n("div",wl,[n("div",vl,[n(f,{class:"opener",to:{name:"index"},target:"_blank"},{default:l((()=>[bl])),_:1}),n("div",{class:"opener",onClick:i[8]||(i[8]=t=>e.toggle("preview",!1))},"🖼️ Preview"),n("div",{class:"opener",onClick:i[9]||(i[9]=t=>e.toggle("settings",!0))},"🛠️ Settings"),n("div",{class:"opener",onClick:i[10]||(i[10]=t=>e.toggle("help",!0))},"ℹ️ Help")])]),n(w,{activePlayers:e.activePlayers,idlePlayers:e.idlePlayers},null,8,["activePlayers","idlePlayers"])])},(async()=>{const e=await fetch("/api/conf"),t=await e.json();const n=b({history:x(),routes:[{name:"index",path:"/",component:$},{name:"new-game",path:"/new-game",component:$t},{name:"game",path:"/g/:id",component:ul},{name:"replay",path:"/replay/:id",component:yl}]});n.beforeEach(((e,t)=>{t.name&&document.documentElement.classList.remove(`view-${String(t.name)}`),document.documentElement.classList.add(`view-${String(e.name)}`)}));const l=C(k);l.config.globalProperties.$config=t,l.config.globalProperties.$clientId=function(){let e=localStorage.getItem("ID");return e||(e=He.uniqId(),localStorage.setItem("ID",e)),e}(),l.use(n),l.mount("#app")})();
