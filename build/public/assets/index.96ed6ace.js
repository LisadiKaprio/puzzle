import{d as oe,r as N,o as h,c as v,a as o,b as j,w as re,e as W,f as A,g as ie,n as De,t as B,F as ae,h as me,i as je,j as H,v as Oe,k as Ze,l as be,m as Po,p as it,q as Co,s as So,u as Us,x as bo,y as To,z as $o,A as Ao,B as Oo,C as No}from"./vendor.aab1bbba.js";const ko=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}};ko();var J=(e,t)=>{const s=e.__vccOpts||e;for(const[n,i]of t)s[n]=i;return s};const Uo=oe({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),Ro={id:"app"},Vo={key:0,class:"nav"},Lo=A("Games overview"),Mo=A("New game");function Do(e,t,s,n,i,r){const a=N("router-link"),u=N("router-view");return h(),v("div",Ro,[e.showNav?(h(),v("ul",Vo,[o("li",null,[j(a,{class:"btn",to:{name:"index"}},{default:re(()=>[Lo]),_:1})]),o("li",null,[j(a,{class:"btn",to:{name:"new-game"}},{default:re(()=>[Mo]),_:1})])])):W("",!0),j(u)])}var zo=J(Uo,[["render",Do]]);class ut{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,s){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const n=(this.rand_high>>>0)/4294967295;return t+n*(s-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const s=t.slice();for(let n=0;n<=s.length-2;n++){const i=this.random(n,s.length-1),r=s[n];s[n]=s[i],s[i]=r}return s}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const s=new ut(0);return s.rand_high=t.rand_high,s.rand_low=t.rand_low,s}}const Go=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},ot=(e,t)=>{const s=`${e}`;return s.length>=t.length?s:t.substr(0,t.length-s.length)+s},Mt=(...e)=>{const t=s=>(...n)=>{const i=new Date,r=ot(i.getHours(),"00"),a=ot(i.getMinutes(),"00"),u=ot(i.getSeconds(),"00");console[s](`${r}:${a}:${u}`,...e,...n)};return{log:t("log"),error:t("error"),info:t("info")}},Bo=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function Fo(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function Io(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function Yo(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function Wo(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function xo(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function Zo(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function Ho(e){return[e.id,e.rng.type||"",ut.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion,e.private]}function jo(e){return{id:e[0],rng:{type:e[1],obj:ut.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10],private:e[11]}}function Ko(e,t){const s=e.width/e.tileSize;return{x:t%s,y:Math.floor(t/s)}}function qo(e,t){const s=e.width/e.pieceSize;return{x:t%s,y:Math.floor(t/s)}}const Qo=e=>{let t=0;for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);t=(t<<5)-t+n,t|=0}return t};function Xo(e){const t=[];for(const s in e){const n=[s,e[s]].map(encodeURIComponent);t.push(n.join("="))}return t.length===0?"":`?${t.join("&")}`}var D={hash:Qo,slug:Go,pad:ot,uniqId:Bo,encodeShape:Fo,decodeShape:Io,encodePiece:Yo,decodePiece:Wo,encodePlayer:xo,decodePlayer:Zo,encodeGame:Ho,decodeGame:jo,coordByPieceIdxDeprecated:Ko,coordByPieceIdx:qo,asQueryArgs:Xo};const ne={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",OTHER_PLAYER_CLICK_SOUND_ENABLED:"other_player_click_sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},ye={SOUND_VOLUME:100,SOUND_ENABLED:!0,OTHER_PLAYER_CLICK_SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},Rs=()=>({background:"",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0}),Dt=(e,t)=>{localStorage.setItem(e,t)},zt=e=>localStorage.getItem(e),Jo=(e,t)=>{Dt(e,`${t}`)},en=(e,t)=>{const s=zt(e);if(s===null)return t;const n=parseInt(s,10);return isNaN(n)?t:n},tn=(e,t)=>{Dt(e,t?"1":"0")},sn=(e,t)=>{const s=zt(e);return s===null?t:s==="1"},on=(e,t)=>{Dt(e,t)},nn=(e,t)=>{const s=zt(e);return s===null?t:s};var X={setInt:Jo,getInt:en,setBool:tn,getBool:sn,setStr:on,getStr:nn};let wt="",Vs="";const _t=async(e,t,s)=>new Promise((n,i)=>{const r=new window.XMLHttpRequest;r.open(e,t,!0),r.withCredentials=!0;for(const a in s.headers||{})r.setRequestHeader(a,s.headers[a]);r.setRequestHeader("Client-Id",wt),r.setRequestHeader("Client-Secret",Vs),r.addEventListener("load",function(a){n({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),r.addEventListener("error",function(a){i(new Error("xhr error"))}),r.upload&&s.onUploadProgress&&r.upload.addEventListener("progress",function(a){s.onUploadProgress&&s.onUploadProgress(a)}),r.send(s.body||null)}),ws=e=>{let t=X.getStr(e,"");return t||(t=D.uniqId(),X.setStr(e,t)),t};var ge={init:()=>{wt=ws("ID"),Vs=ws("SECRET")},request:_t,get:(e,t)=>_t("get",e,t),post:(e,t)=>_t("post",e,t),clientId:()=>wt};const Ls=1,Gt=Ls*1e3,lt=Gt*60,rt=lt*60,Pt=rt*24,ln=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},Ms=e=>{const t=Math.floor(e/Pt);e=e%Pt;const s=Math.floor(e/rt);e=e%rt;const n=Math.floor(e/lt);e=e%lt;const i=Math.floor(e/Gt);return`${t}d ${s}h ${n}m ${i}s`},rn=(e,t)=>Ms(t-e);var ve={MS:Ls,SEC:Gt,MIN:lt,HOUR:rt,DAY:Pt,timestamp:ln,timeDiffStr:rn,durationStr:Ms};const an=oe({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const s=t?"\u{1F3C1}":"\u23F3",n=e,i=t||ve.timestamp(),r=ve.timeDiffStr(n,i);return`${s} ${r}`}}}),un={class:"game-info-text"},cn=o("br",null,null,-1),dn=o("br",null,null,-1),pn=o("br",null,null,-1),hn=A(" \u21AA\uFE0F Watch replay ");function gn(e,t,s,n,i,r){const a=N("router-link");return h(),v("div",{class:"game-teaser",style:De(e.style)},[j(a,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:re(()=>[o("span",un,[A(" \u{1F9E9} "+B(e.game.piecesFinished)+"/"+B(e.game.piecesTotal),1),cn,A(" \u{1F465} "+B(e.game.players),1),dn,A(" "+B(e.time(e.game.started,e.game.finished)),1),pn])]),_:1},8,["to"]),e.game.hasReplay?(h(),ie(a,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:re(()=>[hn]),_:1},8,["to"])):W("",!0)],4)}var Ds=J(an,[["render",gn]]);const mn=oe({components:{GameTeaser:Ds},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ge.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),fn=o("h1",null,"Running games",-1),yn=o("h1",null,"Finished games",-1);function _n(e,t,s,n,i,r){const a=N("game-teaser");return h(),v("div",null,[fn,(h(!0),v(ae,null,me(e.gamesRunning,(u,m)=>(h(),v("div",{class:"game-teaser-wrap",key:m},[j(a,{game:u},null,8,["game"])]))),128)),yn,(h(!0),v(ae,null,me(e.gamesFinished,(u,m)=>(h(),v("div",{class:"game-teaser-wrap",key:m},[j(a,{game:u},null,8,["game"])]))),128))])}var En=J(mn,[["render",_n]]);const vn=oe({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function wn(e,t,s,n,i,r){const a=N("image-teaser");return h(),v("div",null,[(h(!0),v(ae,null,me(e.images,(u,m)=>(h(),ie(a,{image:u,onClick:y=>e.imageClicked(u),onEditClick:y=>e.imageEditClicked(u),key:m},null,8,["image","onClick","onEditClick"]))),128))])}var zs=J(vn,[["render",wn]]);const Pn=oe({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],isPrivate:!1,droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.isPrivate=!1,this.droppable=!1},imageFromDragEvt(e){var n;const t=(n=e.dataTransfer)==null?void 0:n.items;if(!t||t.length===0)return null;const s=t[0];return s.type.startsWith("image/")?s:null},onFileSelect(e){const t=e.target;if(!t.files)return;const s=t.files[0];!s||this.preview(s)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=s=>{this.previewUrl=s.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags,isPrivate:this.isPrivate}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const s=t.getAsFile();return s&&(this.file=s,this.preview(s),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),Cn=o("div",{class:"drop-target"},null,-1),Sn={key:0,class:"has-image"},bn={key:1},Tn={class:"upload"},$n=o("span",{class:"btn"},"Upload File",-1),An={class:"area-settings"},On=o("td",null,[o("label",null,"Title")],-1),Nn=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),kn=o("td",null,[o("label",null,"Private Image")],-1),Un=o("td",null,[o("label",null,"Tags")],-1),Rn={class:"area-buttons"},Vn=["disabled"],Ln=A("\u{1F5BC}\uFE0F Post to gallery"),Mn=["disabled"],Dn=A("\u{1F9E9} Set up game"),zn=A("\u{1F9E9} Post to gallery "),Gn=o("br",null,null,-1),Bn=A(" + set up game");function Fn(e,t,s,n,i,r){const a=N("responsive-image"),u=N("tags-input"),m=N("overlay");return h(),ie(m,{class:"new-image-dialog"},{default:re(()=>[o("div",{class:je(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...y)=>e.onDrop&&e.onDrop(...y)),onDragover:t[3]||(t[3]=(...y)=>e.onDragover&&e.onDragover(...y)),onDragleave:t[4]||(t[4]=(...y)=>e.onDragleave&&e.onDragleave(...y))},[Cn,e.previewUrl?(h(),v("div",Sn,[o("span",{class:"remove btn",onClick:t[0]||(t[0]=y=>e.previewUrl="")},"X"),j(a,{src:e.previewUrl},null,8,["src"])])):(h(),v("div",bn,[o("label",Tn,[o("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...y)=>e.onFileSelect&&e.onFileSelect(...y)),accept:"image/*"},null,32),$n])]))],34),o("div",An,[o("table",null,[o("tr",null,[On,o("td",null,[H(o("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=y=>e.title=y),placeholder:"Flower by @artist"},null,512),[[Oe,e.title]])])]),Nn,o("tr",null,[kn,o("td",null,[H(o("input",{type:"checkbox","onUpdate:modelValue":t[6]||(t[6]=y=>e.isPrivate=y)},null,512),[[Ze,e.isPrivate]])])]),o("tr",null,[Un,o("td",null,[j(u,{modelValue:e.tags,"onUpdate:modelValue":t[7]||(t[7]=y=>e.tags=y),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",Rn,[e.isPrivate?W("",!0):(h(),v("button",{key:0,class:"btn",disabled:!e.canPostToGallery,onClick:t[8]||(t[8]=(...y)=>e.postToGallery&&e.postToGallery(...y))},[e.uploading==="postToGallery"?(h(),v(ae,{key:0},[A("Uploading ("+B(e.uploadProgressPercent)+"%)",1)],64)):(h(),v(ae,{key:1},[Ln],64))],8,Vn)),o("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[9]||(t[9]=(...y)=>e.setupGameClick&&e.setupGameClick(...y))},[e.uploading==="setupGame"?(h(),v(ae,{key:0},[A("Uploading ("+B(e.uploadProgressPercent)+"%)",1)],64)):e.isPrivate?(h(),v(ae,{key:1},[Dn],64)):(h(),v(ae,{key:2},[zn,Gn,Bn],64))],8,Mn)])]),_:1})}var Gs=J(Pn,[["render",Fn]]);const In=oe({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),Yn={class:"area-image"},Wn={class:"has-image"},xn={class:"area-settings"},Zn=o("td",null,[o("label",null,"Title")],-1),Hn=o("tr",null,[o("td",{colspan:"2"},[o("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),jn=o("td",null,[o("label",null,"Tags")],-1),Kn={class:"area-buttons"};function qn(e,t,s,n,i,r){const a=N("responsive-image"),u=N("tags-input"),m=N("overlay");return h(),ie(m,{class:"edit-image-dialog"},{default:re(()=>[o("div",Yn,[o("div",Wn,[j(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),o("div",xn,[o("table",null,[o("tr",null,[Zn,o("td",null,[H(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=y=>e.title=y),placeholder:"Flower by @artist"},null,512),[[Oe,e.title]])])]),Hn,o("tr",null,[jn,o("td",null,[j(u,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=y=>e.tags=y),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),o("div",Kn,[o("button",{class:"btn",onClick:t[2]||(t[2]=(...y)=>e.saveImage&&e.saveImage(...y))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var Bs=J(In,[["render",qn]]),Ne=(e=>(e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY",e))(Ne||{}),He=(e=>(e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT",e))(He||{}),ze=(e=>(e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL",e))(ze||{});const Qn=oe({props:{image:{type:Object,required:!0},forcePrivate:{type:Boolean,default:!1}},emits:{newGame:null},data(){return{tiles:1e3,isPrivate:!1,scoreMode:Ne.ANY,shapeMode:He.NORMAL,snapMode:ze.NORMAL}},mounted(){this.isPrivate=this.forcePrivate},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,private:this.isPrivate,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Xn={class:"area-image"},Jn={class:"has-image"},ei={key:0,class:"image-title"},ti={key:0,class:"image-title-title"},si={key:1,class:"image-title-dim"},oi={class:"area-settings"},ni=o("td",null,[o("label",null,"Pieces")],-1),ii=o("td",null,[o("label",null,"Scoring: ")],-1),li=A(" Any (Score when pieces are connected to each other or on final location)"),ri=o("br",null,null,-1),ai=A(" Final (Score when pieces are put to their final location)"),ui=o("td",null,[o("label",null,"Shapes: ")],-1),ci=A(" Normal"),di=o("br",null,null,-1),pi=A(" Any (Flat pieces can occur anywhere)"),hi=o("br",null,null,-1),gi=A(" Flat (All pieces flat on all sides)"),mi=o("td",null,[o("label",null,"Snapping: ")],-1),fi=A(" Normal (Pieces snap to final destination and to each other)"),yi=o("br",null,null,-1),_i=A(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),Ei=o("td",null,[o("label",null,"Private Game")],-1),vi=["disabled"],wi={key:0},Pi=o("td",null,[o("label",null,"Tags: ")],-1),Ci={class:"area-buttons"},Si=["disabled"];function bi(e,t,s,n,i,r){const a=N("responsive-image"),u=N("overlay");return h(),ie(u,{class:"new-game-dialog"},{default:re(()=>[o("div",Xn,[o("div",Jn,[j(a,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(h(),v("div",ei,[e.image.title?(h(),v("span",ti,'"'+B(e.image.title)+'"',1)):W("",!0),e.image.width||e.image.height?(h(),v("span",si,"("+B(e.image.width)+" \u2715 "+B(e.image.height)+")",1)):W("",!0)])):W("",!0)]),o("div",oi,[o("table",null,[o("tr",null,[ni,o("td",null,[H(o("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=m=>e.tiles=m)},null,512),[[Oe,e.tiles]])])]),o("tr",null,[ii,o("td",null,[o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=m=>e.scoreMode=m),value:"1"},null,512),[[be,e.scoreMode]]),li]),ri,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=m=>e.scoreMode=m),value:"0"},null,512),[[be,e.scoreMode]]),ai])])]),o("tr",null,[ui,o("td",null,[o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=m=>e.shapeMode=m),value:"0"},null,512),[[be,e.shapeMode]]),ci]),di,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=m=>e.shapeMode=m),value:"1"},null,512),[[be,e.shapeMode]]),pi]),hi,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=m=>e.shapeMode=m),value:"2"},null,512),[[be,e.shapeMode]]),gi])])]),o("tr",null,[mi,o("td",null,[o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=m=>e.snapMode=m),value:"0"},null,512),[[be,e.snapMode]]),fi]),yi,o("label",null,[H(o("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=m=>e.snapMode=m),value:"1"},null,512),[[be,e.snapMode]]),_i])])]),o("tr",null,[Ei,o("td",null,[H(o("input",{disabled:e.forcePrivate,type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=m=>e.isPrivate=m)},null,8,vi),[[Ze,e.isPrivate]])])]),e.image.tags.length?(h(),v("tr",wi,[Pi,o("td",null,[(h(!0),v(ae,null,me(e.image.tags,(m,y)=>(h(),v("span",{key:y,class:"bit"},B(m.title),1))),128))])])):W("",!0)])]),o("div",Ci,[o("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[9]||(t[9]=(...m)=>e.onNewGameClick&&e.onNewGameClick(...m))}," \u{1F9E9} Generate Puzzle ",8,Si)])]),_:1})}var Fs=J(Qn,[["render",bi]]);const Ti=oe({components:{ImageLibrary:zs,NewImageDialog:Gs,EditImageDialog:Bs,NewGameDialog:Fs},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",newGameForcePrivate:!1,uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(s=>!t.includes(s.title)&&s.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(s=>s.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ge.get(`/api/newgame-data${D.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.newGameForcePrivate=!1,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags),t.append("private",e.isPrivate);const s=await ge.post("/api/upload",{body:t,onUploadProgress:n=>{this.uploadProgress=n.loaded/n.total}});return this.uploadProgress=1,await s.json()},async saveImage(e){return await(await ge.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.newGameForcePrivate=e.isPrivate,this.dialog="new-game"},async onNewGame(e){const t=await ge.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const s=await t.json();this.$router.push({name:"game",params:{id:s.id}})}}}}),$i={class:"upload-image-teaser"},Ai=o("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),Oi={key:0},Ni=A(" Tags: "),ki=["onClick"],Ui=A(" Sort by: "),Ri=o("option",{value:"date_desc"},"Newest first",-1),Vi=o("option",{value:"date_asc"},"Oldest first",-1),Li=o("option",{value:"alpha_asc"},"A-Z",-1),Mi=o("option",{value:"alpha_desc"},"Z-A",-1),Di=[Ri,Vi,Li,Mi];function zi(e,t,s,n,i,r){const a=N("image-library"),u=N("new-image-dialog"),m=N("edit-image-dialog"),y=N("new-game-dialog");return h(),v("div",null,[o("div",$i,[o("div",{class:"btn btn-big",onClick:t[0]||(t[0]=R=>e.dialog="new-image")},"Upload your image"),Ai]),o("div",null,[e.tags.length>0?(h(),v("label",Oi,[Ni,(h(!0),v(ae,null,me(e.relevantTags,(R,z)=>(h(),v("span",{class:je(["bit is-clickable",{on:e.filters.tags.includes(R.slug)}]),key:z,onClick:_=>e.toggleTag(R)},B(R.title)+" ("+B(R.total)+")",11,ki))),128))])):W("",!0),o("label",null,[Ui,H(o("select",{"onUpdate:modelValue":t[1]||(t[1]=R=>e.filters.sort=R),onChange:t[2]||(t[2]=(...R)=>e.filtersChanged&&e.filtersChanged(...R))},Di,544),[[Po,e.filters.sort]])])]),j(a,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),H(j(u,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=R=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[it,e.dialog==="new-image"]]),H(j(m,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=R=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[it,e.dialog==="edit-image"]]),e.image&&e.dialog==="new-game"?(h(),ie(y,{key:0,onBgclick:t[5]||(t[5]=R=>e.dialog=""),onNewGame:e.onNewGame,image:e.image,forcePrivate:e.newGameForcePrivate},null,8,["onNewGame","image","forcePrivate"])):W("",!0)])}var Gi=J(Ti,[["render",zi]]);const Bi=oe({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),Fi={class:"scores"},Ii=o("div",null,"Scores",-1),Yi=o("td",null,"\u26A1",-1),Wi=o("td",null,"\u{1F4A4}",-1);function xi(e,t,s,n,i,r){return h(),v("div",Fi,[Ii,o("table",null,[(h(!0),v(ae,null,me(e.actives,(a,u)=>(h(),v("tr",{key:u,style:De({color:a.color})},[Yi,o("td",null,B(a.name),1),o("td",null,B(a.points),1)],4))),128)),(h(!0),v(ae,null,me(e.idles,(a,u)=>(h(),v("tr",{key:u,style:De({color:a.color})},[Wi,o("td",null,B(a.name),1),o("td",null,B(a.points),1)],4))),128))])])}var Bt=J(Bi,[["render",xi]]);const Zi=oe({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return ve.durationStr(this.status.duration)}}}),Hi={class:"puzzle-status"};function ji(e,t,s,n,i,r){return h(),v("div",Hi,[o("div",null," \u{1F9E9} "+B(e.status.piecesDone)+"/"+B(e.status.piecesTotal),1),o("div",null,B(e.icon)+" "+B(e.durationStr),1)])}var Ft=J(Zi,[["render",ji]]);const Ki=oe({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,otherPlayerClickSoundEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.otherPlayerClickSoundEnabled=!!e.otherPlayerClickSoundEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,otherPlayerClickSoundEnabled:this.otherPlayerClickSoundEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch(()=>this.background,this.emitChanges)),this.watches.push(this.$watch(()=>this.color,this.emitChanges)),this.watches.push(this.$watch(()=>this.name,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.otherPlayerClickSoundEnabled,this.emitChanges)),this.watches.push(this.$watch(()=>this.soundsVolume,this.emitChanges)),this.watches.push(this.$watch(()=>this.showPlayerNames,this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue)}}),Re=e=>(Co("data-v-39b343a4"),e=e(),So(),e),qi={class:"settings"},Qi=Re(()=>o("td",null,[o("label",null,"Background: ")],-1)),Xi=Re(()=>o("td",null,[o("label",null,"Color: ")],-1)),Ji=Re(()=>o("td",null,[o("label",null,"Name: ")],-1)),el=Re(()=>o("td",null,[o("label",null,"Sounds: ")],-1)),tl=Re(()=>o("td",null,[o("label",null,"Piece connect sounds of others: ")],-1)),sl=["disabled"],ol=Re(()=>o("td",null,[o("label",null,"Sounds Volume: ")],-1)),nl={class:"sound-volume"},il=["disabled","value"],ll=Re(()=>o("td",null,[o("label",null,"Show player names: ")],-1));function rl(e,t,s,n,i,r){const a=N("overlay");return h(),ie(a,{class:"transparent"},{default:re(()=>[o("table",qi,[o("tr",null,[Qi,o("td",null,[H(o("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=u=>e.background=u)},null,512),[[Oe,e.background]])])]),o("tr",null,[Xi,o("td",null,[H(o("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=u=>e.color=u)},null,512),[[Oe,e.color]])])]),o("tr",null,[Ji,o("td",null,[H(o("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=u=>e.name=u)},null,512),[[Oe,e.name]])])]),o("tr",null,[el,o("td",null,[H(o("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=u=>e.soundsEnabled=u)},null,512),[[Ze,e.soundsEnabled]])])]),o("tr",null,[tl,o("td",null,[H(o("input",{type:"checkbox",disabled:!e.soundsEnabled,"onUpdate:modelValue":t[4]||(t[4]=u=>e.otherPlayerClickSoundEnabled=u)},null,8,sl),[[Ze,e.otherPlayerClickSoundEnabled]])])]),o("tr",null,[ol,o("td",nl,[o("span",{onClick:t[5]||(t[5]=(...u)=>e.decreaseVolume&&e.decreaseVolume(...u))},"\u{1F509}"),o("input",{disabled:!e.soundsEnabled,type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[6]||(t[6]=(...u)=>e.updateVolume&&e.updateVolume(...u))},null,40,il),o("span",{onClick:t[7]||(t[7]=(...u)=>e.increaseVolume&&e.increaseVolume(...u))},"\u{1F50A}")])]),o("tr",null,[ll,o("td",null,[H(o("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=u=>e.showPlayerNames=u)},null,512),[[Ze,e.showPlayerNames]])])])])]),_:1})}var It=J(Ki,[["render",rl],["__scopeId","data-v-39b343a4"]]);const al=oe({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),ul={class:"preview"};function cl(e,t,s,n,i,r){const a=N("overlay");return h(),ie(a,{class:"preview-overlay",animate:!1},{default:re(()=>[o("div",ul,[o("div",{class:"img",style:De(e.previewStyle)},null,4)])]),_:1})}var Yt=J(al,[["render",cl]]);const dl=oe({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case Ne.ANY:return["Any","Score when pieces are connected to each other or on final location"];case Ne.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case He.FLAT:return["Flat","All pieces flat on all sides"];case He.ANY:return["Any","Flat pieces can occur anywhere"];case He.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case ze.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case ze.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),pl={class:"help"},hl=o("tr",null,[o("td",{colspan:"2"},"Info about this puzzle")],-1),gl=o("td",null,"Image Title: ",-1),ml=o("td",null,"Scoring: ",-1),fl=["title"],yl=o("td",null,"Shapes: ",-1),_l=["title"],El=o("td",null,"Snapping: ",-1),vl=["title"];function wl(e,t,s,n,i,r){const a=N("overlay");return h(),ie(a,{class:"transparent"},{default:re(()=>[o("table",pl,[hl,o("tr",null,[gl,o("td",null,B(e.game.puzzle.info.image.title),1)]),o("tr",null,[ml,o("td",null,[o("span",{title:e.snapMode[1]},B(e.scoreMode[0]),9,fl)])]),o("tr",null,[yl,o("td",null,[o("span",{title:e.snapMode[1]},B(e.shapeMode[0]),9,_l)])]),o("tr",null,[El,o("td",null,[o("span",{title:e.snapMode[1]},B(e.snapMode[0]),9,vl)])])])]),_:1})}var Wt=J(dl,[["render",wl]]);const Pl=2,Cl=1,Sl=4,bl=2,Tl=3,$l=1,Al=2,Ol=4,Nl=3,kl=1,Ul=2,Rl=3,Vl=4,Ll=5,Ml=6,Dl=7,zl=8,Gl=9,Bl=10,Fl=11,Il=12,Yl=13,Wl=14,xl=15,Zl=16,Hl=17,jl=18,Kl=19,ql=20,Ql=21,Xl=1,Jl=2,er=3,tr=4;var d={EV_SERVER_EVENT:Cl,EV_SERVER_INIT:Sl,EV_CLIENT_EVENT:bl,EV_CLIENT_INIT:Tl,GAME_VERSION:Pl,LOG_HEADER:$l,LOG_ADD_PLAYER:Al,LOG_UPDATE_PLAYER:Ol,LOG_HANDLE_INPUT:Nl,INPUT_EV_MOVE:Gl,INPUT_EV_MOUSE_DOWN:kl,INPUT_EV_MOUSE_UP:Ul,INPUT_EV_MOUSE_MOVE:Rl,INPUT_EV_ZOOM_IN:Vl,INPUT_EV_ZOOM_OUT:Ll,INPUT_EV_BG_COLOR:Ml,INPUT_EV_PLAYER_COLOR:Dl,INPUT_EV_PLAYER_NAME:zl,INPUT_EV_TOGGLE_PREVIEW:Bl,INPUT_EV_TOGGLE_SOUNDS:Fl,INPUT_EV_REPLAY_TOGGLE_PAUSE:Il,INPUT_EV_REPLAY_SPEED_UP:Yl,INPUT_EV_REPLAY_SPEED_DOWN:Wl,INPUT_EV_TOGGLE_PLAYER_NAMES:xl,INPUT_EV_CENTER_FIT_PUZZLE:Zl,INPUT_EV_TOGGLE_FIXED_PIECES:Hl,INPUT_EV_TOGGLE_LOOSE_PIECES:jl,INPUT_EV_STORE_POS:Kl,INPUT_EV_RESTORE_POS:ql,INPUT_EV_CONNECTION_CLOSE:Ql,CHANGE_DATA:Xl,CHANGE_PIECE:Jl,CHANGE_PLAYER:er,PLAYER_SNAP:tr};const sr=Mt("Communication.js"),or=1001,xt=4e3,Is=0,Ct=1,Zt=2,Ys=3,Ws=4;let he,St=[],bt=e=>{St.push(e)},Tt=[],$t=e=>{Tt.push(e)};function nr(e){bt=e;for(const t of St)bt(t);St=[]}function ir(e){$t=e;for(const t of Tt)$t(t);Tt=[]}let At=Is;const Ye=e=>{At!==e&&(At=e,$t(e))};function xs(e){if(At===Zt)try{he.send(JSON.stringify(e))}catch{sr.info("unable to send message.. maybe because ws is invalid?")}}let Le,Me,Ot=0;function Zs(e=2e4){he.readyState==he.OPEN&&he.send(""),Ot=setTimeout(Zs,e)}function Ps(){Ot&&clearTimeout(Ot)}function lr(e,t,s){return Le=0,Me={},Ye(Ys),new Promise(n=>{he=new WebSocket(e,s+"|"+t),he.onopen=()=>{Ye(Zt),xs([d.EV_CLIENT_INIT]),Zs()},he.onmessage=i=>{const r=JSON.parse(i.data),a=r[0];if(a===d.EV_SERVER_INIT){const u=r[1];n(u)}else if(a===d.EV_SERVER_EVENT){const u=r[1],m=r[2];if(u===s&&Me[m]){delete Me[m];return}bt(r)}else throw`[ 2021-05-09 invalid connect msgType ${a} ]`},he.onerror=()=>{throw Ps(),Ye(Ct),"[ 2021-05-15 onerror ]"},he.onclose=i=>{Ps(),i.code===xt||i.code===or?Ye(Ws):Ye(Ct)}})}async function rr(e,t){const s={gameId:e,offset:t};return await(await ge.get(`/api/replay-data${D.asQueryArgs(s)}`,{})).json()}function ar(){he&&he.close(xt),Le=0,Me={}}function ur(e){Le++,Me[Le]=e,xs([d.EV_CLIENT_EVENT,Le,Me[Le]])}var Ce={connect:lr,requestReplayData:rr,disconnect:ar,sendClientEvent:ur,onServerChange:nr,onConnectionStateChange:ir,CODE_CUSTOM_DISCONNECT:xt,CONN_STATE_NOT_CONNECTED:Is,CONN_STATE_DISCONNECTED:Ct,CONN_STATE_CLOSED:Ws,CONN_STATE_CONNECTED:Zt,CONN_STATE_CONNECTING:Ys};const cr=oe({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===Ce.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===Ce.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),dr={key:0},pr={key:2};function hr(e,t,s,n,i,r){const a=N("overlay");return H((h(),ie(a,{class:"connection-lost"},{default:re(()=>[e.lostConnection?(h(),v("div",dr,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):W("",!0),e.lostConnection?(h(),v("span",{key:1,class:"btn",onClick:t[0]||(t[0]=u=>e.$emit("reconnect"))},"Reconnect")):W("",!0),e.connecting?(h(),v("div",pr,"Connecting...")):W("",!0)]),_:1},512)),[[it,e.show]])}var Hs=J(cr,[["render",hr]]);const gr=oe({}),mr=o("table",{class:"help"},[o("tr",null,[o("td",null,"\u2B06\uFE0F Move up:"),o("td",null,[o("div",null,[o("kbd",null,"W"),A("/"),o("kbd",null,"\u2191"),A("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B07\uFE0F Move down:"),o("td",null,[o("div",null,[o("kbd",null,"S"),A("/"),o("kbd",null,"\u2193"),A("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u2B05\uFE0F Move left:"),o("td",null,[o("div",null,[o("kbd",null,"A"),A("/"),o("kbd",null,"\u2190"),A("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td",null,"\u27A1\uFE0F Move right:"),o("td",null,[o("div",null,[o("kbd",null,"D"),A("/"),o("kbd",null,"\u2192"),A("/\u{1F5B1}\uFE0F")])])]),o("tr",null,[o("td"),o("td",null,[o("div",null,[A("Move faster by holding "),o("kbd",null,"Shift")])])]),o("tr",null,[o("td",null,"\u{1F50D}+ Zoom in:"),o("td",null,[o("div",null,[o("kbd",null,"E"),A("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F50D}- Zoom out:"),o("td",null,[o("div",null,[o("kbd",null,"Q"),A("/\u{1F5B1}\uFE0F-Wheel")])])]),o("tr",null,[o("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),o("td",null,[o("div",null,[o("kbd",null,"Space")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Center puzzle in screen:"),o("td",null,[o("div",null,[o("kbd",null,"C")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),o("td",null,[o("div",null,[o("kbd",null,"F")])])]),o("tr",null,[o("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),o("td",null,[o("div",null,[o("kbd",null,"G")])])]),o("tr",null,[o("td",null,"\u{1F464} Toggle player names:"),o("td",null,[o("div",null,[o("kbd",null,"N")])])]),o("tr",null,[o("td",null,"\u{1F509} Toggle sounds:"),o("td",null,[o("div",null,[o("kbd",null,"M")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Store position [0-9]:"),o("td",null,[o("div",null,[o("kbd",null,"Shift"),A(" + "),o("kbd",null,"0"),A("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,"\u{1F3AF} Restore position [0-9]:"),o("td",null,[o("div",null,[o("kbd",null,"0"),A("-"),o("kbd",null,"9")])])]),o("tr",null,[o("td",null,"\u23EB Speed up (replay):"),o("td",null,[o("div",null,[o("kbd",null,"I")])])]),o("tr",null,[o("td",null,"\u23EC Speed down (replay):"),o("td",null,[o("div",null,[o("kbd",null,"O")])])]),o("tr",null,[o("td",null,"\u23F8\uFE0F Pause (replay):"),o("td",null,[o("div",null,[o("kbd",null,"P")])])])],-1);function fr(e,t,s,n,i,r){const a=N("overlay");return h(),ie(a,{class:"transparent"},{default:re(()=>[mr]),_:1})}var Ht=J(gr,[["render",fr]]),yr="/assets/click.bb97cb07.mp3",_r=Object.freeze(Object.defineProperty({__proto__:null,default:yr},Symbol.toStringTag,{value:"Module"})),Er="/assets/click2.98536db5.mp3",vr=Object.freeze(Object.defineProperty({__proto__:null,default:Er},Symbol.toStringTag,{value:"Module"})),wr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",Pr=Object.freeze(Object.defineProperty({__proto__:null,default:wr},Symbol.toStringTag,{value:"Module"})),Cr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",Sr=Object.freeze(Object.defineProperty({__proto__:null,default:Cr},Symbol.toStringTag,{value:"Module"})),br="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",Tr=Object.freeze(Object.defineProperty({__proto__:null,default:br},Symbol.toStringTag,{value:"Module"})),$r="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",Ar=Object.freeze(Object.defineProperty({__proto__:null,default:$r},Symbol.toStringTag,{value:"Module"}));const Or=e=>{let t=!1;const s=()=>{t=!0},n=e.fps||60,i=e.slow||1,r=e.update,a=e.render,u=window.requestAnimationFrame,m=1/n,y=i*m;let R,z=0,_=window.performance.now();const g=()=>{for(R=window.performance.now(),z=z+Math.min(1,(R-_)/1e3);z>y;)z=z-y,r(m);a(z/i),_=R,t||u(g)};return u(g),{stop:s}},Nr=.1,kr=6,Ur=.05;class Nt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,s){this.x+=t/this.curZoom,this.y+=s/this.curZoom}calculateNewZoom(t){const s=t==="in"?1:-1,n=this.curZoom+Ur*this.curZoom*s;return Math.min(Math.max(n,Nr),kr)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,s){if(this.curZoom==t)return!1;const n=1-this.curZoom/t;return this.move(-s.x*n,-s.y*n),this.curZoom=t,!0}zoom(t,s){return this.setZoom(this.calculateNewZoom(t),s)}viewportToWorld(t){const{x:s,y:n}=this.viewportToWorldRaw(t);return{x:Math.round(s),y:Math.round(n)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:s,y:n}=this.worldToViewportRaw(t);return{x:Math.round(s),y:Math.round(n)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:s,h:n}=this.worldDimToViewportRaw(t);return{w:Math.round(s),h:Math.round(n)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:s,h:n}=this.viewportDimToWorldRaw(t);return{w:Math.round(s),h:Math.round(n)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function jt(e=0,t=0){const s=document.createElement("canvas");return s.width=e,s.height=t,s}async function Rr(e){return new Promise(t=>{const s=new Image;s.onload=()=>{createImageBitmap(s).then(t)},s.src=e})}async function Vr(e,t,s){const n=jt(t,s);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,s),await createImageBitmap(n)}function Lr(e,t,s){const n=jt(e.width,e.height),i=n.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=s,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),n}var pe={createCanvas:jt,loadImageToBitmap:Rr,resizeBitmap:Vr,colorizedCanvas:Lr};const Mr=Mt("Debug.js");let kt=0,js=0;const Dr=e=>{kt=performance.now(),js=e},zr=e=>{const t=performance.now(),s=t-kt;s>js&&Mr.log(e+": "+s),kt=t};var Te={checkpoint_start:Dr,checkpoint:zr};function Gr(e,t){return{x:e.x-t.x,y:e.y-t.y}}function Br(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Ks(e,t){const s=e.x-t.x,n=e.y-t.y;return Math.sqrt(s*s+n*n)}function Fr(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function Ut(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function Ir(e,t,s){return{x:e.x+t,y:e.y+s,w:e.w,h:e.h}}function Yr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function Wr(e,t){return Ks(Ut(e),Ut(t))}var K={pointSub:Gr,pointAdd:Br,pointDistance:Ks,pointInBounds:Fr,rectCenter:Ut,rectMoved:Ir,rectCenterDistance:Wr,rectsOverlap:Yr};const Cs=Mt("PuzzleGraphics.js");async function xr(e,t,s){Cs.log("start createPuzzleTileBitmaps");const n=s.tileSize,i=s.tileMarginWidth,r=s.tileDrawSize,a=n/100,u=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],m=new Array(t.length),y={};function R(f){const F=`${f.top}${f.right}${f.left}${f.bottom}`;if(y[F])return y[F];const O=new Path2D,S={x:i,y:i},b=K.pointAdd(S,{x:n,y:0}),P=K.pointAdd(b,{x:0,y:n}),$=K.pointSub(P,{x:n,y:0});if(O.moveTo(S.x,S.y),f.top!==0)for(let c=0;c<u.length/6;c++){const ee=K.pointAdd(S,{x:u[c*6+0]*a,y:f.top*u[c*6+1]*a}),x=K.pointAdd(S,{x:u[c*6+2]*a,y:f.top*u[c*6+3]*a}),te=K.pointAdd(S,{x:u[c*6+4]*a,y:f.top*u[c*6+5]*a});O.bezierCurveTo(ee.x,ee.y,x.x,x.y,te.x,te.y)}else O.lineTo(b.x,b.y);if(f.right!==0)for(let c=0;c<u.length/6;c++){const ee=K.pointAdd(b,{x:-f.right*u[c*6+1]*a,y:u[c*6+0]*a}),x=K.pointAdd(b,{x:-f.right*u[c*6+3]*a,y:u[c*6+2]*a}),te=K.pointAdd(b,{x:-f.right*u[c*6+5]*a,y:u[c*6+4]*a});O.bezierCurveTo(ee.x,ee.y,x.x,x.y,te.x,te.y)}else O.lineTo(P.x,P.y);if(f.bottom!==0)for(let c=0;c<u.length/6;c++){const ee=K.pointSub(P,{x:u[c*6+0]*a,y:f.bottom*u[c*6+1]*a}),x=K.pointSub(P,{x:u[c*6+2]*a,y:f.bottom*u[c*6+3]*a}),te=K.pointSub(P,{x:u[c*6+4]*a,y:f.bottom*u[c*6+5]*a});O.bezierCurveTo(ee.x,ee.y,x.x,x.y,te.x,te.y)}else O.lineTo($.x,$.y);if(f.left!==0)for(let c=0;c<u.length/6;c++){const ee=K.pointSub($,{x:-f.left*u[c*6+1]*a,y:u[c*6+0]*a}),x=K.pointSub($,{x:-f.left*u[c*6+3]*a,y:u[c*6+2]*a}),te=K.pointSub($,{x:-f.left*u[c*6+5]*a,y:u[c*6+4]*a});O.bezierCurveTo(ee.x,ee.y,x.x,x.y,te.x,te.y)}else O.lineTo(S.x,S.y);return y[F]=O,O}const z=pe.createCanvas(r,r),_=z.getContext("2d"),g=pe.createCanvas(r,r),T=g.getContext("2d");for(const f of t){const F=D.decodePiece(f),O=Zr(s,F.idx),S=R(D.decodeShape(s.shapes[F.idx]));_.clearRect(0,0,r,r),_.save(),_.lineWidth=2,_.stroke(S),_.globalCompositeOperation="source-in",_.drawImage(e,O.x-i,O.y-i,r,r,0,0,r,r),_.restore(),_.save(),_.globalCompositeOperation="source-in",_.globalAlpha=.2,_.fillStyle="black",_.fillRect(0,0,z.width,z.height),_.restore(),_.save(),_.clip(S),_.drawImage(e,O.x-i,O.y-i,r,r,0,0,r,r),_.restore(),_.save(),_.clip(S),_.strokeStyle="rgba(0,0,0,.4)",_.lineWidth=0,_.shadowColor="black",_.shadowBlur=2,_.shadowOffsetX=-1,_.shadowOffsetY=-1,_.stroke(S),_.restore(),_.save(),_.clip(S),_.strokeStyle="rgba(255,255,255,.4)",_.lineWidth=0,_.shadowColor="white",_.shadowBlur=2,_.shadowOffsetX=1,_.shadowOffsetY=1,_.stroke(S),_.restore(),T.clearRect(0,0,r,r),T.save(),T.lineWidth=1,T.stroke(S),T.globalCompositeOperation="source-in",T.drawImage(e,O.x-i,O.y-i,r,r,0,0,r,r),T.restore(),_.drawImage(g,0,0),m[F.idx]=await createImageBitmap(z)}return Cs.log("end createPuzzleTileBitmaps"),m}function Zr(e,t){const s=D.coordByPieceIdxDeprecated(e,t);return{x:s.x*e.tileSize,y:s.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function Hr(e){const t=await pe.loadImageToBitmap(e.info.imageUrl),s=await pe.resizeBitmap(t,e.info.width,e.info.height);return await xr(s,e.tiles,e.info)}var jr={loadPuzzleBitmaps:Hr};const qs=30,C={};function Kr(e){return!!C[e]||!1}function qr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function Qr(e,t){C[e]=t}function Xr(e){delete C[e]}function ct(e,t){let s=0;for(const n of C[e].players){if(D.decodePlayer(n).id===t)return s;s++}return-1}function Jr(e,t){return C[e].players.length>t?D.decodePlayer(C[e].players[t]).id:null}function Ue(e,t){const s=ct(e,t);return s===-1?null:D.decodePlayer(C[e].players[s])}function Kt(e,t,s){const n=ct(e,t);n===-1?C[e].players.push(D.encodePlayer(s)):C[e].players[n]=D.encodePlayer(s)}function ea(e,t,s){C[e].puzzle.tiles[t]=D.encodePiece(s)}function ta(e,t){C[e].puzzle.data=t}function Qs(e,t){return ct(e,t)!==-1}function sa(e,t){return lo(C[e],t)}function oa(e,t){return Ra(C[e],t)}function na(e,t,s){Qs(e,t)?le(e,t,{ts:s}):Kt(e,t,qr(t,s))}function ia(e){return C[e]||null}function Rt(e){return Qt(C[e])}function la(e){return ro(C[e])}function Et(e){return C[e].scoreMode}function Xs(e){return C[e].snapMode}function Vt(e){return qt(C[e])}function ra(e){return C[e].puzzle.tiles.map(D.decodePiece).sort((s,n)=>s.z-n.z)}function le(e,t,s){const n=Ue(e,t);if(n!==null){for(const i of Object.keys(s))n[i]=s[i];Kt(e,t,n)}}function et(e,t){for(const s of Object.keys(t))C[e].puzzle.data[s]=t[s]}function ke(e,t,s){for(const n of Object.keys(s)){const i=D.decodePiece(C[e].puzzle.tiles[t]);i[n]=s[n],C[e].puzzle.tiles[t]=D.encodePiece(i)}}const Ge=(e,t)=>D.decodePiece(C[e].puzzle.tiles[t]),at=(e,t)=>Ge(e,t).group,aa=(e,t)=>{const s=C[e].puzzle.info;return t===0||t===s.tilesX-1||t===s.tiles-s.tilesX||t===s.tiles-1},Js=(e,t)=>{const s=C[e].puzzle.info,n={x:(s.table.width-s.width)/2,y:(s.table.height-s.height)/2},i=fa(e,t);return K.pointAdd(n,i)},nt=(e,t)=>Ge(e,t).pos,ua=e=>{const t=to(e),s=so(e),n=Math.round(t/4),i=Math.round(s/4);return{x:0-n,y:0-i,w:t+2*n,h:s+2*i}},ca=(e,t)=>Ge(e,t).z,We=(e,t)=>{for(const s of C[e].puzzle.tiles){const n=D.decodePiece(s);if(n.owner===t)return n.idx}return-1},da=(e,t)=>{const s=We(e,t);return s<0?null:C[e].puzzle.tiles[s]},pa=e=>C[e].puzzle.info.tileDrawOffset,eo=e=>C[e].puzzle.info.tileDrawSize,ha=e=>oo(C[e]),ga=e=>no(C[e]),Ss=e=>C[e].puzzle.data.maxGroup,bs=e=>C[e].puzzle.data.maxZ,ma=(e,t)=>{let s=0;for(const n of t){const i=ca(e,n);i>s&&(s=i)}return s};function fa(e,t){const s=C[e].puzzle.info,n=D.coordByPieceIdxDeprecated(s,t),i=n.x*s.tileSize,r=n.y*s.tileSize;return{x:i,y:r}}function ya(e,t){const s=C[e].puzzle.info,n=D.coordByPieceIdxDeprecated(s,t);return[n.y>0?t-s.tilesX:-1,n.x<s.tilesX-1?t+1:-1,n.y<s.tilesY-1?t+s.tilesX:-1,n.x>0?t-1:-1]}const Ts=(e,t,s)=>{for(const n of t)ke(e,n,{z:s})},_a=(e,t,s)=>{const n=nt(e,t),i=K.pointAdd(n,s);ke(e,t,{pos:i})},tt=(e,t,s)=>{const n=eo(e),i=ua(e),r=s;for(const a of t){const u=Ge(e,a);u.pos.x+s.x<i.x?r.x=Math.max(i.x-u.pos.x,r.x):u.pos.x+n+s.x>i.x+i.w&&(r.x=Math.min(i.x+i.w-u.pos.x+n,r.x)),u.pos.y+s.y<i.y?r.y=Math.max(i.y-u.pos.y,r.y):u.pos.y+n+s.y>i.y+i.h&&(r.y=Math.min(i.y+i.h-u.pos.y+n,r.y))}if(!r.x&&!r.y)return!1;for(const a of t)_a(e,a,r);return!0},Ea=(e,t)=>va(e,t)===-1,va=(e,t)=>Ge(e,t).owner,$s=(e,t)=>{for(const s of t)ke(e,s,{owner:-1,z:1})},vt=(e,t,s)=>{for(const n of t)ke(e,n,{owner:s})};function wa(e,t){return Ee(e,t).length}function Ee(e,t){const s=C[e].puzzle.tiles,n=D.decodePiece(s[t]),i=[];if(n.group)for(const r of s){const a=D.decodePiece(r);a.group===n.group&&i.push(a.idx)}else i.push(n.idx);return i}const Pa=(e,t)=>{const s=C[e].puzzle.info,n=C[e].puzzle.tiles;let i=-1,r=-1;for(let a=0;a<n.length;a++){const u=D.decodePiece(n[a]);if(u.owner!==0)continue;const m={x:u.pos.x,y:u.pos.y,w:s.tileSize,h:s.tileSize};K.pointInBounds(t,m)&&(i===-1||u.z>i)&&(i=u.z,r=a)}return r},Ca=(e,t)=>{const s=Ue(e,t);return s?s.bgcolor:null},Sa=(e,t)=>{const s=Ue(e,t);return s?s.color:null},ba=(e,t)=>{const s=Ue(e,t);return s?s.name:null},As=(e,t)=>{const s=Ue(e,t);return s?s.points:0},Ta=(e,t,s)=>{const n=at(e,t),i=at(e,s);return!!(n&&n===i)},to=e=>C[e].puzzle.info.table.width,so=e=>C[e].puzzle.info.table.height,$a=e=>C[e].puzzle,Aa=e=>C[e].rng.obj,Oa=e=>C[e].puzzle.info.width,Na=e=>C[e].puzzle.info.height,ka=(e,t)=>{if(Xs(e)===ze.REAL){for(const s of t)if(aa(e,s))return!0;return!1}return!0};function Ua(e,t,s,n){const i=C[e].puzzle,r=[],a=()=>{r.push([d.CHANGE_DATA,i.data])},u=g=>{r.push([d.CHANGE_PIECE,D.encodePiece(Ge(e,g))])},m=g=>{for(const T of g)u(T)},y=()=>{const g=Ue(e,t);!g||r.push([d.CHANGE_PLAYER,D.encodePlayer(g)])};let R=!1;const z=(g,T,f)=>{const F=C[g].puzzle.tiles,O=at(g,T),S=at(g,f);let b;const P=[];if(O&&P.push(O),S&&P.push(S),O)b=O;else if(S)b=S;else{const $=Ss(g)+1;et(g,{maxGroup:$}),a(),b=Ss(g)}if(ke(g,T,{group:b}),u(T),ke(g,f,{group:b}),u(f),P.length>0)for(const $ of F){const c=D.decodePiece($);P.includes(c.group)&&(ke(g,c.idx,{group:b}),u(c.idx))}},_=s[0];if(_===d.INPUT_EV_CONNECTION_CLOSE){const g=We(e,t);if(g>=0){const T=Ee(e,g);vt(e,T,0),m(T)}}else if(_===d.INPUT_EV_BG_COLOR){const g=s[1];le(e,t,{bgcolor:g,ts:n}),y()}else if(_===d.INPUT_EV_PLAYER_COLOR){const g=s[1];le(e,t,{color:g,ts:n}),y()}else if(_===d.INPUT_EV_PLAYER_NAME){const g=`${s[1]}`.substr(0,16);le(e,t,{name:g,ts:n}),y()}else if(_===d.INPUT_EV_MOVE){const g=s[1],T=s[2],f=Ue(e,t);if(f){const F=f.x-g,O=f.y-T;le(e,t,{ts:n,x:F,y:O}),y();const S=We(e,t);if(S>=0){const b=Ee(e,S),P={x:-g,y:-T};tt(e,b,P)&&m(b)}}}else if(_===d.INPUT_EV_MOUSE_DOWN){const g=s[1],T=s[2],f={x:g,y:T};le(e,t,{d:1,ts:n}),y();const F=Pa(e,f);if(F>=0){const O=bs(e)+1;et(e,{maxZ:O}),a();const S=Ee(e,F);Ts(e,S,bs(e)),vt(e,S,t),m(S)}}else if(_===d.INPUT_EV_MOUSE_MOVE){const g=s[1],T=s[2];if(!s[5])le(e,t,{x:g,y:T,ts:n}),y();else{const F=We(e,t);if(F<0)le(e,t,{ts:n}),y();else{const O=s[1],S=s[2],b=s[3],P=s[4];le(e,t,{x:O,y:S,ts:n}),y();const $=Ee(e,F);tt(e,$,{x:b,y:P})&&m($)}}}else if(_===d.INPUT_EV_MOUSE_UP){const T=We(e,t);if(T>=0){const f=Ee(e,T);vt(e,f,0),m(f);const F=nt(e,T),O=Js(e,T);if(ka(e,f)&&K.pointDistance(O,F)<i.info.snapDistance){const S=K.pointSub(O,F);tt(e,f,S),$s(e,f),m(f);let b=As(e,t);Et(e)===Ne.FINAL?b+=f.length:Et(e)===Ne.ANY&&(b+=1),le(e,t,{d:0,ts:n,points:b}),y(),Vt(e)===Rt(e)&&(et(e,{finished:n}),a()),R=!0}else{const S=(P,$,c,ee)=>{const x=C[P].puzzle.info;if(c<0||Ta(P,$,c))return!1;const te=nt(P,$),we=K.pointAdd(nt(P,c),{x:ee[0]*x.tileSize,y:ee[1]*x.tileSize});if(K.pointDistance(te,we)<x.snapDistance){const Se=K.pointSub(we,te);let de=Ee(P,$);if(tt(P,de,Se),z(P,$,c),de=Ee(P,$),Ea(P,c))$s(P,de);else{const Ve=ma(P,de);Ts(P,de,Ve)}return m(de),!0}return!1};let b=!1;for(const P of Ee(e,T)){const $=ya(e,P);if(S(e,P,$[0],[0,1])||S(e,P,$[1],[-1,0])||S(e,P,$[2],[0,-1])||S(e,P,$[3],[1,0])){b=!0;break}}if(b&&Et(e)===Ne.ANY){const P=As(e,t)+1;le(e,t,{d:0,ts:n,points:P}),y()}else le(e,t,{d:0,ts:n}),y();b&&Xs(e)===ze.REAL&&Vt(e)===Rt(e)&&(et(e,{finished:n}),a()),b&&(R=!0)}}else le(e,t,{d:0,ts:n}),y()}else if(_===d.INPUT_EV_ZOOM_IN){const g=s[1],T=s[2];le(e,t,{x:g,y:T,ts:n}),y()}else if(_===d.INPUT_EV_ZOOM_OUT){const g=s[1],T=s[2];le(e,t,{x:g,y:T,ts:n}),y()}else le(e,t,{ts:n}),y();return R&&r.push([d.PLAYER_SNAP,t]),r}function oo(e){return e.puzzle.data.started}function no(e){return e.puzzle.data.finished}function qt(e){let t=0;for(const s of e.puzzle.tiles)D.decodePiece(s).owner===-1&&t++;return t}function Qt(e){return e.puzzle.tiles.length}function io(e){return e.players.map(D.decodePlayer)}function lo(e,t){const s=t-qs*ve.SEC;return io(e).filter(n=>n.ts>=s)}function Ra(e,t){const s=t-qs*ve.SEC;return io(e).filter(n=>n.ts<s&&n.points>0)}function ro(e){var s;const t=((s=e.puzzle.info.image)==null?void 0:s.url)||e.puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Va(e){return qt(e)===Qt(e)}var k={setGame:Qr,unsetGame:Xr,loaded:Kr,playerExists:Qs,getActivePlayers:sa,getIdlePlayers:oa,addPlayer:na,getFinishedPiecesCount:Vt,getPieceCount:Rt,getImageUrl:la,get:ia,getGroupedPieceCount:wa,getPlayerBgColor:Ca,getPlayerColor:Sa,getPlayerName:ba,getPlayerIndexById:ct,getPlayerIdByIndex:Jr,changePlayer:le,setPlayer:Kt,setPiece:ea,setPuzzleData:ta,getTableWidth:to,getTableHeight:so,getPuzzle:$a,getRng:Aa,getPuzzleWidth:Oa,getPuzzleHeight:Na,getPiecesSortedByZIndex:ra,getFirstOwnedPiece:da,getPieceDrawOffset:pa,getPieceDrawSize:eo,getFinalPiecePos:Js,getStartTs:ha,getFinishTs:ga,handleInput:Ua,Game_getStartTs:oo,Game_getFinishTs:no,Game_getFinishedPiecesCount:qt,Game_getPieceCount:Qt,Game_getActivePlayers:lo,Game_getImageUrl:ro,Game_isFinished:Va};let ao=-10,uo=20,Lt=2,co=15;const La=5,Ma=5,Xt=1,Da=200,Os=10,za=100,Ga=10,Ba=1,Fa=5;function Ia(e){const t=e.random(0,255),s=e.random(0,255),n=e.random(0,255);return"rgba("+t+","+s+","+n+", 0.8)"}class Ns{constructor(t){this.radius=Os,this.previousRadius=Os,this.explodingDuration=za,this.hasExploded=!1,this.alive=!0,this.color=Ia(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=ao+Math.random()*uo,this.vy=(Lt+Math.random()*co)*-1,this.duration=0}update(t){if(this.hasExploded){const s=Da-this.radius;this.previousRadius=this.radius,this.radius+=s/Ga,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=Xt,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const s=3+Math.floor(Math.random()*3);for(let n=0;n<s;n++){const i=10+Math.floor(Math.random()*21),r=La+Math.random()*Ma,a=2*Math.PI/i,u=Math.random()*a;for(let m=0;m<i;m++)t.push(new Ya(this,m*a+u,r))}}}class Ya{constructor(t,s,n){this.px=t.px,this.py=t.py,this.vx=Math.cos(s)*n,this.vy=Math.sin(s)*n,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=Xt/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class Wa{constructor(t,s){this.canvas=t,this.rng=s,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,s=0;for(;t<this.canvas.height&&s>=0;)s+=Xt,t+=s;Lt=s/2,co=s-Lt;const n=1/4*this.canvas.width/(s/2);ao=-n,uo=2*n}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<Ba;t++)this.readyBombs.push(new Ns(this.rng))}update(){Math.random()*100<Fa&&this.readyBombs.push(new Ns(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const s=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):s.push(i)}this.readyBombs=s;const n=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&n.push(i)}this.particles=n}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function xa(e,t,s,n){let i=[],r=!0,a=!1,u=!1,m=!1,y=!1,R=!1,z=!1,_=!1;const g=(E,U)=>{const Y=s.viewportToWorld({x:E,y:U});return[Y.x,Y.y]},T=(E,U)=>{const Y=s.viewportDimToWorld({w:E,h:U});return[Y.w,Y.h]},f=E=>g(E.offsetX,E.offsetY),F=()=>g(e.width/2,e.height/2),O=(E,U)=>{!r||(U.code==="ShiftLeft"||U.code==="ShiftRight"?_=E:U.code==="ArrowUp"||U.code==="KeyW"?m=E:U.code==="ArrowDown"||U.code==="KeyS"?y=E:U.code==="ArrowLeft"||U.code==="KeyA"?a=E:U.code==="ArrowRight"||U.code==="KeyD"?u=E:U.code==="KeyQ"?z=E:U.code==="KeyE"&&(R=E))};let S=!1,b=null,P=null;const $=E=>{P=f(E),b=[E.offsetX,E.offsetY],E.button===0&&(S=!0,q([d.INPUT_EV_MOUSE_DOWN,...P]))},c=E=>{P=f(E),b=[E.offsetX,E.offsetY],E.button===0&&(S=!1,q([d.INPUT_EV_MOUSE_UP,...P]))},ee=E=>{if(!b)return;P=f(E);const U=T(-(b[0]-E.offsetX),-(b[1]-E.offsetY));q([d.INPUT_EV_MOUSE_MOVE,...P,...U,S?1:0]),b=[E.offsetX,E.offsetY]},x=E=>{if(P=f(E),s.canZoom(E.deltaY<0?"in":"out")){const U=E.deltaY<0?d.INPUT_EV_ZOOM_IN:d.INPUT_EV_ZOOM_OUT;q([U,...P])}},te=E=>O(!0,E),we=E=>O(!1,E),Se=E=>{if(!!r){if(n===_e&&(E.code==="KeyI"?q([d.INPUT_EV_REPLAY_SPEED_UP]):E.code==="KeyO"?q([d.INPUT_EV_REPLAY_SPEED_DOWN]):E.code==="KeyP"&&q([d.INPUT_EV_REPLAY_TOGGLE_PAUSE])),E.code==="Space")q([d.INPUT_EV_TOGGLE_PREVIEW]);else if(E.code==="KeyF")q([d.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(E.code==="KeyG")q([d.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(E.code==="KeyM")q([d.INPUT_EV_TOGGLE_SOUNDS]);else if(E.code==="KeyN")q([d.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(E.code==="KeyC")q([d.INPUT_EV_CENTER_FIT_PUZZLE]);else for(let U=0;U<=9;U++)if(E.code===`Digit${U}`){const Y=E.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;q([Y,U]);break}}},de=()=>{e.addEventListener("mousedown",$),e.addEventListener("mouseup",c),e.addEventListener("mousemove",ee),e.addEventListener("wheel",x),t.addEventListener("keydown",te),t.addEventListener("keyup",we),t.addEventListener("keypress",Se)},Ve=()=>{e.removeEventListener("mousedown",$),e.removeEventListener("mouseup",c),e.removeEventListener("mousemove",ee),e.removeEventListener("wheel",x),t.removeEventListener("keydown",te),t.removeEventListener("keyup",we),t.removeEventListener("keypress",Se)},Ke=(E,U)=>{if(!b||!P)return;const Y=new Nt(E).viewportToWorld({x:b[0],y:b[1]}),fe=new Nt(U).viewportToWorld({x:b[0],y:b[1]}),ue=[-(Y.x-fe.x),-(Y.y-fe.y)];q([d.INPUT_EV_MOUSE_MOVE,...P,...ue,S?1:0])},q=E=>{i.push(E)};return{registerEvents:de,unregisterEvents:Ve,addEvent:q,consumeAll:()=>{if(i.length===0)return[];const E=i.slice();return i=[],E},createKeyEvents:()=>{const E=(a?1:0)-(u?1:0),U=(m?1:0)-(y?1:0);if(E!==0||U!==0){const Y=(_?24:12)*Math.sqrt(s.getCurrentZoom()),fe=s.viewportDimToWorld({w:E*Y,h:U*Y});q([d.INPUT_EV_MOVE,fe.w,fe.h]),P&&(P[0]-=fe.w,P[1]-=fe.h)}if(!(R&&z)){if(R){if(s.canZoom("in")){const Y=P||F();q([d.INPUT_EV_ZOOM_IN,...Y])}}else if(z&&s.canZoom("out")){const Y=P||F();q([d.INPUT_EV_ZOOM_OUT,...Y])}}},createSnapshotEvents:Ke,setHotkeys:E=>{r=E}}}const st={"./grab.png":Pr,"./grab_mask.png":Sr,"./hand.png":Tr,"./hand_mask.png":Ar},ks={"./click.mp3":_r,"./click2.mp3":vr},xe="play",_e="replay";let $e=!0,Ae=!0;const Za=e=>e.owner===-1?$e:Ae;let se=!0;async function po(e,t,s,n,i,r){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const a=l=>n===_e||l.id!==t,u=ks["./click.mp3"].default,m=ks["./click2.mp3"].default,y=new Audio(u),R=new Audio(m),z=await pe.loadImageToBitmap(st["./grab.png"].default),_=await pe.loadImageToBitmap(st["./hand.png"].default),g=await pe.loadImageToBitmap(st["./grab_mask.png"].default),T=await pe.loadImageToBitmap(st["./hand_mask.png"].default),f=z.width,F=Math.round(f/2),O=z.height,S=Math.round(O/2),b={},P=async l=>{const p=l.color+" "+l.d;if(!b[p]){const w=l.d?z:_;if(l.color){const L=l.d?g:T;b[p]=await createImageBitmap(pe.colorizedCanvas(w,L,l.color))}else b[p]=w}return b[p]},$=i,c={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};Ce.onConnectionStateChange(l=>{r.emit("connectionState",l)});const ee=async l=>{const p=c.dataOffset;c.dataOffset+=1e4;const w=await Ce.requestReplayData(l,p);return c.log=c.log.slice(c.logPointer),c.logPointer=0,c.log.push(...w.log),w.log.length===0&&(c.final=!0),w};let x=()=>0;const te=async()=>{if(n===xe){const l=await Ce.connect(s,e,t),p=D.decodeGame(l);k.setGame(p.id,p),x=()=>ve.timestamp()}else if(n===_e){const l=await ee(e);if(!l.game)throw"[ 2021-05-29 no game received ]";const p=D.decodeGame(l.game);k.setGame(p.id,p),c.lastRealTs=ve.timestamp(),c.gameStartTs=parseInt(l.log[0][4],10),c.lastGameTs=c.gameStartTs,x=()=>c.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";se=!0};await te();const we=k.getPieceDrawOffset(e),Se=k.getPieceDrawSize(e),de=k.getPuzzleWidth(e),Ve=k.getPuzzleHeight(e),Ke=k.getTableWidth(e),q=k.getTableHeight(e),Jt={x:(Ke-de)/2,y:(q-Ve)/2},dt={w:de,h:Ve},es={w:Se,h:Se},E=await jr.loadPuzzleBitmaps(k.getPuzzle(e)),U=new Wa($,k.getRng(e));U.init();const Y=$.getContext("2d");$.classList.add("loaded"),r.emit("puzzleCut");let fe="";const ue={},V=new Nt,mo=()=>{V.reset(),V.move(-(Ke-$.width)/2,-(q-$.height)/2);const l=V.worldDimToViewportRaw(dt),p=20,w=$.width-p*2,L=$.height-p*2;if(l.w>w||l.h>L||l.w<w&&l.h<L){const G=Math.min(w/l.w,L/l.h),I={x:$.width/2,y:$.height/2};V.setZoom(G,I)}},ce=xa($,window,V,n);ce.registerEvents();const qe=l=>{if(ue.last&&fe===l){const p=V.snapshot(),w=ue.last;return V.fromSnapshot(w),ce.createSnapshotEvents(p,w),delete ue.last,"last"}else if(ue[l]){const p=ue[l],w=V.snapshot();return ue.last=w,fe=l,V.fromSnapshot(p),ce.createSnapshotEvents(w,p),l}else return null};mo(),ue.center=V.snapshot();const fo=k.getImageUrl(e),Qe=l=>{const p=k.getStartTs(e),w=k.getFinishTs(e);r.emit("status",{finished:!!w,duration:(w||l)-p,piecesDone:k.getFinishedPiecesCount(e),piecesTotal:k.getPieceCount(e)}),r.emit("players",{active:k.getActivePlayers(e,l),idle:k.getIdlePlayers(e,l)})};Qe(x());const ts=!!k.getFinishTs(e);let pt=ts;const ss=()=>pt&&!ts,ht=()=>X.getInt(ne.SOUND_VOLUME,ye.SOUND_VOLUME),os=()=>X.getBool(ne.OTHER_PLAYER_CLICK_SOUND_ENABLED,ye.OTHER_PLAYER_CLICK_SOUND_ENABLED),gt=()=>X.getBool(ne.SOUND_ENABLED,ye.SOUND_ENABLED),ns=()=>X.getBool(ne.SHOW_PLAYER_NAMES,ye.SHOW_PLAYER_NAMES),is=()=>n===_e?X.getStr(ne.COLOR_BACKGROUND,ye.COLOR_BACKGROUND):k.getPlayerBgColor(e,t)||X.getStr(ne.COLOR_BACKGROUND,ye.COLOR_BACKGROUND),ls=()=>n===_e?X.getStr(ne.PLAYER_COLOR,ye.PLAYER_COLOR):k.getPlayerColor(e,t)||X.getStr(ne.PLAYER_COLOR,ye.PLAYER_COLOR),yo=()=>n===_e?X.getStr(ne.PLAYER_NAME,ye.PLAYER_NAME):k.getPlayerName(e,t)||X.getStr(ne.PLAYER_NAME,ye.PLAYER_NAME),rs=()=>{const l=ht();y.volume=l/100,y.play()},_o=()=>{const l=ht();R.volume=l/100,R.play()},Z={background:is(),color:ls(),name:yo(),soundsEnabled:gt(),otherPlayerClickSoundEnabled:os(),soundsVolume:ht(),showPlayerNames:ns()};ce.addEvent([d.INPUT_EV_BG_COLOR,Z.background]),ce.addEvent([d.INPUT_EV_PLAYER_COLOR,Z.color]),ce.addEvent([d.INPUT_EV_PLAYER_NAME,Z.name]);let as="",us="",cs=!1;const Be=l=>{cs=l;const[p,w]=l?[as,"grab"]:[us,"default"];$.style.cursor=`url('${p}') ${F} ${S}, ${w}`},mt=l=>{as=pe.colorizedCanvas(z,g,l).toDataURL(),us=pe.colorizedCanvas(_,T,l).toDataURL(),Be(cs)};mt(ls());const Xe=()=>{r.emit("replaySpeed",c.speeds[c.speedIdx]),r.emit("replayPaused",c.paused)},Q=(l,p=void 0)=>{r.emit("statusMessage",{what:l,value:p})},ds=()=>{c.speedIdx+1<c.speeds.length&&(c.speedIdx++,Xe(),Q("Speed Up"))},ps=()=>{c.speedIdx>=1&&(c.speedIdx--,Xe(),Q("Speed Down"))},hs=()=>{c.paused=!c.paused,Xe(),Q(c.paused?"Paused":"Playing")};let Fe=!1;const gs=()=>{Fe=!Fe,r.emit("togglePreview",Fe)},ms=()=>{Z.soundsEnabled=!Z.soundsEnabled;const l=Z.soundsEnabled;r.emit("toggleSoundsEnabled",l),X.setBool(ne.SOUND_ENABLED,l),Q("Sounds",l)},fs=()=>{Z.showPlayerNames=!Z.showPlayerNames;const l=Z.showPlayerNames;r.emit("togglePlayerNames",l),X.setBool(ne.SHOW_PLAYER_NAMES,l),Q("Player names",l)};r.on("replayOnSpeedUp",()=>{ds()}),r.on("replayOnSpeedDown",()=>{ps()}),r.on("replayOnPauseToggle",()=>{hs()}),r.on("onPreviewChange",l=>{Fe!==l&&(Fe=l)}),r.on("onBgChange",l=>{Z.background!==l&&(Z.background=l,X.setStr(ne.COLOR_BACKGROUND,l),ce.addEvent([d.INPUT_EV_BG_COLOR,l]),Q("Background",l))}),r.on("onColorChange",l=>{Z.color!==l&&(Z.color=l,X.setStr(ne.PLAYER_COLOR,l),ce.addEvent([d.INPUT_EV_PLAYER_COLOR,l]),Q("Color",l))}),r.on("onNameChange",l=>{Z.name!==l&&(Z.name=l,X.setStr(ne.PLAYER_NAME,l),ce.addEvent([d.INPUT_EV_PLAYER_NAME,l]),Q("Name",l))}),r.on("onOtherPlayerClickSoundEnabledChange",l=>{Z.otherPlayerClickSoundEnabled!==l&&(Z.otherPlayerClickSoundEnabled=l,X.setBool(ne.OTHER_PLAYER_CLICK_SOUND_ENABLED,l),Q("Other player sounds",l))}),r.on("onSoundsEnabledChange",l=>{Z.soundsEnabled!==l&&(Z.soundsEnabled=l,X.setBool(ne.SOUND_ENABLED,l),Q("Sounds",l))}),r.on("onSoundsVolumeChange",l=>{Z.soundsVolume!==l&&(Z.soundsVolume=l,X.setInt(ne.SOUND_VOLUME,l),rs(),Q("Volume",l))}),r.on("onShowPlayerNamesChange",l=>{Z.showPlayerNames!==l&&(Z.showPlayerNames=l,X.setBool(ne.SHOW_PLAYER_NAMES,l),Q("Player names",l))}),r.on("setHotkeys",l=>{ce.setHotkeys(l)}),r.on("requireRerender",()=>{se=!0});const ys=[];let Je;const Eo=()=>{ys.forEach(l=>{clearInterval(l)}),Je&&clearTimeout(Je)};if(n===xe?ys.push(setInterval(()=>{Qe(x())},1e3)):n===_e&&Xe(),n===xe)Ce.onServerChange(l=>{l[0],l[1],l[2];const p=l[3];let w=!1,L=!1;for(const[G,I]of p)switch(G){case d.CHANGE_PLAYER:{const M=D.decodePlayer(I);M.id!==t&&(k.setPlayer(e,M.id,M),w=!0)}break;case d.CHANGE_PIECE:{const M=D.decodePiece(I);k.setPiece(e,M.idx,M),w=!0}break;case d.CHANGE_DATA:k.setPuzzleData(e,I),w=!0;break;case d.PLAYER_SNAP:I!==t&&(L=!0);break}L&&gt()&&os()&&_o(),w&&(se=!0),pt=!!k.getFinishTs(e)});else if(n===_e){const l=(L,G)=>{const I=L;if(I[0]===d.LOG_ADD_PLAYER){const M=I[1];return k.addPlayer(e,M,G),!0}if(I[0]===d.LOG_UPDATE_PLAYER){const M=k.getPlayerIdByIndex(e,I[1]);if(!M)throw"[ 2021-05-17 player not found (update player) ]";return k.addPlayer(e,M,G),!0}if(I[0]===d.LOG_HANDLE_INPUT){const M=k.getPlayerIdByIndex(e,I[1]);if(!M)throw"[ 2021-05-17 player not found (handle input) ]";const Pe=I[2];return k.handleInput(e,M,Pe,G),!0}return!1};let p=c.lastGameTs;const w=async()=>{c.logPointer+1>=c.log.length&&await ee(e);const L=ve.timestamp();if(c.paused){c.lastRealTs=L,Je=setTimeout(w,50);return}const I=(L-c.lastRealTs)*c.speeds[c.speedIdx];let M=c.lastGameTs+I,Pe=!0;do if(c.paused)Pe=!1;else{const Ie=c.logPointer+1;if(Ie>=c.log.length)Pe=!1;else{const _s=c.log[c.logPointer],Es=p+_s[_s.length-1],ft=c.log[Ie],vs=ft[ft.length-1],yt=Es+vs;yt>M?(M+500*ve.MS<yt&&(M+=vs),Pe=!1):(p=Es,l(ft,yt)&&(se=!0),c.logPointer=Ie)}}while(Pe);c.lastRealTs=L,c.lastGameTs=M,Qe(x()),c.final||(Je=setTimeout(w,50))};w()}const vo=Or({update:()=>{ce.createKeyEvents();for(const l of ce.consumeAll())if(n===xe){const p=l[0];if(p===d.INPUT_EV_MOVE){const G=V.worldDimToViewportRaw({w:l[1],h:l[2]});se=!0,V.move(G.w,G.h),delete ue.last}else if(p===d.INPUT_EV_MOUSE_MOVE){if(l[5]&&!k.getFirstOwnedPiece(e,t)){const I=V.worldDimToViewportRaw({w:l[3],h:l[4]});se=!0,V.move(I.w,I.h),delete ue.last}}else if(p===d.INPUT_EV_PLAYER_COLOR)mt(l[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Be(!0);else if(p===d.INPUT_EV_MOUSE_UP)Be(!1);else if(p===d.INPUT_EV_ZOOM_IN){const G={x:l[1],y:l[2]};se=!0,V.zoom("in",V.worldToViewportRaw(G)),delete ue.last}else if(p===d.INPUT_EV_ZOOM_OUT){const G={x:l[1],y:l[2]};se=!0,V.zoom("out",V.worldToViewportRaw(G)),delete ue.last}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)gs();else if(p===d.INPUT_EV_TOGGLE_SOUNDS)ms();else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)fs();else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE){const G="center",I=qe(G);Q(I?`Restored position "${I}"`:`Position "${G}" not set`)}else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)$e=!$e,Q(`${$e?"Showing":"Hiding"} finished pieces`),se=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)Ae=!Ae,Q(`${Ae?"Showing":"Hiding"} unfinished pieces`),se=!0;else if(p===d.INPUT_EV_STORE_POS){const G=`${l[1]}`;ue[G]=V.snapshot(),Q(`Stored position ${G}`)}else if(p===d.INPUT_EV_RESTORE_POS){const G=`${l[1]}`,I=qe(G);Q(I?`Restored position "${I}"`:`Position "${G}" not set`)}const w=x(),L=k.handleInput(e,t,l,w);gt()&&L.find(G=>G[0]===d.PLAYER_SNAP)&&rs(),L.length>0&&(se=!0),Ce.sendClientEvent(l)}else if(n===_e){const p=l[0];if(p===d.INPUT_EV_REPLAY_TOGGLE_PAUSE)hs();else if(p===d.INPUT_EV_REPLAY_SPEED_DOWN)ps();else if(p===d.INPUT_EV_REPLAY_SPEED_UP)ds();else if(p===d.INPUT_EV_MOVE){const w=V.worldDimToViewportRaw({w:l[1],h:l[2]});se=!0,V.move(w.w,w.h)}else if(p===d.INPUT_EV_MOUSE_MOVE){if(l[5]){const L=V.worldDimToViewportRaw({w:l[3],h:l[4]});se=!0,V.move(L.w,L.h)}}else if(p===d.INPUT_EV_PLAYER_COLOR)mt(l[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Be(!0);else if(p===d.INPUT_EV_MOUSE_UP)Be(!1);else if(p===d.INPUT_EV_ZOOM_IN){const w={x:l[1],y:l[2]};se=!0,V.zoom("in",V.worldToViewportRaw(w))}else if(p===d.INPUT_EV_ZOOM_OUT){const w={x:l[1],y:l[2]};se=!0,V.zoom("out",V.worldToViewportRaw(w))}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)gs();else if(p===d.INPUT_EV_TOGGLE_SOUNDS)ms();else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)fs();else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE){const w="center",L=qe(w);Q(L?`Restored position "${L}"`:`Position "${w}" not set`)}else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)$e=!$e,Q(`${$e?"Showing":"Hiding"} finished pieces`),se=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)Ae=!Ae,Q(`${Ae?"Showing":"Hiding"} unfinished pieces`),se=!0;else if(p===d.INPUT_EV_STORE_POS){const w=`${l[1]}`;ue[w]=V.snapshot(),Q(`Stored position ${w}`)}else if(p===d.INPUT_EV_RESTORE_POS){const w=`${l[1]}`,L=qe(w);Q(L?`Restored position "${L}"`:`Position "${w}" not set`)}}pt=!!k.getFinishTs(e),ss()&&(U.update(),se=!0)},render:async()=>{if(!se)return;const l=x();let p,w,L;window.DEBUG&&Te.checkpoint_start(0),Y.fillStyle=is(),Y.fillRect(0,0,$.width,$.height),window.DEBUG&&Te.checkpoint("clear done"),p=V.worldToViewportRaw(Jt),w=V.worldDimToViewportRaw(dt),Y.fillStyle="rgba(255, 255, 255, .3)",Y.fillRect(p.x,p.y,w.w,w.h),window.DEBUG&&Te.checkpoint("board done");const G=k.getPiecesSortedByZIndex(e);window.DEBUG&&Te.checkpoint("get pieces done"),w=V.worldDimToViewportRaw(es);for(const M of G)!Za(M)||(L=E[M.idx],p=V.worldToViewportRaw({x:we+M.pos.x,y:we+M.pos.y}),Y.drawImage(L,0,0,L.width,L.height,p.x,p.y,w.w,w.h));window.DEBUG&&Te.checkpoint("pieces done");const I=[];for(const M of k.getActivePlayers(e,l))a(M)&&(L=await P(M),p=V.worldToViewport(M),Y.drawImage(L,p.x-F,p.y-S),ns()&&I.push([`${M.name} (${M.points})`,p.x,p.y+O]));Y.fillStyle="white",Y.textAlign="center";for(const[M,Pe,Ie]of I)Y.fillText(M,Pe,Ie);window.DEBUG&&Te.checkpoint("players done"),Qe(l),window.DEBUG&&Te.checkpoint("HUD done"),ss()&&U.render(),se=!1}}),wo=()=>{Eo(),vo.stop(),ce&&ce.unregisterEvents()};return{previewImageUrl:fo,player:Z,game:k.get(e),disconnect:Ce.disconnect,connect:te,unload:wo}}const Ha=oe({name:"game",components:{PuzzleStatusComponent:Ft,Scores:Bt,SettingsOverlay:It,PreviewOverlay:Yt,InfoOverlay:Wt,ConnectionOverlay:Hs,HelpOverlay:Ht},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:Us(),g:{player:Rs(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await po(`${this.$route.params.id}`,ge.clientId(),this.$config.WS_ADDRESS,xe,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}}}),ja={id:"game"},Ka=o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),qa={class:"menu-left"},Qa={key:0,class:"switch-game-replay"},Xa=A("\u21AA\uFE0F Watch replay"),Ja={class:"menu"},eu={class:"tabs"},tu=A("\u{1F9E9} Puzzles"),su={class:"menu-right"},ou={key:4,class:"status-messages"},nu={ref:"canvas"};function iu(e,t,s,n,i,r){const a=N("settings-overlay"),u=N("preview-overlay"),m=N("info-overlay"),y=N("help-overlay"),R=N("overlay"),z=N("connection-overlay"),_=N("puzzle-status"),g=N("router-link"),T=N("scores");return h(),v("div",ja,[e.overlay==="settings"?(h(),ie(a,{key:0,onClose:t[0]||(t[0]=f=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=f=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=f=>e.g.player=f)},null,8,["modelValue"])):W("",!0),e.overlay==="preview"?(h(),ie(u,{key:1,onClose:t[3]||(t[3]=f=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=f=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):W("",!0),e.g.game&&e.overlay==="info"?(h(),ie(m,{key:2,onClose:t[5]||(t[5]=f=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=f=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):W("",!0),e.overlay==="help"?(h(),ie(y,{key:3,onClose:t[7]||(t[7]=f=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=f=>e.toggle("help",!0))})):W("",!0),H(j(R,null,{default:re(()=>[Ka]),_:1},512),[[it,e.cuttingPuzzle]]),j(z,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),o("div",qa,[j(_,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(h(),v("div",Qa,[j(g,{to:{name:"replay",params:{id:e.g.game.id}}},{default:re(()=>[Xa]),_:1},8,["to"])])):W("",!0)]),o("div",Ja,[o("div",eu,[j(g,{class:"opener",to:{name:"index"},target:"_blank"},{default:re(()=>[tu]),_:1}),o("div",{class:"opener",onClick:t[9]||(t[9]=f=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[10]||(t[10]=f=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[11]||(t[11]=f=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[12]||(t[12]=f=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",su,[j(T,{players:e.players},null,8,["players"])]),e.statusMessages.length?(h(),v("div",ou,[(h(!0),v(ae,null,me(e.statusMessages,(f,F)=>(h(),v("div",{key:F},B(f),1))),128))])):W("",!0),o("canvas",nu,null,512)])}var lu=J(Ha,[["render",iu]]);const ru=oe({name:"replay",components:{PuzzleStatusComponent:Ft,Scores:Bt,SettingsOverlay:It,PreviewOverlay:Yt,InfoOverlay:Wt,HelpOverlay:Ht},data(){return{statusMessages:[],players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:Us(),g:{player:Rs(),game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("togglePreview",t=>{this.toggleTo("preview",t,!1)}),this.eventBus.on("toggleSoundsEnabled",t=>{this.g.player.soundsEnabled=!!t}),this.eventBus.on("togglePlayerNames",t=>{this.g.player.showPlayerNames=!!t}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.otherPlayerClickSoundEnabled,t=>{this.eventBus.emit("onOtherPlayerClickSoundEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await po(`${this.$route.params.id}`,ge.clientId(),this.$config.WS_ADDRESS,_e,e,this.eventBus),this.eventBus.on("statusMessage",t=>{this.addStatusMessage(t.what,t.value)})},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{addStatusMessage(e,t){typeof t=="undefined"?this.statusMessages.push(`${e}`):t===!0||t===!1?this.statusMessages.push(`${e} ${t?"enabled":"disabled"}`):this.statusMessages.push(`${e} changed to ${t}`),setTimeout(()=>{this.statusMessages.shift()},3e3)},onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggleTo(e,t,s){t===!1?(this.overlay="",s&&this.eventBus.emit("setHotkeys",!0)):(this.overlay=e,s&&this.eventBus.emit("setHotkeys",!1))},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0)),e==="preview"&&this.eventBus.emit("onPreviewChange",this.overlay==="preview")}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),au={id:"replay"},uu={key:4,class:"overlay"},cu=o("div",{class:"overlay-content"},[o("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),du=[cu],pu={class:"menu-left"},hu={class:"playback-control"},gu={key:0,class:"switch-game-replay"},mu=A("\u{1F9E9} To the game"),fu={class:"menu"},yu={class:"tabs"},_u=A("\u{1F9E9} Puzzles"),Eu={class:"menu-right"},vu={key:5,class:"status-messages"},wu={ref:"canvas"};function Pu(e,t,s,n,i,r){const a=N("settings-overlay"),u=N("preview-overlay"),m=N("info-overlay"),y=N("help-overlay"),R=N("puzzle-status"),z=N("router-link"),_=N("scores");return h(),v("div",au,[e.overlay==="settings"?(h(),ie(a,{key:0,onClose:t[0]||(t[0]=g=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=g=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=g=>e.g.player=g)},null,8,["modelValue"])):W("",!0),e.overlay==="preview"?(h(),ie(u,{key:1,onClose:t[3]||(t[3]=g=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=g=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"])):W("",!0),e.g.game&&e.overlay==="info"?(h(),ie(m,{key:2,onClose:t[5]||(t[5]=g=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=g=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])):W("",!0),e.overlay==="help"?(h(),ie(y,{key:3,onClose:t[7]||(t[7]=g=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=g=>e.toggle("help",!0))})):W("",!0),e.cuttingPuzzle?(h(),v("div",uu,du)):W("",!0),o("div",pu,[j(R,{status:e.status},null,8,["status"]),o("div",hu,[o("div",null,B(e.replayText),1),o("button",{class:"btn",onClick:t[9]||(t[9]=g=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),o("button",{class:"btn",onClick:t[10]||(t[10]=g=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),o("button",{class:"btn",onClick:t[11]||(t[11]=g=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")]),e.g.game?(h(),v("div",gu,[j(z,{to:{name:"game",params:{id:e.g.game.id}}},{default:re(()=>[mu]),_:1},8,["to"])])):W("",!0)]),o("div",fu,[o("div",yu,[j(z,{class:"opener",to:{name:"index"},target:"_blank"},{default:re(()=>[_u]),_:1}),o("div",{class:"opener",onClick:t[12]||(t[12]=g=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),o("div",{class:"opener",onClick:t[13]||(t[13]=g=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),o("div",{class:"opener",onClick:t[14]||(t[14]=g=>e.toggle("info",!0))},"\u2139\uFE0F Info"),o("div",{class:"opener",onClick:t[15]||(t[15]=g=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),o("div",Eu,[j(_,{players:e.players},null,8,["players"])]),e.statusMessages.length?(h(),v("div",vu,[(h(!0),v(ae,null,me(e.statusMessages,(g,T)=>(h(),v("div",{key:T},B(g),1))),128))])):W("",!0),o("canvas",wu,null,512)])}var Cu=J(ru,[["render",Pu]]);let ho=null;async function Su(){ho=await(await ge.get("/api/me",{})).json()}var go={getMe:()=>ho,init:Su};const bu=oe({props:{image:{type:Object,required:!0}},data:()=>({me:go.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function Tu(e,t,s,n,i,r){return h(),v("div",{class:"imageteaser",style:De(e.style),onClick:t[1]||(t[1]=(...a)=>e.onClick&&e.onClick(...a))},[e.canEdit?(h(),v("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=bo((...a)=>e.onEditClick&&e.onEditClick(...a),["stop"]))},"\u270F\uFE0F")):W("",!0)],4)}var $u=J(bu,[["render",Tu]]);const Au=oe({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Ou={class:"overlay"};function Nu(e,t,s,n,i,r){return h(),v("div",Ou,[o("div",{class:je(["overlay-background",e.classes.map(a=>"overlay-background-"+a)]),onClick:t[0]||(t[0]=a=>e.$emit("bgclick"))},null,2),o("div",{class:je(["overlay-content",e.classes.map(a=>"overlay-content-"+a)])},[To(e.$slots,"default")],2)])}var ku=J(Au,[["render",Nu]]);const Uu={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},Ru=["title"];function Vu(e,t,s,n,i,r){return h(),v("div",{style:De(r.style),title:s.title},null,12,Ru)}var Lu=J(Uu,[["render",Vu]]);const Mu=oe({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),Du={key:0,class:"autocomplete"},zu=["onClick"],Gu=["onClick"];function Bu(e,t,s,n,i,r){return h(),v("div",null,[H(o("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=a=>e.input=a),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...a)=>e.onChange&&e.onChange(...a)),onKeydown:t[2]||(t[2]=$o((...a)=>e.add&&e.add(...a),["enter"])),onKeyup:t[3]||(t[3]=(...a)=>e.onKeyUp&&e.onKeyUp(...a))},null,544),[[Oe,e.input]]),e.autocomplete.values?(h(),v("div",Du,[o("ul",null,[(h(!0),v(ae,null,me(e.autocomplete.values,(a,u)=>(h(),v("li",{key:u,class:je({active:u===e.autocomplete.idx}),onClick:m=>e.addVal(a)},B(a),11,zu))),128))])])):W("",!0),(h(!0),v(ae,null,me(e.values,(a,u)=>(h(),v("span",{key:u,class:"bit is-clickable",onClick:m=>e.rm(a)},B(a)+" \u2716",9,Gu))),128))])}var Fu=J(Mu,[["render",Bu],["__scopeId","data-v-d5073870"]]);(async()=>{ge.init(),await go.init();const t=await(await ge.get("/api/conf",{})).json(),s=Ao({history:Oo(),routes:[{name:"index",path:"/",component:En},{name:"new-game",path:"/new-game",component:Gi},{name:"game",path:"/g/:id",component:lu},{name:"replay",path:"/replay/:id",component:Cu}]});s.beforeEach((i,r)=>{r.name&&document.documentElement.classList.remove(`view-${String(r.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const n=No(zo);n.config.globalProperties.$config=t,n.use(s),n.component("connection-overlay",Hs),n.component("edit-image-dialog",Bs),n.component("game-teaser",Ds),n.component("help-overlay",Ht),n.component("image-library",zs),n.component("image-teaser",$u),n.component("info-overlay",Wt),n.component("new-game-dialog",Fs),n.component("new-image-dialog",Gs),n.component("overlay",ku),n.component("preview-overlay",Yt),n.component("puzzle-status",Ft),n.component("responsive-image",Lu),n.component("scores",Bt),n.component("settings-overlay",It),n.component("tags-input",Fu),n.mount("#app")})();
//# sourceMappingURL=index.96ed6ace.js.map
