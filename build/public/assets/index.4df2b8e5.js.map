{"version":3,"file":"index.4df2b8e5.js","sources":["../../../vite/modulepreload-polyfill","../../../plugin-vue:export-helper","../../../src/frontend/App.vue","../../../src/common/Rng.ts","../../../src/common/Util.ts","../../../src/frontend/settings.ts","../../../src/frontend/xhr.ts","../../../src/common/Time.ts","../../../src/frontend/components/GameTeaser.vue","../../../src/frontend/views/Index.vue","../../../src/frontend/components/ImageLibrary.vue","../../../src/frontend/components/NewImageDialog.vue","../../../src/frontend/components/EditImageDialog.vue","../../../src/common/Types.ts","../../../src/frontend/components/NewGameDialog.vue","../../../src/frontend/views/NewGame.vue","../../../src/frontend/components/Scores.vue","../../../src/frontend/components/PuzzleStatus.vue","../../../src/frontend/components/SettingsOverlay.vue","../../../src/frontend/components/PreviewOverlay.vue","../../../src/frontend/components/InfoOverlay.vue","../../../src/common/Protocol.ts","../../../src/frontend/Communication.ts","../../../src/frontend/components/ConnectionOverlay.vue","../../../src/frontend/components/HelpOverlay.vue","../../../src/frontend/click.mp3","../../../src/frontend/grab.png","../../../src/frontend/grab_mask.png","../../../src/frontend/hand.png","../../../src/frontend/hand_mask.png","../../../src/frontend/gameloop.ts","../../../src/frontend/Camera.ts","../../../src/frontend/Graphics.ts","../../../src/frontend/Debug.ts","../../../src/common/Geometry.ts","../../../src/frontend/PuzzleGraphics.ts","../../../src/common/GameCommon.ts","../../../src/frontend/Fireworks.ts","../../../src/frontend/EventAdapter.ts","../../../src/frontend/game.ts","../../../src/frontend/views/Game.vue","../../../src/frontend/views/Replay.vue","../../../src/frontend/user.ts","../../../src/frontend/components/ImageTeaser.vue","../../../src/frontend/components/Overlay.vue","../../../src/frontend/components/ResponsiveImage.vue","../../../src/frontend/components/TagsInput.vue","../../../src/frontend/main.ts"],"sourcesContent":["const p = function polyfill() {\n    const relList = document.createElement('link').relList;\n    if (relList && relList.supports && relList.supports('modulepreload')) {\n        return;\n    }\n    for (const link of document.querySelectorAll('link[rel=\"modulepreload\"]')) {\n        processPreload(link);\n    }\n    new MutationObserver((mutations) => {\n        for (const mutation of mutations) {\n            if (mutation.type !== 'childList') {\n                continue;\n            }\n            for (const node of mutation.addedNodes) {\n                if (node.tagName === 'LINK' && node.rel === 'modulepreload')\n                    processPreload(node);\n            }\n        }\n    }).observe(document, { childList: true, subtree: true });\n    function getFetchOpts(script) {\n        const fetchOpts = {};\n        if (script.integrity)\n            fetchOpts.integrity = script.integrity;\n        if (script.referrerpolicy)\n            fetchOpts.referrerPolicy = script.referrerpolicy;\n        if (script.crossorigin === 'use-credentials')\n            fetchOpts.credentials = 'include';\n        else if (script.crossorigin === 'anonymous')\n            fetchOpts.credentials = 'omit';\n        else\n            fetchOpts.credentials = 'same-origin';\n        return fetchOpts;\n    }\n    function processPreload(link) {\n        if (link.ep)\n            // ep marker = processed\n            return;\n        link.ep = true;\n        // prepopulate the load record\n        const fetchOpts = getFetchOpts(link);\n        fetch(link.href, fetchOpts);\n    }\n};__VITE_IS_MODERN__&&p();","\nexport default (sfc, props) => {\n  const target = sfc.__vccOpts || sfc;\n  for (const [key, val] of props) {\n    target[key] = val;\n  }\n  return target;\n}\n","<template>\n  <div id=\"app\">\n    <ul class=\"nav\" v-if=\"showNav\">\n      <li><router-link class=\"btn\" :to=\"{name: 'index'}\">Games overview</router-link></li>\n      <li><router-link class=\"btn\" :to=\"{name: 'new-game'}\">New game</router-link></li>\n    </ul>\n\n    <router-view />\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n  name: 'app',\n  computed: {\n    showNav () {\n      // TODO: add info wether to show nav to route props\n      return !['game', 'replay'].includes(String(this.$route.name))\n    },\n  },\n})\n</script>\n","export interface RngSerialized {\n  rand_high: number,\n  rand_low: number,\n}\n\nexport class Rng {\n  rand_high: number\n  rand_low: number\n\n  constructor(seed: number) {\n    this.rand_high = seed || 0xDEADC0DE\n    this.rand_low = seed ^ 0x49616E42\n  }\n\n  random (min: number, max: number): number {\n    this.rand_high = ((this.rand_high << 16) + (this.rand_high >> 16) + this.rand_low) & 0xffffffff;\n    this.rand_low = (this.rand_low + this.rand_high) & 0xffffffff;\n    const n = (this.rand_high >>> 0) / 0xffffffff;\n    return (min + n * (max-min+1))|0;\n  }\n\n  // get one random item from the given array\n  choice<T> (array: Array<T>): T {\n    return array[this.random(0, array.length - 1)]\n  }\n\n  // return a shuffled (shallow) copy of the given array\n  shuffle<T> (array: Array<T>): Array<T> {\n    const arr = array.slice()\n    for (let i = 0; i <= arr.length - 2; i++) {\n      const j = this.random(i, arr.length -1)\n      const tmp = arr[i]\n      arr[i] = arr[j]\n      arr[j] = tmp\n    }\n    return arr\n  }\n\n  static serialize (rng: Rng): RngSerialized {\n    return {\n      rand_high: rng.rand_high,\n      rand_low: rng.rand_low\n    }\n  }\n\n  static unserialize (rngSerialized: RngSerialized): Rng {\n    const rng = new Rng(0)\n    rng.rand_high = rngSerialized.rand_high\n    rng.rand_low = rngSerialized.rand_low\n    return rng\n  }\n}\n","import { PuzzleCreationInfo } from '../server/Puzzle'\nimport {\n  EncodedGame,\n  EncodedPiece,\n  EncodedPieceShape,\n  EncodedPlayer,\n  Game,\n  Piece,\n  PieceShape,\n  Player,\n  PuzzleInfo,\n} from './Types'\nimport { Point } from './Geometry'\nimport { Rng } from './Rng'\n\nconst slug = (str: string): string => {\n  let tmp = str.toLowerCase()\n  tmp = tmp.replace(/[^a-z0-9]+/g, '-')\n  tmp = tmp.replace(/^-|-$/, '')\n  return tmp\n}\n\nconst pad = (x: number, pad: string): string => {\n  const str = `${x}`\n  if (str.length >= pad.length) {\n    return str\n  }\n  return pad.substr(0, pad.length - str.length) + str\n}\n\ntype LogArgs = Array<any>\ntype LogFn = (...args: LogArgs) => void\n\nexport const logger = (...pre: string[]): { log: LogFn, error: LogFn, info: LogFn } => {\n  const log = (m: 'log'|'info'|'error') => (...args: LogArgs): void => {\n    const d = new Date()\n    const hh = pad(d.getHours(), '00')\n    const mm = pad(d.getMinutes(), '00')\n    const ss = pad(d.getSeconds(), '00')\n    console[m](`${hh}:${mm}:${ss}`, ...pre, ...args)\n  }\n  return {\n    log: log('log'),\n    error: log('error'),\n    info: log('info'),\n  }\n}\n\n// get a unique id\nexport const uniqId = (): string => {\n  return Date.now().toString(36) + Math.random().toString(36).substring(2)\n}\n\nfunction encodeShape(data: PieceShape): EncodedPieceShape {\n  /* encoded in 1 byte:\n    00000000\n          ^^ top\n        ^^   right\n      ^^     bottom\n    ^^       left\n  */\n  return ((data.top    + 1) << 0)\n       | ((data.right  + 1) << 2)\n       | ((data.bottom + 1) << 4)\n       | ((data.left   + 1) << 6)\n}\n\nfunction decodeShape(data: EncodedPieceShape): PieceShape {\n  return {\n    top:    (data >> 0 & 0b11) - 1,\n    right:  (data >> 2 & 0b11) - 1,\n    bottom: (data >> 4 & 0b11) - 1,\n    left:   (data >> 6 & 0b11) - 1,\n  }\n}\n\nfunction encodePiece(data: Piece): EncodedPiece {\n  return [data.idx, data.pos.x, data.pos.y, data.z, data.owner, data.group]\n}\n\nfunction decodePiece(data: EncodedPiece): Piece {\n  return {\n    idx: data[0],\n    pos: {\n      x: data[1],\n      y: data[2],\n    },\n    z: data[3],\n    owner: data[4],\n    group: data[5],\n  }\n}\n\nfunction encodePlayer(data: Player): EncodedPlayer {\n  return [\n    data.id,\n    data.x,\n    data.y,\n    data.d,\n    data.name,\n    data.color,\n    data.bgcolor,\n    data.points,\n    data.ts,\n  ]\n}\n\nfunction decodePlayer(data: EncodedPlayer): Player {\n  return {\n    id: data[0],\n    x: data[1],\n    y: data[2],\n    d: data[3], // mouse down\n    name: data[4],\n    color: data[5],\n    bgcolor: data[6],\n    points: data[7],\n    ts: data[8],\n  }\n}\n\nfunction encodeGame(data: Game): EncodedGame {\n  return [\n    data.id,\n    data.rng.type || '',\n    Rng.serialize(data.rng.obj),\n    data.puzzle,\n    data.players,\n    data.scoreMode,\n    data.shapeMode,\n    data.snapMode,\n    data.creatorUserId,\n    data.hasReplay,\n    data.gameVersion,\n    data.private,\n  ]\n}\n\nfunction decodeGame(data: EncodedGame): Game {\n  return {\n    id: data[0],\n    rng: {\n      type: data[1],\n      obj: Rng.unserialize(data[2]),\n    },\n    puzzle: data[3],\n    players: data[4],\n    scoreMode: data[5],\n    shapeMode: data[6],\n    snapMode: data[7],\n    creatorUserId: data[8],\n    hasReplay: data[9],\n    gameVersion: data[10],\n    private: data[11],\n  }\n}\n\nfunction coordByPieceIdx(info: PuzzleInfo|PuzzleCreationInfo, pieceIdx: number): Point {\n  const wTiles = info.width / info.tileSize\n  return {\n    x: pieceIdx % wTiles,\n    y: Math.floor(pieceIdx / wTiles),\n  }\n}\n\nconst hash = (str: string): number => {\n  let hash = 0\n\n  for (let i = 0; i < str.length; i++) {\n    const chr = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + chr;\n    hash |= 0; // Convert to 32bit integer\n  }\n  return hash;\n}\n\nfunction asQueryArgs(data: Record<string, any>): string {\n  const q = []\n  for (const k in data) {\n    const pair = [k, data[k]].map(encodeURIComponent)\n    q.push(pair.join('='))\n  }\n  if (q.length === 0) {\n    return ''\n  }\n  return `?${q.join('&')}`\n}\n\nexport default {\n  hash,\n  slug,\n  uniqId,\n\n  encodeShape,\n  decodeShape,\n\n  encodePiece,\n  decodePiece,\n\n  encodePlayer,\n  decodePlayer,\n\n  encodeGame,\n  decodeGame,\n\n  coordByPieceIdx,\n\n  asQueryArgs,\n}\n","/**\n * Player settings\n */\n\nexport const SETTINGS = {\n  SOUND_VOLUME: 'sound_volume',\n  SOUND_ENABLED: 'sound_enabled',\n  OTHER_PLAYER_CLICK_SOUND_ENABLED: 'other_player_click_sound_enabled',\n  COLOR_BACKGROUND: 'bg_color',\n  PLAYER_COLOR: 'player_color',\n  PLAYER_NAME: 'player_name',\n  SHOW_PLAYER_NAMES: 'show_player_names',\n}\n\nexport const DEFAULTS = {\n  SOUND_VOLUME: 100,\n  SOUND_ENABLED: true,\n  OTHER_PLAYER_CLICK_SOUND_ENABLED: true,\n  COLOR_BACKGROUND: '#222222',\n  PLAYER_COLOR: '#ffffff',\n  PLAYER_NAME: 'anon',\n  SHOW_PLAYER_NAMES: true,\n}\n\nexport const defaultPlayerSettings = () => ({\n  background: '',\n  color: '',\n  name: '',\n  soundsEnabled: true,\n  otherPlayerClickSoundEnabled: true,\n  soundsVolume: 100,\n  showPlayerNames: true,\n})\n\nconst set = (setting: string, value: string): void => {\n  localStorage.setItem(setting, value)\n}\n\nconst get = (setting: string): any => {\n  return localStorage.getItem(setting)\n}\n\nconst setInt = (setting: string, val: number): void => {\n  set(setting, `${val}`)\n}\n\nconst getInt = (setting: string, def: number): number => {\n  const value = get(setting)\n  if (value === null) {\n    return def\n  }\n  const vol = parseInt(value, 10)\n  return isNaN(vol) ? def : vol\n}\n\nconst setBool = (setting: string, val: boolean): void => {\n  set(setting, val ? '1' : '0')\n}\n\nconst getBool = (setting: string, def: boolean): boolean => {\n  const value = get(setting)\n  if (value === null) {\n    return def\n  }\n  return value === '1'\n}\n\nconst setStr = (setting: string, val: string): void => {\n  set(setting, val)\n}\n\nconst getStr = (setting: string, def: string): string => {\n  const value = get(setting)\n  if (value === null) {\n    return def\n  }\n  return value\n}\n\nexport default {\n  setInt,\n  getInt,\n  setBool,\n  getBool,\n  setStr,\n  getStr,\n}\n","import Util from \"../common/Util\"\nimport settings from \"./settings\"\n\nexport interface Response {\n  status: number,\n  text: string,\n  json: () => Promise<any>,\n}\n\nexport interface Options {\n  body: FormData|string,\n  headers?: any,\n  onUploadProgress?: (ev: ProgressEvent<XMLHttpRequestEventTarget>) => any,\n}\n\nlet xhrClientId: string = ''\nlet xhrClientSecret: string = ''\nconst request = async (\n  method: string,\n  url: string,\n  options: Options\n): Promise<Response> => {\n  return new Promise((resolve, reject) => {\n    const xhr = new window.XMLHttpRequest()\n    xhr.open(method, url, true)\n    xhr.withCredentials = true\n    for (const k in options.headers || {}) {\n      xhr.setRequestHeader(k, options.headers[k])\n    }\n\n    xhr.setRequestHeader('Client-Id', xhrClientId)\n    xhr.setRequestHeader('Client-Secret', xhrClientSecret)\n\n    xhr.addEventListener('load', function (ev: ProgressEvent<XMLHttpRequestEventTarget>\n      ) {\n      resolve({\n        status: this.status,\n        text: this.responseText,\n        json: async () => JSON.parse(this.responseText),\n      })\n    })\n    xhr.addEventListener('error', function (ev: ProgressEvent<XMLHttpRequestEventTarget>) {\n      reject(new Error('xhr error'))\n    })\n    if (xhr.upload && options.onUploadProgress) {\n      xhr.upload.addEventListener('progress', function (ev: ProgressEvent<XMLHttpRequestEventTarget>) {\n        // typescript complains without this extra check\n        if (options.onUploadProgress) {\n          options.onUploadProgress(ev)\n        }\n      })\n    }\n    xhr.send(options.body || null)\n  })\n}\n\nconst uniq = (str: string) => {\n  let val = settings.getStr(str, '')\n  if (!val) {\n    val = Util.uniqId()\n    settings.setStr(str, val)\n  }\n  return val\n}\n\nexport default {\n  init: () => {\n    xhrClientId = uniq('ID')\n    xhrClientSecret = uniq('SECRET')\n  },\n  request,\n  get: (url: string, options: any): Promise<Response> => {\n    return request('get', url, options)\n  },\n  post: (url: string, options: any): Promise<Response> => {\n    return request('post', url, options)\n  },\n  clientId: () => xhrClientId\n}\n","const MS = 1\nconst SEC = MS * 1000\nconst MIN = SEC * 60\nconst HOUR = MIN * 60\nconst DAY = HOUR * 24\n\nexport const timestamp = (): number => {\n  const d = new Date();\n  return Date.UTC(\n    d.getUTCFullYear(),\n    d.getUTCMonth(),\n    d.getUTCDate(),\n    d.getUTCHours(),\n    d.getUTCMinutes(),\n    d.getUTCSeconds(),\n    d.getUTCMilliseconds(),\n  )\n}\n\nexport const durationStr = (duration: number): string => {\n  const d = Math.floor(duration / DAY)\n  duration = duration % DAY\n\n  const h = Math.floor(duration / HOUR)\n  duration = duration % HOUR\n\n  const m = Math.floor(duration / MIN)\n  duration = duration % MIN\n\n  const s = Math.floor(duration / SEC)\n\n  return `${d}d ${h}h ${m}m ${s}s`\n}\n\nexport const timeDiffStr = (\n  from: number,\n  to: number\n): string => durationStr(to - from)\n\nexport default {\n  MS,\n  SEC,\n  MIN,\n  HOUR,\n  DAY,\n\n  timestamp,\n  timeDiffStr,\n  durationStr,\n}\n","<template>\n  <div class=\"game-teaser\" :style=\"style\">\n    <router-link class=\"game-info\" :to=\"{ name: 'game', params: { id: game.id } }\">\n      <span class=\"game-info-text\">\n        🧩 {{game.tilesFinished}}/{{game.tilesTotal}}<br />\n        👥 {{game.players}}<br />\n        {{time(game.started, game.finished)}}<br />\n      </span>\n    </router-link>\n    <router-link v-if=\"game.hasReplay\" class=\"game-replay\" :to=\"{ name: 'replay', params: { id: game.id } }\">\n      ↪️ Watch replay\n    </router-link>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport Time from './../../common/Time'\n\nexport default defineComponent({\n  props: {\n    game: {\n      type: Object,\n      required: true,\n    },\n  },\n  computed: {\n    style (): object {\n      const url = this.game.imageUrl.replace('uploads/', 'uploads/r/') + '-375x210.webp'\n      return {\n        'background-image': `url(\"${url}\")`,\n      }\n    },\n  },\n  methods: {\n    time(start: number, end: number) {\n      const icon = end ? '🏁' : '⏳'\n      const from = start;\n      const to = end || Time.timestamp()\n      const timeDiffStr = Time.timeDiffStr(from, to)\n      return `${icon} ${timeDiffStr}`\n    },\n  },\n})\n</script>\n","<template>\n  <div>\n    <h1>Running games</h1>\n    <div class=\"game-teaser-wrap\" v-for=\"(g, idx) in gamesRunning\" :key=\"idx\">\n      <game-teaser :game=\"g\" />\n    </div>\n\n    <h1>Finished games</h1>\n    <div class=\"game-teaser-wrap\" v-for=\"(g, idx) in gamesFinished\" :key=\"idx\">\n      <game-teaser :game=\"g\" />\n    </div>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport xhr from '../xhr'\n\nimport GameTeaser from './../components/GameTeaser.vue'\n\nexport default defineComponent({\n  components: {\n    GameTeaser,\n  },\n  data() {\n    return {\n      gamesRunning: [],\n      gamesFinished: [],\n    }\n  },\n  async created() {\n    const res = await xhr.get('/api/index-data', {})\n    const json = await res.json()\n    this.gamesRunning = json.gamesRunning\n    this.gamesFinished = json.gamesFinished\n  },\n})\n</script>\n","<template>\n  <div>\n    <image-teaser v-for=\"(i,idx) in images\" :image=\"i\" @click=\"imageClicked(i)\" @editClick=\"imageEditClicked(i)\" :key=\"idx\" />\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport { Image } from '../../common/Types'\n\nexport default defineComponent({\n  props: {\n    images: {\n      type: Array,\n      required: true,\n    },\n  },\n  emits: {\n    imageClicked: null,\n    imageEditClicked: null,\n  },\n  methods: {\n    imageClicked (image: Image) {\n      this.$emit('imageClicked', image)\n    },\n    imageEditClicked (image: Image) {\n      this.$emit('imageEditClicked', image)\n    },\n  },\n})\n</script>\n","\"Upload image\" clicked: what it looks like when the image was uploaded.\nProbably needs a (x) in the upper right corner of the image to allow the\nuser to remove the image if a wrong one was selected. The image should\nbe uploaded to the actual gallery only when the user presses \"post to\ngallery\", if possible!\n<template>\n  <overlay class=\"new-image-dialog\">\n    <template v-slot:default>\n      <div\n        class=\"area-image\"\n        :class=\"{'has-image': !!previewUrl, 'no-image': !previewUrl, droppable: droppable}\"\n        @drop=\"onDrop\"\n        @dragover=\"onDragover\"\n        @dragleave=\"onDragleave\">\n        <!-- TODO: ...  -->\n        <div class=\"drop-target\"></div>\n        <div v-if=\"previewUrl\" class=\"has-image\">\n          <span class=\"remove btn\" @click=\"previewUrl=''\">X</span>\n          <responsive-image :src=\"previewUrl\" />\n        </div>\n        <div v-else>\n          <label class=\"upload\">\n            <input type=\"file\" style=\"display: none\" @change=\"onFileSelect\" accept=\"image/*\" />\n            <span class=\"btn\">Upload File</span>\n          </label>\n        </div>\n      </div>\n\n      <div class=\"area-settings\">\n        <table>\n          <tr>\n            <td><label>Title</label></td>\n            <td><input type=\"text\" v-model=\"title\" placeholder=\"Flower by @artist\" /></td>\n          </tr>\n          <tr>\n            <td colspan=\"2\">\n              <div class=\"hint\">Feel free to leave a credit to the artist/photographer in the title :)</div>\n            </td>\n          </tr>\n          <tr>\n            <td><label>Private Image</label></td>\n            <td>\n              <input type=\"checkbox\" v-model=\"isPrivate\" />\n            </td>\n          </tr>\n          <tr>\n            <!-- TODO: autocomplete tags -->\n            <td><label>Tags</label></td>\n            <td>\n              <tags-input v-model=\"tags\" :autocompleteTags=\"autocompleteTags\" />\n            </td>\n          </tr>\n        </table>\n      </div>\n\n      <div class=\"area-buttons\">\n        <button class=\"btn\"\n          v-if=\"!isPrivate\"\n          :disabled=\"!canPostToGallery\"\n          @click=\"postToGallery\"\n        >\n          <template v-if=\"uploading === 'postToGallery'\">Uploading ({{uploadProgressPercent}}%)</template>\n          <template v-else>🖼️ Post to gallery</template>\n        </button>\n        <button class=\"btn\"\n          :disabled=\"!canSetupGameClick\"\n          @click=\"setupGameClick\"\n        >\n          <template v-if=\"uploading === 'setupGame'\">Uploading ({{uploadProgressPercent}}%)</template>\n          <template v-else-if=\"isPrivate\">🧩 Set up game</template>\n          <template v-else>🧩 Post to gallery <br /> + set up game</template>\n        </button>\n      </div>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport { logger } from '../../common/Util'\n\nconst log = logger('NewImageDialog.vue')\n\nexport default defineComponent({\n  props: {\n    autocompleteTags: {\n      type: Function,\n    },\n    uploadProgress: {\n      type: Number,\n    },\n    uploading: {\n      type: String,\n    },\n  },\n  emits: {\n    setupGameClick: null,\n    postToGalleryClick: null,\n  },\n  data () {\n    return {\n      previewUrl: '',\n      file: null as File|null,\n      title: '',\n      tags: [] as string[],\n      isPrivate: false,\n      droppable: false,\n    }\n  },\n  computed: {\n    uploadProgressPercent (): number {\n      return this.uploadProgress ? Math.round(this.uploadProgress * 100) : 0\n    },\n    canPostToGallery (): boolean {\n      if (this.uploading) {\n        return false\n      }\n      return !!(this.previewUrl && this.file)\n    },\n    canSetupGameClick (): boolean {\n      if (this.uploading) {\n        return false\n      }\n      return !!(this.previewUrl && this.file)\n    },\n  },\n  methods: {\n    reset(): void {\n      this.previewUrl = ''\n      this.file = null\n      this.title = ''\n      this.tags = []\n      this.isPrivate = false\n      this.droppable = false\n    },\n    imageFromDragEvt (evt: DragEvent): DataTransferItem|null {\n      const items = evt.dataTransfer?.items\n      if (!items || items.length === 0) {\n        return null\n      }\n      const item = items[0]\n      if (!item.type.startsWith('image/')) {\n        return null\n      }\n      return item\n    },\n    onFileSelect (evt: Event) {\n      const target = (evt.target as HTMLInputElement)\n      if (!target.files) return;\n      const file = target.files[0]\n      if (!file) return;\n\n      this.preview(file)\n    },\n    preview (file: File) {\n      const r = new FileReader()\n      r.readAsDataURL(file)\n      r.onload = (ev: any) => {\n        this.previewUrl = ev.target.result\n        this.file = file\n      }\n    },\n    postToGallery () {\n      this.$emit('postToGalleryClick', {\n        file: this.file,\n        title: this.title,\n        tags: this.tags,\n        isPrivate: this.isPrivate,\n      })\n      this.reset()\n    },\n    setupGameClick () {\n      this.$emit('setupGameClick', {\n        file: this.file,\n        title: this.title,\n        tags: this.tags,\n        isPrivate: this.isPrivate,\n      })\n      this.reset()\n    },\n    onDrop (evt: DragEvent): boolean {\n      this.droppable = false\n      const img = this.imageFromDragEvt(evt)\n      if (!img) {\n        return false\n      }\n      const f = img.getAsFile()\n      if (!f) {\n        return false\n      }\n      this.file = f\n      this.preview(f)\n      evt.preventDefault()\n      return false\n    },\n    onDragover (evt: DragEvent): boolean {\n      const img = this.imageFromDragEvt(evt)\n      if (!img) {\n        return false\n      }\n      this.droppable = true\n      evt.preventDefault()\n      return false\n    },\n    onDragleave () {\n      this.droppable = false\n    },\n  },\n})\n</script>\n\n// TODO: scoped vs .new-image-dialog\n<style>\n.new-image-dialog .overlay-content {\n  display: grid;\n  grid-template-columns: auto 450px;\n  grid-template-rows: auto;\n  grid-template-areas:\n    \"image settings\"\n    \"image buttons\";\n  height: 90%;\n  width: 80%;\n}\n@media (max-width: 1400px) and (min-height: 720px),\n       (max-width: 1000px) {\n  .new-image-dialog .overlay-content {\n    grid-template-columns: auto;\n    grid-template-rows: 1fr min-content min-content;\n    grid-template-areas:\n      \"image\"\n      \"settings\"\n      \"buttons\";\n  }\n  .new-image-dialog .overlay-content .area-buttons .btn br {\n    display: none;\n  }\n}\n\n.new-image-dialog .area-image {\n  grid-area: image;\n  margin: .5em;\n  border: solid 6px transparent;\n}\n.new-image-dialog .area-image.no-image {\n  align-content: center;\n  display: grid;\n  text-align: center;\n  border: solid 6px;\n  position: relative;\n}\n.new-image-dialog .area-image.droppable {\n  border: dashed 6px;\n}\n.new-image-dialog .area-image .has-image {\n  position: relative;\n  width: 100%;\n  height: 100%;\n}\n.new-image-dialog .area-image .has-image .remove {\n  position: absolute;\n  top: .5em;\n  left: .5em;\n}\n\n.new-image-dialog .area-settings {\n  grid-area: settings;\n}\n.new-game-dialog .area-settings td:first-child {\n  white-space: nowrap;\n}\n.new-image-dialog .area-settings table input[type=\"text\"] {\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.new-image-dialog .area-buttons {\n  align-self: end;\n  grid-area: buttons;\n}\n.new-image-dialog .area-buttons button {\n  width: 100%;\n  margin-top: .5em;\n}\n.new-image-dialog .upload {\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  cursor: pointer;\n}\n.new-image-dialog .upload .btn {\n  position: absolute;\n  top: 50%;\n  transform: translate(-50%,-50%);\n}\n.area-image .drop-target {\n  display: none;\n}\n.area-image.droppable .drop-target {\n  pointer-events: none;\n  position: absolute;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  z-index: 3;\n}\n</style>\n","<template>\n  <overlay class=\"edit-image-dialog\">\n    <template v-slot:default>\n      <div class=\"area-image\">\n        <div class=\"has-image\">\n          <responsive-image :src=\"image.url\" :title=\"image.title\" />\n        </div>\n      </div>\n\n      <div class=\"area-settings\">\n        <table>\n          <tr>\n            <td><label>Title</label></td>\n            <td><input type=\"text\" v-model=\"title\" placeholder=\"Flower by @artist\" /></td>\n          </tr>\n          <tr>\n            <td colspan=\"2\">\n              <div class=\"hint\">Feel free to leave a credit to the artist/photographer in the title :)</div>\n            </td>\n          </tr>\n          <tr>\n            <!-- TODO: autocomplete tags -->\n            <td><label>Tags</label></td>\n            <td>\n              <tags-input v-model=\"tags\" :autocompleteTags=\"autocompleteTags\" />\n            </td>\n          </tr>\n        </table>\n      </div>\n\n      <div class=\"area-buttons\">\n        <button class=\"btn\" @click=\"saveImage\">🖼️ Save image</button>\n      </div>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent, PropType } from 'vue'\nimport { Image, Tag } from '../../common/Types'\n\nexport default defineComponent({\n  props: {\n    image: {\n      type: Object as PropType<Image>,\n      required: true,\n    },\n    autocompleteTags: {\n      type: Function,\n    },\n  },\n  emits: {\n    saveClick: null,\n  },\n  data () {\n    return {\n      title: '',\n      tags: [] as string[],\n    }\n  },\n  watch: {\n    image(newValue, oldValue) {\n      this.init(newValue)\n    },\n  },\n  created () {\n    this.init(this.image)\n  },\n  methods: {\n    init(image: Image) {\n      this.title = image.title\n      this.tags = image.tags.map((t: Tag) => t.title)\n    },\n    saveImage () {\n      this.$emit('saveClick', {\n        id: this.image.id,\n        title: this.title,\n        tags: this.tags,\n      })\n    },\n  },\n})\n</script>\n\n// TODO: scoped vs .edit-image-dialog\n<style>\n.edit-image-dialog .overlay-content {\n  display: grid;\n  grid-template-columns: auto 450px;\n  grid-template-rows: auto;\n  grid-template-areas:\n    \"image settings\"\n    \"image buttons\";\n  height: 90%;\n  width: 80%;\n}\n@media (max-width: 1400px) and (min-height: 720px),\n       (max-width: 1000px) {\n  .edit-image-dialog .overlay-content {\n    grid-template-columns: auto;\n    grid-template-rows: 1fr min-content min-content;\n    grid-template-areas:\n      \"image\"\n      \"settings\"\n      \"buttons\";\n  }\n}\n.edit-image-dialog .area-image {\n  grid-area: image;\n  margin: 20px;\n}\n.edit-image-dialog .area-image.no-image {\n  align-content: center;\n  display: grid;\n  text-align: center;\n  border: dashed 6px;\n  position: relative;\n}\n.edit-image-dialog .area-image .has-image {\n  position: relative;\n  width: 100%;\n  height: 100%;\n}\n.edit-image-dialog .area-image .has-image .remove {\n  position: absolute;\n  top: .5em;\n  left: .5em;\n}\n\n.edit-image-dialog .area-settings {\n  grid-area: settings;\n}\n\n.edit-image-dialog .area-settings table input[type=\"text\"] {\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.edit-image-dialog .area-buttons {\n  align-self: end;\n  grid-area: buttons;\n}\n.edit-image-dialog .area-buttons button {\n  width: 100%;\n  margin-top: .5em;\n}\n</style>\n","import { Point } from \"./Geometry\"\nimport { Rng, RngSerialized } from \"./Rng\"\n\n// @see https://stackoverflow.com/a/59906630/392905\ntype ArrayLengthMutationKeys = 'splice' | 'push' | 'pop' | 'shift' | 'unshift' | number\ntype ArrayItems<T extends Array<any>> = T extends Array<infer TItems> ? TItems : never\nexport type FixedLengthArray<T extends any[]> =\n  Pick<T, Exclude<keyof T, ArrayLengthMutationKeys>>\n  & { [Symbol.iterator]: () => IterableIterator< ArrayItems<T> > }\n\nexport type Timestamp = number\n\nexport type Input = any\nexport type Change = Array<any>\n\nexport type GameEvent = Array<any>\n\nexport type ServerEvent = Array<any>\nexport type ClientEvent = Array<any>\n\nexport type EncodedPlayer = FixedLengthArray<[\n  string,\n  number,\n  number,\n  0|1,\n  string|null,\n  string|null,\n  string|null,\n  number,\n  Timestamp,\n]>\n\nexport type EncodedPiece = FixedLengthArray<[\n  number,\n  number,\n  number,\n  number,\n  string|number,\n  number,\n]>\n\nexport type EncodedPieceShape = number\n\nexport type EncodedGame = FixedLengthArray<[\n  string,\n  string,\n  RngSerialized,\n  Puzzle,\n  Array<EncodedPlayer>,\n  ScoreMode,\n  ShapeMode,\n  SnapMode,\n  number|null,\n  boolean, // has replay\n  number, // gameVersion\n  boolean, // private\n]>\n\nexport interface ReplayData {\n  log: any[],\n  game: EncodedGame|null\n}\n\nexport interface Tag {\n  id: number\n  slug: string\n  title: string\n  total: number\n}\n\ninterface GameRng {\n  obj: Rng\n  type?: string\n}\n\nexport interface Game {\n  id: string\n  gameVersion: number\n  creatorUserId: number|null\n  players: Array<EncodedPlayer>\n  puzzle: Puzzle\n  scoreMode: ScoreMode\n  shapeMode: ShapeMode\n  snapMode: SnapMode\n  rng: GameRng\n  private: boolean\n  hasReplay: boolean\n}\n\nexport interface Image {\n  id: number\n  filename: string\n  file: string\n  url: string\n  title: string\n  tags: Array<Tag>\n  created: number\n}\n\nexport interface GameSettings {\n  tiles: number\n  private: boolean\n  image: ImageInfo\n  scoreMode: ScoreMode\n  shapeMode: ShapeMode\n  snapMode: SnapMode\n}\n\nexport interface Puzzle {\n  tiles: Array<EncodedPiece>\n  data: PuzzleData\n  info: PuzzleInfo\n}\n\nexport interface PuzzleData {\n  started: number\n  finished: number\n  maxGroup: number\n  maxZ: number\n}\n\nexport interface PuzzleDataChange {\n  started?: number\n  finished?: number\n  maxGroup?: number\n  maxZ?: number\n}\n\ninterface PuzzleTable {\n  width: number\n  height: number\n}\n\nenum PieceEdge {\n  Flat = 0,\n  Out = 1,\n  In = -1,\n}\nexport interface PieceShape {\n  top: PieceEdge\n  bottom: PieceEdge\n  left: PieceEdge\n  right: PieceEdge\n}\n\nexport interface Piece {\n  owner: string|number\n  idx: number\n  pos: Point\n  z: number\n  group: number\n}\n\nexport interface PieceChange {\n  owner?: string|number\n  idx?: number\n  pos?: Point\n  z?: number\n  group?: number\n}\n\nexport interface ImageInfo\n{\n  id: number\n  uploaderUserId: number|null\n  filename: string\n  url: string\n  title: string\n  tags: Tag[]\n  created: Timestamp\n  width: number\n  height: number\n}\n\nexport interface PuzzleInfo {\n  table: PuzzleTable\n  targetTiles: number\n  imageUrl?: string // deprecated, use image.url instead\n  image?: ImageInfo\n\n  width: number\n  height: number\n  tileSize: number\n  tileDrawSize: number\n  tileMarginWidth: number\n  tileDrawOffset: number\n  snapDistance: number\n\n  tiles: number\n  tilesX: number\n  tilesY: number\n\n  shapes: Array<EncodedPieceShape>\n}\n\nexport interface Player {\n  id: string\n  x: number\n  y: number\n  d: 0|1\n  name: string|null\n  color: string|null\n  bgcolor: string|null\n  points: number\n  ts: Timestamp\n}\n\nexport interface PuzzleStatus {\n  finished: boolean\n  duration: number\n  piecesDone: number\n  piecesTotal: number\n}\n\nexport interface PlayerChange {\n  id?: string\n  x?: number\n  y?: number\n  d?: 0|1\n  name?: string|null\n  color?: string|null\n  bgcolor?: string|null\n  points?: number\n  ts?: Timestamp\n}\n\nexport enum ScoreMode {\n  FINAL = 0,\n  ANY = 1,\n}\n\nexport enum ShapeMode {\n  NORMAL = 0,\n  ANY = 1,\n  FLAT = 2,\n}\n\nexport enum SnapMode {\n  NORMAL = 0,\n  REAL = 1,\n}\n\nexport const DefaultScoreMode = (v: any): ScoreMode => {\n  if (v === ScoreMode.FINAL || v === ScoreMode.ANY) {\n    return v\n  }\n  return ScoreMode.FINAL\n}\n\nexport const DefaultShapeMode = (v: any): ShapeMode => {\n  if (v === ShapeMode.NORMAL || v === ShapeMode.ANY || v === ShapeMode.FLAT) {\n    return v\n  }\n  return ShapeMode.NORMAL\n}\n\nexport const DefaultSnapMode = (v: any): SnapMode => {\n  if (v === SnapMode.NORMAL || v === SnapMode.REAL) {\n    return v\n  }\n  return SnapMode.NORMAL\n}\n","<template>\n  <overlay class=\"new-game-dialog\">\n    <template v-slot:default>\n      <div class=\"area-image\">\n        <div class=\"has-image\">\n          <responsive-image :src=\"image.url\" :title=\"image.title\" />\n        </div>\n        <div class=\"image-title\" v-if=\"image.title || image.width || image.height\">\n          <span class=\"image-title-title\" v-if=\"image.title\">\"{{image.title}}\"</span>\n          <span class=\"image-title-dim\" v-if=\"image.width || image.height\">({{image.width}} ✕ {{image.height}})</span>\n        </div>\n      </div>\n\n      <div class=\"area-settings\">\n        <table>\n          <tr>\n            <td><label>Pieces</label></td>\n            <td><input type=\"text\" v-model=\"tiles\" /></td>\n          </tr>\n          <tr>\n            <td><label>Scoring: </label></td>\n            <td>\n              <label><input type=\"radio\" v-model=\"scoreMode\" value=\"1\" />\n              Any (Score when pieces are connected to each other or on final location)</label>\n              <br />\n              <label><input type=\"radio\" v-model=\"scoreMode\" value=\"0\" />\n              Final (Score when pieces are put to their final location)</label>\n            </td>\n          </tr>\n          <tr>\n            <td><label>Shapes: </label></td>\n            <td>\n              <label><input type=\"radio\" v-model=\"shapeMode\" value=\"0\" />\n              Normal</label>\n              <br />\n              <label><input type=\"radio\" v-model=\"shapeMode\" value=\"1\" />\n              Any (Flat pieces can occur anywhere)</label>\n              <br />\n              <label><input type=\"radio\" v-model=\"shapeMode\" value=\"2\" />\n              Flat (All pieces flat on all sides)</label>\n            </td>\n          </tr>\n          <tr>\n            <td><label>Snapping: </label></td>\n            <td>\n              <label><input type=\"radio\" v-model=\"snapMode\" value=\"0\" />\n              Normal (Pieces snap to final destination and to each other)</label>\n              <br />\n              <label><input type=\"radio\" v-model=\"snapMode\" value=\"1\" />\n              Real (Pieces snap only to corners, already snapped pieces and to each other)</label>\n            </td>\n          </tr>\n          <tr>\n            <td><label>Private Game</label></td>\n            <td><input :disabled=\"forcePrivate\" type=\"checkbox\" v-model=\"isPrivate\" /></td>\n          </tr>\n          <tr v-if=\"image.tags.length\">\n            <td><label>Tags: </label></td>\n            <td>\n              <span v-for=\"(tag,idx) in image.tags\" :key=\"idx\" class=\"bit\">{{ tag.title }}</span>\n            </td>\n          </tr>\n        </table>\n      </div>\n\n      <div class=\"area-buttons\">\n        <button class=\"btn\" :disabled=\"!canStartNewGame\" @click=\"onNewGameClick\">\n          🧩 Generate Puzzle\n        </button>\n      </div>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nimport { GameSettings, ScoreMode, ShapeMode, SnapMode } from './../../common/Types'\n\nexport default defineComponent({\n  props: {\n    image: {\n      type: Object,\n      required: true,\n    },\n    forcePrivate: {\n      type: Boolean,\n      default: false,\n    },\n  },\n  emits: {\n    newGame: null,\n  },\n  data() {\n    return {\n      tiles: 1000,\n      isPrivate: false,\n      scoreMode: ScoreMode.ANY,\n      shapeMode: ShapeMode.NORMAL,\n      snapMode: SnapMode.NORMAL,\n    }\n  },\n  mounted() {\n    this.isPrivate = this.forcePrivate\n  },\n  methods: {\n    onNewGameClick () {\n      this.$emit('newGame', {\n        tiles: this.tilesInt,\n        private: this.isPrivate,\n        image: this.image,\n        scoreMode: this.scoreModeInt,\n        shapeMode: this.shapeModeInt,\n        snapMode: this.snapModeInt,\n      } as GameSettings)\n    },\n  },\n  computed: {\n    canStartNewGame () {\n      if (\n        !this.tilesInt\n        || !this.image\n        || !this.image.url\n        || ![0, 1].includes(this.scoreModeInt)\n      ) {\n        return false\n      }\n      return true\n    },\n    scoreModeInt (): number {\n      return parseInt(`${this.scoreMode}`, 10)\n    },\n    shapeModeInt (): number {\n      return parseInt(`${this.shapeMode}`, 10)\n    },\n    snapModeInt (): number {\n      return parseInt(`${this.snapMode}`, 10)\n    },\n    tilesInt (): number {\n      return parseInt(`${this.tiles}`, 10)\n    },\n  },\n})\n</script>\n\n\n// TODO: scoped vs .new-game-dialog\n<style>\n.new-game-dialog .overlay-content {\n  display: grid;\n  grid-template-columns: auto 450px;\n  grid-template-rows: auto;\n  grid-template-areas:\n    \"image settings\"\n    \"image buttons\";\n  height: 90%;\n  width: 80%;\n}\n.new-game-dialog .area-image {\n  grid-area: image;\n  display: grid;\n  grid-template-rows: 1fr min-content;\n  grid-template-areas:\n    \"image\"\n    \"image-title\";\n  margin-right: 1em;\n}\n@media (max-width: 1400px) and (min-height: 720px),\n       (max-width: 1000px) {\n  .new-game-dialog .overlay-content {\n    grid-template-columns: auto;\n    grid-template-rows: 1fr min-content min-content;\n    grid-template-areas:\n      \"image\"\n      \"settings\"\n      \"buttons\";\n  }\n  .new-game-dialog .area-image {\n    margin-right: 0;\n  }\n}\n.new-game-dialog .area-settings {\n  grid-area: settings;\n}\n.new-game-dialog .area-settings td:first-child {\n  white-space: nowrap;\n}\n.new-game-dialog .area-settings table input[type=\"text\"] {\n  width: 100%;\n  box-sizing: border-box;\n}\n\n.new-game-dialog .area-buttons {\n  align-self: end;\n  grid-area: buttons;\n}\n.new-game-dialog .area-buttons button {\n  width: 100%;\n}\n.new-game-dialog .has-image {\n  box-sizing: border-box;\n  grid-area: image;\n  position: relative;\n  width: 100%;\n  height: 100%;\n  border: solid 1px;\n}\n\n.new-game-dialog .image-title {\n  grid-area: image-title;\n  text-align: center;\n  padding: .5em 0;\n  background: var(--main-color);\n  color: #262523;\n}\n\n.new-game-dialog .has-image .remove {\n  position: absolute;\n  top: .5em;\n  left: .5em;\n}\n\n.new-game-dialog .image-title > span { margin-right: .5em; }\n.new-game-dialog .image-title > span:last-child { margin-right: 0; }\n.image-title-dim { display: inline-block; white-space: no-wrap; }\n</style>\n","\"New Game\" page: Upload button big, centered, at the top of the page, as\nvisible as possible. Upload button has a warning that the image will\nbe added to public gallery, just so noone uploads anything naughty on\naccident. The page can show all the images by default, or one of the categories\nof images. Instead of categories, you can make the system tag-based, like\nin jigsawpuzzles.io\n\n<template>\n  <div>\n    <div class=\"upload-image-teaser\">\n      <div class=\"btn btn-big\" @click=\"dialog='new-image'\">Upload your image</div>\n      <div class=\"hint\">(The image you upload will be added to the public gallery.)</div>\n    </div>\n\n    <div>\n      <label v-if=\"tags.length > 0\">\n        Tags:\n        <span\n          class=\"bit is-clickable\"\n          v-for=\"(t,idx) in relevantTags\"\n          :key=\"idx\"\n          @click=\"toggleTag(t)\"\n          :class=\"{on: filters.tags.includes(t.slug)}\">{{t.title}} ({{t.total}})</span>\n        <!-- <select v-model=\"filters.tags\" @change=\"filtersChanged\">\n          <option value=\"\">All</option>\n          <option v-for=\"(c, idx) in tags\" :key=\"idx\" :value=\"c.slug\">{{c.title}}</option>\n        </select> -->\n      </label>\n      <label>\n        Sort by:\n        <select v-model=\"filters.sort\" @change=\"filtersChanged\">\n          <option value=\"date_desc\">Newest first</option>\n          <option value=\"date_asc\">Oldest first</option>\n          <option value=\"alpha_asc\">A-Z</option>\n          <option value=\"alpha_desc\">Z-A</option>\n        </select>\n      </label>\n    </div>\n    <image-library\n      :images=\"images\"\n      @imageClicked=\"onImageClicked\"\n      @imageEditClicked=\"onImageEditClicked\" />\n    <new-image-dialog\n      v-show=\"dialog==='new-image'\"\n      :autocompleteTags=\"autocompleteTags\"\n      @bgclick=\"dialog=''\"\n      :uploadProgress=\"uploadProgress\"\n      :uploading=\"uploading\"\n      @postToGalleryClick=\"postToGalleryClick\"\n      @setupGameClick=\"setupGameClick\"\n      />\n    <edit-image-dialog\n      v-show=\"dialog==='edit-image'\"\n      :autocompleteTags=\"autocompleteTags\"\n      @bgclick=\"dialog=''\"\n      @saveClick=\"onSaveImageClick\"\n      :image=\"image\" />\n    <new-game-dialog\n      v-if=\"image && dialog==='new-game'\"\n      @bgclick=\"dialog=''\"\n      @newGame=\"onNewGame\"\n      :image=\"image\"\n      :forcePrivate=\"newGameForcePrivate\" />\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nimport ImageLibrary from './../components/ImageLibrary.vue'\nimport NewImageDialog from './../components/NewImageDialog.vue'\nimport EditImageDialog from './../components/EditImageDialog.vue'\nimport NewGameDialog from './../components/NewGameDialog.vue'\nimport { GameSettings, Image, Tag } from '../../common/Types'\nimport Util from '../../common/Util'\nimport xhr from '../xhr'\n\nexport default defineComponent({\n  components: {\n    ImageLibrary,\n    NewImageDialog,\n    EditImageDialog,\n    NewGameDialog,\n  },\n  data() {\n    return {\n      filters: {\n        sort: 'date_desc',\n        tags: [] as string[],\n      },\n      images: [],\n      tags: [] as Tag[],\n\n      image: {\n        id: 0,\n        filename: '',\n        file: '',\n        url: '',\n        title: '',\n        tags: [],\n        created: 0,\n      } as Image,\n\n      dialog: '',\n\n      newGameForcePrivate: false,\n\n      uploading: '',\n      uploadProgress: 0,\n    }\n  },\n  async created() {\n    await this.loadImages()\n  },\n  computed: {\n    relevantTags (): Tag[] {\n      return this.tags.filter((tag: Tag) => tag.total > 0)\n    },\n  },\n  methods: {\n    autocompleteTags (input: string, exclude: string[]): string[] {\n      return this.tags\n        .filter((tag: Tag) => {\n          return !exclude.includes(tag.title)\n            && tag.title.toLowerCase().startsWith(input.toLowerCase())\n        })\n        .slice(0, 10)\n        .map((tag: Tag) => tag.title)\n    },\n    toggleTag (t: Tag) {\n      if (this.filters.tags.includes(t.slug)) {\n        this.filters.tags = this.filters.tags.filter(slug => slug !== t.slug)\n      } else {\n        this.filters.tags.push(t.slug)\n      }\n      this.filtersChanged()\n    },\n    async loadImages () {\n      const res = await xhr.get(`/api/newgame-data${Util.asQueryArgs(this.filters)}`, {})\n      const json = await res.json()\n      this.images = json.images\n      this.tags = json.tags\n    },\n    async filtersChanged () {\n      await this.loadImages()\n    },\n    onImageClicked (image: Image) {\n      this.image = image\n      this.newGameForcePrivate = false\n      this.dialog = 'new-game'\n    },\n    onImageEditClicked (image: Image) {\n      this.image = image\n      this.dialog = 'edit-image'\n    },\n    async uploadImage (data: any) {\n      this.uploadProgress = 0\n      const formData = new FormData();\n      formData.append('file', data.file, data.file.name);\n      formData.append('title', data.title)\n      formData.append('tags', data.tags)\n      formData.append('private', data.isPrivate)\n      const res = await xhr.post('/api/upload', {\n        body: formData,\n        onUploadProgress: (evt: ProgressEvent<XMLHttpRequestEventTarget>): void => {\n          this.uploadProgress = evt.loaded / evt.total\n        },\n      })\n      this.uploadProgress = 1\n      return await res.json()\n    },\n    async saveImage (data: any) {\n      const res = await xhr.post('/api/save-image', {\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          id: data.id,\n          title: data.title,\n          tags: data.tags,\n        }),\n      })\n      return await res.json()\n    },\n    async onSaveImageClick(data: any) {\n      const res = await this.saveImage(data)\n      if (res.ok) {\n        this.dialog = ''\n        await this.loadImages()\n      } else {\n        alert(res.error)\n      }\n    },\n    async postToGalleryClick(data: any) {\n      this.uploading = 'postToGallery'\n      await this.uploadImage(data)\n      this.uploading = ''\n      this.dialog = ''\n      await this.loadImages()\n    },\n    async setupGameClick (data: any) {\n      this.uploading = 'setupGame'\n      const image = await this.uploadImage(data)\n      this.uploading = ''\n      this.loadImages() // load images in background\n      this.image = image\n      this.newGameForcePrivate = data.isPrivate\n      this.dialog = 'new-game'\n    },\n    async onNewGame(gameSettings: GameSettings) {\n      const res = await xhr.post('/api/newgame', {\n        headers: {\n          'Accept': 'application/json',\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(gameSettings),\n      })\n      if (res.status === 200) {\n        const game = await res.json()\n        this.$router.push({ name: 'game', params: { id: game.id } })\n      }\n    },\n  },\n})\n</script>\n","<template>\n  <div class=\"scores\">\n    <div>Scores</div>\n    <table>\n      <tr v-for=\"(p, idx) in actives\" :key=\"idx\" :style=\"{color: p.color}\">\n        <td>⚡</td>\n        <td>{{p.name}}</td>\n        <td>{{p.points}}</td>\n      </tr>\n      <tr v-for=\"(p, idx) in idles\" :key=\"idx\" :style=\"{color: p.color}\">\n        <td>💤</td>\n        <td>{{p.name}}</td>\n        <td>{{p.points}}</td>\n      </tr>\n    </table>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n  props: {\n    players: {\n      type: Object,\n      required: true,\n    },\n  },\n  computed: {\n    actives (): Array<any> {\n      // TODO: dont sort in place\n      this.players.active.sort((a: any, b: any) => b.points - a.points)\n      return this.players.active\n    },\n    idles (): Array<any> {\n      // TODO: dont sort in place\n      this.players.idle.sort((a: any, b: any) => b.points - a.points)\n      return this.players.idle\n    },\n  },\n})\n</script>\n","<template>\n  <div class=\"puzzle-status\">\n    <div>\n      🧩 {{status.piecesDone}}/{{status.piecesTotal}}\n    </div>\n    <div>\n      {{icon}} {{durationStr}}\n    </div>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent, PropType } from 'vue'\nimport { PuzzleStatus } from '../../common/Types'\nimport Time from './../../common/Time'\n\nexport default defineComponent({\n  props: {\n    status: {\n      type: Object as PropType<PuzzleStatus>,\n      required: true,\n    },\n  },\n  computed: {\n    icon (): string {\n      return this.status.finished ? '🏁' : '⏳'\n    },\n    durationStr (): string {\n      return Time.durationStr(this.status.duration)\n    },\n  }\n})\n</script>\n","<template>\n  <overlay class=\"transparent\">\n    <template v-slot:default>\n      <table class=\"settings\">\n        <tr>\n          <td><label>Background: </label></td>\n          <td><input type=\"color\" v-model=\"background\" /></td>\n        </tr>\n        <tr>\n          <td><label>Color: </label></td>\n          <td><input type=\"color\" v-model=\"color\" /></td>\n        </tr>\n        <tr>\n          <td><label>Name: </label></td>\n          <td><input type=\"text\" maxLength=\"16\" v-model=\"name\" /></td>\n        </tr>\n        <tr>\n          <td><label>Sounds: </label></td>\n          <td><input type=\"checkbox\" v-model=\"soundsEnabled\" /></td>\n        </tr>\n        <tr>\n          <td><label>Piece connect sounds of others: </label></td>\n          <td><input type=\"checkbox\" :disabled=\"!soundsEnabled\" v-model=\"otherPlayerClickSoundEnabled\" /></td>\n        </tr>\n        <tr>\n          <td><label>Sounds Volume: </label></td>\n          <td class=\"sound-volume\">\n            <span @click=\"decreaseVolume\">🔉</span>\n            <input\n              :disabled=\"!soundsEnabled\"\n              type=\"range\"\n              min=\"0\"\n              max=\"100\"\n              :value=\"soundsVolume\"\n              @change=\"updateVolume\"\n              />\n            <span @click=\"increaseVolume\">🔊</span>\n          </td>\n        </tr>\n        <tr>\n          <td><label>Show player names: </label></td>\n          <td><input type=\"checkbox\" v-model=\"showPlayerNames\" /></td>\n        </tr>\n      </table>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent, WatchStopHandle } from 'vue'\n\nexport default defineComponent({\n  emits: {\n    'update:modelValue': null,\n  },\n  props: {\n    modelValue: {\n      type: Object,\n      required: true,\n    },\n  },\n  data: () => {\n    return {\n      background: '',\n      color: '',\n      name: '',\n      soundsEnabled: true,\n      otherPlayerClickSoundEnabled: true,\n      soundsVolume: 100,\n      showPlayerNames: true,\n\n      watches: [] as WatchStopHandle[],\n    }\n  },\n  methods: {\n    updateVolume (ev: Event): void {\n      const vol = parseInt((ev.target as HTMLInputElement).value)\n      this.soundsVolume = vol\n    },\n    decreaseVolume (): void {\n      this.soundsVolume = Math.max(0, this.soundsVolume - 5)\n    },\n    increaseVolume (): void {\n      this.soundsVolume = Math.min(100, this.soundsVolume + 5)\n    },\n    apply (modelValue: any): void {\n      this.disableWatches()\n      this.background = `${modelValue.background}`\n      this.color = `${modelValue.color}`\n      this.name = `${modelValue.name}`\n      this.soundsEnabled = !!modelValue.soundsEnabled\n      this.otherPlayerClickSoundEnabled = !!modelValue.otherPlayerClickSoundEnabled\n      this.soundsVolume = parseInt(`${modelValue.soundsVolume}`, 10)\n      this.showPlayerNames = !!modelValue.showPlayerNames\n      this.enableWatches()\n    },\n    emitChanges (): void {\n      this.$emit('update:modelValue', {\n        background: this.background,\n        color: this.color,\n        name: this.name,\n        soundsEnabled: this.soundsEnabled,\n        otherPlayerClickSoundEnabled: this.otherPlayerClickSoundEnabled,\n        soundsVolume: this.soundsVolume,\n        showPlayerNames: this.showPlayerNames,\n      })\n    },\n    enableWatches (): void {\n      this.watches.push(this.$watch(() => this.background, this.emitChanges))\n      this.watches.push(this.$watch(() => this.color, this.emitChanges))\n      this.watches.push(this.$watch(() => this.name, this.emitChanges))\n      this.watches.push(this.$watch(() => this.soundsEnabled, this.emitChanges))\n      this.watches.push(this.$watch(() => this.otherPlayerClickSoundEnabled, this.emitChanges))\n      this.watches.push(this.$watch(() => this.soundsVolume, this.emitChanges))\n      this.watches.push(this.$watch(() => this.showPlayerNames, this.emitChanges))\n    },\n    disableWatches (): void {\n      const w = this.watches\n      this.watches = []\n      w.forEach(stop => stop())\n    },\n  },\n  created () {\n    this.apply(this.modelValue)\n    // TODO: ts type PlayerSettings\n    this.$watch(() => this.modelValue, (val: any) => {\n      this.apply(val)\n    }, { deep: true })\n  },\n})\n</script>\n<style scoped>\n.sound-volume span { cursor: pointer; user-select: none; }\n.sound-volume input { vertical-align: middle; }\n</style>\n","<template>\n  <overlay class=\"preview-overlay\" :animate=\"false\">\n    <template v-slot:default>\n      <div class=\"preview\">\n        <div class=\"img\" :style=\"previewStyle\"></div>\n      </div>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n  props: {\n    img: String,\n  },\n  computed: {\n    previewStyle (): object {\n      return {\n        backgroundImage: `url('${this.img}')`,\n      }\n    },\n  },\n})\n</script>\n","<template>\n  <overlay class=\"transparent\">\n    <template v-slot:default>\n      <table class=\"help\">\n        <tr>\n          <td colspan=\"2\">Info about this puzzle</td>\n        </tr>\n        <tr>\n          <td>Image Title: </td>\n          <td>{{game.puzzle.info.image.title}}</td>\n        </tr>\n        <tr>\n          <td>Scoring: </td>\n          <td><span :title=\"snapMode[1]\">{{scoreMode[0]}}</span></td>\n        </tr>\n        <tr>\n          <td>Shapes: </td>\n          <td><span :title=\"snapMode[1]\">{{shapeMode[0]}}</span></td>\n        </tr>\n        <tr>\n          <td>Snapping: </td>\n          <td><span :title=\"snapMode[1]\">{{snapMode[0]}}</span></td>\n        </tr>\n      </table>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent, PropType } from 'vue'\nimport { Game, ScoreMode, ShapeMode, SnapMode } from '../../common/Types'\n\nexport default defineComponent({\n  props: {\n    game: {\n      type: Object as PropType<Game>,\n      required: true,\n    },\n  },\n  computed: {\n    scoreMode () {\n      switch (this.game.scoreMode) {\n        case ScoreMode.ANY: return ['Any', 'Score when pieces are connected to each other or on final location']\n        case ScoreMode.FINAL:\n        default: return ['Final', 'Score when pieces are put to their final location']\n      }\n    },\n    shapeMode () {\n      switch (this.game.shapeMode) {\n        case ShapeMode.FLAT: return ['Flat', 'All pieces flat on all sides']\n        case ShapeMode.ANY: return ['Any', 'Flat pieces can occur anywhere']\n        case ShapeMode.NORMAL:\n        default:\n          return ['Normal', '']\n      }\n    },\n    snapMode () {\n      switch (this.game.snapMode) {\n        case SnapMode.REAL: return ['Real', 'Pieces snap only to corners, already snapped pieces and to each other']\n        case SnapMode.NORMAL:\n        default:\n          return ['Normal', 'Pieces snap to final destination and to each other']\n      }\n    },\n  },\n})\n</script>\n","/*\nSERVER_CLIENT_MESSAGE_PROTOCOL\nNOTE: clients always send game id and their id\n      when creating sockets (via socket.protocol), so\n      this doesn't need to be set in each message data\n\nNOTE: first value in the array is always the type of event/message\n      when describing them below, the value each has is used\n      instead of writing EVENT_TYPE or something ismilar\n\n\nEV_CLIENT_EVENT: event triggered by clients and sent to server\n[\n  EV_CLIENT_EVENT, // constant value, type of event\n  CLIENT_SEQ, // sequence number sent by client.\n  EV_DATA, // (eg. mouse input info)\n]\n\nEV_SERVER_EVENT: event sent to clients after recieving a client\n                 event and processing it\n[\n  EV_SERVER_EVENT, // constant value, type of event\n  CLIENT_ID, // user who sent the client event\n  CLIENT_SEQ, // sequence number of the client event msg\n  CHANGES_TRIGGERED_BY_CLIENT_EVENT,\n]\n\nEV_CLIENT_INIT: event sent by client to enter a game\n[\n  EV_CLIENT_INIT, // constant value, type of event\n]\n\nEV_SERVER_INIT: event sent to one client after that client\n                connects to a game\n[\n  EV_SERVER_INIT, // constant value, type of event\n  GAME, // complete game instance required by\n        // client to build client side of the game\n]\n*/\nconst GAME_VERSION = 2; // must be increased whenever there is an incompatible change\n\nconst EV_SERVER_EVENT = 1\nconst EV_SERVER_INIT = 4\nconst EV_CLIENT_EVENT = 2\nconst EV_CLIENT_INIT = 3\n\nconst LOG_HEADER = 1\nconst LOG_ADD_PLAYER = 2\nconst LOG_UPDATE_PLAYER = 4\nconst LOG_HANDLE_INPUT = 3\n\nconst INPUT_EV_MOUSE_DOWN = 1\nconst INPUT_EV_MOUSE_UP = 2\nconst INPUT_EV_MOUSE_MOVE = 3\nconst INPUT_EV_ZOOM_IN = 4\nconst INPUT_EV_ZOOM_OUT = 5\nconst INPUT_EV_BG_COLOR = 6\nconst INPUT_EV_PLAYER_COLOR = 7\nconst INPUT_EV_PLAYER_NAME = 8\nconst INPUT_EV_MOVE = 9\nconst INPUT_EV_TOGGLE_PREVIEW = 10\nconst INPUT_EV_TOGGLE_SOUNDS = 11\n\nconst INPUT_EV_REPLAY_TOGGLE_PAUSE = 12\nconst INPUT_EV_REPLAY_SPEED_UP = 13\nconst INPUT_EV_REPLAY_SPEED_DOWN = 14\n\nconst INPUT_EV_TOGGLE_PLAYER_NAMES = 15\nconst INPUT_EV_CENTER_FIT_PUZZLE = 16\n\nconst INPUT_EV_TOGGLE_FIXED_PIECES = 17\nconst INPUT_EV_TOGGLE_LOOSE_PIECES = 18\n\nconst INPUT_EV_STORE_POS = 19\nconst INPUT_EV_RESTORE_POS = 20\n\nconst INPUT_EV_CONNECTION_CLOSE = 21\n\nconst CHANGE_DATA = 1\nconst CHANGE_TILE = 2\nconst CHANGE_PLAYER = 3\nconst PLAYER_SNAP = 4\n\nexport default {\n  EV_SERVER_EVENT,\n  EV_SERVER_INIT,\n  EV_CLIENT_EVENT,\n  EV_CLIENT_INIT,\n\n  GAME_VERSION,\n\n  LOG_HEADER,\n  LOG_ADD_PLAYER,\n  LOG_UPDATE_PLAYER,\n  LOG_HANDLE_INPUT,\n\n  INPUT_EV_MOVE, // move by x/y\n\n  INPUT_EV_MOUSE_DOWN,\n  INPUT_EV_MOUSE_UP,\n  INPUT_EV_MOUSE_MOVE,\n\n  INPUT_EV_ZOOM_IN,\n  INPUT_EV_ZOOM_OUT,\n  INPUT_EV_BG_COLOR,\n  INPUT_EV_PLAYER_COLOR,\n  INPUT_EV_PLAYER_NAME,\n\n  INPUT_EV_TOGGLE_PREVIEW,\n  INPUT_EV_TOGGLE_SOUNDS,\n\n  INPUT_EV_REPLAY_TOGGLE_PAUSE,\n  INPUT_EV_REPLAY_SPEED_UP,\n  INPUT_EV_REPLAY_SPEED_DOWN,\n\n  INPUT_EV_TOGGLE_PLAYER_NAMES,\n  INPUT_EV_CENTER_FIT_PUZZLE,\n\n  INPUT_EV_TOGGLE_FIXED_PIECES,\n  INPUT_EV_TOGGLE_LOOSE_PIECES,\n\n  INPUT_EV_STORE_POS,\n  INPUT_EV_RESTORE_POS,\n\n  INPUT_EV_CONNECTION_CLOSE,\n\n  CHANGE_DATA,\n  CHANGE_TILE,\n  CHANGE_PLAYER,\n  PLAYER_SNAP,\n}\n","\"use strict\"\n\nimport { ClientEvent, EncodedGame, GameEvent, ReplayData, ServerEvent } from '../common/Types'\nimport Util, { logger } from '../common/Util'\nimport Protocol from './../common/Protocol'\nimport xhr from './xhr'\n\nconst log = logger('Communication.js')\n\nconst CODE_GOING_AWAY = 1001\nconst CODE_CUSTOM_DISCONNECT = 4000\n\nconst CONN_STATE_NOT_CONNECTED = 0 // not connected yet\nconst CONN_STATE_DISCONNECTED = 1 // not connected, but was connected before\nconst CONN_STATE_CONNECTED = 2 // connected\nconst CONN_STATE_CONNECTING = 3 // connecting\nconst CONN_STATE_CLOSED = 4 // not connected (closed on purpose)\n\nlet ws: WebSocket\n\nlet missedMessages: ServerEvent[] = []\nlet changesCallback = (msg: ServerEvent) => {\n  missedMessages.push(msg)\n}\n\nlet missedStateChanges: Array<number> = []\nlet connectionStateChangeCallback = (state: number) => {\n  missedStateChanges.push(state)\n}\n\nfunction onServerChange(callback: (msg: ServerEvent) => void): void {\n  changesCallback = callback\n  for (const missedMessage of missedMessages) {\n    changesCallback(missedMessage)\n  }\n  missedMessages = []\n}\n\nfunction onConnectionStateChange(callback: (state: number) => void): void {\n  connectionStateChangeCallback = callback\n  for (const missedStateChange of missedStateChanges) {\n    connectionStateChangeCallback(missedStateChange)\n  }\n  missedStateChanges = []\n}\n\nlet connectionState = CONN_STATE_NOT_CONNECTED\nconst setConnectionState = (state: number): void => {\n  if (connectionState !== state) {\n    connectionState = state\n    connectionStateChangeCallback(state)\n  }\n}\nfunction send(message: ClientEvent): void {\n  if (connectionState === CONN_STATE_CONNECTED) {\n    try {\n      ws.send(JSON.stringify(message))\n    } catch (e) {\n      log.info('unable to send message.. maybe because ws is invalid?')\n    }\n  }\n}\n\nlet clientSeq: number\nlet events: Record<number, GameEvent>\n\nlet timerId: any = 0;\n\nfunction keepAlive(timeout = 20000) {\n    if (ws.readyState == ws.OPEN) {\n        ws.send('');\n    }\n    timerId = setTimeout(keepAlive, timeout);\n}\n\nfunction cancelKeepAlive() {\n    if (timerId) {\n        clearTimeout(timerId);\n    }\n}\n\nfunction connect(\n  address: string,\n  gameId: string,\n  clientId: string\n): Promise<EncodedGame> {\n  clientSeq = 0\n  events = {}\n  setConnectionState(CONN_STATE_CONNECTING)\n  return new Promise(resolve => {\n    ws = new WebSocket(address, clientId + '|' + gameId)\n    ws.onopen = () => {\n      setConnectionState(CONN_STATE_CONNECTED)\n      send([Protocol.EV_CLIENT_INIT])\n      keepAlive()\n    }\n    ws.onmessage = (e: MessageEvent) => {\n      const msg: ServerEvent = JSON.parse(e.data)\n      const msgType = msg[0]\n      if (msgType === Protocol.EV_SERVER_INIT) {\n        const game = msg[1]\n        resolve(game)\n      } else if (msgType === Protocol.EV_SERVER_EVENT) {\n        const msgClientId = msg[1]\n        const msgClientSeq = msg[2]\n        if (msgClientId === clientId && events[msgClientSeq]) {\n          delete events[msgClientSeq]\n          // we have already calculated that change locally. probably\n          return\n        }\n        changesCallback(msg)\n      } else {\n        throw `[ 2021-05-09 invalid connect msgType ${msgType} ]`\n      }\n    }\n\n    ws.onerror = () => {\n      cancelKeepAlive()\n      setConnectionState(CONN_STATE_DISCONNECTED)\n      throw `[ 2021-05-15 onerror ]`\n    }\n\n    ws.onclose = (e: CloseEvent) => {\n      cancelKeepAlive()\n      if (e.code === CODE_CUSTOM_DISCONNECT || e.code === CODE_GOING_AWAY) {\n        setConnectionState(CONN_STATE_CLOSED)\n      } else {\n        setConnectionState(CONN_STATE_DISCONNECTED)\n      }\n    }\n  })\n}\n\nasync function requestReplayData(\n  gameId: string,\n  offset: number\n): Promise<ReplayData> {\n  const args = { gameId, offset }\n  const res = await xhr.get(`/api/replay-data${Util.asQueryArgs(args)}`, {})\n  const json: ReplayData = await res.json()\n  return json\n}\n\nfunction disconnect(): void {\n  if (ws) {\n    ws.close(CODE_CUSTOM_DISCONNECT)\n  }\n  clientSeq = 0\n  events = {}\n}\n\nfunction sendClientEvent(evt: GameEvent): void {\n  // when sending event, increase number of sent events\n  // and add the event locally\n  clientSeq++;\n  events[clientSeq] = evt\n  send([Protocol.EV_CLIENT_EVENT, clientSeq, events[clientSeq]])\n}\n\nexport default {\n  connect,\n  requestReplayData,\n  disconnect,\n  sendClientEvent,\n  onServerChange,\n  onConnectionStateChange,\n  CODE_CUSTOM_DISCONNECT,\n\n  CONN_STATE_NOT_CONNECTED,\n  CONN_STATE_DISCONNECTED,\n  CONN_STATE_CLOSED,\n  CONN_STATE_CONNECTED,\n  CONN_STATE_CONNECTING,\n}\n","<template>\n  <overlay class=\"connection-lost\" v-show=\"show\">\n    <template v-slot:default>\n      <div v-if=\"lostConnection\">⁉️ LOST CONNECTION ⁉️</div>\n      <span v-if=\"lostConnection\" class=\"btn\" @click=\"$emit('reconnect')\">Reconnect</span>\n      <div v-if=\"connecting\">Connecting...</div>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nimport Communication from './../Communication'\n\nexport default defineComponent({\n  emits: {\n    reconnect: null,\n  },\n  props: {\n    connectionState: Number,\n  },\n  computed: {\n    lostConnection (): boolean {\n      return this.connectionState === Communication.CONN_STATE_DISCONNECTED\n    },\n    connecting (): boolean {\n      return this.connectionState === Communication.CONN_STATE_CONNECTING\n    },\n    show (): boolean {\n      return !!(this.lostConnection || this.connecting)\n    },\n  }\n})\n</script>\n","<template>\n  <overlay class=\"transparent\">\n    <template v-slot:default>\n      <table class=\"help\">\n        <tr><td>⬆️ Move up:</td><td><div><kbd>W</kbd>/<kbd>↑</kbd>/🖱️</div></td></tr>\n        <tr><td>⬇️ Move down:</td><td><div><kbd>S</kbd>/<kbd>↓</kbd>/🖱️</div></td></tr>\n        <tr><td>⬅️ Move left:</td><td><div><kbd>A</kbd>/<kbd>←</kbd>/🖱️</div></td></tr>\n        <tr><td>➡️ Move right:</td><td><div><kbd>D</kbd>/<kbd>→</kbd>/🖱️</div></td></tr>\n        <tr><td></td><td><div>Move faster by holding <kbd>Shift</kbd></div></td></tr>\n\n        <tr><td>🔍+ Zoom in:</td><td><div><kbd>E</kbd>/🖱️-Wheel</div></td></tr>\n        <tr><td>🔍- Zoom out:</td><td><div><kbd>Q</kbd>/🖱️-Wheel</div></td></tr>\n        <tr><td>🖼️ Toggle preview:</td><td><div><kbd>Space</kbd></div></td></tr>\n        <tr><td>🎯 Center puzzle in screen:</td><td><div><kbd>C</kbd></div></td></tr>\n\n        <tr><td>🧩✔️ Toggle fixed pieces:</td><td><div><kbd>F</kbd></div></td></tr>\n        <tr><td>🧩❓ Toggle loose pieces:</td><td><div><kbd>G</kbd></div></td></tr>\n\n        <tr><td>👤 Toggle player names:</td><td><div><kbd>N</kbd></div></td></tr>\n        <tr><td>🔉 Toggle sounds:</td><td><div><kbd>M</kbd></div></td></tr>\n\n        <tr><td>🎯 Store position [0-9]:</td><td><div><kbd>Shift</kbd> + <kbd>0</kbd>-<kbd>9</kbd></div></td></tr>\n        <tr><td>🎯 Restore position [0-9]:</td><td><div><kbd>0</kbd>-<kbd>9</kbd></div></td></tr>\n\n        <tr><td>⏫ Speed up (replay):</td><td><div><kbd>I</kbd></div></td></tr>\n        <tr><td>⏬ Speed down (replay):</td><td><div><kbd>O</kbd></div></td></tr>\n        <tr><td>⏸️ Pause (replay):</td><td><div><kbd>P</kbd></div></td></tr>\n      </table>\n    </template>\n  </overlay>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n})\n</script>\n","export default \"__VITE_ASSET__bb97cb07__\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=\"","export default \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=\"","\"use strict\"\n\ninterface GameLoopOptions {\n  fps?: number\n  slow?: number\n  update: (step: number) => void\n  render: (passed: number) => void\n}\n\nexport interface GameLoopInstance {\n  stop: () => void\n}\n\nexport const run = (options: GameLoopOptions): GameLoopInstance => {\n  let stopped = false\n  const stop = () => {\n    stopped = true\n  }\n\n  const fps = options.fps || 60\n  const slow = options.slow || 1\n  const update = options.update\n  const render = options.render\n  const raf = window.requestAnimationFrame\n  const step = 1 / fps\n  const slowStep = slow * step\n\n  let now\n  let dt = 0\n  let last = window.performance.now()\n\n  const frame = () => {\n    now = window.performance.now()\n    dt = dt + Math.min(1, (now - last) / 1000) // duration capped at 1.0 seconds\n    while (dt > slowStep) {\n      dt = dt - slowStep\n      update(step)\n    }\n    render(dt / slow)\n    last = now\n    if (!stopped) {\n      raf(frame)\n    }\n  }\n\n  raf(frame)\n  return {\n    stop,\n  }\n}\n\nexport default {\n  run\n}\n","import { Dim, Point } from \"../common/Geometry\"\n\nconst MIN_ZOOM = .1\nconst MAX_ZOOM = 6\nconst ZOOM_STEP = .05\n\ntype ZOOM_DIR = 'in'|'out'\n\nexport interface Snapshot {\n  x: number\n  y: number\n  curZoom: number\n}\n\nexport class Camera {\n  private x: number = 0\n  private y: number = 0\n  private curZoom: number = 1\n\n  constructor(snapshot: Snapshot|null = null) {\n    if (snapshot) {\n      this.fromSnapshot(snapshot)\n    }\n  }\n\n  snapshot(): Snapshot {\n    return { x: this.x, y: this.y, curZoom: this.curZoom }\n  }\n\n  getCurrentZoom() {\n    return this.curZoom\n  }\n\n  fromSnapshot(snapshot: Snapshot) {\n    this.x = snapshot.x\n    this.y = snapshot.y\n    this.curZoom = snapshot.curZoom\n  }\n\n  reset() {\n    this.x = 0\n    this.y = 0\n    this.curZoom = 1\n  }\n\n  move(byX: number, byY: number) {\n    this.x += byX / this.curZoom\n    this.y += byY / this.curZoom\n  }\n\n  calculateNewZoom(inout: ZOOM_DIR): number {\n    const factor = inout === 'in' ? 1 : -1\n    const newzoom = this.curZoom + ZOOM_STEP * this.curZoom * factor\n    const capped = Math.min(Math.max(newzoom, MIN_ZOOM), MAX_ZOOM)\n    return capped\n  }\n\n  canZoom(inout: ZOOM_DIR): boolean {\n    return this.curZoom != this.calculateNewZoom(inout)\n  }\n\n  setZoom(newzoom: number, viewportCoordCenter: Point): boolean {\n    if (this.curZoom == newzoom) {\n      return false\n    }\n\n    const zoomFactor = 1 - (this.curZoom / newzoom)\n    this.move(\n      -viewportCoordCenter.x * zoomFactor,\n      -viewportCoordCenter.y * zoomFactor,\n    )\n    this.curZoom = newzoom\n    return true\n  }\n\n  /**\n   * Zooms towards/away from the provided coordinate, if possible.\n   * If at max or min zoom respectively, no zooming is performed.\n   */\n  zoom(inout: ZOOM_DIR, viewportCoordCenter: Point): boolean {\n    return this.setZoom(this.calculateNewZoom(inout), viewportCoordCenter)\n  }\n\n  /**\n   * Translate a coordinate in the viewport to a\n   * coordinate in the world, rounded\n   * @param {x, y} viewportCoord\n   */\n  viewportToWorld(viewportCoord: Point): Point {\n    const { x, y } = this.viewportToWorldRaw(viewportCoord)\n    return { x: Math.round(x), y: Math.round(y) }\n  }\n\n  /**\n   * Translate a coordinate in the viewport to a\n   * coordinate in the world, not rounded\n   * @param {x, y} viewportCoord\n   */\n  viewportToWorldRaw(viewportCoord: Point): Point {\n    return {\n      x: (viewportCoord.x / this.curZoom) - this.x,\n      y: (viewportCoord.y / this.curZoom) - this.y,\n    }\n  }\n\n  /**\n   * Translate a coordinate in the world to a\n   * coordinate in the viewport, rounded\n   * @param {x, y} worldCoord\n   */\n  worldToViewport(worldCoord: Point): Point {\n    const { x, y } = this.worldToViewportRaw(worldCoord)\n    return { x: Math.round(x), y: Math.round(y) }\n  }\n\n  /**\n   * Translate a coordinate in the world to a\n   * coordinate in the viewport, not rounded\n   * @param {x, y} worldCoord\n   */\n  worldToViewportRaw(worldCoord: Point): Point {\n    return {\n      x: (worldCoord.x + this.x) * this.curZoom,\n      y: (worldCoord.y + this.y) * this.curZoom,\n    }\n  }\n\n  /**\n   * Translate a 2d dimension (width/height) in the world to\n   * one in the viewport, rounded\n   * @param {w, h} worldDim\n   */\n  worldDimToViewport(worldDim: Dim): Dim {\n    const { w, h } = this.worldDimToViewportRaw(worldDim)\n    return { w: Math.round(w), h: Math.round(h) }\n  }\n\n\n  /**\n   * Translate a 2d dimension (width/height) in the world to\n   * one in the viewport, not rounded\n   * @param {w, h} worldDim\n   */\n  worldDimToViewportRaw(worldDim: Dim): Dim {\n    return {\n      w: worldDim.w * this.curZoom,\n      h: worldDim.h * this.curZoom,\n    }\n  }\n\n  viewportDimToWorld(viewportDim: Dim): Dim {\n    const { w, h } = this.viewportDimToWorldRaw(viewportDim)\n    return { w: Math.round(w), h: Math.round(h) }\n  }\n\n  viewportDimToWorldRaw(viewportDim: Dim): Dim {\n    return {\n      w: viewportDim.w / this.curZoom,\n      h: viewportDim.h / this.curZoom,\n    }\n  }\n}\n","\"use strict\"\n\nfunction createCanvas(width:number = 0, height:number = 0): HTMLCanvasElement {\n    const c = document.createElement('canvas')\n    c.width = width\n    c.height = height\n    return c\n}\n\nasync function loadImageToBitmap(imagePath: string): Promise<ImageBitmap> {\n  return new Promise((resolve) => {\n    const img = new Image()\n    img.onload = () => {\n      createImageBitmap(img).then(resolve)\n    }\n    img.src = imagePath\n  })\n}\n\nasync function resizeBitmap (\n  bitmap: ImageBitmap,\n  width: number,\n  height: number\n): Promise<ImageBitmap> {\n  const c = createCanvas(width, height)\n  const ctx = c.getContext('2d') as CanvasRenderingContext2D\n  ctx.drawImage(bitmap, 0, 0, bitmap.width, bitmap.height, 0, 0, width, height)\n  return await createImageBitmap(c)\n}\n\nfunction colorizedCanvas(\n  bitmap: ImageBitmap,\n  mask: ImageBitmap,\n  color: string,\n): HTMLCanvasElement {\n  const c = createCanvas(bitmap.width, bitmap.height)\n  const ctx = c.getContext('2d') as CanvasRenderingContext2D\n  ctx.save()\n  ctx.drawImage(mask, 0, 0)\n  ctx.fillStyle = color\n  ctx.globalCompositeOperation = \"source-in\"\n  ctx.fillRect(0, 0, mask.width, mask.height)\n  ctx.restore()\n  ctx.save()\n  ctx.globalCompositeOperation = \"destination-over\"\n  ctx.drawImage(bitmap, 0, 0)\n  ctx.restore()\n  return c\n}\n\nexport default {\n  createCanvas,\n  loadImageToBitmap,\n  resizeBitmap,\n  colorizedCanvas,\n}\n","\"use strict\"\n\nimport { logger } from '../common/Util'\n\nconst log = logger('Debug.js')\n\nlet _pt = 0\nlet _mindiff = 0\n\nconst checkpoint_start = (mindiff: number): void => {\n  _pt = performance.now()\n  _mindiff = mindiff\n}\n\nconst checkpoint = (label: string): void => {\n  const now = performance.now()\n  const diff = now - _pt\n  if (diff > _mindiff) {\n    log.log(label + ': ' + (diff))\n  }\n  _pt = now\n}\n\nexport default {\n  checkpoint_start,\n  checkpoint,\n}\n","export interface Point {\n  x: number\n  y: number\n}\n\nexport interface Rect {\n  x: number\n  y: number\n  w: number\n  h: number\n}\nexport interface Dim {\n  w: number\n  h: number\n}\n\nfunction pointSub(a: Point, b: Point): Point {\n  return { x: a.x - b.x, y: a.y - b.y }\n}\n\nfunction pointAdd(a: Point, b: Point): Point {\n  return { x: a.x + b.x, y: a.y + b.y }\n}\n\nfunction pointDistance(a: Point, b: Point): number {\n  const diffX = a.x - b.x\n  const diffY = a.y - b.y\n  return Math.sqrt(diffX * diffX + diffY * diffY)\n}\n\nfunction pointInBounds(pt: Point, rect: Rect): boolean {\n  return pt.x >= rect.x\n    && pt.x <= rect.x + rect.w\n    && pt.y >= rect.y\n    && pt.y <= rect.y + rect.h\n}\n\nfunction rectCenter(rect: Rect): Point {\n  return {\n    x: rect.x + (rect.w / 2),\n    y: rect.y + (rect.h / 2),\n  }\n}\n\n/**\n * Returns a rectangle with same dimensions as the given one, but\n * location (x/y) moved by x and y.\n *\n * @param {x, y, w,, h} rect\n * @param number x\n * @param number y\n * @returns {x, y, w, h}\n */\nfunction rectMoved(rect: Rect, x: number, y: number): Rect {\n  return {\n    x: rect.x + x,\n    y: rect.y + y,\n    w: rect.w,\n    h: rect.h,\n  }\n}\n\n/**\n * Returns true if the rectangles overlap, including their borders.\n *\n * @param {x, y, w, h} rectA\n * @param {x, y, w, h} rectB\n * @returns bool\n */\nfunction rectsOverlap(rectA: Rect, rectB: Rect): boolean {\n  return !(\n    rectB.x > (rectA.x + rectA.w)\n    || rectA.x > (rectB.x + rectB.w)\n    || rectB.y > (rectA.y + rectA.h)\n    || rectA.y > (rectB.y + rectB.h)\n  )\n}\n\nfunction rectCenterDistance(rectA: Rect, rectB: Rect): number {\n  return pointDistance(rectCenter(rectA), rectCenter(rectB))\n}\n\nexport default {\n  pointSub,\n  pointAdd,\n  pointDistance,\n  pointInBounds,\n  rectCenter,\n  rectMoved,\n  rectCenterDistance,\n  rectsOverlap,\n}\n","\"use strict\"\n\nimport Geometry, { Rect } from '../common/Geometry'\nimport Graphics from './Graphics'\nimport Util, { logger } from './../common/Util'\nimport { Puzzle, PuzzleInfo, PieceShape, EncodedPiece } from './../common/Types'\n\nconst log = logger('PuzzleGraphics.js')\n\nasync function createPuzzleTileBitmaps(\n  img: ImageBitmap,\n  pieces: EncodedPiece[],\n  info: PuzzleInfo\n): Promise<Array<ImageBitmap>> {\n  log.log('start createPuzzleTileBitmaps')\n  const tileSize = info.tileSize\n  const tileMarginWidth = info.tileMarginWidth\n  const tileDrawSize = info.tileDrawSize\n  const tileRatio = tileSize / 100.0\n\n  const curvyCoords = [\n    0, 0, 40, 15, 37, 5,\n    37, 5, 40, 0, 38, -5,\n    38, -5, 20, -20, 50, -20,\n    50, -20, 80, -20, 62, -5,\n    62, -5, 60, 0, 63, 5,\n    63, 5, 65, 15, 100, 0\n  ];\n\n  const bitmaps: Array<ImageBitmap> = new Array(pieces.length)\n\n  const paths: Record<string, Path2D> = {}\n  function pathForShape(shape: PieceShape) {\n    const key = `${shape.top}${shape.right}${shape.left}${shape.bottom}`\n    if (paths[key]) {\n      return paths[key]\n    }\n\n    const path = new Path2D()\n    const topLeftEdge = { x: tileMarginWidth, y: tileMarginWidth }\n    const topRightEdge = Geometry.pointAdd(topLeftEdge, { x: tileSize, y: 0 })\n    const bottomRightEdge = Geometry.pointAdd(topRightEdge, { x: 0, y: tileSize })\n    const bottomLeftEdge = Geometry.pointSub(bottomRightEdge, { x: tileSize, y: 0 })\n\n    path.moveTo(topLeftEdge.x, topLeftEdge.y)\n    if (shape.top !== 0) {\n      for (let i = 0; i < curvyCoords.length / 6; i++) {\n        const p1 = Geometry.pointAdd(topLeftEdge, { x: curvyCoords[i * 6 + 0] * tileRatio, y: shape.top * curvyCoords[i * 6 + 1] * tileRatio })\n        const p2 = Geometry.pointAdd(topLeftEdge, { x: curvyCoords[i * 6 + 2] * tileRatio, y: shape.top * curvyCoords[i * 6 + 3] * tileRatio })\n        const p3 = Geometry.pointAdd(topLeftEdge, { x: curvyCoords[i * 6 + 4] * tileRatio, y: shape.top * curvyCoords[i * 6 + 5] * tileRatio })\n        path.bezierCurveTo(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y);\n      }\n    } else {\n      path.lineTo(topRightEdge.x, topRightEdge.y)\n    }\n    if (shape.right !== 0) {\n      for (let i = 0; i < curvyCoords.length / 6; i++) {\n        const p1 = Geometry.pointAdd(topRightEdge, { x: -shape.right * curvyCoords[i * 6 + 1] * tileRatio, y: curvyCoords[i * 6 + 0] * tileRatio })\n        const p2 = Geometry.pointAdd(topRightEdge, { x: -shape.right * curvyCoords[i * 6 + 3] * tileRatio, y: curvyCoords[i * 6 + 2] * tileRatio })\n        const p3 = Geometry.pointAdd(topRightEdge, { x: -shape.right * curvyCoords[i * 6 + 5] * tileRatio, y: curvyCoords[i * 6 + 4] * tileRatio })\n        path.bezierCurveTo(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y);\n      }\n    } else {\n      path.lineTo(bottomRightEdge.x, bottomRightEdge.y)\n    }\n    if (shape.bottom !== 0) {\n      for (let i = 0; i < curvyCoords.length / 6; i++) {\n        const p1 = Geometry.pointSub(bottomRightEdge, { x: curvyCoords[i * 6 + 0] * tileRatio, y: shape.bottom * curvyCoords[i * 6 + 1] * tileRatio })\n        const p2 = Geometry.pointSub(bottomRightEdge, { x: curvyCoords[i * 6 + 2] * tileRatio, y: shape.bottom * curvyCoords[i * 6 + 3] * tileRatio })\n        const p3 = Geometry.pointSub(bottomRightEdge, { x: curvyCoords[i * 6 + 4] * tileRatio, y: shape.bottom * curvyCoords[i * 6 + 5] * tileRatio })\n        path.bezierCurveTo(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y);\n      }\n    } else {\n      path.lineTo(bottomLeftEdge.x, bottomLeftEdge.y)\n    }\n    if (shape.left !== 0) {\n      for (let i = 0; i < curvyCoords.length / 6; i++) {\n        const p1 = Geometry.pointSub(bottomLeftEdge, { x: -shape.left * curvyCoords[i * 6 + 1] * tileRatio, y: curvyCoords[i * 6 + 0] * tileRatio })\n        const p2 = Geometry.pointSub(bottomLeftEdge, { x: -shape.left * curvyCoords[i * 6 + 3] * tileRatio, y: curvyCoords[i * 6 + 2] * tileRatio })\n        const p3 = Geometry.pointSub(bottomLeftEdge, { x: -shape.left * curvyCoords[i * 6 + 5] * tileRatio, y: curvyCoords[i * 6 + 4] * tileRatio })\n        path.bezierCurveTo(p1.x, p1.y, p2.x, p2.y, p3.x, p3.y);\n      }\n    } else {\n      path.lineTo(topLeftEdge.x, topLeftEdge.y)\n    }\n    paths[key] = path\n    return path\n  }\n\n  const c = Graphics.createCanvas(tileDrawSize, tileDrawSize)\n  const ctx = c.getContext('2d') as CanvasRenderingContext2D\n\n  const c2 = Graphics.createCanvas(tileDrawSize, tileDrawSize)\n  const ctx2 = c2.getContext('2d') as CanvasRenderingContext2D\n\n  for (const p of pieces) {\n    const piece = Util.decodePiece(p)\n    const srcRect = srcRectByIdx(info, piece.idx)\n    const path = pathForShape(Util.decodeShape(info.shapes[piece.idx]))\n\n    ctx.clearRect(0, 0, tileDrawSize, tileDrawSize)\n\n    // stroke (slightly darker version of image)\n    // -----------------------------------------------------------\n    // -----------------------------------------------------------\n    ctx.save()\n    ctx.lineWidth = 2\n    ctx.stroke(path)\n    ctx.globalCompositeOperation = 'source-in'\n    ctx.drawImage(\n      img,\n      srcRect.x - tileMarginWidth,\n      srcRect.y - tileMarginWidth,\n      tileDrawSize,\n      tileDrawSize,\n      0,\n      0,\n      tileDrawSize,\n      tileDrawSize,\n    )\n    ctx.restore()\n    ctx.save()\n    ctx.globalCompositeOperation = 'source-in'\n    ctx.globalAlpha = .2\n    ctx.fillStyle = 'black'\n    ctx.fillRect(0,0, c.width, c.height)\n    ctx.restore()\n\n    // main image\n    // -----------------------------------------------------------\n    // -----------------------------------------------------------\n    ctx.save()\n    ctx.clip(path)\n    ctx.drawImage(\n      img,\n      srcRect.x - tileMarginWidth,\n      srcRect.y - tileMarginWidth,\n      tileDrawSize,\n      tileDrawSize,\n      0,\n      0,\n      tileDrawSize,\n      tileDrawSize,\n    )\n    ctx.restore()\n\n    // INSET SHADOW (bottom, right)\n    // -----------------------------------------------------------\n    // -----------------------------------------------------------\n    ctx.save()\n    ctx.clip(path)\n    ctx.strokeStyle = 'rgba(0,0,0,.4)'\n    ctx.lineWidth = 0\n    ctx.shadowColor = \"black\";\n    ctx.shadowBlur = 2;\n    ctx.shadowOffsetX = -1;\n    ctx.shadowOffsetY = -1;\n    ctx.stroke(path)\n    ctx.restore()\n\n    // INSET SHADOW (top, left)\n    // -----------------------------------------------------------\n    // -----------------------------------------------------------\n    ctx.save()\n    ctx.clip(path)\n    ctx.strokeStyle = 'rgba(255,255,255,.4)'\n    ctx.lineWidth = 0\n    ctx.shadowColor = \"white\";\n    ctx.shadowBlur = 2;\n    ctx.shadowOffsetX = 1;\n    ctx.shadowOffsetY = 1;\n    ctx.stroke(path)\n    ctx.restore()\n\n    // Redraw the path (border) in the color of the\n    // tile, this makes the tile look more realistic\n    // -----------------------------------------------------------\n    // -----------------------------------------------------------\n    ctx2.clearRect(0, 0, tileDrawSize, tileDrawSize)\n    ctx2.save()\n    ctx2.lineWidth = 1\n    ctx2.stroke(path)\n    ctx2.globalCompositeOperation = 'source-in'\n    ctx2.drawImage(\n      img,\n      srcRect.x - tileMarginWidth,\n      srcRect.y - tileMarginWidth,\n      tileDrawSize,\n      tileDrawSize,\n      0,\n      0,\n      tileDrawSize,\n      tileDrawSize,\n    )\n    ctx2.restore()\n    ctx.drawImage(c2, 0, 0)\n\n    bitmaps[piece.idx] = await createImageBitmap(c)\n  }\n\n  log.log('end createPuzzleTileBitmaps')\n  return bitmaps\n}\n\nfunction srcRectByIdx(puzzleInfo: PuzzleInfo, idx: number): Rect {\n  const c = Util.coordByPieceIdx(puzzleInfo, idx)\n  return {\n    x: c.x * puzzleInfo.tileSize,\n    y: c.y * puzzleInfo.tileSize,\n    w: puzzleInfo.tileSize,\n    h: puzzleInfo.tileSize,\n  }\n}\n\nasync function loadPuzzleBitmaps(puzzle: Puzzle): Promise<Array<ImageBitmap>> {\n  // load bitmap, to determine the original size of the image\n  const bmp = await Graphics.loadImageToBitmap(puzzle.info.imageUrl)\n\n  // creation of tile bitmaps\n  // then create the final puzzle bitmap\n  // NOTE: this can decrease OR increase in size!\n  const bmpResized = await Graphics.resizeBitmap(bmp, puzzle.info.width, puzzle.info.height)\n  return await createPuzzleTileBitmaps(bmpResized, puzzle.tiles, puzzle.info)\n}\n\nexport default {\n  loadPuzzleBitmaps,\n}\n","import Geometry, { Point, Rect } from './Geometry'\nimport Protocol from './Protocol'\nimport { Rng } from './Rng'\nimport Time from './Time'\nimport {\n  Change,\n  EncodedPiece,\n  Game,\n  Input,\n  Piece,\n  PieceChange,\n  Player,\n  PlayerChange,\n  Puzzle,\n  PuzzleData,\n  PuzzleDataChange,\n  ScoreMode,\n  SnapMode,\n  Timestamp\n} from './Types'\nimport Util from './Util'\n\nconst IDLE_TIMEOUT_SEC = 30\n\n// Map<gameId, Game>\nconst GAMES: Record<string, Game> = {}\n\nfunction loaded(gameId: string): boolean {\n  return (!!GAMES[gameId]) || false\n}\n\nfunction __createPlayerObject(id: string, ts: Timestamp): Player {\n  return {\n    id: id,\n    x: 0,\n    y: 0,\n    d: 0, // mouse down\n    name: null, // 'anon'\n    color: null, // '#ffffff'\n    bgcolor: null, // '#222222'\n    points: 0,\n    ts: ts,\n  }\n}\n\nfunction setGame(gameId: string, game: Game): void {\n  GAMES[gameId] = game\n}\n\nfunction unsetGame(gameId: string): void {\n  delete GAMES[gameId]\n}\n\nfunction getPlayerIndexById(gameId: string, playerId: string): number {\n  let i = 0;\n  for (const player of GAMES[gameId].players) {\n    if (Util.decodePlayer(player).id === playerId) {\n      return i\n    }\n    i++\n  }\n  return -1\n}\n\nfunction getPlayerIdByIndex(gameId: string, playerIndex: number): string|null {\n  if (GAMES[gameId].players.length > playerIndex) {\n    return Util.decodePlayer(GAMES[gameId].players[playerIndex]).id\n  }\n  return null\n}\n\nfunction getPlayer(gameId: string, playerId: string): Player|null {\n  const idx = getPlayerIndexById(gameId, playerId)\n  if (idx === -1) {\n    return null\n  }\n  return Util.decodePlayer(GAMES[gameId].players[idx])\n}\n\nfunction setPlayer(\n  gameId: string,\n  playerId: string,\n  player: Player\n): void {\n  const idx = getPlayerIndexById(gameId, playerId)\n  if (idx === -1) {\n    GAMES[gameId].players.push(Util.encodePlayer(player))\n  } else {\n    GAMES[gameId].players[idx] = Util.encodePlayer(player)\n  }\n}\n\nfunction setPiece(gameId: string, pieceIdx: number, piece: Piece): void {\n  GAMES[gameId].puzzle.tiles[pieceIdx] = Util.encodePiece(piece)\n}\n\nfunction setPuzzleData(gameId: string, data: PuzzleData): void {\n  GAMES[gameId].puzzle.data = data\n}\n\nfunction playerExists(gameId: string, playerId: string): boolean {\n  const idx = getPlayerIndexById(gameId, playerId)\n  return idx !== -1\n}\n\nfunction getActivePlayers(gameId: string, ts: number): Array<Player> {\n  return Game_getActivePlayers(GAMES[gameId], ts)\n}\n\nfunction getIdlePlayers(gameId: string, ts: number): Player[] {\n  return Game_getIdlePlayers(GAMES[gameId], ts)\n}\n\nfunction addPlayer(gameId: string, playerId: string, ts: Timestamp): void {\n  if (!playerExists(gameId, playerId)) {\n    setPlayer(gameId, playerId, __createPlayerObject(playerId, ts))\n  } else {\n    changePlayer(gameId, playerId, { ts })\n  }\n}\n\nfunction get(gameId: string): Game|null {\n  return GAMES[gameId] || null\n}\n\nfunction getPieceCount(gameId: string): number {\n  return Game_getPieceCount(GAMES[gameId])\n}\n\nfunction getImageUrl(gameId: string): string {\n  return Game_getImageUrl(GAMES[gameId])\n}\n\nfunction getScoreMode(gameId: string): ScoreMode {\n  return GAMES[gameId].scoreMode\n}\n\nfunction getSnapMode(gameId: string): SnapMode {\n  return GAMES[gameId].snapMode\n}\n\nfunction isFinished(gameId: string): boolean {\n  return getFinishedPiecesCount(gameId) === getPieceCount(gameId)\n}\n\nfunction getFinishedPiecesCount(gameId: string): number {\n  return Game_getFinishedPiecesCount(GAMES[gameId])\n}\n\nfunction getPiecesSortedByZIndex(gameId: string): Piece[] {\n  const pieces = GAMES[gameId].puzzle.tiles.map(Util.decodePiece)\n  return pieces.sort((t1, t2) => t1.z - t2.z)\n}\n\nfunction changePlayer(\n  gameId: string,\n  playerId: string,\n  change: PlayerChange\n): void {\n  const player = getPlayer(gameId, playerId)\n  if (player === null) {\n    return\n  }\n\n  for (const k of Object.keys(change)) {\n    // @ts-ignore\n    player[k] = change[k]\n  }\n  setPlayer(gameId, playerId, player)\n}\n\nfunction changeData(gameId: string, change: PuzzleDataChange): void {\n  for (const k of Object.keys(change)) {\n    // @ts-ignore\n    GAMES[gameId].puzzle.data[k] = change[k]\n  }\n}\n\nfunction changePiece(\n  gameId: string,\n  pieceIdx: number,\n  change: PieceChange\n): void {\n  for (const k of Object.keys(change)) {\n    const piece = Util.decodePiece(GAMES[gameId].puzzle.tiles[pieceIdx])\n    // @ts-ignore\n    piece[k] = change[k]\n    GAMES[gameId].puzzle.tiles[pieceIdx] = Util.encodePiece(piece)\n  }\n}\n\nconst getPiece = (gameId: string, pieceIdx: number): Piece => {\n  return Util.decodePiece(GAMES[gameId].puzzle.tiles[pieceIdx])\n}\n\nconst getPieceGroup = (gameId: string, tileIdx: number): number => {\n  const tile = getPiece(gameId, tileIdx)\n  return tile.group\n}\n\nconst isCornerPiece = (gameId: string, tileIdx: number): boolean => {\n  const info = GAMES[gameId].puzzle.info\n  return (\n    tileIdx === 0 // top left corner\n    || tileIdx === (info.tilesX - 1) // top right corner\n    || tileIdx === (info.tiles - info.tilesX) // bottom left corner\n    || tileIdx === (info.tiles - 1) // bottom right corner\n  )\n}\n\nconst getFinalPiecePos = (gameId: string, tileIdx: number): Point => {\n  const info = GAMES[gameId].puzzle.info\n  const boardPos = {\n    x: (info.table.width - info.width) / 2,\n    y: (info.table.height - info.height) / 2\n  }\n  const srcPos = srcPosByTileIdx(gameId, tileIdx)\n  return Geometry.pointAdd(boardPos, srcPos)\n}\n\nconst getPiecePos = (gameId: string, tileIdx: number): Point => {\n  const tile = getPiece(gameId, tileIdx)\n  return tile.pos\n}\n\n// todo: instead, just make the table bigger and use that :)\nconst getBounds = (gameId: string): Rect => {\n  const tw = getTableWidth(gameId)\n  const th = getTableHeight(gameId)\n\n  const overX = Math.round(tw / 4)\n  const overY = Math.round(th / 4)\n  return {\n    x: 0 - overX,\n    y: 0 - overY,\n    w: tw + 2 * overX,\n    h: th + 2 * overY,\n  }\n}\n\nconst getPieceBounds = (gameId: string, tileIdx: number): Rect => {\n  const s = getPieceSize(gameId)\n  const tile = getPiece(gameId, tileIdx)\n  return {\n    x: tile.pos.x,\n    y: tile.pos.y,\n    w: s,\n    h: s,\n  }\n}\n\nconst getPieceZIndex = (gameId: string, pieceIdx: number): number => {\n  return getPiece(gameId, pieceIdx).z\n}\n\nconst getFirstOwnedPieceIdx = (gameId: string, playerId: string): number => {\n  for (const t of GAMES[gameId].puzzle.tiles) {\n    const tile = Util.decodePiece(t)\n    if (tile.owner === playerId) {\n      return tile.idx\n    }\n  }\n  return -1\n}\n\nconst getFirstOwnedPiece = (\n  gameId: string,\n  playerId: string\n): EncodedPiece|null => {\n  const idx = getFirstOwnedPieceIdx(gameId, playerId)\n  return idx < 0 ? null : GAMES[gameId].puzzle.tiles[idx]\n}\n\nconst getPieceDrawOffset = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.tileDrawOffset\n}\n\nconst getPieceDrawSize = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.tileDrawSize\n}\n\nconst getPieceSize = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.tileSize\n}\n\nconst getStartTs = (gameId: string): Timestamp => {\n  return Game_getStartTs(GAMES[gameId])\n}\n\nconst getFinishTs = (gameId: string): Timestamp => {\n  return Game_getFinishTs(GAMES[gameId])\n}\n\nconst getMaxGroup = (gameId: string): number => {\n  return GAMES[gameId].puzzle.data.maxGroup\n}\n\nconst getMaxZIndex = (gameId: string): number => {\n  return GAMES[gameId].puzzle.data.maxZ\n}\n\nconst getMaxZIndexByPieceIdxs = (gameId: string, pieceIdxs: Array<number>): number => {\n  let maxZ = 0\n  for (const pieceIdx of pieceIdxs) {\n    const curZ = getPieceZIndex(gameId, pieceIdx)\n    if (curZ > maxZ) {\n      maxZ = curZ\n    }\n  }\n  return maxZ\n}\n\nfunction srcPosByTileIdx(gameId: string, tileIdx: number): Point {\n  const info = GAMES[gameId].puzzle.info\n\n  const c = Util.coordByPieceIdx(info, tileIdx)\n  const cx = c.x * info.tileSize\n  const cy = c.y * info.tileSize\n\n  return { x: cx, y: cy }\n}\n\nfunction getSurroundingTilesByIdx(gameId: string, tileIdx: number) {\n  const info = GAMES[gameId].puzzle.info\n\n  const c = Util.coordByPieceIdx(info, tileIdx)\n\n  return [\n    // top\n    (c.y > 0) ?               (tileIdx - info.tilesX) : -1,\n    // right\n    (c.x < info.tilesX - 1) ? (tileIdx + 1)           : -1,\n    // bottom\n    (c.y < info.tilesY - 1) ? (tileIdx + info.tilesX) : -1,\n    // left\n    (c.x > 0) ?               (tileIdx - 1)           : -1,\n  ]\n}\n\nconst setPiecesZIndex = (gameId: string, tileIdxs: Array<number>, zIndex: number): void => {\n  for (const tilesIdx of tileIdxs) {\n    changePiece(gameId, tilesIdx, { z: zIndex })\n  }\n}\n\nconst moveTileDiff = (gameId: string, tileIdx: number, diff: Point): void => {\n  const oldPos = getPiecePos(gameId, tileIdx)\n  const pos = Geometry.pointAdd(oldPos, diff)\n  changePiece(gameId, tileIdx, { pos })\n}\n\nconst movePiecesDiff = (\n  gameId: string,\n  pieceIdxs: Array<number>,\n  diff: Point\n): boolean => {\n  const drawSize = getPieceDrawSize(gameId)\n  const bounds = getBounds(gameId)\n  const cappedDiff = diff\n\n  for (const pieceIdx of pieceIdxs) {\n    const t = getPiece(gameId, pieceIdx)\n    if (t.pos.x + diff.x < bounds.x) {\n      cappedDiff.x = Math.max(bounds.x - t.pos.x, cappedDiff.x)\n    } else if (t.pos.x + drawSize + diff.x > bounds.x + bounds.w) {\n      cappedDiff.x = Math.min(bounds.x + bounds.w - t.pos.x + drawSize, cappedDiff.x)\n    }\n    if (t.pos.y + diff.y < bounds.y) {\n      cappedDiff.y = Math.max(bounds.y - t.pos.y, cappedDiff.y)\n    } else if (t.pos.y + drawSize + diff.y > bounds.y + bounds.h) {\n      cappedDiff.y = Math.min(bounds.y + bounds.h - t.pos.y + drawSize, cappedDiff.y)\n    }\n  }\n  if (!cappedDiff.x && !cappedDiff.y) {\n    return false\n  }\n\n  for (const pieceIdx of pieceIdxs) {\n    moveTileDiff(gameId, pieceIdx, cappedDiff)\n  }\n  return true\n}\n\nconst isFinishedPiece = (gameId: string, pieceIdx: number): boolean => {\n  return getPieceOwner(gameId, pieceIdx) === -1\n}\n\nconst getPieceOwner = (gameId: string, pieceIdx: number): string|number => {\n  return getPiece(gameId, pieceIdx).owner\n}\n\nconst finishPieces = (gameId: string, pieceIdxs: Array<number>): void => {\n  for (const pieceIdx of pieceIdxs) {\n    changePiece(gameId, pieceIdx, { owner: -1, z: 1 })\n  }\n}\n\nconst setTilesOwner = (\n  gameId: string,\n  pieceIdxs: Array<number>,\n  owner: string|number\n): void => {\n  for (const pieceIdx of pieceIdxs) {\n    changePiece(gameId, pieceIdx, { owner })\n  }\n}\n\n// returns the count of pieces in the same group as\n// the piece identified by pieceIdx\nfunction getGroupedPieceCount(gameId: string, pieceIdx: number): number {\n  return getGroupedPieceIdxs(gameId, pieceIdx).length\n}\n\n// get all grouped tiles for a tile\nfunction getGroupedPieceIdxs(gameId: string, pieceIdx: number): number[] {\n  const pieces = GAMES[gameId].puzzle.tiles\n  const piece = Util.decodePiece(pieces[pieceIdx])\n\n  const grouped = []\n  if (piece.group) {\n    for (const other of pieces) {\n      const otherPiece = Util.decodePiece(other)\n      if (otherPiece.group === piece.group) {\n        grouped.push(otherPiece.idx)\n      }\n    }\n  } else {\n    grouped.push(piece.idx)\n  }\n  return grouped\n}\n\n// Returns the index of the puzzle tile with the highest z index\n// that is not finished yet and that matches the position\nconst freePieceIdxByPos = (gameId: string, pos: Point): number => {\n  const info = GAMES[gameId].puzzle.info\n  const pieces = GAMES[gameId].puzzle.tiles\n\n  let maxZ = -1\n  let pieceIdx = -1\n  for (let idx = 0; idx < pieces.length; idx++) {\n    const piece = Util.decodePiece(pieces[idx])\n    if (piece.owner !== 0) {\n      continue\n    }\n\n    const collisionRect: Rect = {\n      x: piece.pos.x,\n      y: piece.pos.y,\n      w: info.tileSize,\n      h: info.tileSize,\n    }\n    if (Geometry.pointInBounds(pos, collisionRect)) {\n      if (maxZ === -1 || piece.z > maxZ) {\n        maxZ = piece.z\n        pieceIdx = idx\n      }\n    }\n  }\n  return pieceIdx\n}\n\nconst getPlayerBgColor = (gameId: string, playerId: string): string|null => {\n  const p = getPlayer(gameId, playerId)\n  return p ? p.bgcolor : null\n}\n\nconst getPlayerColor = (gameId: string, playerId: string): string|null => {\n  const p = getPlayer(gameId, playerId)\n  return p ? p.color : null\n}\n\nconst getPlayerName = (gameId: string, playerId: string): string|null => {\n  const p = getPlayer(gameId, playerId)\n  return p ? p.name : null\n}\n\nconst getPlayerPoints = (gameId: string, playerId: string): number => {\n  const p = getPlayer(gameId, playerId)\n  return p ? p.points : 0\n}\n\n// determine if two tiles are grouped together\nconst areGrouped = (\n  gameId: string,\n  tileIdx1: number,\n  tileIdx2: number\n): boolean => {\n  const g1 = getPieceGroup(gameId, tileIdx1)\n  const g2 = getPieceGroup(gameId, tileIdx2)\n  return !!(g1 && g1 === g2)\n}\n\nconst getTableWidth = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.table.width\n}\n\nconst getTableHeight = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.table.height\n}\n\nconst getPuzzle = (gameId: string): Puzzle => {\n  return GAMES[gameId].puzzle\n}\n\nconst getRng = (gameId: string): Rng => {\n  return GAMES[gameId].rng.obj\n}\n\nconst getPuzzleWidth = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.width\n}\n\nconst getPuzzleHeight = (gameId: string): number => {\n  return GAMES[gameId].puzzle.info.height\n}\n\nconst maySnapToFinal = (gameId: string, pieceIdxs: number[]): boolean => {\n  if (getSnapMode(gameId) === SnapMode.REAL) {\n    // only can snap to final if any of the grouped pieces are\n    // corner pieces\n    for (const pieceIdx of pieceIdxs) {\n      if (isCornerPiece(gameId, pieceIdx)) {\n        return true\n      }\n    }\n    return false\n  }\n\n  // in other modes can always snap\n  return true\n}\n\nfunction handleInput(\n  gameId: string,\n  playerId: string,\n  input: Input,\n  ts: Timestamp,\n): Array<Change> {\n  const puzzle = GAMES[gameId].puzzle\n\n  const changes: Array<Change> = []\n\n  const _dataChange = (): void => {\n    changes.push([Protocol.CHANGE_DATA, puzzle.data])\n  }\n\n  const _pieceChange = (pieceIdx: number): void => {\n    changes.push([\n      Protocol.CHANGE_TILE,\n      Util.encodePiece(getPiece(gameId, pieceIdx)),\n    ])\n  }\n\n  const _pieceChanges = (pieceIdxs: Array<number>): void => {\n    for (const pieceIdx of pieceIdxs) {\n      _pieceChange(pieceIdx)\n    }\n  }\n\n  const _playerChange = (): void => {\n    const player = getPlayer(gameId, playerId)\n    if (!player) {\n      return\n    }\n    changes.push([\n      Protocol.CHANGE_PLAYER,\n      Util.encodePlayer(player),\n    ])\n  }\n\n  let anySnapped: boolean = false\n\n  // put both tiles (and their grouped tiles) in the same group\n  const groupTiles = (\n    gameId: string,\n    pieceIdx1: number,\n    pieceIdx2: number\n  ): void => {\n    const pieces = GAMES[gameId].puzzle.tiles\n    const group1 = getPieceGroup(gameId, pieceIdx1)\n    const group2 = getPieceGroup(gameId, pieceIdx2)\n\n    let group\n    const searchGroups = []\n    if (group1) {\n      searchGroups.push(group1)\n    }\n    if (group2) {\n      searchGroups.push(group2)\n    }\n    if (group1) {\n      group = group1\n    } else if (group2) {\n      group = group2\n    } else {\n      const maxGroup = getMaxGroup(gameId) + 1\n      changeData(gameId, { maxGroup })\n      _dataChange()\n      group = getMaxGroup(gameId)\n    }\n\n    changePiece(gameId, pieceIdx1, { group })\n    _pieceChange(pieceIdx1)\n    changePiece(gameId, pieceIdx2, { group })\n    _pieceChange(pieceIdx2)\n\n    // TODO: strange\n    if (searchGroups.length > 0) {\n      for (const p of pieces) {\n        const piece = Util.decodePiece(p)\n        if (searchGroups.includes(piece.group)) {\n          changePiece(gameId, piece.idx, { group })\n          _pieceChange(piece.idx)\n        }\n      }\n    }\n  }\n\n  const type = input[0]\n  if (type === Protocol.INPUT_EV_CONNECTION_CLOSE) {\n    // player lost connection, so un-own all their pieces\n    const pieceIdx = getFirstOwnedPieceIdx(gameId, playerId)\n    if (pieceIdx >= 0) {\n      const pieceIdxs = getGroupedPieceIdxs(gameId, pieceIdx)\n      setTilesOwner(gameId, pieceIdxs, 0)\n      _pieceChanges(pieceIdxs)\n    }\n  } else if (type === Protocol.INPUT_EV_BG_COLOR) {\n    const bgcolor = input[1]\n    changePlayer(gameId, playerId, { bgcolor, ts })\n    _playerChange()\n  } else if (type === Protocol.INPUT_EV_PLAYER_COLOR) {\n    const color = input[1]\n    changePlayer(gameId, playerId, { color, ts })\n    _playerChange()\n  } else if (type === Protocol.INPUT_EV_PLAYER_NAME) {\n    const name = `${input[1]}`.substr(0, 16)\n    changePlayer(gameId, playerId, { name, ts })\n    _playerChange()\n  } else if (type === Protocol.INPUT_EV_MOVE) {\n    const diffX = input[1]\n    const diffY = input[2]\n    const player = getPlayer(gameId, playerId)\n    if (player) {\n      const x = player.x - diffX\n      const y = player.y - diffY\n      changePlayer(gameId, playerId, { ts, x, y })\n      _playerChange()\n      const pieceIdx = getFirstOwnedPieceIdx(gameId, playerId)\n      if (pieceIdx >= 0) {\n        // check if pos is on the tile, otherwise dont move\n        // (mouse could be out of table, but tile stays on it)\n        const pieceIdxs = getGroupedPieceIdxs(gameId, pieceIdx)\n        const diff = { x: -diffX, y: -diffY }\n        if (movePiecesDiff(gameId, pieceIdxs, diff)) {\n          _pieceChanges(pieceIdxs)\n        }\n      }\n    }\n  } else if (type === Protocol.INPUT_EV_MOUSE_DOWN) {\n    const x = input[1]\n    const y = input[2]\n    const pos = {x, y}\n\n    changePlayer(gameId, playerId, { d: 1, ts })\n    _playerChange()\n\n    const tileIdxAtPos = freePieceIdxByPos(gameId, pos)\n    if (tileIdxAtPos >= 0) {\n      const maxZ = getMaxZIndex(gameId) + 1\n      changeData(gameId, { maxZ })\n      _dataChange()\n      const tileIdxs = getGroupedPieceIdxs(gameId, tileIdxAtPos)\n      setPiecesZIndex(gameId, tileIdxs, getMaxZIndex(gameId))\n      setTilesOwner(gameId, tileIdxs, playerId)\n      _pieceChanges(tileIdxs)\n    }\n  } else if (type === Protocol.INPUT_EV_MOUSE_MOVE) {\n    const x = input[1]\n    const y = input[2]\n    const down = input[5]\n\n    if (!down) {\n      // player is just moving the hand\n      changePlayer(gameId, playerId, {x, y, ts})\n      _playerChange()\n    } else {\n      const pieceIdx = getFirstOwnedPieceIdx(gameId, playerId)\n      if (pieceIdx < 0) {\n        // player is just moving map, so no change in position!\n        changePlayer(gameId, playerId, {ts})\n        _playerChange()\n      } else {\n        const x = input[1]\n        const y = input[2]\n        const diffX = input[3]\n        const diffY = input[4]\n\n        // player is moving a tile (and hand)\n        changePlayer(gameId, playerId, {x, y, ts})\n        _playerChange()\n\n        // check if pos is on the tile, otherwise dont move\n        // (mouse could be out of table, but tile stays on it)\n        const pieceIdxs = getGroupedPieceIdxs(gameId, pieceIdx)\n        const diff = { x: diffX, y: diffY }\n        if (movePiecesDiff(gameId, pieceIdxs, diff)) {\n          _pieceChanges(pieceIdxs)\n        }\n      }\n    }\n  } else if (type === Protocol.INPUT_EV_MOUSE_UP) {\n    const d = 0 // mouse down = false\n\n    const pieceIdx = getFirstOwnedPieceIdx(gameId, playerId)\n    if (pieceIdx >= 0) {\n      // drop the tile(s)\n      const pieceIdxs = getGroupedPieceIdxs(gameId, pieceIdx)\n      setTilesOwner(gameId, pieceIdxs, 0)\n      _pieceChanges(pieceIdxs)\n\n      // Check if the tile was dropped near the final location\n      const tilePos = getPiecePos(gameId, pieceIdx)\n      const finalPos = getFinalPiecePos(gameId, pieceIdx)\n\n      if (\n        maySnapToFinal(gameId, pieceIdxs)\n        && Geometry.pointDistance(finalPos, tilePos) < puzzle.info.snapDistance\n      ) {\n        const diff = Geometry.pointSub(finalPos, tilePos)\n        // Snap the tile to the final destination\n        movePiecesDiff(gameId, pieceIdxs, diff)\n        finishPieces(gameId, pieceIdxs)\n        _pieceChanges(pieceIdxs)\n\n        let points = getPlayerPoints(gameId, playerId)\n        if (getScoreMode(gameId) === ScoreMode.FINAL) {\n          points += pieceIdxs.length\n        } else if (getScoreMode(gameId) === ScoreMode.ANY) {\n          points += 1\n        } else {\n          // no score mode... should never occur, because there is a\n          // fallback to ScoreMode.FINAL in getScoreMode function\n        }\n        changePlayer(gameId, playerId, { d, ts, points })\n        _playerChange()\n\n        // check if the puzzle is finished\n        if (getFinishedPiecesCount(gameId) === getPieceCount(gameId)) {\n          changeData(gameId, { finished: ts })\n          _dataChange()\n        }\n\n        anySnapped = true\n      } else {\n        // Snap to other tiles\n        const check = (\n          gameId: string,\n          tileIdx: number,\n          otherTileIdx: number,\n          off: Array<number>\n        ): boolean => {\n          const info = GAMES[gameId].puzzle.info\n          if (otherTileIdx < 0) {\n            return false\n          }\n          if (areGrouped(gameId, tileIdx, otherTileIdx)) {\n            return false\n          }\n          const tilePos = getPiecePos(gameId, tileIdx)\n          const dstPos = Geometry.pointAdd(\n            getPiecePos(gameId, otherTileIdx),\n            {x: off[0] * info.tileSize, y: off[1] * info.tileSize}\n          )\n          if (Geometry.pointDistance(tilePos, dstPos) < info.snapDistance) {\n            const diff = Geometry.pointSub(dstPos, tilePos)\n            let pieceIdxs = getGroupedPieceIdxs(gameId, tileIdx)\n            movePiecesDiff(gameId, pieceIdxs, diff)\n            groupTiles(gameId, tileIdx, otherTileIdx)\n            pieceIdxs = getGroupedPieceIdxs(gameId, tileIdx)\n            if (isFinishedPiece(gameId, otherTileIdx)) {\n              finishPieces(gameId, pieceIdxs)\n            } else {\n              const zIndex = getMaxZIndexByPieceIdxs(gameId, pieceIdxs)\n              setPiecesZIndex(gameId, pieceIdxs, zIndex)\n            }\n            _pieceChanges(pieceIdxs)\n            return true\n          }\n          return false\n        }\n\n        let snapped = false\n        for (const pieceIdxTmp of getGroupedPieceIdxs(gameId, pieceIdx)) {\n          const othersIdxs = getSurroundingTilesByIdx(gameId, pieceIdxTmp)\n          if (\n            check(gameId, pieceIdxTmp, othersIdxs[0], [0, 1]) // top\n            || check(gameId, pieceIdxTmp, othersIdxs[1], [-1, 0]) // right\n            || check(gameId, pieceIdxTmp, othersIdxs[2], [0, -1]) // bottom\n            || check(gameId, pieceIdxTmp, othersIdxs[3], [1, 0]) // left\n          ) {\n            snapped = true\n            break\n          }\n        }\n        if (snapped && getScoreMode(gameId) === ScoreMode.ANY) {\n          const points = getPlayerPoints(gameId, playerId) + 1\n          changePlayer(gameId, playerId, { d, ts, points })\n          _playerChange()\n        } else {\n          changePlayer(gameId, playerId, { d, ts })\n          _playerChange()\n        }\n\n        if (snapped && getSnapMode(gameId) === SnapMode.REAL) {\n          if (getFinishedPiecesCount(gameId) === getPieceCount(gameId)) {\n            changeData(gameId, { finished: ts })\n            _dataChange()\n          }\n        }\n        if (snapped) {\n          anySnapped = true\n        }\n      }\n    } else {\n      changePlayer(gameId, playerId, { d, ts })\n      _playerChange()\n    }\n  } else if (type === Protocol.INPUT_EV_ZOOM_IN) {\n    const x = input[1]\n    const y = input[2]\n    changePlayer(gameId, playerId, { x, y, ts })\n    _playerChange()\n  } else if (type === Protocol.INPUT_EV_ZOOM_OUT) {\n    const x = input[1]\n    const y = input[2]\n    changePlayer(gameId, playerId, { x, y, ts })\n    _playerChange()\n  } else {\n    changePlayer(gameId, playerId, { ts })\n    _playerChange()\n  }\n\n  if (anySnapped) {\n    changes.push([\n      Protocol.PLAYER_SNAP,\n      playerId,\n    ])\n  }\n  return changes\n}\n\n// functions that operate on given game instance instead of global one\n// -------------------------------------------------------------------\n\nfunction Game_getStartTs(game: Game): number {\n  return game.puzzle.data.started\n}\n\nfunction Game_getFinishTs(game: Game): number {\n  return game.puzzle.data.finished\n}\n\nfunction Game_getFinishedPiecesCount(game: Game): number {\n  let count = 0\n  for (const t of game.puzzle.tiles) {\n    if (Util.decodePiece(t).owner === -1) {\n      count++\n    }\n  }\n  return count\n}\n\nfunction Game_getPieceCount(game: Game): number {\n  return game.puzzle.tiles.length\n}\n\nfunction Game_getAllPlayers(game: Game): Array<Player> {\n  return game.players.map(Util.decodePlayer)\n}\n\nfunction Game_getActivePlayers(game: Game, ts: number): Array<Player> {\n  const minTs = ts - IDLE_TIMEOUT_SEC * Time.SEC\n  return Game_getAllPlayers(game).filter((p: Player) => p.ts >= minTs)\n}\n\nfunction Game_getIdlePlayers(game: Game, ts: number): Player[] {\n  const minTs = ts - IDLE_TIMEOUT_SEC * Time.SEC\n  return Game_getAllPlayers(game).filter((p: Player) => p.ts < minTs && p.points > 0)\n}\n\nfunction Game_getImageUrl(game: Game): string {\n  const imageUrl = game.puzzle.info.image?.url || game.puzzle.info.imageUrl\n  if (!imageUrl) {\n    throw new Error('[2021-07-11] no image url set')\n  }\n  return imageUrl\n}\n\n\nexport default {\n  setGame,\n  unsetGame,\n  loaded,\n  playerExists,\n  getActivePlayers,\n  getIdlePlayers,\n  addPlayer,\n  getFinishedPiecesCount,\n  getPieceCount,\n  getImageUrl,\n  get,\n  getGroupedPieceCount,\n  getPlayerBgColor,\n  getPlayerColor,\n  getPlayerName,\n  getPlayerIndexById,\n  getPlayerIdByIndex,\n  changePlayer,\n  setPlayer,\n  setPiece,\n  setPuzzleData,\n  getTableWidth,\n  getTableHeight,\n  getPuzzle,\n  getRng,\n  getPuzzleWidth,\n  getPuzzleHeight,\n  getPiecesSortedByZIndex,\n  getFirstOwnedPiece,\n  getPieceDrawOffset,\n  getPieceDrawSize,\n  getFinalPiecePos,\n  getStartTs,\n  getFinishTs,\n  handleInput,\n\n  /// operate directly on the game object given\n  Game_getStartTs,\n  Game_getFinishTs,\n  Game_getFinishedPiecesCount,\n  Game_getPieceCount,\n  Game_getActivePlayers,\n  Game_getImageUrl,\n}\n","\"use strict\"\n\nimport { Rng } from '../common/Rng'\n\nlet minVx = -10\nlet deltaVx = 20\nlet minVy = 2\nlet deltaVy = 15\nconst minParticleV = 5\nconst deltaParticleV = 5\n\nconst gravity = 1\n\nconst explosionRadius = 200\nconst bombRadius = 10\nconst explodingDuration = 100\nconst explosionDividerFactor = 10\n\nconst nBombs = 1\nconst percentChanceNewBomb = 5\n\nfunction color(rng: Rng): string {\n  const r = rng.random(0, 255)\n  const g = rng.random(0, 255)\n  const b = rng.random(0, 255)\n  return 'rgba(' + r + ',' + g + ',' + b + ', 0.8)'\n}\n\n// A Bomb. Or firework.\nclass Bomb {\n  radius: number\n  previousRadius: number\n  explodingDuration: number\n  hasExploded: boolean\n  alive: boolean\n  color: string\n  px: number\n  py: number\n  vx: number\n  vy: number\n  duration: number\n\n  constructor(rng: Rng) {\n    this.radius = bombRadius\n    this.previousRadius = bombRadius\n    this.explodingDuration = explodingDuration\n    this.hasExploded = false\n    this.alive = true\n    this.color = color(rng)\n\n    this.px = (window.innerWidth / 4) + (Math.random() * window.innerWidth / 2)\n    this.py = window.innerHeight\n\n    this.vx = minVx + Math.random() * deltaVx\n    this.vy = (minVy + Math.random() * deltaVy) * -1 // because y grows downwards\n\n    this.duration = 0\n  }\n\n  update(particlesVector?: Array<Particle>) {\n    if (this.hasExploded) {\n      const deltaRadius = explosionRadius - this.radius\n      this.previousRadius = this.radius\n      this.radius += deltaRadius / explosionDividerFactor\n      this.explodingDuration--\n      if (this.explodingDuration == 0) {\n        this.alive = false\n      }\n    }\n    else {\n      this.vx += 0\n      this.vy += gravity\n      if (this.vy >= 0) { // invertion point\n        if (particlesVector) {\n          this.explode(particlesVector)\n        }\n      }\n\n      this.px += this.vx\n      this.py += this.vy\n    }\n  }\n\n  draw(ctx: CanvasRenderingContext2D) {\n    ctx.beginPath()\n    ctx.arc(this.px, this.py, this.previousRadius, 0, Math.PI * 2, false)\n    if (!this.hasExploded) {\n      ctx.fillStyle = this.color\n      ctx.lineWidth = 1\n      ctx.fill()\n    }\n  }\n\n  explode(particlesVector: Array<Particle>) {\n    this.hasExploded = true\n    const e = 3 + Math.floor(Math.random() * 3)\n    for (let j = 0; j < e; j++) {\n      const n = 10 + Math.floor(Math.random() * 21) // 10 - 30\n      const speed = minParticleV + Math.random() * deltaParticleV\n      const deltaAngle = 2 * Math.PI / n\n      const initialAngle = Math.random() * deltaAngle\n      for (let i = 0; i < n; i++) {\n        particlesVector.push(new Particle(this, i * deltaAngle + initialAngle, speed))\n      }\n    }\n  }\n}\n\nclass Particle {\n  px: number\n  py: number\n  vx: number\n  vy: number\n  color: string\n  duration: number\n  alive: boolean\n  radius: number\n  constructor(parent: Bomb, angle: number, speed: number) {\n    this.px = parent.px\n    this.py = parent.py\n    this.vx = Math.cos(angle) * speed\n    this.vy = Math.sin(angle) * speed\n    this.color = parent.color\n    this.duration = 40 + Math.floor(Math.random() * 20)\n    this.alive = true\n    this.radius = 0\n  }\n  update() {\n    this.vx += 0\n    this.vy += gravity / 10\n\n    this.px += this.vx\n    this.py += this.vy\n    this.radius = 3\n\n    this.duration--\n    if (this.duration <= 0) {\n      this.alive = false\n    }\n  }\n\n  draw(ctx: CanvasRenderingContext2D) {\n    ctx.beginPath()\n    ctx.arc(this.px, this.py, this.radius, 0, Math.PI * 2, false)\n    ctx.fillStyle = this.color\n    ctx.lineWidth = 1\n    ctx.fill()\n  }\n}\n\nclass Controller {\n  canvas: HTMLCanvasElement\n  rng: Rng\n  ctx: CanvasRenderingContext2D\n  readyBombs: Array<Bomb>\n  explodedBombs: Array<Bomb>\n  particles: Array<Particle>\n  constructor(canvas: HTMLCanvasElement, rng: Rng) {\n    this.canvas = canvas\n    this.rng = rng\n    this.ctx = this.canvas.getContext('2d') as CanvasRenderingContext2D\n    this.resize()\n\n    this.readyBombs = []\n    this.explodedBombs = []\n    this.particles = []\n\n    window.addEventListener('resize', () => {\n      this.resize()\n    })\n  }\n\n  setSpeedParams(): void {\n    let heightReached = 0\n    let vy = 0\n\n    while (heightReached < this.canvas.height && vy >= 0) {\n      vy += gravity\n      heightReached += vy\n    }\n\n    minVy = vy / 2\n    deltaVy = vy - minVy\n\n    const vx = (1 / 4) * this.canvas.width / (vy / 2)\n    minVx = -vx\n    deltaVx = 2 * vx\n  }\n\n  resize(): void {\n    this.setSpeedParams()\n  }\n\n  init(): void {\n    this.readyBombs = []\n    this.explodedBombs = []\n    this.particles = []\n\n    for (let i = 0; i < nBombs; i++) {\n      this.readyBombs.push(new Bomb(this.rng))\n    }\n  }\n\n  update(): void {\n    if (Math.random() * 100 < percentChanceNewBomb) {\n      this.readyBombs.push(new Bomb(this.rng))\n    }\n\n    const aliveBombs = []\n    while (this.explodedBombs.length > 0) {\n      const bomb = this.explodedBombs.shift()\n      if (!bomb) {\n        break;\n      }\n      bomb.update()\n      if (bomb.alive) {\n        aliveBombs.push(bomb)\n      }\n    }\n    this.explodedBombs = aliveBombs\n\n    const notExplodedBombs = []\n    while (this.readyBombs.length > 0) {\n      const bomb = this.readyBombs.shift()\n      if (!bomb) {\n        break\n      }\n      bomb.update(this.particles)\n      if (bomb.hasExploded) {\n        this.explodedBombs.push(bomb)\n      }\n      else {\n        notExplodedBombs.push(bomb)\n      }\n    }\n    this.readyBombs = notExplodedBombs\n\n    const aliveParticles = []\n    while (this.particles.length > 0) {\n      const particle = this.particles.shift()\n      if (!particle) {\n        break\n      }\n      particle.update()\n      if (particle.alive) {\n        aliveParticles.push(particle)\n      }\n    }\n    this.particles = aliveParticles\n  }\n\n  render(): void {\n    this.ctx.beginPath()\n    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)' // Ghostly effect\n    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height)\n\n    for (let i = 0; i < this.readyBombs.length; i++) {\n      this.readyBombs[i].draw(this.ctx)\n    }\n\n    for (let i = 0; i < this.explodedBombs.length; i++) {\n      this.explodedBombs[i].draw(this.ctx)\n    }\n\n    for (let i = 0; i < this.particles.length; i++) {\n      this.particles[i].draw(this.ctx)\n    }\n  }\n}\n\nexport default Controller\n","import Protocol from \"../common/Protocol\"\nimport { GameEvent } from \"../common/Types\"\nimport { Camera, Snapshot } from \"./Camera\"\nimport { MODE_REPLAY } from \"./game\"\n\nfunction EventAdapter (\n  canvas: HTMLCanvasElement,\n  window: any,\n  viewport: Camera,\n  MODE: string\n) {\n  let events: Array<GameEvent> = []\n\n  let KEYS_ON = true\n\n  let LEFT = false\n  let RIGHT = false\n  let UP = false\n  let DOWN = false\n  let ZOOM_IN = false\n  let ZOOM_OUT = false\n  let SHIFT = false\n\n  const _toWorldPoint = (x: number, y: number): [number, number] => {\n    const pos = viewport.viewportToWorld({x, y})\n    return [pos.x, pos.y]\n  }\n  const _toWorldDim = (w: number, h: number): [number, number] => {\n    const dim = viewport.viewportDimToWorld({ w, h })\n    return [ dim.w, dim.h ]\n  }\n\n  const _mousePos = (ev: MouseEvent) => _toWorldPoint(ev.offsetX, ev.offsetY)\n  const _canvasCenter = () => _toWorldPoint(canvas.width / 2, canvas.height / 2)\n\n  const _key = (state: boolean, ev: KeyboardEvent) => {\n    if (!KEYS_ON) {\n      return\n    }\n\n    if (ev.code === 'ShiftLeft' || ev.code === 'ShiftRight') {\n      SHIFT = state\n    } else if (ev.code === 'ArrowUp' || ev.code === 'KeyW') {\n      UP = state\n    } else if (ev.code === 'ArrowDown' || ev.code === 'KeyS') {\n      DOWN = state\n    } else if (ev.code === 'ArrowLeft' || ev.code === 'KeyA') {\n      LEFT = state\n    } else if (ev.code === 'ArrowRight' || ev.code === 'KeyD') {\n      RIGHT = state\n    } else if (ev.code === 'KeyQ') {\n      ZOOM_OUT = state\n    } else if (ev.code === 'KeyE') {\n      ZOOM_IN = state\n    }\n  }\n\n  let mouseDown: boolean = false\n  let lastMouseRaw: [number, number]|null = null\n  let lastMouseWorld: [number, number]|null = null\n\n  const _onMouseDown = (ev: MouseEvent) => {\n    lastMouseWorld = _mousePos(ev)\n    lastMouseRaw = [ev.offsetX, ev.offsetY]\n    if (ev.button === 0) {\n      mouseDown = true\n      addEvent([Protocol.INPUT_EV_MOUSE_DOWN, ...lastMouseWorld])\n    }\n  }\n\n  const _onMouseUp = (ev: MouseEvent) => {\n    lastMouseWorld = _mousePos(ev)\n    lastMouseRaw = [ev.offsetX, ev.offsetY]\n    if (ev.button === 0) {\n      mouseDown = false\n      addEvent([Protocol.INPUT_EV_MOUSE_UP, ...lastMouseWorld])\n    }\n  }\n\n  const _onMouseMove = (ev: MouseEvent) => {\n    if (!lastMouseRaw) {\n      return\n    }\n    lastMouseWorld = _mousePos(ev)\n    const diffWorld = _toWorldDim(\n      -(lastMouseRaw[0] - ev.offsetX),\n      -(lastMouseRaw[1] - ev.offsetY),\n    )\n    addEvent([Protocol.INPUT_EV_MOUSE_MOVE, ...lastMouseWorld, ...diffWorld, mouseDown ? 1 : 0])\n    lastMouseRaw = [ev.offsetX, ev.offsetY]\n  }\n\n  const _onWheel = (ev: WheelEvent) => {\n    lastMouseWorld = _mousePos(ev)\n    if (viewport.canZoom(ev.deltaY < 0 ? 'in' : 'out')) {\n      const evt = ev.deltaY < 0\n        ? Protocol.INPUT_EV_ZOOM_IN\n        : Protocol.INPUT_EV_ZOOM_OUT\n      addEvent([evt, ...lastMouseWorld])\n    }\n  }\n\n  const _onKeyUp = (ev: KeyboardEvent) => _key(true, ev)\n  const _onKeyDown = (ev: KeyboardEvent) => _key(false, ev)\n  const _onKeyPress = (ev: KeyboardEvent) => {\n    if (!KEYS_ON) {\n      return\n    }\n\n    if (MODE === MODE_REPLAY) {\n      if (ev.code === 'KeyI') {\n        addEvent([Protocol.INPUT_EV_REPLAY_SPEED_UP])\n      } else if (ev.code === 'KeyO') {\n        addEvent([Protocol.INPUT_EV_REPLAY_SPEED_DOWN])\n      } else if (ev.code === 'KeyP') {\n        addEvent([Protocol.INPUT_EV_REPLAY_TOGGLE_PAUSE])\n      }\n    }\n\n    if (ev.code === 'Space') {\n      addEvent([Protocol.INPUT_EV_TOGGLE_PREVIEW])\n    } else if (ev.code === 'KeyF') {\n      addEvent([Protocol.INPUT_EV_TOGGLE_FIXED_PIECES])\n    } else if (ev.code === 'KeyG') {\n      addEvent([Protocol.INPUT_EV_TOGGLE_LOOSE_PIECES])\n    } else if (ev.code === 'KeyM') {\n      addEvent([Protocol.INPUT_EV_TOGGLE_SOUNDS])\n    } else if (ev.code === 'KeyN') {\n      addEvent([Protocol.INPUT_EV_TOGGLE_PLAYER_NAMES])\n    } else if (ev.code === 'KeyC') {\n      addEvent([Protocol.INPUT_EV_CENTER_FIT_PUZZLE])\n    } else {\n      for (let i = 0; i <= 9; i++) {\n        if (ev.code === `Digit${i}`) {\n          // store or restore pos+zoom in slot i\n          const evt = ev.shiftKey ? Protocol.INPUT_EV_STORE_POS : Protocol.INPUT_EV_RESTORE_POS\n          addEvent([evt, i])\n          break;\n        }\n      }\n    }\n  }\n\n  const registerEvents = () => {\n    canvas.addEventListener('mousedown', _onMouseDown)\n    canvas.addEventListener('mouseup', _onMouseUp)\n    canvas.addEventListener('mousemove', _onMouseMove)\n    canvas.addEventListener('wheel', _onWheel)\n    window.addEventListener('keydown', _onKeyUp)\n    window.addEventListener('keyup', _onKeyDown)\n    window.addEventListener('keypress', _onKeyPress)\n  }\n  const unregisterEvents = () => {\n    canvas.removeEventListener('mousedown', _onMouseDown)\n    canvas.removeEventListener('mouseup', _onMouseUp)\n    canvas.removeEventListener('mousemove', _onMouseMove)\n    canvas.removeEventListener('wheel', _onWheel)\n    window.removeEventListener('keydown', _onKeyUp)\n    window.removeEventListener('keyup', _onKeyDown)\n    window.removeEventListener('keypress', _onKeyPress)\n  }\n\n  const createSnapshotEvents = (prev: Snapshot, curr: Snapshot) => {\n    if (!lastMouseRaw || !lastMouseWorld) {\n      return\n    }\n\n    const prevWorld = new Camera(prev).viewportToWorld({x: lastMouseRaw[0], y: lastMouseRaw[1]})\n    const currWorld = new Camera(curr).viewportToWorld({x: lastMouseRaw[0], y: lastMouseRaw[1]})\n    const diffWorld = [\n      -(prevWorld.x - currWorld.x),\n      -(prevWorld.y - currWorld.y),\n    ]\n    addEvent([Protocol.INPUT_EV_MOUSE_MOVE, ...lastMouseWorld, ...diffWorld, mouseDown ? 1 : 0])\n  }\n\n  const addEvent = (event: GameEvent) => {\n    events.push(event)\n  }\n\n  const consumeAll = (): GameEvent[] => {\n    if (events.length === 0) {\n      return []\n    }\n    const all = events.slice()\n    events = []\n    return all\n  }\n\n  const createKeyEvents = (): void => {\n    const w = (LEFT ? 1 : 0) - (RIGHT ? 1 : 0)\n    const h = (UP ? 1 : 0) - (DOWN ? 1 : 0)\n    if (w !== 0 || h !== 0) {\n      const amount = (SHIFT ? 24 : 12) * Math.sqrt(viewport.getCurrentZoom())\n      const pos = viewport.viewportDimToWorld({w: w * amount, h: h * amount})\n      addEvent([Protocol.INPUT_EV_MOVE, pos.w, pos.h])\n      if (lastMouseWorld) {\n        lastMouseWorld[0] -= pos.w\n        lastMouseWorld[1] -= pos.h\n      }\n    }\n\n    if (ZOOM_IN && ZOOM_OUT) {\n      // cancel each other out\n    } else if (ZOOM_IN) {\n      if (viewport.canZoom('in')) {\n        const target = lastMouseWorld || _canvasCenter()\n        addEvent([Protocol.INPUT_EV_ZOOM_IN, ...target])\n      }\n    } else if (ZOOM_OUT) {\n      if (viewport.canZoom('out')) {\n        const target = lastMouseWorld || _canvasCenter()\n        addEvent([Protocol.INPUT_EV_ZOOM_OUT, ...target])\n      }\n    }\n  }\n\n  const setHotkeys = (state: boolean) => {\n    KEYS_ON = state\n  }\n\n  return {\n    registerEvents,\n    unregisterEvents,\n    addEvent,\n    consumeAll,\n    createKeyEvents,\n    createSnapshotEvents,\n    setHotkeys,\n  }\n}\n\nexport default EventAdapter\n","\"use strict\"\n\nimport { Emitter, EventType } from 'mitt'\nimport { GameLoopInstance, run } from './gameloop'\nimport { Camera, Snapshot } from './Camera'\nimport Graphics from './Graphics'\nimport Debug from './Debug'\nimport Communication from './Communication'\nimport Util, { logger } from './../common/Util'\nimport PuzzleGraphics from './PuzzleGraphics'\nimport Game from './../common/GameCommon'\nimport fireworksController from './Fireworks'\nimport Protocol from '../common/Protocol'\nimport Time from '../common/Time'\nimport settings from './settings'\nimport { SETTINGS, DEFAULTS } from './settings'\nimport { Dim, Point } from '../common/Geometry'\nimport {\n  FixedLengthArray,\n  Game as GameType,\n  Player,\n  Piece,\n  EncodedGame,\n  ReplayData,\n  Timestamp,\n  ServerEvent,\n} from '../common/Types'\nimport EventAdapter from './EventAdapter'\ndeclare global {\n  interface Window {\n      DEBUG?: boolean\n  }\n}\n\nconst log = logger('game.ts')\n\n// @ts-ignore\nconst images = import.meta.globEager('./*.png')\n\n// @ts-ignore\nconst sounds = import.meta.globEager('./*.mp3')\n\nexport const MODE_PLAY = 'play'\nexport const MODE_REPLAY = 'replay'\n\nlet PIECE_VIEW_FIXED = true\nlet PIECE_VIEW_LOOSE = true\n\ninterface Replay {\n  final: boolean\n  log: Array<any> // current log entries\n  logPointer: number // pointer to current item in the log array\n  speeds: Array<number>\n  speedIdx: number\n  paused: boolean\n  lastRealTs: number\n  lastGameTs: number\n  gameStartTs: number\n  skipNonActionPhases: boolean\n  //\n  dataOffset: number\n}\n\nconst shouldDrawPiece = (piece: Piece) => {\n  if (piece.owner === -1) {\n    return PIECE_VIEW_FIXED\n  }\n  return PIECE_VIEW_LOOSE\n}\n\nlet RERENDER = true\n\nexport async function main(\n  gameId: string,\n  clientId: string,\n  wsAddress: string,\n  MODE: string,\n  TARGET_EL: HTMLCanvasElement,\n  eventBus: Emitter<Record<EventType, unknown>>,\n) {\n  if (typeof window.DEBUG === 'undefined') window.DEBUG = false\n\n  const shouldDrawPlayer = (player: Player) => {\n    return MODE === MODE_REPLAY || player.id !== clientId\n  }\n\n  const click = sounds['./click.mp3'].default\n  const clickAudio = new Audio(click)\n\n  const cursorGrab = await Graphics.loadImageToBitmap(images['./grab.png'].default)\n  const cursorHand = await Graphics.loadImageToBitmap(images['./hand.png'].default)\n  const cursorGrabMask = await Graphics.loadImageToBitmap(images['./grab_mask.png'].default)\n  const cursorHandMask = await Graphics.loadImageToBitmap(images['./hand_mask.png'].default)\n\n  // all cursors must be of the same dimensions\n  const CURSOR_W = cursorGrab.width\n  const CURSOR_W_2 = Math.round(CURSOR_W / 2)\n  const CURSOR_H = cursorGrab.height\n  const CURSOR_H_2 = Math.round(CURSOR_H / 2)\n\n  const cursors: Record<string, ImageBitmap> = {}\n  const getPlayerCursor = async (p: Player) => {\n    const key = p.color + ' ' + p.d\n    if (!cursors[key]) {\n      const cursor = p.d ? cursorGrab : cursorHand\n      if (p.color) {\n        const mask = p.d ? cursorGrabMask : cursorHandMask\n        cursors[key] = await createImageBitmap(\n          Graphics.colorizedCanvas(cursor, mask, p.color)\n        )\n      } else {\n        cursors[key] = cursor\n      }\n    }\n    return cursors[key]\n  }\n\n  const canvas = TARGET_EL\n\n  // stuff only available in replay mode...\n  // TODO: refactor\n  const REPLAY: Replay = {\n    final: false,\n    log: [],\n    logPointer: 0,\n    speeds: [0.5, 1, 2, 5, 10, 20, 50, 100, 250, 500],\n    speedIdx: 1,\n    paused: false,\n    lastRealTs: 0,\n    lastGameTs: 0,\n    gameStartTs: 0,\n    skipNonActionPhases: true,\n    dataOffset: 0,\n  }\n\n  Communication.onConnectionStateChange((state) => {\n    eventBus.emit('connectionState', state)\n  })\n\n  const queryNextReplayBatch = async (\n    gameId: string\n  ): Promise<ReplayData> => {\n    const offset = REPLAY.dataOffset\n    REPLAY.dataOffset += 10000 // meh\n    const replay: ReplayData = await Communication.requestReplayData(\n      gameId,\n      offset\n    )\n\n    // cut log that was already handled\n    REPLAY.log = REPLAY.log.slice(REPLAY.logPointer)\n    REPLAY.logPointer = 0\n    REPLAY.log.push(...replay.log)\n\n    if (replay.log.length === 0) {\n      REPLAY.final = true\n    }\n    return replay\n  }\n\n  let TIME: () => number = () => 0\n  const connect = async () => {\n    if (MODE === MODE_PLAY) {\n      const game: EncodedGame = await Communication.connect(wsAddress, gameId, clientId)\n      const gameObject: GameType = Util.decodeGame(game)\n      Game.setGame(gameObject.id, gameObject)\n      TIME = () => Time.timestamp()\n    } else if (MODE === MODE_REPLAY) {\n      const replay: ReplayData = await queryNextReplayBatch(gameId)\n      if (!replay.game) {\n        throw '[ 2021-05-29 no game received ]'\n      }\n      const gameObject: GameType = Util.decodeGame(replay.game)\n      Game.setGame(gameObject.id, gameObject)\n\n      REPLAY.lastRealTs = Time.timestamp()\n      REPLAY.gameStartTs = parseInt(replay.log[0][4], 10)\n      REPLAY.lastGameTs = REPLAY.gameStartTs\n\n      TIME = () => REPLAY.lastGameTs\n    } else {\n      throw '[ 2020-12-22 MODE invalid, must be play|replay ]'\n    }\n\n    // rerender after (re-)connect\n    RERENDER = true\n  }\n\n  await connect()\n\n  const PIECE_DRAW_OFFSET = Game.getPieceDrawOffset(gameId)\n  const PIECE_DRAW_SIZE = Game.getPieceDrawSize(gameId)\n  const PUZZLE_WIDTH = Game.getPuzzleWidth(gameId)\n  const PUZZLE_HEIGHT = Game.getPuzzleHeight(gameId)\n  const TABLE_WIDTH = Game.getTableWidth(gameId)\n  const TABLE_HEIGHT = Game.getTableHeight(gameId)\n\n  const BOARD_POS = {\n    x: (TABLE_WIDTH - PUZZLE_WIDTH) / 2,\n    y: (TABLE_HEIGHT - PUZZLE_HEIGHT) / 2\n  }\n  const BOARD_DIM = {\n    w: PUZZLE_WIDTH,\n    h: PUZZLE_HEIGHT,\n  }\n  const PIECE_DIM = {\n    w: PIECE_DRAW_SIZE,\n    h: PIECE_DRAW_SIZE,\n  }\n\n  const bitmaps = await PuzzleGraphics.loadPuzzleBitmaps(Game.getPuzzle(gameId))\n\n  const fireworks = new fireworksController(canvas, Game.getRng(gameId))\n  fireworks.init()\n\n  const ctx = canvas.getContext('2d') as CanvasRenderingContext2D\n  canvas.classList.add('loaded')\n  eventBus.emit('puzzleCut')\n\n  let viewportToggleSlot: string = '';\n  const viewportSnapshots: Record<string, Snapshot> = {}\n  // initialize some view data\n  // this global data will change according to input events\n  const viewport = new Camera()\n\n  const centerPuzzle = () => {\n    // center on the puzzle\n    viewport.reset()\n    viewport.move(\n      -(TABLE_WIDTH - canvas.width) /2,\n      -(TABLE_HEIGHT - canvas.height) /2\n    )\n\n    // zoom viewport to fit whole puzzle in\n    const x = viewport.worldDimToViewportRaw(BOARD_DIM)\n    const border = 20\n    const targetW = canvas.width - (border * 2)\n    const targetH = canvas.height - (border * 2)\n    if (\n      (x.w > targetW || x.h > targetH)\n      || (x.w < targetW && x.h < targetH)\n    ) {\n      const zoom = Math.min(targetW / x.w, targetH / x.h)\n      const center = { x: canvas.width / 2, y: canvas.height / 2 }\n      viewport.setZoom(zoom, center)\n    }\n  }\n  const evts = EventAdapter(canvas, window, viewport, MODE)\n  evts.registerEvents()\n\n  const handleViewportSnapshot = (slot: string): void => {\n    if (viewportSnapshots['last'] && viewportToggleSlot === slot) {\n      const prev = viewport.snapshot()\n      const curr = viewportSnapshots['last']\n      viewport.fromSnapshot(curr)\n      evts.createSnapshotEvents(prev, curr)\n      delete viewportSnapshots['last']\n    } else if (viewportSnapshots[slot]) {\n      const curr = viewportSnapshots[slot]\n      const prev = viewport.snapshot()\n      viewportSnapshots['last'] = prev\n      viewportToggleSlot = slot\n      viewport.fromSnapshot(curr)\n      evts.createSnapshotEvents(prev, curr)\n    }\n  }\n\n  centerPuzzle()\n  viewportSnapshots['center'] = viewport.snapshot()\n\n  const previewImageUrl = Game.getImageUrl(gameId)\n\n  const updateStatus = (ts: number) => {\n    const startTs = Game.getStartTs(gameId)\n    const finishTs = Game.getFinishTs(gameId)\n\n    eventBus.emit('status', {\n      finished: !!(finishTs),\n      duration: (finishTs || ts) - startTs,\n      piecesDone: Game.getFinishedPiecesCount(gameId),\n      piecesTotal: Game.getPieceCount(gameId),\n    })\n    eventBus.emit('players', {\n      active: Game.getActivePlayers(gameId, ts),\n      idle: Game.getIdlePlayers(gameId, ts),\n    })\n  }\n\n  updateStatus(TIME())\n\n  const longFinished = !! Game.getFinishTs(gameId)\n  let finished = longFinished\n  const justFinished = () => finished && !longFinished\n\n  const playerSoundVolume = (): number => {\n    return settings.getInt(SETTINGS.SOUND_VOLUME, DEFAULTS.SOUND_VOLUME)\n  }\n  const otherPlayerClickSoundEnabled = (): boolean => {\n    return settings.getBool(SETTINGS.OTHER_PLAYER_CLICK_SOUND_ENABLED, DEFAULTS.OTHER_PLAYER_CLICK_SOUND_ENABLED)\n  }\n  const playerSoundEnabled = (): boolean => {\n    return settings.getBool(SETTINGS.SOUND_ENABLED, DEFAULTS.SOUND_ENABLED)\n  }\n  const showPlayerNames = (): boolean => {\n    return settings.getBool(SETTINGS.SHOW_PLAYER_NAMES, DEFAULTS.SHOW_PLAYER_NAMES)\n  }\n  const playerBgColor = (): string => {\n    if (MODE === MODE_REPLAY) {\n      return settings.getStr(SETTINGS.COLOR_BACKGROUND, DEFAULTS.COLOR_BACKGROUND)\n    }\n    return Game.getPlayerBgColor(gameId, clientId)\n        || settings.getStr(SETTINGS.COLOR_BACKGROUND, DEFAULTS.COLOR_BACKGROUND)\n  }\n  const playerColor = (): string => {\n    if (MODE === MODE_REPLAY) {\n      return settings.getStr(SETTINGS.PLAYER_COLOR, DEFAULTS.PLAYER_COLOR)\n    }\n    return Game.getPlayerColor(gameId, clientId)\n        || settings.getStr(SETTINGS.PLAYER_COLOR, DEFAULTS.PLAYER_COLOR)\n  }\n  const playerName = (): string => {\n    if (MODE === MODE_REPLAY) {\n      return settings.getStr(SETTINGS.PLAYER_NAME, DEFAULTS.PLAYER_NAME)\n    }\n    return Game.getPlayerName(gameId, clientId)\n        || settings.getStr(SETTINGS.PLAYER_NAME, DEFAULTS.PLAYER_NAME)\n  }\n\n  const playClick = () => {\n    const vol = playerSoundVolume()\n    clickAudio.volume = vol / 100\n    clickAudio.play()\n  }\n\n  const player = {\n    background: playerBgColor(),\n    color: playerColor(),\n    name: playerName(),\n    soundsEnabled: playerSoundEnabled(),\n    otherPlayerClickSoundEnabled: otherPlayerClickSoundEnabled(),\n    soundsVolume: playerSoundVolume(),\n    showPlayerNames: showPlayerNames(),\n  }\n  evts.addEvent([Protocol.INPUT_EV_BG_COLOR, player.background])\n  evts.addEvent([Protocol.INPUT_EV_PLAYER_COLOR, player.color])\n  evts.addEvent([Protocol.INPUT_EV_PLAYER_NAME, player.name])\n\n  let cursorDown: string = ''\n  let cursor: string = ''\n  let cursorState: boolean = false\n  const updatePlayerCursorState = (d: boolean) => {\n    cursorState = d\n    const [url, fallback] = d ? [cursorDown, 'grab'] : [cursor, 'default']\n    canvas.style.cursor = `url('${url}') ${CURSOR_W_2} ${CURSOR_H_2}, ${fallback}`\n  }\n  const updatePlayerCursorColor = (color: string) => {\n    cursorDown = Graphics.colorizedCanvas(cursorGrab, cursorGrabMask, color).toDataURL()\n    cursor = Graphics.colorizedCanvas(cursorHand, cursorHandMask, color).toDataURL()\n    updatePlayerCursorState(cursorState)\n  }\n  updatePlayerCursorColor(playerColor())\n\n  const doSetSpeedStatus = () => {\n    eventBus.emit('replaySpeed', REPLAY.speeds[REPLAY.speedIdx])\n    eventBus.emit('replayPaused', REPLAY.paused)\n  }\n\n  const replayOnSpeedUp = () => {\n    if (REPLAY.speedIdx + 1 < REPLAY.speeds.length) {\n      REPLAY.speedIdx++\n      doSetSpeedStatus()\n    }\n  }\n  const replayOnSpeedDown = () => {\n    if (REPLAY.speedIdx >= 1) {\n      REPLAY.speedIdx--\n      doSetSpeedStatus()\n    }\n  }\n  const replayOnPauseToggle = () => {\n    REPLAY.paused = !REPLAY.paused\n    doSetSpeedStatus()\n  }\n\n  eventBus.on('replayOnSpeedUp', () => {\n    replayOnSpeedUp()\n  })\n  eventBus.on('replayOnSpeedDown', () => {\n    replayOnSpeedDown()\n  })\n  eventBus.on('replayOnPauseToggle', () => {\n    replayOnPauseToggle()\n  })\n  eventBus.on('onBgChange', (value: any) => {\n    if (player.background !== value) {\n      player.background = value\n      settings.setStr(SETTINGS.COLOR_BACKGROUND, value)\n      evts.addEvent([Protocol.INPUT_EV_BG_COLOR, value])\n    }\n  })\n  eventBus.on('onColorChange', (value: any) => {\n    if (player.color !== value) {\n      player.color = value\n      settings.setStr(SETTINGS.PLAYER_COLOR, value)\n      evts.addEvent([Protocol.INPUT_EV_PLAYER_COLOR, value])\n    }\n  })\n  eventBus.on('onNameChange', (value: any) => {\n    if (player.name !== value) {\n      player.name = value\n      settings.setStr(SETTINGS.PLAYER_NAME, value)\n      evts.addEvent([Protocol.INPUT_EV_PLAYER_NAME, value])\n    }\n  })\n  eventBus.on('onOtherPlayerClickSoundEnabledChange', (value: any) => {\n    if (player.otherPlayerClickSoundEnabled !== value) {\n      player.otherPlayerClickSoundEnabled = value\n      settings.setBool(SETTINGS.OTHER_PLAYER_CLICK_SOUND_ENABLED, value)\n    }\n  })\n  eventBus.on('onSoundsEnabledChange', (value: any) => {\n    if (player.soundsEnabled !== value) {\n      player.soundsEnabled = value\n      settings.setBool(SETTINGS.SOUND_ENABLED, value)\n    }\n  })\n  eventBus.on('onSoundsVolumeChange', (value: any) => {\n    if (player.soundsVolume !== value) {\n      player.soundsVolume = value\n      settings.setInt(SETTINGS.SOUND_VOLUME, value)\n      playClick()\n    }\n  })\n  eventBus.on('onShowPlayerNamesChange', (value: any) => {\n    if (player.showPlayerNames !== value) {\n      player.showPlayerNames = value\n      settings.setBool(SETTINGS.SHOW_PLAYER_NAMES, value)\n    }\n  })\n  eventBus.on('setHotkeys', (state: any) => {\n    evts.setHotkeys(state)\n  })\n  eventBus.on('requireRerender', () => {\n    RERENDER = true\n  })\n\n  const intervals: NodeJS.Timeout[] = []\n  let to: NodeJS.Timeout\n  const clearIntervals = () => {\n    intervals.forEach(inter => {\n      clearInterval(inter)\n    })\n    if (to) {\n      clearTimeout(to)\n    }\n  }\n\n  let gameLoopInstance: GameLoopInstance\n  const unload = () => {\n    clearIntervals()\n    if (gameLoopInstance) {\n      gameLoopInstance.stop()\n    }\n    if (evts) {\n      evts.unregisterEvents()\n    }\n  }\n\n  if (MODE === MODE_PLAY) {\n    intervals.push(setInterval(() => {\n      updateStatus(TIME())\n    }, 1000))\n  } else if (MODE === MODE_REPLAY) {\n    doSetSpeedStatus()\n  }\n\n  if (MODE === MODE_PLAY) {\n    Communication.onServerChange((msg: ServerEvent) => {\n      const msgType = msg[0]\n      const evClientId = msg[1]\n      const evClientSeq = msg[2]\n      const evChanges = msg[3]\n\n      let rerender: boolean = false;\n      let otherPlayerPiecesConnected: boolean = false;\n\n      for (const [changeType, changeData] of evChanges) {\n        switch (changeType) {\n          case Protocol.CHANGE_PLAYER: {\n            const p = Util.decodePlayer(changeData)\n            if (p.id !== clientId) {\n              Game.setPlayer(gameId, p.id, p)\n              rerender = true\n            }\n          } break;\n          case Protocol.CHANGE_TILE: {\n            const piece = Util.decodePiece(changeData)\n            Game.setPiece(gameId, piece.idx, piece)\n            rerender = true\n          } break;\n          case Protocol.CHANGE_DATA: {\n            Game.setPuzzleData(gameId, changeData)\n            rerender = true\n          } break;\n          case Protocol.PLAYER_SNAP: {\n            const snapPlayerId = changeData\n            if (snapPlayerId !== clientId) {\n              otherPlayerPiecesConnected = true\n            }\n          } break;\n        }\n      }\n      if (otherPlayerPiecesConnected && playerSoundEnabled() && otherPlayerClickSoundEnabled()) {\n        playClick()\n      }\n      if (rerender) {\n        RERENDER = true\n      }\n      finished = !! Game.getFinishTs(gameId)\n    })\n  } else if (MODE === MODE_REPLAY) {\n    const handleLogEntry = (logEntry: any[], ts: Timestamp) => {\n      const entry = logEntry\n      if (entry[0] === Protocol.LOG_ADD_PLAYER) {\n        const playerId = entry[1]\n        Game.addPlayer(gameId, playerId, ts)\n        return true\n      }\n      if (entry[0] === Protocol.LOG_UPDATE_PLAYER) {\n        const playerId = Game.getPlayerIdByIndex(gameId, entry[1])\n        if (!playerId) {\n          throw '[ 2021-05-17 player not found (update player) ]'\n        }\n        Game.addPlayer(gameId, playerId, ts)\n        return true\n      }\n      if (entry[0] === Protocol.LOG_HANDLE_INPUT) {\n        const playerId = Game.getPlayerIdByIndex(gameId, entry[1])\n        if (!playerId) {\n          throw '[ 2021-05-17 player not found (handle input) ]'\n        }\n        const input = entry[2]\n        Game.handleInput(gameId, playerId, input, ts)\n        return true\n      }\n      return false\n    }\n\n    let GAME_TS = REPLAY.lastGameTs\n    const next = async () => {\n      if (REPLAY.logPointer + 1 >= REPLAY.log.length) {\n        await queryNextReplayBatch(gameId)\n      }\n\n      const realTs = Time.timestamp()\n      if (REPLAY.paused) {\n        REPLAY.lastRealTs = realTs\n        to = setTimeout(next, 50)\n        return\n      }\n      const timePassedReal = realTs - REPLAY.lastRealTs\n      const timePassedGame = timePassedReal * REPLAY.speeds[REPLAY.speedIdx]\n      let maxGameTs = REPLAY.lastGameTs + timePassedGame\n      do {\n        if (REPLAY.paused) {\n          break\n        }\n        const nextIdx = REPLAY.logPointer + 1\n        if (nextIdx >= REPLAY.log.length) {\n          break\n        }\n\n        const currLogEntry = REPLAY.log[REPLAY.logPointer]\n        const currTs: Timestamp = GAME_TS + currLogEntry[currLogEntry.length - 1]\n\n        const nextLogEntry = REPLAY.log[nextIdx]\n        const diffToNext = nextLogEntry[nextLogEntry.length - 1]\n        const nextTs: Timestamp = currTs + diffToNext\n        if (nextTs > maxGameTs) {\n          // next log entry is too far into the future\n          if (REPLAY.skipNonActionPhases && (maxGameTs + 500 * Time.MS < nextTs)) {\n            maxGameTs += diffToNext\n          }\n          break\n        }\n\n        GAME_TS = currTs\n        if (handleLogEntry(nextLogEntry, nextTs)) {\n          RERENDER = true\n        }\n        REPLAY.logPointer = nextIdx\n      } while (true)\n      REPLAY.lastRealTs = realTs\n      REPLAY.lastGameTs = maxGameTs\n      updateStatus(TIME())\n\n      if (!REPLAY.final) {\n        to = setTimeout(next, 50)\n      }\n    }\n\n    next()\n  }\n\n  const onUpdate = (): void => {\n    // handle key downs once per onUpdate\n    // this will create Protocol.INPUT_EV_MOVE events if something\n    // relevant is pressed\n    evts.createKeyEvents()\n\n    for (const evt of evts.consumeAll()) {\n      if (MODE === MODE_PLAY) {\n        // LOCAL ONLY CHANGES\n        // -------------------------------------------------------------\n        const type = evt[0]\n        if (type === Protocol.INPUT_EV_MOVE) {\n          const dim = viewport.worldDimToViewportRaw({ w: evt[1], h: evt[2] })\n          RERENDER = true\n          viewport.move(dim.w, dim.h)\n          delete viewportSnapshots['last']\n        } else if (type === Protocol.INPUT_EV_MOUSE_MOVE) {\n          const down = evt[5]\n          if (down && !Game.getFirstOwnedPiece(gameId, clientId)) {\n            // move the cam\n            const diff = viewport.worldDimToViewportRaw({ w: evt[3], h: evt[4] })\n            RERENDER = true\n            viewport.move(diff.w, diff.h)\n            delete viewportSnapshots['last']\n          }\n        } else if (type === Protocol.INPUT_EV_PLAYER_COLOR) {\n          updatePlayerCursorColor(evt[1])\n        } else if (type === Protocol.INPUT_EV_MOUSE_DOWN) {\n          updatePlayerCursorState(true)\n        } else if (type === Protocol.INPUT_EV_MOUSE_UP) {\n          updatePlayerCursorState(false)\n        } else if (type === Protocol.INPUT_EV_ZOOM_IN) {\n          const pos = { x: evt[1], y: evt[2] }\n          RERENDER = true\n          viewport.zoom('in', viewport.worldToViewportRaw(pos))\n          delete viewportSnapshots['last']\n        } else if (type === Protocol.INPUT_EV_ZOOM_OUT) {\n          const pos = { x: evt[1], y: evt[2] }\n          RERENDER = true\n          viewport.zoom('out', viewport.worldToViewportRaw(pos))\n          delete viewportSnapshots['last']\n        } else if (type === Protocol.INPUT_EV_TOGGLE_PREVIEW) {\n          eventBus.emit('togglePreview')\n        } else if (type === Protocol.INPUT_EV_TOGGLE_SOUNDS) {\n          eventBus.emit('toggleSoundsEnabled')\n        } else if (type === Protocol.INPUT_EV_TOGGLE_PLAYER_NAMES) {\n          eventBus.emit('togglePlayerNames')\n        } else if (type === Protocol.INPUT_EV_CENTER_FIT_PUZZLE) {\n          handleViewportSnapshot('center')\n        } else if (type === Protocol.INPUT_EV_TOGGLE_FIXED_PIECES) {\n          PIECE_VIEW_FIXED = !PIECE_VIEW_FIXED\n          RERENDER = true\n        } else if (type === Protocol.INPUT_EV_TOGGLE_LOOSE_PIECES) {\n          PIECE_VIEW_LOOSE = !PIECE_VIEW_LOOSE\n          RERENDER = true\n        } else if (type === Protocol.INPUT_EV_STORE_POS) {\n          const slot: string = `${evt[1]}`\n          viewportSnapshots[slot] = viewport.snapshot()\n        } else if (type === Protocol.INPUT_EV_RESTORE_POS) {\n          const slot: string = `${evt[1]}`\n          handleViewportSnapshot(slot)\n        }\n\n        // LOCAL + SERVER CHANGES\n        // -------------------------------------------------------------\n        const ts = TIME()\n        const changes = Game.handleInput(gameId, clientId, evt, ts)\n        if (playerSoundEnabled()) {\n          if (changes.find(change => change[0] === Protocol.PLAYER_SNAP)) {\n            playClick()\n          }\n        }\n        if (changes.length > 0) {\n          RERENDER = true\n        }\n        Communication.sendClientEvent(evt)\n      } else if (MODE === MODE_REPLAY) {\n        // LOCAL ONLY CHANGES\n        // -------------------------------------------------------------\n        const type = evt[0]\n        if (type === Protocol.INPUT_EV_REPLAY_TOGGLE_PAUSE) {\n          replayOnPauseToggle()\n        } else if (type === Protocol.INPUT_EV_REPLAY_SPEED_DOWN) {\n          replayOnSpeedDown()\n        } else if (type === Protocol.INPUT_EV_REPLAY_SPEED_UP) {\n          replayOnSpeedUp()\n        } else if (type === Protocol.INPUT_EV_MOVE) {\n          const dim = viewport.worldDimToViewportRaw({ w: evt[1], h: evt[2] })\n          RERENDER = true\n          viewport.move(dim.w, dim.h)\n        } else if (type === Protocol.INPUT_EV_MOUSE_MOVE) {\n          const down = evt[5]\n          if (down) {\n            const diff = viewport.worldDimToViewportRaw({ w: evt[3], h: evt[4] })\n            RERENDER = true\n            viewport.move(diff.w, diff.h)\n          }\n        } else if (type === Protocol.INPUT_EV_PLAYER_COLOR) {\n          updatePlayerCursorColor(evt[1])\n        } else if (type === Protocol.INPUT_EV_MOUSE_DOWN) {\n          updatePlayerCursorState(true)\n        } else if (type === Protocol.INPUT_EV_MOUSE_UP) {\n          updatePlayerCursorState(false)\n        } else if (type === Protocol.INPUT_EV_ZOOM_IN) {\n          const pos = { x: evt[1], y: evt[2] }\n          RERENDER = true\n          viewport.zoom('in', viewport.worldToViewportRaw(pos))\n        } else if (type === Protocol.INPUT_EV_ZOOM_OUT) {\n          const pos = { x: evt[1], y: evt[2] }\n          RERENDER = true\n          viewport.zoom('out', viewport.worldToViewportRaw(pos))\n        } else if (type === Protocol.INPUT_EV_TOGGLE_PREVIEW) {\n          eventBus.emit('togglePreview')\n        } else if (type === Protocol.INPUT_EV_TOGGLE_SOUNDS) {\n          eventBus.emit('toggleSoundsEnabled')\n        } else if (type === Protocol.INPUT_EV_TOGGLE_PLAYER_NAMES) {\n          eventBus.emit('togglePlayerNames')\n        } else if (type === Protocol.INPUT_EV_CENTER_FIT_PUZZLE) {\n          handleViewportSnapshot('center')\n        } else if (type === Protocol.INPUT_EV_TOGGLE_FIXED_PIECES) {\n          PIECE_VIEW_FIXED = !PIECE_VIEW_FIXED\n          RERENDER = true\n        } else if (type === Protocol.INPUT_EV_TOGGLE_LOOSE_PIECES) {\n          PIECE_VIEW_LOOSE = !PIECE_VIEW_LOOSE\n          RERENDER = true\n        } else if (type === Protocol.INPUT_EV_STORE_POS) {\n          const slot: string = `${evt[1]}`\n          viewportSnapshots[slot] = viewport.snapshot()\n        } else if (type === Protocol.INPUT_EV_RESTORE_POS) {\n          const slot: string = `${evt[1]}`\n          handleViewportSnapshot(slot)\n        }\n      }\n    }\n\n    finished = !! Game.getFinishTs(gameId)\n    if (justFinished()) {\n      fireworks.update()\n      RERENDER = true\n    }\n  }\n\n  const onRender = async (): Promise<void> => {\n    if (!RERENDER) {\n      return\n    }\n\n    const ts = TIME()\n\n    let pos: Point\n    let dim: Dim\n    let bmp: ImageBitmap\n\n    if (window.DEBUG) Debug.checkpoint_start(0)\n\n    // CLEAR CTX\n    // ---------------------------------------------------------------\n    ctx.fillStyle = playerBgColor()\n    ctx.fillRect(0, 0, canvas.width, canvas.height)\n    if (window.DEBUG) Debug.checkpoint('clear done')\n    // ---------------------------------------------------------------\n\n\n    // DRAW BOARD\n    // ---------------------------------------------------------------\n    pos = viewport.worldToViewportRaw(BOARD_POS)\n    dim = viewport.worldDimToViewportRaw(BOARD_DIM)\n    ctx.fillStyle = 'rgba(255, 255, 255, .3)'\n    ctx.fillRect(pos.x, pos.y, dim.w, dim.h)\n    if (window.DEBUG) Debug.checkpoint('board done')\n    // ---------------------------------------------------------------\n\n\n    // DRAW TILES\n    // ---------------------------------------------------------------\n    const tiles = Game.getPiecesSortedByZIndex(gameId)\n    if (window.DEBUG) Debug.checkpoint('get tiles done')\n\n    dim = viewport.worldDimToViewportRaw(PIECE_DIM)\n    for (const tile of tiles) {\n      if (!shouldDrawPiece(tile)) {\n        continue\n      }\n      bmp = bitmaps[tile.idx]\n      pos = viewport.worldToViewportRaw({\n        x: PIECE_DRAW_OFFSET + tile.pos.x,\n        y: PIECE_DRAW_OFFSET + tile.pos.y,\n      })\n      ctx.drawImage(bmp,\n        0, 0, bmp.width, bmp.height,\n        pos.x, pos.y, dim.w, dim.h\n      )\n    }\n    if (window.DEBUG) Debug.checkpoint('tiles done')\n    // ---------------------------------------------------------------\n\n\n    // DRAW PLAYERS\n    // ---------------------------------------------------------------\n    const texts: Array<FixedLengthArray<[string, number, number]>> = []\n    // Cursors\n    for (const p of Game.getActivePlayers(gameId, ts)) {\n      if (shouldDrawPlayer(p)) {\n        bmp = await getPlayerCursor(p)\n        pos = viewport.worldToViewport(p)\n        ctx.drawImage(bmp, pos.x - CURSOR_W_2, pos.y - CURSOR_H_2)\n        if (showPlayerNames()) {\n          // performance:\n          // not drawing text directly here, to have less ctx\n          // switches between drawImage and fillTxt\n          texts.push([`${p.name} (${p.points})`, pos.x, pos.y + CURSOR_H])\n        }\n      }\n    }\n\n    // Names\n    ctx.fillStyle = 'white'\n    ctx.textAlign = 'center'\n    for (const [txt, x, y] of texts) {\n      ctx.fillText(txt, x, y)\n    }\n\n    if (window.DEBUG) Debug.checkpoint('players done')\n\n    // propagate HUD changes\n    // ---------------------------------------------------------------\n    updateStatus(ts)\n    if (window.DEBUG) Debug.checkpoint('HUD done')\n    // ---------------------------------------------------------------\n\n    if (justFinished()) {\n      fireworks.render()\n    }\n\n    RERENDER = false\n  }\n\n  gameLoopInstance = run({\n    update: onUpdate,\n    render: onRender,\n  })\n\n  return {\n    previewImageUrl,\n    player: player,\n    game: Game.get(gameId),\n    disconnect: Communication.disconnect,\n    connect: connect,\n    unload: unload,\n  }\n}\n","<template>\n  <div id=\"game\">\n    <settings-overlay\n      v-show=\"overlay === 'settings'\"\n      @close=\"toggle('settings', true)\"\n      @bgclick=\"toggle('settings', true)\"\n      v-model=\"g.player\" />\n    <preview-overlay\n      v-show=\"overlay === 'preview'\"\n      @close=\"toggle('preview', false)\"\n      @click=\"toggle('preview', false)\"\n      :img=\"g.previewImageUrl\" />\n    <info-overlay\n      v-if=\"g.game\"\n      v-show=\"overlay === 'info'\"\n      @close=\"toggle('info', true)\"\n      @bgclick=\"toggle('info', true)\"\n      :game=\"g.game\" />\n    <help-overlay\n      v-show=\"overlay === 'help'\"\n      @close=\"toggle('help', true)\"\n      @bgclick=\"toggle('help', true)\" />\n\n    <overlay v-show=\"cuttingPuzzle\">\n      <template v-slot:default>\n        <div>⏳ Cutting puzzle, please wait... ⏳</div>\n      </template>\n    </overlay>\n\n    <connection-overlay\n      :connectionState=\"connectionState\"\n      @reconnect=\"reconnect\"\n      />\n\n    <div class=\"menu-left\">\n      <puzzle-status :status=\"status\" />\n      <div class=\"switch-game-replay\" v-if=\"g.game && g.game.hasReplay\">\n        <router-link :to=\"{ name: 'replay', params: { id: g.game.id } }\">↪️ Watch replay</router-link>\n      </div>\n    </div>\n\n    <div class=\"menu\">\n      <div class=\"tabs\">\n        <router-link class=\"opener\" :to=\"{name: 'index'}\" target=\"_blank\">🧩 Puzzles</router-link>\n        <div class=\"opener\" @click=\"toggle('preview', false)\">🖼️ Preview</div>\n        <div class=\"opener\" @click=\"toggle('settings', true)\">🛠️ Settings</div>\n        <div class=\"opener\" @click=\"toggle('info', true)\">ℹ️ Info</div>\n        <div class=\"opener\" @click=\"toggle('help', true)\">⌨️ Hotkeys</div>\n      </div>\n    </div>\n\n    <div class=\"menu-right\">\n      <scores :players=\"players\" />\n    </div>\n\n    <canvas ref=\"canvas\"></canvas>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport mitt from 'mitt'\n\nimport Scores from './../components/Scores.vue'\nimport PuzzleStatusComponent from './../components/PuzzleStatus.vue'\nimport SettingsOverlay from './../components/SettingsOverlay.vue'\nimport PreviewOverlay from './../components/PreviewOverlay.vue'\nimport InfoOverlay from './../components/InfoOverlay.vue'\nimport ConnectionOverlay from './../components/ConnectionOverlay.vue'\nimport HelpOverlay from './../components/HelpOverlay.vue'\n\nimport { main, MODE_PLAY } from '../game'\nimport { Game, Player, PuzzleStatus } from '../../common/Types'\nimport xhr from '../xhr'\nimport { defaultPlayerSettings } from '../settings'\n\nexport default defineComponent({\n  name: 'game',\n  components: {\n    PuzzleStatusComponent,\n    Scores,\n    SettingsOverlay,\n    PreviewOverlay,\n    InfoOverlay,\n    ConnectionOverlay,\n    HelpOverlay,\n  },\n  data() {\n    return {\n      players: {\n        active: [] as Player[],\n        idle: [] as Player[],\n      },\n\n      status: {\n        finished: false,\n        duration: 0,\n        piecesDone: 0,\n        piecesTotal: 0,\n      } as PuzzleStatus,\n\n      overlay: '',\n\n      connectionState: 0,\n      cuttingPuzzle: true,\n\n      eventBus: mitt(),\n      g: {\n        player: defaultPlayerSettings(),\n        game: null as Game|null,\n        previewImageUrl: '',\n        connect: () => {},\n        disconnect: () => {},\n        unload: () => {},\n      },\n    }\n  },\n  async mounted() {\n    if (!this.$route.params.id) {\n      return\n    }\n\n    this.eventBus.on('puzzleCut', () => {\n      this.cuttingPuzzle = false\n    })\n    this.eventBus.on('players', (players: any) => {\n      this.players = players\n    })\n    this.eventBus.on('status', (status: any) => {\n      this.status = status\n    })\n    this.eventBus.on('togglePreview', () => {\n      this.toggle('preview', false)\n    })\n    this.eventBus.on('connectionState', (v: any) => {\n      this.connectionState = v\n    })\n    this.eventBus.on('toggleSoundsEnabled', () => {\n      this.g.player.soundsEnabled = !this.g.player.soundsEnabled\n    })\n    this.eventBus.on('togglePlayerNames', () => {\n      this.g.player.showPlayerNames = !this.g.player.showPlayerNames\n    })\n\n    this.$watch(() => this.g.player.background, (value: string) => {\n      this.eventBus.emit('onBgChange', value)\n    })\n    this.$watch(() => this.g.player.color, (value: string) => {\n      this.eventBus.emit('onColorChange', value)\n    })\n    this.$watch(() => this.g.player.name, (value: string) => {\n      this.eventBus.emit('onNameChange', value)\n    })\n    this.$watch(() => this.g.player.soundsEnabled, (value: boolean) => {\n      this.eventBus.emit('onSoundsEnabledChange', value)\n    })\n    this.$watch(() => this.g.player.otherPlayerClickSoundEnabled, (value: boolean) => {\n      this.eventBus.emit('onOtherPlayerClickSoundEnabledChange', value)\n    })\n    this.$watch(() => this.g.player.soundsVolume, (value: number) => {\n      this.eventBus.emit('onSoundsVolumeChange', value)\n    })\n    this.$watch(() => this.g.player.showPlayerNames, (value: boolean) => {\n      this.eventBus.emit('onShowPlayerNamesChange', value)\n    })\n\n    const canvasEl = this.$refs.canvas as HTMLCanvasElement\n    canvasEl.width = window.innerWidth\n    canvasEl.height = window.innerHeight\n    window.addEventListener('resize', this.onResize)\n\n    this.g = await main(\n      `${this.$route.params.id}`,\n      // @ts-ignore\n      xhr.clientId(),\n      // @ts-ignore\n      this.$config.WS_ADDRESS,\n      MODE_PLAY,\n      canvasEl,\n      this.eventBus,\n    )\n  },\n  unmounted () {\n    this.g.unload()\n    this.g.disconnect()\n    window.removeEventListener('resize', this.onResize)\n  },\n  methods: {\n    onResize(): void {\n      const canvasEl = this.$refs.canvas as HTMLCanvasElement\n      canvasEl.width = window.innerWidth\n      canvasEl.height = window.innerHeight\n      this.eventBus.emit('requireRerender')\n    },\n    reconnect(): void {\n      this.g.connect()\n    },\n    toggle(overlay: string, affectsHotkeys: boolean): void {\n      if (this.overlay === '') {\n        this.overlay = overlay\n        if (affectsHotkeys) {\n          this.eventBus.emit('setHotkeys', false)\n        }\n      } else {\n        // could check if overlay was the provided one\n        this.overlay = ''\n        if (affectsHotkeys) {\n          this.eventBus.emit('setHotkeys', true)\n        }\n      }\n    },\n  },\n})\n</script>\n","<template>\n  <div id=\"replay\">\n    <settings-overlay\n      v-show=\"overlay === 'settings'\"\n      @close=\"toggle('settings', true)\"\n      @bgclick=\"toggle('settings', true)\"\n      v-model=\"g.player\" />\n    <preview-overlay\n      v-show=\"overlay === 'preview'\"\n      @close=\"toggle('preview', false)\"\n      @click=\"toggle('preview', false)\"\n      :img=\"g.previewImageUrl\" />\n    <info-overlay\n      v-if=\"g.game\"\n      v-show=\"overlay === 'info'\"\n      @close=\"toggle('info', true)\"\n      @bgclick=\"toggle('info', true)\"\n      :game=\"g.game\" />\n    <help-overlay\n      v-show=\"overlay === 'help'\"\n      @close=\"toggle('help', true)\"\n      @bgclick=\"toggle('help', true)\" />\n\n    <div class=\"overlay\" v-if=\"cuttingPuzzle\">\n      <div class=\"overlay-content\">\n        <div>⏳ Cutting puzzle, please wait... ⏳</div>\n      </div>\n    </div>\n\n    <div class=\"menu-left\">\n      <puzzle-status :status=\"status\" />\n      <div class=\"playback-control\">\n        <div>{{replayText}}</div>\n        <button class=\"btn\" @click=\"eventBus.emit('replayOnSpeedUp')\">⏫</button>\n        <button class=\"btn\" @click=\"eventBus.emit('replayOnSpeedDown')\">⏬</button>\n        <button class=\"btn\" @click=\"eventBus.emit('replayOnPauseToggle')\">⏸️</button>\n      </div>\n      <div class=\"switch-game-replay\" v-if=\"g.game\">\n        <router-link :to=\"{ name: 'game', params: { id: g.game.id } }\">🧩 To the game</router-link>\n      </div>\n    </div>\n\n    <div class=\"menu\">\n      <div class=\"tabs\">\n        <router-link class=\"opener\" :to=\"{name: 'index'}\" target=\"_blank\">🧩 Puzzles</router-link>\n        <div class=\"opener\" @click=\"toggle('preview', false)\">🖼️ Preview</div>\n        <div class=\"opener\" @click=\"toggle('settings', true)\">🛠️ Settings</div>\n        <div class=\"opener\" @click=\"toggle('info', true)\">ℹ️ Info</div>\n        <div class=\"opener\" @click=\"toggle('help', true)\">⌨️ Hotkeys</div>\n      </div>\n    </div>\n\n    <div class=\"menu-right\">\n      <scores :players=\"players\" />\n    </div>\n\n    <canvas ref=\"canvas\"></canvas>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport mitt from 'mitt'\n\nimport Scores from './../components/Scores.vue'\nimport PuzzleStatusComponent from './../components/PuzzleStatus.vue'\nimport SettingsOverlay from './../components/SettingsOverlay.vue'\nimport PreviewOverlay from './../components/PreviewOverlay.vue'\nimport InfoOverlay from './../components/InfoOverlay.vue'\nimport HelpOverlay from './../components/HelpOverlay.vue'\n\nimport { main, MODE_REPLAY } from './../game'\nimport { Game, Player, PuzzleStatus } from '../../common/Types'\nimport xhr from '../xhr'\nimport { defaultPlayerSettings } from '../settings'\n\nexport default defineComponent({\n  name: 'replay',\n  components: {\n    PuzzleStatusComponent,\n    Scores,\n    SettingsOverlay,\n    PreviewOverlay,\n    InfoOverlay,\n    HelpOverlay,\n  },\n  data() {\n    return {\n      players: {\n        active: [] as Player[],\n        idle: [] as Player[],\n      },\n\n      status: {\n        finished: false,\n        duration: 0,\n        piecesDone: 0,\n        piecesTotal: 0,\n      } as PuzzleStatus,\n\n      overlay: '',\n\n      connectionState: 0,\n      cuttingPuzzle: true,\n\n      eventBus: mitt(),\n      g: {\n        player: defaultPlayerSettings(),\n        game: null as Game|null,\n        previewImageUrl: '',\n        connect: () => {},\n        disconnect: () => {},\n        unload: () => {},\n      },\n\n      replay: {\n        speed: 1,\n        paused: false,\n      },\n    }\n  },\n  async mounted() {\n    if (!this.$route.params.id) {\n      return\n    }\n\n    this.eventBus.on('puzzleCut', () => {\n      this.cuttingPuzzle = false\n    })\n    this.eventBus.on('players', (players: any) => {\n      this.players = players\n    })\n    this.eventBus.on('status', (status: any) => {\n      this.status = status\n    })\n    this.eventBus.on('togglePreview', () => {\n      this.toggle('preview', false)\n    })\n    this.eventBus.on('connectionState', (v: any) => {\n      this.connectionState = v\n    })\n    this.eventBus.on('toggleSoundsEnabled', () => {\n      this.g.player.soundsEnabled = !this.g.player.soundsEnabled\n    })\n    this.eventBus.on('togglePlayerNames', () => {\n      this.g.player.showPlayerNames = !this.g.player.showPlayerNames\n    })\n    this.eventBus.on('replaySpeed', (v: any) => {\n      this.replay.speed = v\n    })\n    this.eventBus.on('replayPaused', (v: any) => {\n      this.replay.paused = v\n    })\n\n    this.$watch(() => this.g.player.background, (value: string) => {\n      this.eventBus.emit('onBgChange', value)\n    })\n    this.$watch(() => this.g.player.color, (value: string) => {\n      this.eventBus.emit('onColorChange', value)\n    })\n    this.$watch(() => this.g.player.name, (value: string) => {\n      this.eventBus.emit('onNameChange', value)\n    })\n    this.$watch(() => this.g.player.soundsEnabled, (value: boolean) => {\n      this.eventBus.emit('onSoundsEnabledChange', value)\n    })\n    this.$watch(() => this.g.player.otherPlayerClickSoundEnabled, (value: boolean) => {\n      this.eventBus.emit('onOtherPlayerClickSoundEnabledChange', value)\n    })\n    this.$watch(() => this.g.player.soundsVolume, (value: number) => {\n      this.eventBus.emit('onSoundsVolumeChange', value)\n    })\n    this.$watch(() => this.g.player.showPlayerNames, (value: boolean) => {\n      this.eventBus.emit('onShowPlayerNamesChange', value)\n    })\n\n    const canvasEl = this.$refs.canvas as HTMLCanvasElement\n    canvasEl.width = window.innerWidth\n    canvasEl.height = window.innerHeight\n    window.addEventListener('resize', this.onResize)\n\n    this.g = await main(\n      `${this.$route.params.id}`,\n      // @ts-ignore\n      xhr.clientId(),\n      // @ts-ignore\n      this.$config.WS_ADDRESS,\n      MODE_REPLAY,\n      canvasEl,\n      this.eventBus,\n    )\n  },\n  unmounted () {\n    this.g.unload()\n    this.g.disconnect()\n    window.removeEventListener('resize', this.onResize)\n  },\n  methods: {\n    onResize(): void {\n      const canvasEl = this.$refs.canvas as HTMLCanvasElement\n      canvasEl.width = window.innerWidth\n      canvasEl.height = window.innerHeight\n      this.eventBus.emit('requireRerender')\n    },\n    toggle(overlay: string, affectsHotkeys: boolean): void {\n      if (this.overlay === '') {\n        this.overlay = overlay\n        if (affectsHotkeys) {\n          this.eventBus.emit('setHotkeys', false)\n        }\n      } else {\n        // could check if overlay was the provided one\n        this.overlay = ''\n        if (affectsHotkeys) {\n          this.eventBus.emit('setHotkeys', true)\n        }\n      }\n    },\n  },\n  computed: {\n    replayText (): string {\n      return 'Replay-Speed: ' +\n        (this.replay.speed + 'x') +\n        (this.replay.paused ? ' Paused' : '')\n    },\n  },\n})\n</script>\n","import xhr from \"./xhr\";\n\nlet me: any = null;\n\nasync function init() {\n  const meRes = await xhr.get(`/api/me`, {})\n  me = await meRes.json()\n}\n\nexport default {\n  getMe: () => {\n    return me\n  },\n  init,\n}\n","<template>\n  <div\n    class=\"imageteaser\"\n    :style=\"style\"\n    @click=\"onClick\">\n    <div class=\"btn edit\" v-if=\"canEdit\" @click.stop=\"onEditClick\">✏️</div>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\nimport user from '../user'\n\nexport default defineComponent({\n  props: {\n    image: {\n      type: Object,\n      required: true,\n    },\n  },\n  data: () => {\n    return {\n      me: user.getMe(),\n    }\n  },\n  computed: {\n    style(): object {\n      const url = this.image.url.replace('uploads/', 'uploads/r/') + '-150x100.webp'\n      return {\n        'backgroundImage': `url(\"${url}\")`,\n      }\n    },\n    canEdit(): boolean {\n      if (!this.me.id) {\n        return false\n      }\n      return this.me.id === this.image.uploaderUserId\n    },\n  },\n  emits: {\n    click: null,\n    editClick: null,\n  },\n  methods: {\n    onClick() {\n      this.$emit('click')\n    },\n    onEditClick() {\n      this.$emit('editClick')\n    },\n  },\n})\n</script>\n<style type=\"css\">\n.imageteaser { position: relative; }\n.imageteaser .edit { display: none; position: absolute; }\n.imageteaser:hover .edit { display: inline-block; }\n</style>\n","<template>\n  <div class=\"overlay\">\n    <div\n      class=\"overlay-background\"\n      @click=\"$emit('bgclick')\"\n      :class=\"classes.map(c => 'overlay-background-' + c)\">\n    </div>\n    <div\n      class=\"overlay-content\"\n      :class=\"classes.map(c => 'overlay-content-' + c)\">\n      <slot />\n    </div>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent } from 'vue'\n\nexport default defineComponent({\n  props: {\n    animate: {\n      type: Boolean,\n      default: true,\n    },\n  },\n  emits: {\n    bgclick: null,\n    close: null,\n  },\n  data: () => ({\n    classes: [],\n  }),\n  methods: {\n    onKeyUp(ev: KeyboardEvent) {\n      if (ev.code === 'Escape' && window.getComputedStyle(this.$el).display !== 'none') {\n        this.$emit('close')\n      }\n    },\n  },\n  mounted () {\n    window.addEventListener('keyup', this.onKeyUp)\n  },\n  unmounted () {\n    window.removeEventListener('keyup', this.onKeyUp)\n  },\n})\n</script>\n","<template>\n  <div :style=\"style\" :title=\"title\"></div>\n</template>\n<script>\nexport default {\n  props: {\n    src: String,\n    title: {\n      type: String,\n      default: '',\n    },\n    height: {\n      type: String,\n      default: '100%',\n    },\n    width: {\n      type: String,\n      default: '100%',\n    },\n  },\n  computed: {\n    style() {\n      return {\n        display: 'inline-block',\n        verticalAlign: 'text-bottom',\n        backgroundImage: `url('${this.src}')`,\n        backgroundRepeat: 'no-repeat',\n        backgroundSize: 'contain',\n        backgroundPosition: 'center',\n        width: this.width,\n        height: this.height,\n      }\n    },\n  },\n}\n</script>\n","<template>\n  <div>\n    <input\n      ref=\"input\"\n      class=\"input\"\n      type=\"text\"\n      v-model=\"input\"\n      placeholder=\"Plants, People\"\n      @change=\"onChange\"\n      @keydown.enter=\"add\"\n      @keyup=\"onKeyUp\"\n      />\n    <div v-if=\"autocomplete.values\" class=\"autocomplete\">\n      <ul>\n        <li\n          v-for=\"(val,idx) in autocomplete.values\"\n          :key=\"idx\"\n          :class=\"{active: idx===autocomplete.idx}\"\n          @click=\"addVal(val)\"\n          >{{val}}</li>\n      </ul>\n    </div>\n    <span v-for=\"(tag,idx) in values\" :key=\"idx\" class=\"bit is-clickable\" @click=\"rm(tag)\">{{tag}} ✖</span>\n  </div>\n</template>\n<script lang=\"ts\">\nimport { defineComponent, PropType } from 'vue'\n\nexport default defineComponent({\n  props: {\n    modelValue: {\n      type: Array as PropType<string[]>,\n      required: true,\n    },\n    autocompleteTags: {\n      type: Function,\n    },\n  },\n  emits: {\n    'update:modelValue': null,\n  },\n  data () {\n    return {\n      input: '',\n      values: [] as string[],\n      autocomplete: {\n        idx: -1,\n        values: [] as string[],\n      },\n    }\n  },\n  watch: {\n    modelValue(newValue, oldValue) {\n      this.values = newValue\n    },\n  },\n  created () {\n    this.values = this.modelValue\n  },\n  methods: {\n    onKeyUp (ev: KeyboardEvent) {\n      if (ev.code === 'ArrowDown' && this.autocomplete.values.length > 0) {\n        if (this.autocomplete.idx < this.autocomplete.values.length - 1) {\n          this.autocomplete.idx++\n        }\n        ev.stopPropagation()\n        return false\n      }\n      if (ev.code === 'ArrowUp' && this.autocomplete.values.length > 0) {\n        if (this.autocomplete.idx > 0) {\n          this.autocomplete.idx--\n        }\n        ev.stopPropagation()\n        return false\n      }\n      if (ev.key === ',') {\n        this.add()\n        ev.stopPropagation()\n        return false\n      }\n\n      if (this.input && this.autocompleteTags) {\n        this.autocomplete.values = this.autocompleteTags(\n          this.input,\n          this.values\n        )\n        this.autocomplete.idx = -1\n      } else {\n        this.autocomplete.values = []\n        this.autocomplete.idx = -1\n      }\n    },\n    addVal (value: string) {\n      const newval = value.replace(/,/g, '').trim()\n      if (!newval) {\n        return\n      }\n      if (!this.values.includes(newval)) {\n        this.values.push(newval)\n      }\n      this.input = ''\n      this.autocomplete.values = []\n      this.autocomplete.idx = -1\n      this.$emit('update:modelValue', this.values)\n      ;(this.$refs.input as HTMLInputElement).focus()\n    },\n    add () {\n      const value = this.autocomplete.idx >= 0\n        ? this.autocomplete.values[this.autocomplete.idx]\n        : this.input\n      this.addVal(value)\n    },\n    rm (val: string) {\n      this.values = this.values.filter(v => v !== val)\n      this.$emit('update:modelValue', this.values)\n    },\n  }\n})\n</script>\n<style scoped>\n.input {\n  margin-bottom: .5em;\n}\n.autocomplete {\n  position: relative;\n}\n.autocomplete ul { list-style: none;\n  padding: 0;\n  margin: 0;\n  position: absolute;\n  left: 0;\n  right: 0;\n  background: #333230;\n  top: -.5em;\n}\n.autocomplete ul li {\n  position: relative;\n  padding: .5em .5em .5em 1.5em;\n  cursor: pointer;\n}\n.autocomplete ul li.active {\n  color: var(--link-hover-color);\n  background: var(--input-bg-color);\n}\n.autocomplete ul li.active:before {\n  content: '▶';\n  display: block;\n  position: absolute;\n  left: .5em;\n}\n</style>\n","import * as VueRouter from 'vue-router'\nimport * as Vue from 'vue'\n\nimport App from './App.vue'\nimport Index from './views/Index.vue'\nimport NewGame from './views/NewGame.vue'\nimport Game from './views/Game.vue'\nimport Replay from './views/Replay.vue'\nimport xhr from './xhr'\n\nimport ConnectionOverlay from './components/ConnectionOverlay.vue'\nimport EditImageDialog from './components/EditImageDialog.vue'\nimport GameTeaser from './components/GameTeaser.vue'\nimport HelpOverlay from './components/HelpOverlay.vue'\nimport ImageLibrary from './components/ImageLibrary.vue'\nimport ImageTeaser from './components/ImageTeaser.vue'\nimport InfoOverlay from './components/InfoOverlay.vue'\nimport NewGameDialog from './components/NewGameDialog.vue'\nimport NewImageDialog from './components/NewImageDialog.vue'\nimport Overlay from './components/Overlay.vue'\nimport PreviewOverlay from './components/PreviewOverlay.vue'\nimport PuzzleStatus from './components/PuzzleStatus.vue'\nimport ResponsiveImage from './components/ResponsiveImage.vue'\nimport Scores from './components/Scores.vue'\nimport SettingsOverlay from './components/SettingsOverlay.vue'\nimport TagsInput from './components/TagsInput.vue'\nimport user from './user'\n\n(async () => {\n  xhr.init()\n\n  await user.init()\n\n  const confRes = await xhr.get(`/api/conf`, {})\n  const conf = await confRes.json()\n\n  const router = VueRouter.createRouter({\n    history: VueRouter.createWebHashHistory(),\n    routes: [\n      { name: 'index', path: '/', component: Index },\n      { name: 'new-game', path: '/new-game', component: NewGame },\n      { name: 'game', path: '/g/:id', component: Game },\n      { name: 'replay', path: '/replay/:id', component: Replay },\n    ],\n  })\n\n  router.beforeEach((to, from) => {\n    if (from.name) {\n      document.documentElement.classList.remove(`view-${String(from.name)}`)\n    }\n    document.documentElement.classList.add(`view-${String(to.name)}`)\n  })\n\n  const app = Vue.createApp(App)\n  app.config.globalProperties.$config = conf\n  app.use(router)\n  app.component('connection-overlay', ConnectionOverlay)\n  app.component('edit-image-dialog', EditImageDialog)\n  app.component('game-teaser', GameTeaser)\n  app.component('help-overlay', HelpOverlay)\n  app.component('image-library', ImageLibrary)\n  app.component('image-teaser', ImageTeaser)\n  app.component('info-overlay', InfoOverlay)\n  app.component('new-game-dialog', NewGameDialog)\n  app.component('new-image-dialog', NewImageDialog)\n  app.component('overlay', Overlay)\n  app.component('preview-overlay', PreviewOverlay)\n  app.component('puzzle-status', PuzzleStatus)\n  app.component('responsive-image', ResponsiveImage)\n  app.component('scores', Scores)\n  app.component('settings-overlay', SettingsOverlay)\n  app.component('tags-input', TagsInput)\n  app.mount('#app')\n})()\n"],"names":["_sfc_main","_openBlock","_createElementBlock","_createCommentVNode","get","_withCtx","_hoisted_1","_createTextVNode","_Fragment","_createBlock","_normalizeClass","_hoisted_3","_hoisted_4","_hoisted_6","_hoisted_7","_createElementVNode","_hoisted_8","_hoisted_9","_hoisted_10","_hoisted_16","_hoisted_5","_hoisted_12","_hoisted_11","_createVNode","_hoisted_2","_toDisplayString","log","_withDirectives","Game","fireworksController","PuzzleStatusComponent","_normalizeStyle","VueRouter.createRouter","VueRouter.createWebHashHistory","Vue.createApp"],"mappings":"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"}