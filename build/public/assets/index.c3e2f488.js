import{d as q,r as N,o as _,c as P,a as n,b as V,w as ee,e as te,f as k,g as ue,n as Ue,t as I,F as re,h as me,i as De,j as z,v as Ce,k as Se,l as rn,m as ae,p as po,q as an,s as un,u as ho,x as cn,y as dn,z as pn,A as hn,B as gn,C as mn}from"./vendor.0dfaad5f.js";const fn=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function o(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerpolicy&&(l.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?l.credentials="include":i.crossorigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function s(i){if(i.ep)return;i.ep=!0;const l=o(i);fetch(i.href,l)}};fn();var H=(e,t)=>{const o=e.__vccOpts||e;for(const[s,i]of t)o[s]=i;return o};const yn=q({name:"app",computed:{showNav(){return!["game","replay"].includes(String(this.$route.name))}}}),_n={id:"app"},En={key:0,class:"nav"},wn=k("Games overview"),vn=k("New game");function Pn(e,t,o,s,i,l){const r=N("router-link"),a=N("router-view");return _(),P("div",_n,[e.showNav?(_(),P("ul",En,[n("li",null,[V(r,{class:"btn",to:{name:"index"}},{default:ee(()=>[wn]),_:1})]),n("li",null,[V(r,{class:"btn",to:{name:"new-game"}},{default:ee(()=>[vn]),_:1})])])):te("",!0),V(a)])}var Tn=H(yn,[["render",Pn]]);class qe{constructor(t){this.rand_high=t||3735929054,this.rand_low=t^1231121986}random(t,o){this.rand_high=(this.rand_high<<16)+(this.rand_high>>16)+this.rand_low&4294967295,this.rand_low=this.rand_low+this.rand_high&4294967295;const s=(this.rand_high>>>0)/4294967295;return t+s*(o-t+1)|0}choice(t){return t[this.random(0,t.length-1)]}shuffle(t){const o=t.slice();for(let s=0;s<=o.length-2;s++){const i=this.random(s,o.length-1),l=o[s];o[s]=o[i],o[i]=l}return o}static serialize(t){return{rand_high:t.rand_high,rand_low:t.rand_low}}static unserialize(t){const o=new qe(0);return o.rand_high=t.rand_high,o.rand_low=t.rand_low,o}}const Cn=e=>{let t=e.toLowerCase();return t=t.replace(/[^a-z0-9]+/g,"-"),t=t.replace(/^-|-$/,""),t},gt=(e,t)=>{const o=`${e}`;return o.length>=t.length?o:t.substr(0,t.length-o.length)+o},mt=(...e)=>{const t=o=>(...s)=>{const i=new Date,l=gt(i.getHours(),"00"),r=gt(i.getMinutes(),"00"),a=gt(i.getSeconds(),"00");console[o](`${l}:${r}:${a}`,...e,...s)};return{log:t("log"),error:t("error"),info:t("info")}},Sn=()=>Date.now().toString(36)+Math.random().toString(36).substring(2);function bn(e){return e.top+1<<0|e.right+1<<2|e.bottom+1<<4|e.left+1<<6}function $n(e){return{top:(e>>0&3)-1,right:(e>>2&3)-1,bottom:(e>>4&3)-1,left:(e>>6&3)-1}}function An(e){return[e.idx,e.pos.x,e.pos.y,e.z,e.owner,e.group]}function On(e){return{idx:e[0],pos:{x:e[1],y:e[2]},z:e[3],owner:e[4],group:e[5]}}function Nn(e){return[e.id,e.x,e.y,e.d,e.name,e.color,e.bgcolor,e.points,e.ts]}function Un(e){return{id:e[0],x:e[1],y:e[2],d:e[3],name:e[4],color:e[5],bgcolor:e[6],points:e[7],ts:e[8]}}function kn(e){return[e.id,e.rng.type||"",qe.serialize(e.rng.obj),e.puzzle,e.players,e.scoreMode,e.shapeMode,e.snapMode,e.creatorUserId,e.hasReplay,e.gameVersion]}function Rn(e){return{id:e[0],rng:{type:e[1],obj:qe.unserialize(e[2])},puzzle:e[3],players:e[4],scoreMode:e[5],shapeMode:e[6],snapMode:e[7],creatorUserId:e[8],hasReplay:e[9],gameVersion:e[10]}}function Vn(e,t){const o=e.width/e.tileSize;return{x:t%o,y:Math.floor(t/o)}}const Ln=e=>{let t=0;for(let o=0;o<e.length;o++){const s=e.charCodeAt(o);t=(t<<5)-t+s,t|=0}return t};function zn(e){const t=[];for(const o in e){const s=[o,e[o]].map(encodeURIComponent);t.push(s.join("="))}return t.length===0?"":`?${t.join("&")}`}var L={hash:Ln,slug:Cn,uniqId:Sn,encodeShape:bn,decodeShape:$n,encodePiece:An,decodePiece:On,encodePlayer:Nn,decodePlayer:Un,encodeGame:kn,decodeGame:Rn,coordByPieceIdx:Vn,asQueryArgs:zn};const ie={SOUND_VOLUME:"sound_volume",SOUND_ENABLED:"sound_enabled",COLOR_BACKGROUND:"bg_color",PLAYER_COLOR:"player_color",PLAYER_NAME:"player_name",SHOW_PLAYER_NAMES:"show_player_names"},fe={SOUND_VOLUME:100,SOUND_ENABLED:!0,COLOR_BACKGROUND:"#222222",PLAYER_COLOR:"#ffffff",PLAYER_NAME:"anon",SHOW_PLAYER_NAMES:!0},ft=(e,t)=>{localStorage.setItem(e,t)},yt=e=>localStorage.getItem(e),Mn=(e,t)=>{ft(e,`${t}`)},Dn=(e,t)=>{const o=yt(e);if(o===null)return t;const s=parseInt(o,10);return isNaN(s)?t:s},Fn=(e,t)=>{ft(e,t?"1":"0")},In=(e,t)=>{const o=yt(e);return o===null?t:o==="1"},Gn=(e,t)=>{ft(e,t)},Bn=(e,t)=>{const o=yt(e);return o===null?t:o};var oe={setInt:Mn,getInt:Dn,setBool:Fn,getBool:In,setStr:Gn,getStr:Bn};let _t="",go="";const Et=async(e,t,o)=>new Promise((s,i)=>{const l=new window.XMLHttpRequest;l.open(e,t,!0),l.withCredentials=!0;for(const r in o.headers||{})l.setRequestHeader(r,o.headers[r]);l.setRequestHeader("Client-Id",_t),l.setRequestHeader("Client-Secret",go),l.addEventListener("load",function(r){s({status:this.status,text:this.responseText,json:async()=>JSON.parse(this.responseText)})}),l.addEventListener("error",function(r){i(new Error("xhr error"))}),l.upload&&o.onUploadProgress&&l.upload.addEventListener("progress",function(r){o.onUploadProgress&&o.onUploadProgress(r)}),l.send(o.body||null)}),mo=e=>{let t=oe.getStr(e,"");return t||(t=L.uniqId(),oe.setStr(e,t)),t};var ce={init:()=>{_t=mo("ID"),go=mo("SECRET")},request:Et,get:(e,t)=>Et("get",e,t),post:(e,t)=>Et("post",e,t),clientId:()=>_t};const fo=1,wt=fo*1e3,Qe=wt*60,Xe=Qe*60,vt=Xe*24,xn=()=>{const e=new Date;return Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds(),e.getUTCMilliseconds())},yo=e=>{const t=Math.floor(e/vt);e=e%vt;const o=Math.floor(e/Xe);e=e%Xe;const s=Math.floor(e/Qe);e=e%Qe;const i=Math.floor(e/wt);return`${t}d ${o}h ${s}m ${i}s`},Yn=(e,t)=>yo(t-e);var ye={MS:fo,SEC:wt,MIN:Qe,HOUR:Xe,DAY:vt,timestamp:xn,timeDiffStr:Yn,durationStr:yo};const Wn=q({props:{game:{type:Object,required:!0}},computed:{style(){return{"background-image":`url("${this.game.imageUrl.replace("uploads/","uploads/r/")+"-375x210.webp"}")`}}},methods:{time(e,t){const o=t?"\u{1F3C1}":"\u23F3",s=e,i=t||ye.timestamp(),l=ye.timeDiffStr(s,i);return`${o} ${l}`}}}),Zn={class:"game-info-text"},Hn=n("br",null,null,-1),jn=n("br",null,null,-1),Kn=n("br",null,null,-1),qn=k(" \u21AA\uFE0F Watch replay ");function Qn(e,t,o,s,i,l){const r=N("router-link");return _(),P("div",{class:"game-teaser",style:Ue(e.style)},[V(r,{class:"game-info",to:{name:"game",params:{id:e.game.id}}},{default:ee(()=>[n("span",Zn,[k(" \u{1F9E9} "+I(e.game.tilesFinished)+"/"+I(e.game.tilesTotal),1),Hn,k(" \u{1F465} "+I(e.game.players),1),jn,k(" "+I(e.time(e.game.started,e.game.finished)),1),Kn])]),_:1},8,["to"]),e.game.hasReplay?(_(),ue(r,{key:0,class:"game-replay",to:{name:"replay",params:{id:e.game.id}}},{default:ee(()=>[qn]),_:1},8,["to"])):te("",!0)],4)}var _o=H(Wn,[["render",Qn]]);const Xn=q({components:{GameTeaser:_o},data(){return{gamesRunning:[],gamesFinished:[]}},async created(){const t=await(await ce.get("/api/index-data",{})).json();this.gamesRunning=t.gamesRunning,this.gamesFinished=t.gamesFinished}}),Jn=n("h1",null,"Running games",-1),es=n("h1",null,"Finished games",-1);function ts(e,t,o,s,i,l){const r=N("game-teaser");return _(),P("div",null,[Jn,(_(!0),P(re,null,me(e.gamesRunning,(a,m)=>(_(),P("div",{class:"game-teaser-wrap",key:m},[V(r,{game:a},null,8,["game"])]))),128)),es,(_(!0),P(re,null,me(e.gamesFinished,(a,m)=>(_(),P("div",{class:"game-teaser-wrap",key:m},[V(r,{game:a},null,8,["game"])]))),128))])}var os=H(Xn,[["render",ts]]);const ns=q({props:{images:{type:Array,required:!0}},emits:{imageClicked:null,imageEditClicked:null},methods:{imageClicked(e){this.$emit("imageClicked",e)},imageEditClicked(e){this.$emit("imageEditClicked",e)}}});function ss(e,t,o,s,i,l){const r=N("image-teaser");return _(),P("div",null,[(_(!0),P(re,null,me(e.images,(a,m)=>(_(),ue(r,{image:a,onClick:w=>e.imageClicked(a),onEditClick:w=>e.imageEditClicked(a),key:m},null,8,["image","onClick","onEditClick"]))),128))])}var Eo=H(ns,[["render",ss]]);const is=q({props:{autocompleteTags:{type:Function},uploadProgress:{type:Number},uploading:{type:String}},emits:{setupGameClick:null,postToGalleryClick:null},data(){return{previewUrl:"",file:null,title:"",tags:[],droppable:!1}},computed:{uploadProgressPercent(){return this.uploadProgress?Math.round(this.uploadProgress*100):0},canPostToGallery(){return this.uploading?!1:!!(this.previewUrl&&this.file)},canSetupGameClick(){return this.uploading?!1:!!(this.previewUrl&&this.file)}},methods:{reset(){this.previewUrl="",this.file=null,this.title="",this.tags=[],this.droppable=!1},imageFromDragEvt(e){var s;const t=(s=e.dataTransfer)==null?void 0:s.items;if(!t||t.length===0)return null;const o=t[0];return o.type.startsWith("image/")?o:null},onFileSelect(e){const t=e.target;if(!t.files)return;const o=t.files[0];!o||this.preview(o)},preview(e){const t=new FileReader;t.readAsDataURL(e),t.onload=o=>{this.previewUrl=o.target.result,this.file=e}},postToGallery(){this.$emit("postToGalleryClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},setupGameClick(){this.$emit("setupGameClick",{file:this.file,title:this.title,tags:this.tags}),this.reset()},onDrop(e){this.droppable=!1;const t=this.imageFromDragEvt(e);if(!t)return!1;const o=t.getAsFile();return o&&(this.file=o,this.preview(o),e.preventDefault()),!1},onDragover(e){return this.imageFromDragEvt(e)&&(this.droppable=!0,e.preventDefault()),!1},onDragleave(){this.droppable=!1}}}),ls=n("div",{class:"drop-target"},null,-1),rs={key:0,class:"has-image"},as={key:1},us={class:"upload"},cs=n("span",{class:"btn"},"Upload File",-1),ds={class:"area-settings"},ps=n("td",null,[n("label",null,"Title")],-1),hs=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),gs=n("td",null,[n("label",null,"Tags")],-1),ms={class:"area-buttons"},fs=["disabled"],ys=k("\u{1F5BC}\uFE0F Post to gallery"),_s=["disabled"],Es=k("\u{1F9E9} Post to gallery "),ws=n("br",null,null,-1),vs=k(" + set up game");function Ps(e,t,o,s,i,l){const r=N("responsive-image"),a=N("tags-input"),m=N("overlay");return _(),ue(m,{class:"new-image-dialog"},{default:ee(()=>[n("div",{class:De(["area-image",{"has-image":!!e.previewUrl,"no-image":!e.previewUrl,droppable:e.droppable}]),onDrop:t[2]||(t[2]=(...w)=>e.onDrop&&e.onDrop(...w)),onDragover:t[3]||(t[3]=(...w)=>e.onDragover&&e.onDragover(...w)),onDragleave:t[4]||(t[4]=(...w)=>e.onDragleave&&e.onDragleave(...w))},[ls,e.previewUrl?(_(),P("div",rs,[n("span",{class:"remove btn",onClick:t[0]||(t[0]=w=>e.previewUrl="")},"X"),V(r,{src:e.previewUrl},null,8,["src"])])):(_(),P("div",as,[n("label",us,[n("input",{type:"file",style:{display:"none"},onChange:t[1]||(t[1]=(...w)=>e.onFileSelect&&e.onFileSelect(...w)),accept:"image/*"},null,32),cs])]))],34),n("div",ds,[n("table",null,[n("tr",null,[ps,n("td",null,[z(n("input",{type:"text","onUpdate:modelValue":t[5]||(t[5]=w=>e.title=w),placeholder:"Flower by @artist"},null,512),[[Ce,e.title]])])]),hs,n("tr",null,[gs,n("td",null,[V(a,{modelValue:e.tags,"onUpdate:modelValue":t[6]||(t[6]=w=>e.tags=w),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),n("div",ms,[n("button",{class:"btn",disabled:!e.canPostToGallery,onClick:t[7]||(t[7]=(...w)=>e.postToGallery&&e.postToGallery(...w))},[e.uploading==="postToGallery"?(_(),P(re,{key:0},[k("Uploading ("+I(e.uploadProgressPercent)+"%)",1)],64)):(_(),P(re,{key:1},[ys],64))],8,fs),n("button",{class:"btn",disabled:!e.canSetupGameClick,onClick:t[8]||(t[8]=(...w)=>e.setupGameClick&&e.setupGameClick(...w))},[e.uploading==="setupGame"?(_(),P(re,{key:0},[k("Uploading ("+I(e.uploadProgressPercent)+"%)",1)],64)):(_(),P(re,{key:1},[Es,ws,vs],64))],8,_s)])]),_:1})}var wo=H(is,[["render",Ps]]);const Ts=q({props:{image:{type:Object,required:!0},autocompleteTags:{type:Function}},emits:{saveClick:null},data(){return{title:"",tags:[]}},watch:{image(e,t){this.init(e)}},created(){this.init(this.image)},methods:{init(e){this.title=e.title,this.tags=e.tags.map(t=>t.title)},saveImage(){this.$emit("saveClick",{id:this.image.id,title:this.title,tags:this.tags})}}}),Cs={class:"area-image"},Ss={class:"has-image"},bs={class:"area-settings"},$s=n("td",null,[n("label",null,"Title")],-1),As=n("tr",null,[n("td",{colspan:"2"},[n("div",{class:"hint"},"Feel free to leave a credit to the artist/photographer in the title :)")])],-1),Os=n("td",null,[n("label",null,"Tags")],-1),Ns={class:"area-buttons"};function Us(e,t,o,s,i,l){const r=N("responsive-image"),a=N("tags-input"),m=N("overlay");return _(),ue(m,{class:"edit-image-dialog"},{default:ee(()=>[n("div",Cs,[n("div",Ss,[V(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])])]),n("div",bs,[n("table",null,[n("tr",null,[$s,n("td",null,[z(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=w=>e.title=w),placeholder:"Flower by @artist"},null,512),[[Ce,e.title]])])]),As,n("tr",null,[Os,n("td",null,[V(a,{modelValue:e.tags,"onUpdate:modelValue":t[1]||(t[1]=w=>e.tags=w),autocompleteTags:e.autocompleteTags},null,8,["modelValue","autocompleteTags"])])])])]),n("div",Ns,[n("button",{class:"btn",onClick:t[2]||(t[2]=(...w)=>e.saveImage&&e.saveImage(...w))},"\u{1F5BC}\uFE0F Save image")])]),_:1})}var vo=H(Ts,[["render",Us]]),Po;(function(e){e[e.Flat=0]="Flat",e[e.Out=1]="Out",e[e.In=-1]="In"})(Po||(Po={}));var Ee;(function(e){e[e.FINAL=0]="FINAL",e[e.ANY=1]="ANY"})(Ee||(Ee={}));var ke;(function(e){e[e.NORMAL=0]="NORMAL",e[e.ANY=1]="ANY",e[e.FLAT=2]="FLAT"})(ke||(ke={}));var be;(function(e){e[e.NORMAL=0]="NORMAL",e[e.REAL=1]="REAL"})(be||(be={}));const ks=q({props:{image:{type:Object,required:!0}},emits:{newGame:null},data(){return{tiles:1e3,scoreMode:Ee.ANY,shapeMode:ke.NORMAL,snapMode:be.NORMAL}},methods:{onNewGameClick(){this.$emit("newGame",{tiles:this.tilesInt,image:this.image,scoreMode:this.scoreModeInt,shapeMode:this.shapeModeInt,snapMode:this.snapModeInt})}},computed:{canStartNewGame(){return!(!this.tilesInt||!this.image||!this.image.url||![0,1].includes(this.scoreModeInt))},scoreModeInt(){return parseInt(`${this.scoreMode}`,10)},shapeModeInt(){return parseInt(`${this.shapeMode}`,10)},snapModeInt(){return parseInt(`${this.snapMode}`,10)},tilesInt(){return parseInt(`${this.tiles}`,10)}}}),Rs={class:"area-image"},Vs={class:"has-image"},Ls={key:0,class:"image-title"},zs={key:0,class:"image-title-title"},Ms={key:1,class:"image-title-dim"},Ds={class:"area-settings"},Fs=n("td",null,[n("label",null,"Pieces")],-1),Is=n("td",null,[n("label",null,"Scoring: ")],-1),Gs=k(" Any (Score when pieces are connected to each other or on final location)"),Bs=n("br",null,null,-1),xs=k(" Final (Score when pieces are put to their final location)"),Ys=n("td",null,[n("label",null,"Shapes: ")],-1),Ws=k(" Normal"),Zs=n("br",null,null,-1),Hs=k(" Any (Flat pieces can occur anywhere)"),js=n("br",null,null,-1),Ks=k(" Flat (All pieces flat on all sides)"),qs=n("td",null,[n("label",null,"Snapping: ")],-1),Qs=k(" Normal (Pieces snap to final destination and to each other)"),Xs=n("br",null,null,-1),Js=k(" Real (Pieces snap only to corners, already snapped pieces and to each other)"),ei={key:0},ti=n("td",null,[n("label",null,"Tags: ")],-1),oi={class:"area-buttons"},ni=["disabled"];function si(e,t,o,s,i,l){const r=N("responsive-image"),a=N("overlay");return _(),ue(a,{class:"new-game-dialog"},{default:ee(()=>[n("div",Rs,[n("div",Vs,[V(r,{src:e.image.url,title:e.image.title},null,8,["src","title"])]),e.image.title||e.image.width||e.image.height?(_(),P("div",Ls,[e.image.title?(_(),P("span",zs,'"'+I(e.image.title)+'"',1)):te("",!0),e.image.width||e.image.height?(_(),P("span",Ms,"("+I(e.image.width)+" \u2715 "+I(e.image.height)+")",1)):te("",!0)])):te("",!0)]),n("div",Ds,[n("table",null,[n("tr",null,[Fs,n("td",null,[z(n("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=m=>e.tiles=m)},null,512),[[Ce,e.tiles]])])]),n("tr",null,[Is,n("td",null,[n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[1]||(t[1]=m=>e.scoreMode=m),value:"1"},null,512),[[Se,e.scoreMode]]),Gs]),Bs,n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[2]||(t[2]=m=>e.scoreMode=m),value:"0"},null,512),[[Se,e.scoreMode]]),xs])])]),n("tr",null,[Ys,n("td",null,[n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[3]||(t[3]=m=>e.shapeMode=m),value:"0"},null,512),[[Se,e.shapeMode]]),Ws]),Zs,n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[4]||(t[4]=m=>e.shapeMode=m),value:"1"},null,512),[[Se,e.shapeMode]]),Hs]),js,n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[5]||(t[5]=m=>e.shapeMode=m),value:"2"},null,512),[[Se,e.shapeMode]]),Ks])])]),n("tr",null,[qs,n("td",null,[n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[6]||(t[6]=m=>e.snapMode=m),value:"0"},null,512),[[Se,e.snapMode]]),Qs]),Xs,n("label",null,[z(n("input",{type:"radio","onUpdate:modelValue":t[7]||(t[7]=m=>e.snapMode=m),value:"1"},null,512),[[Se,e.snapMode]]),Js])])]),e.image.tags.length?(_(),P("tr",ei,[ti,n("td",null,[(_(!0),P(re,null,me(e.image.tags,(m,w)=>(_(),P("span",{key:w,class:"bit"},I(m.title),1))),128))])])):te("",!0)])]),n("div",oi,[n("button",{class:"btn",disabled:!e.canStartNewGame,onClick:t[8]||(t[8]=(...m)=>e.onNewGameClick&&e.onNewGameClick(...m))}," \u{1F9E9} Generate Puzzle ",8,ni)])]),_:1})}var To=H(ks,[["render",si]]);const ii=q({components:{ImageLibrary:Eo,NewImageDialog:wo,EditImageDialog:vo,NewGameDialog:To},data(){return{filters:{sort:"date_desc",tags:[]},images:[],tags:[],image:{id:0,filename:"",file:"",url:"",title:"",tags:[],created:0},dialog:"",uploading:"",uploadProgress:0}},async created(){await this.loadImages()},computed:{relevantTags(){return this.tags.filter(e=>e.total>0)}},methods:{autocompleteTags(e,t){return this.tags.filter(o=>!t.includes(o.title)&&o.title.toLowerCase().startsWith(e.toLowerCase())).slice(0,10).map(o=>o.title)},toggleTag(e){this.filters.tags.includes(e.slug)?this.filters.tags=this.filters.tags.filter(t=>t!==e.slug):this.filters.tags.push(e.slug),this.filtersChanged()},async loadImages(){const t=await(await ce.get(`/api/newgame-data${L.asQueryArgs(this.filters)}`,{})).json();this.images=t.images,this.tags=t.tags},async filtersChanged(){await this.loadImages()},onImageClicked(e){this.image=e,this.dialog="new-game"},onImageEditClicked(e){this.image=e,this.dialog="edit-image"},async uploadImage(e){this.uploadProgress=0;const t=new FormData;t.append("file",e.file,e.file.name),t.append("title",e.title),t.append("tags",e.tags);const o=await ce.post("/api/upload",{body:t,onUploadProgress:s=>{this.uploadProgress=s.loaded/s.total}});return this.uploadProgress=1,await o.json()},async saveImage(e){return await(await ce.post("/api/save-image",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:e.id,title:e.title,tags:e.tags})})).json()},async onSaveImageClick(e){const t=await this.saveImage(e);t.ok?(this.dialog="",await this.loadImages()):alert(t.error)},async postToGalleryClick(e){this.uploading="postToGallery",await this.uploadImage(e),this.uploading="",this.dialog="",await this.loadImages()},async setupGameClick(e){this.uploading="setupGame";const t=await this.uploadImage(e);this.uploading="",this.loadImages(),this.image=t,this.dialog="new-game"},async onNewGame(e){const t=await ce.post("/api/newgame",{headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===200){const o=await t.json();this.$router.push({name:"game",params:{id:o.id}})}}}}),li={class:"upload-image-teaser"},ri=n("div",{class:"hint"},"(The image you upload will be added to the public gallery.)",-1),ai={key:0},ui=k(" Tags: "),ci=["onClick"],di=k(" Sort by: "),pi=n("option",{value:"date_desc"},"Newest first",-1),hi=n("option",{value:"date_asc"},"Oldest first",-1),gi=n("option",{value:"alpha_asc"},"A-Z",-1),mi=n("option",{value:"alpha_desc"},"Z-A",-1),fi=[pi,hi,gi,mi];function yi(e,t,o,s,i,l){const r=N("image-library"),a=N("new-image-dialog"),m=N("edit-image-dialog"),w=N("new-game-dialog");return _(),P("div",null,[n("div",li,[n("div",{class:"btn btn-big",onClick:t[0]||(t[0]=S=>e.dialog="new-image")},"Upload your image"),ri]),n("div",null,[e.tags.length>0?(_(),P("label",ai,[ui,(_(!0),P(re,null,me(e.relevantTags,(S,G)=>(_(),P("span",{class:De(["bit is-clickable",{on:e.filters.tags.includes(S.slug)}]),key:G,onClick:f=>e.toggleTag(S)},I(S.title)+" ("+I(S.total)+")",11,ci))),128))])):te("",!0),n("label",null,[di,z(n("select",{"onUpdate:modelValue":t[1]||(t[1]=S=>e.filters.sort=S),onChange:t[2]||(t[2]=(...S)=>e.filtersChanged&&e.filtersChanged(...S))},fi,544),[[rn,e.filters.sort]])])]),V(r,{images:e.images,onImageClicked:e.onImageClicked,onImageEditClicked:e.onImageEditClicked},null,8,["images","onImageClicked","onImageEditClicked"]),z(V(a,{autocompleteTags:e.autocompleteTags,onBgclick:t[3]||(t[3]=S=>e.dialog=""),uploadProgress:e.uploadProgress,uploading:e.uploading,onPostToGalleryClick:e.postToGalleryClick,onSetupGameClick:e.setupGameClick},null,8,["autocompleteTags","uploadProgress","uploading","onPostToGalleryClick","onSetupGameClick"]),[[ae,e.dialog==="new-image"]]),z(V(m,{autocompleteTags:e.autocompleteTags,onBgclick:t[4]||(t[4]=S=>e.dialog=""),onSaveClick:e.onSaveImageClick,image:e.image},null,8,["autocompleteTags","onSaveClick","image"]),[[ae,e.dialog==="edit-image"]]),z(V(w,{onBgclick:t[5]||(t[5]=S=>e.dialog=""),onNewGame:e.onNewGame,image:e.image},null,8,["onNewGame","image"]),[[ae,e.image&&e.dialog==="new-game"]])])}var _i=H(ii,[["render",yi]]);const Ei=q({props:{players:{type:Object,required:!0}},computed:{actives(){return this.players.active.sort((e,t)=>t.points-e.points),this.players.active},idles(){return this.players.idle.sort((e,t)=>t.points-e.points),this.players.idle}}}),wi={class:"scores"},vi=n("div",null,"Scores",-1),Pi=n("td",null,"\u26A1",-1),Ti=n("td",null,"\u{1F4A4}",-1);function Ci(e,t,o,s,i,l){return _(),P("div",wi,[vi,n("table",null,[(_(!0),P(re,null,me(e.actives,(r,a)=>(_(),P("tr",{key:a,style:Ue({color:r.color})},[Pi,n("td",null,I(r.name),1),n("td",null,I(r.points),1)],4))),128)),(_(!0),P(re,null,me(e.idles,(r,a)=>(_(),P("tr",{key:a,style:Ue({color:r.color})},[Ti,n("td",null,I(r.name),1),n("td",null,I(r.points),1)],4))),128))])])}var Pt=H(Ei,[["render",Ci]]);const Si=q({props:{status:{type:Object,required:!0}},computed:{icon(){return this.status.finished?"\u{1F3C1}":"\u23F3"},durationStr(){return ye.durationStr(this.status.duration)}}}),bi={class:"puzzle-status"};function $i(e,t,o,s,i,l){return _(),P("div",bi,[n("div",null," \u{1F9E9} "+I(e.status.piecesDone)+"/"+I(e.status.piecesTotal),1),n("div",null,I(e.icon)+" "+I(e.durationStr),1)])}var Tt=H(Si,[["render",$i]]);const Ai=q({emits:{"update:modelValue":null},props:{modelValue:{type:Object,required:!0}},data:()=>({background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0,watches:[]}),methods:{updateVolume(e){const t=parseInt(e.target.value);this.soundsVolume=t},decreaseVolume(){this.soundsVolume=Math.max(0,this.soundsVolume-5)},increaseVolume(){this.soundsVolume=Math.min(100,this.soundsVolume+5)},apply(e){this.disableWatches(),this.background=`${e.background}`,this.color=`${e.color}`,this.name=`${e.name}`,this.soundsEnabled=!!e.soundsEnabled,this.soundsVolume=parseInt(`${e.soundsVolume}`,10),this.showPlayerNames=!!e.showPlayerNames,this.enableWatches()},emitChanges(){this.$emit("update:modelValue",{background:this.background,color:this.color,name:this.name,soundsEnabled:this.soundsEnabled,soundsVolume:this.soundsVolume,showPlayerNames:this.showPlayerNames})},enableWatches(){this.watches.push(this.$watch("background",this.emitChanges)),this.watches.push(this.$watch("color",this.emitChanges)),this.watches.push(this.$watch("name",this.emitChanges)),this.watches.push(this.$watch("soundsEnabled",this.emitChanges)),this.watches.push(this.$watch("soundsVolume",this.emitChanges)),this.watches.push(this.$watch("showPlayerNames",this.emitChanges))},disableWatches(){const e=this.watches;this.watches=[],e.forEach(t=>t())}},created(){this.apply(this.modelValue),this.$watch("modelValue",e=>{this.apply(e)})}}),Re=e=>(an("data-v-39db9680"),e=e(),un(),e),Oi={class:"settings"},Ni=Re(()=>n("td",null,[n("label",null,"Background: ")],-1)),Ui=Re(()=>n("td",null,[n("label",null,"Color: ")],-1)),ki=Re(()=>n("td",null,[n("label",null,"Name: ")],-1)),Ri=Re(()=>n("td",null,[n("label",null,"Sounds: ")],-1)),Vi=Re(()=>n("td",null,[n("label",null,"Sounds Volume: ")],-1)),Li={class:"sound-volume"},zi=["value"],Mi=Re(()=>n("td",null,[n("label",null,"Show player names: ")],-1));function Di(e,t,o,s,i,l){const r=N("overlay");return _(),ue(r,{class:"transparent"},{default:ee(()=>[n("table",Oi,[n("tr",null,[Ni,n("td",null,[z(n("input",{type:"color","onUpdate:modelValue":t[0]||(t[0]=a=>e.background=a)},null,512),[[Ce,e.background]])])]),n("tr",null,[Ui,n("td",null,[z(n("input",{type:"color","onUpdate:modelValue":t[1]||(t[1]=a=>e.color=a)},null,512),[[Ce,e.color]])])]),n("tr",null,[ki,n("td",null,[z(n("input",{type:"text",maxLength:"16","onUpdate:modelValue":t[2]||(t[2]=a=>e.name=a)},null,512),[[Ce,e.name]])])]),n("tr",null,[Ri,n("td",null,[z(n("input",{type:"checkbox","onUpdate:modelValue":t[3]||(t[3]=a=>e.soundsEnabled=a)},null,512),[[po,e.soundsEnabled]])])]),n("tr",null,[Vi,n("td",Li,[n("span",{onClick:t[4]||(t[4]=(...a)=>e.decreaseVolume&&e.decreaseVolume(...a))},"\u{1F509}"),n("input",{type:"range",min:"0",max:"100",value:e.soundsVolume,onChange:t[5]||(t[5]=(...a)=>e.updateVolume&&e.updateVolume(...a))},null,40,zi),n("span",{onClick:t[6]||(t[6]=(...a)=>e.increaseVolume&&e.increaseVolume(...a))},"\u{1F50A}")])]),n("tr",null,[Mi,n("td",null,[z(n("input",{type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=a=>e.showPlayerNames=a)},null,512),[[po,e.showPlayerNames]])])])])]),_:1})}var Ct=H(Ai,[["render",Di],["__scopeId","data-v-39db9680"]]);const Fi=q({props:{img:String},computed:{previewStyle(){return{backgroundImage:`url('${this.img}')`}}}}),Ii={class:"preview"};function Gi(e,t,o,s,i,l){const r=N("overlay");return _(),ue(r,{class:"preview-overlay",animate:!1},{default:ee(()=>[n("div",Ii,[n("div",{class:"img",style:Ue(e.previewStyle)},null,4)])]),_:1})}var St=H(Fi,[["render",Gi]]);const Bi=q({props:{game:{type:Object,required:!0}},computed:{scoreMode(){switch(this.game.scoreMode){case Ee.ANY:return["Any","Score when pieces are connected to each other or on final location"];case Ee.FINAL:default:return["Final","Score when pieces are put to their final location"]}},shapeMode(){switch(this.game.shapeMode){case ke.FLAT:return["Flat","All pieces flat on all sides"];case ke.ANY:return["Any","Flat pieces can occur anywhere"];case ke.NORMAL:default:return["Normal",""]}},snapMode(){switch(this.game.snapMode){case be.REAL:return["Real","Pieces snap only to corners, already snapped pieces and to each other"];case be.NORMAL:default:return["Normal","Pieces snap to final destination and to each other"]}}}}),xi={class:"help"},Yi=n("tr",null,[n("td",{colspan:"2"},"Info about this puzzle")],-1),Wi=n("td",null,"Image Title: ",-1),Zi=n("td",null,"Scoring: ",-1),Hi=["title"],ji=n("td",null,"Shapes: ",-1),Ki=["title"],qi=n("td",null,"Snapping: ",-1),Qi=["title"];function Xi(e,t,o,s,i,l){const r=N("overlay");return _(),ue(r,{class:"transparent"},{default:ee(()=>[n("table",xi,[Yi,n("tr",null,[Wi,n("td",null,I(e.game.puzzle.info.image.title),1)]),n("tr",null,[Zi,n("td",null,[n("span",{title:e.snapMode[1]},I(e.scoreMode[0]),9,Hi)])]),n("tr",null,[ji,n("td",null,[n("span",{title:e.snapMode[1]},I(e.shapeMode[0]),9,Ki)])]),n("tr",null,[qi,n("td",null,[n("span",{title:e.snapMode[1]},I(e.snapMode[0]),9,Qi)])])])]),_:1})}var bt=H(Bi,[["render",Xi]]);const Ji=2,el=1,tl=4,ol=2,nl=3,sl=1,il=2,ll=4,rl=3,al=1,ul=2,cl=3,dl=4,pl=5,hl=6,gl=7,ml=8,fl=9,yl=10,_l=11,El=12,wl=13,vl=14,Pl=15,Tl=16,Cl=17,Sl=18,bl=19,$l=20,Al=21,Ol=1,Nl=2,Ul=3;var d={EV_SERVER_EVENT:el,EV_SERVER_INIT:tl,EV_CLIENT_EVENT:ol,EV_CLIENT_INIT:nl,GAME_VERSION:Ji,LOG_HEADER:sl,LOG_ADD_PLAYER:il,LOG_UPDATE_PLAYER:ll,LOG_HANDLE_INPUT:rl,INPUT_EV_MOVE:fl,INPUT_EV_MOUSE_DOWN:al,INPUT_EV_MOUSE_UP:ul,INPUT_EV_MOUSE_MOVE:cl,INPUT_EV_ZOOM_IN:dl,INPUT_EV_ZOOM_OUT:pl,INPUT_EV_BG_COLOR:hl,INPUT_EV_PLAYER_COLOR:gl,INPUT_EV_PLAYER_NAME:ml,INPUT_EV_TOGGLE_PREVIEW:yl,INPUT_EV_TOGGLE_SOUNDS:_l,INPUT_EV_REPLAY_TOGGLE_PAUSE:El,INPUT_EV_REPLAY_SPEED_UP:wl,INPUT_EV_REPLAY_SPEED_DOWN:vl,INPUT_EV_TOGGLE_PLAYER_NAMES:Pl,INPUT_EV_CENTER_FIT_PUZZLE:Tl,INPUT_EV_TOGGLE_FIXED_PIECES:Cl,INPUT_EV_TOGGLE_LOOSE_PIECES:Sl,INPUT_EV_STORE_POS:bl,INPUT_EV_RESTORE_POS:$l,INPUT_EV_CONNECTION_CLOSE:Al,CHANGE_DATA:Ol,CHANGE_TILE:Nl,CHANGE_PLAYER:Ul};const kl=mt("Communication.js"),Rl=1001,$t=4e3,Co=0,At=1,Ot=2,So=3,bo=4;let pe,Nt=[],Ut=e=>{Nt.push(e)},kt=[],Rt=e=>{kt.push(e)};function Vl(e){Ut=e;for(const t of Nt)Ut(t);Nt=[]}function Ll(e){Rt=e;for(const t of kt)Rt(t);kt=[]}let Vt=Co;const Fe=e=>{Vt!==e&&(Vt=e,Rt(e))};function $o(e){if(Vt===Ot)try{pe.send(JSON.stringify(e))}catch{kl.info("unable to send message.. maybe because ws is invalid?")}}let Ve,Le,Lt=0;function Ao(e=2e4){pe.readyState==pe.OPEN&&pe.send(""),Lt=setTimeout(Ao,e)}function Oo(){Lt&&clearTimeout(Lt)}function zl(e,t,o){return Ve=0,Le={},Fe(So),new Promise(s=>{pe=new WebSocket(e,o+"|"+t),pe.onopen=()=>{Fe(Ot),$o([d.EV_CLIENT_INIT]),Ao()},pe.onmessage=i=>{const l=JSON.parse(i.data),r=l[0];if(r===d.EV_SERVER_INIT){const a=l[1];s(a)}else if(r===d.EV_SERVER_EVENT){const a=l[1],m=l[2];if(a===o&&Le[m]){delete Le[m];return}Ut(l)}else throw`[ 2021-05-09 invalid connect msgType ${r} ]`},pe.onerror=()=>{throw Oo(),Fe(At),"[ 2021-05-15 onerror ]"},pe.onclose=i=>{Oo(),i.code===$t||i.code===Rl?Fe(bo):Fe(At)}})}async function Ml(e,t){const o={gameId:e,offset:t};return await(await ce.get(`/api/replay-data${L.asQueryArgs(o)}`,{})).json()}function Dl(){pe&&pe.close($t),Ve=0,Le={}}function Fl(e){Ve++,Le[Ve]=e,$o([d.EV_CLIENT_EVENT,Ve,Le[Ve]])}var we={connect:zl,requestReplayData:Ml,disconnect:Dl,sendClientEvent:Fl,onServerChange:Vl,onConnectionStateChange:Ll,CODE_CUSTOM_DISCONNECT:$t,CONN_STATE_NOT_CONNECTED:Co,CONN_STATE_DISCONNECTED:At,CONN_STATE_CLOSED:bo,CONN_STATE_CONNECTED:Ot,CONN_STATE_CONNECTING:So};const Il=q({emits:{reconnect:null},props:{connectionState:Number},computed:{lostConnection(){return this.connectionState===we.CONN_STATE_DISCONNECTED},connecting(){return this.connectionState===we.CONN_STATE_CONNECTING},show(){return!!(this.lostConnection||this.connecting)}}}),Gl={key:0},Bl={key:2};function xl(e,t,o,s,i,l){const r=N("overlay");return z((_(),ue(r,{class:"connection-lost"},{default:ee(()=>[e.lostConnection?(_(),P("div",Gl,"\u2049\uFE0F LOST CONNECTION \u2049\uFE0F")):te("",!0),e.lostConnection?(_(),P("span",{key:1,class:"btn",onClick:t[0]||(t[0]=a=>e.$emit("reconnect"))},"Reconnect")):te("",!0),e.connecting?(_(),P("div",Bl,"Connecting...")):te("",!0)]),_:1},512)),[[ae,e.show]])}var No=H(Il,[["render",xl]]);const Yl=q({}),Wl=n("table",{class:"help"},[n("tr",null,[n("td",null,"\u2B06\uFE0F Move up:"),n("td",null,[n("div",null,[n("kbd",null,"W"),k("/"),n("kbd",null,"\u2191"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u2B07\uFE0F Move down:"),n("td",null,[n("div",null,[n("kbd",null,"S"),k("/"),n("kbd",null,"\u2193"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u2B05\uFE0F Move left:"),n("td",null,[n("div",null,[n("kbd",null,"A"),k("/"),n("kbd",null,"\u2190"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td",null,"\u27A1\uFE0F Move right:"),n("td",null,[n("div",null,[n("kbd",null,"D"),k("/"),n("kbd",null,"\u2192"),k("/\u{1F5B1}\uFE0F")])])]),n("tr",null,[n("td"),n("td",null,[n("div",null,[k("Move faster by holding "),n("kbd",null,"Shift")])])]),n("tr",null,[n("td",null,"\u{1F50D}+ Zoom in:"),n("td",null,[n("div",null,[n("kbd",null,"E"),k("/\u{1F5B1}\uFE0F-Wheel")])])]),n("tr",null,[n("td",null,"\u{1F50D}- Zoom out:"),n("td",null,[n("div",null,[n("kbd",null,"Q"),k("/\u{1F5B1}\uFE0F-Wheel")])])]),n("tr",null,[n("td",null,"\u{1F5BC}\uFE0F Toggle preview:"),n("td",null,[n("div",null,[n("kbd",null,"Space")])])]),n("tr",null,[n("td",null,"\u{1F3AF} Center puzzle in screen:"),n("td",null,[n("div",null,[n("kbd",null,"C")])])]),n("tr",null,[n("td",null,"\u{1F9E9}\u2714\uFE0F Toggle fixed pieces:"),n("td",null,[n("div",null,[n("kbd",null,"F")])])]),n("tr",null,[n("td",null,"\u{1F9E9}\u2753 Toggle loose pieces:"),n("td",null,[n("div",null,[n("kbd",null,"G")])])]),n("tr",null,[n("td",null,"\u{1F464} Toggle player names:"),n("td",null,[n("div",null,[n("kbd",null,"N")])])]),n("tr",null,[n("td",null,"\u{1F509} Toggle sounds:"),n("td",null,[n("div",null,[n("kbd",null,"M")])])]),n("tr",null,[n("td",null,"\u23EB Speed up (replay):"),n("td",null,[n("div",null,[n("kbd",null,"I")])])]),n("tr",null,[n("td",null,"\u23EC Speed down (replay):"),n("td",null,[n("div",null,[n("kbd",null,"O")])])]),n("tr",null,[n("td",null,"\u23F8\uFE0F Pause (replay):"),n("td",null,[n("div",null,[n("kbd",null,"P")])])])],-1);function Zl(e,t,o,s,i,l){const r=N("overlay");return _(),ue(r,{class:"transparent"},{default:ee(()=>[Wl]),_:1})}var zt=H(Yl,[["render",Zl]]),Hl="/assets/click.bb97cb07.mp3",jl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Hl}),Kl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAW0lEQVQ4je1RywrAIAxLxP//5exixRWlVgZelpOKeTQFfnDypgy3eLIkSLLL8mxGPoHsU2hPAgDHBLvRX6hZZw/fwT0BtlLSONqCbWAmEIqMZOCDDlaDR3N03gOyDCn+y4DWmAAAAABJRU5ErkJggg==",ql=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Kl}),Ql="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4jWNgGAU0Af+hmBCbgYGBgYERhwHEAEYGBgYGJtIdiApYyLAZBVDsAqoagC1ACQJyY4ERg0GCISh6KA4DigEAou8LC+LnIJoAAAAASUVORK5CYII=",Xl=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Ql}),Jl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAcUlEQVQ4ja1TQQ7AIAgD///n7jCozA2Hbk00jbG1KIrcARszTugoBs49qioZj7r2kKACptkyAOCJsJuA+GzglwHjvMSSWFVaENWVASxh5eRLiq5fN/ASjI89VcP2K3hHpq1cEXNaMfnrL3TDZP2tDuoOA6MzCCXWr38AAAAASUVORK5CYII=",er=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Jl}),tr="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAU0lEQVQ4jWNgoAH4D8X42HDARKlt5BoAd82AuQAOGLGIYQQUPv0wF5CiCQUge4EsQ5C9QI4BjMguwBYeBAElscCIy1ZivMKIwSDBEBQ9FCckigEAU3QOD7TGvY4AAAAASUVORK5CYII=",or=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:tr});const nr=e=>{let t=!1;const o=()=>{t=!0},s=e.fps||60,i=e.slow||1,l=e.update,r=e.render,a=window.requestAnimationFrame,m=1/s,w=i*m;let S,G=0,f=window.performance.now();const g=()=>{for(S=window.performance.now(),G=G+Math.min(1,(S-f)/1e3);G>w;)G=G-w,l(m);r(G/i),f=S,t||a(g)};return a(g),{stop:o}},sr=.1,ir=6,lr=.05;class Mt{constructor(t=null){this.x=0,this.y=0,this.curZoom=1,t&&this.fromSnapshot(t)}snapshot(){return{x:this.x,y:this.y,curZoom:this.curZoom}}getCurrentZoom(){return this.curZoom}fromSnapshot(t){this.x=t.x,this.y=t.y,this.curZoom=t.curZoom}reset(){this.x=0,this.y=0,this.curZoom=1}move(t,o){this.x+=t/this.curZoom,this.y+=o/this.curZoom}calculateNewZoom(t){const o=t==="in"?1:-1,s=this.curZoom+lr*this.curZoom*o;return Math.min(Math.max(s,sr),ir)}canZoom(t){return this.curZoom!=this.calculateNewZoom(t)}setZoom(t,o){if(this.curZoom==t)return!1;const s=1-this.curZoom/t;return this.move(-o.x*s,-o.y*s),this.curZoom=t,!0}zoom(t,o){return this.setZoom(this.calculateNewZoom(t),o)}viewportToWorld(t){const{x:o,y:s}=this.viewportToWorldRaw(t);return{x:Math.round(o),y:Math.round(s)}}viewportToWorldRaw(t){return{x:t.x/this.curZoom-this.x,y:t.y/this.curZoom-this.y}}worldToViewport(t){const{x:o,y:s}=this.worldToViewportRaw(t);return{x:Math.round(o),y:Math.round(s)}}worldToViewportRaw(t){return{x:(t.x+this.x)*this.curZoom,y:(t.y+this.y)*this.curZoom}}worldDimToViewport(t){const{w:o,h:s}=this.worldDimToViewportRaw(t);return{w:Math.round(o),h:Math.round(s)}}worldDimToViewportRaw(t){return{w:t.w*this.curZoom,h:t.h*this.curZoom}}viewportDimToWorld(t){const{w:o,h:s}=this.viewportDimToWorldRaw(t);return{w:Math.round(o),h:Math.round(s)}}viewportDimToWorldRaw(t){return{w:t.w/this.curZoom,h:t.h/this.curZoom}}}function Dt(e=0,t=0){const o=document.createElement("canvas");return o.width=e,o.height=t,o}async function rr(e){return new Promise(t=>{const o=new Image;o.onload=()=>{createImageBitmap(o).then(t)},o.src=e})}async function ar(e,t,o){const s=Dt(t,o);return s.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,o),await createImageBitmap(s)}function ur(e,t,o){const s=Dt(e.width,e.height),i=s.getContext("2d");return i.save(),i.drawImage(t,0,0),i.fillStyle=o,i.globalCompositeOperation="source-in",i.fillRect(0,0,t.width,t.height),i.restore(),i.save(),i.globalCompositeOperation="destination-over",i.drawImage(e,0,0),i.restore(),s}var he={createCanvas:Dt,loadImageToBitmap:rr,resizeBitmap:ar,colorizedCanvas:ur};const cr=mt("Debug.js");let Ft=0,Uo=0;const dr=e=>{Ft=performance.now(),Uo=e},pr=e=>{const t=performance.now(),o=t-Ft;o>Uo&&cr.log(e+": "+o),Ft=t};var $e={checkpoint_start:dr,checkpoint:pr};function hr(e,t){return{x:e.x-t.x,y:e.y-t.y}}function gr(e,t){return{x:e.x+t.x,y:e.y+t.y}}function ko(e,t){const o=e.x-t.x,s=e.y-t.y;return Math.sqrt(o*o+s*s)}function mr(e,t){return e.x>=t.x&&e.x<=t.x+t.w&&e.y>=t.y&&e.y<=t.y+t.h}function It(e){return{x:e.x+e.w/2,y:e.y+e.h/2}}function fr(e,t,o){return{x:e.x+t,y:e.y+o,w:e.w,h:e.h}}function yr(e,t){return!(t.x>e.x+e.w||e.x>t.x+t.w||t.y>e.y+e.h||e.y>t.y+t.h)}function _r(e,t){return ko(It(e),It(t))}var Z={pointSub:hr,pointAdd:gr,pointDistance:ko,pointInBounds:mr,rectCenter:It,rectMoved:fr,rectCenterDistance:_r,rectsOverlap:yr};const Ro=mt("PuzzleGraphics.js");async function Er(e,t,o){Ro.log("start createPuzzleTileBitmaps");const s=o.tileSize,i=o.tileMarginWidth,l=o.tileDrawSize,r=s/100,a=[0,0,40,15,37,5,37,5,40,0,38,-5,38,-5,20,-20,50,-20,50,-20,80,-20,62,-5,62,-5,60,0,63,5,63,5,65,15,100,0],m=new Array(t.length),w={};function S(y){const B=`${y.top}${y.right}${y.left}${y.bottom}`;if(w[B])return w[B];const O=new Path2D,b={x:i,y:i},v=Z.pointAdd(b,{x:s,y:0}),c=Z.pointAdd(v,{x:0,y:s}),M=Z.pointSub(c,{x:s,y:0});if(O.moveTo(b.x,b.y),y.top!==0)for(let E=0;E<a.length/6;E++){const Q=Z.pointAdd(b,{x:a[E*6+0]*r,y:y.top*a[E*6+1]*r}),K=Z.pointAdd(b,{x:a[E*6+2]*r,y:y.top*a[E*6+3]*r}),X=Z.pointAdd(b,{x:a[E*6+4]*r,y:y.top*a[E*6+5]*r});O.bezierCurveTo(Q.x,Q.y,K.x,K.y,X.x,X.y)}else O.lineTo(v.x,v.y);if(y.right!==0)for(let E=0;E<a.length/6;E++){const Q=Z.pointAdd(v,{x:-y.right*a[E*6+1]*r,y:a[E*6+0]*r}),K=Z.pointAdd(v,{x:-y.right*a[E*6+3]*r,y:a[E*6+2]*r}),X=Z.pointAdd(v,{x:-y.right*a[E*6+5]*r,y:a[E*6+4]*r});O.bezierCurveTo(Q.x,Q.y,K.x,K.y,X.x,X.y)}else O.lineTo(c.x,c.y);if(y.bottom!==0)for(let E=0;E<a.length/6;E++){const Q=Z.pointSub(c,{x:a[E*6+0]*r,y:y.bottom*a[E*6+1]*r}),K=Z.pointSub(c,{x:a[E*6+2]*r,y:y.bottom*a[E*6+3]*r}),X=Z.pointSub(c,{x:a[E*6+4]*r,y:y.bottom*a[E*6+5]*r});O.bezierCurveTo(Q.x,Q.y,K.x,K.y,X.x,X.y)}else O.lineTo(M.x,M.y);if(y.left!==0)for(let E=0;E<a.length/6;E++){const Q=Z.pointSub(M,{x:-y.left*a[E*6+1]*r,y:a[E*6+0]*r}),K=Z.pointSub(M,{x:-y.left*a[E*6+3]*r,y:a[E*6+2]*r}),X=Z.pointSub(M,{x:-y.left*a[E*6+5]*r,y:a[E*6+4]*r});O.bezierCurveTo(Q.x,Q.y,K.x,K.y,X.x,X.y)}else O.lineTo(b.x,b.y);return w[B]=O,O}const G=he.createCanvas(l,l),f=G.getContext("2d"),g=he.createCanvas(l,l),A=g.getContext("2d");for(const y of t){const B=L.decodePiece(y),O=wr(o,B.idx),b=S(L.decodeShape(o.shapes[B.idx]));f.clearRect(0,0,l,l),f.save(),f.lineWidth=2,f.stroke(b),f.globalCompositeOperation="source-in",f.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),f.restore(),f.save(),f.globalCompositeOperation="source-in",f.globalAlpha=.2,f.fillStyle="black",f.fillRect(0,0,G.width,G.height),f.restore(),f.save(),f.clip(b),f.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),f.restore(),f.save(),f.clip(b),f.strokeStyle="rgba(0,0,0,.4)",f.lineWidth=0,f.shadowColor="black",f.shadowBlur=2,f.shadowOffsetX=-1,f.shadowOffsetY=-1,f.stroke(b),f.restore(),f.save(),f.clip(b),f.strokeStyle="rgba(255,255,255,.4)",f.lineWidth=0,f.shadowColor="white",f.shadowBlur=2,f.shadowOffsetX=1,f.shadowOffsetY=1,f.stroke(b),f.restore(),A.clearRect(0,0,l,l),A.save(),A.lineWidth=1,A.stroke(b),A.globalCompositeOperation="source-in",A.drawImage(e,O.x-i,O.y-i,l,l,0,0,l,l),A.restore(),f.drawImage(g,0,0),m[B.idx]=await createImageBitmap(G)}return Ro.log("end createPuzzleTileBitmaps"),m}function wr(e,t){const o=L.coordByPieceIdx(e,t);return{x:o.x*e.tileSize,y:o.y*e.tileSize,w:e.tileSize,h:e.tileSize}}async function vr(e){const t=await he.loadImageToBitmap(e.info.imageUrl),o=await he.resizeBitmap(t,e.info.width,e.info.height);return await Er(o,e.tiles,e.info)}var Pr={loadPuzzleBitmaps:vr};const Vo=30,T={};function Tr(e){return!!T[e]||!1}function Cr(e,t){return{id:e,x:0,y:0,d:0,name:null,color:null,bgcolor:null,points:0,ts:t}}function Sr(e,t){T[e]=t}function Je(e,t){let o=0;for(const s of T[e].players){if(L.decodePlayer(s).id===t)return o;o++}return-1}function br(e,t){return T[e].players.length>t?L.decodePlayer(T[e].players[t]).id:null}function Ae(e,t){const o=Je(e,t);return o===-1?null:L.decodePlayer(T[e].players[o])}function Gt(e,t,o){const s=Je(e,t);s===-1?T[e].players.push(L.encodePlayer(o)):T[e].players[s]=L.encodePlayer(o)}function $r(e,t,o){T[e].puzzle.tiles[t]=L.encodePiece(o)}function Ar(e,t){T[e].puzzle.data=t}function Lo(e,t){return Je(e,t)!==-1}function Or(e,t){const o=t-Vo*ye.SEC;return zo(e).filter(s=>s.ts>=o)}function Nr(e,t){const o=t-Vo*ye.SEC;return zo(e).filter(s=>s.ts<o&&s.points>0)}function Ur(e,t,o){Lo(e,t)?ne(e,t,{ts:o}):Gt(e,t,Cr(t,o))}function kr(){return Object.values(T).sort((e,t)=>{const o=Do(e.id);return o===Do(t.id)?o?t.puzzle.data.finished-e.puzzle.data.finished:t.puzzle.data.started-e.puzzle.data.started:o?1:-1})}function zo(e){return T[e]?T[e].players.map(L.decodePlayer):[]}function Rr(e){return T[e]||null}function et(e){return T[e].puzzle.tiles.length}function Vr(e){var o;const t=((o=T[e].puzzle.info.image)==null?void 0:o.url)||T[e].puzzle.info.imageUrl;if(!t)throw new Error("[2021-07-11] no image url set");return t}function Bt(e){return T[e].scoreMode}function Mo(e){return T[e].snapMode}function Do(e){return tt(e)===et(e)}function tt(e){let t=0;for(const o of T[e].puzzle.tiles)L.decodePiece(o).owner===-1&&t++;return t}function Lr(e){return T[e].puzzle.tiles.map(L.decodePiece).sort((o,s)=>o.z-s.z)}function ne(e,t,o){const s=Ae(e,t);if(s!==null){for(const i of Object.keys(o))s[i]=o[i];Gt(e,t,s)}}function ot(e,t){for(const o of Object.keys(t))T[e].puzzle.data[o]=t[o]}function Oe(e,t,o){for(const s of Object.keys(o)){const i=L.decodePiece(T[e].puzzle.tiles[t]);i[s]=o[s],T[e].puzzle.tiles[t]=L.encodePiece(i)}}const ze=(e,t)=>L.decodePiece(T[e].puzzle.tiles[t]),nt=(e,t)=>ze(e,t).group,zr=(e,t)=>{const o=T[e].puzzle.info;return t===0||t===o.tilesX-1||t===o.tiles-o.tilesX||t===o.tiles-1},Fo=(e,t)=>{const o=T[e].puzzle.info,s={x:(o.table.width-o.width)/2,y:(o.table.height-o.height)/2},i=Yr(e,t);return Z.pointAdd(s,i)},st=(e,t)=>ze(e,t).pos,Mr=e=>{const t=Zo(e),o=Ho(e),s=Math.round(t/4),i=Math.round(o/4);return{x:0-s,y:0-i,w:t+2*s,h:o+2*i}},Dr=(e,t)=>ze(e,t).z,Ie=(e,t)=>{for(const o of T[e].puzzle.tiles){const s=L.decodePiece(o);if(s.owner===t)return s.idx}return-1},Fr=(e,t)=>{const o=Ie(e,t);return o<0?null:T[e].puzzle.tiles[o]},Ir=e=>T[e].puzzle.info.tileDrawOffset,Io=e=>T[e].puzzle.info.tileDrawSize,Gr=e=>T[e].puzzle.data.started,Br=e=>T[e].puzzle.data.finished,Go=e=>T[e].puzzle.data.maxGroup,Bo=e=>T[e].puzzle.data.maxZ,xr=(e,t)=>{let o=0;for(const s of t){const i=Dr(e,s);i>o&&(o=i)}return o};function Yr(e,t){const o=T[e].puzzle.info,s=L.coordByPieceIdx(o,t),i=s.x*o.tileSize,l=s.y*o.tileSize;return{x:i,y:l}}function Wr(e,t){const o=T[e].puzzle.info,s=L.coordByPieceIdx(o,t);return[s.y>0?t-o.tilesX:-1,s.x<o.tilesX-1?t+1:-1,s.y<o.tilesY-1?t+o.tilesX:-1,s.x>0?t-1:-1]}const xo=(e,t,o)=>{for(const s of t)Oe(e,s,{z:o})},Zr=(e,t,o)=>{const s=st(e,t),i=Z.pointAdd(s,o);Oe(e,t,{pos:i})},it=(e,t,o)=>{const s=Io(e),i=Mr(e),l=o;for(const r of t){const a=ze(e,r);a.pos.x+o.x<i.x?l.x=Math.max(i.x-a.pos.x,l.x):a.pos.x+s+o.x>i.x+i.w&&(l.x=Math.min(i.x+i.w-a.pos.x+s,l.x)),a.pos.y+o.y<i.y?l.y=Math.max(i.y-a.pos.y,l.y):a.pos.y+s+o.y>i.y+i.h&&(l.y=Math.min(i.y+i.h-a.pos.y+s,l.y))}if(!l.x&&!l.y)return!1;for(const r of t)Zr(e,r,l);return!0},Hr=(e,t)=>jr(e,t)===-1,jr=(e,t)=>ze(e,t).owner,Yo=(e,t)=>{for(const o of t)Oe(e,o,{owner:-1,z:1})},xt=(e,t,o)=>{for(const s of t)Oe(e,s,{owner:o})};function ve(e,t){const o=T[e].puzzle.tiles,s=L.decodePiece(o[t]),i=[];if(s.group)for(const l of o){const r=L.decodePiece(l);r.group===s.group&&i.push(r.idx)}else i.push(s.idx);return i}const Kr=(e,t)=>{const o=T[e].puzzle.info,s=T[e].puzzle.tiles;let i=-1,l=-1;for(let r=0;r<s.length;r++){const a=L.decodePiece(s[r]);if(a.owner!==0)continue;const m={x:a.pos.x,y:a.pos.y,w:o.tileSize,h:o.tileSize};Z.pointInBounds(t,m)&&(i===-1||a.z>i)&&(i=a.z,l=r)}return l},qr=(e,t)=>{const o=Ae(e,t);return o?o.bgcolor:null},Qr=(e,t)=>{const o=Ae(e,t);return o?o.color:null},Xr=(e,t)=>{const o=Ae(e,t);return o?o.name:null},Wo=(e,t)=>{const o=Ae(e,t);return o?o.points:0},Jr=(e,t,o)=>{const s=nt(e,t),i=nt(e,o);return!!(s&&s===i)},Zo=e=>T[e].puzzle.info.table.width,Ho=e=>T[e].puzzle.info.table.height,ea=e=>T[e].puzzle,ta=e=>T[e].rng.obj,oa=e=>T[e].puzzle.info.width,na=e=>T[e].puzzle.info.height,sa=(e,t)=>{if(Mo(e)===be.REAL){for(const o of t)if(zr(e,o))return!0;return!1}return!0};function ia(e,t,o,s,i){const l=T[e].puzzle,r=[],a=()=>{r.push([d.CHANGE_DATA,l.data])},m=g=>{r.push([d.CHANGE_TILE,L.encodePiece(ze(e,g))])},w=g=>{for(const A of g)m(A)},S=()=>{const g=Ae(e,t);!g||r.push([d.CHANGE_PLAYER,L.encodePlayer(g)])},G=(g,A,y)=>{const B=T[g].puzzle.tiles,O=nt(g,A),b=nt(g,y);let v;const c=[];if(O&&c.push(O),b&&c.push(b),O)v=O;else if(b)v=b;else{const M=Go(g)+1;ot(g,{maxGroup:M}),a(),v=Go(g)}if(Oe(g,A,{group:v}),m(A),Oe(g,y,{group:v}),m(y),c.length>0)for(const M of B){const E=L.decodePiece(M);c.includes(E.group)&&(Oe(g,E.idx,{group:v}),m(E.idx))}},f=o[0];if(f===d.INPUT_EV_CONNECTION_CLOSE){const g=Ie(e,t);if(g>=0){const A=ve(e,g);xt(e,A,0),w(A)}}else if(f===d.INPUT_EV_BG_COLOR){const g=o[1];ne(e,t,{bgcolor:g,ts:s}),S()}else if(f===d.INPUT_EV_PLAYER_COLOR){const g=o[1];ne(e,t,{color:g,ts:s}),S()}else if(f===d.INPUT_EV_PLAYER_NAME){const g=`${o[1]}`.substr(0,16);ne(e,t,{name:g,ts:s}),S()}else if(f===d.INPUT_EV_MOVE){const g=o[1],A=o[2],y=Ae(e,t);if(y){const B=y.x-g,O=y.y-A;ne(e,t,{ts:s,x:B,y:O}),S();const b=Ie(e,t);if(b>=0){const v=ve(e,b),c={x:-g,y:-A};it(e,v,c)&&w(v)}}}else if(f===d.INPUT_EV_MOUSE_DOWN){const g=o[1],A=o[2],y={x:g,y:A};ne(e,t,{d:1,ts:s}),S();const B=Kr(e,y);if(B>=0){const O=Bo(e)+1;ot(e,{maxZ:O}),a();const b=ve(e,B);xo(e,b,Bo(e)),xt(e,b,t),w(b)}}else if(f===d.INPUT_EV_MOUSE_MOVE){const g=o[1],A=o[2];if(!o[5])ne(e,t,{x:g,y:A,ts:s}),S();else{const B=Ie(e,t);if(B<0)ne(e,t,{ts:s}),S();else{const O=o[1],b=o[2],v=o[3],c=o[4];ne(e,t,{x:O,y:b,ts:s}),S();const M=ve(e,B);it(e,M,{x:v,y:c})&&w(M)}}}else if(f===d.INPUT_EV_MOUSE_UP){const g=0,A=Ie(e,t);if(A>=0){const y=ve(e,A);xt(e,y,0),w(y);const B=st(e,A),O=Fo(e,A);if(sa(e,y)&&Z.pointDistance(O,B)<l.info.snapDistance){const b=Z.pointSub(O,B);it(e,y,b),Yo(e,y),w(y);let v=Wo(e,t);Bt(e)===Ee.FINAL?v+=y.length:Bt(e)===Ee.ANY&&(v+=1),ne(e,t,{d:g,ts:s,points:v}),S(),tt(e)===et(e)&&(ot(e,{finished:s}),a()),i&&i(t)}else{const b=(c,M,E,Q)=>{const K=T[c].puzzle.info;if(E<0||Jr(c,M,E))return!1;const X=st(c,M),_e=Z.pointAdd(st(c,E),{x:Q[0]*K.tileSize,y:Q[1]*K.tileSize});if(Z.pointDistance(X,_e)<K.snapDistance){const Pe=Z.pointSub(_e,X);let de=ve(c,M);if(it(c,de,Pe),G(c,M,E),de=ve(c,M),Hr(c,E))Yo(c,de);else{const Ne=xr(c,de);xo(c,de,Ne)}return w(de),!0}return!1};let v=!1;for(const c of ve(e,A)){const M=Wr(e,c);if(b(e,c,M[0],[0,1])||b(e,c,M[1],[-1,0])||b(e,c,M[2],[0,-1])||b(e,c,M[3],[1,0])){v=!0;break}}if(v&&Bt(e)===Ee.ANY){const c=Wo(e,t)+1;ne(e,t,{d:g,ts:s,points:c}),S()}else ne(e,t,{d:g,ts:s}),S();v&&Mo(e)===be.REAL&&tt(e)===et(e)&&(ot(e,{finished:s}),a()),v&&i&&i(t)}}else ne(e,t,{d:g,ts:s}),S()}else if(f===d.INPUT_EV_ZOOM_IN){const g=o[1],A=o[2];ne(e,t,{x:g,y:A,ts:s}),S()}else if(f===d.INPUT_EV_ZOOM_OUT){const g=o[1],A=o[2];ne(e,t,{x:g,y:A,ts:s}),S()}else ne(e,t,{ts:s}),S();return r}var U={setGame:Sr,exists:Tr,playerExists:Lo,getActivePlayers:Or,getIdlePlayers:Nr,addPlayer:Ur,getFinishedPiecesCount:tt,getPieceCount:et,getImageUrl:Vr,get:Rr,getAllGames:kr,getPlayerBgColor:qr,getPlayerColor:Qr,getPlayerName:Xr,getPlayerIndexById:Je,getPlayerIdByIndex:br,changePlayer:ne,setPlayer:Gt,setPiece:$r,setPuzzleData:Ar,getTableWidth:Zo,getTableHeight:Ho,getPuzzle:ea,getRng:ta,getPuzzleWidth:oa,getPuzzleHeight:na,getPiecesSortedByZIndex:Lr,getFirstOwnedPiece:Fr,getPieceDrawOffset:Ir,getPieceDrawSize:Io,getFinalPiecePos:Fo,getStartTs:Gr,getFinishTs:Br,handleInput:ia};let jo=-10,Ko=20,Yt=2,qo=15;const la=5,ra=5,Wt=1,aa=200,Qo=10,ua=100,ca=10,da=1,pa=5;function ha(e){const t=e.random(0,255),o=e.random(0,255),s=e.random(0,255);return"rgba("+t+","+o+","+s+", 0.8)"}class Xo{constructor(t){this.radius=Qo,this.previousRadius=Qo,this.explodingDuration=ua,this.hasExploded=!1,this.alive=!0,this.color=ha(t),this.px=window.innerWidth/4+Math.random()*window.innerWidth/2,this.py=window.innerHeight,this.vx=jo+Math.random()*Ko,this.vy=(Yt+Math.random()*qo)*-1,this.duration=0}update(t){if(this.hasExploded){const o=aa-this.radius;this.previousRadius=this.radius,this.radius+=o/ca,this.explodingDuration--,this.explodingDuration==0&&(this.alive=!1)}else this.vx+=0,this.vy+=Wt,this.vy>=0&&t&&this.explode(t),this.px+=this.vx,this.py+=this.vy}draw(t){t.beginPath(),t.arc(this.px,this.py,this.previousRadius,0,Math.PI*2,!1),this.hasExploded||(t.fillStyle=this.color,t.lineWidth=1,t.fill())}explode(t){this.hasExploded=!0;const o=3+Math.floor(Math.random()*3);for(let s=0;s<o;s++){const i=10+Math.floor(Math.random()*21),l=la+Math.random()*ra,r=2*Math.PI/i,a=Math.random()*r;for(let m=0;m<i;m++)t.push(new ga(this,m*r+a,l))}}}class ga{constructor(t,o,s){this.px=t.px,this.py=t.py,this.vx=Math.cos(o)*s,this.vy=Math.sin(o)*s,this.color=t.color,this.duration=40+Math.floor(Math.random()*20),this.alive=!0,this.radius=0}update(){this.vx+=0,this.vy+=Wt/10,this.px+=this.vx,this.py+=this.vy,this.radius=3,this.duration--,this.duration<=0&&(this.alive=!1)}draw(t){t.beginPath(),t.arc(this.px,this.py,this.radius,0,Math.PI*2,!1),t.fillStyle=this.color,t.lineWidth=1,t.fill()}}class ma{constructor(t,o){this.canvas=t,this.rng=o,this.ctx=this.canvas.getContext("2d"),this.resize(),this.readyBombs=[],this.explodedBombs=[],this.particles=[],window.addEventListener("resize",()=>{this.resize()})}setSpeedParams(){let t=0,o=0;for(;t<this.canvas.height&&o>=0;)o+=Wt,t+=o;Yt=o/2,qo=o-Yt;const s=1/4*this.canvas.width/(o/2);jo=-s,Ko=2*s}resize(){this.setSpeedParams()}init(){this.readyBombs=[],this.explodedBombs=[],this.particles=[];for(let t=0;t<da;t++)this.readyBombs.push(new Xo(this.rng))}update(){Math.random()*100<pa&&this.readyBombs.push(new Xo(this.rng));const t=[];for(;this.explodedBombs.length>0;){const i=this.explodedBombs.shift();if(!i)break;i.update(),i.alive&&t.push(i)}this.explodedBombs=t;const o=[];for(;this.readyBombs.length>0;){const i=this.readyBombs.shift();if(!i)break;i.update(this.particles),i.hasExploded?this.explodedBombs.push(i):o.push(i)}this.readyBombs=o;const s=[];for(;this.particles.length>0;){const i=this.particles.shift();if(!i)break;i.update(),i.alive&&s.push(i)}this.particles=s}render(){this.ctx.beginPath(),this.ctx.fillStyle="rgba(0, 0, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);for(let t=0;t<this.readyBombs.length;t++)this.readyBombs[t].draw(this.ctx);for(let t=0;t<this.explodedBombs.length;t++)this.explodedBombs[t].draw(this.ctx);for(let t=0;t<this.particles.length;t++)this.particles[t].draw(this.ctx)}}function fa(e,t,o,s){let i=[],l=!0,r=!1,a=!1,m=!1,w=!1,S=!1,G=!1,f=!1;const g=(h,R)=>{const D=o.viewportToWorld({x:h,y:R});return[D.x,D.y]},A=(h,R)=>{const D=o.viewportDimToWorld({w:h,h:R});return[D.w,D.h]},y=h=>g(h.offsetX,h.offsetY),B=()=>g(e.width/2,e.height/2),O=(h,R)=>{!l||(R.code==="ShiftLeft"||R.code==="ShiftRight"?f=h:R.code==="ArrowUp"||R.code==="KeyW"?m=h:R.code==="ArrowDown"||R.code==="KeyS"?w=h:R.code==="ArrowLeft"||R.code==="KeyA"?r=h:R.code==="ArrowRight"||R.code==="KeyD"?a=h:R.code==="KeyQ"?G=h:R.code==="KeyE"&&(S=h))};let b=!1,v=null,c=null;const M=h=>{c=y(h),v=[h.offsetX,h.offsetY],h.button===0&&(b=!0,W([d.INPUT_EV_MOUSE_DOWN,...c]))},E=h=>{c=y(h),v=[h.offsetX,h.offsetY],h.button===0&&(b=!1,W([d.INPUT_EV_MOUSE_UP,...c]))},Q=h=>{if(!v)return;c=y(h);const R=A(-(v[0]-h.offsetX),-(v[1]-h.offsetY));W([d.INPUT_EV_MOUSE_MOVE,...c,...R,b?1:0]),v=[h.offsetX,h.offsetY]},K=h=>{if(c=y(h),o.canZoom(h.deltaY<0?"in":"out")){const R=h.deltaY<0?d.INPUT_EV_ZOOM_IN:d.INPUT_EV_ZOOM_OUT;W([R,...c])}},X=h=>O(!0,h),_e=h=>O(!1,h),Pe=h=>{if(!!l){if(s===ge&&(h.code==="KeyI"?W([d.INPUT_EV_REPLAY_SPEED_UP]):h.code==="KeyO"?W([d.INPUT_EV_REPLAY_SPEED_DOWN]):h.code==="KeyP"&&W([d.INPUT_EV_REPLAY_TOGGLE_PAUSE])),h.code==="Space")W([d.INPUT_EV_TOGGLE_PREVIEW]);else if(h.code==="KeyF")W([d.INPUT_EV_TOGGLE_FIXED_PIECES]);else if(h.code==="KeyG")W([d.INPUT_EV_TOGGLE_LOOSE_PIECES]);else if(h.code==="KeyM")W([d.INPUT_EV_TOGGLE_SOUNDS]);else if(h.code==="KeyN")W([d.INPUT_EV_TOGGLE_PLAYER_NAMES]);else if(h.code==="KeyC")W([d.INPUT_EV_CENTER_FIT_PUZZLE]);else if(h.code==="Digit1"){const R=h.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;W([R,1])}else if(h.code==="Digit2"){const R=h.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;W([R,2])}else if(h.code==="Digit3"){const R=h.shiftKey?d.INPUT_EV_STORE_POS:d.INPUT_EV_RESTORE_POS;W([R,3])}}},de=()=>{e.addEventListener("mousedown",M),e.addEventListener("mouseup",E),e.addEventListener("mousemove",Q),e.addEventListener("wheel",K),t.addEventListener("keydown",X),t.addEventListener("keyup",_e),t.addEventListener("keypress",Pe)},Ne=()=>{e.removeEventListener("mousedown",M),e.removeEventListener("mouseup",E),e.removeEventListener("mousemove",Q),e.removeEventListener("wheel",K),t.removeEventListener("keydown",X),t.removeEventListener("keyup",_e),t.removeEventListener("keypress",Pe)},rt=(h,R)=>{if(!v||!c)return;const D=new Mt(h).viewportToWorld({x:v[0],y:v[1]}),$=new Mt(R).viewportToWorld({x:v[0],y:v[1]}),at=[-(D.x-$.x),-(D.y-$.y)];W([d.INPUT_EV_MOUSE_MOVE,...c,...at,b?1:0])},W=h=>{i.push(h)};return{registerEvents:de,unregisterEvents:Ne,addEvent:W,consumeAll:()=>{if(i.length===0)return[];const h=i.slice();return i=[],h},createKeyEvents:()=>{const h=(r?1:0)-(a?1:0),R=(m?1:0)-(w?1:0);if(h!==0||R!==0){const D=(f?24:12)*Math.sqrt(o.getCurrentZoom()),$=o.viewportDimToWorld({w:h*D,h:R*D});W([d.INPUT_EV_MOVE,$.w,$.h]),c&&(c[0]-=$.w,c[1]-=$.h)}if(!(S&&G)){if(S){if(o.canZoom("in")){const D=c||B();W([d.INPUT_EV_ZOOM_IN,...D])}}else if(G&&o.canZoom("out")){const D=c||B();W([d.INPUT_EV_ZOOM_OUT,...D])}}},createSnapshotEvents:rt,setHotkeys:h=>{l=h}}}const lt={"./grab.png":ql,"./grab_mask.png":Xl,"./hand.png":er,"./hand_mask.png":or},ya={"./click.mp3":jl},Ge="play",ge="replay";let Be=!0,xe=!0;const _a=e=>e.owner===-1?Be:xe;let j=!0;async function Jo(e,t,o,s,i,l){typeof window.DEBUG=="undefined"&&(window.DEBUG=!1);const r=u=>s===ge||u.id!==t,a=ya["./click.mp3"].default,m=new Audio(a),w=await he.loadImageToBitmap(lt["./grab.png"].default),S=await he.loadImageToBitmap(lt["./hand.png"].default),G=await he.loadImageToBitmap(lt["./grab_mask.png"].default),f=await he.loadImageToBitmap(lt["./hand_mask.png"].default),g=w.width,A=Math.round(g/2),y=w.height,B=Math.round(y/2),O={},b=async u=>{const p=u.color+" "+u.d;if(!O[p]){const C=u.d?w:S;if(u.color){const x=u.d?G:f;O[p]=await createImageBitmap(he.colorizedCanvas(C,x,u.color))}else O[p]=C}return O[p]},v=i,c={final:!1,log:[],logPointer:0,speeds:[.5,1,2,5,10,20,50,100,250,500],speedIdx:1,paused:!1,lastRealTs:0,lastGameTs:0,gameStartTs:0,skipNonActionPhases:!0,dataOffset:0};we.onConnectionStateChange(u=>{l.emit("connectionState",u)});const M=async u=>{const p=c.dataOffset;c.dataOffset+=1e4;const C=await we.requestReplayData(u,p);return c.log=c.log.slice(c.logPointer),c.logPointer=0,c.log.push(...C.log),C.log.length===0&&(c.final=!0),C};let E=()=>0;const Q=async()=>{if(s===Ge){const u=await we.connect(o,e,t),p=L.decodeGame(u);U.setGame(p.id,p),E=()=>ye.timestamp()}else if(s===ge){const u=await M(e);if(!u.game)throw"[ 2021-05-29 no game received ]";const p=L.decodeGame(u.game);U.setGame(p.id,p),c.lastRealTs=ye.timestamp(),c.gameStartTs=parseInt(u.log[0][4],10),c.lastGameTs=c.gameStartTs,E=()=>c.lastGameTs}else throw"[ 2020-12-22 MODE invalid, must be play|replay ]";j=!0};await Q();const K=U.getPieceDrawOffset(e),X=U.getPieceDrawSize(e),_e=U.getPuzzleWidth(e),Pe=U.getPuzzleHeight(e),de=U.getTableWidth(e),Ne=U.getTableHeight(e),rt={x:(de-_e)/2,y:(Ne-Pe)/2},W={w:_e,h:Pe},Zt={w:X,h:X},Ht=await Pr.loadPuzzleBitmaps(U.getPuzzle(e)),Ye=new ma(v,U.getRng(e));Ye.init();const h=v.getContext("2d");v.classList.add("loaded"),l.emit("puzzleCut");let R="";const D={},$=new Mt,at=()=>{$.reset(),$.move(-(de-v.width)/2,-(Ne-v.height)/2);const u=$.worldDimToViewportRaw(W),p=20,C=v.width-p*2,x=v.height-p*2;if(u.w>C||u.h>x||u.w<C&&u.h<x){const F=Math.min(C/u.w,x/u.h),J={x:v.width/2,y:v.height/2};$.setZoom(F,J)}},le=fa(v,window,$,s);le.registerEvents();const We=u=>{if(D.last&&R===u){const p=$.snapshot(),C=D.last;$.fromSnapshot(C),le.createSnapshotEvents(p,C),delete D.last}else if(D[u]){const p=D[u],C=$.snapshot();D.last=C,R=u,$.fromSnapshot(p),le.createSnapshotEvents(C,p)}};at(),D.center=$.snapshot();const on=U.getImageUrl(e),Ze=u=>{const p=U.getStartTs(e),C=U.getFinishTs(e);l.emit("status",{finished:!!C,duration:(C||u)-p,piecesDone:U.getFinishedPiecesCount(e),piecesTotal:U.getPieceCount(e)}),l.emit("players",{active:U.getActivePlayers(e,u),idle:U.getIdlePlayers(e,u)})};Ze(E());const jt=!!U.getFinishTs(e);let ut=jt;const Kt=()=>ut&&!jt,qt=()=>oe.getInt(ie.SOUND_VOLUME,fe.SOUND_VOLUME),Qt=()=>oe.getBool(ie.SOUND_ENABLED,fe.SOUND_ENABLED),Xt=()=>oe.getBool(ie.SHOW_PLAYER_NAMES,fe.SHOW_PLAYER_NAMES),Jt=()=>s===ge?oe.getStr(ie.COLOR_BACKGROUND,fe.COLOR_BACKGROUND):U.getPlayerBgColor(e,t)||oe.getStr(ie.COLOR_BACKGROUND,fe.COLOR_BACKGROUND),eo=()=>s===ge?oe.getStr(ie.PLAYER_COLOR,fe.PLAYER_COLOR):U.getPlayerColor(e,t)||oe.getStr(ie.PLAYER_COLOR,fe.PLAYER_COLOR),nn=()=>s===ge?oe.getStr(ie.PLAYER_NAME,fe.PLAYER_NAME):U.getPlayerName(e,t)||oe.getStr(ie.PLAYER_NAME,fe.PLAYER_NAME),to=()=>{const u=qt();m.volume=u/100,m.play()},se={background:Jt(),color:eo(),name:nn(),soundsEnabled:Qt(),soundsVolume:qt(),showPlayerNames:Xt()};le.addEvent([d.INPUT_EV_BG_COLOR,se.background]),le.addEvent([d.INPUT_EV_PLAYER_COLOR,se.color]),le.addEvent([d.INPUT_EV_PLAYER_NAME,se.name]);let oo="",no="",so=!1;const Me=u=>{so=u;const[p,C]=u?[oo,"grab"]:[no,"default"];v.style.cursor=`url('${p}') ${A} ${B}, ${C}`},ct=u=>{oo=he.colorizedCanvas(w,G,u).toDataURL(),no=he.colorizedCanvas(S,f,u).toDataURL(),Me(so)};ct(eo());const He=()=>{l.emit("replaySpeed",c.speeds[c.speedIdx]),l.emit("replayPaused",c.paused)},io=()=>{c.speedIdx+1<c.speeds.length&&(c.speedIdx++,He())},lo=()=>{c.speedIdx>=1&&(c.speedIdx--,He())},ro=()=>{c.paused=!c.paused,He()};l.on("replayOnSpeedUp",()=>{io()}),l.on("replayOnSpeedDown",()=>{lo()}),l.on("replayOnPauseToggle",()=>{ro()}),l.on("onBgChange",u=>{se.background!==u&&(se.background=u,oe.setStr(ie.COLOR_BACKGROUND,u),le.addEvent([d.INPUT_EV_BG_COLOR,u]))}),l.on("onColorChange",u=>{se.color!==u&&(se.color=u,oe.setStr(ie.PLAYER_COLOR,u),le.addEvent([d.INPUT_EV_PLAYER_COLOR,u]))}),l.on("onNameChange",u=>{se.name!==u&&(se.name=u,oe.setStr(ie.PLAYER_NAME,u),le.addEvent([d.INPUT_EV_PLAYER_NAME,u]))}),l.on("onSoundsEnabledChange",u=>{se.soundsEnabled!==u&&(se.soundsEnabled=u,oe.setBool(ie.SOUND_ENABLED,u))}),l.on("onSoundsVolumeChange",u=>{se.soundsVolume!==u&&(se.soundsVolume=u,oe.setInt(ie.SOUND_VOLUME,u),to())}),l.on("onShowPlayerNamesChange",u=>{se.showPlayerNames!==u&&(se.showPlayerNames=u,oe.setBool(ie.SHOW_PLAYER_NAMES,u))}),l.on("setHotkeys",u=>{le.setHotkeys(u)}),l.on("requireRerender",()=>{j=!0});const ao=[];let je;const sn=()=>{ao.forEach(u=>{clearInterval(u)}),je&&clearTimeout(je)};let dt;const ln=()=>{sn(),dt&&dt.stop(),le&&le.unregisterEvents()};if(s===Ge?ao.push(setInterval(()=>{Ze(E())},1e3)):s===ge&&He(),s===Ge)we.onServerChange(u=>{u[0],u[1],u[2];const p=u[3];for(const[C,x]of p)switch(C){case d.CHANGE_PLAYER:{const F=L.decodePlayer(x);F.id!==t&&(U.setPlayer(e,F.id,F),j=!0)}break;case d.CHANGE_TILE:{const F=L.decodePiece(x);U.setPiece(e,F.idx,F),j=!0}break;case d.CHANGE_DATA:U.setPuzzleData(e,x),j=!0;break}ut=!!U.getFinishTs(e)});else if(s===ge){const u=(x,F)=>{const J=x;if(J[0]===d.LOG_ADD_PLAYER){const Y=J[1];return U.addPlayer(e,Y,F),!0}if(J[0]===d.LOG_UPDATE_PLAYER){const Y=U.getPlayerIdByIndex(e,J[1]);if(!Y)throw"[ 2021-05-17 player not found (update player) ]";return U.addPlayer(e,Y,F),!0}if(J[0]===d.LOG_HANDLE_INPUT){const Y=U.getPlayerIdByIndex(e,J[1]);if(!Y)throw"[ 2021-05-17 player not found (handle input) ]";const Te=J[2];return U.handleInput(e,Y,Te,F),!0}return!1};let p=c.lastGameTs;const C=async()=>{c.logPointer+1>=c.log.length&&await M(e);const x=ye.timestamp();if(c.paused){c.lastRealTs=x,je=setTimeout(C,50);return}const J=(x-c.lastRealTs)*c.speeds[c.speedIdx];let Y=c.lastGameTs+J;do{if(c.paused)break;const Te=c.logPointer+1;if(Te>=c.log.length)break;const Ke=c.log[c.logPointer],uo=p+Ke[Ke.length-1],pt=c.log[Te],co=pt[pt.length-1],ht=uo+co;if(ht>Y){Y+500*ye.MS<ht&&(Y+=co);break}p=uo,u(pt,ht)&&(j=!0),c.logPointer=Te}while(!0);c.lastRealTs=x,c.lastGameTs=Y,Ze(E()),c.final||(je=setTimeout(C,50))};C()}return dt=nr({update:()=>{le.createKeyEvents();for(const u of le.consumeAll())if(s===Ge){const p=u[0];if(p===d.INPUT_EV_MOVE){const F=$.worldDimToViewportRaw({w:u[1],h:u[2]});j=!0,$.move(F.w,F.h),delete D.last}else if(p===d.INPUT_EV_MOUSE_MOVE){if(u[5]&&!U.getFirstOwnedPiece(e,t)){const J=$.worldDimToViewportRaw({w:u[3],h:u[4]});j=!0,$.move(J.w,J.h),delete D.last}}else if(p===d.INPUT_EV_PLAYER_COLOR)ct(u[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Me(!0);else if(p===d.INPUT_EV_MOUSE_UP)Me(!1);else if(p===d.INPUT_EV_ZOOM_IN){const F={x:u[1],y:u[2]};j=!0,$.zoom("in",$.worldToViewportRaw(F)),delete D.last}else if(p===d.INPUT_EV_ZOOM_OUT){const F={x:u[1],y:u[2]};j=!0,$.zoom("out",$.worldToViewportRaw(F)),delete D.last}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(p===d.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE)We("center");else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)Be=!Be,j=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)xe=!xe,j=!0;else if(p===d.INPUT_EV_STORE_POS){const F=`${u[1]}`;D[F]=$.snapshot()}else if(p===d.INPUT_EV_RESTORE_POS){const F=`${u[1]}`;We(F)}const C=E();U.handleInput(e,t,u,C,F=>{Qt()&&to()}).length>0&&(j=!0),we.sendClientEvent(u)}else if(s===ge){const p=u[0];if(p===d.INPUT_EV_REPLAY_TOGGLE_PAUSE)ro();else if(p===d.INPUT_EV_REPLAY_SPEED_DOWN)lo();else if(p===d.INPUT_EV_REPLAY_SPEED_UP)io();else if(p===d.INPUT_EV_MOVE){const C=$.worldDimToViewportRaw({w:u[1],h:u[2]});j=!0,$.move(C.w,C.h)}else if(p===d.INPUT_EV_MOUSE_MOVE){if(u[5]){const x=$.worldDimToViewportRaw({w:u[3],h:u[4]});j=!0,$.move(x.w,x.h)}}else if(p===d.INPUT_EV_PLAYER_COLOR)ct(u[1]);else if(p===d.INPUT_EV_MOUSE_DOWN)Me(!0);else if(p===d.INPUT_EV_MOUSE_UP)Me(!1);else if(p===d.INPUT_EV_ZOOM_IN){const C={x:u[1],y:u[2]};j=!0,$.zoom("in",$.worldToViewportRaw(C))}else if(p===d.INPUT_EV_ZOOM_OUT){const C={x:u[1],y:u[2]};j=!0,$.zoom("out",$.worldToViewportRaw(C))}else if(p===d.INPUT_EV_TOGGLE_PREVIEW)l.emit("togglePreview");else if(p===d.INPUT_EV_TOGGLE_SOUNDS)l.emit("toggleSoundsEnabled");else if(p===d.INPUT_EV_TOGGLE_PLAYER_NAMES)l.emit("togglePlayerNames");else if(p===d.INPUT_EV_CENTER_FIT_PUZZLE)We("center");else if(p===d.INPUT_EV_TOGGLE_FIXED_PIECES)Be=!Be,j=!0;else if(p===d.INPUT_EV_TOGGLE_LOOSE_PIECES)xe=!xe,j=!0;else if(p===d.INPUT_EV_STORE_POS){const C=`${u[1]}`;D[C]=$.snapshot()}else if(p===d.INPUT_EV_RESTORE_POS){const C=`${u[1]}`;We(C)}}ut=!!U.getFinishTs(e),Kt()&&(Ye.update(),j=!0)},render:async()=>{if(!j)return;const u=E();let p,C,x;window.DEBUG&&$e.checkpoint_start(0),h.fillStyle=Jt(),h.fillRect(0,0,v.width,v.height),window.DEBUG&&$e.checkpoint("clear done"),p=$.worldToViewportRaw(rt),C=$.worldDimToViewportRaw(W),h.fillStyle="rgba(255, 255, 255, .3)",h.fillRect(p.x,p.y,C.w,C.h),window.DEBUG&&$e.checkpoint("board done");const F=U.getPiecesSortedByZIndex(e);window.DEBUG&&$e.checkpoint("get tiles done"),C=$.worldDimToViewportRaw(Zt);for(const Y of F)!_a(Y)||(x=Ht[Y.idx],p=$.worldToViewportRaw({x:K+Y.pos.x,y:K+Y.pos.y}),h.drawImage(x,0,0,x.width,x.height,p.x,p.y,C.w,C.h));window.DEBUG&&$e.checkpoint("tiles done");const J=[];for(const Y of U.getActivePlayers(e,u))r(Y)&&(x=await b(Y),p=$.worldToViewport(Y),h.drawImage(x,p.x-A,p.y-B),Xt()&&J.push([`${Y.name} (${Y.points})`,p.x,p.y+y]));h.fillStyle="white",h.textAlign="center";for(const[Y,Te,Ke]of J)h.fillText(Y,Te,Ke);window.DEBUG&&$e.checkpoint("players done"),Ze(u),window.DEBUG&&$e.checkpoint("HUD done"),Kt()&&Ye.render(),j=!1}}),{previewImageUrl:on,player:se,game:U.get(e),disconnect:we.disconnect,connect:Q,unload:ln}}const Ea=q({name:"game",components:{PuzzleStatusComponent:Tt,Scores:Pt,SettingsOverlay:Ct,PreviewOverlay:St,InfoOverlay:bt,ConnectionOverlay:No,HelpOverlay:zt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:ho(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Jo(`${this.$route.params.id}`,ce.clientId(),this.$config.WS_ADDRESS,Ge,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},reconnect(){this.g.connect()},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}}}),wa={id:"game"},va=n("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3",-1),Pa={class:"menu-left"},Ta={key:0,class:"switch-game-replay"},Ca=k("\u21AA\uFE0F Watch replay"),Sa={class:"menu"},ba={class:"tabs"},$a=k("\u{1F9E9} Puzzles"),Aa={class:"menu-right"},Oa={ref:"canvas"};function Na(e,t,o,s,i,l){const r=N("settings-overlay"),a=N("preview-overlay"),m=N("info-overlay"),w=N("help-overlay"),S=N("overlay"),G=N("connection-overlay"),f=N("puzzle-status"),g=N("router-link"),A=N("scores");return _(),P("div",wa,[z(V(r,{onClose:t[0]||(t[0]=y=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=y=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=y=>e.g.player=y)},null,8,["modelValue"]),[[ae,e.overlay==="settings"]]),z(V(a,{onClose:t[3]||(t[3]=y=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=y=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[ae,e.overlay==="preview"]]),e.g.game?z((_(),ue(m,{key:0,onClose:t[5]||(t[5]=y=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=y=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[ae,e.overlay==="info"]]):te("",!0),z(V(w,{onClose:t[7]||(t[7]=y=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=y=>e.toggle("help",!0))},null,512),[[ae,e.overlay==="help"]]),z(V(S,null,{default:ee(()=>[va]),_:1},512),[[ae,e.cuttingPuzzle]]),V(G,{connectionState:e.connectionState,onReconnect:e.reconnect},null,8,["connectionState","onReconnect"]),n("div",Pa,[V(f,{status:e.status},null,8,["status"]),e.g.game&&e.g.game.hasReplay?(_(),P("div",Ta,[V(g,{to:{name:"replay",params:{id:e.g.game.id}}},{default:ee(()=>[Ca]),_:1},8,["to"])])):te("",!0)]),n("div",Sa,[n("div",ba,[V(g,{class:"opener",to:{name:"index"},target:"_blank"},{default:ee(()=>[$a]),_:1}),n("div",{class:"opener",onClick:t[9]||(t[9]=y=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),n("div",{class:"opener",onClick:t[10]||(t[10]=y=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),n("div",{class:"opener",onClick:t[11]||(t[11]=y=>e.toggle("info",!0))},"\u2139\uFE0F Info"),n("div",{class:"opener",onClick:t[12]||(t[12]=y=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),n("div",Aa,[V(A,{players:e.players},null,8,["players"])]),n("canvas",Oa,null,512)])}var Ua=H(Ea,[["render",Na]]);const ka=q({name:"replay",components:{PuzzleStatusComponent:Tt,Scores:Pt,SettingsOverlay:Ct,PreviewOverlay:St,InfoOverlay:bt,HelpOverlay:zt},data(){return{players:{active:[],idle:[]},status:{finished:!1,duration:0,piecesDone:0,piecesTotal:0},overlay:"",connectionState:0,cuttingPuzzle:!0,eventBus:ho(),g:{player:{background:"",color:"",name:"",soundsEnabled:!0,soundsVolume:100,showPlayerNames:!0},game:null,previewImageUrl:"",connect:()=>{},disconnect:()=>{},unload:()=>{}},replay:{speed:1,paused:!1}}},async mounted(){if(!this.$route.params.id)return;this.eventBus.on("puzzleCut",()=>{this.cuttingPuzzle=!1}),this.eventBus.on("players",t=>{this.players=t}),this.eventBus.on("status",t=>{this.status=t}),this.eventBus.on("togglePreview",()=>{this.toggle("preview",!1)}),this.eventBus.on("connectionState",t=>{this.connectionState=t}),this.eventBus.on("toggleSoundsEnabled",()=>{this.g.player.soundsEnabled=!this.g.player.soundsEnabled}),this.eventBus.on("togglePlayerNames",()=>{this.g.player.showPlayerNames=!this.g.player.showPlayerNames}),this.eventBus.on("replaySpeed",t=>{this.replay.speed=t}),this.eventBus.on("replayPaused",t=>{this.replay.paused=t}),this.$watch(()=>this.g.player.background,t=>{this.eventBus.emit("onBgChange",t)}),this.$watch(()=>this.g.player.color,t=>{this.eventBus.emit("onColorChange",t)}),this.$watch(()=>this.g.player.name,t=>{this.eventBus.emit("onNameChange",t)}),this.$watch(()=>this.g.player.soundsEnabled,t=>{this.eventBus.emit("onSoundsEnabledChange",t)}),this.$watch(()=>this.g.player.soundsVolume,t=>{this.eventBus.emit("onSoundsVolumeChange",t)}),this.$watch(()=>this.g.player.showPlayerNames,t=>{this.eventBus.emit("onShowPlayerNamesChange",t)});const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,window.addEventListener("resize",this.onResize),this.g=await Jo(`${this.$route.params.id}`,ce.clientId(),this.$config.WS_ADDRESS,ge,e,this.eventBus)},unmounted(){this.g.unload(),this.g.disconnect(),window.removeEventListener("resize",this.onResize)},methods:{onResize(){const e=this.$refs.canvas;e.width=window.innerWidth,e.height=window.innerHeight,this.eventBus.emit("requireRerender")},toggle(e,t){this.overlay===""?(this.overlay=e,t&&this.eventBus.emit("setHotkeys",!1)):(this.overlay="",t&&this.eventBus.emit("setHotkeys",!0))}},computed:{replayText(){return"Replay-Speed: "+(this.replay.speed+"x")+(this.replay.paused?" Paused":"")}}}),Ra={id:"replay"},Va={key:1,class:"overlay"},La=n("div",{class:"overlay-content"},[n("div",null,"\u23F3 Cutting puzzle, please wait... \u23F3")],-1),za=[La],Ma={class:"menu-left"},Da={class:"playback-control"},Fa={key:0,class:"switch-game-replay"},Ia=k("\u{1F9E9} To the game"),Ga={class:"menu"},Ba={class:"tabs"},xa=k("\u{1F9E9} Puzzles"),Ya={class:"menu-right"},Wa={ref:"canvas"};function Za(e,t,o,s,i,l){const r=N("settings-overlay"),a=N("preview-overlay"),m=N("info-overlay"),w=N("help-overlay"),S=N("puzzle-status"),G=N("router-link"),f=N("scores");return _(),P("div",Ra,[z(V(r,{onClose:t[0]||(t[0]=g=>e.toggle("settings",!0)),onBgclick:t[1]||(t[1]=g=>e.toggle("settings",!0)),modelValue:e.g.player,"onUpdate:modelValue":t[2]||(t[2]=g=>e.g.player=g)},null,8,["modelValue"]),[[ae,e.overlay==="settings"]]),z(V(a,{onClose:t[3]||(t[3]=g=>e.toggle("preview",!1)),onClick:t[4]||(t[4]=g=>e.toggle("preview",!1)),img:e.g.previewImageUrl},null,8,["img"]),[[ae,e.overlay==="preview"]]),e.g.game?z((_(),ue(m,{key:0,onClose:t[5]||(t[5]=g=>e.toggle("info",!0)),onBgclick:t[6]||(t[6]=g=>e.toggle("info",!0)),game:e.g.game},null,8,["game"])),[[ae,e.overlay==="info"]]):te("",!0),z(V(w,{onClose:t[7]||(t[7]=g=>e.toggle("help",!0)),onBgclick:t[8]||(t[8]=g=>e.toggle("help",!0))},null,512),[[ae,e.overlay==="help"]]),e.cuttingPuzzle?(_(),P("div",Va,za)):te("",!0),n("div",Ma,[V(S,{status:e.status},null,8,["status"]),n("div",Da,[n("div",null,I(e.replayText),1),n("button",{class:"btn",onClick:t[9]||(t[9]=g=>e.eventBus.emit("replayOnSpeedUp"))},"\u23EB"),n("button",{class:"btn",onClick:t[10]||(t[10]=g=>e.eventBus.emit("replayOnSpeedDown"))},"\u23EC"),n("button",{class:"btn",onClick:t[11]||(t[11]=g=>e.eventBus.emit("replayOnPauseToggle"))},"\u23F8\uFE0F")]),e.g.game?(_(),P("div",Fa,[V(G,{to:{name:"game",params:{id:e.g.game.id}}},{default:ee(()=>[Ia]),_:1},8,["to"])])):te("",!0)]),n("div",Ga,[n("div",Ba,[V(G,{class:"opener",to:{name:"index"},target:"_blank"},{default:ee(()=>[xa]),_:1}),n("div",{class:"opener",onClick:t[12]||(t[12]=g=>e.toggle("preview",!1))},"\u{1F5BC}\uFE0F Preview"),n("div",{class:"opener",onClick:t[13]||(t[13]=g=>e.toggle("settings",!0))},"\u{1F6E0}\uFE0F Settings"),n("div",{class:"opener",onClick:t[14]||(t[14]=g=>e.toggle("info",!0))},"\u2139\uFE0F Info"),n("div",{class:"opener",onClick:t[15]||(t[15]=g=>e.toggle("help",!0))},"\u2328\uFE0F Hotkeys")])]),n("div",Ya,[V(f,{players:e.players},null,8,["players"])]),n("canvas",Wa,null,512)])}var Ha=H(ka,[["render",Za]]);let en=null;async function ja(){en=await(await ce.get("/api/me",{})).json()}var tn={getMe:()=>en,init:ja};const Ka=q({props:{image:{type:Object,required:!0}},data:()=>({me:tn.getMe()}),computed:{style(){return{backgroundImage:`url("${this.image.url.replace("uploads/","uploads/r/")+"-150x100.webp"}")`}},canEdit(){return this.me.id?this.me.id===this.image.uploaderUserId:!1}},emits:{click:null,editClick:null},methods:{onClick(){this.$emit("click")},onEditClick(){this.$emit("editClick")}}});function qa(e,t,o,s,i,l){return _(),P("div",{class:"imageteaser",style:Ue(e.style),onClick:t[1]||(t[1]=(...r)=>e.onClick&&e.onClick(...r))},[e.canEdit?(_(),P("div",{key:0,class:"btn edit",onClick:t[0]||(t[0]=cn((...r)=>e.onEditClick&&e.onEditClick(...r),["stop"]))},"\u270F\uFE0F")):te("",!0)],4)}var Qa=H(Ka,[["render",qa]]);const Xa=q({props:{animate:{type:Boolean,default:!0}},emits:{bgclick:null,close:null},data:()=>({classes:[]}),methods:{onKeyUp(e){e.code==="Escape"&&window.getComputedStyle(this.$el).display!=="none"&&this.$emit("close")}},mounted(){window.addEventListener("keyup",this.onKeyUp)},unmounted(){window.removeEventListener("keyup",this.onKeyUp)}}),Ja={class:"overlay"};function eu(e,t,o,s,i,l){return _(),P("div",Ja,[n("div",{class:De(["overlay-background",e.classes.map(r=>"overlay-background-"+r)]),onClick:t[0]||(t[0]=r=>e.$emit("bgclick"))},null,2),n("div",{class:De(["overlay-content",e.classes.map(r=>"overlay-content-"+r)])},[dn(e.$slots,"default")],2)])}var tu=H(Xa,[["render",eu]]);const ou={props:{src:String,title:{type:String,default:""},height:{type:String,default:"100%"},width:{type:String,default:"100%"}},computed:{style(){return{display:"inline-block",verticalAlign:"text-bottom",backgroundImage:`url('${this.src}')`,backgroundRepeat:"no-repeat",backgroundSize:"contain",backgroundPosition:"center",width:this.width,height:this.height}}}},nu=["title"];function su(e,t,o,s,i,l){return _(),P("div",{style:Ue(l.style),title:o.title},null,12,nu)}var iu=H(ou,[["render",su]]);const lu=q({props:{modelValue:{type:Array,required:!0},autocompleteTags:{type:Function}},emits:{"update:modelValue":null},data(){return{input:"",values:[],autocomplete:{idx:-1,values:[]}}},watch:{modelValue(e,t){this.values=e}},created(){this.values=this.modelValue},methods:{onKeyUp(e){if(e.code==="ArrowDown"&&this.autocomplete.values.length>0)return this.autocomplete.idx<this.autocomplete.values.length-1&&this.autocomplete.idx++,e.stopPropagation(),!1;if(e.code==="ArrowUp"&&this.autocomplete.values.length>0)return this.autocomplete.idx>0&&this.autocomplete.idx--,e.stopPropagation(),!1;if(e.key===",")return this.add(),e.stopPropagation(),!1;this.input&&this.autocompleteTags?(this.autocomplete.values=this.autocompleteTags(this.input,this.values),this.autocomplete.idx=-1):(this.autocomplete.values=[],this.autocomplete.idx=-1)},addVal(e){const t=e.replace(/,/g,"").trim();!t||(this.values.includes(t)||this.values.push(t),this.input="",this.autocomplete.values=[],this.autocomplete.idx=-1,this.$emit("update:modelValue",this.values),this.$refs.input.focus())},add(){const e=this.autocomplete.idx>=0?this.autocomplete.values[this.autocomplete.idx]:this.input;this.addVal(e)},rm(e){this.values=this.values.filter(t=>t!==e),this.$emit("update:modelValue",this.values)}}}),ru={key:0,class:"autocomplete"},au=["onClick"],uu=["onClick"];function cu(e,t,o,s,i,l){return _(),P("div",null,[z(n("input",{ref:"input",class:"input",type:"text","onUpdate:modelValue":t[0]||(t[0]=r=>e.input=r),placeholder:"Plants, People",onChange:t[1]||(t[1]=(...r)=>e.onChange&&e.onChange(...r)),onKeydown:t[2]||(t[2]=pn((...r)=>e.add&&e.add(...r),["enter"])),onKeyup:t[3]||(t[3]=(...r)=>e.onKeyUp&&e.onKeyUp(...r))},null,544),[[Ce,e.input]]),e.autocomplete.values?(_(),P("div",ru,[n("ul",null,[(_(!0),P(re,null,me(e.autocomplete.values,(r,a)=>(_(),P("li",{key:a,class:De({active:a===e.autocomplete.idx}),onClick:m=>e.addVal(r)},I(r),11,au))),128))])])):te("",!0),(_(!0),P(re,null,me(e.values,(r,a)=>(_(),P("span",{key:a,class:"bit is-clickable",onClick:m=>e.rm(r)},I(r)+" \u2716",9,uu))),128))])}var du=H(lu,[["render",cu],["__scopeId","data-v-d5073870"]]);const pu=q({props:{accept:String,label:String},methods:{async upload(e){const t=e.target;if(!t.files)return;const o=t.files[0];if(!o)return;const s=new FormData;s.append("file",o,o.name);const l=await(await ce.post("/upload",{body:s})).json();this.$emit("uploaded",l)}}}),hu=["accept"],gu={class:"btn"};function mu(e,t,o,s,i,l){return _(),P("label",null,[n("input",{type:"file",style:{display:"none"},onChange:t[0]||(t[0]=(...r)=>e.upload&&e.upload(...r)),accept:e.accept},null,40,hu),n("span",gu,I(e.label||"Upload File"),1)])}var fu=H(pu,[["render",mu]]);(async()=>{ce.init(),await tn.init();const t=await(await ce.get("/api/conf",{})).json(),o=hn({history:gn(),routes:[{name:"index",path:"/",component:os},{name:"new-game",path:"/new-game",component:_i},{name:"game",path:"/g/:id",component:Ua},{name:"replay",path:"/replay/:id",component:Ha}]});o.beforeEach((i,l)=>{l.name&&document.documentElement.classList.remove(`view-${String(l.name)}`),document.documentElement.classList.add(`view-${String(i.name)}`)});const s=mn(Tn);s.config.globalProperties.$config=t,s.use(o),s.component("connection-overlay",No),s.component("edit-image-dialog",vo),s.component("game-teaser",_o),s.component("help-overlay",zt),s.component("image-library",Eo),s.component("image-teaser",Qa),s.component("info-overlay",bt),s.component("new-game-dialog",To),s.component("new-image-dialog",wo),s.component("overlay",tu),s.component("preview-overlay",St),s.component("puzzle-status",Tt),s.component("responsive-image",iu),s.component("scores",Pt),s.component("settings-overlay",Ct),s.component("tags-input",du),s.component("upload",fu),s.mount("#app")})();
//# sourceMappingURL=index.c3e2f488.js.map
